# OtoTheory v3.1 — Single Source of Truth（仕様 正本）

*最終更新: 2025/10/13*

> 本書は v3.0 SSOT をベースに、**Web Lite のGA（録音UI非露出）**、**iOS収益主軸**、**Undoキャンセル（非搭載）**、**PNG白背景固定** など合意事項を反映した **v3.1 差分統合版**です。旧版（v2.4〜v3.0）は参照資料とし、本書と矛盾する場合は本書を優先します。

---

## 0. 本版の主要決定（v3.0 → v3.1 の差分）

* **Webは M3 完了の Lite を GA**：録音UI（Melody/Solo Analyze）は**メニューから撤去**し、**Flag OFF**のまま（UI非露出）。
* **iOS を収益主軸**（M4）：**セクション編集**／**MIDI出力（Chord Track＋Section Markers＋Guide Tones）**／**Sketch無制限（クラウド）**／**IAP（¥490/月）**。
* **Undo は非搭載（キャンセル確定）**：個別削除・並べ替えで代替。**DoD と Telemetry から "undo" を削除**。
* **PNG 出力は白背景固定（v3.1）**：テーマ自動反転は将来再検討。`export_png` は**成功/失敗に関わらず1回のみ**発火。
* v3.0の中核原則（**二層Overlay／非ヘプタ規則／Capo Top2（Shapedのみ・無音）／"試聴→＋Add→即ループ"**）は継続。

---

## 1. 画面モジュール（共通哲学）

* **結果カード**：Key ≤3 候補＋% → **Diatonic** → **Fretboard（二層 Overlay）** → **Patterns / Cadence / 基礎代理**。操作は **「試聴→＋Add→即ループ」2タップ以内**。
* **二層 Overlay**：Scale 層＝輪郭/小/無地、Chord 層＝塗り/大/ラベル。**Reset＝Chordのみ**。**Degrees / Names** のみトグル。
* **非ヘプタ**：Roman 非表示・Diatonic は Open 限定（**Pent/Blues は例外的に Roman 表示**）。
* **Capo**：Diatonic 折りたたみ内に **Top2（Shaped 表記）**。**音は鳴らさない**。注記 *Shaped=fingered / Sounding=actual* を併記。

### 1.1 Chord Progression（メイン）

* **Lite（Web／iOS Free）**

  * 12コード上限／**プリセットFree 20種**／自動ループ（4/4・BPM）／**Undoなし**／Sketch 3件（ローカル）。
  * 他画面からの`＋Add to progression`で即挿入＆自動再生。

* **Pro（iOS）**

  * **プリセット50種（Free 20＋Pro 30）**
  * **セクション編集**（Verse/Chorus/Bridge…）：**各セクションが独立したコード進行を持つ** ✅ 完了（2025-10-13）
    - Post-chorusセクションタイプを含む10種類のセクション
    - PlaybackOrderEditor（ドラッグ&ドロップ、繰り返し回数調整）
  * **MIDI出力**：SMF Type‑1、5トラック（**Guitar＋Bass＋Scale Guide×2＋Guide Tones**）✅ 完了
  * **Sketch無制限（クラウド同期）／IAP（¥490/月）**。
  * **Fretboard & Diatonic & Roman（Chord Progression）** ✅ 完了（2025-10-13）：
    - Result下のToolsセクションに統合（Web版同様の構成）
    - **Fretboard**: Degrees/Names toggle、ダイアトニック選択時のコードトーンoverlay表示
    - **Diatonic Table**: タップで再生、長押しで進行に追加（Phase E-4A連携）
    - **Roman Numerals**: 進行をローマ数字表記で表示（横スクロール対応）
  * **iOS実装状況（2025-10-13）**：
    - ✅ **コード追加機能**（長押しで追加、Toast通知、ハプティク、スロットハイライト）
    - ✅ **ProgressionStore**（共有ストア、状態管理）
    - ✅ **Advanced Chord Builder**（Phase E-4B完了）
    - ✅ **Slash Chord Editor**（Phase E-4C完了）
    - ✅ **セクション別コード進行**（Phase E-5完了）
    - ✅ **PlaybackOrderEditor**（Phase E-5C完了）
    - ✅ **Fretboard & Diatonic & Roman**（Phase E-6完了）

### 1.2 Find Chords（キー/スケール→使えるコード）

* Key/Scale 選択で **Diatonic→Fretboard** 即更新。**Scale Table（2–3件＋Why＋ⓘGlossary＋短いアルペジオ）**／**Chord Forms（Open/Barre＋試聴）**／**基礎代理（2–3件＋試聴/＋Add）** を搭載。
* **iOS（Phase E-1 ~ E-4A完了）**：
  - ✅ **Fretboard二層Overlay**（15フレット、Landscape Full-Screen、強制横向き）
  - ✅ **Diatonic Table**（Open + Capo Top2、長押しでProgression追加）
  - ✅ **Suggested Scales**（Chord quality判定、アルペジオ試聴）
  - ✅ **Substitute Chords**（和声理論ベース、長押しでProgression追加）
  - ✅ **Toast通知＋ハプティクフィードバック**
  - ⏳ **Advanced Chord Builder**（次回実装予定）

### 1.3 Resources（学習リソース）✅ 完了（2025-10-13）

* **3つのサブセクション構成**（Reference → Resources にリブランド）：
  - **Glossary**（用語解説）：音楽理論用語の定義と解説（日英対応）
  - **Music Theory**（理論解説）：ギタリスト向けの実践的理論ガイド（日英対応）
  - **Chord Library**（コードライブラリ）：インタラクティブなコードフォーム集

* **Chord Library 機能**：
  - **3フォーム表示**：1コード = 3フォーム（Open/Compact、E-shape Barre、A-shape Barre）
  - **横向きフレットボード**：標準的なギター配置（1弦が上、6弦が下）
  - **3つの表示モード**：
    - Finger：指番号表示（1,2,3,4）
    - Roman：音程表示（R, III, V, ♭VII など）
    - Note：音名表示（C, E, G など）
  - **音再生機能**：
    - Play（▶）：ストラム（じゃーん）再生
    - Arp：アルペジオ再生
    - Web Audio API による高品質サウンド
  - **構成音表示**：コード名の下に「R · III · V | C · E · G」形式で表示
  - **40+種類のコード対応**：Major, minor, 7th, M7, m7, 6, m6, aug, dim, sus2, sus4, 9th, 11th, 13th, altered など
  - **開放弦表示**：Roman/Noteモードでは開放弦にも音程/音名を表示

* **SEO最適化**：
  - 各ページに専用メタデータ（title, description, keywords, OpenGraph）
  - `/resources`、`/resources/glossary`、`/resources/music-theory`、`/resources/chord-library`
  - 301リダイレクト設定（旧`/reference` → 新`/resources`）

* **ナビゲーション**：
  - メインナビゲーションバーに「Resources」リンク
  - Chord Libraryは「Find Chords」の右隣に専用リンク配置
  - レスポンシブ対応（モバイルでは改行表示）

### 1.4 Melody/Solo Analyze（録音→Key/Scale）

* **v3.1 は UI 非露出（Flag OFF）**。Line‑in 前提／停止後サーバ解析。将来解禁時も **Key候補≤3＋Conf%** と**低信頼時の再録ガイド**を必須。

---

## 2. 保存（Sketch）

* 保存単位は **Sketch（ソングスケッチ）**。
* **保存内容**：
  - **Free**: Key＋Scale＋進行（≤12）＋Fretboard表示状態（Degrees/Names＋Overlay）
  - **Pro**: 上記＋**セクション進行**（SectionDefinitions＋PlaybackOrder）
* **Free**：ローカル 3 件（LRU 上書き／自動保存 3 秒）。**Pro**：無制限（クラウド同期）。復元時も **非ヘプタ規則／Capo注記** を厳守。

---

## 3. 出力・共有

* **PNG（Free）**：**白背景固定（v3.1）**・視認性最適化。`export_png` は保存成否に関わらず **1回のみ**発火。
* **テキスト（Free）**：Key/Scale／Diatonic／進行（Roman/実音）／Capo注記のコピー。
* **MIDI（iOS Pro）**：**Chord Track＋Section Markers＋Guide Tones** を SMF Type‑1 で書き出し。

---

## 4. Free / Pro 境界

* **Free（Web/iOS）**：Find Chords 拡張／二層 Overlay／Capo Top2／Progression Lite（12上限・**プリセットFree 20種**・自動ループ）／Sketch 3 件／PNG・テキスト出力。
* **Pro（iOS）**：**プリセット50種（Free 20＋Pro 30）**／**セクション編集**／**MIDI 出力**／**Sketch無制限**／将来の高度機能。

---

## 5. Telemetry（最小セット）

* **共通**：`page_view, key_pick, scale_pick, diatonic_pick, overlay_shown, fb_toggle, overlay_reset, play_note, play_chord, export_png, instrument_change`（**1操作=1発火**）※`overlay_shown`は**初回ユーザー操作時のみ**。`page_view` ラベルは `chord_progression / find_chords / melody_solo_analyze`（旧ラベル互換は90日維持）。
* **進行**：`progression_play, preset_inserted, toast_shown(kind)`（`limit_warn / limit_block / low_conf`。**undoは廃止**）、**`cta_appstore_click{place}`**（header/sticky/limit_toast/png_toast/qr）。
* **保存**：`save_project, open_project, project_rename, project_delete, project_duplicate, project_limit_warn, project_limit_block`。
* **録音（将来露出）**：`audio_record_start/stop, audio_analyze_ok, audio_analyze_conf(engine,conf)`（Flag OFFのまま維持）。
* **広告（Web版のみ）**：`ad_shown{page}`（広告表示時、ページごとに記録）✅ 完了（2025-10-13）

---

## 6. 受け入れ基準（DoD）

1. **Find Chords**：Key/Scale 選択のみで Result 更新。Open 行タップで和音再生＆Chord 層強調。Reset で Scale は保持。
2. **Capo**：折りたたみ内に **Top2（Shaped）**＋注記。音は鳴らさない。
3. **Progression**：**ドラッグ並べ替え／プリセット→自動ループ**が動作（**Undoなし**）。
4. **提案の追加**：Patterns / Cadence / 基礎代理 は **試聴→＋Add** が 2 タップ以内、直後に自動再生。
5. **Sketch**：Key/Scale・Capo（Shaped）・進行・Overlay 表示を完全復元。Free=3 件、Pro=無制限。
6. **出力**：Free＝PNG（白固定）/テキスト、Pro＝MIDI（Chord+Markers+Guide）。`export_png` は必ず 1 回。
7. **録音（将来 Flag ON 時）**：Line‑inのみ開始可。停止→Key 候補≤3＋Conf% 表示、低信頼は Advice。デフォルトは UI 非露出。

---

## 7. ロードマップ（期日なし方式）

* **M3.5 Web Lite GA**：Analyze撤去・6面CTA・`cta_appstore_click` 追加。
* **M4 iOS v1**：Free＝M3パリティ／Pro＝**セクション編集・MIDI（Chord+Markers+Guide）・無制限保存・IAP**。
* **M4.1+（任意）**：Split Bar／Groove（簡易ドラム）／ミニベース（パターンのみ）／**MIDI多トラック拡張**。**ミニDAW化は回避**。
* **M5 Polish**：A11y・Telemetry最終化・PNG反転の将来再検討。


---

## 8. Web版収益化（広告）✅ 完了（2025-10-13）

### 8.1 Google AdSense統合

**目的**：Web版（Free）の収益化施策として、Google AdSenseを統合

**実装内容**：
- **パブリッシャーID**: `ca-pub-9662479821167655`
- **配置箇所**（4ページ）：
  - ホームページ（`/`）：ページ下部に横長フォーマット
  - Chord Progression（`/chord-progression`）：Toolsセクション下
  - Find Chords（`/find-chords`）：メインコンテンツ下
  - Chord Library（`/resources/chord-library`）：フッター下（ダークテーマ対応スタイリング）

**Pro版対応**：
- Pro版ユーザーには広告を非表示（`usePro()`フックで判定）
- 将来的にiOS Pro購入者がWeb版でも広告非表示となる連携を想定

**技術実装**：
- Next.js `Script`コンポーネントでAdSenseスクリプト読み込み（`afterInteractive`）
- `AdSlot.client.tsx`コンポーネントで広告表示を一元管理
- CLS（Cumulative Layout Shift）対策：`minHeight: 110px`でレイアウトシフトを防止
- ads.txt設置：`google.com, pub-9662479821167655, DIRECT, f08c47fec0942fa0`
- 認証メタタグ：`<meta name="google-adsense-account" content="ca-pub-9662479821167655">`

**Telemetry**：
- `ad_shown{page}` イベント（ページごとの広告表示を記録）
- ページ値：`home / chord_progression / find_chords / chord_library`

**ドキュメント**：
- 詳細な設定手順は `ototheory-web/AD_SETUP_GUIDE.md` に記載
- トラブルシューティング、審査手順も含む

---

## 9. リスク / 決めごと

* **ミニDAW化の回避**：パターンの範囲に限定、音色作り込まず、成果物は **MIDI** に集中。
* **録音の扱い**：**Flag OFF 維持**。合格指標（例：Top‑1≥85% 等）に達するまで解禁しない。
* **表記整合**：非ヘプタ例外（Pent/Blues Roman）／Capo注記／二層Overlayのルールを全画面で統一。

---

## 10. 運用メモ（リポジトリ／PR手順）

* **配置**：`docs/SSOT/OtoTheory_v3.1_SSOT.md`（本書）。旧版は `docs/SSOT/legacy/` へ移動し「参照目的のみ」と明記。
* **PR テンプレ**：SSOT欄は**要更新**を選択。**Roadmap / Implementation SSOT** も同時に差分PR（Undo削除／PNG白固定／Analyze非露出を揃える）。
* **計測タグ**：Webの送客強化に伴い **`cta_appstore_click{place}`** を新設。既存イベント（`export_png / progression_play / preset_inserted / instrument_change / toast_shown` など）と統合して可視化。


---

### 備考（非エンジニア向け）

* **使い方はシンプル**：①Key/Scale→②Diatonic＋Fretboard（二層）→③提案を**試聴→＋Add→即ループ**→④良ければ**Sketch保存**。
* **迷ったらこのSSOT**：**Capo Top2（Shapedのみ）／非ヘプタのRoman非表示／Reset＝Chordのみ** を守れば体験は自然に揃います。

---

## 7. サイト/ポリシー（v3.1）

**目的**：App Store審査通過率の向上と利用者の信頼担保（法務・サポートの可視化）

**公開必須URL**（JP/EN）：
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約（EULA相当条項を含む）
- `/subscription` - サブスク・自動更新・キャンセル・返金
- `/support` - サポート／FAQ／連絡先
- `/account-deletion` - アカウント／データ削除手順
- `/security` - セキュリティ＆データ保護（保存地域=東京、保持期間）
- `/accessibility` - アクセシビリティ声明
- `/transparency` - 透明性レポート（収集イベント一覧、保持期間=90日）
- `/licenses` - OSSライセンス（自動生成）

**導線**：
- フッター常設リンク（全画面共通）
- App内「設定」＞「プライバシー/利用規約/アカウント削除」へ1タップ遷移
- Web Lite本体から6面CTA（ヘッダー／下部スティッキー／到達トースト／保存制限／PNG後／フッターQR）で App Store誘導

**Free/Proの境界**（従来通り）：
- Free=PNG/テキスト、Pro=iOSのMIDI（Chord+Markers+Guide）
- 録音UIはβ/Flag OFF（UI非露出）

**計測**：
- Web Lite（M3完了機能）からApp Storeへ6面CTAで誘導
- `cta_appstore_click{place}` を追加（Web→iOSファネル可視化）
- `export_png` は成功/失敗に関わらず1回のみ

**KPI**：
- 公開14日内の審査一次指摘0件
- Support返信SLA=2営業日以内

---

