# OtoTheory v3.1 — Implementation SSOT（実装正本 / Web Lite & iOS収益軸）

*最終更新: 2025/10/10*

> 本書は v3.0 Implementation SSOT をベースに、**Web LiteのGA**、**iOS収益主軸（M4）**、**Undo＝非搭載**、**PNG＝白背景固定**、**録音UI＝非露出（Flag OFF）** を反映した v3.1 の実装基準です。
> 仕様の根拠は v3.0 SSOT 正本の中核原則に準拠します。

---

## 0. v3.1 の主要差分（v3.0 → v3.1）

* **WebはM3完了のLiteをGA**：録音メニューを撤去（Flag OFF継続）、**Chord Progression中心**の体験を公開。
* **iOSを収益主軸**：M4で **セクション編集／MIDI出力（Chord Track＋Section Markers＋Guide Tones）／Sketch無制限（クラウド）／IAP（¥490/月）** を実装。
* **Undoは非搭載（キャンセル確定）**：個別削除・並べ替えで代替。DoD/Telemetryから"undo"を削除。
* **PNGは白背景固定**：v3.0の「テーマ自動反転」は停止。`export_png` は成功/失敗に関わらず**1回のみ**発火。
* **録音UIは非露出（Flag OFF）**：将来ON時のみメニュー露出／サーバ解析（/api/analyze）設計は温存。

---

## 1. スコープ & 非スコープ

**In（v3.1）**

* **Web Lite GA（M3.5）**：Analyze撤去、6面CTA、計測追加。
* **iOS v1（M4）**：Free=M3パリティ、Pro=セクション編集＋MIDI（Chord+Markers+Guide）＋無制限保存＋IAP。
* **PNG出力**：白背景固定。**Undoなし**。

**Out / vNext**

* 録音系（Analyze）機能の公開。
* Split Bar（1小節2コード）、Groove/ミニベース、MIDI多トラック拡張（Drum/Bass）はM4.1+。
* テーマ自動反転PNGの再開。

---

## 2. 画面・機能別 実装要件

### 2.1 Find Chords（M3完了／Web・iOS共通）

* **即時反映**：Key/Scale選択→**Diatonic→Fretboard（二層）**更新。Resetは**Chord層のみ**解除、Degrees/Namesトグルは最小構成。
* **Scale Table**（11種・Why文・ⓘGlossary・アルペジオ試聴）／**Chord Forms**（Open/Barre＋試聴）／**基礎代理**（2–3提案＋試聴/＋Add）。
* **Capo提案**：Diatonic折りたたみ内に**Top2（Shaped表記）**。**音は鳴らさない**。*Shaped/Sounding*注記を併記。
* **非ヘプタ**：Roman非表示（Pent/Bluesのみ例外表示）。

**DoD**

* Key/Scale→結果更新が**1操作**で完了／和音試聴は**完全同時発音（0ms）**で鳴る。

---

### 2.2 Chord Progression（Lite / Pro）

**共通（Lite）**

* **12コード上限**、**プリセットFree 20種**、4拍カウントイン→4/4自動ループ、BPM 40–240、音色5種（Distortion/Over Drive は一時除外）。**Undoなし**（削除＋D&Dで代替）。
* **結果カード→Diatonic→Fretboard（二層）→Patterns/Cadence/基礎代理**で、**「試聴→＋Add→即ループ」**の2タップ原則を厳守。

**Pro（iOS）**

* **プリセット50種（Free 20＋Pro 30）**：Free 20種（Rock 5＋Pop 5＋Blues 2＋Ballad 4＋Jazz 4）＋Pro 30種（Rock 6＋Pop 8＋Ballad 5＋Jazz 5＋Blues 2＋Other 4）。詳細は `docs/data/presets_pro_pack.md` を参照。
* **セクション編集**（Verse/Chorus/Bridge…）：追加・削除・並べ替え・名称変更／セクション単位ループ。
* **MIDI出力**（**SMF Type‑1**）：

  * **Chord Track**（Triad/7th：note-onはコード長を全拍で、ベロシティ推奨80±10）
  * **Guide Tones Track**（3rd/7th中心、ハーフノート継続を基本）
  * **Markers**（Meta：Section名・小節頭）
  * **Meta**：TimeSig=4/4、Tempo（BPM）、Key Signature（現在のKey）
* **Sketch無制限（クラウド）**、**IAP（¥490/月）**、**Paywall**実装。

**DoD**

* セクション編集の結果がMIDI Markersに同期。
* 生成MIDIをDAWに読み込むだけで**構成（Markers）・コード骨格・ガイドトーン**が再現される。

---

### 2.3 Sketch（保存・呼び出し）

* **Free**：ローカル3件（LRU上書き／自動保存3秒）
* **Pro**：無制限（クラウド同期）
* **保存項目**：Key/Scale、進行（≤12）、Capo（Shaped基準）、Fretboard表示（Degrees/Names/ガイド）。

**DoD**

* Sketch復元で**即ループ再生**＆表示状態まで完全復元。

---

### 2.4 出力（PNG/テキスト/MIDI）

* **PNG（Free）**：**白背景固定**・視認性最適化（タイトル24px/700、Key/Progression/Scale 18–16px、黒字、要素の青強調 #1e40af）。`export_png` は**1操作=1発火**。
* **テキスト（Free）**：Key/Scale、Diatonic、進行（Roman/実音）、Capo注記をコピー。
* **MIDI（iOS Pro）**：**Chord＋Markers＋Guide** を出力（SMF Type‑1）。

---

## 3. Web Lite GA（M3.5）— 実装完了 ✅

**実装日**: 2025/10/04  
**ステータス**: 完了

**A. UI/ナビ** ✅

* ✅ メニューから **Analyze（録音）** を撤去（Flag OFF）。`/analyze` は `/find-key` へリダイレクト実装。
* ✅ **6面CTA実装**：
  1. ヘッダーCTA（デスクトップ常設）
  2. モバイル下部スティッキー（スクロール200px後表示）
  3. 9コード到達トースト（info）
  4. 12コード到達トースト（warning）
  5. Sketch 4件目保存ブロック（warning）
  6. PNG出力後トースト（success）
  7. フッターQR CTA

**B. 計測** ✅

* ✅ 追加：`cta_appstore_click{place}`（`header|sticky|limit_toast|png_toast|qr`）
* ✅ 既存：`progression_play / preset_inserted / export_png / toast_shown(kind)` を継続。
* ✅ 実装：`trackCtaClick(place, extra)` 関数、各CTA箇所から発火確認。

**C. DoD（GA）** ✅

* ✅ **プリセット→即ループ→PNG出力**を**3クリック以内**で完了できる。
* ✅ CTAクリックが計測でき、Web→iOSファネルがダッシュボードで見える。
* ✅ `export_png`は成功/失敗に関わらず1回のみ発火（`toastShownRef`で制御）。
* ✅ Free制限（3 sketches, 12 chords）が正しく動作。

**D. 実装詳細**

#### 新規コンポーネント
- `src/components/Toast.client.tsx`: Toast通知システム（3種: info/warning/success）
- `src/components/HeaderCta.client.tsx`: ヘッダーCTA
- `src/components/FooterCta.client.tsx`: フッターCTA
- `src/components/MobileStickyCta.client.tsx`: モバイルスティッキーCTA

#### 主要更新
- `src/app/find-key/page.tsx`: 
  - 制限チェック（localStorage直接読み取り）
  - Toast表示ロジック
  - Export名修正（`currentExportName` state追加）
- `src/app/analyze/page.tsx`: リダイレクト実装
- `src/components/Nav.tsx`: Melody/Solo Analyze削除
- `src/app/layout.tsx`: CTA統合
- `src/lib/telemetry.ts`: `cta_appstore_click` / `trackCtaClick` 追加
- `src/app/globals.css`: Toast/CTA用アニメーション

#### バグ修正
- ✅ Sketch 4件目が保存できてしまう問題（localStorage直接読み取りで解決）
- ✅ PNG Exportでsketch名が反映されない問題（`currentExportName` state追加で解決）

**E. 統計**

| 項目 | 数値 |
|-----|------|
| **新規コンポーネント** | 4個 |
| **新規Telemetryイベント** | 1個（cta_appstore_click） |
| **CTA箇所** | 6箇所 |
| **制限チェック箇所** | 3箇所 |

**F. リリース状態**

✅ **Web Lite GAリリース準備完了**  
次はM4: iOS v1（Proの核）に進む。

---

## 2.5 Site / Marketing Pages（v3.1）

**目的**: App Store審査対応と利用者の信頼担保（法務・サポートの可視化）

**ルート**（MDX、JP/EN）:
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約（EULA相当条項を含む）
- `/subscription` - サブスク・自動更新・キャンセル・返金
- `/support` - サポート／FAQ／連絡先
- `/account-deletion` - アカウント／データ削除手順
- `/security` - セキュリティ＆データ保護（保存地域=東京、保持期間）
- `/accessibility` - アクセシビリティ声明
- `/transparency` - 透明性レポート（収集イベント一覧、保持期間=90日）
- `/licenses` - OSSライセンス（自動生成）

**導線**:
- **フッター常設リンク**（全画面共通）：Privacy | Terms | Subscription | Support | Account Deletion | Security | Accessibility | Licenses
- **App内設定**：「設定」＞「プライバシー/利用規約/アカウント削除」へ1タップ遷移
- **Web Lite本体の6面CTA**：header/sticky/limit_toast/png_toast/qr（既存実装）

**計測**:
- 追加：`cta_appstore_click{place}` 
- 既存：`page_view / export_png(必ず1回) / progression_play / preset_inserted / toast_shown(kind)` 

**実装スタック**:
- **Next.js App Router + TypeScript + MDX**
- **i18n**: `/ja` と `/en` のサブパス or ヘッダー切替
- **ホスティング**: Vercel（CDN/SSR）
- **SEO**: `<meta>`/OG/Twitterカード、`/sitemap.xml`・`/robots.txt`、構造化データ

**DoD**:
- アプリ内「設定」から `/privacy` `/terms` `/account-deletion` へ1タップ遷移
- すべての政策系URLがJP/ENで表示可能
- フッターに常設リンク実装
- 録音UIは非露出（Flag OFF）
- 公開14日内の審査一次指摘0件／Support返信SLA=2営業日以内

---

## 4. iOS v1（M4）— 実装方針

**M4-A（Freeパリティ）**

* 結果カード〜Fretboard二層、プリセット、自動ループ、Sketch3件までを実装。録音UIは**非露出**。

**M4-B（Pro核）**

* セクション編集／MIDI出力（Chord+Markers+Guide）／Sketch無制限（クラウド）／IAP。
* **計測**：`paywall_view / purchase_success / midi_export{tracks,sections,bpm}` を実装。

**技術メモ（推奨）**

* 進行・スケール・代理・MIDIライターは共通のTSパッケージ化（`packages/core`）でWeb/iOS共有。
* オーディオは**完全同時発音（0ms）**を実現（Release=80ms、最大6声、4拍リズム）。

---

### 4.1 Hybrid Audio Architecture（M4オーディオ実装方針）

**更新日**: 2025/10/10  
**ステータス**: Phase B 完了、Phase C 準備中

#### 目的

長いリリースで「音が伸びる」問題を根絶しつつ、将来のベース/ドラム追加とMIDI書き出しに対応。

#### 方式

**Hybrid = ギターPCM + ベース/ドラムMIDI**

1. **ギター（和音）** = 1小節 = 2.0秒のPCMに事前バウンス（末尾80msを波形でフェード）
2. **ベース/ドラム** = MIDI（Sequencer）で拍位置に予約
3. **再生** = `AVAudioPlayerNode`（ギター）+ `AVAudioSequencer`（B/D）を同一エンジンで同時駆動

#### 効果

- ✅ **拍ズレなし**（ギターはサンプル長で管理、B/Dはテンポトラックで管理）
- ✅ **ギターの減衰は波形内で100%制御** → 「伸び」が消える
- ✅ **将来のMIDI書き出し**はベース/ドラムはそのまま、ギターも和音をノート列として書き出し可能

#### SSOT（タイム基準）

| 項目 | 仕様 | 備考 |
|------|------|------|
| **BPM** | UI指定 | 1小節 = 4拍。BPM120なら2.000秒固定 |
| **Strum（ギター）** | 0ms（同時発音） | ユーザーフィードバックにより最適化 |
| **Release（フェードアウト）** | 80ms | 末尾を波形で線形フェード、次の音とかぶらない |
| **最大同時発音（ギター）** | 6声 | |
| **ループ** | 1ループ単位で無限繰り返し | 各小節頭に必ず無音から入る |

#### パート別ルール

##### Guitar（和音）

| 項目 | 仕様 |
|------|------|
| **音源** | SF2（Program25 Acoustic Steel等） |
| **出力** | 1小節PCM（2.0秒）に事前バウンス、末尾80msを波形で線形フェード |
| **ストローク** | 0ms（完全同時発音）、4拍リズム（じゃん×4） |
| **キャッシュ** | `(chordSymbol, program, bpm)` をキーにメモリ/LRUでキャッシュ（最大16バリエーション） |
| **サイズ** | 約0.7MB/Bar（44.1kHz/2ch/2.0s） |

##### Bass（単声）

| 項目 | 仕様 |
|------|------|
| **MIDI** | Sequencerトラックで拍位置にNoteOn/Off |
| **パターン** | 基本は 1拍目Root、3拍目5th、任意で4拍目アプローチ |
| **音源** | AUSampler（Melodic Bank / Program 34 Electric Bass finger） |

##### Drums（ch10）

| 項目 | 仕様 |
|------|------|
| **MIDI** | Sequencerトラックで16ステップ/1小節のパターン |
| **音色** | K=36（Kick）, S=38（Snare）, H=42/46（HiHat） |
| **音源** | AUSampler（Percussion Bank: `kAUSampler_DefaultPercussionBankMSB`、Program 0） |

#### システム構成（ノードと責務）

```
[Score/SSOT] --(Events)--> [Generators]
    |                         |-- GuitarEvents --> [GuitarBounceService] --> [PCM Cache(2.0s/Bar)]
    |                         |-- BassEvents   --> [SequencerBuilder]     --> [MusicSequence: Bass]
    |                         |-- DrumEvents   --> [SequencerBuilder]     --> [MusicSequence: Drums]
    |
[HybridPlayer]
    ├─ AVAudioEngine
    │    ├─ AVAudioPlayerNode (Guitar PCM)
    │    ├─ AVAudioUnitSampler (Bass)
    │    ├─ AVAudioUnitSampler (Drums, ch=10 Percussion)
    │    └─ mainMixer
    ├─ AVAudioSequencer (tempo + Bass/Drums tracks)
    └─ UI Sync (bar callbacks / meter)
```

**ノード配線**:
```
playerGtr (AVAudioPlayerNode) → mainMixer
samplerBass (AUSampler) → mainMixer
samplerDrum (AUSampler) → mainMixer（Percussion Bank）
```

**Sequencer**: `MusicTrack` の `destination` を上記サンプラーへバインド。サンプルレート: 44.1kHz、I/Oバッファ: 10ms（実機なら 5ms でも可）

#### 実装計画（段階・チェックリスト）

##### Phase A：基盤（1–2日） ✅ 完了

- [x] `Score` / `Bar` モデルを追加（既存UIのslots→Scoreに集約）
- [x] `GuitarBounceService` を新規作成（オフラインrender→PCM化→末尾80msフェード）
- [x] `HybridPlayer` の土台（Engine+PlayerNode+2サンプラー、prepare/start/stop）
- [x] `SequencerBuilder` の雛形（TempoTrackのみ）

##### Phase B：最小再生（1–2日） ✅ 完了

- [x] C/G/Am/F のギターPCMを生成してPlayerNodeで連結再生
- [x] 同じScoreからベース基本形（Root/5th）をイベント化→Sequencerで発音（Phase Cで有効化予定）
- [x] カウントインはハイハット風4拍を先頭にschedule
- [x] ループ：最後のcompletionで再スケジュール
- [x] 停止：Player/Sequencer.stop()
- [x] **UI同期**：Timer方式（0.1秒ごと）で画面と音が完全一致、遅延累積なし
- [x] **音響最適化**：ストローク0ms、フェードアウト80ms、4拍リズム実装

##### Phase C：拡張（以後）

- [ ] **音色品質改善**
  - [ ] Distortion（Program 30）：ワウペダル効果を軽減（一時的に除外中）
  - [ ] Over Drive（Program 29）：ワウペダル効果を軽減（一時的に除外中）
  - [ ] Acoustic Nylon（Program 24）：2拍目・3拍目のドラム音混入を修正（一時的に警告表示）
- [ ] ベース：有効化＋ターンアラウンド／オクターブ選択／Humanize（±5ms, ±6Vel）
- [ ] ドラム：プリセット（Rock/Pop/Funkなど）をステップで追加
- [ ] MIDI書き出し：`MusicSequenceFileCreateData` を使いSMFを生成
- [ ] キャッシュ最適化：LRU最大16バリエーション
- [ ] BPM変更時：ギターPCM再バウンス（Bass/DrumはSequencerのテンポ更新だけ）

#### 受け入れ基準（DoD）

| 項目 | 基準 | ステータス |
|------|------|-----------|
| **拍精度** | BPM120で各小節=2.000s（PlayerNodeの連結で保証） | ✅ 達成 |
| **減衰** | ギターは末尾80msで0（波形検査で確認）。ベース/ドラムはNoteOff＋CC120で尾なし | ✅ 達成 |
| **音量感** | overallGain −6dB、Reverb/Chorus/Sustain=0（ch0–1）を初期化 | ✅ 達成 |
| **最大発音** | ギター≤6声、ストローク0ms（完全同時発音） | ✅ 達成 |
| **ループ** | バウンス済みPCMの連結でクリックなし | ✅ 達成 |
| **UI同期** | 画面と音が完全一致、遅延累積なし | ✅ 達成 |
| **MIDI書き出し** | DAWに取り込んでテンポ／拍子／トラック名が有効 | 🔜 Phase C |

#### リスクと回避

**SequencerとPlayerNodeの開始ずれ**:  
→ PlayerNodeの最初のバッファを0.2s先のhostTimeに`play(at:)`予約し、その直前に`sequencer.start()`（またはクリック4発のプリロールで両者を整列）。

**メモリ**:  
→ PCMは1本≒0.7MB。LRUで同時キャッシュを12–16本に制限、重複コードは同じバッファを再利用。

**音色差**:  
→ 鳴らし分けはバウンス時にprogram指定（GuitarはPCM、Bass/Drumはt=0のProgram）で吸収。

#### 現行コードからの差分ポイント

**削除/停止**:
- `ChordSequencer` の 2バス・フェード／flush/hardKill/crossFade 系は**撤去**
- 代わりに `GuitarBounceService` + `HybridPlayer` を配置

**流用**:
- `chordToMidi` のルールはそのまま（ギターPCM生成時とSMF出力時に共用）
- CC初期化（Reverb/Chorus/Sustain=0、Volume=100）を準備時に実行

**追加**:
- `SequencerBuilder` で `MusicTrack` の `dest` を `Sampler` へ明示バインド（Bank/Program= t=0）
- `GuitarBounceService` の manual rendering と 末尾フェード（80ms）
- `HybridPlayer` で ギターPCM schedule＋Sequencer.start() の同時スタート

#### 実装インターフェース（Swift雛形）

##### Score（SSOTモデル）
```swift
struct Score {
    var bpm: Double
    var bars: [Bar]
}

struct Bar {              // 1小節分
    var chord: String     // "C", "Am7", "G/B" など
}
```

##### GuitarBounceService（1小節PCMを作る）
```swift
final class GuitarBounceService {
    struct Key: Hashable { let chord: String; let program: UInt8; let bpm: Double }
    private var cache: [Key: AVAudioPCMBuffer] = [:]

    func buffer(for key: Key, sf2: URL, strumMs: Double = 0, releaseMs: Double = 80) throws -> AVAudioPCMBuffer {
        // 1) オフラインエンジン(enableManualRenderingMode .offline, 44.1k/2ch)
        // 2) 4拍リズム：各拍頭で strum(<=6声)を noteOn、拍の70%でnoteOff
        // 3) 2.0秒ぶん renderOffline してバッファへ
        // 4) 末尾 releaseMs を線形フェード（波形を 0 に）
        // 5) cache[key] = buffer; return
        // ✅ 実装済み：LRUキャッシュ最大16バリエーション
    }
}
```

##### HybridPlayer（再生）
```swift
final class HybridPlayer {
    let engine = AVAudioEngine()
    let playerGtr = AVAudioPlayerNode()
    let samplerBass = AVAudioUnitSampler()
    let samplerDrum = AVAudioUnitSampler()
    var sequencer: AVAudioSequencer!

    func prepare(sf2: URL, drumKit: URL?) throws {
        // Engine/PlayerNode/Sampler×2 を attach & connect
        // Bass/Drum SF2 をロード
    }

    func play(score: Score, guitarBuffers: [AVAudioPCMBuffer], onBarChange: @escaping(Int)->Void) throws {
        // 1) Sequencer 準備（Bass/Drum - Phase Cで有効化）
        // 2) カウントイン（2秒、ハイハット風4拍）を先頭に schedule
        // 3) PlayerNode にギターPCMを順番に schedule（連結で隙間なし）
        // 4) 同時スタート（hostTime指定で開始）
        // 5) Timer で UI 同期（0.1秒ごとに現在時刻をチェック、バーが変わったら onBarChange 呼び出し）
        // 6) ループ：最後のバッファ completion で 2サイクル分を再 schedule
        // ✅ 実装済み：完全同期、遅延累積なし
    }
}
```

#### まとめ（決定事項）

| 項目 | 決定内容 | 実装状況 |
|------|----------|-----------|
| **方式** | Hybrid = ギターPCM + ベース/ドラムMIDI | ✅ Phase B 完了 |
| **SSOT** | Strum 0ms、Release 80ms（波形フェード）、最大6声、1小節=2.000s | ✅ 達成 |
| **構成** | PlayerNode（Gtr）, Sampler×2（Bass/Drum）, Sequencer（BPM/Tracks） | ✅ 実装済み |
| **UI同期** | Timer方式（0.1秒ごと）で画面と音が完全一致 | ✅ 達成 |
| **ロードマップ** | Phase A→B（完了）→C（音色改善・ベース有効化・MIDI出力） | 🔜 Phase C |

**このハイブリッド方式により、「音が伸びる」問題が完全に解決され、将来のベース/ドラム/MIDI書き出し機能がスムーズに実装できます。**

---

## 5. データ契約（概念TS）

```ts
// Sketch（永続化）
interface SketchV1 {
  id: string;
  name: string;
  createdAt: string; updatedAt: string;
  schema: 'sketch_v1'; appVersion: string;
  key: { tonic: string; scaleId: string }; // 例: C, ionian
  capo: { capoFret: number; notation: 'Shaped' }; // Shaped基準で保存
  progression: { bars: BarV1[]; maxBars: 12 }; // Lite
  fretboardView: { mode: 'Degrees'|'Names'; showGuides: boolean };
}

interface BarV1 {
  chord: string; // 例: Cmaj7
  beats: 4;      // Liteは常に4
}
```

---

## 6. Telemetry（イベント仕様）

**共通**

* `page_view, key_pick, scale_pick, diatonic_pick, overlay_shown(初回のみ), fb_toggle, overlay_reset, play_note, play_chord, export_png(常に1回), instrument_change`。

**進行**

* `progression_play{bpm, chordCount}`／`preset_inserted{name}`／`toast_shown{kind=limit_warn|limit_block|low_conf}`（**undoは廃止**）。
* **Web→iOS**：`cta_appstore_click{place}` を新設。
* **iOS Pro**：`paywall_view`／`purchase_success`／`midi_export{tracks,sections,bpm}`。

**保存**

* `save_project, open_project, project_rename, project_delete, project_duplicate, project_limit_warn, project_limit_block`。

**録音（将来）**

* `audio_record_start/stop, audio_analyze_ok, audio_analyze_conf(engine, conf)`（Flag OFF 継続）。

---

## 7. 受け入れ基準（DoD）

1. **Find Chords**：Key/Scale選択のみでResult更新。Open行タップで和音再生＆Chord層強調。ResetでScale保持。
2. **Capo**：折りたたみ内にTop2（Shaped）＋注記。音は鳴らさない。
3. **Progression**：**ドラッグ並べ替え**／**プリセット→自動ループ**が動作（**Undoなし**）。
4. **提案追加**：Patterns/Cadence/基礎代理は**試聴→＋Add**を2タップ以内、直後に自動再生。
5. **Sketch**：Key/Scale・Capo（Shaped）・進行・Overlay表示が完全復元。Free=3件、Pro=無制限。
6. **出力**：Free＝PNG（白固定）/テキスト、Pro＝MIDI（Chord+Markers+Guide）。`export_png`は必ず1回。
7. **Web GA**：プリセット→即ループ→PNG出力が3クリック以内／`cta_appstore_click` が計測可能。
8. **iOS Pro**：MIDIをDAWに読み込むだけで構成・Chord・Guideが再現、`paywall_view/purchase_success` が発火。
9. **M4 Week 1 完了（2025-10-04）**：Xcode環境構築・`packages/core`（2.2KB）・`parseChord`/`getDiatonicChords` 動作・Audio Engine 音出し確認。
10. **M4 Week 2 完了（2025-10-04）**：Tab Bar Navigation（3画面）・12-Slot UI・Root+Quick選択・Preview+Add常時表示・削除ボタン・コード再生（12キー×7種類）・Web版UX完全準拠・NavigationTitle削除。
11. **M4 Week 3 完了（2025-10-10）**：Hybrid Audio Architecture（Phase A & B）実装完了。ストローク0ms・フェードアウト80ms・4拍リズム・UI同期（Timer方式）・ループ機能。もたつきゼロ、コードの変わり目クリア。

---

## 8. Feature Flags / 環境変数

* `RECORDING_UI_ENABLED = false`（既定）
* `PNG_THEME_AUTO_INVERT = false`（v3.1）
* `UNDO_ENABLED = false`（v3.1）
* `CTA_APPSTORE_ENABLED = true`（Webの6面CTA）

---

## 9. QA / A11y / NFR

* **TTFI ≤ 2s**（Web）、Overlay再描画≤16ms（p95）。
* **A11y**：roving-tablist／focus-visible／色以外の手掛かり。
* **PNG**：ライト/ダーク双方で可読（白背景固定・黒字）。**export_pngは一度のみ**。

---

## 10. リリース & 運用

* **Web GA（M3.5）**：Analyze非露出、6面CTA、計測導入→ダッシュボードでWeb→iOSファネル監視。
* **iOS v1（M4）**：Freeパリティ→Pro機能（MIDI/セクション/IAP）→App Review。
* **ロールバック**：CTAの場所別ON/OFF／Paywall文言のサーバ駆動（Remote Config推奨）。

---

## 11. 付録：用語

* **Sketch**：進行＋Key/Scale＋Capo（Shaped）＋Fretboard表示の保存単位。
* **Guide Tones**：主に3rd/7th。MIDIでは別トラックに出力。
* **Shaped/Sounding**：押さえ方と実音の区別。Capo注記に併記。

---

