# OtoTheory v3.1 — Implementation SSOT（実装正本 / Web Lite & iOS収益軸）

*最終更新: 2025/10/16*

## 🔄 最新更新（2025-10-16）

### Chord Library 5フォーム拡張 + My Forms 🚧 実装中

#### 概要
既定の3フォームから5フォームへの上位互換拡張。My Forms保存機能を追加し、iOS収益軸（CloudKit/Pro）とWeb送客（ローカル保存/Free）を強化。

#### 方針
- **最低保証**: 3フォーム（Open / E-shape / A-shape）
- **推奨拡張**: 5フォーム（上記 + Compact + Color）
- **iOS先行**: 5フォーム版を直接実装（3フォーム中間版はスキップ）
- **Web後回し**: 1コード=1ページ化は次スプリント（広告/SEO最適化と合わせて実施）

#### 実装統計
- **新規ファイル**: 7個（2,262行）
- **更新ファイル**: 3個
- **対応コード**: 12ルート × 40+品質 = 480+コード
- **実装期間**: 2025-10-16（1日）
- **ビルド状態**: ✅ BUILD SUCCEEDED

#### 実装内容

**iOS（優先）**:
1. **5フォーム生成ロジック**
   - Open（開放弦）
   - E-shape Barre（6弦ルート）
   - A-shape Barre（5弦ルート）
   - Compact（上4弦、把弦負荷軽減）
   - Color（add9/6/9/sus2/4から響き重視で自動選択）

2. **My Forms保存**
   - Free: UserDefaults（最大30、LRU）
   - Pro: CloudKit同期（無制限、既存Sketchインフラ活用）
   - Model: `SavedForm { id, root, quality, shapeKind, diagram, createdAt }`

3. **長押し導線**
   - Find Chords / Progression のコードチップから長押し
   - モーダルで ChordLibraryView を表示（シード: root + quality）
   - ハプティクス + トースト通知

4. **UI最適化**
   - 横スクロール（TabView / ScrollViewReader）
   - 横向き推奨バナー（縦向き時に表示）
   - ☆ボタンで My Forms へ保存/削除
   - 表示順を固定: **Open → Root-6 → Root-5 → Root-4 → Triad-1 → Triad-2**
   - `shapeName` 未指定フォームのタイトルをUI側で推定（Open/Root-6/5/4/Triad）

5. **Static v0 データ投入（本スプリント）**
   - 7th / maj7 / m7 を中心に、C〜B＋派生の各フォーム（Open/Root-6/5/4）を大量追加
   - 参照: `StaticChordProvider.swift`、`StaticChordLibraryView.swift`

**Web（次スプリント）**:
- 1コード=1ページルーティング（/resources/chord-library/[root]/[quality]）
- 構造化データ（JSON-LD）+ Sitemap更新
- AdSlot統合（コード詳細ページ末尾）
- My Forms（localStorage、Free=30上限）

#### Telemetryイベント追加
- `chord_form_shown`: フォーム表示時
- `play_chord{source=form_preview}`: プレビュー再生時
- `myform_save`: My Forms保存時
- `myform_open`: My Forms一覧表示時
- `myform_delete`: My Forms削除時

#### Pro制限の整合性
- **プレビュー**: すべてのフォーム（Colorを含む）で自由に試聴可能
- **進行追加**: 既存のPro制限を継続（Altered/13th/Slash）
- **My Forms**: Free=30上限、Pro=無制限（CloudKit）

#### DoD
- [x] iOS 5フォーム生成ロジック実装
- [x] My Forms CRUD（UserDefaults + CloudKit）
- [ ] 長押し導線統合（Find Chords / Progression） ← 次フェーズ
- [x] 横向き最適化 + UI微調整
- [x] Telemetryイベント実装
- [x] ビルド成功（Debug / Release）
- [x] 実装レポート作成

> **✅ Phase 1 完了**: コア機能実装完了（2025-10-16）
> **⏳ Phase 2**: 長押し導線は次フェーズで実装予定

---

## 🔄 最新更新（2025-10-14）

### Advanced Chords Pro制限 & Chord Library修正 ✅ 完了

#### Pro制限機能（Web & iOS共通）
- **Altered Dominant制限**: 7b9, 7#9, 7#11, 7b13, 7alt → Pro専用
- **13th系制限**: 13, M13, m13 → Pro専用
- **Slash/On-Bass制限**: C/E等のベース音指定 → Pro専用
- **👑 Proバッジ**: Pro専用コードチップの右上に小さく表示（Free時のみ）
- **プレビュー再生**: すべてのコード（Pro制限対象含む）で可能
- **Add制限**: Freeユーザーは制限対象コードの追加がブロックされる

#### 11th警告機能
- **対象**: maj/domコンテキストで`11`を選択時
- **頻度**: セッション1回のみ表示
- **文言**: 
  - EN: "11 clashes with the 3rd on maj/dom. Consider #11 or sus4."
  - JA: "11はmaj/domでは3rdと衝突しがち。#11またはsus4を検討"

#### Chord Library CM7修正
- **問題**: CM7の2番目と3番目が同じA型フォームになっていた
- **原因**: E型Maj7フォーム (`shapeE_Maj7`) が未実装
- **修正**: 
  - `shapeE_Maj7(r)` 関数を追加（フレット配置: [r, r+2, r+1, r+1, r, r]）
  - 2番目のフォーム生成ロジックで `shapeE_Maj7(r)` を使用
- **結果**: CM7で3つの異なるフォームが表示される
  1. Open形
  2. Barre (E-shape, M7) — 新規追加
  3. Barre (A-shape, M7)

#### i18n文言追加
- **Web**: `messages.ts` に以下を追加
  - `chordBuilder.proOnlyToast`: Pro専用トースト
  - `chordBuilder.proOnlyToastCta`: "Get Pro" / "Proを入手"
  - `chordBuilder.eleventhWarning`: 11th警告文言
- **iOS**: 既存のProManager文言を活用

#### 実装ファイル（Web）
- `/lib/pro/guard.ts` — 新規作成
  - `canAddQuality()`: Pro制限チェック関数
  - `shouldShowProBadge()`: バッジ表示判定
  - `getProOnlyReason()`: Pro専用理由取得（telemetry用）
- `/components/ChordBuilder.tsx` — 修正
  - 👑 Proバッジコンポーネント追加
  - `onBlock`, `onPreview` コールバック追加
  - 11th警告のセッション管理
  - Alterations全チップに👑バッジ表示
- `/lib/chord-library.ts` — 修正
  - `shapeE_Maj7()` 関数追加
  - 2番目フォーム生成で `shapeE_Maj7(r)` 使用
- `/lib/i18n/messages.ts` — 修正
  - chordBuilder文言追加（EN/JA）

#### 実装ファイル（iOS）
- `/Services/ProManager.swift` — 修正
  - `proOnlyQualities` Set定義
  - `canAddQuality(_:hasSlash:)` 関数追加
  - `shouldShowProBadge(_:hasSlash:)` 関数追加

#### DoD
- ✅ Pro制限ロジック実装（Web/iOS）
- ✅ 👑 Proバッジ表示（チップ右上）
- ✅ 11th警告機能（セッション1回）
- ✅ CM7 E型フォーム追加・修正
- ✅ i18n文言追加（EN/JA）
- ✅ Web/iOSビルド成功
- ✅ デプロイ完了（commit 80d04ad）

> **✅ 完了**: Advanced Chords Pro制限機能とChord Library CM7修正が実装され、本番デプロイ完了。

---

### Phase 4: Sketch無制限（クラウド同期） ✅ 完了

#### CloudKitManager実装
- **iCloud統合**: CloudKitを使用したスケッチの自動バックアップ & 同期
- **CRUD操作**: `saveSketch()`, `fetchAllSketches()`, `deleteSketch()`
- **競合解決**: Last-Write-Wins（lastModified基準）
- **エラーハンドリング**: iCloud可用性チェック、ネットワークエラー表示

#### SketchManager拡張
- **Pro判定**: `maxSketches`（Free: 3 / Pro: 無制限）、`canUseCloudSync`
- **Singleton化**: `SketchManager.shared` で全画面から同一インスタンスにアクセス
- **自動同期**: `save()`, `delete()`, `rename()` 実行時に自動的にiCloudへ同期
- **手動同期**: `syncWithCloud()` - 全スケッチの完全同期
- **状態管理**: `isSyncing`, `lastSyncDate`, `syncError`

#### UI実装
- **Pro機能表示**: スケッチ数無制限表示、同期ボタン、最終同期日時
- **Free機能表示**: "X / 3 sketches"、制限到達警告、Pro誘導ボタン
- **同期状態**: ローディング表示、相対時間表示（"5m ago"）、エラー表示
- **Paywall統合**: Pro誘導ボタンからPaywallView表示

#### CloudKit設定
- **Bundle Identifier**: `TH-Quest.OtoTheory`
- **CloudKit Container**: `iCloud.TH-Quest.OtoTheory`
- **Record Type**: `Sketch`
- **Indexes**: `recordName` (QUERYABLE), `lastModified` (Queryable, Sortable)
- **Dashboard URL**: https://icloud.developer.apple.com/dashboard/

#### UX改善（追加実装）
- **Sketch導線統一**: `SketchTabView.swift` 削除、タブバーから直接 `SketchListView` 表示
- **Convert to Section機能拡張**: `ConvertToSectionSheet` 新規作成
  - Section Type選択（Intro, Verse, Pre-Chorus, Chorus, Post-Chorus, Bridge, Outro）
  - Section Name編集（デフォルト値自動入力）
  - 重複名の自動番号付与（"Verse" → "Verse (1)" → "Verse (2)"）

#### DoD
- ✅ CloudKitManager実装（CRUD + 同期ロジック）
- ✅ SketchManager統合（Pro判定 + 自動同期）
- ✅ UI実装（同期状態表示、Pro/Free区別）
- ✅ Xcode Capabilities設定（iCloud + CloudKit有効化）
- ✅ CloudKit Dashboard設定（recordName QUERYABLE）
- ✅ ビルド成功、iPhone実機で動作確認
- ✅ iCloud同期確認（デバイスからクラウドへ保存）
- ✅ Sketch導線統一
- ✅ Convert to Section機能拡張
- ⏳ **複数デバイス間同期テスト（要追加デバイス）**

> **✅ 完了**: CloudKit機能が有効化され、iCloud同期が動作確認済み。Dashboardで `recordName` インデックスを QUERYABLE に設定完了。

---

### Phase 5: プリセット拡張 ✅ 完了

#### プリセット数の拡張
- **Before**: 20種（すべてFree）
- **After**: 50種（Free 20 + Pro 30）
- **Pro専用**: 30種（Pop 10, Rock 5, Jazz 7, Blues 2, R&B/Soul 3, Acoustic 3）

#### ジャンル拡張
- **Before**: 5カテゴリー（Rock, Pop, Blues, Ballad, Jazz）
- **After**: 7カテゴリー（Pop, Rock, Jazz, Blues, Ballad, R&B/Soul, Acoustic）

#### UI/UX改善
- ジャンルセレクターをチップスタイルに変更（スクロール可能）
- プリセット数を表示（Freeユーザー: "4 +10 🔒"形式、Proユーザー: "14"）
- Pro Onlyセクションヘッダーを魅力的に改善（"⭐ Pro Only — Unlock X More Presets"）
- ロックUIを強化（🔒アイコン + "Pro"ラベル、⭐アイコン）

#### DoD
- ✅ 50種のプリセット実装（Free 20 + Pro 30）
- ✅ 7カテゴリーに整理
- ✅ ジャンルチップUIで視認性向上
- ✅ Pro Onlyプリセットの魅力的な表示
- ✅ Freeユーザーへの適切なPro誘導
- ✅ すべてのプリセットが正常動作

---

### Phase E-8: UX改善 & MIDI修正 ✅ 完了

#### MIDI小節数問題の修正
- **問題**: GarageBandで小節数が倍になる（19コード → 38小節）、四分音符の長さが倍
- **原因**: `barDuration = 8.0`（本来は4.0）
- **修正**: すべてのMIDI関数で`barDuration = 4.0`、`quarterNote = 1.0`に統一
- **結果**: 正確な小節数、四分音符の長さがアプリ内再生と一致

#### Sectionsボタンの混乱解消
- **問題**: "Sections"ボタンが2つあり、どちらを押すべきかわかりにくい
- **修正**: 
  - 変換ボタン → "Enable Sections"（青色、grid.2x2アイコン）
  - 管理ボタン → "Section (3)"（グレー、grid.3x2アイコン）
- **結果**: 明確な区別、UX向上

#### 上部メニューボタンのレイアウト改善
- **問題**: 4つのボタンが1行に並び、文字が潰れて読めない
- **修正**: 
  - 2行レイアウトに変更（Row1: Preset, Section, Reset / Row2: Enable Sections, Sketches）
  - ボタンデザインを縦型（VStack: アイコン大 + テキスト小）に変更
- **結果**: アイコンが見やすい、文字が読める、余裕のあるレイアウト

### Phase E-7: Sketch一覧UI改善 ✅ 完了（前回）
- スケール名を表示（Ionian → Major Scale、Aeolian → Natural Minor）
- 経過時間（relative time）を削除
- セクションモードの表示を改善（紫色バッジで「3 sections • 15 chords」と表示）
- カード型UIで視認性向上（ボーダー付き、padding調整）
- メニューボタンのアイコンを円形に変更

### Convert to Sections機能追加 ✅ 完了（前回）
- セクションなしで作成したコード進行を、後からセクション扱いに変換可能
- "Enable Sections"ボタンを追加（セクションなしかつコードがある場合のみ表示）
- 変換時に「Main」セクションを自動作成し、既存のコードをコピー

### MIDI Export改善 ✅ 完了（前回）
- セクションマーカーの小節数計算を修正（空スロットを除外）
- セクション名のマーカーをシンプル化（繰り返し回数を表示から削除）
- デバッグログ追加（各セクションの開始位置と長さを表示）

### スケール名称の統一 ✅ 完了（前回）
- 全UIで「Ionian」→「Major Scale」、「Aeolian」→「Natural Minor」に統一
- SSOT に明記

> 本書は v3.0 Implementation SSOT をベースに、**Web LiteのGA**、**iOS収益主軸（M4）**、**Undo＝非搭載**、**PNG＝白背景固定**、**録音UI＝非露出（Flag OFF）** を反映した v3.1 の実装基準です。
> 仕様の根拠は v3.0 SSOT 正本の中核原則に準拠します。

---

## 0. v3.1 の主要差分（v3.0 → v3.1）

* **WebはM3完了のLiteをGA**：録音メニューを撤去（Flag OFF継続）、**Chord Progression中心**の体験を公開。
* **iOSを収益主軸**：M4で **セクション編集／MIDI出力（Chord Track＋Section Markers＋Guide Tones）／Sketch無制限（クラウド）／IAP（¥490/月）** を実装。
* **Undoは非搭載（キャンセル確定）**：個別削除・並べ替えで代替。DoD/Telemetryから"undo"を削除。
* **PNGは白背景固定**：v3.0の「テーマ自動反転」は停止。`export_png` は成功/失敗に関わらず**1回のみ**発火。
* **録音UIは非露出（Flag OFF）**：将来ON時のみメニュー露出／サーバ解析（/api/analyze）設計は温存。

---

## 1. スコープ & 非スコープ

**In（v3.1）**

* **Web Lite GA（M3.5）**：Analyze撤去、6面CTA、計測追加。
* **iOS v1（M4）**：Free=M3パリティ、Pro=セクション編集＋MIDI（Chord+Markers+Guide）＋無制限保存＋IAP。
* **PNG出力**：白背景固定。**Undoなし**。

**Out / vNext**

* 録音系（Analyze）機能の公開。
* Split Bar（1小節2コード）、Groove/ミニベース、MIDI多トラック拡張（Drum/Bass）はM4.1+。
* テーマ自動反転PNGの再開。

---

## 2. 画面・機能別 実装要件

### 2.1 Find Chords（Web: M3完了／iOS: Phase E実装予定）

**Web版（完了）**:
* **即時反映**：Key/Scale選択→**Diatonic→Fretboard（二層）**更新。Resetは**Chord層のみ**解除、Degrees/Namesトグルは最小構成。
* **Scale Table**（11種・Why文・ⓘGlossary・アルペジオ試聴）／**Chord Forms**（Open/Barre＋試聴）／**基礎代理**（2–3提案＋試聴/＋Add）。
* **Capo提案**：Diatonic折りたたみ内に**Top2（Shaped表記）**。**音は鳴らさない**。*Shaped/Sounding*注記を併記。
* **非ヘプタ**：Roman非表示（Pent/Bluesのみ例外表示）。

**iOS版（Phase E-1 ~ E-4A完了）**:

*最終更新: 2025-10-12（Phase E-1 ~ E-4A実装完了）*

#### Fretboard（二層Overlay） ✅ 完了
* **レイアウト**: 6弦×15フレット、Open string、フレット番号ドット（0,1,3,5,7,9,12,15）、ナット線（太線）
* **二層Overlay システム**:
  - **Scale層**（ゴースト）: 小さい、薄い、輪郭のみ
  - **Chord層**（メイン）: 大きい、塗りつぶし、ラベル付き
* **表示モード**: Degrees（度数）/ Names（音名）切り替え（°/♪ボタン）
* **色システム**: Root（特別色）、3rd/5th/7th（段階的）、その他スケール音
* **インタラクション**: タップで単音試聴、Reset（Chordのみ）、長押し未実装
* **Landscape Full-Screen**: 
  - OrientationManager統合（強制横向き）
  - タブバー自動非表示
  - Chord/Scale情報トップバー表示
  - 2段階Reset（Preview Scale → Chord → Scale Only）
* **技術**: SwiftUI Canvas描画、AVAudioEngine連携、Web版準拠デザイン（弦線なし）

#### Diatonic Table ✅ 完了
* **Roman数字表示**: I-VII、Major/Minor/Diminished表記
* **Open行**: 
  - タップで和音試聴、Fretboard Chord層更新、視覚的選択フィードバック
  - 再タップで選択解除
  - **長押し**でChord Progressionに追加（Toast通知＋ハプティク）
* **Capo行**: Top 2表示、Shaped表記（C, G, D, A, E）、音鳴らさない
* **Synchronized Scrolling**: Roman数字、Open、Capo行すべて同期
* **Enharmonic Key対応**: Eb, Ab, Bb → D#, G#, A#へマッピング
* **TheoryBridge連携**: `getDiatonicChords`でI-VII取得

#### Suggested Scales for this chord ✅ 完了
* **Chord Quality判定**: Major, Minor, Dom7, Dim, m7b5を自動認識
* **スケール提案**:
  - Major → Major Scale, Lydian
  - Minor → Natural Minor, Dorian, Phrygian
  - Dom7 → Mixolydian, Altered, Diminished
* **インタラクション**:
  - タップでアルペジオ試聴（ScalePreviewPlayer）
  - Fretboardドットが提案スケールに更新
  - Reset機能で元のスケールに戻す

#### Substitute Chords ✅ 完了
* **和声理論ベース**: Same function, Modal interchange, Secondary dominants, Tritone sub
* **提案内容**: 代理コード名、理由、使用例
* **インタラクション**:
  - ▶ボタンで和音試聴
  - **長押し**でChord Progressionに追加（Toast通知＋ハプティク）

#### コード追加機能 ✅ 完了（Phase E-4A）
* **ProgressionStore**: Singleton共有ストア、`slots`管理、ハイライト機能
* **長押しジェスチャー**: Diatonic/Substitute chords → Progression追加（0.5秒）
* **視覚的フィードバック**:
  - チップ縮小アニメーション（80% + 半透明）
  - スロットハイライト（緑枠、"New!"バッジ、1.05倍拡大、2秒自動消滅）
  - Toast通知（"Added C → Slot 3"、アイコン＋色分け）
* **ハプティクフィードバック**: 成功振動/警告振動（UINotificationFeedbackGenerator）
* **メモリ管理**: ScalePreviewPlayer二重初期化防止、非同期処理でUIフリーズ回避

#### Fretboard & Diatonic & Roman in Chord Progression ✅ 完了（Phase E-6）

*最終更新: 2025-10-13*

**Phase E-6A: Fretboard表示問題の完全解決** ✅ 完了
* **問題修正**:
  - 6弦下の横線問題（Divider削除）
  - 横スクロール不可問題（verticalSizeClass判定、scrollDisabled(false)）
  - 窮屈な表示問題（Canvas高さクランプ、Row高さ最適化）
* **技術改善**:
  - `isLandscape` → `verticalSizeClass` ベースの判定
  - Canvas高さを親にクランプ（geometry.size.height固定）
  - 背景矩形を6弦下端までピクセルスナップ（ヘアライン解消）
  - Row高さ計算を親に収まるように修正

**Phase E-6B: 全モード対応のダイアトニックコード実装** ✅ 完了
* **対応スケール**: 
  - Ionian (Major), Dorian, Phrygian, Lydian, Mixolydian, Aeolian (Minor), Locrian
  - HarmonicMinor, MelodicMinor
  - MajorPentatonic, MinorPentatonic
* **Capo提案**: 全モード対応（Open chordに基づく提案）

**Phase E-6C: Roman Numerals実装** ✅ 完了
* **機能**: コード進行をスケールの度数で表示
* **表示例**: `I – vi – IV – V`
* **Quality対応**: Major（大文字）/ Minor（小文字）/ Diminished（°）

**Phase E-6D: Patterns実装** ✅ 完了
* **検出パターン**:
  - Canon Progression (I-V-vi-IV)
  - Doo-wop (I-vi-IV-V)
  - Blues I-IV-V (I-IV-V-IV)
  - Pop Progression (vi-IV-I-V)
  - ii-V-I (Jazz) (ii-V-I)
  - 50s Progression (I-vi-ii-V)
* **表示**: パターン名、Roman Pattern、Bars位置

**Phase E-6E: Cadence実装** ✅ 完了
* **検出カデンツ**:
  - Perfect Cadence (V→I) - 完全終止
  - Plagal Cadence (IV→I) - アーメン終止
  - Deceptive Cadence (V→vi) - 偽終止
  - Half Cadence (...→V) - 半終止
* **表示**: カデンツ名、Roman Pattern、Bars位置

#### 統合 ✅ 完了
* **FindChordsView**: 
  - Key/Scale選択（12キー×14スケール）
  - Diatonic Table → Fretboard → Suggested Scales → Substitute Chords
  - Full-Screen Fretboard Mode（Chord/Preview Scale情報表示）
* **ProgressionView**: 
  - ProgressionStore統合
  - スロットハイライト機能
  - 将来：結果カード下にFretboard統合予定

**DoD（共通）**

* ✅ Key/Scale→結果更新が**1操作**で完了
* ✅ 和音試聴は**完全同時発音（0ms）**で鳴る
* ✅ Fretboard二層Overlay動作
* ✅ Degrees/Names切り替え
* ✅ Diatonic Table統合（Open + Capo Top2）
* ✅ Landscape Full-Screen（強制横向き）
* ✅ Suggested Scales（アルペジオ試聴）
* ✅ Substitute Chords（和声理論ベース）
* ✅ 長押しでProgression追加
* ✅ Toast通知＋ハプティクフィードバック
* ✅ Advanced Chord Builder（Phase E-4B）
* ✅ Slash Chord Editor（Phase E-4C）
* ✅ Section別コード進行（Phase E-5A~F）
* ✅ PlaybackOrderEditor（Phase E-5C）
* ✅ Fretboard & Diatonic in Chord Progression（Phase E-6A~B）
* ✅ Roman Numerals（Phase E-6C）
* ✅ Patterns自動検出（Phase E-6D）
* ✅ Cadence自動検出（Phase E-6E）
* ✅ Sketch保存機能（Phase E-7）

#### Sketch保存機能 ✅ 完了（Phase E-7）

*最終更新: 2025-10-13*

**Phase E-7: Sketch保存機能の完全統合**
* **Sketchモデル拡張**: Fretboard表示モード、セクション情報保存
* **保存ボタン**: Tools Sectionの最後に配置
* **保存・復元ロジック**: 全状態の保存・復元
* **通知ベース読み込み**: SketchTabViewからの読み込み対応
* **MIDIエクスポート統合**: セクションモード対応
* **LRU方式**: Free版は最大3件（ローカル保存）

---

### 2.2 Chord Progression（Lite / Pro）

**共通（Lite）**

* **12コード上限**、**プリセットFree 20種**、4拍カウントイン→4/4自動ループ、BPM 40–240、音色5種（Distortion/Over Drive は一時除外）。**Undoなし**（削除＋D&Dで代替）。
* **結果カード→Diatonic→Fretboard（二層）→Patterns/Cadence/基礎代理**で、**「試聴→＋Add→即ループ」**の2タップ原則を厳守。

**Pro（iOS）**

* **プリセット50種（Free 20＋Pro 30）**：Free 20種（Rock 5＋Pop 5＋Blues 2＋Ballad 4＋Jazz 4）＋Pro 30種（Rock 6＋Pop 8＋Ballad 5＋Jazz 5＋Blues 2＋Other 4）。詳細は `docs/data/presets_pro_pack.md` を参照。
* **セクション編集**（Verse/Chorus/Bridge…）：**各セクションが独立したコード進行を持つ**、追加・削除・並べ替え・名称変更／セクション単位ループ／リピート回数。
  - **データ構造**: `SectionDefinition { id, name, type, chords: [String?] }`、`PlaybackOrder { items: [PlaybackItem] }`
  - **PlaybackItem**: `{ id, sectionId, repeatCount }`
  - **例**: Verse ["C","Am","F","G"] ×2、Chorus ["F","G","C","Am"] ×1、Bridge ["Dm","Em","Am","G"] ×1
  - **PlaybackOrderEditor** ✅ 完了（2025-10-13）:
    * ドラッグ&ドロップでセクション順序変更
    * ±ボタンで繰り返し回数調整（1-99回）
    * プレビューヘッダー（総セクション数、総コード数）
    * AddToPlaybackOrderSheet（セクション選択UI）
    * 削除されたセクションの検出（Orphaned item表示）
  - **SectionType拡張** ✅ 完了（2025-10-13）:
    * Post-chorusセクションタイプを追加（`postChorus`）
    * アイコン: `star.circle.fill`
  - **Fretboard & Diatonic & Roman（Chord Progression）** ✅ 完了（2025-10-13）:
    * **Phase E-6**: Result下のToolsセクションに統合（Web版同様の構成）
    * **Fretboard Section**:
      - FretboardView統合（15フレット、6弦）
      - Degrees/Names toggle（状態管理: `fbDisplay: FretboardDisplay`）
      - Overlay表示（`overlayChordNotes: [String]`でダイアトニックコード選択時に自動表示）
      - FretboardOverlay構造体を使用（scaleRootPc, scaleType, chordNotes, display）
    * **Diatonic Table Section**:
      - DiatonicTableView統合
      - タップで再生（`onChordTap`）
      - 長押しで進行に追加（`onChordLongPress`、Phase E-4A連携）
      - `selectedDiatonicChord: String?`で選択状態管理
    * **Roman Numerals Section**:
      - 進行をローマ数字表記で表示（I, ii, iii, IV, V, vi, vii°）
      - 横スクロール対応（長い進行でも全表示）
      - `getRomanNumeral(for:key:scale:)` ヘルパー関数でコードをローマ数字変換
      - コードのquality（major/minor/dim/7/maj7）を反映
    * **Helper Functions**:
      - `noteToMidi(_:)`: 音名→MIDIノート番号変換
      - `getChordNotes(chord:key:)`: コード名→音名配列変換（Fretboard overlay用）
      - `keyToPitchClass(_:)`: 音名→ピッチクラス（0-11）変換
      - `getRomanNumeral(for:key:scale:)`: コード→ローマ数字変換
    * **コンパイル最適化**:
      - `toolsSection` @ViewBuilderで分離（コンパイラタイムアウト回避）
      - `fretboardSection`, `diatonicSection`, `romanSection`に細分化
* **MIDI出力**（**SMF Type‑1**）：*最終更新: 2025-10-12（5トラック構成、DAW対応完全強化）*

  * **Tempo Track** (Track 0):
    - **Tempo**（BPM 120）
    - **Key Signature** (FF 59 02 sf mi) - Major/Minor判定、調号自動表示
    - **Time Signature** (FF 58 04 04 02 18 08) - 4/4拍子
    - **Chord Symbols**（Marker Type 6、タイムライン表示）
    - **Section Markers**（Marker Type 6）
  * **Track 1: Guitar** [Program 24: Nylon String Guitar] (Channel 0)
    - **Block Chords**（Root+3rd+5th+7th、全音符、Close Voicing）
    - **Close Voicing Algorithm**: 前のコードからの最小移動距離を計算
    - 音域: C3-C5 (MIDI 48-72)
    - Velocity: 80
  * **Track 2: Bass** [Program 33: Acoustic Bass] (Channel 1)
    - **Root-5th-Root-5th パターン**（4分音符）
    - 音域: C2-C3 (MIDI 36-48)
    - Velocity: 90
  * **Track 3: Scale Guide (Bass)** [Program 33] (Channel 2)
    - スケール構成音（低音域 C2-C3、1オクターブ、ベース作成用、Velocity 20）
    - Pattern: 上昇→下降（1小節で往復、125ms間隔）
    - ★OtoTheory独自機能
  * **Track 4: Scale Guide (Middle)** [Program 24] (Channel 3)
    - スケール構成音（中音域 C3-C5、**2オクターブ連続**、メロディ作成用、Velocity 20）
    - Pattern: 上昇C3→C5、下降C5→C3（広い音域でスケールを可視化）
    - ★OtoTheory独自機能
  * **Track 5: Guide Tones (3rd/7th)** [Program 24] (Channel 4)
    - 各コードの3度と7度のみ（ジャズ/ポップアレンジ用）
    - 音域: C3-C4 (MIDI 48-60)
    - Velocity: 30
  * **音楽理論エンジン**:
    - 27種類のスケール対応（Diatonic Modes, Pentatonic, Blues, Harmonic/Melodic Minor）
    - Key Signature自動判定（Scale type優先、相対長調計算）
    - Close Voicing: 12パターンの転回形を試行、最小移動距離を選択
* **Sketch無制限（クラウド）**、**IAP（¥490/月）**、**Paywall**実装。

**DoD**

* セクション別コード進行がMIDI Markersに反映。
* 5トラック生成（Guitar/Bass/Scale Guide×2/Guide Tones）。
* Key Signature / Time Signature正しく表示。
* Block Chords（全音符）+ Close Voicing（最小移動距離）。
* Bass Line: Root-5th-Root-5th パターン。
* Scale Guide適切な音域（Bass: C2-C3 [1oct], Middle: C3-C5 [2oct連続]）。
* DAWでの動作確認完了（GarageBand/Logic Pro）。
* 生成MIDIをDAWに読み込むだけで**即編集可能な高品質素材**が再現される。

---

### 2.3 Sketch（保存・呼び出し）

* **Free**：ローカル3件（LRU上書き／自動保存3秒）
* **Pro**：無制限（クラウド同期）
* **保存項目**：Key/Scale、進行（≤12）、Capo（Shaped基準）、Fretboard表示（Degrees/Names/ガイド）。

**DoD**

* Sketch復元で**即ループ再生**＆表示状態まで完全復元。

---

### 2.4 出力（PNG/テキスト/MIDI）

* **PNG（Free）**：**白背景固定**・視認性最適化（タイトル24px/700、Key/Progression/Scale 18–16px、黒字、要素の青強調 #1e40af）。`export_png` は**1操作=1発火**。
* **テキスト（Free）**：Key/Scale、Diatonic、進行（Roman/実音）、Capo注記をコピー。
* **MIDI（iOS Pro）**：**Chord＋Markers＋Guide** を出力（SMF Type‑1）。

---

## 3. Web Lite GA（M3.5）— 実装完了 ✅

**実装日**: 2025/10/04  
**ステータス**: 完了

**A. UI/ナビ** ✅

* ✅ メニューから **Analyze（録音）** を撤去（Flag OFF）。`/analyze` は `/chord-progression` へリダイレクト実装。
* ✅ **6面CTA実装**：
  1. ヘッダーCTA（デスクトップ常設）
  2. モバイル下部スティッキー（スクロール200px後表示）
  3. 9コード到達トースト（info）
  4. 12コード到達トースト（warning）
  5. Sketch 4件目保存ブロック（warning）
  6. PNG出力後トースト（success）
  7. フッターQR CTA

**B. 計測** ✅

* ✅ 追加：`cta_appstore_click{place}`（`header|sticky|limit_toast|png_toast|qr`）
* ✅ 既存：`progression_play / preset_inserted / export_png / toast_shown(kind)` を継続。
* ✅ 実装：`trackCtaClick(place, extra)` 関数、各CTA箇所から発火確認。

**C. DoD（GA）** ✅

* ✅ **プリセット→即ループ→PNG出力**を**3クリック以内**で完了できる。
* ✅ CTAクリックが計測でき、Web→iOSファネルがダッシュボードで見える。
* ✅ `export_png`は成功/失敗に関わらず1回のみ発火（`toastShownRef`で制御）。
* ✅ Free制限（3 sketches, 12 chords）が正しく動作。

**D. 実装詳細**

#### 新規コンポーネント
- `src/components/Toast.client.tsx`: Toast通知システム（3種: info/warning/success）
- `src/components/HeaderCta.client.tsx`: ヘッダーCTA
- `src/components/FooterCta.client.tsx`: フッターCTA
- `src/components/MobileStickyCta.client.tsx`: モバイルスティッキーCTA

#### 主要更新
- `src/app/find-key/page.tsx`: 
  - 制限チェック（localStorage直接読み取り）
  - Toast表示ロジック
  - Export名修正（`currentExportName` state追加）
- `src/app/analyze/page.tsx`: リダイレクト実装
- `src/components/Nav.tsx`: Melody/Solo Analyze削除
- `src/app/layout.tsx`: CTA統合
- `src/lib/telemetry.ts`: `cta_appstore_click` / `trackCtaClick` 追加
- `src/app/globals.css`: Toast/CTA用アニメーション

#### バグ修正
- ✅ Sketch 4件目が保存できてしまう問題（localStorage直接読み取りで解決）
- ✅ PNG Exportでsketch名が反映されない問題（`currentExportName` state追加で解決）

**E. 統計**

| 項目 | 数値 |
|-----|------|
| **新規コンポーネント** | 4個 |
| **新規Telemetryイベント** | 1個（cta_appstore_click） |
| **CTA箇所** | 6箇所 |
| **制限チェック箇所** | 3箇所 |

**F. リリース状態**

✅ **Web Lite GAリリース準備完了**  
次はM4: iOS v1（Proの核）に進む。

---

## 2.5 Site / Marketing Pages（v3.1）

**目的**: App Store審査対応と利用者の信頼担保（法務・サポートの可視化）

**実装済みURL**（JP/EN）:
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約
- `/support` - サポート・お問い合わせ
- `/faq` - よくある質問
- `/about` - OtoTheoryについて
- `/pricing` - 料金プラン

**コアツール**:
- `/chord-progression` - コード進行ビルダー（旧 /find-key 統合）
- `/find-chords` - コード検索ツール
- `/resources` - リソースハブ
  - `/resources/chord-library` - コードライブラリ
  - `/resources/music-theory` - 音楽理論ガイド
  - `/resources/glossary` - 用語集
- `/getting-started` - 使い方ガイド

**非搭載機能**:
- ~~`/analyze`~~ - 録音機能（Flag OFF、UI非露出）

**導線**:
- **フッター常設リンク**（全画面共通）：Privacy | Terms | FAQ | Support | About | Pricing
- **App内設定**：「設定」＞「プライバシー/利用規約」へ1タップ遷移
- **Web Lite本体の6面CTA**：header/sticky/limit_toast/png_toast/qr（既存実装）

**計測**:
- 追加：`cta_appstore_click{place}` 
- 既存：`page_view / export_png(必ず1回) / progression_play / preset_inserted / toast_shown(kind)` 

**実装スタック**:
- **Next.js App Router + TypeScript**
- **ホスティング**: Vercel（CDN/SSR）
- **SEO**: `<meta>`/OG/Twitterカード、`/sitemap.xml`・`/robots.txt`、構造化データ（JSON-LD）

**DoD**:
- アプリ内「設定」から `/privacy` `/terms` へ1タップ遷移
- すべてのページが表示可能
- フッターに常設リンク実装
- 録音UIは非露出（Flag OFF）
- 公開14日内の審査一次指摘0件／Support返信SLA=2営業日以内

---

## 4. iOS v1（M4）— 実装方針

**M4-A（Freeパリティ）**

* 結果カード〜Fretboard二層、プリセット、自動ループ、Sketch3件までを実装。録音UIは**非露出**。

**M4-B（Pro核）** ✅ **完了**（Phase 1-3、2025-10-11）

* ✅ IAP & Paywall（¥490/月）
* ✅ セクション編集（UI実装済み）
* ✅ MIDI出力（4トラック構成: Guitar/Bass/Scale Guide×2）
* 🔜 Sketch無制限（クラウド同期、Phase 4）
* **計測**：`paywall_view / purchase_success / midi_export` を実装。

**M4-C（MIDI大幅強化）** ✅ **完了**（2025-10-11）

* ✅ **Scale Guide Track**（OtoTheory独自機能）
  - 2音域（Middle: C4周辺、Bass: C3周辺）
  - 15種類のスケール対応
  - DAWでゴーストノートとして表示
* ✅ **Program Change**（楽器自動選択）
* ✅ **コードボイシング**（Root+3rd+5th+7th）
* ✅ **リズムパターン**（4拍子ストラム）
* ✅ **ベースライン**（Root-Root-5th-Root(Oct)）
* ✅ **UI再設計**（Sketch Export方式）

**M4-D（UI改善）** ✅ **完了**（2025-10-11）

* ✅ **キー候補拡張**（3→5）
* ✅ **スケール候補拡張**（無制限→5）
* ✅ **スケール音プレビュー**（新機能）
  - ScalePreviewPlayer.swift（AVAudioEngine + Sampler）
  - 15種類のスケール対応
  - 上昇→下降パターン（200ms per note）
  - UI: 各スケール候補に緑色の🔊ボタン

**技術メモ（推奨）**

* 進行・スケール・代理・MIDIライターは共通のTSパッケージ化（`packages/core`）でWeb/iOS共有。
* オーディオは**完全同時発音（0ms）**を実現（Release=80ms、最大6声、4拍リズム）。

---

### 4.1 Hybrid Audio Architecture（M4オーディオ実装方針）

**更新日**: 2025/10/10  
**ステータス**: Phase B 完了、Phase C 準備中

#### 目的

長いリリースで「音が伸びる」問題を根絶しつつ、将来のベース/ドラム追加とMIDI書き出しに対応。

#### 方式

**Hybrid = ギターPCM + ベースPCM**

1. **ギター（和音）** = 1小節 = 2.0秒のPCMに事前バウンス（末尾80msを波形でフェード）
2. **ベース（単音）** = 1小節 = 2.0秒のPCMに事前バウンス（Root音4つ打ち）
3. **ドラム** = 削除（CPU過負荷・心理音響的突っ込み感により）
4. **再生** = `AVAudioPlayerNode`（ギター）+ `AVAudioPlayerNode`（ベース）を同一 `AVAudioTime` で同時駆動

#### 効果

- ✅ **完璧な同期**（サンプル精度、同一 `AVAudioTime` で起動）
- ✅ **ギター・ベースの減衰は波形内で100%制御** → 「伸び」が消える
- ✅ **心理音響的問題の解決**（Root音のみで突っ込み感を回避）
- ✅ **CPU負荷軽減**（ドラム削除により安定動作）

#### SSOT（タイム基準）

| 項目 | 仕様 | 備考 |
|------|------|------|
| **BPM** | UI指定 | 1小節 = 4拍。BPM120なら2.000秒固定 |
| **Strum（ギター）** | 0ms（同時発音） | ユーザーフィードバックにより最適化 |
| **Release（フェードアウト）** | 80ms | 末尾を波形で線形フェード、次の音とかぶらない |
| **最大同時発音（ギター）** | 6声 | |
| **ループ** | 1ループ単位で無限繰り返し | 各小節頭に必ず無音から入る |

#### パート別ルール

##### Guitar（和音）

| 項目 | 仕様 |
|------|------|
| **音源** | SF2（Program25 Acoustic Steel等） |
| **出力** | 1小節PCM（2.0秒）に事前バウンス、末尾80msを波形で線形フェード |
| **ストローク** | 0ms（完全同時発音）、4拍リズム（じゃん×4） |
| **キャッシュ** | `(chordSymbol, program, bpm)` をキーにメモリ/LRUでキャッシュ（最大16バリエーション） |
| **サイズ** | 約0.7MB/Bar（44.1kHz/2ch/2.0s） |

##### Bass（単声）

| 項目 | 仕様 |
|------|------|
| **音源** | SF2（Program 34 Electric Bass finger） |
| **出力** | 1小節PCM（2.0秒）に事前バウンス |
| **パターン** | Root音4つ打ち（各拍でRoot音、Note Duration 90%） |
| **キャッシュ** | `(chordSymbol, program, bpm)` をキーにLRUでキャッシュ（最大16） |
| **同期** | ギターと同一 `AVAudioTime` で起動、サンプル精度で完璧に同期 |

##### Drums（削除）

| 項目 | 理由 |
|------|------|
| **実装試行** | Rock/Pop/Funk パターンを実装 |
| **CPU過負荷** | HALC overload発生、最適化しても「モタる」 |
| **心理音響問題** | 高音（ハイハット・スネア）が物理同期でも「突っ込んで聴こえる」 |
| **最終判断** | ギター+ベースのみでシンプル化 |

#### システム構成（ノードと責務）

```
[Score/SSOT] --(Events)--> [Generators]
    |                         |-- GuitarEvents --> [GuitarBounceService] --> [PCM Cache(2.0s/Bar)]
    |                         |-- BassEvents   --> [BassBounceService]   --> [PCM Cache(2.0s/Bar)]
    |
[HybridPlayer]
    ├─ AVAudioEngine
    │    ├─ AVAudioPlayerNode (Guitar PCM)
    │    ├─ AVAudioPlayerNode (Bass PCM)
    │    └─ mainMixerNode --> 出力
    └─ UI Sync (Timer 0.1s / bar callbacks)
```

**ノード配線**:
```
playerGtr  (AVAudioPlayerNode) → mainMixerNode
playerBass (AVAudioPlayerNode) → mainMixerNode
```

**オーディオ設定**: サンプルレート: 44.1kHz、I/Oバッファ: 10ms（シミュレータ）/ 5ms（実機）

#### 実装計画（段階・チェックリスト）

##### Phase A：基盤（1–2日） ✅ 完了

- [x] `Score` / `Bar` モデルを追加（既存UIのslots→Scoreに集約）
- [x] `GuitarBounceService` を新規作成（オフラインrender→PCM化→末尾80msフェード）
- [x] `HybridPlayer` の土台（Engine+PlayerNode+2サンプラー、prepare/start/stop）
- [x] `SequencerBuilder` の雛形（TempoTrackのみ）

##### Phase B：最小再生（1–2日） ✅ 完了

- [x] C/G/Am/F のギターPCMを生成してPlayerNodeで連結再生
- [x] 同じScoreからベース基本形（Root/5th）をイベント化→Sequencerで発音（Phase Cで有効化予定）
- [x] カウントインはハイハット風4拍を先頭にschedule
- [x] ループ：最後のcompletionで再スケジュール
- [x] 停止：Player/Sequencer.stop()
- [x] **UI同期**：Timer方式（0.1秒ごと）で画面と音が完全一致、遅延累積なし
- [x] **音響最適化**：ストローク0ms、フェードアウト80ms、4拍リズム実装

##### Phase C：拡張（完了・先送り）

**✅ 完了項目**：
- [x] **ベース PCM レンダリング（Phase C-2.5）**：
  - [x] `BassBounceService` 作成（SF2 Program 34、Root音4つ打ち）
  - [x] `HybridPlayer` に `playerBass` 追加、完璧な同期実現
  - [x] `ProgressionView` に `bassService` 統合
  - [x] 心理音響的問題の解決（5度音の突っ込み感 → Root音のみで回避）
- [x] **ドラム実装（Phase C-3）** → **削除**：
  - [x] `DrumBounceService` 作成（Rock/Pop/Funk）
  - [x] CPU過負荷問題（HALC overload）により最適化試行
  - [x] 心理音響的突っ込み感（高音の鋭いアタック）により削除判断
  - [x] 最終構成：ギター+ベースのみ

**⏭️ 先送り事項（M4.1以降）**：
- [ ] **音色品質改善**：
  - [ ] Distortion（Program 30）：ワウペダル効果を軽減または除外
  - [ ] Over Drive（Program 29）：ワウペダル効果を軽減または除外
  - [ ] Acoustic Nylon（Program 24）：2拍目・3拍目のドラム音混入を修正
  - 理由：現在の音色（Acoustic Steel, Electric Clean, Electric Muted, Piano）で十分な品質
- [ ] **ベース Humanize（Phase C-5）**：±5ms タイミング、±6 Velocity
  - 理由：現在の同期精度で十分、Humanizeは必須ではない
- [ ] **ドラム再実装**：
  - 理由：CPU過負荷・心理音響問題により先送り、M4.1以降で再検討

**🔜 次フェーズで実装**：
- [ ] MIDI書き出し：`MusicSequenceFileCreateData` を使いSMFを生成
- [ ] キャッシュ最適化：LRU最大16バリエーション（現在16で実装済み）
- [ ] BPM変更時：ギター+ベースPCM再バウンス

#### 受け入れ基準（DoD）

| 項目 | 基準 | ステータス |
|------|------|-----------|
| **拍精度** | BPM120で各小節=2.000s（PlayerNodeの連結で保証） | ✅ 達成 |
| **減衰** | ギターは末尾80msで0（波形検査で確認）。ベース/ドラムはNoteOff＋CC120で尾なし | ✅ 達成 |
| **音量感** | overallGain −6dB、Reverb/Chorus/Sustain=0（ch0–1）を初期化 | ✅ 達成 |
| **最大発音** | ギター≤6声、ストローク0ms（完全同時発音） | ✅ 達成 |
| **ループ** | バウンス済みPCMの連結でクリックなし | ✅ 達成 |
| **UI同期** | 画面と音が完全一致、遅延累積なし | ✅ 達成 |
| **MIDI書き出し** | DAWに取り込んでテンポ／拍子／トラック名が有効 | 🔜 Phase C |

#### リスクと回避

**SequencerとPlayerNodeの開始ずれ**:  
→ PlayerNodeの最初のバッファを0.2s先のhostTimeに`play(at:)`予約し、その直前に`sequencer.start()`（またはクリック4発のプリロールで両者を整列）。

**メモリ**:  
→ PCMは1本≒0.7MB。LRUで同時キャッシュを12–16本に制限、重複コードは同じバッファを再利用。

**音色差**:  
→ 鳴らし分けはバウンス時にprogram指定（GuitarはPCM、Bass/Drumはt=0のProgram）で吸収。

#### 現行コードからの差分ポイント

**削除/停止**:
- `ChordSequencer` の 2バス・フェード／flush/hardKill/crossFade 系は**撤去**
- 代わりに `GuitarBounceService` + `HybridPlayer` を配置

**流用**:
- `chordToMidi` のルールはそのまま（ギターPCM生成時とSMF出力時に共用）
- CC初期化（Reverb/Chorus/Sustain=0、Volume=100）を準備時に実行

**追加**:
- `SequencerBuilder` で `MusicTrack` の `dest` を `Sampler` へ明示バインド（Bank/Program= t=0）
- `GuitarBounceService` の manual rendering と 末尾フェード（80ms）
- `HybridPlayer` で ギターPCM schedule＋Sequencer.start() の同時スタート

#### 実装インターフェース（Swift雛形）

##### Score（SSOTモデル）
```swift
struct Score {
    var bpm: Double
    var bars: [Bar]
}

struct Bar {              // 1小節分
    var chord: String     // "C", "Am7", "G/B" など
}
```

##### GuitarBounceService（1小節PCMを作る）
```swift
final class GuitarBounceService {
    struct Key: Hashable { let chord: String; let program: UInt8; let bpm: Double }
    private var cache: [Key: AVAudioPCMBuffer] = [:]

    func buffer(for key: Key, sf2: URL, strumMs: Double = 0, releaseMs: Double = 80) throws -> AVAudioPCMBuffer {
        // 1) オフラインエンジン(enableManualRenderingMode .offline, 44.1k/2ch)
        // 2) 4拍リズム：各拍頭で strum(<=6声)を noteOn、拍の70%でnoteOff
        // 3) 2.0秒ぶん renderOffline してバッファへ
        // 4) 末尾 releaseMs を線形フェード（波形を 0 に）
        // 5) cache[key] = buffer; return
        // ✅ 実装済み：LRUキャッシュ最大16バリエーション
    }
}
```

##### HybridPlayer（再生）
```swift
final class HybridPlayer {
    let engine = AVAudioEngine()
    let playerGtr = AVAudioPlayerNode()
    let samplerBass = AVAudioUnitSampler()
    let samplerDrum = AVAudioUnitSampler()
    var sequencer: AVAudioSequencer!

    func prepare(sf2: URL, drumKit: URL?) throws {
        // Engine/PlayerNode/Sampler×2 を attach & connect
        // Bass/Drum SF2 をロード
    }

    func play(score: Score, guitarBuffers: [AVAudioPCMBuffer], onBarChange: @escaping(Int)->Void) throws {
        // 1) Sequencer 準備（Bass/Drum - Phase Cで有効化）
        // 2) カウントイン（2秒、ハイハット風4拍）を先頭に schedule
        // 3) PlayerNode にギターPCMを順番に schedule（連結で隙間なし）
        // 4) 同時スタート（hostTime指定で開始）
        // 5) Timer で UI 同期（0.1秒ごとに現在時刻をチェック、バーが変わったら onBarChange 呼び出し）
        // 6) ループ：最後のバッファ completion で 2サイクル分を再 schedule
        // ✅ 実装済み：完全同期、遅延累積なし
    }
}
```

#### まとめ（決定事項）

| 項目 | 決定内容 | 実装状況 |
|------|----------|-----------|
| **方式** | Hybrid = ギターPCM + ベース/ドラムMIDI | ✅ Phase B 完了 |
| **SSOT** | Strum 0ms、Release 80ms（波形フェード）、最大6声、1小節=2.000s | ✅ 達成 |
| **構成** | PlayerNode（Gtr）, Sampler×2（Bass/Drum）, Sequencer（BPM/Tracks） | ✅ 実装済み |
| **UI同期** | Timer方式（0.1秒ごと）で画面と音が完全一致 | ✅ 達成 |
| **ロードマップ** | Phase A→B（完了）→C（音色改善・ベース有効化・MIDI出力） | 🔜 Phase C |

**このハイブリッド方式により、「音が伸びる」問題が完全に解決され、将来のベース/ドラム/MIDI書き出し機能がスムーズに実装できます。**

---

## 5. データ契約（概念TS）

```ts
// Sketch（永続化）
interface SketchV1 {
  id: string;
  name: string;
  createdAt: string; updatedAt: string;
  schema: 'sketch_v1'; appVersion: string;
  key: { tonic: string; scaleId: string }; // 例: C, ionian
  capo: { capoFret: number; notation: 'Shaped' }; // Shaped基準で保存
  progression: { bars: BarV1[]; maxBars: 12 }; // Lite
  fretboardView: { mode: 'Degrees'|'Names'; showGuides: boolean };
}

interface BarV1 {
  chord: string; // 例: Cmaj7
  beats: 4;      // Liteは常に4
}
```

---

## 6. Telemetry（イベント仕様）

**共通**

* `page_view, key_pick, scale_pick, diatonic_pick, overlay_shown(初回のみ), fb_toggle, overlay_reset, play_note, play_chord, export_png(常に1回), instrument_change`。

**進行**

* `progression_play{bpm, chordCount}`／`preset_inserted{name}`／`toast_shown{kind=limit_warn|limit_block|low_conf}`（**undoは廃止**）。
* **Web→iOS**：`cta_appstore_click{place}` を新設。
* **iOS Pro**：`paywall_view`／`purchase_success`／`midi_export{tracks,sections,bpm}`。

**保存**

* `save_project, open_project, project_rename, project_delete, project_duplicate, project_limit_warn, project_limit_block`。

**録音（将来）**

* `audio_record_start/stop, audio_analyze_ok, audio_analyze_conf(engine, conf)`（Flag OFF 継続）。

---

## 7. 受け入れ基準（DoD）

1. **Find Chords**：Key/Scale選択のみでResult更新。Open行タップで和音再生＆Chord層強調。ResetでScale保持。
2. **Capo**：折りたたみ内にTop2（Shaped）＋注記。音は鳴らさない。
3. **Progression**：**ドラッグ並べ替え**／**プリセット→自動ループ**が動作（**Undoなし**）。
4. **提案追加**：Patterns/Cadence/基礎代理は**試聴→＋Add**を2タップ以内、直後に自動再生。
5. **Sketch**：Key/Scale・Capo（Shaped）・進行・Overlay表示が完全復元。Free=3件、Pro=無制限。
6. **出力**：Free＝PNG（白固定）/テキスト、Pro＝MIDI（Chord+Markers+Guide）。`export_png`は必ず1回。
7. **Web GA**：プリセット→即ループ→PNG出力が3クリック以内／`cta_appstore_click` が計測可能。
8. **iOS Pro**：MIDIをDAWに読み込むだけで構成・Chord・Guideが再現、`paywall_view/purchase_success` が発火。
9. **M4 Week 1 完了（2025-10-04）**：Xcode環境構築・`packages/core`（2.2KB）・`parseChord`/`getDiatonicChords` 動作・Audio Engine 音出し確認。
10. **M4 Week 2 完了（2025-10-04）**：Tab Bar Navigation（3画面）・12-Slot UI・Root+Quick選択・Preview+Add常時表示・削除ボタン・コード再生（12キー×7種類）・Web版UX完全準拠・NavigationTitle削除。
11. **M4 Week 3 完了（2025-10-10）**：Hybrid Audio Architecture（Phase A & B）実装完了。ストローク0ms・フェードアウト80ms・4拍リズム・UI同期（Timer方式）・ループ機能。もたつきゼロ、コードの変わり目クリア。

---

## 8. Feature Flags / 環境変数

* `RECORDING_UI_ENABLED = false`（既定）
* `PNG_THEME_AUTO_INVERT = false`（v3.1）
* `UNDO_ENABLED = false`（v3.1）
* `CTA_APPSTORE_ENABLED = true`（Webの6面CTA）

---

## 9. QA / A11y / NFR

* **TTFI ≤ 2s**（Web）、Overlay再描画≤16ms（p95）。
* **A11y**：roving-tablist／focus-visible／色以外の手掛かり。
* **PNG**：ライト/ダーク双方で可読（白背景固定・黒字）。**export_pngは一度のみ**。

---

## 10. リリース & 運用

* **Web GA（M3.5）**：Analyze非露出、6面CTA、計測導入→ダッシュボードでWeb→iOSファネル監視。
* **iOS v1（M4）**：Freeパリティ→Pro機能（MIDI/セクション/IAP）→App Review。
* **ロールバック**：CTAの場所別ON/OFF／Paywall文言のサーバ駆動（Remote Config推奨）。

---

## 11. 付録：用語

* **Sketch**：進行＋Key/Scale＋Capo（Shaped）＋Fretboard表示の保存単位。
* **Guide Tones**：主に3rd/7th。MIDIでは別トラックに出力。
* **Shaped/Sounding**：押さえ方と実音の区別。Capo注記に併記。

---

