# OtoTheory v3.1 — Implementation SSOT（実装正本 / Web Lite & iOS収益軸）

*最終更新: 2025/10/04*

> 本書は v3.0 Implementation SSOT をベースに、**Web LiteのGA**、**iOS収益主軸（M4）**、**Undo＝非搭載**、**PNG＝白背景固定**、**録音UI＝非露出（Flag OFF）** を反映した v3.1 の実装基準です。
> 仕様の根拠は v3.0 SSOT 正本の中核原則に準拠します。

---

## 0. v3.1 の主要差分（v3.0 → v3.1）

* **WebはM3完了のLiteをGA**：録音メニューを撤去（Flag OFF継続）、**Chord Progression中心**の体験を公開。
* **iOSを収益主軸**：M4で **セクション編集／MIDI出力（Chord Track＋Section Markers＋Guide Tones）／Sketch無制限（クラウド）／IAP（¥490/月）** を実装。
* **Undoは非搭載（キャンセル確定）**：個別削除・並べ替えで代替。DoD/Telemetryから"undo"を削除。
* **PNGは白背景固定**：v3.0の「テーマ自動反転」は停止。`export_png` は成功/失敗に関わらず**1回のみ**発火。
* **録音UIは非露出（Flag OFF）**：将来ON時のみメニュー露出／サーバ解析（/api/analyze）設計は温存。

---

## 1. スコープ & 非スコープ

**In（v3.1）**

* **Web Lite GA（M3.5）**：Analyze撤去、6面CTA、計測追加。
* **iOS v1（M4）**：Free=M3パリティ、Pro=セクション編集＋MIDI（Chord+Markers+Guide）＋無制限保存＋IAP。
* **PNG出力**：白背景固定。**Undoなし**。

**Out / vNext**

* 録音系（Analyze）機能の公開。
* Split Bar（1小節2コード）、Groove/ミニベース、MIDI多トラック拡張（Drum/Bass）はM4.1+。
* テーマ自動反転PNGの再開。

---

## 2. 画面・機能別 実装要件

### 2.1 Find Chords（M3完了／Web・iOS共通）

* **即時反映**：Key/Scale選択→**Diatonic→Fretboard（二層）**更新。Resetは**Chord層のみ**解除、Degrees/Namesトグルは最小構成。
* **Scale Table**（11種・Why文・ⓘGlossary・アルペジオ試聴）／**Chord Forms**（Open/Barre＋試聴）／**基礎代理**（2–3提案＋試聴/＋Add）。
* **Capo提案**：Diatonic折りたたみ内に**Top2（Shaped表記）**。**音は鳴らさない**。*Shaped/Sounding*注記を併記。
* **非ヘプタ**：Roman非表示（Pent/Bluesのみ例外表示）。

**DoD**

* Key/Scale→結果更新が**1操作**で完了／和音試聴は**同時or軽ストラム（≈10–20ms）**で鳴る。

---

### 2.2 Chord Progression（Lite / Pro）

**共通（Lite）**

* **12コード上限**、プリセット20、4拍カウントイン→4/4自動ループ、BPM 40–240、音色7種。**Undoなし**（削除＋D&Dで代替）。
* **結果カード→Diatonic→Fretboard（二層）→Patterns/Cadence/基礎代理**で、**「試聴→＋Add→即ループ」**の2タップ原則を厳守。

**Pro（iOS）**

* **セクション編集**（Verse/Chorus/Bridge…）：追加・削除・並べ替え・名称変更／セクション単位ループ。
* **MIDI出力**（**SMF Type‑1**）：

  * **Chord Track**（Triad/7th：note-onはコード長を全拍で、ベロシティ推奨80±10）
  * **Guide Tones Track**（3rd/7th中心、ハーフノート継続を基本）
  * **Markers**（Meta：Section名・小節頭）
  * **Meta**：TimeSig=4/4、Tempo（BPM）、Key Signature（現在のKey）
* **Sketch無制限（クラウド）**、**IAP（¥490/月）**、**Paywall**実装。

**DoD**

* セクション編集の結果がMIDI Markersに同期。
* 生成MIDIをDAWに読み込むだけで**構成（Markers）・コード骨格・ガイドトーン**が再現される。

---

### 2.3 Sketch（保存・呼び出し）

* **Free**：ローカル3件（LRU上書き／自動保存3秒）
* **Pro**：無制限（クラウド同期）
* **保存項目**：Key/Scale、進行（≤12）、Capo（Shaped基準）、Fretboard表示（Degrees/Names/ガイド）。

**DoD**

* Sketch復元で**即ループ再生**＆表示状態まで完全復元。

---

### 2.4 出力（PNG/テキスト/MIDI）

* **PNG（Free）**：**白背景固定**・視認性最適化（タイトル24px/700、Key/Progression/Scale 18–16px、黒字、要素の青強調 #1e40af）。`export_png` は**1操作=1発火**。
* **テキスト（Free）**：Key/Scale、Diatonic、進行（Roman/実音）、Capo注記をコピー。
* **MIDI（iOS Pro）**：**Chord＋Markers＋Guide** を出力（SMF Type‑1）。

---

## 3. Web Lite GA（M3.5）— 実装完了 ✅

**実装日**: 2025/10/04  
**ステータス**: 完了

**A. UI/ナビ** ✅

* ✅ メニューから **Analyze（録音）** を撤去（Flag OFF）。`/analyze` は `/find-key` へリダイレクト実装。
* ✅ **6面CTA実装**：
  1. ヘッダーCTA（デスクトップ常設）
  2. モバイル下部スティッキー（スクロール200px後表示）
  3. 9コード到達トースト（info）
  4. 12コード到達トースト（warning）
  5. Sketch 4件目保存ブロック（warning）
  6. PNG出力後トースト（success）
  7. フッターQR CTA

**B. 計測** ✅

* ✅ 追加：`cta_appstore_click{place}`（`header|sticky|limit_toast|png_toast|qr`）
* ✅ 既存：`progression_play / preset_inserted / export_png / toast_shown(kind)` を継続。
* ✅ 実装：`trackCtaClick(place, extra)` 関数、各CTA箇所から発火確認。

**C. DoD（GA）** ✅

* ✅ **プリセット→即ループ→PNG出力**を**3クリック以内**で完了できる。
* ✅ CTAクリックが計測でき、Web→iOSファネルがダッシュボードで見える。
* ✅ `export_png`は成功/失敗に関わらず1回のみ発火（`toastShownRef`で制御）。
* ✅ Free制限（3 sketches, 12 chords）が正しく動作。

**D. 実装詳細**

#### 新規コンポーネント
- `src/components/Toast.client.tsx`: Toast通知システム（3種: info/warning/success）
- `src/components/HeaderCta.client.tsx`: ヘッダーCTA
- `src/components/FooterCta.client.tsx`: フッターCTA
- `src/components/MobileStickyCta.client.tsx`: モバイルスティッキーCTA

#### 主要更新
- `src/app/find-key/page.tsx`: 
  - 制限チェック（localStorage直接読み取り）
  - Toast表示ロジック
  - Export名修正（`currentExportName` state追加）
- `src/app/analyze/page.tsx`: リダイレクト実装
- `src/components/Nav.tsx`: Melody/Solo Analyze削除
- `src/app/layout.tsx`: CTA統合
- `src/lib/telemetry.ts`: `cta_appstore_click` / `trackCtaClick` 追加
- `src/app/globals.css`: Toast/CTA用アニメーション

#### バグ修正
- ✅ Sketch 4件目が保存できてしまう問題（localStorage直接読み取りで解決）
- ✅ PNG Exportでsketch名が反映されない問題（`currentExportName` state追加で解決）

**E. 統計**

| 項目 | 数値 |
|-----|------|
| **新規コンポーネント** | 4個 |
| **新規Telemetryイベント** | 1個（cta_appstore_click） |
| **CTA箇所** | 6箇所 |
| **制限チェック箇所** | 3箇所 |

**F. リリース状態**

✅ **Web Lite GAリリース準備完了**  
次はM4: iOS v1（Proの核）に進む。

---

## 2.5 Site / Marketing Pages（v3.1）

**目的**: App Store審査対応と利用者の信頼担保（法務・サポートの可視化）

**ルート**（MDX、JP/EN）:
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約（EULA相当条項を含む）
- `/subscription` - サブスク・自動更新・キャンセル・返金
- `/support` - サポート／FAQ／連絡先
- `/account-deletion` - アカウント／データ削除手順
- `/security` - セキュリティ＆データ保護（保存地域=東京、保持期間）
- `/accessibility` - アクセシビリティ声明
- `/transparency` - 透明性レポート（収集イベント一覧、保持期間=90日）
- `/licenses` - OSSライセンス（自動生成）

**導線**:
- **フッター常設リンク**（全画面共通）：Privacy | Terms | Subscription | Support | Account Deletion | Security | Accessibility | Licenses
- **App内設定**：「設定」＞「プライバシー/利用規約/アカウント削除」へ1タップ遷移
- **Web Lite本体の6面CTA**：header/sticky/limit_toast/png_toast/qr（既存実装）

**計測**:
- 追加：`cta_appstore_click{place}` 
- 既存：`page_view / export_png(必ず1回) / progression_play / preset_inserted / toast_shown(kind)` 

**実装スタック**:
- **Next.js App Router + TypeScript + MDX**
- **i18n**: `/ja` と `/en` のサブパス or ヘッダー切替
- **ホスティング**: Vercel（CDN/SSR）
- **SEO**: `<meta>`/OG/Twitterカード、`/sitemap.xml`・`/robots.txt`、構造化データ

**DoD**:
- アプリ内「設定」から `/privacy` `/terms` `/account-deletion` へ1タップ遷移
- すべての政策系URLがJP/ENで表示可能
- フッターに常設リンク実装
- 録音UIは非露出（Flag OFF）
- 公開14日内の審査一次指摘0件／Support返信SLA=2営業日以内

---

## 4. iOS v1（M4）— 実装方針

**M4-A（Freeパリティ）**

* 結果カード〜Fretboard二層、プリセット、自動ループ、Sketch3件までを実装。録音UIは**非露出**。

**M4-B（Pro核）**

* セクション編集／MIDI出力（Chord+Markers+Guide）／Sketch無制限（クラウド）／IAP。
* **計測**：`paywall_view / purchase_success / midi_export{tracks,sections,bpm}` を実装。

**技術メモ（推奨）**

* 進行・スケール・代理・MIDIライターは共通のTSパッケージ化（`packages/core`）でWeb/iOS共有。
* オーディオはまず**同時/軽ストラム**の品質を担保（Attack≈3–5ms/Release≈80–150ms、最大6声）。

---

## 5. データ契約（概念TS）

```ts
// Sketch（永続化）
interface SketchV1 {
  id: string;
  name: string;
  createdAt: string; updatedAt: string;
  schema: 'sketch_v1'; appVersion: string;
  key: { tonic: string; scaleId: string }; // 例: C, ionian
  capo: { capoFret: number; notation: 'Shaped' }; // Shaped基準で保存
  progression: { bars: BarV1[]; maxBars: 12 }; // Lite
  fretboardView: { mode: 'Degrees'|'Names'; showGuides: boolean };
}

interface BarV1 {
  chord: string; // 例: Cmaj7
  beats: 4;      // Liteは常に4
}
```

---

## 6. Telemetry（イベント仕様）

**共通**

* `page_view, key_pick, scale_pick, diatonic_pick, overlay_shown(初回のみ), fb_toggle, overlay_reset, play_note, play_chord, export_png(常に1回), instrument_change`。

**進行**

* `progression_play{bpm, chordCount}`／`preset_inserted{name}`／`toast_shown{kind=limit_warn|limit_block|low_conf}`（**undoは廃止**）。
* **Web→iOS**：`cta_appstore_click{place}` を新設。
* **iOS Pro**：`paywall_view`／`purchase_success`／`midi_export{tracks,sections,bpm}`。

**保存**

* `save_project, open_project, project_rename, project_delete, project_duplicate, project_limit_warn, project_limit_block`。

**録音（将来）**

* `audio_record_start/stop, audio_analyze_ok, audio_analyze_conf(engine, conf)`（Flag OFF 継続）。

---

## 7. 受け入れ基準（DoD）

1. **Find Chords**：Key/Scale選択のみでResult更新。Open行タップで和音再生＆Chord層強調。ResetでScale保持。
2. **Capo**：折りたたみ内にTop2（Shaped）＋注記。音は鳴らさない。
3. **Progression**：**ドラッグ並べ替え**／**プリセット→自動ループ**が動作（**Undoなし**）。
4. **提案追加**：Patterns/Cadence/基礎代理は**試聴→＋Add**を2タップ以内、直後に自動再生。
5. **Sketch**：Key/Scale・Capo（Shaped）・進行・Overlay表示が完全復元。Free=3件、Pro=無制限。
6. **出力**：Free＝PNG（白固定）/テキスト、Pro＝MIDI（Chord+Markers+Guide）。`export_png`は必ず1回。
7. **Web GA**：プリセット→即ループ→PNG出力が3クリック以内／`cta_appstore_click` が計測可能。
8. **iOS Pro**：MIDIをDAWに読み込むだけで構成・Chord・Guideが再現、`paywall_view/purchase_success` が発火。

---

## 8. Feature Flags / 環境変数

* `RECORDING_UI_ENABLED = false`（既定）
* `PNG_THEME_AUTO_INVERT = false`（v3.1）
* `UNDO_ENABLED = false`（v3.1）
* `CTA_APPSTORE_ENABLED = true`（Webの6面CTA）

---

## 9. QA / A11y / NFR

* **TTFI ≤ 2s**（Web）、Overlay再描画≤16ms（p95）。
* **A11y**：roving-tablist／focus-visible／色以外の手掛かり。
* **PNG**：ライト/ダーク双方で可読（白背景固定・黒字）。**export_pngは一度のみ**。

---

## 10. リリース & 運用

* **Web GA（M3.5）**：Analyze非露出、6面CTA、計測導入→ダッシュボードでWeb→iOSファネル監視。
* **iOS v1（M4）**：Freeパリティ→Pro機能（MIDI/セクション/IAP）→App Review。
* **ロールバック**：CTAの場所別ON/OFF／Paywall文言のサーバ駆動（Remote Config推奨）。

---

## 11. 付録：用語

* **Sketch**：進行＋Key/Scale＋Capo（Shaped）＋Fretboard表示の保存単位。
* **Guide Tones**：主に3rd/7th。MIDIでは別トラックに出力。
* **Shaped/Sounding**：押さえ方と実音の区別。Capo注記に併記。

---

