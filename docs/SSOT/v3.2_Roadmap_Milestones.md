# OtoTheory v3.2 — マイルストーン & 範囲（期日なし方式・Web→iOSシフト）

*最終更新: 2025/01/19*

> 本書は v3.1 をベースに、v3.2ビジネスプラン（サウンドパレット、Android計画、日英同時リリース）を反映した差分統合版です。
> 今後は本v3.2を正として作業を進めます。v3.1は参考資料として扱います。
> v3.2ビジネスプラン（/docs/SSOT/v3.2_Business_Plan.md）を最優先とし、本書と矛盾する場合はビジネスプランを優先します。

> **参照**：
> ・現行マイルストーン（M0〜M3 完了／M4定義）
> ・実装要件 v3.0（ProのMIDI：Chord＋セクションマーカー＋ガイドトーン／録音UIはFlag OFF） 
> ・SSOT v3.0 正本（結果カード→Diatonic→Fretboard二層→提案／Capo Top2（Shaped）／出力境界） 

---

## ✅ 変更サマリー（v3.1 → v3.2 の差分）

* **Undo**：**キャンセル確定**（個別削除＆D&Dで代替）。DoD／ドキュメント注記を更新。
* **PNG出力**：**白背景固定**を明記（テーマ自動反転は将来）。Telemetry `export_png` は**必ず1回のみ**送出の原則を継続。
* **Web Lite**：M3完了範囲で**即リリース可**。**Melody/Solo Analyze（録音）**は**メニューから撤去**（Flag OFF方針と一致）。
* **M4以降**：**iOSアプリ開発を主軸**に移行（**セクション編集／MIDI出力（Chord＋Markers＋Guide）／Sketch無制限**＝Proの核）。
* **サウンドパレット（v3.2新機能）**：**"音の雰囲気"でコードを選ぶ**体験をPro機能として提供。3つのカテゴリ（キラキラ・浮遊感、おしゃれ・都会的、緊張感・スパイス）で分類。
* **Android版計画**：**Pro機能なし**、初心者特化の**広告モデル（AdSense/AdMob中心）**でマネタイズし、iOS Proへ誘導。
* **日英同時リリース**：**10月中TestFlight開始→11/15正式リリース**。EN/JAマスター準拠の翻訳体制。

---

## M0. Baseline（統合の土台） ✅ 完了

* Chord Progression を主導線、**結果カード→Diatonic→Fretboard二層**、Capo Top2（Shaped）。

## M1. Sketch Library（保存・呼び出し） ✅ 完了

* **Free=3件ローカル**（LRU）／**Auto‑save 3秒**／**PNG出力**（白背景固定・視認性最適化・`export_png` 1回計測）。

## M2. Progression Lite ✅ 完了

* **12コード上限**／**プリセット20**／**自動ループ**（Play/Stop, BPM, 4/4）／**Undo=キャンセル**に確定。

## M3. Find Chords 強化 ✅ 完了

* **Scale Table（Why一文＋Glossary＋アルペジオ）**／**Chord Forms（試聴）**／**Capo Top2（Shaped）**／**基礎代理コード**。

---

## **M3.5 Web Lite GA（サイト同時公開）** ✅ 完了

**実装日**: 2025-10-04  
**目的**：M3までの機能で**"触って曲の芯が分かる"**体験を提供し、**iOS Proへ送客**。App Store審査対応のため法務・サポートページを同時公開。

**In**

* **Analyze（録音）メニュー撤去**・該当ルートはChord Progressionへ**リダイレクト**（Flag OFF方針と一致）。
* **6面CTA**（ヘッダー常設／モバイル下部スティッキー／9–12到達トースト／Sketch 4件目モーダル／PNG後トースト／フッターQR）
* **計測**：既存 `export_png / progression_play / preset_inserted / toast_shown` に加え `cta_appstore_click{place}` を追加（Web→iOSファネルを可視化）。
* **Policy 9ページ（JP/EN）公開**：`/privacy` `/terms` `/subscription` `/support` `/account-deletion` `/security` `/accessibility` `/transparency` `/licenses`
* **App内設定リンク**：「設定」＞「プライバシー/利用規約/アカウント削除」へ1タップで遷移（審査対応）
* **ドキュメント整合**：Undo=キャンセル／PNG=白固定を**SSOT v3.2 注記**として反映。

**DoD**

* Web上で**プリセット→即ループ→PNG出力**まで一連を3クリック以内で完了。
* `export_png` は**成功/失敗に関わらず1発火**、`toast_shown(kind=limit_warn|limit_block)`でPro誘導が確認できる。
* **政策系URLは外部公開済み**（フッター常設）、JP/EN併記。
* `cta_appstore_click{place}` が全6面で発火。
* **録音UIは非露出**（Flag OFF）を確認済み。

---

## **M4. iOS v1（Proの核）** ★主軸移行

### M4: Chord Library 拡張 — 進捗更新（2025-10-16）

**達成（iOS）**
- 静的フォームv0を大量投入（Open/Root‑6/Root‑5/Root‑4/Triad基本形）
- UIでフォーム順を固定（Open → Root‑6 → Root‑5 → Root‑4 → Triad‑1 → Triad‑2）
- `shapeName`未指定のタイトル推定を実装
- Triad（3和音、基本形）実装完了
- m7コードのRoot-4フォーム修正完了（配列順序統一）

**達成（Web）** ✅ 2025-10-16
- 静的データ統合（Major/minor/7th/M7/m7、計15コード50フォーム）
- ChordDiagram配列順序統一（1弦→6弦、iOS版と一致）
- バレー表示の1-indexed対応
- ビルド成功 & mainブランチデプロイ完了

**残**
- Triad転回形（第1・第2転回形）
- sus2/sus4, add9, 6/9 の追加
- Web版残りルート追加（F, Bb, F#, Eb, Ab, B）
- Web版1コード=1ページ化（SEO + AdSlot）

**狙い**：**「DAW前処理を数分で」**を**成果物（MIDI）**で実現し、IAPに直結。

### M4‑Week 1：iOS基盤構築 ✅ 完了（2025-10-04）

* **環境構築**：Xcode プロジェクト作成・Code Signing 設定完了。
* **共通ロジック**：`packages/core` パッケージ化（TypeScript → ES2020 → JS Bundle 2.2KB）。
* **JavaScriptCore Bridge**：Swift ↔ JS 通信確立（`parseChord` ✅, `getDiatonicChords` ✅）。
* **Audio Engine**：`AVAudioEngine` + `AVAudioUnitSampler` 実装、実機音出し成功 ✅。
  **DoD**：`parseChord` 成功 / `getDiatonicChords` 成功 / 単音・和音再生確認 / ビルド成功。

### M4‑Week 2：Tab Bar + UI + Audio 完全実装 ✅ 完了（2025-10-04）

#### Day 1：`getDiatonicChords` 実装 ✅
* **実装完了**：`packages/core/src/theory/diatonic.ts` 新規作成
* **テスト成功**：C ionian → `["C", "Dm", "Em", "F", "G", "Am", "Bdim"]` ✅
* **技術課題解決**：CommonJS → ES2020、esbuild IIFE（2.2KB）、Xcode参照修正

#### Day 2-3：Tab Bar Navigation 実装 ✅
* **3画面構築**：MainTabView、ProgressionView、FindChordsView、ReferenceView
* **Tab切り替え**：Chord Progression / Find Chords / Reference
* **NavigationTitle削除**：画面領域最大化

#### Day 4：12-Slot UI 実装 ✅
* **Progression Builder**：12スロット（4列×3行）、番号バッジ、カーソル管理
* **Reset機能**：全スロットクリア

#### Day 5：オーディオ統合 & Web版UX完全準拠 ✅
* **コード再生**：12キー×7種類Quick（Major, m, 7, maj7, m7, dim, sus4）
* **Root + Quick選択**：Web版と完全同一UX
* **Preview + Add**：常時表示（初期状態から）
* **削除ボタン**：スロット右上バツマーク（`xmark.circle.fill`）
* **技術課題解決**：インデント修正、スコープエラー解決、非推奨API修正

**DoD達成**：
- ✅ Tab Bar で3画面切り替え
- ✅ 12スロット表示・操作
- ✅ コード選択・追加・削除・再生
- ✅ Web版UX完全準拠
- ✅ NavigationTitle削除（領域最大化）

### M4‑Week 3：Hybrid Audio Architecture 実装 ✅ 完了（2025-10-10）

#### Phase A：基盤構築 ✅
* **Score/Bar モデル**：既存 UI slots から Score へ集約
* **GuitarBounceService**：オフラインレンダリング実装、末尾80msフェード、LRUキャッシュ（最大16バリエーション）
* **HybridPlayer 土台**：Engine + PlayerNode + 2サンプラー実装
* **SequencerBuilder 雛形**：TempoTrack のみ実装

#### Phase B：最小再生 & 音響最適化 ✅
* **ギターPCM再生**：C/G/Am/F の4拍リズム（じゃん×4）実装
* **カウントイン**：ハイハット風4拍を先頭にschedule
* **ループ機能**：最後のcompletion で2サイクル分を再schedule
* **UI同期**：Timer方式（0.1秒ごと）で画面と音が完全一致、遅延累積なし
* **音響最適化**：
  - ストローク0ms（完全同時発音）：ユーザーフィードバックにより「もたつき」を完全解消
  - フェードアウト80ms：コードの変わり目がキレッキレに
  - 4拍リズム：各拍の70%でNote Off、自然な減衰
* **音色管理**：
  - Distortion/Over Drive：ワウペダル効果のため一時的に除外
  - Acoustic Nylon：2拍目・3拍目にドラム音混入のため警告表示

**DoD達成**：
- ✅ 拍精度：BPM120で各小節=2.000s
- ✅ 減衰：末尾80msで0（波形検査で確認）
- ✅ ストローク：0ms（完全同時発音）
- ✅ ループ：クリックなし
- ✅ UI同期：画面と音が完全一致
- ✅ 音響品質：もたつきゼロ、コードの変わり目クリア

### M4‑A：iOS 基盤 & M3パリティ（Free） ⚠️ **未完了**

**現状**: 基盤構築・Audio統合完了、**Fretboard/Diatonic未実装**

* 結果カード → **Diatonic → Fretboard（二層）** → Patterns/Cadence/基礎代理（**試聴→＋Add→即ループ**）。
* **Sketch 3件（ローカル）**、プリセット→自動ループ、Capo Top2（Shaped）／非ヘプタ規則を踏襲。
  **DoD**：Web M3相当の体験が**2タップ以内**で再現。録音UIは**非露出（Flag OFF）**。

**⚠️ 欠落機能（必須）**:
- ❌ Fretboard（二層Overlay）
- ❌ Diatonic Table（Open行＋Capo Top2）
- ❌ Section別コード進行（Pro機能、現在は範囲指定のみ）

**→ M4-E で実装予定**

### M4‑B：iOS Pro（収益の中核） 🔜 次のマイルストーン

#### Phase C：音色改善 & ベース ✅ 完了（ベース）

**✅ 完了項目**：
* **ベース PCM レンダリング（Phase C-2.5）**：
  - `BassBounceService` 作成（Root音4つ打ち、SF2 Program 34）
  - `HybridPlayer` に `playerBass` 追加、完璧な同期実現
  - 心理音響的問題の解決（5度音の突っ込み感 → Root音のみで回避）
* **ドラム実装（Phase C-3）** → 実装後に削除：
  - Rock/Pop/Funk パターンを実装
  - CPU過負荷（HALC overload）により最適化試行
  - 心理音響的突っ込み感（高音の鋭いアタック）により削除判断
  - 最終構成：ギター+ベースのみ

**⏭️ 先送り事項（M4.1以降）**：
* **音色品質改善** → M4.1以降：
  - Distortion（Program 30）：ワウペダル効果を軽減または除外
  - Over Drive（Program 29）：ワウペダル効果を軽減または除外
  - Acoustic Nylon（Program 24）：2拍目・3拍目にドラム音混入を修正
  - 理由：現在の音色（Acoustic Steel, Electric Clean, Electric Muted, Piano）で十分な品質
* **ベース Humanize（Phase C-5）** → M4.1以降：
  - ±5ms タイミング、±6 Velocity
  - 理由：現在の同期精度で十分、Humanizeは必須ではない
* **ドラム再実装** → M4.1以降：
  - 理由：CPU過負荷・心理音響問題により先送り、将来的に再検討

#### Pro機能実装

**✅ Phase 1: IAP & Paywall（完了）**
* **IAP（¥490/月）**：StoreKit 2統合、購入・リストア実装
* **Paywall UI**：Pro機能紹介、購読ボタン、エラーハンドリング
* **Free/Pro分岐**：プリセット20種（Free）+ 30種（Pro、Phase 5で追加）
* **計測**：`paywall_view` / `purchase_success` / `purchase_fail` / `restore_success`
* **ProManager**：Singleton、購入状態管理、トランザクションリスナー
* **Configuration.storekit**：テスト環境設定

**⚠️ Phase 2: セクション編集（UI のみ完了、機能未実装）**
* **Section モデル**：9種類のセクションタイプ（Verse, Chorus, Bridge等）、範囲指定、リピート回数
* **SectionEditorView**：追加・編集・削除・並べ替えUI
* **セクションマーカー**：ProgressionViewに表示（横スクロール）
* **Pro分岐**：Sectionsボタン（Freeユーザーはpaywall）
* **Sketch統合**：セクション情報を永続化
* ❌ **セクション別コード進行機能**: 現在は範囲指定のみ、各セクション独立した進行は未実装
* 🔜 **再生機能**：Phase 2.5で実装予定（セクション指定再生・ループ）

**🔜 Phase E: Fretboard & Diatonic Table（必須・最優先）**

*最終更新: 2025-10-13（Phase E-1 ~ E-7 完了）*

**目的**: SSOT必須機能の実装、Web M3パリティ達成

**Phase E-1: Fretboard コンポーネント（2日）** ✅ 完了
**実装日**: 2025-10-12
* **FretboardView.swift**: SwiftUI Canvas描画
* **二層Overlay システム**:
  - Scale層：ゴースト表示（小さい、薄い、輪郭）
  - Chord層：メイン表示（大きい、塗りつぶし、ラベル）
* **表示モード**: Degrees（度数）/ Names（音名）切り替え
* **Reset機能**: Chordのみリセット（Scale層保持）
* **インタラクション**: タップで単音試聴
* **レイアウト**: 6弦×15フレット、Open string、フレット番号ドット、ナット
* **Landscape Full-Screen**: OrientationManager統合、強制横向き、タブバー非表示
* **Web版準拠**: 弦線削除、ギターらしいデザイン

**Phase E-2: Diatonic Table コンポーネント（1日）** ✅ 完了
**実装日**: 2025-10-12
* **DiatonicTableView.swift**: I-VII Roman数字表示
* **Open行**: タップで和音試聴、Fretboard Chord層更新、再タップで解除
* **Capo行**: Top 2表示（Shaped表記）、Easy open chord shapes (C, G, D, A, E)
* **Synchronized Scrolling**: Roman数字、Open、Capo行すべて同期
* **長押し機能**: Chord Progressionに追加（Phase E-4A）

**Phase E-3: FindChordsView 統合（1日）** ✅ 完了
**実装日**: 2025-10-12
* Key/Scale選択 → Diatonic更新 → Fretboard更新
* **14スケール対応**: Major, Minor, 7 Modes, Pentatonic, Blues, Harmonic/Melodic Minor, Diminished
* **Suggested Scales for this chord**: Chord qualityに基づくスケール提案、アルペジオ試聴
* **Substitute Chords**: 和声理論ベースの代理コード提案、長押しでProgression追加
* **Full-Screen強化**: Chord名、Preview Scale表示、2段階Reset
* 状態管理統合

**Phase E-4A: 基本コード追加機能（0.5日）** ✅ 完了
**実装日**: 2025-10-12
* **ToastView.swift**: トースト通知コンポーネント（success/warning/error）
* **ProgressionStore.swift**: Singleton共有ストア、`slots`管理、ハイライト機能
* **長押しジェスチャー**: Diatonic/Substitute chords → Progression追加
* **視覚的フィードバック**:
  - チップ縮小アニメーション（80% + 半透明）
  - スロットハイライト（緑枠、"New!"バッジ、1.05倍拡大）
  - Toast通知（"Added C → Slot 3"）
* **ハプティクフィードバック**: 成功振動/警告振動
* **メモリリーク修正**: ScalePreviewPlayer二重初期化防止

**Phase E-4B: Advanced Chord Builder（3-4時間）** 🔜 次回実装予定
* **Extensions**: 6, m6, 9, M9, m9, 11, M11, 13, M13
* **Altered Dominant**: 7b5, 7#5, 7b9, 7#9, 7#11, 7b13, 7alt
* **Diminished/Variants**: dim7, m7b5
* **Suspensions/Adds**: sus2, add9, add11, add13, 6/9
* **Aug/mM7**: aug, mM7
* **Slash Chords**: C/E, Am/C など（On Bass）
* **Paywall統合**: Pro機能としてロック

**Phase E-5: セクション別コード進行（7-8時間）** ✅ 完了
**実装日**: 2025-10-12～2025-10-13

**Phase E-5A: データモデル & Store** ✅ 完了（2025-10-12）
* **SectionDefinition**: 各セクションが独立したコード進行を持つ
* **PlaybackOrder**: セクションの再生順序と繰り返し回数を管理
* **ProgressionStore拡張**: 
  - `sectionDefinitions: [SectionDefinition]`
  - `playbackOrder: PlaybackOrder`
  - `currentSectionId: UUID?`
  - `useSectionMode: Bool`
  - `combinedProgression: [String?]` - 全セクション結合
  - `activeSlots: [String?]` - 現在セクションのコード

**Phase E-5B: UI実装** ✅ 完了（2025-10-12）
* **SectionManagementView**: セクション定義管理
  - セクション作成・編集・削除・複製
  - デフォルト名: SectionType.displayName（例: "Intro"）
* **SectionEditorSheet**: セクション詳細編集
  - 名前、タイプ、色の変更
* **ProgressionView統合**:
  - セクション選択チップ（横スクロール）
  - 再生モード選択（Full Song / Current Section）
  - セクション情報表示（Total Chords, Total Sections）
  - カーソルリセット（セクション切り替え時）

**Phase E-5C: PlaybackOrderEditor** ✅ 完了（2025-10-13）
* **PlaybackOrderEditor**:
  - ドラッグ&ドロップでセクション順序変更
  - ±ボタンで繰り返し回数調整（1-99回）
  - プレビューヘッダー（総セクション数、総コード数）
  - Orphaned item検出（削除されたセクション）
* **AddToPlaybackOrderSheet**:
  - セクション選択UI
  - 繰り返し回数設定（Stepper）

**Phase E-5D: 再生ロジック** ✅ 完了（2025-10-12）
* **Full Song再生**: `combinedProgression`を使用
* **Current Section再生**: `activeSlots`を使用
* **自動セクション切り替え**: 
  - `autoSwitchSection(for slotIndex: Int)`
  - UI highlight自動更新（セクション跨ぎ対応）
* **Score拡張**: `Bar.slotIndex`で元のスロット位置を追跡

**Phase E-5E: 解析ロジック（セクション重み付け）** ✅ 完了（2025-10-12）
* **セクション重み付けアルゴリズム**:
  - `W_section`: Chorus=1.6, PreChorus=1.2, Verse=1.0, Intro=0.8...
  - `W_posSong`: 曲全体での位置（先頭1.2×、末尾1.3×）
  - `W_posSection`: セクション内位置（両端1.1×）
  - `W_repeat`: √repeatCount
* **TypeScript実装** (`music-theory.ts`):
  - `computeWeights()`: 重み計算
  - `analyzeChordProgression()`: セクション情報を受け取り解析
  - `scoreForKey()`: 重み配列を使用したスコアリング
* **iOS Bridge** (`TheoryBridge.swift`):
  - `SectionInfo`: セクション情報をJSに渡す
  - `analyzeProgression(sections: [SectionInfo])`

**Phase E-5F: MIDI Export統合** ✅ 完了（2025-10-12）
* セクション別データをSection Markers反映
* PlaybackOrderに基づく順序とリピート

**Phase E-6: Fretboard & Diatonic & Roman in Chord Progression（3-4時間）** ✅ 完了
**実装日**: 2025-10-13

**Phase E-6A: Fretboard表示問題の完全解決** ✅ 完了（2025-10-13）
* **問題修正**:
  - ✅ 6弦下の横線問題（Divider削除）
  - ✅ 横スクロール不可問題（verticalSizeClass判定、scrollDisabled(false)）
  - ✅ 窮屈な表示問題（Canvas高さクランプ、Row高さ最適化）
* **技術改善**:
  - `isLandscape` → `verticalSizeClass` ベースの判定
  - Canvas高さを親にクランプ（geometry.size.height固定）
  - 背景矩形を6弦下端までピクセルスナップ（ヘアライン解消）
  - Row高さ計算を親に収まるように修正

**Phase E-6B: 全モード対応のダイアトニックコード実装** ✅ 完了（2025-10-13）
* **対応スケール**:
  - ✅ Ionian (Major), Dorian, Phrygian, Lydian, Mixolydian, Aeolian (Minor), Locrian
  - ✅ HarmonicMinor, MelodicMinor
  - ✅ MajorPentatonic, MinorPentatonic
* **Capo提案**: 全モード対応（Open chordに基づく提案）

**Phase E-6C: Roman Numerals実装** ✅ 完了（2025-10-13）
* **機能**: コード進行をスケールの度数で表示
* **表示例**: `I – vi – IV – V`
* **Quality対応**: Major（大文字）/ Minor（小文字）/ Diminished（°）

**Phase E-6D: Patterns実装** ✅ 完了（2025-10-13）
* **検出パターン**:
  - ✅ Canon Progression (I-V-vi-IV)
  - ✅ Doo-wop (I-vi-IV-V)
  - ✅ Blues I-IV-V (I-IV-V-IV)
  - ✅ Pop Progression (vi-IV-I-V)
  - ✅ ii-V-I (Jazz) (ii-V-I)
  - ✅ 50s Progression (I-vi-ii-V)
* **表示**: パターン名、Roman Pattern、Bars位置

**Phase E-6E: Cadence実装** ✅ 完了（2025-10-13）
* **検出カデンツ**:
  - ✅ Perfect Cadence (V→I) - 完全終止
  - ✅ Plagal Cadence (IV→I) - アーメン終止
  - ✅ Deceptive Cadence (V→vi) - 偽終止
  - ✅ Half Cadence (...→V) - 半終止
* **表示**: カデンツ名、Roman Pattern、Bars位置

**DoD（Phase E）**: ✅ すべて達成（2025-10-13）
- ✅ Fretboard二層Overlay表示（Scale + Chord）
- ✅ Degrees/Names切り替え
- ✅ Landscape Full-Screen（強制横向き）
- ✅ Diatonic Table（Open + Capo Top2）
- ✅ Suggested Scales（アルペジオ試聴）
- ✅ Substitute Chords（和声理論ベース）
- ✅ FindChords統合完了
- ✅ 長押しでProgression追加
- ✅ Toast通知＋ハプティクフィードバック
- ✅ スロットハイライト＋吸い込まれる演出
- ✅ Advanced Chord Builder（Phase E-4B）
- ✅ Slash Chord Editor（Phase E-4C）
- ✅ Section別コード進行（Phase E-5A~F完了）
- ✅ PlaybackOrderEditor（ドラッグ&ドロップ、繰り返し回数調整）
- ✅ Full Song / Current Section 再生モード選択
- ✅ セクション重み付け解析
- ✅ Fretboard & Diatonic in Chord Progression（Phase E-6A~B完了）
- ✅ Roman Numerals（Phase E-6C完了）
- ✅ Patterns自動検出（Phase E-6D完了）
- ✅ Cadence自動検出（Phase E-6E完了）

**完了工数**: 6.5日（2025-10-12～2025-10-13）

**Phase E-7: Sketch保存機能の完全統合（3-4時間）** ✅ 完了
**実装日**: 2025-10-13

**Phase E-7A: Sketchモデルの拡張** ✅ 完了
* **Fretboard表示状態の保存**: Degrees/Names表示モード
* **セクション情報の保存**: SectionDefinitions、PlaybackOrder、useSectionMode
* **後方互換性**: 既存のSketchデータを正常に読み込み

**Phase E-7B: ProgressionViewへの統合** ✅ 完了
* **保存ボタンの追加**: Tools Sectionの最後に配置
* **保存ダイアログ**: 既存のalertモディファイアを使用
* **保存ロジック**: すべての状態を正しく保存
* **復元ロジック**: すべての状態を正しく復元
* **Toast通知**: 保存成功時のフィードバック

**Phase E-7C: 通知ベース読み込み** ✅ 完了
* **.onReceive**: NotificationCenterで`.loadSketch`を監視
* **SketchTabView統合**: 通知経由でHomeタブにSketch読み込み

**Phase E-7D: MIDIエクスポート統合** ✅ 完了
* **シグネチャ変更**: `sections` → `sectionDefinitions` + `playbackOrder`
* **Section Markers**: PlaybackOrderベースのマーカー生成
* **SketchListView**: セクションモード対応のMIDIエクスポート

**DoD（Phase E-7）**: ✅ すべて達成（2025-10-13）
- ✅ Sketch保存ボタン追加
- ✅ Fretboard表示モード保存
- ✅ セクション情報保存（Pro機能）
- ✅ 保存・復元ロジック実装
- ✅ 通知ベース読み込み実装
- ✅ MIDIエクスポート統合
- ✅ LRU方式（最大3件）動作確認

**完了工数**: 7日（2025-10-12～2025-10-13）

**Phase E-8: UX改善 & MIDI修正（2時間）** ✅ 完了
**実装日**: 2025-10-14

**Phase E-8A: MIDI小節数問題の修正** ✅ 完了
* **問題**: GarageBandで小節数が倍になる（19コード → 38小節）、四分音符の長さが倍
* **原因**: `barDuration = 8.0`（本来は4.0）
* **修正**: すべてのMIDI関数で`barDuration = 4.0`、`quarterNote = 1.0`に統一
  - `addChordEvents()`, `addGuideTones()`, `addBassLineEvents()`
  - `addScaleGuide()`, `addChordSymbols()`, `addSectionMarkers()`
* **結果**: 正確な小節数、四分音符の長さがアプリ内再生と一致

**Phase E-8B: Sectionsボタンの混乱解消** ✅ 完了
* **問題**: "Sections"ボタンが2つあり、どちらを押すべきかわかりにくい
* **修正**: 
  - 変換ボタン → "Enable Sections"（青色、grid.2x2アイコン）
  - 管理ボタン → "Section (3)"（グレー、grid.3x2アイコン）
* **結果**: 明確な区別、UX向上

**Phase E-8C: 上部メニューボタンのレイアウト改善** ✅ 完了
* **問題**: 4つのボタンが1行に並び、文字が潰れて読めない
* **修正**: 
  - 2行レイアウトに変更（Row1: Preset, Section, Reset / Row2: Enable Sections, Sketches）
  - ボタンデザインを縦型（VStack: アイコン`.title3` + テキスト`.caption2`）に変更
* **結果**: アイコンが見やすい、文字が読める、余裕のあるレイアウト

**DoD（Phase E-8）**: ✅ すべて達成（2025-10-14）
- ✅ MIDI出力の小節数が正確（19コード = 19小節）
- ✅ GarageBandで四分音符の長さが正しい
- ✅ "Enable Sections"と"Section"ボタンの区別が明確
- ✅ メニューボタンのアイコンとテキストが見やすい
- ✅ 2行レイアウトで余裕がある
- ✅ すべての機能が正常動作

**完了工数**: 7.33日（2025-10-12～2025-10-14）

---

**🔜 Phase 3: MIDI出力（完了）**

*最終更新: 2025-10-12（Phase 3-C: DAW対応完全強化）*

#### Phase 3-A: 基本実装（完了）
* **MIDIExportService**：Chord Track生成、Section Markers、Guide Tones（3rd + 7th）
* **SMF Type-1書き出し**：MusicSequenceFileCreateDataで2トラック生成
* **MIDIボタン**：Pro専用、共有シート統合
* **Telemetry**：`midi_export`イベント記録
* **DoD**：DAWへ読み込むだけで**構成（Markers）とコード骨格＋ガイドトーン**が再現 ✅

#### Phase 3-B: MIDI大幅強化（完了）
**実装日**: 2025-10-11

* **UI再設計**: SketchListViewにExportメニュー追加（PNG/MIDI選択式）
* **4トラック構成**: Guitar/Bass/Scale Guide (Middle/Bass)
* **Program Change**: 楽器自動選択
* **Scale Guide Track**: 2音域でゴーストノート表示（独自機能）

#### Phase 3-C: DAW対応完全強化（完了）
**実装日**: 2025-10-12

**5トラック構成**（SMF Type-1）:
```
Tempo Track (Track 0):
  ├─ Meta Event: Tempo (BPM 120)
  ├─ Meta Event: Key Signature (FF 59 02 sf mi) ★NEW
  ├─ Meta Event: Time Signature (FF 58 04 04 02 18 08) ★NEW → 4/4
  ├─ Chord Symbols (Marker Type 6) → "C", "Am", etc.
  └─ Section Markers (Type 6) → "Verse (2x)", "Chorus (1x)"

Track 1: Guitar [Program 24: Nylon String Guitar] (Channel 0)
  └─ Block Chords（Root+3rd+5th+7th、全音符、Close Voicing） ★Updated
     音域: C3-C5 (MIDI 48-72)

Track 2: Bass [Program 33: Acoustic Bass] (Channel 1)
  └─ Root-5th-Root-5th パターン（4分音符） ★Updated
     音域: C2-C3 (MIDI 36-48)

Track 3: Scale Guide (Bass) [Program 33] (Channel 2)
  └─ スケール構成音（低音域、ベース作成用、Velocity 20、1オクターブ）
     音域: C2-C3 (MIDI 36-48) ★Fixed

Track 4: Scale Guide (Middle) [Program 24] (Channel 3)
  └─ スケール構成音（中音域、メロディ作成用、Velocity 20、2オクターブ連続） ★Updated
     音域: C3-C5 (MIDI 48-72)

Track 5: Guide Tones (3rd/7th) [Program 24] (Channel 4) ★NEW
  └─ 3度と7度のみ（ジャズ/ポップアレンジ用、Velocity 30）
     音域: C3-C4 (MIDI 48-60)
```

**Phase 3-C の新機能**:
1. ✅ **Key Signature** - DAWでの調号自動表示（Major/Minor判定、相対長調計算）
2. ✅ **Time Signature** - 拍子情報（4/4）
3. ✅ **Block Chords** - 全音符での和音出力（DAWで編集しやすい）
4. ✅ **Close Voicing** - 前のコードからの最小移動距離を計算（voice leading）
5. ✅ **Guide Tones Track** - 3度と7度の専用トラック（独立制御可能）
6. ✅ **Bass Pattern Updated** - Root-5th-Root-5th（よりシンプルで汎用的）
7. ✅ **Scale Guide範囲修正** - Bass: C2-C3（1オクターブ）、Middle: C3-C5（2オクターブ連続）

**音楽理論エンジン強化**:
- **Close Voicing Algorithm**: 12パターンの転回形を試行し、最小移動距離を選択
- **Key Signature判定**: Scale type（Ionian/Dorian/Aeolian等）から自動判定
- **相対長調計算**: Minor keyの場合、相対Majorのtonicで調号を設定
- **27種類のスケール対応**: Diatonic Modes, Pentatonic, Blues, Harmonic/Melodic Minor等

**技術課題と解決**:
- ✅ Scale Guide音域調整（-36→-24で聞き取りやすく）
- ✅ Key Signature誤判定修正（Scale type優先ロジック）
- ✅ Track名とデータの不一致解決（addScaleGuide順序修正）
- ✅ Bass音域を適切に下げる（C3→C2）

**効果**:
- ✅ **プロフェッショナルDAWユーザーにも対応**
- ✅ **編集時間を大幅短縮**（Block Chords + Close Voicing）
- ✅ **音楽理論の可視化**（Key Signature + Guide Tones）
- ✅ **作曲初心者〜上級者まで幅広く支援**

**DoD**:
- ✅ 5トラック生成（Guitar/Bass/Scale Guide×2/Guide Tones）
- ✅ Key Signature正しく表示（GarageBandで確認）
- ✅ Time Signature正しく表示（4/4）
- ✅ Block Chords（全音符）
- ✅ Close Voicing（最小移動距離）
- ✅ Guide Tones Track独立
- ✅ Bass Line: Root-5th-Root-5th
- ✅ Scale Guide適切な音域（Bass: C2-C3, Middle: C3-C4）
- ✅ DAWでの動作確認（GarageBand）

---

**✅ Phase 4: Sketch無制限（クラウド同期）** （完了）

*最終更新: 2025-10-14*

**実装内容**:
- **CloudKitManager**: iCloud統合、CRUD操作、競合解決（Last-Write-Wins）
- **SketchManager拡張**: Pro判定、自動同期、エラーハンドリング、Singleton化
- **UI強化**: 同期状態表示、Pro/Free区別、エラー表示、Pro誘導
- **CloudKit Dashboard設定**: recordNameインデックス追加、スキーマ定義完了

**Pro機能**:
- **無制限Sketch保存**（Free: 3個 → Pro: 無制限）
- **iCloud自動バックアップ**（データ損失防止）
- **デバイス間自動同期**（iPhone/iPad/Mac）
- **オフライン対応**（ローカルキャッシュ + 自動同期）

**技術仕様**:
- **CKRecord**: `Sketch`（name, bpm, chords, sectionDefinitions, playbackOrder等）
- **競合解決**: Last-Write-Wins（lastModified基準）
- **エラーハンドリング**: iCloud可用性チェック、ネットワークエラー表示
- **UI**: 同期ボタン、最終同期日時、エラー表示、Pro誘導

**CloudKit設定**:
- **Bundle Identifier**: `TH-Quest.OtoTheory`
- **Container**: `iCloud.TH-Quest.OtoTheory`
- **Record Type**: `Sketch`
- **Indexes**: `recordName` (QUERYABLE), `lastModified` (Queryable, Sortable)

**DoD**:
- ✅ CloudKitManager実装（CRUD + 同期ロジック）
- ✅ SketchManager統合（Pro判定 + 自動同期）
- ✅ UI実装（同期状態表示、Pro/Free区別）
- ✅ Xcode Capabilities設定（iCloud + CloudKit）
- ✅ CloudKit Dashboard設定（recordName QUERYABLE）
- ✅ ビルド成功
- ✅ iPhone実機で動作確認
- ✅ iCloud同期確認（デバイスからクラウドへ保存）
- ⏳ **複数デバイス間同期テスト（要追加デバイス）**

**UX改善（追加実装）**:
- ✅ **Sketch導線統一**: タブバーの「Sketches」のみに統一（Chord Progression上部のボタン削除）
- ✅ **Convert to Section機能拡張**: SectionType選択、Name編集、重複時の自動番号付与
- ✅ `SketchTabView.swift` 削除（導線統一のため）

**完了工数**: 0.33日（2025-10-14）

> **✅ 完了**: CloudKit機能が有効化され、iCloud同期が動作確認済み。Dashboardで `recordName` インデックスを QUERYABLE に設定済み。

---

**✅ Phase 5: プリセット拡張（完了）**

*最終更新: 2025-建立14*

**実装内容**:
- **プリセット数拡張**: 20種 → 50種（Free 20 + Pro 30）
- **ジャンル拡張**: 5種 → 7種（R&B/Soul, Acoustic追加）
- **UI改善**: ジャンルチップスタイル、プリセット数表示
- **Pro誘導強化**: ロックUI改善、魅力的なヘッダー

**Pro専用30種の内訳**:
- Pop: 10種（8-bar Ballad, Beatles, Synth Pop, etc.）
- Rock: 5種（Rock Anthem, Alternative, Hard Rock, etc.）
- Jazz: 7種（Coltrane Changes, Tritone Sub, Bossa Nova, etc.）
- Blues: 2種（Minor Blues, Slow 12-bar Blues）
- R&B/Soul: 3種（R&B Soul, Neo Soul, Motown）
- Acoustic: 3種（Folk Ballad, Celtic, Fingerstyle）

**DoD**:
- ✅ 50種のプリセット実装（Free 20 + Pro 30）
- ✅ 7カテゴリーに整理
- ✅ ジャンルチップUIで視認性向上
- ✅ Pro Onlyプリセットの魅力的な表示
- ✅ Freeユーザーへの適切なPro誘導
- ✅ すべてのプリセットが正常動作
- ✅ iPhone 12で動作確認

**完了工数**: 0.25日（2025-10-14）

> *メモ：スプリット小節等は**M4.1 以降**の拡張として扱い、**ミニDAW化は回避**。中核のMIDIを先行で完成させる。*

---

## **M4.1 以降（拡張：前処理の時短をさらに強化）** ★任意

### アプリ内音響改善（先送り事項）

* **音色品質改善**（Phase C-1 先送り）：
  - Distortion/Over Drive のワウペダル効果軽減
  - Acoustic Nylon のドラム音混入修正
  - 理由：現在の音色で十分な品質、優先度低
* **ベース Humanize**（Phase C-5 先送り）：
  - ±5ms タイミング、±6 Velocity
  - 理由：現在の同期精度で十分、Humanizeは必須ではない
* **ドラム再実装**（Phase C-3 先送り）：
  - シンプルなパターン（キックのみ、スネアのみ等）
  - CPU負荷とタイミング精度を考慮した実装
  - 理由：CPU過負荷・心理音響問題により先送り、将来的に再検討

### MIDI Export拡張

* **Split Bar**（1小節=2コード）：曲っぽさの最小強化（MIDIは2拍/2拍で反映）。
* ✅ **MIDI多トラック拡張**（Phase 3-Cで完了）：
  - ✅ Key Signature / Time Signature
  - ✅ ブロック和音（全音符）
  - ✅ 近接ボイシング（Close Voicing）
  - ✅ ガイドトーン（3rd/7th専用トラック）
  - ✅ Bass (Simple)バリエーション（Root-5th-Root-5th）
  **DoD達成**：5トラック生成、DAWでの動作確認完了。

### アプリUI拡張 ✅ **完了（M4-D、2025-10-11）**

* ✅ **キー候補拡張**：3→5に増加
* ✅ **スケール候補拡張**：無制限→5に制限
* ✅ **スケール音プレビュー**：選択したスケールを「たららららら」と再生
  - AVAudioEngine + AVAudioUnitSampler
  - 15種類のスケール対応（Diatonic Modes, Minor Variations, Pentatonic, Blues）
  - 上昇→下降パターン、200ms per note
  - UI: 緑色の🔊ボタン

---

## **M5. サウンドパレット実装（v3.2新機能）** ★主軸移行

### M5-A：サウンドパレットUI実装（1-2週間）

**目的**: **"音の雰囲気"でコードを選ぶ**体験をPro機能として提供

**実装内容**:
- **カテゴリカード**：✨キラキラ・浮遊感、🌃おしゃれ・都会的、⚡️緊張感・スパイス
- **2タップ原則**：カテゴリカード→試聴→**＋Add**の**2タップ以内**
- **感情語説明**：理論的説明ではなく、情景語で説明（例：**mM7＝「映画音楽のような、ミステリアスでドラマチック」**）
- **Free制限**：チップ表示のみ（タップでPro誘導トースト）

**DoD**:
- ✅ カテゴリカード表示（3カテゴリ）
- ✅ 2タップ追加フロー（カテゴリ→試聴→＋Add）
- ✅ 感情語説明表示（hover/長押し）
- ✅ Free制限時のPro誘導トースト
- ✅ Telemetry実装（`sound_palette_category_view`等）

### M5-B：Web版サウンドパレット統合（1週間）

**実装内容**:
- **カテゴリカード表示**（非アクティブ）
- **Pro誘導トースト**（タップでApp Store CTA）
- **6面CTAとの一貫性**（サウンドパレット誘導）

**DoD**:
- ✅ Web版カテゴリカード表示
- ✅ Pro誘導トースト実装
- ✅ 6面CTAとの一貫性確保

---

## **M6. Android版実装（v3.2新機能）** ★将来計画

### M6-A：Android基盤構築（2-3週間）

**実装内容**:
- **Android Studio環境構築**
- **基本UI実装**（Free機能のみ）
- **広告統合**（AdSense/AdMob）

**DoD**:
- ✅ Android Studio環境構築
- ✅ 基本UI実装（Free機能のみ）
- ✅ 広告統合（AdSense/AdMob）
- ✅ iOS Pro誘導導線

### M6-B：広告最適化（1週間）

**実装内容**:
- **CLS回避**（Cumulative Layout Shift対策）
- **プレースホルダー設計**
- **表示頻度最適化**

**DoD**:
- ✅ CLS回避実装
- ✅ プレースホルダー設計
- ✅ 表示頻度最適化
- ✅ ページ品質維持

---

## **M7. Polish & Release（横断仕上げ）**

* **PNGテーマ自動反転**の**再検討**（v3.2は白固定）／背景バリエーションの整理。
* **A11y**：roving‑tablist／focus‑visible／色以外の手掛かり。
* **Telemetry最終化**：各操作=1発火（`export_png / progression_play / save_project` ほか）。
* **QA**：非ヘプタ例外（Pent/Blues Roman）／Capo注記（Shaped vs Sounding）の回帰。
* **サウンドパレット**：感情語説明の品質向上、カテゴリ分類の最適化。

---

## スコープ整理（v3.2 確定）

**In（v3.2）**

* **Web Lite GA**（録音撤去・6面CTA・計測追加・ドキュメント整合）
* **iOS v1**：Free＝M3パリティ／Pro＝**セクション編集＋MIDI（Chord＋Markers＋Guide）＋無制限保存＋IAP＋サウンドパレット**。
* **サウンドパレット**：**"音の雰囲気"でコードを選ぶ**体験（Pro機能）
* **Android版計画**：**Pro機能なし**、**広告モデル**、iOS Pro誘導

**Out / vNext**

* 録音解析（Analyze）一式（**Flag OFF 継続**）。
* Split Bar／Groove／ミニベース／MIDI多トラックは**M4.1+**で段階導入。
* Undo再検討（今回は**非搭載**で確定）。

---

## 受け入れ基準（DoDの更新点）

* **Undo**：**なし**（キャンセル確定）。Milestones/SSOTの該当記述を**v3.2注記**で上書き。
* **PNG**：**白背景固定**。`export_png` は**成功/失敗に関わらず1回**送出。
* **Web GA**：Analyze非露出／6面CTA動作／ファネル計測が取得できること。
* **iOS Pro**：**MIDI（Chord＋Markers＋Guide）**がDAWで再現／セクション編集の結果が**Marker**に反映／IAP計測（`paywall_view/purchase_success`）。
* **サウンドパレット**：カテゴリカード→試聴→**＋Add**が2タップ以内、感情語説明表示、Free制限時はPro誘導トースト。
* **Android版**：Free機能のみ、広告統合、iOS Pro誘導、CLS回避。

---

## ドキュメント整合（PRメモ）

1. `docs/SSOT/OtoTheory_v3.2_Roadmap_Milestones.md` を**本テキストで置換**（v3.2としてコミット）。
2. `docs/SSOT/OtoTheory_v3.1_Implementation_SSOT.md` に**注記を追記**：

   * Undo=キャンセル（LiteのDoDから削除）
   * PNG=白固定（テーマ自動反転は将来）
   * Web v1は録音非搭載（Flag OFFのまま） 
3. `docs/SSOT/OtoTheory_v3.2_SSOT.md` の**"出力/Free vs Pro"**・**"録音（β）"**の節に上記注記の参照リンクを追加。

---

## ✅ Phase CL: Chord Library Static v0（完了）

**実装日**: 2025-10-16  
**目的**: 静的フォームデータ投入（Open/Root‑6/Root‑5/Root‑4）。My Forms保存機能を追加し、iOS収益軸（CloudKit/Pro）を強化。

### 詳細内容

**Phase CL-1: 静的データ投入** ✅ 完了
* **フォーム構成**: Open / Root‑6 / Root‑5 / Root‑4 / Triad（3和音、基本形）
* **表示順固定**: Open → Root‑6 → Root‑5 → Root‑4 → Triad‑1 → Triad‑2
* **今後拡張**: Triad転回形（第1・第2転回形）

**Phase CL-2: Canvas描画 & 音声再生** ✅ 完了
* Canvas-basedフレットボード描画（3表示モード: Finger/Roman/Note）
* FluidR3_GM.sf2音源（Strum/Arpeggio）

**Phase CL-3: メインUI** ✅ 完了
* 横スクロール（TabView）
* 横向き推奨バナー
* `shapeName` 未指定フォームのタイトル推定（UI側）

**Phase CL-4: My Forms機能** ✅ 完了
* **Free版**: UserDefaults、最大30件、LRUポリシー
* **Pro版**: CloudKit同期（無制限）、Last-Write-Wins衝突解決

**Phase CL-5: 統合** ✅ 完了
* MainTabView統合、Telemetry統合（4イベント）

### 実装統計
- **新規ファイル**: 7個（2,262行）
- **実装期間**: 2025-10-16（1日）
- **ビルド状態**: ✅ BUILD SUCCEEDED

### 関連ファイル
- [実装レポート](../reports/ChordLibrary_Static_v0_Implementation_Report.md)

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/01/19 | 3.2 | v3.1をベースに、サウンドパレット（カテゴリ）、Android版計画、日英同時リリース計画を追加。v3.2を正として採用。 |
| 2025/10/16 | 3.1 | Web Lite GA、iOS収益軸、Undo非搭載、PNG白背景固定 |
