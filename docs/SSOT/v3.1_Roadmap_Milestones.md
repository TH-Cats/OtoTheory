# OtoTheory v3.1 — マイルストーン & 範囲（期日なし方式・Web→iOSシフト）

*最終更新: 2025/10/10*

> **参照**：
> ・現行マイルストーン（M0〜M3 完了／M4定義）
> ・実装要件 v3.0（ProのMIDI：Chord＋セクションマーカー＋ガイドトーン／録音UIはFlag OFF） 
> ・SSOT v3.0 正本（結果カード→Diatonic→Fretboard二層→提案／Capo Top2（Shaped）／出力境界） 

---

## ✅ 変更サマリー（v3.1差分）

* **Undo**：**キャンセル確定**（個別削除＆D&Dで代替）。DoD／ドキュメント注記を更新。
* **PNG出力**：**白背景固定**を明記（テーマ自動反転は将来）。Telemetry `export_png` は**必ず1回のみ**送出の原則を継続。
* **Web Lite**：M3完了範囲で**即リリース可**。**Melody/Solo Analyze（録音）**は**メニューから撤去**（Flag OFF方針と一致）。
* **M4以降**：**iOSアプリ開発を主軸**に移行（**セクション編集／MIDI出力（Chord＋Markers＋Guide）／Sketch無制限**＝Proの核）。

---

## M0. Baseline（統合の土台） ✅ 完了

* Chord Progression を主導線、**結果カード→Diatonic→Fretboard二層**、Capo Top2（Shaped）。

## M1. Sketch Library（保存・呼び出し） ✅ 完了

* **Free=3件ローカル**（LRU）／**Auto‑save 3秒**／**PNG出力**（白背景固定・視認性最適化・`export_png` 1回計測）。

## M2. Progression Lite ✅ 完了

* **12コード上限**／**プリセット20**／**自動ループ**（Play/Stop, BPM, 4/4）／**Undo=キャンセル**に確定。

## M3. Find Chords 強化 ✅ 完了

* **Scale Table（Why一文＋Glossary＋アルペジオ）**／**Chord Forms（試聴）**／**Capo Top2（Shaped）**／**基礎代理コード**。

---

## **M3.5 Web Lite GA（サイト同時公開）** ✅ 完了

**実装日**: 2025-10-04  
**目的**：M3までの機能で**"触って曲の芯が分かる"**体験を提供し、**iOS Proへ送客**。App Store審査対応のため法務・サポートページを同時公開。

**In**

* **Analyze（録音）メニュー撤去**・該当ルートはChord Progressionへ**リダイレクト**（Flag OFF方針と一致）。
* **6面CTA**（ヘッダー常設／モバイル下部スティッキー／9–12到達トースト／Sketch 4件目モーダル／PNG後トースト／フッターQR）
* **計測**：既存 `export_png / progression_play / preset_inserted / toast_shown` に加え `cta_appstore_click{place}` を追加（Web→iOSファネルを可視化）。
* **Policy 9ページ（JP/EN）公開**：`/privacy` `/terms` `/subscription` `/support` `/account-deletion` `/security` `/accessibility` `/transparency` `/licenses`
* **App内設定リンク**：「設定」＞「プライバシー/利用規約/アカウント削除」へ1タップで遷移（審査対応）
* **ドキュメント整合**：Undo=キャンセル／PNG=白固定を**SSOT v3.1 注記**として反映。

**DoD**

* Web上で**プリセット→即ループ→PNG出力**まで一連を3クリック以内で完了。
* `export_png` は**成功/失敗に関わらず1発火**、`toast_shown(kind=limit_warn|limit_block)`でPro誘導が確認できる。
* **政策系URLは外部公開済み**（フッター常設）、JP/EN併記。
* `cta_appstore_click{place}` が全6面で発火。
* **録音UIは非露出**（Flag OFF）を確認済み。

---

## **M4. iOS v1（Proの核）** ★主軸移行

**狙い**：**「DAW前処理を数分で」**を**成果物（MIDI）**で実現し、IAPに直結。

### M4‑Week 1：iOS基盤構築 ✅ 完了（2025-10-04）

* **環境構築**：Xcode プロジェクト作成・Code Signing 設定完了。
* **共通ロジック**：`packages/core` パッケージ化（TypeScript → ES2020 → JS Bundle 2.2KB）。
* **JavaScriptCore Bridge**：Swift ↔ JS 通信確立（`parseChord` ✅, `getDiatonicChords` ✅）。
* **Audio Engine**：`AVAudioEngine` + `AVAudioUnitSampler` 実装、実機音出し成功 ✅。
  **DoD**：`parseChord` 成功 / `getDiatonicChords` 成功 / 単音・和音再生確認 / ビルド成功。

### M4‑Week 2：Tab Bar + UI + Audio 完全実装 ✅ 完了（2025-10-04）

#### Day 1：`getDiatonicChords` 実装 ✅
* **実装完了**：`packages/core/src/theory/diatonic.ts` 新規作成
* **テスト成功**：C ionian → `["C", "Dm", "Em", "F", "G", "Am", "Bdim"]` ✅
* **技術課題解決**：CommonJS → ES2020、esbuild IIFE（2.2KB）、Xcode参照修正

#### Day 2-3：Tab Bar Navigation 実装 ✅
* **3画面構築**：MainTabView、ProgressionView、FindChordsView、ReferenceView
* **Tab切り替え**：Chord Progression / Find Chords / Reference
* **NavigationTitle削除**：画面領域最大化

#### Day 4：12-Slot UI 実装 ✅
* **Progression Builder**：12スロット（4列×3行）、番号バッジ、カーソル管理
* **Reset機能**：全スロットクリア

#### Day 5：オーディオ統合 & Web版UX完全準拠 ✅
* **コード再生**：12キー×7種類Quick（Major, m, 7, maj7, m7, dim, sus4）
* **Root + Quick選択**：Web版と完全同一UX
* **Preview + Add**：常時表示（初期状態から）
* **削除ボタン**：スロット右上バツマーク（`xmark.circle.fill`）
* **技術課題解決**：インデント修正、スコープエラー解決、非推奨API修正

**DoD達成**：
- ✅ Tab Bar で3画面切り替え
- ✅ 12スロット表示・操作
- ✅ コード選択・追加・削除・再生
- ✅ Web版UX完全準拠
- ✅ NavigationTitle削除（領域最大化）

### M4‑Week 3：Hybrid Audio Architecture 実装 ✅ 完了（2025-10-10）

#### Phase A：基盤構築 ✅
* **Score/Bar モデル**：既存 UI slots から Score へ集約
* **GuitarBounceService**：オフラインレンダリング実装、末尾80msフェード、LRUキャッシュ（最大16バリエーション）
* **HybridPlayer 土台**：Engine + PlayerNode + 2サンプラー実装
* **SequencerBuilder 雛形**：TempoTrack のみ実装

#### Phase B：最小再生 & 音響最適化 ✅
* **ギターPCM再生**：C/G/Am/F の4拍リズム（じゃん×4）実装
* **カウントイン**：ハイハット風4拍を先頭にschedule
* **ループ機能**：最後のcompletion で2サイクル分を再schedule
* **UI同期**：Timer方式（0.1秒ごと）で画面と音が完全一致、遅延累積なし
* **音響最適化**：
  - ストローク0ms（完全同時発音）：ユーザーフィードバックにより「もたつき」を完全解消
  - フェードアウト80ms：コードの変わり目がキレッキレに
  - 4拍リズム：各拍の70%でNote Off、自然な減衰
* **音色管理**：
  - Distortion/Over Drive：ワウペダル効果のため一時的に除外
  - Acoustic Nylon：2拍目・3拍目にドラム音混入のため警告表示

**DoD達成**：
- ✅ 拍精度：BPM120で各小節=2.000s
- ✅ 減衰：末尾80msで0（波形検査で確認）
- ✅ ストローク：0ms（完全同時発音）
- ✅ ループ：クリックなし
- ✅ UI同期：画面と音が完全一致
- ✅ 音響品質：もたつきゼロ、コードの変わり目クリア

### M4‑A：iOS 基盤 & M3パリティ（Free）

* 結果カード → **Diatonic → Fretboard（二層）** → Patterns/Cadence/基礎代理（**試聴→＋Add→即ループ**）。
* **Sketch 3件（ローカル）**、プリセット→自動ループ、Capo Top2（Shaped）／非ヘプタ規則を踏襲。
  **DoD**：Web M3相当の体験が**2タップ以内**で再現。録音UIは**非露出（Flag OFF）**。

### M4‑B：iOS Pro（収益の中核） 🔜 次のマイルストーン

#### Phase C：音色改善 & ベース/ドラム
* **音色品質改善**：
  - Distortion（Program 30）：ワウペダル効果を軽減または除外
  - Over Drive（Program 29）：ワウペダル効果を軽減または除外
  - Acoustic Nylon（Program 24）：2拍目・3拍目のドラム音混入を修正または代替音源検討
* **ベース有効化**：Root/5th 基本形＋ターンアラウンド／Humanize（±5ms, ±6Vel）
* **ドラム追加**：プリセット（Rock/Pop/Funk）をステップで実装

#### Pro機能実装
* **セクション編集**（Verse/Chorus/Bridge…）→ 再生/ループと連動。
* **MIDI出力**：**Chord Track＋セクションMarkers＋Guide Tones**（SMF Type‑1）。
* **Sketch無制限（クラウド同期）**／**IAP（¥490/月）**／**Paywall & 計測**。
  **DoD**：DAWへ読み込むだけで**構成（Markers）とコード骨格＋ガイドトーン**が再現。`paywall_view / purchase_success` を記録。

> *メモ：スプリット小節等は**M4.1 以降**の拡張として扱い、**ミニDAW化は回避**。中核のMIDIを先行で完成させる。*

---

## **M4.1 以降（拡張：前処理の時短をさらに強化）** ★任意

* **Split Bar**（1小節=2コード）：曲っぽさの最小強化（MIDIは2拍/2拍で反映）。
* **Groove（簡易ドラム）／ミニベース（Root‑5/Walk）**：**再生はプリセットのみ**、**音色の作り込みはしない**。**MIDI多トラック拡張**（Drum/Bass）をオプションで追加。
  **DoD**：適用が**2タップ**で即反映。MIDI拡張は**Chord/Guide/Markers**を壊さない。

---

## M5. Polish & Release（横断仕上げ）

* **PNGテーマ自動反転**の**再検討**（v3.1は白固定）／背景バリエーションの整理。
* **A11y**：roving‑tablist／focus‑visible／色以外の手掛かり。
* **Telemetry最終化**：各操作=1発火（`export_png / progression_play / save_project` ほか）。
* **QA**：非ヘプタ例外（Pent/Blues Roman）／Capo注記（Shaped vs Sounding）の回帰。

---

## スコープ整理（v3.1 確定）

**In（v3.1）**

* **Web Lite GA**（録音撤去・6面CTA・計測追加・ドキュメント整合）
* **iOS v1**：Free＝M3パリティ／Pro＝**セクション編集＋MIDI（Chord＋Markers＋Guide）＋無制限保存＋IAP**。

**Out / vNext**

* 録音解析（Analyze）一式（**Flag OFF 継続**）。
* Split Bar／Groove／ミニベース／MIDI多トラックは**M4.1+**で段階導入。
* Undo再検討（今回は**非搭載**で確定）。

---

## 受け入れ基準（DoDの更新点）

* **Undo**：**なし**（キャンセル確定）。Milestones/SSOTの該当記述を**v3.1注記**で上書き。
* **PNG**：**白背景固定**。`export_png` は**成功/失敗に関わらず1回**送出。
* **Web GA**：Analyze非露出／6面CTA動作／ファネル計測が取得できること。
* **iOS Pro**：**MIDI（Chord＋Markers＋Guide）**がDAWで再現／セクション編集の結果が**Marker**に反映／IAP計測（`paywall_view/purchase_success`）。

---

## ドキュメント整合（PRメモ）

1. `docs/SSOT/OtoTheory_Roadmap_Milestones.md` を**本テキストで置換**（v3.1としてコミット）。
2. `docs/SSOT/OtoTheory_v3.0_Implementation_SSOT.md` に**注記を追記**：

   * Undo=キャンセル（LiteのDoDから削除）
   * PNG=白固定（テーマ自動反転は将来）
   * Web v1は録音非搭載（Flag OFFのまま） 
3. `docs/SSOT/OtoTheory_v3.0_SSOT.md` の**"出力/Free vs Pro"**・**"録音（β）"**の節に上記注記の参照リンクを追加。

---

