# OtoTheory v3.2 — System Architecture（Web Lite & iOS収益軸）

*最終更新: 2025/01/19*

> 本書は v3.1 をベースに、v3.2ビジネスプラン（サウンドパレット、Android計画、日英同時リリース）を反映した差分統合版です。
> 今後は本v3.2を正として作業を進めます。v3.1は参考資料として扱います。
> v3.2ビジネスプラン（/docs/SSOT/v3.2_Business_Plan.md）を最優先とし、本書と矛盾する場合はビジネスプランを優先します。

> **目的**：v3.1 アーキテクチャを、**Web Liteを即時GA**・**iOSを収益主軸**・**Android版計画**・**サウンドパレット**とする方針へ整合。**Undoは非搭載**、**PNGは白背景固定**、**録音UIはFlag OFF** を前提に、クライアント／サービス／データ／運用を再定義する。

---

## 0. 本版の主要差分（v3.1 → v3.2）

* **WebはM3完了の Lite をGA**：**Chord Progression中心**・**結果カード→Diatonic→Fretboard（二層）→Patterns/Cadence/基礎代理** の2タップ追加→即ループ体験をコアとして公開。**Capo提案はTop2（Shaped／無音）**、**非ヘプタはRoman非表示（Pent/Blues例外）**を厳守。
* **iOSは収益主軸**：**Pro＝MIDI出力（Chord Track＋Section Markers＋Guide Tones）／セクション編集／Sketch無制限**、FreeはWebと同等のLite機能。
* **サウンドパレット（v3.2新機能）**：**"音の雰囲気"でコードを選ぶ**体験をPro機能として提供。3つのカテゴリ（キラキラ・浮遊感、おしゃれ・都会的、緊張感・スパイス）で分類。
* **Android版計画**：**Pro機能なし**、初心者特化の**広告モデル（AdSense/AdMob中心）**でマネタイズし、iOS Proへ誘導。
* **日英同時リリース**：**10月中TestFlight開始→11/15正式リリース**。EN/JAマスター準拠の翻訳体制。
* **Undoは非搭載**（キャンセル確定。個別削除＆並べ替えで代替）。Telemetry/DoDから`undo`を削除。
* **PNGは白背景固定**（v3.2の運用）。`export_png`は**保存成否に関わらず1回のみ**。
* **Melody/Solo Analyze（録音UI）はFlag OFFのまま非露出**。サーバ側`/api/analyze`は将来解禁用の設計を維持。

---

## 1. 全体像（論理アーキテクチャ）

```
┌─────────────────────────────────────────────────────────────────┐
│                   Clients (UI)                                  │
│  ┌───────────────────────────┐   ┌─────────────────────────────┐ │
│  │ Web Lite (M3 GA)          │   │ iOS App                     │ │
│  │ - Progression Lite        │   │ - Free: Lite同等            │ │
│  │ - Find Chords (ScaleTbl/  │   │ - Pro: Section/MIDI         │ │
│  │   Forms/Substitute)       │   │        /Cloud Sketch        │ │
│  │ - Sketch(3 local)         │   │        /Sound Palette       │ │
│  │ - PNG/Text Export         │   │ - Paywall/IAP               │ │
│  │ - Sound Palette (View)    │   │                             │ │
│  └───────────────▲───────────┘   └────────────▲────────────────┘ │
│  ┌───────────────────────────┐                │                  │
│  │ Android (計画)            │                │                  │
│  │ - Free機能のみ            │                │                  │
│  │ - 広告統合                │                │                  │
│  │ - iOS Pro誘導             │                │                  │
│  └───────────────▲───────────┘                │                  │
│                  │Telemetry + API + 広告配信                     │
└───────────────┬──┴───────────────────────────────┬──────────────┘
                │                                    │
        ┌───────▼────────┐                    ┌──────▼────────┐
        │  API Layer      │                    │ Telemetry      │
        │  (HTTPS/JSON)   │                    │ Collector      │
        ├─────────────────┤                    ├────────────────┤
        │ /sketch (Pro用) │                    │ event sink     │
        │ /midi (iOS Pro) │                    │ (page_view/… ) │
        │ /analyze (Flag) │                    │ sound_palette  │
        │ /ads (Android)  │                    │ android_ads    │
        └───┬───────────┬─┘                    └────────────────┘
            │           │
   ┌────────▼───┐  ┌────▼────────┐  ┌─────────────┐
   │ Cloud Store │  │ Analyze Svc │  │ Ad Network   │
   │ (Sketch/…)  │  │ (server-run │  │ (AdSense/    │
   │             │  │  /api/      │  │  AdMob)      │
   │             │  │  analyze)   │  │              │
   └─────────────┘  └─────────────┘  └─────────────┘
                    ← *Flag OFF（将来ON）*        ← *Android版用*
```

* **UI哲学**（全クライアント共通）：**結果カード → Diatonic → Fretboard（二層） → 提案群**、**「試聴→＋Add→即ループ」**の2タップ原則。
* **出力境界**：Free＝**PNG/テキスト**、Pro（iOS）＝**MIDI（Chord＋Markers＋Guide）**。
* **録音**：**UIは非露出**（Flag OFF）。サーバ解析は**Line‑in前提**の`/api/analyze`を温存。
* **サウンドパレット**：**"音の雰囲気"でコードを選ぶ**体験。カテゴリ別UI、感情語説明、2タップ追加フロー。
* **Android版**：**Free機能のみ**、**広告モデル**、iOS Pro誘導。

---

## 2. クライアント構成

### 2.1 Web（Lite / GA）

* **モジュール**：

  * **Chord Progression Lite**（12上限・プリセット20・自動ループ）
  * **Find Chords**（Scale Table／Chord Forms／Substitute）
  * **ToneOverlay（二層）**：Scale＝輪郭/小、Chord＝塗り/大。**Reset＝Chordのみ**。
  * **Capo提案**：**Top2（Shaped）**・**無音**・注記併記。
  * **Sketch（3件・ローカル）**／**PNG/テキスト出力（白背景固定・`export_png`は1回）**。
  * **サウンドパレット（表示のみ）**：カテゴリカード表示（非アクティブ）、Pro誘導トースト。
* **音**：単音 Attack≈3–5ms／Release≈80–150ms、最大6声（voice‑stealing）。和音は**同時 or 軽ストラム（≈10–20ms）**。初回はAudio Unlocker。
* **Telemetry**：`page_view / progression_play / preset_inserted / play_note / play_chord / export_png / instrument_change / toast_shown(kind)` ＋ **`cta_appstore_click{place}`**（送客計測）＋ **`sound_palette_category_view`**（v3.2新機能）。
* **非ヘプタ**：Roman非表示（**Pent/Bluesのみ例外**）、Capo行は無効。

### 2.2 iOS（Free / Pro）

* **Free**：Web Lite と同等の体験（**Undoなし**、Sketch 3件、PNG/テキスト）。
* **Pro**：

  * **セクション編集**（Verse/Chorus/Bridge…） → 再生/ループと連動。
  * **MIDI出力**：**SMF Type‑1**、**Chord Track＋Section Markers＋Guide Tones**。
  * **Sketch無制限（クラウド）**、**IAP（¥490/月）**。
  * **サウンドパレット**：**"音の雰囲気"でコードを選ぶ**体験。
    - カテゴリカード表示（3カテゴリ）
    - 2タップ追加フロー（カテゴリ→試聴→＋Add）
    - 感情語説明（hover/長押し）
    - Free制限時はPro誘導トースト
* **録音UI**：非露出（Flag OFF 維持）。

### 2.3 Android（計画）

* **機能範囲**：
  * **基本コード進行**（12コード上限）
  * **Find Chords**（Scale Table、基礎代理）
  * **プリセット20種**（Free版と同等）
  * **Sketch保存3件**（ローカル）
  * **PNG出力**（白背景固定）
* **非搭載機能**：
  * セクション編集
  * MIDI出力
  * サウンドパレット（Pro専用コード）
  * クラウド同期
  * プリセット拡張（Pro30種）
* **広告戦略**：
  * **AdSense/AdMob統合**
  * バナー広告（ページ下部、非侵入的）
  * インタースティシャル（アプリ起動時、適度な頻度）
  * リワード広告（追加機能アンロック、オプション）
* **UX配慮**：
  * CLS（Cumulative Layout Shift）回避
  * 高速描画、プレースホルダー使用
  * 表示点数上限設定（ページ品質維持）
  * 広告ブロッカー対応
* **iOS Pro誘導**：
  * アプリ内CTA（「より高度な機能はiOS Proで」）
  * 広告表示時のPro機能紹介
  * 制限到達時のiOS Pro案内

---

## 3. サービス構成（API / バックエンド）

* **API Layer（HTTPS/JSON）**

  * `/sketch/*`：Proのクラウド保存・読み出し。
  * `/midi/export`：iOS Pro のMIDI生成（端末内生成でもよい。メタとして**Markers/Key**連携）。
  * `/analyze`：将来解禁用の**サーバ実行**（Line‑in前提・**Conf%**と再録Adviceを返す）。**今はFlag OFF**。
  * `/ads/*`：Android版の広告配信（AdSense/AdMob統合）。
* **Cloud Store**：Sketchメタ（Key/Scale／Capo（Shaped）／進行／Fretboard表示状態）を保存。**Freeはローカル3件**、**Proはクラウド無制限**。
* **Telemetry Collector**：イベントをバッチ/ストリームで集計（*event schema はSSOTのイベント名を正*）。
* **広告配信（Android向け）**：
  * **AdSense/AdMob SDK統合**
  * **CLS回避の実装パターン**
  * **プレースホルダー設計**
  * **表示頻度最適化**

> **注**：PNGは**クライアント生成**を基本（白背景固定）。`export_png`の**1操作=1発火**はクライアントで担保。

---

## 4. データモデル（概念）

* **Sketch**（概念）

  * `key`（tonic, scaleId）／`capo`（capoFret + **Shaped注記**）／`progression`（Lite上限12）／`fretboardView`（Degrees/Names, guide）／`meta`（id/name/createdAt/updatedAt/schema/appVersion）。
  * 復元時は**非ヘプタ規則**と**Capo注記**を厳守。
* **MIDI（iOS Pro）**

  * **Chord Track**（Triad/7th）、**Guide Tones**（3rd/7th 等）、**Section Markers**（Verse/Chorus…）。**SMF Type‑1**で書き出し。
* **Analyze（将来）**

  * 入力：録音blob/PCP12、出力：`keyCandidates (≤3, conf)`＋`advice?`。**Line‑in前提**。
* **サウンドパレット（v3.2新機能）**

  * **カテゴリ定義**：✨キラキラ・浮遊感、🌃おしゃれ・都会的、⚡️緊張感・スパイス
  * **感情語説明**：理論的説明ではなく、情景語で説明
  * **UI状態**：カテゴリ選択、コード試聴、追加フロー
* **広告データ（Android向け）**

  * **広告配信設定**：表示頻度、プレースホルダー、CLS回避
  * **ユーザー行動**：広告表示、クリック、iOS Pro誘導

---

## 5. Feature Flags & 環境

* `recording.ui.enabled` **= false**（既定）。将来ON時のみメニュー露出。
* `export.png.themeAutoInvert` **= false**（v3.2。白背景固定）
* `undo.enabled` **= false**（v3.2）
* `cta.appstore.enabled` **= true**（6面CTAをWebに常設）
* `sound_palette.enabled` **= true**（v3.2新機能）
* `android.ads.enabled` **= true**（Android版広告配信）

---

## 6. セキュリティ / プライバシー / ライセンス

* **録音解析**：**サーバ実行**を前提に設計（AGPL等の懸念をクライアント配布から切り離す）。**UIはFlag OFF**のまま。
* **最小収集**：Telemetryは**最小限の操作イベント**のみ（個人特定情報は収集しない方針）。イベント名はSSOT準拠。
* **出力物**：PNG/MIDIは**ユーザー生成物**。MIDIは**Markers/Guide**を含むがオーディオデータは持たない。
* **広告配信**：Android版の広告配信は**AdSense/AdMob**の標準的なプライバシーポリシーに準拠。
* **サイト/ポリシー**：App Store審査対応のため以下のページを公開（JP/EN）
  - `/privacy`, `/terms`, `/subscription`, `/support`, `/account-deletion`, `/security`, `/accessibility`, `/transparency`, `/licenses`
  - フッター常設リンク＋App内「設定」から1タップ遷移
  - Support返信SLA=2営業日以内、公開14日内の審査一次指摘0件を目標

---

## 7. 運用 / デプロイ指針（要約）

* **Web**：静的配信＋CDN（TTFIを重視）。PNGはクライアント生成。
* **iOS**：App Store 配信／**IAP（¥490/月）**／Sign in with Apple（Pro同期用）。
* **Android**：Google Play 配信／**広告モデル**（AdSense/AdMob）。
* **監視**：クライアント側のイベント発火（`progression_ະlay / export_png / cta_appstore_click / paywall_view / purchase_success / sound_palette_* / android_ads_*` など）をダッシュボード化。

---

## 8. テレメトリ（イベント表｜抜粋）

| カテゴリ          | イベント                                                                  | 備考                                                |                         |
| ------------- | --------------------------------------------------------------------- | ------------------------------------------------- | ----------------------- |
| Navigation    | `page_view`                                                           | `chord_progression / find_chords` 他。旧ラベル互換は90日維持。 |                         |
| Find Chords   | `key_pick / scale_pick / diatonic_pick / play_chord`                  | Why表示/アルペジオなど拡張あり。                                |                         |
| Progression   | `progression_play / preset_inserted / play_chord / instrument_change` | Undoは廃止。                                          |                         |
| Limits        | `toast_shown(kind=limit_warn                                          | limit_block)`                                     | 9–12の段階濃色や13ブロックでPro誘導。 |
| Export        | `export_png`                                                          | **成功/失敗に関わらず1回**。                                 |                         |
| Web→iOS       | `cta_appstore_click{place}`                                           | header / sticky / limit_toast / png_toast / qr    |                         |
| Purchase(iOS) | `paywall_view / purchase_success`                                     | Pro導線の健全性を可視化。                                    |                         |
| Sound Palette | `sound_palette_category_view / sound_palette_code_preview`            | v3.2新機能。カテゴリ別コード選択。                                |                         |
| Android Ads   | `android_ads_shown / android_ads_click / ios_pro_prompt`              | Android版広告配信、iOS Pro誘導。                              |                         |

---

## 9. 受け入れ基準（アーキテクチャ観点）

* Web：**プリセット→即ループ→PNG出力**が**3クリック以内**で成立。`export_png` は1発火。
* iOS Pro：**MIDI（Chord＋Markers＋Guide）**がDAWで再現／セクション編集がMarkerに反映。
* サウンドパレット：カテゴリカード→試聴→**＋Add**が2タップ以内、感情語説明表示、Free制限時はPro誘導トースト。
* Android版：Free機能のみ、広告統合、iOS Pro誘導、CLS回避。
* 共通：**Capo Top2（Shaped／無音）**、**非ヘプタRoman非表示（Pent/Blues例外）**、**二層Overlay＆Reset=Chordのみ**を全画面で一貫。

---

### 付記（非エンジニア向け）

* **作る流れは同じ**：①Key/Scale → ②Diatonic＋Fretboard（二層） → ③**提案を試聴→＋Add** → ④即ループ。気に入ったら **Sketch保存**・**PNG**・（iOS Proなら）**MIDI**。
* **サウンドパレット**：**"音の雰囲気"でコードを選ぶ**体験。理論ではなく、**感情語・情景語**で説明し、直感的に選べます。
* **Android版**：初心者向けのシンプルな機能に特化し、**広告モデル**でマネタイズ。より高度な機能は**iOS Pro**で提供。
* **録音は後日**：いまはFlag OFFのまま。まずは**"理論×即制作×MIDIで仕上げ"**の体験を磨く。

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/01/19 | 3.2 | v3.1をベースに、サウンドパレット、Android版計画、日英同時リリースを反映。v3.2を正として採用。 |
| 2025/10/10 | 3.1 | Web Lite GA、iOS収益軸、Undo非搭載、PNG白背景固定 |
