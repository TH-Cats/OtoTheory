# OtoTheory v3.2 — Single Source of Truth（仕様 正本）

*最終更新: 2025/01/19*

> 本書は v3.1 をベースに、v3.2ビジネスプラン（サウンドパレット、Android計画、日英同時リリース）を反映した差分統合版です。
> 今後は本v3.2を正として作業を進めます。v3.1は参考資料として扱います。
> v3.2ビジネスプラン（/docs/SSOT/v3.2_Business_Plan.md）を最優先とし、本書と矛盾する場合はビジネスプランを優先します。

---

## 0. 本版の主要決定（v3.1 → v3.2 の差分）

* **Webは M3 完了の Lite を GA**：録音UI（Melody/Solo Analyze）は**メニューから撤去**し、**Flag OFF**のまま（UI非露出）。
* **iOS を収益主軸**（M4）：**セクション編集**／**MIDI出力（Chord Track＋Section Markers＋Guide Tones）**／**Sketch無制限（クラウド）**／**IAP（¥490/月）**。
* **Undo は非搭載（キャンセル確定）**：個別削除・並べ替えで代替。**DoD と Telemetry から "undo" を削除**。
* **PNG 出力は白背景固定（v3.2）**：テーマ自動反転は将来再検討。`export_png` は**成功/失敗に関わらず1回のみ**発火。
* **サウンドパレット（カテゴリ）**：**"音の雰囲気"でコードを選ぶ**体験をPro機能として提供。3つのカテゴリ（キラキラ・浮遊感、おしゃれ・都会的、緊張感・スパイス）で分類。
* **Android版計画**：**Pro機能なし**、初心者特化の**広告モデル（AdSense/AdMob中心）**でマネタイズし、iOS Proへ誘導。
* **日英同時リリース**：**10月中TestFlight開始→11/15正式リリース**。EN/JAマスター準拠の翻訳体制。
* **多言語パイプライン統一**：**グローバルLocaleContext**を導入し、全コンポーネントで統一されたローカライゼーション管理を実現。
* v3.1の中核原則（**二層Overlay／非ヘプタ規則／Capo Top2（Shapedのみ・無音）／"試聴→＋Add→即ループ"**）は継続。

---

## 1. データ管理（Single Source of Truth）

### 1.0 MIDI実装仕様（必須参照）

**ファイル**: `/Users/nh/App/OtoTheory/on-chord-midi-specification.md`

**役割**: オンコード（スラッシュコード）のMIDI実装に関する**単一の真実の源（SSOT）**として機能

**⚠️ 重要**: MIDI関連の実装・修正を行う前に、必ずこの仕様書を確認すること

**管理内容**:
- **基本仕様**: オクターブ範囲、クランプ、解析ルール
- **MIDI Export仕様**: ギター・ベーストラックの詳細仕様
- **アプリ内再生仕様**: 各サービスの動作定義
- **実装ファイル**: 各ファイルの責務とメソッド
- **テスト仕様**: テストケースとエッジケース
- **制約事項**: パフォーマンス、互換性、制限

**更新フロー**:
1. 仕様変更時は必ずこの文書を更新
2. 実装時はこの仕様に従って実装
3. テスト時は仕様書のテストケースを参照
4. レビュー時は仕様との整合性を確認

**実装対象**:
- **MIDIExportService.swift**: 統一パーサ、三段階安全弁、Voice Leading
- **BassBounceService.swift**: ベース音抽出（スラッシュ対応）
- **GuitarBounceService.swift**: ギターボイシング生成（クランプ付き）
- **ChordSequencer.swift**: レガシー再生用ボイシング

### 1.1 コードライブラリマスターCSV

**ファイル**: `/Users/nh/App/OtoTheory/docs/content/Chord Library Mastar.csv`

**役割**: コードライブラリの**単一の真実の源（SSOT）**として機能

**データ構造**:
- **Chord**: コード名（例: C, C#, Dm, F#m7）
- **Symbol**: 表示用シンボル（例: C, C#, Dm, F#m7）
- **Quality**: コードクオリティ（M, m, M7, 7, m7, sus4, add9, sus2, 6, m6, aug, dim, m9）
- **FormOrder**: フォーム表示順序（1=Open, 2=Root-6, 3=Root-5, 4=Root-4, 5=Triad-1, 6=Triad-2）
- **FormID**: フォーム識別子（例: C-1-Open, C-2-Root6）
- **ShapeName**: 形状名（Open, Root-6, Root-5, Root-4, Triad-1, Triad-2）
- **Fret1-Fret6**: フレット配列（1弦〜6弦、0=開放、x=ミュート、数字=フレット番号）
- **Finger1-Finger6**: 指番号（1弦〜6弦、1-4=指番号、-=未使用）
- **BarreFret, BarreFrom, BarreTo**: バレー情報（フレット、開始弦、終了弦）
- **Tips**: 演奏のコツ・説明

**生成対象**:
- **iOS版**: `OtoTheory-iOS/OtoTheory/Services/StaticChordProvider.swift`
- **Web版**: `ototheory-web/src/lib/chord-library-static.ts`

**更新フロー**:
1. マスターCSVを編集
2. `scripts/csv_to_ios_swift.mjs`でiOS版を生成
3. `scripts/csv_to_web_ts.mjs`でWeb版を生成
4. 両プラットフォームに反映

**現在の規模**:
- **Total chords**: 281
- **Total forms**: 742
- **対応クオリティ**: Major, minor, M7, 7, m7, sus4, add9, sus2, 6, aug, dim, m9, M9 (maj9), 6/9, add#11, m11, m7b5, mM7, m6, 7sus4, dim7, 7(#9), 7(b9), 7(#5), 7(b13)
- **対応キー**: 全12キー（C, C#, D, D#, Eb, E, F, F#, G, G#, A, A#, Bb, B）

### 1.1.1 多言語パイプライン統一（LocaleContext）

**ファイル**: `ototheory-web/src/contexts/LocaleContext.tsx`

**役割**: 全コンポーネントで統一されたローカライゼーション管理の**単一の真実の源（SSOT）**

**アーキテクチャ**:
- **グローバルLocaleContext**: アプリ全体で一貫した言語状態を管理
- **SSRセーフ実装**: サーバーサイドとクライアントサイドで一貫した初期化
- **統一データ取得関数**: 各機能（ChordBuilder、DiatonicTable、Fretboard）で共通のローカライゼーション関数を使用

**実装対象**:
- **ChordBuilder**: クオリティコメントのローカライゼーション統一
- **DiatonicTable**: ローマ数字ラベルとツールチップの統一
- **Fretboard**: 度数/音名表示切り替えの統一
- **ページレベル**: 全UIテキストの統一

**参照ファイル**:
- **言語相対表**: `docs/SSOT/EN_JA_language_SSOT.md`を常に参照
- **統一ヘルパー**: `src/lib/i18n/`配下の各機能別ヘルパー関数

**更新フロー**:
1. 言語相対表（`EN_JA_language_SSOT.md`）を更新
2. 該当するヘルパー関数を更新
3. コンポーネントでLocaleContextを使用
4. 全プラットフォーム（Web、iOS、Android）で一貫性を確保

### 1.1.2 コードクオリティマスター（サウンドパレット対応）

**ファイル**: `/Users/nh/App/OtoTheory/docs/content/Quality Master.csv`

**役割**: コードクオリティの定義、カテゴリ分け、Free/Pro境界の**単一の真実の源（SSOT）**

**データ構造**:
- **Tier**: Free/Pro分類
- **カテゴリ (日本語/English)**: UIグルーピング用（v3.2でサウンドパレット化）
- **クオリティ (Quality)**: コードクオリティ名
- **日本語コメント/English Comment**: UI表示用の説明文（構造化形式）

**コンセプト**:
- **Free**: これさえあれば、現代のポップスやロックの8割は作れる！と感じてもらえる、頼れる基本セット。理論学習の観点からも重要なコードに絞ります。
- **Pro**: ユーザーが「この響きが欲しかった！」と直感的に選べるように、サウンドの雰囲気でカテゴリ分け。DAWですぐに使える「プロの響き」を提供します。

**コメント表示機能** ✅ 完了（2025-10-20）:
- **電球マークタップ**: 各クオリティチップに電球アイコンを配置、タップで詳細コメント表示
- **Sheet/Popover表示**: iPhoneはSheet、iPadはPopoverでモーダル表示
- **構造化コメント**: 「雰囲気」「特徴」「Try」「理論」の4セクション構成
- **視覚的デザイン**: セクションタイトルは太字・オレンジ色・18pt、段落間は8pt、項目内は3pt間隔
- **言語自動切替**: アプリの言語設定に従って日本語/英語を自動選択
- **NavigationStack対応**: iOS 16+の最新APIを使用
- **閉じる機能**: 閉じるボタンとスワイプダウンの両方で閉じられる

**サウンドパレット（v3.2新機能）**:

**カテゴリA｜✨ キラキラ・浮遊感（Sparkle & Float）**
- M9（maj9）／6／6/9／add#11
- *おしゃれ・現代的・ドリーミー。R&B/ポップの王道、レトロな温かさ、ジャズ/フュージョンの豊かさ、浮遊感の演出。*

**カテゴリB｜🌃 おしゃれ・都会的（Stylish & Urban）**
- m9／m11／m7b5／mM7（m/maj7）／m6
- *Lo‑fi〜R&B定番のアンニュイ、ジャズ/ボサの入口、映画音楽のようなドラマ感。*

**カテゴリC｜⚡️ 緊張感・スパイス（Tension & Spice）**
- 7sus4／aug／dim7／7(#9)／7(b9)／7(#5)／7(b13)
- *解決前の高揚、推進力、経過緊張、ジャズ/ブルースの"プロのスパイス"。*

**更新フロー**:
1. Quality Master.csvを編集
2. Chord Library Mastar.csvに新規クオリティを追加（既存は変更しない）
3. 静的ファイル再生成（csv_to_web_ts.mjs, csv_to_ios_swift.mjs）
4. ChordBuilder UIを更新（Free/Pro境界、コメント表示、サウンドパレットカテゴリ表示）

### 1.2 iボタン表記内容マスター

**ファイル**: `/Users/nh/App/OtoTheory/docs/content/i_button_master.md`

**役割**: アプリ内のiボタン（情報ボタン）で表示される表記内容の**単一の真実の源（SSOT）**として機能

**管理内容**:
- **Chord Library（コードライブラリ）**: インタラクティブカード説明、ヘルプ情報、コード表示、表示モード、ナビゲーション
- **Find Chords（コード検索）**: フレットボード、ダイアトニックテーブル、提案スケール、代理コードの説明
- **Chord Progression（コード進行）**: 進行エディタ、Build Progression、プリセット、セクション、パターン検出、終止形検出の説明
- **共通UI要素**: 二層Overlay、非ヘプタ規則、Capoの説明
- **保存・出力機能**: Sketch保存、出力機能の説明
- **サウンドパレット（v3.2新機能）**: カテゴリ別コード選択の説明

**日英対応**:
- 各説明文は日本語と英語の両方で記載
- 日英対応表（Quick Reference）で主要用語の対応を整理
- 実装時は必ずマスターの表記を参照

**更新フロー**:
1. マスターファイルを編集
2. Web版とiOS版の実装を更新
3. 一貫性を保つため、新しい表記が必要な場合は必ずマスターに追加してから実装

**実装対象**:
- **Web版**: `ototheory-web/src/app/chord-progression/page.tsx`（InfoDotコンポーネント）
- **iOS版**: `OtoTheory-iOS/OtoTheory/Views/BuildProgressionView.swift`（アラート表示）

---

## 2. 画面モジュール（共通哲学）

* **結果カード**：Key ≤3 候補＋% → **Diatonic** → **Fretboard（二層 Overlay）** → **Patterns / Cadence / 基礎代理**。操作は **「試聴→＋Add→即ループ」2タップ以内**。
* **二層 Overlay**：Scale 層＝輪郭/小/無地、Chord 層＝塗り/大/ラベル。**Reset＝Chordのみ**。**Degrees / Names** のみトグル。
* **非ヘプタ**：**表示は7音として見せる（RomanとCapoを出す）**・**中身は5/6音として扱う（欠落音は"土台"扱いで区別表示）**・**必ず注釈を自動表示（EN/JA）**。
* **Capo**：Diatonic 折りたたみ内に **Top2（Shaped 表記）**。**音は鳴らさない**。注記 *Shaped=fingered / Sounding=actual* を併記。
* **スケール名称の統一**：**Ionian → "Major Scale"**、**Aeolian → "Natural Minor"** と表記。ロック/ポップでは一般的な呼称を優先し、モード名は Dorian, Lydian 等の他モードのみ使用。

### 2.1 Chord Progression（メイン）

* **Lite（Web／iOS Free／Android）**

  * 12コード上限／**プリセットFree 20種**／自動ループ（4/4・BPM）／**Undoなし**／Sketch 3件（ローカル）。
  * 他画面からの`＋Add to progression`で即挿入＆自動再生。
  * **Advanced Chord制限** ✅ 完了（2025-10-14）：
    - **Altered Dominant**: 7b9, 7#9, 7#11, 7b13, 7alt → 👑 Pro専用
    - **13th系**: 13, M13, m13 → 👑 Pro専用
    - **Slash/On-Bass**: C/E等のベース音指定 → 👑 Pro専用
    - **視聴（Play）**: すべてのコードで可能（Free/Pro共通）
    - **Add to Progression**: Free版では上記Pro専用コードの追加がブロックされる
    - **👑 Proバッジ**: Pro専用コードのチップ右上に小さく表示（Free時のみ）
    - **11th警告**: maj/domで`11`選択時、セッション1回のみ警告表示

* **Pro（iOS）**

  * **プリセット50種（Free 20＋Pro 30）** ✅ 完了（2025-10-14）
    - 7カテゴリー（Pop, Rock, Jazz, Blues, Ballad, R&B/Soul, Acoustic）
    - Pro専用30種（Pop 10, Rock 5, Jazz 7, Blues 2, R&B/Soul 3, Acoustic 3）
    - チップスタイルUI、プリセット数表示、魅力的なPro誘導
  * **セクション編集**（Verse/Chorus/Bridge…）：**各セクションが独立したコード進行を持つ** ✅ 完了（2025-10-13）
    - Post-chorusセクションタイプを含む10種類のセクション
    - PlaybackOrderEditor（ドラッグ&ドロップ、繰り返し回数調整）
  * **MIDI出力**：SMF Type‑1、5トラック（**Guitar＋Bass＋Scale Guide×2＋Guide Tones**）✅ 完了
    - **オンコード対応**：スラッシュコード（C/E、Am7/G等）のベース音を反映
    - **仕様準拠**：`/on-chord-midi-specification.md`の仕様に完全準拠
    - **三段階安全弁**：ベースパターンの音楽的処理（コードトーン内↔5度、非コードトーン4つ打ち、半音/全音接続ウォーク）
    - **Voice Leading**：上声部のみの最適化、オンベース固定
    - **オクターブクランプ**：ギターとベースの音域衝突回避
  * **Sketch無制限（クラウド同期）** ✅ 完了（2025-10-14）／**IAP（¥490/月）**
    - CloudKit統合（iCloud自動バックアップ & デバイス間同期）
    - Pro: 無制限保存、Free: 3個制限（LRU削除）
    - 競合解決: Last-Write-Wins（lastModified基準）
    - UI: 同期状態表示、最終同期日時、エラー表示、Pro誘導
    - **要設定**: Xcode Capabilities（iCloud + CloudKit有効化）
  * **サウンドパレット（v3.2新機能）**：**"音の雰囲気"でコードを選ぶ**体験
    - **カテゴリカード**：✨キラキラ・浮遊感、🌃おしゃれ・都会的、⚡️緊張感・スパイス
    - **2タップ原則**：カテゴリカード→試聴→**＋Add**の**2タップ以内**
    - **感情語説明**：理論的説明ではなく、情景語で説明（例：**mM7＝「映画音楽のような、ミステリアスでドラマチック」**）
    - **Free制限**：チップ表示のみ（タップでPro誘導トースト）
  * **Fretboard & Diatonic & Roman（Chord Progression）** ✅ 完了（2025-10-13）：
    - Result下のToolsセクションに統合（Web版同様の構成）
    - **Fretboard**: Degrees/Names toggle、ダイアトニック選択時のコードトーンoverlay表示、全モード対応
    - **Diatonic Table**: タップで再生、長押しで進行に追加、全モード対応（11スケール）
    - **Roman Numerals**: 進行をローマ数字表記で表示（横スクロール対応）。Major=大文字、minor=小文字、dim=°、aug=+（例: I–vi–IV–V）
    - **Patterns**: 6種類の一般的なパターンを自動検出（Canon、Doo-wop、ii-V-I等）
    - **Cadence**: 4種類の終止形を自動検出（Perfect、Plagal、Deceptive、Half）

### 2.2 Find Chords（キー/スケール→使えるコード）

* Key/Scale 選択で **Diatonic→Fretboard** 即更新。**Scale Table（2–3件＋Why＋ⓘGlossary＋短いアルペジオ）**／**Chord Forms（Open/Barre＋試聴）**／**基礎代理（2–3件＋試聴/＋Add）** を搭載。
* **iOS（Phase E-1 ~ E-4A完了）**：
  - ✅ **Fretboard二層Overlay**（15フレット、Landscape Full-Screen、強制横向き）
  - ✅ **Diatonic Table**（Open + Capo Top2、長押しでProgression追加）
  - ✅ **Suggested Scales**（Chord quality判定、アルペジオ試聴）
  - ✅ **Substitute Chords**（和声理論ベース、長押しでProgression追加）
  - ✅ **Toast通知＋ハプティクフィードバック**
  - ⏳ **Advanced Chord Builder**（次回実装予定）

### 2.3 Resources（学習リソース）✅ 完了（2025-10-13）

* **3つのサブセクション構成**（Reference → Resources にリブランド）：
  - **Glossary**（用語解説）：音楽理論用語の定義と解説（日英対応）
  - **Music Theory**（理論解説）：ギタリスト向けの実践的理論ガイド（日英対応）
  - **Chord Library**（コードライブラリ）：インタラクティブなコードフォーム集

* **Chord Library 機能**：
  - **フォーム表示**：
    - **v3.2 現状（Static v0, iOS）**：Open / Root‑6 / Root‑5 / Root‑4 / Triad（3和音）
    - **表示順を固定**：Open → Root‑6 → Root‑5 → Root‑4 → Triad‑1 → Triad‑2
    - **今後拡張**：Triad転回形（第1・第2転回形）
    - **タイトル推定**：`shapeName`が未指定のフォームはUIで名称を推定（開放弦/バレー有無）
    - **My Forms保存**：Free=ローカル（最大30）／Pro=CloudKit同期（無制限）
    - **長押し導線**：Find Chords/Progressionのコードチップから「フォームを確認」でライブラリページへ
  - **横向きフレットボード**：標準的なギター配置（1弦が上、6弦が下）、横向き推奨UI
  - **3つの表示モード**：
    - Finger：指番号表示（1,2,3,4）
    - Roman：音程表示（R, III, V, ♭VII など）
    - Note：音名表示（C, E, G など）
  - **音再生機能**：
    - Play（▶）：ストラム（じゃーん）再生 — すべてのコードで利用可能（Pro制限なし）
    - Arp：アルペジオ再生 — すべてのコードで利用可能（Pro制限なし）
    - Web Audio API による高品質サウンド
  - **構成音表示**：コード名の下に「R · III · V | C · E · G」形式で表示
  - **25種類のコードクオリティ対応**：Major, minor, M7, 7, m7, sus4, sus2, add9, dim, 6, aug, m9, M9 (maj9), 6/9, add#11, m11, m7b5, mM7, m6, 7sus4, dim7, 7(#9), 7(b9), 7(#5), 7(b13)
  - **開放弦表示**：Roman/Noteモードでは開放弦にも音程/音名を表示
  - **Pro制限対応**（Chord Progression機能で使用時）：
    - **Pro専用クオリティ**（視聴もPro専用）:
      - ✨ キラキラ・浮遊感: M9 (maj9), 6, 6/9, add#11
      - 🌃 おしゃれ・都会的: m9, m11, m7b5, mM7, m6
      - ⚡️ 緊張感・スパイス: 7sus4, aug, dim7, 7(#9), 7(b9), 7(#5), 7(b13)
    - **視聴（Play）**: Free版ではPro専用クオリティの視聴もブロック
    - **Add to Progression**: Free版ではPro専用クオリティの追加がブロックされる
    - **👑 Proバッジ**: Pro専用クオリティのチップ右上に小さく表示（Free時のみ）
    - **コメント表示**: 各クオリティチップにhover/長押しでコメント表示（日英切り替え対応）
  - **11th警告機能**：maj/domコンテキストで`11`選択時、セッション1回のみ警告表示（「3rdと衝突」）

### 2.4 Melody/Solo Analyze（録音→Key/Scale）

* **v3.2 は UI 非露出（Flag OFF）**。Line‑in 前提／停止後サーバ解析。将来解禁時も **Key候補≤3＋Conf%** と**低信頼時の再録ガイド**を必須。

---

## 3. 保存（Sketch）

* 保存単位は **Sketch（ソングスケッチ）**。
* **保存内容**：
  - **Free**: Key＋Scale＋進行（≤12）＋Fretboard表示状態（Degrees/Names＋Overlay）
  - **Pro**: 上記＋**セクション進行**（SectionDefinitions＋PlaybackOrder）
* **Free**：ローカル 3 件（LRU 上書き／自動保存 3 秒）。**Pro**：無制限（クラウド同期）。復元時も **非ヘプタ規則／Capo注記** を厳守。

---

## 4. 出力・共有

* **PNG（Free）**：**白背景固定（v3.2）**・視認性最適化。`export_png` は保存成否に関わらず **1回のみ**発火。
* **テキスト（Free）**：Key/Scale／Diatonic／進行（Roman/実音）／Capo注記のコピー。
* **MIDI（iOS Pro）**：**Chord Track＋Section Markers＋Guide Tones** を SMF Type‑1 で書き出し。
  - **オンコード対応**：スラッシュコード（C/E、Am7/G等）のベース音を反映
  - **仕様準拠**：`/on-chord-midi-specification.md`の仕様に完全準拠

---

## 5. Free / Pro / Android 境界

* **Free（Web/iOS）**：基本クオリティ（Major, minor, 7, maj7, m7, sus4, sus2, add9, dim）／Find Chords 拡張／二層 Overlay／Capo Top2／Progression Lite（12上限・**プリセットFree 20種**・自動ループ）／Sketch 3 件／PNG・テキスト出力。
* **Pro（iOS）**：Pro専用クオリティ15種（M9, 6, 6/9, add#11, m9, m11, m7b5, mM7, m6, 7sus4, aug, dim7, 7(#9), 7(b9), 7(#5), 7(b13)）／**プリセット50種（Free 20＋Pro 30）**／**セクション編集**／**MIDI 出力**／**Sketch無制限**／**サウンドパレット**／将来の高度機能。
* **Android（計画）**：**Free機能のみ**（Pro機能なし）、**広告モデル**（AdSense/AdMob中心）、iOS Pro誘導。

---

## 6. Telemetry（最小セット）

* **共通**：`page_view, key_pick, scale_pick, diatonic_pick, overlay_shown, fb_toggle, overlay_reset, play_note, play_chord, export_png, instrument_change`（**1操作=1発火**）※`overlay_shown`は**初回ユーザー操作時のみ**。`page_view` ラベルは `chord_progression / find_chords / melody_solo_analyze`（旧ラベル互換は90日維持）。
* **進行**：`progression_play, preset_inserted, toast_shown(kind)`（`limit_warn / limit_block / low_conf`。**undoは廃止**）、**`cta_appstore_click{place}`**（header/sticky/limit_toast/png_toast/qr）。
* **保存**：`save_project, open_project, project_rename, project_delete, project_duplicate, project_limit_warn, project_limit_block`。
* **録音（将来露出）**：`audio_record_start/stop, audio_analyze_ok, audio_analyze_conf(engine,conf)`（Flag OFFのまま維持）。
* **広告（Web版のみ）**：`ad_shown{page}`（広告表示時、ページごとに記録）✅ 完了（2025-10-13）
* **サウンドパレット（v3.2新機能）**：`sound_palette_category_view, sound_palette_code_preview, sound_palette_code_add`

---

## 7. 受け入れ基準（DoD）

1. **Find Chords**：Key/Scale 選択のみで Result 更新。Open 行タップで和音再生＆Chord 層強調。Reset で Scale は保持。
2. **Capo**：折りたたみ内に **Top2（Shaped）**＋注記。音は鳴らさない。
3. **Progression**：**ドラッグ並べ替え／プリセット→自動ループ**が動作（**Undoなし**）。
4. **提案の追加**：Patterns / Cadence / 基礎代理 は **試聴→＋Add** が 2 タップ以内、直後に自動再生。
5. **Sketch**：Key/Scale・Capo（Shaped）・進行・Overlay 表示を完全復元。Free=3 件、Pro=無制限。
6. **出力**：Free＝PNG（白固定）/テキスト、Pro＝MIDI（Chord+Markers+Guide）。`export_png` は必ず 1 回。
7. **MIDI実装**：オンコード（スラッシュコード）の実装は`/on-chord-midi-specification.md`の仕様に完全準拠。
8. **録音（将来 Flag ON 時）**：Line‑inのみ開始可。停止→Key 候補≤3＋Conf% 表示、低信頼は Advice。デフォルトは UI 非露出。
9. **サウンドパレット（v3.2新機能）**：カテゴリカード→試聴→**＋Add**が2タップ以内、感情語説明表示、Free制限時はPro誘導トースト。

---

## 8. ロードマップ（期日なし方式）

* **M3.5 Web Lite GA**：Analyze撤去・6面CTA・`cta_appstore_click` 追加。
* **M4 iOS v1**：Free＝M3パリティ／Pro＝**セクション編集・MIDI（Chord+Markers+Guide）・無制限保存・IAP・サウンドパレット**。
* **M4.1+（任意）**：Split Bar／Groove（簡易ドラム）／ミニベース（パターンのみ）／**MIDI多トラック拡張**。**ミニDAW化は回避**。
* **M5 Polish**：A11y・Telemetry最終化・PNG反転の将来再検討。
* **M6 Android版（計画）**：**Pro機能なし**、**広告モデル**、iOS Pro誘導。

---

## 9. Web版収益化（広告）✅ 完了（2025-10-13）

### 9.1 Google AdSense統合

**目的**：Web版（Free）の収益化施策として、Google AdSenseを統合

**実装内容**：
- **パブリッシャーID**: `ca-pub-9662479821167655`
- **配置箇所**（4ページ）：
  - ホームページ（`/`）：ページ下部に横長フォーマット
  - Chord Progression（`/chord-progression`）：Toolsセクション下
  - Find Chords（`/find-chords`）：メインコンテンツ下
  - Chord Library（`/resources/chord-library`）：フッター下（ダークテーマ対応スタイリング）

**Pro版対応**：
- Pro版ユーザーには広告を非表示（`usePro()`フックで判定）
- 将来的にiOS Pro購入者がWeb版でも広告非表示となる連携を想定

**技術実装**：
- Next.js `Script`コンポーネントでAdSenseスクリプト読み込み（`afterInteractive`）
- `AdSlot.client.tsx`コンポーネントで広告表示を一元管理
- CLS（Cumulative Layout Shift）対策：`minHeight: 110px`でレイアウトシフトを防止
- ads.txt設置：`google.com, pub-9662479821167655, DIRECT, f08c47fec0942fa0`
- 認証メタタグ：`<meta name="google-adsense-account" content="ca-pub-9662479821167655">`

**Telemetry**：
- `ad_shown{page}` イベント（ページごとの広告表示を記録）
- ページ値：`home / chord_progression / find_chords / chord_library`

**ドキュメント**：
- 詳細な設定手順は `ototheory-web/AD_SETUP_GUIDE.md` に記載
- トラブルシューティング、審査手順も含む

---

## 10. Android版計画（v3.2新機能）

### 10.1 戦略的ポジション

* **ターゲット**：音楽理論初心者・学習重視ユーザー
* **競合差別化**：Pro機能なし、シンプルな学習体験に特化
* **収益モデル**：広告中心＋iOS Proへの送客

### 10.2 機能範囲

**搭載機能**
* 基本コード進行（12コード上限）
* Find Chords（Scale Table、基礎代理）
* プリセット20種（Free版と同等）
* Sketch保存3件（ローカル）
* PNG出力（白背景固定）

**非搭載機能**
* セクション編集
* MIDI出力
* サウンドパレット（Pro専用コード）
* クラウド同期
* プリセット拡張（Pro30種）

### 10.3 広告戦略

**AdSense/AdMob統合**
* バナー広告（ページ下部、非侵入的）
* インタースティシャル（アプリ起動時、適度な頻度）
* リワード広告（追加機能アンロック、オプション）

**UX配慮**
* CLS（Cumulative Layout Shift）回避
* 高速描画、プレースホルダー使用
* 表示点数上限設定（ページ品質維持）
* 広告ブロッカー対応

### 10.4 iOS Pro誘導

* アプリ内CTA（「より高度な機能はiOS Proで」）
* 広告表示時のPro機能紹介
* 制限到達時のiOS Pro案内

---

## 11. リスク / 決めごと

* **ミニDAW化の回避**：パターンの範囲に限定、音色作り込まず、成果物は **MIDI** に集中。
* **録音の扱い**：**Flag OFF 維持**。合格指標（例：Top‑1≥85% 等）に達するまで解禁しない。
* **表記整合**：**非ヘプタの7音表示（RomanとCapo表示、欠落音は点線○、Bluesのb5は◇）**／Capo注記／二層Overlayのルールを全画面で統一。
* **サウンドパレット**：理論的説明ではなく、**感情語・情景語**で説明し、「響きの雰囲気」で選べる体験を重視。
* **Android広告品質**：CLS回避、UX配慮、適切な表示頻度でページ品質を維持。

---

## 12. 運用メモ（リポジトリ／PR手順）

* **配置**：`docs/SSOT/OtoTheory_v3.2_SSOT.md`（本書）。v3.1は `docs/SSOT/` に保持し「参考資料」と明記。
* **PR テンプレ**：SSOT欄は**要更新**を選択。**Roadmap / Implementation SSOT** も同時に差分PR（サウンドパレット／Android計画／日英同時リリースを揃える）。
* **計測タグ**：Webの送客強化に伴い **`cta_appstore_click{place}`** を新設。既存イベント（`export_png / progression_play / preset_inserted / instrument_change / toast_shown` など）と統合して可視化。サウンドパレット用イベントを追加。

---

### 備考（非エンジニア向け）

* **使い方はシンプル**：①Key/Scale→②Diatonic＋Fretboard（二層）→③提案を**試聴→＋Add→即ループ**→④良ければ**Sketch保存**。
* **迷ったらこのSSOT**：**Capo Top2（Shapedのみ）／非ヘプタの7音表示（RomanとCapo表示、欠落音は点線○）／Reset＝Chordのみ** を守れば体験は自然に揃います。
* **サウンドパレット**：**"音の雰囲気"でコードを選ぶ**体験。理論ではなく、**感情語・情景語**で説明し、直感的に選べます。

---

## 13. サイト/ポリシー（v3.2）

**目的**：App Store審査通過率の向上と利用者の信頼担保（法務・サポートの可視化）

**実装済みURL**（JP/EN）：
- `/privacy` - プライバシーポリシー
- `/terms` - 利用規約
- `/support` - サポート・お問い合わせ
- `/faq` - よくある質問
- `/about` - OtoTheoryについて
- `/pricing` - 料金プラン

**コアツール**：
- `/chord-progression` - コード進行ビルダー（旧 /find-key 統合）
- `/find-chords` - コード検索ツール
- `/resources` - リソースハブ
  - `/resources/chord-library` - コードライブラリ
  - `/resources/music-theory` - 音楽理論ガイド
  - `/resources/glossary` - 用語集
- `/getting-started` - 使い方ガイド

**非搭載機能**：
- ~~`/analyze`~~ - 録音機能（Flag OFF、UI非露出）

**導線**：
- フッター常設リンク（全画面共通）
- App内「設定」＞「プライバシー/利用規約」へ1タップ遷移
- Web Lite本体から6面CTA（ヘッダー／下部スティッキー／到達トースト／保存制限／PNG後／フッターQR）で App Store誘導

**Free/Pro/Androidの境界**（従来通り）：
- Free=PNG/テキスト、Pro=iOSのMIDI（Chord+Markers+Guide）、Android=Free機能のみ
- 録音UIはβ/Flag OFF（UI非露出）

**計測**：
- Web Lite（M3完了機能）からApp Storeへ6面CTAで誘導
- `cta_appstore_click{place}` を追加（Web→iOSファネル可視化）
- `export_png` は成功/失敗に関わらず1回のみ
- サウンドパレット用イベント（`sound_palette_category_view`等）を追加

**KPI**：
- 公開14日内の審査一次指摘0件
- Support返信SLA=2営業日以内

---

## 14. 日本語UI定義（v3.2 JP terminology alignment）

本節は日本市場向けUI統一方針に基づく用語の最終定義です。英語表記は現行維持（My Sketches, My Chords, Preset Progressions）。iOS / Web 双方で統一し、以下の画面で同一表記を用います（トップメニュー／コード進行エディタ／コードライブラリ）。

- My進行（EN: My Sketches）
  - 説明: 自分で作ったコード進行を保存・呼び出せる機能。
  - プラン: Free=ローカル最大3件、Pro=クラウド同期＆無制限保存。
  - 表示箇所: トップメニュー導線（iOSはタブ）、コード進行エディタ内の呼び出しUI、コードライブラリからの保存導線。

- Myコード（EN: My Chords）
  - 説明: お気に入りのコードフォームを保存できる機能。
  - 備考: コード進行作成画面からも呼び出し可能。Chord Libraryとの連携導線を持つ。

- プリセット進行（EN: Preset Progressions）
  - 説明: あらかじめ用意した進行テンプレート群。カテゴリ別（Pop, Rock, Jazz, など）。

- サウンドパレット（EN: Sound Palette）
  - 説明: "音の雰囲気"でコードを選ぶ機能。カテゴリ別に分類されたコードクオリティ。
  - プラン: Pro機能。Free版ではチップ表示のみ、タップでPro誘導。

注記: 本節はSSOT差分記録の一環として追加（変更履歴コメント: v3.2 JP terminology alignment）。

### 日英翻訳マスター（参照）

**重要**: すべての日英翻訳は以下のマスターファイルに従うこと。

管理ファイル:
- docs/SSOT/EN_JA_language_SSOT.md（人間可読）
- docs/SSOT/EN_JA_language_SSOT.csv（機械可読: area,key,en,ja,notes）
- docs/content/i_button_master.md（iボタン表記内容専用）

**翻訳ルール**:
- 実装時は必ずマスターファイルの表記を参照
- 新しい翻訳が必要な場合は、マスターファイルに追加してから実装
- iボタンの表記内容は`i_button_master.md`を最優先とする
- 本編と矛盾時は本SSOTを最優先とし、マスター側を更新すること

**クオリティコメントセクション名**:
- コードクオリティのコメントセクション名は言語相対表（EN_JA_language_SSOT.md）に定義された翻訳ルールに従う
- 日本語: 雰囲気 / 利用シーン / 使ってみよう / 理論
- 英語: Vibe / Usage / Try / Theory

### 度数表記のルール（Interval / Degree Notation Rules）

【1】コード進行での度数表記（Chord Progression / Roman Numerals）
目的：度数とコードのクオリティを同時に表現

表記ルール：
- メジャーコード → 大文字（I, IV, V）
- マイナーコード → 小文字（ii, iii, vi）
- ディミニッシュコード → 小文字+°（vii°）
- オーギュメントコード → 大文字+augまたは+（III+）

例（Cメジャーのダイアトニック）: I (C), ii (Dm), iii (Em), IV (F), V (G), vi (Am), vii° (Bdim)

【2】スケール/音程での度数表記（Scale Intervals）
目的：各音の音程の性質を明確に表現

表記ルール：
- Perfect（完全音程） → 大文字P（P1, P4, P5, P8）
- Major（長音程） → 大文字M（M2, M3, M6, M7）
- minor（短音程） → 小文字m（m2, m3, m6, m7）
- Augmented（増音程） → 大文字A（A4, A5 など）
- diminished（減音程） → 小文字d（d5, d7 など）

例：
- メジャースケール: 1 - M2 - M3 - P4 - P5 - M6 - M7
- ナチュラルマイナー: 1 - M2 - m3 - P4 - P5 - m6 - m7
- ドリアン: 1 - M2 - m3 - P4 - P5 - M6 - m7

【3】実装上の注意点
- コード進行表記：大文字小文字の区別でコードタイプを判別
- スケール表記：P/M/m/A/d の接頭辞で音程の質を判別
- 両方とも数字は度数（1-7または1-8）を表す

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025/10/20 | 3.2 | オンコード（スラッシュコード）MIDI実装仕様書作成、README・SSOTに必須参照記載 |
| 2025/10/20 | 3.2 | コードクオリティコメント表示機能実装（電球マークタップ、構造化コメント、言語自動切替） |
| 2025/01/19 | 3.2 | v3.1をベースに、サウンドパレット（カテゴリ）、Android版計画、日英同時リリース計画を追加。v3.2を正として採用。 |
| 2025/01/16 | 3.1 | Web Lite GA、iOS収益軸、Undo非搭載、PNG白背景固定 |
