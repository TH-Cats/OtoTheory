# OtoTheory v3.1 — System Architecture（Web Lite & iOS収益軸）

*最終更新: 2025/10/05*

> **目的**：v3.0 アーキテクチャを、**Web Liteを即時GA**・**iOSを収益主軸**とする方針へ整合。**Undoは非搭載**、**PNGは白背景固定**、**録音UIはFlag OFF** を前提に、クライアント／サービス／データ／運用を再定義する。

---

## 0. 本版の主要差分（v3.0 → v3.1）

* **WebはM3完了の Lite をGA**：**Chord Progression中心**・**結果カード→Diatonic→Fretboard（二層）→Patterns/Cadence/基礎代理** の2タップ追加→即ループ体験をコアとして公開。**Capo提案はTop2（Shaped／無音）**、**非ヘプタはRoman非表示（Pent/Blues例外）**を厳守。
* **iOSは収益主軸**：**Pro＝MIDI出力（Chord Track＋Section Markers＋Guide Tones）／セクション編集／Sketch無制限**、FreeはWebと同等のLite機能。
* **Undoは非搭載**（キャンセル確定。個別削除＆並べ替えで代替）。Telemetry/DoDから`undo`を削除。
* **PNGは白背景固定**（v3.1の運用）。`export_png`は**保存成否に関わらず1回のみ**。
* **Melody/Solo Analyze（録音UI）はFlag OFFのまま非露出**。サーバ側`/api/analyze`は将来解禁用の設計を維持。

---

## 1. 全体像（論理アーキテクチャ）

```
┌───────────────────────────────────────────┐
│                   Clients (UI)                           │
│  ┌───────────────────────────┐   ┌────────────────────┐ │
│  │ Web Lite (M3 GA)          │   │ iOS App            │ │
│  │ - Progression Lite        │   │ - Free: Lite同等   │ │
│  │ - Find Chords (ScaleTbl/  │   │ - Pro: Section/MIDI│ │
│  │   Forms/Substitute)       │   │        /Cloud Sketch│ │
│  │ - Sketch(3 local)         │   │ - Paywall/IAP      │ │
│  │ - PNG/Text Export         │   │                    │ │
│  └───────────────▲───────────┘   └────────────▲───────┘ │
│                  │Telemetry + API                         │
└───────────────┬──┴───────────────────────────────┬────────┘
                │                                    │
        ┌───────▼────────┐                    ┌──────▼────────┐
        │  API Layer      │                    │ Telemetry      │
        │  (HTTPS/JSON)   │                    │ Collector      │
        ├─────────────────┤                    ├────────────────┤
        │ /sketch (Pro用) │                    │ event sink     │
        │ /midi (iOS Pro) │                    │ (page_view/… ) │
        │ /analyze (Flag) │                    └────────────────┘
        └───┬───────────┬─┘
            │           │
   ┌────────▼───┐  ┌────▼────────┐
   │ Cloud Store │  │ Analyze Svc │  ← *Flag OFF（将来ON）*
   │ (Sketch/…)  │  │ (server-run │
   └─────────────┘  │  /api/analyze)
                    └─────────────┘
```

* **UI哲学**（両クライアント共通）：**結果カード → Diatonic → Fretboard（二層） → 提案群**、**「試聴→＋Add→即ループ」**の2タップ原則。
* **出力境界**：Free＝**PNG/テキスト**、Pro（iOS）＝**MIDI（Chord＋Markers＋Guide）**。
* **録音**：**UIは非露出**（Flag OFF）。サーバ解析は**Line‑in前提**の`/api/analyze`を温存。

---

## 2. クライアント構成

### 2.1 Web（Lite / GA）

* **モジュール**：

  * **Chord Progression Lite**（12上限・プリセット20・自動ループ）
  * **Find Chords**（Scale Table／Chord Forms／Substitute）
  * **ToneOverlay（二層）**：Scale＝輪郭/小、Chord＝塗り/大。**Reset＝Chordのみ**。
  * **Capo提案**：**Top2（Shaped）**・**無音**・注記併記。
  * **Sketch（3件・ローカル）**／**PNG/テキスト出力（白背景固定・`export_png`は1回）**。
* **音**：単音 Attack≈3–5ms／Release≈80–150ms、最大6声（voice‑stealing）。和音は**同時 or 軽ストラム（≈10–20ms）**。初回はAudio Unlocker。
* **Telemetry**：`page_view / progression_play / preset_inserted / play_note / play_chord / export_png / instrument_change / toast_shown(kind)` ＋ **`cta_appstore_click{place}`**（送客計測）。
* **非ヘプタ**：Roman非表示（**Pent/Bluesのみ例外**）、Capo行は無効。

### 2.2 iOS（Free / Pro）

* **Free**：Web Lite と同等の体験（**Undoなし**、Sketch 3件、PNG/テキスト）。
* **Pro**：

  * **セクション編集**（Verse/Chorus/Bridge…） → 再生/ループと連動。
  * **MIDI出力**：**SMF Type‑1**、**Chord Track＋Section Markers＋Guide Tones**。
  * **Sketch無制限（クラウド）**、**IAP（¥490/月）**。
* **録音UI**：非露出（Flag OFF 維持）。

---

## 3. サービス構成（API / バックエンド）

* **API Layer（HTTPS/JSON）**

  * `/sketch/*`：Proのクラウド保存・読み出し。
  * `/midi/export`：iOS Pro のMIDI生成（端末内生成でもよい。メタとして**Markers/Key**連携）。
  * `/analyze`：将来解禁用の**サーバ実行**（Line‑in前提・**Conf%**と再録Adviceを返す）。**今はFlag OFF**。
* **Cloud Store**：Sketchメタ（Key/Scale／Capo（Shaped）／進行／Fretboard表示状態）を保存。**Freeはローカル3件**、**Proはクラウド無制限**。
* **Telemetry Collector**：イベントをバッチ/ストリームで集計（*event schema はSSOTのイベント名を正*）。

> **注**：PNGは**クライアント生成**を基本（白背景固定）。`export_png`の**1操作=1発火**はクライアントで担保。

---

## 4. データモデル（概念）

* **Sketch**（概念）

  * `key`（tonic, scaleId）／`capo`（capoFret + **Shaped注記**）／`progression`（Lite上限12）／`fretboardView`（Degrees/Names, guide）／`meta`（id/name/createdAt/updatedAt/schema/appVersion）。
  * 復元時は**非ヘプタ規則**と**Capo注記**を厳守。
* **MIDI（iOS Pro）**

  * **Chord Track**（Triad/7th）、**Guide Tones**（3rd/7th 等）、**Section Markers**（Verse/Chorus…）。**SMF Type‑1**で書き出し。
* **Analyze（将来）**

  * 入力：録音blob/PCP12、出力：`keyCandidates (≤3, conf)`＋`advice?`。**Line‑in前提**。

---

## 5. Feature Flags & 環境

* `recording.ui.enabled` **= false**（既定）。将来ON時のみメニュー露出。
* `export.png.themeAutoInvert` **= false**（v3.1。白背景固定）
* `undo.enabled` **= false**（v3.1）
* `cta.appstore.enabled` **= true**（6面CTAをWebに常設）

---

## 6. セキュリティ / プライバシー / ライセンス

* **録音解析**：**サーバ実行**を前提に設計（AGPL等の懸念をクライアント配布から切り離す）。**UIはFlag OFF**のまま。
* **最小収集**：Telemetryは**最小限の操作イベント**のみ（個人特定情報は収集しない方針）。イベント名はSSOT準拠。
* **出力物**：PNG/MIDIは**ユーザー生成物**。MIDIは**Markers/Guide**を含むがオーディオデータは持たない。
* **サイト/ポリシー**：App Store審査対応のため以下のページを公開（JP/EN）
  - `/privacy`, `/terms`, `/subscription`, `/support`, `/account-deletion`, `/security`, `/accessibility`, `/transparency`, `/licenses`
  - フッター常設リンク＋App内「設定」から1タップ遷移
  - Support返信SLA=2営業日以内、公開14日内の審査一次指摘0件を目標

---

## 7. 運用 / デプロイ指針（要約）

* **Web**：静的配信＋CDN（TTFIを重視）。PNGはクライアント生成。
* **iOS**：App Store 配信／**IAP（¥490/月）**／Sign in with Apple（Pro同期用）。
* **監視**：クライアント側のイベント発火（`progression_play / export_png / cta_appstore_click / paywall_view / purchase_success` など）をダッシュボード化。

---

## 8. テレメトリ（イベント表｜抜粋）

| カテゴリ          | イベント                                                                  | 備考                                                |                         |
| ------------- | --------------------------------------------------------------------- | ------------------------------------------------- | ----------------------- |
| Navigation    | `page_view`                                                           | `chord_progression / find_chords` 他。旧ラベル互換は90日維持。 |                         |
| Find Chords   | `key_pick / scale_pick / diatonic_pick / play_chord`                  | Why表示/アルペジオなど拡張あり。                                |                         |
| Progression   | `progression_play / preset_inserted / play_chord / instrument_change` | Undoは廃止。                                          |                         |
| Limits        | `toast_shown(kind=limit_warn                                          | limit_block)`                                     | 9–12の段階濃色や13ブロックでPro誘導。 |
| Export        | `export_png`                                                          | **成功/失敗に関わらず1回**。                                 |                         |
| Web→iOS       | `cta_appstore_click{place}`                                           | header / sticky / limit_toast / png_toast / qr    |                         |
| Purchase(iOS) | `paywall_view / purchase_success`                                     | Pro導線の健全性を可視化。                                    |                         |

---

## 9. 受け入れ基準（アーキテクチャ観点）

* Web：**プリセット→即ループ→PNG出力**が**3クリック以内**で成立。`export_png` は1発火。
* iOS Pro：**MIDI（Chord＋Markers＋Guide）**がDAWで再現／セクション編集がMarkerに反映。
* 共通：**Capo Top2（Shaped／無音）**、**非ヘプタRoman非表示（Pent/Blues例外）**、**二層Overlay＆Reset=Chordのみ**を全画面で一貫。

---

### 付記（非エンジニア向け）

* **作る流れは同じ**：①Key/Scale → ②Diatonic＋Fretboard（二層） → ③**提案を試聴→＋Add** → ④即ループ。気に入ったら **Sketch保存**・**PNG**・（iOS Proなら）**MIDI**。
* **録音は後日**：いまはFlag OFFのまま。まずは**"理論×即制作×MIDIで仕上げ"**の体験を磨く。

---

