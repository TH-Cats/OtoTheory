{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/AdSlot.client.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { track } from \"@/lib/telemetry\";\nimport { usePro } from \"@/components/ProProvider\";\n\ninterface AdSlotProps {\n  page: string;\n  slot?: string; // AdSense広告スロットID（オプション）\n  format?: \"auto\" | \"rectangle\" | \"horizontal\" | \"vertical\";\n  style?: React.CSSProperties;\n}\n\nexport default function AdSlot({ \n  page, \n  slot = \"XXXXXXXXXX\", // デフォルトの広告スロットID\n  format = \"auto\",\n  style = {}\n}: AdSlotProps) {\n  const { isPro } = usePro();\n  const [mounted, setMounted] = useState(false);\n  const [adLoaded, setAdLoaded] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  useEffect(() => {\n    if (!mounted || isPro) return;\n\n    // AdSenseの広告をロード\n    try {\n      // @ts-ignore\n      if (window.adsbygoogle && !adLoaded) {\n        // @ts-ignore\n        (window.adsbygoogle = window.adsbygoogle || []).push({});\n        setAdLoaded(true);\n        track(\"ad_shown\", { page });\n      }\n    } catch (error) {\n      console.error(\"AdSense load error:\", error);\n    }\n  }, [mounted, isPro, page, adLoaded]);\n\n  if (isPro) {\n    return null;\n  }\n\n  return (\n    <div \n      style={{ minHeight: 110, ...style }} \n      aria-label=\"Advertisement\"\n      className=\"ad-container\"\n    >\n      {mounted ? (\n        <ins\n          className=\"adsbygoogle\"\n          style={{ display: \"block\", ...style }}\n          data-ad-client=\"ca-pub-9662479821167655\"\n          data-ad-slot={slot}\n          data-ad-format={format}\n          data-full-width-responsive=\"true\"\n        />\n      ) : null}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;;;AAJA;;;;AAae,SAAS,OAAO,KAKjB;QALiB,EAC7B,IAAI,EACJ,OAAO,YAAY,EACnB,SAAS,MAAM,EACf,QAAQ,CAAC,CAAC,EACE,GALiB;;IAM7B,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,8IAAM;IACxB,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,yKAAQ,EAAC;IACvC,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,yKAAQ,EAAC;IAEzC,IAAA,0KAAS;4BAAC;YACR,WAAW;QACb;2BAAG,EAAE;IAEL,IAAA,0KAAS;4BAAC;YACR,IAAI,CAAC,WAAW,OAAO;YAEvB,iBAAiB;YACjB,IAAI;gBACF,aAAa;gBACb,IAAI,OAAO,WAAW,IAAI,CAAC,UAAU;oBACnC,aAAa;oBACb,CAAC,OAAO,WAAW,GAAG,OAAO,WAAW,IAAI,EAAE,EAAE,IAAI,CAAC,CAAC;oBACtD,YAAY;oBACZ,IAAA,mIAAK,EAAC,YAAY;wBAAE;oBAAK;gBAC3B;YACF,EAAE,OAAO,OAAO;gBACd,QAAQ,KAAK,CAAC,uBAAuB;YACvC;QACF;2BAAG;QAAC;QAAS;QAAO;QAAM;KAAS;IAEnC,IAAI,OAAO;QACT,OAAO;IACT;IAEA,qBACE,6LAAC;QACC,OAAO;YAAE,WAAW;YAAK,GAAG,KAAK;QAAC;QAClC,cAAW;QACX,WAAU;kBAET,wBACC,6LAAC;YACC,WAAU;YACV,OAAO;gBAAE,SAAS;gBAAS,GAAG,KAAK;YAAC;YACpC,kBAAe;YACf,gBAAc;YACd,kBAAgB;YAChB,8BAA2B;;;;;mBAE3B;;;;;;AAGV;GArDwB;;QAMJ,8IAAM;;;KANF","debugId":null}},
    {"offset": {"line": 99, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/hooks/useRovingTabs.ts"],"sourcesContent":["\"use client\";\n\nimport { useEffect } from \"react\";\n\ntype Options = {\n  itemSelector?: string;\n  orientation?: \"horizontal\" | \"vertical\" | \"both\";\n  includeHomeEnd?: boolean;\n};\n\nexport function useRovingTabs(root: React.RefObject<HTMLElement | null>, options: Options = {}) {\n  const {\n    itemSelector = '[role=\"tab\"],[data-roving=\"item\"]',\n    orientation = \"horizontal\",\n    includeHomeEnd = true,\n  } = options;\n\n  useEffect(() => {\n    const el = root.current;\n    if (!el) return;\n\n    const getItems = () => Array.from(el.querySelectorAll<HTMLElement>(itemSelector)).filter((node) => !node.hasAttribute(\"disabled\"));\n    const setTabIndex = (items: HTMLElement[], idx: number) => {\n      items.forEach((node, i) => (node.tabIndex = i === idx ? 0 : -1));\n    };\n\n    const applyInitial = () => {\n      const items = getItems();\n      if (!items.length) return;\n      let index = items.findIndex((node) => node.getAttribute(\"aria-selected\") === \"true\" || node.tabIndex === 0 || node === document.activeElement);\n      if (index < 0) index = 0;\n      setTabIndex(items, index);\n    };\n\n    applyInitial();\n\n    const onKey = (event: KeyboardEvent) => {\n      const items = getItems();\n      if (!items.length) return;\n      const currentIndex = items.indexOf(document.activeElement as HTMLElement);\n      if (currentIndex < 0) return;\n\n      const { key } = event;\n      const horizontal = orientation === \"horizontal\" || orientation === \"both\";\n      const vertical = orientation === \"vertical\" || orientation === \"both\";\n      let nextIndex = -1;\n\n      if (horizontal && key === \"ArrowRight\") nextIndex = (currentIndex + 1) % items.length;\n      if (horizontal && key === \"ArrowLeft\") nextIndex = (currentIndex - 1 + items.length) % items.length;\n      if (vertical && key === \"ArrowDown\") nextIndex = (currentIndex + 1) % items.length;\n      if (vertical && key === \"ArrowUp\") nextIndex = (currentIndex - 1 + items.length) % items.length;\n\n      if (nextIndex >= 0) {\n        event.preventDefault();\n        setTabIndex(items, nextIndex);\n        items[nextIndex].focus({ preventScroll: true });\n        return;\n      }\n\n      if (includeHomeEnd && key === \"Home\") {\n        event.preventDefault();\n        setTabIndex(items, 0);\n        items[0].focus({ preventScroll: true });\n        return;\n      }\n\n      if (includeHomeEnd && key === \"End\") {\n        event.preventDefault();\n        const last = items.length - 1;\n        setTabIndex(items, last);\n        items[last].focus({ preventScroll: true });\n      }\n    };\n\n    el.addEventListener(\"keydown\", onKey);\n    return () => {\n      el.removeEventListener(\"keydown\", onKey);\n    };\n  }, [root, itemSelector, orientation, includeHomeEnd]);\n}\n\n\n\n\n\n"],"names":[],"mappings":";;;;AAEA;;AAFA;;AAUO,SAAS,cAAc,IAAyC;QAAE,UAAA,iEAAmB,CAAC;;IAC3F,MAAM,EACJ,eAAe,mCAAmC,EAClD,cAAc,YAAY,EAC1B,iBAAiB,IAAI,EACtB,GAAG;IAEJ,IAAA,0KAAS;mCAAC;YACR,MAAM,KAAK,KAAK,OAAO;YACvB,IAAI,CAAC,IAAI;YAET,MAAM;oDAAW,IAAM,MAAM,IAAI,CAAC,GAAG,gBAAgB,CAAc,eAAe,MAAM;4DAAC,CAAC,OAAS,CAAC,KAAK,YAAY,CAAC;;;YACtH,MAAM;uDAAc,CAAC,OAAsB;oBACzC,MAAM,OAAO;+DAAC,CAAC,MAAM,IAAO,KAAK,QAAQ,GAAG,MAAM,MAAM,IAAI,CAAC;;gBAC/D;;YAEA,MAAM;wDAAe;oBACnB,MAAM,QAAQ;oBACd,IAAI,CAAC,MAAM,MAAM,EAAE;oBACnB,IAAI,QAAQ,MAAM,SAAS;sEAAC,CAAC,OAAS,KAAK,YAAY,CAAC,qBAAqB,UAAU,KAAK,QAAQ,KAAK,KAAK,SAAS,SAAS,aAAa;;oBAC7I,IAAI,QAAQ,GAAG,QAAQ;oBACvB,YAAY,OAAO;gBACrB;;YAEA;YAEA,MAAM;iDAAQ,CAAC;oBACb,MAAM,QAAQ;oBACd,IAAI,CAAC,MAAM,MAAM,EAAE;oBACnB,MAAM,eAAe,MAAM,OAAO,CAAC,SAAS,aAAa;oBACzD,IAAI,eAAe,GAAG;oBAEtB,MAAM,EAAE,GAAG,EAAE,GAAG;oBAChB,MAAM,aAAa,gBAAgB,gBAAgB,gBAAgB;oBACnE,MAAM,WAAW,gBAAgB,cAAc,gBAAgB;oBAC/D,IAAI,YAAY,CAAC;oBAEjB,IAAI,cAAc,QAAQ,cAAc,YAAY,CAAC,eAAe,CAAC,IAAI,MAAM,MAAM;oBACrF,IAAI,cAAc,QAAQ,aAAa,YAAY,CAAC,eAAe,IAAI,MAAM,MAAM,IAAI,MAAM,MAAM;oBACnG,IAAI,YAAY,QAAQ,aAAa,YAAY,CAAC,eAAe,CAAC,IAAI,MAAM,MAAM;oBAClF,IAAI,YAAY,QAAQ,WAAW,YAAY,CAAC,eAAe,IAAI,MAAM,MAAM,IAAI,MAAM,MAAM;oBAE/F,IAAI,aAAa,GAAG;wBAClB,MAAM,cAAc;wBACpB,YAAY,OAAO;wBACnB,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC;4BAAE,eAAe;wBAAK;wBAC7C;oBACF;oBAEA,IAAI,kBAAkB,QAAQ,QAAQ;wBACpC,MAAM,cAAc;wBACpB,YAAY,OAAO;wBACnB,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC;4BAAE,eAAe;wBAAK;wBACrC;oBACF;oBAEA,IAAI,kBAAkB,QAAQ,OAAO;wBACnC,MAAM,cAAc;wBACpB,MAAM,OAAO,MAAM,MAAM,GAAG;wBAC5B,YAAY,OAAO;wBACnB,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC;4BAAE,eAAe;wBAAK;oBAC1C;gBACF;;YAEA,GAAG,gBAAgB,CAAC,WAAW;YAC/B;2CAAO;oBACL,GAAG,mBAAmB,CAAC,WAAW;gBACpC;;QACF;kCAAG;QAAC;QAAM;QAAc;QAAa;KAAe;AACtD;GArEgB","debugId":null}},
    {"offset": {"line": 201, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/scaleCatalog.ts"],"sourcesContent":["// Single Source of Truth for scale catalog (English-first)\n\nexport type DegreeToken =\n  | '1' | 'b2' | '2' | 'b3' | '3' | '4' | '#4' | 'b5' | '5' | '#5' | 'b6' | '6' | 'bb7' | 'b7' | '7';\n\nexport type ScaleId =\n  | 'Ionian' | 'Dorian' | 'Phrygian' | 'Lydian' | 'Mixolydian' | 'Aeolian' | 'Locrian'\n  | 'MajorPentatonic' | 'MinorPentatonic' | 'Blues'\n  | 'HarmonicMinor' | 'MelodicMinor' | 'Dorianb2'\n  | 'DiminishedWholeHalf' | 'DiminishedHalfWhole';\n\nexport type ScaleCatalogItem = {\n  id: ScaleId;\n  display: { en: string; ja?: string };\n  degrees: DegreeToken[];\n  group: 'Diatonic' | 'Pentatonic' | 'Minor' | 'Other';\n  info?: {\n    oneLiner?: string;\n    examples?: Array<{ title: string; artist: string; url?: string; cue?: string }>;\n  };\n  enabled?: boolean; // future feature flag (defaults true)\n};\n\n// NOTE: These entries follow common definitions. Please align with Excel (EN) if it differs.\nexport const SCALE_CATALOG: ScaleCatalogItem[] = [\n  // Use English names per Excel (avoid modal names for major/minor)\n  { id: 'Ionian', display: { en: 'Major Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','4','5','6','7'],\n    info: { oneLiner: 'Major scale; bright and stable.',\n      examples: [\n        { title: 'Let It Be', artist: 'The Beatles' },\n        { title: 'Do-Re-Mi', artist: 'Richard Rodgers' }\n      ] } },\n  { id: 'Dorian', display: { en: 'Dorian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','b3','4','5','6','b7'],\n    info: { oneLiner: 'Minor with a natural 6th; cool, modal colour.',\n      examples: [\n        { title: 'So What', artist: 'Miles Davis' }\n      ] } },\n  { id: 'Phrygian', display: { en: 'Phrygian Scale' }, group: 'Diatonic',\n    degrees: ['1','b2','b3','4','5','b6','b7'],\n    info: { oneLiner: 'Dark, Spanish/Arabic flavour with flat 2.' } },\n  { id: 'Lydian', display: { en: 'Lydian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','#4','5','6','7'],\n    info: { oneLiner: 'Dreamy major with raised 4th (♯4).',\n      examples: [ { title: 'The Simpsons Theme', artist: 'Danny Elfman' } ] } },\n  { id: 'Mixolydian', display: { en: 'Mixolydian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','4','5','6','b7'],\n    info: { oneLiner: 'Major with flat 7; dominant, bluesy feel.',\n      examples: [\n        { title: 'Sweet Home Alabama', artist: 'Lynyrd Skynyrd' }\n      ] } },\n  { id: 'Aeolian', display: { en: 'Natural Minor Scale' }, group: 'Diatonic',\n    degrees: ['1','2','b3','4','5','b6','b7'],\n    info: { oneLiner: 'Natural minor; sad or moody colour.',\n      examples: [ { title: 'House of the Rising Sun', artist: 'Traditional' } ] } },\n  { id: 'Locrian', display: { en: 'Locrian Scale' }, group: 'Diatonic',\n    degrees: ['1','b2','b3','4','b5','b6','b7'],\n    info: { oneLiner: 'Diminished 5th; unstable, rarely used as a key.' } },\n\n  { id: 'MajorPentatonic', display: { en: 'Major Pentatonic' }, group: 'Pentatonic',\n    degrees: ['1','2','3','5','6'],\n    info: { oneLiner: 'Five-note, open and melodic; fits many chords.',\n      examples: [ { title: 'My Girl', artist: 'The Temptations' } ] } },\n  { id: 'MinorPentatonic', display: { en: 'Minor Pentatonic' }, group: 'Pentatonic',\n    degrees: ['1','b3','4','5','b7'],\n    info: { oneLiner: 'Five-note minor staple for rock/blues solos.',\n      examples: [ { title: 'Purple Haze', artist: 'Jimi Hendrix' } ] } },\n  { id: 'Blues', display: { en: 'Blues Scale (minor)' }, group: 'Pentatonic',\n    degrees: ['1','b3','4','b5','5','b7'],\n    info: { oneLiner: 'Minor pentatonic plus blue note (♭5).',\n      examples: [ { title: 'Smoke on the Water', artist: 'Deep Purple' } ] } },\n\n  { id: 'HarmonicMinor', display: { en: 'Harmonic Minor' }, group: 'Minor',\n    degrees: ['1','2','b3','4','5','b6','7'],\n    info: { oneLiner: 'Minor with raised 7th; exotic dominant pull.',\n      examples: [ { title: 'Misirlou', artist: 'Traditional' } ] } },\n  { id: 'MelodicMinor', display: { en: 'Melodic Minor Scale' }, group: 'Minor',\n    degrees: ['1','2','b3','4','5','6','7'],\n    info: { oneLiner: 'Jazz minor (ascending); smooth minor/major blend.' } },\n\n  // Diminished scales (symmetric) — added per Excel list\n  { id: 'DiminishedWholeHalf', display: { en: 'Diminished Scale (Whole–Half)' }, group: 'Other',\n    degrees: ['1','2','b3','4','b5','b6','6','7'],\n    info: { oneLiner: 'Symmetric 8-note (whole–half) scale; over dim7.' } },\n  { id: 'DiminishedHalfWhole', display: { en: 'Diminished Scale (Half–Whole)' }, group: 'Other',\n    degrees: ['1','b2','b3','3','#4','5','6','b7'],\n    info: { oneLiner: 'Symmetric 8-note (half–whole); over 7♭9 chords.' } },\n];\n\n// Dev helper: expose catalog for quick inspection in console (no filtering)\nif (typeof window !== 'undefined') {\n  (window as any).__SCALES_EN__ = SCALE_CATALOG;\n}\n\n\n// Build 12-bit mask from degree tokens (C-root relative)\nexport function getScaleMask12(id: ScaleId): number[] {\n  const item = SCALE_CATALOG.find(s => s.id === id);\n  if (!item) return Array(12).fill(0);\n  const DEGREE_TO_SEMITONE: Record<DegreeToken, number> = {\n    '1': 0, 'b2': 1, '2': 2, 'b3': 3, '3': 4, '4': 5, '#4': 6, 'b5': 6, '5': 7, '#5': 8, 'b6': 8, '6': 9, 'bb7': 9, 'b7': 10, '7': 11\n  };\n  const mask = Array(12).fill(0);\n  for (const d of item.degrees) {\n    const s = DEGREE_TO_SEMITONE[d];\n    if (typeof s === 'number') mask[(s + 120) % 12] = 1;\n  }\n  return mask;\n}\n\nexport function listScales(): { id: ScaleId; label: string }[] {\n  return SCALE_CATALOG.map(s => ({ id: s.id, label: s.display.en }));\n}\n\n// 非ヘプタ判定とPent/Blues例外のヘルパー関数\nexport const isHeptatonic = (scaleId: string): boolean => {\n  const item = SCALE_CATALOG.find(s => s.id === scaleId as ScaleId);\n  return item ? item.degrees.length === 7 : false;\n};\n\nexport const isPentOrBlues = (scaleId: string): boolean => {\n  return scaleId === 'MajorPentatonic' || scaleId === 'MinorPentatonic' || scaleId === 'Blues';\n};\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 590, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/scales.ts"],"sourcesContent":["export type Pc = number; // 0..11\nimport { SCALE_CATALOG, type DegreeToken, type ScaleId as CatalogScaleId } from './scaleCatalog';\n\nexport type ScaleType =\n  | 'Ionian'\n  | 'Dorian'\n  | 'Phrygian'\n  | 'Lydian'\n  | 'Mixolydian'\n  | 'Aeolian'\n  | 'Locrian'\n  | 'HarmonicMinor'\n  | 'MelodicMinor'\n  | 'MajorPentatonic'\n  | 'MinorPentatonic'\n  | 'Blues'\n  | 'DiminishedWholeHalf'\n  | 'DiminishedHalfWhole';\n\nexport const SCALE_INTERVALS: Record<ScaleType, number[]> = {\n  Ionian:          [0,2,4,5,7,9,11],\n  Dorian:          [0,2,3,5,7,9,10],\n  Phrygian:        [0,1,3,5,7,8,10],\n  Lydian:          [0,2,4,6,7,9,11],\n  Mixolydian:      [0,2,4,5,7,9,10],\n  Aeolian:         [0,2,3,5,7,8,10],\n  Locrian:         [0,1,3,5,6,8,10],\n  HarmonicMinor:   [0,2,3,5,7,8,11],\n  MelodicMinor:    [0,2,3,5,7,9,11],\n  MajorPentatonic: [0,2,4,7,9],\n  MinorPentatonic: [0,3,5,7,10],\n  Blues:           [0,3,5,6,7,10],\n  DiminishedWholeHalf: [0,2,3,5,6,8,9,11],\n  DiminishedHalfWhole: [0,1,3,4,6,7,9,10],\n};\n\nexport type ScaleId = CatalogScaleId;\n\nexport function getScalePitches(root: Pc, type: ScaleId): Pc[] {\n  // Prefer catalog-driven calculation when possible\n  try {\n    return getScalePitchesById(root, type as unknown as CatalogScaleId);\n  } catch {}\n  const ints = SCALE_INTERVALS[type as unknown as ScaleType];\n  if (!ints || ints.length === 0) {\n    throw new Error(`Unknown scale id: ${String(type)}`);\n  }\n  return ints.map((iv) => (root + iv + 120) % 12);\n}\n\n// エイリアス→正規IDの正規化関数\nexport function normalizeScaleId(id: string): string {\n  const aliases: Record<string, string> = { Major: 'Ionian', Minor: 'Aeolian' };\n  const key = String(id);\n  return aliases[key] ?? aliases[key[0].toUpperCase()+key.slice(1)] ?? id;\n}\n\nexport function scaleTypeLabel(t: ScaleId | ScaleType): string {\n  // エイリアス吸収（防御的）\n  const aliasToId: Record<string, ScaleType> = { Major: 'Ionian', Minor: 'Aeolian' };\n  const id = (aliasToId[t as string] ?? t) as ScaleType;\n  \n  const map: Record<ScaleType,string> = {\n    Ionian: 'Major Scale',\n    Dorian: 'Dorian',\n    Phrygian: 'Phrygian',\n    Lydian: 'Lydian',\n    Mixolydian: 'Mixolydian',\n    Aeolian: 'Natural Minor',\n    Locrian: 'Locrian',\n    HarmonicMinor: 'Harmonic Minor',\n    MelodicMinor: 'Melodic Minor',\n    MajorPentatonic: 'Major Pentatonic',\n    MinorPentatonic: 'Minor Pentatonic',\n  };\n  // Mapを既定とし、未定義はカタログのdisplay.enを利用\n  const short = map[id];\n  if (short) return short;\n  const cat = SCALE_CATALOG.find(s => s.id === (id as any));\n  return (cat?.display.en || String(id)).replace(/\\s*\\(.*\\)$/,'');\n}\n\n// === Degree labels (with accidentals) per scale type ===\nexport const DEGREE_LABELS: Record<ScaleType, string[]> = {\n  Ionian:          [\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],\n  Dorian:          [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"6\",\"♭7\"],\n  Phrygian:        [\"1\",\"♭2\",\"♭3\",\"4\",\"5\",\"♭6\",\"♭7\"],\n  Lydian:          [\"1\",\"2\",\"3\",\"♯4\",\"5\",\"6\",\"7\"],\n  Mixolydian:      [\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"♭7\"],\n  Aeolian:         [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"♭6\",\"♭7\"],\n  Locrian:         [\"1\",\"♭2\",\"♭3\",\"4\",\"♭5\",\"♭6\",\"♭7\"],\n  HarmonicMinor:   [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"♭6\",\"7\"],\n  MelodicMinor:    [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"6\",\"7\"],\n  MajorPentatonic: [\"1\",\"2\",\"3\",\"5\",\"6\"],\n  MinorPentatonic: [\"1\",\"♭3\",\"4\",\"5\",\"♭7\"],\n  Blues:           [\"1\",\"♭3\",\"4\",\"♭5\",\"5\",\"♭7\"],\n};\n\n// pc to degree label for given scale; returns null if pc not in scale\nexport function degreeLabelFor(pc: Pc, root: Pc, type: ScaleId | ScaleType): string | null {\n  const iv = (pc - root + 120) % 12;\n  // Prefer catalog degrees → semitone offsets\n  const cat = SCALE_CATALOG.find(s => s.id === (type as any));\n  const ivs = (cat ? cat.degrees.map(d => DEGREE_TO_SEMITONE[d]) : undefined)\n    ?? (SCALE_INTERVALS[type as ScaleType] ?? []);\n  const idx = ivs.indexOf(iv);\n  if (idx === -1) return null;\n  const labels = (cat?.degrees as string[] | undefined)\n    ?? (DEGREE_LABELS[type as ScaleType] ?? undefined);\n  if (!labels) return null;\n  return labels[idx] ?? null;\n}\n\n// Convert a degree token like \"1\", \"b2\", \"#4\", \"♭3\" to Roman form (R, II, ♯IV, ♭III, etc.)\nfunction degreeTokenToRoman(token: string): string {\n  const t = token.replace(/\\s+/g, '')\n    .replace(/bb/g, '♭♭')\n    .replace(/b/g, '♭')\n    .replace(/##/g, '♯♯')\n    .replace(/#/g, '♯');\n  // Extract accidentals and number\n  const m = t.match(/^(♭|♯|♭♭|♯♯)?(\\d)$/);\n  if (!m) {\n    // fallback: if already has Roman-like content, return as is\n    return t;\n  }\n  const acc = m[1] ?? '';\n  const n = m[2];\n  const romanBase: Record<string,string> = {\n    '1': 'R',\n    '2': 'II',\n    '3': 'III',\n    '4': 'IV',\n    '5': 'V',\n    '6': 'VI',\n    '7': 'VII',\n  };\n  const base = romanBase[n] ?? n;\n  return `${acc}${base}`;\n}\n\n// Roman degree label for a pitch class in a given scale (uses catalog degrees when available)\nexport function degreeRomanFor(pc: Pc, root: Pc, type: ScaleId | ScaleType): string | null {\n  const iv = (pc - root + 120) % 12;\n  const cat = SCALE_CATALOG.find(s => s.id === (type as any));\n  const ivs = (cat ? cat.degrees.map(d => DEGREE_TO_SEMITONE[d]) : undefined)\n    ?? (SCALE_INTERVALS[type as ScaleType] ?? []);\n  const idx = ivs.indexOf(iv);\n  if (idx === -1) return null;\n  const labels = (cat?.degrees as string[] | undefined)\n    ?? (DEGREE_LABELS[type as ScaleType] ?? undefined);\n  if (!labels) return null;\n  const token = labels[idx] ?? '';\n  return degreeTokenToRoman(token);\n}\n\n// Parent mode mapping (e.g., pentatonic → its diatonic parent)\nexport function parentModeOf(t: ScaleId | ScaleType): ScaleType | null {\n  switch (t) {\n    case 'MajorPentatonic':\n      return 'Ionian';\n    case 'MinorPentatonic':\n      return 'Aeolian';\n    default:\n      return null;\n  }\n}\n\n\n// === Roman degree labels per scale type (vs Ionian baseline) ===\nconst IONIAN_INTERVALS = [0,2,4,5,7,9,11];\nconst ROMAN_BASE = ['I','II','III','IV','V','VI','VII'] as const;\n\nexport function romanDegreeLabelsForScale(scaleType: ScaleType): string[] {\n  const ints = SCALE_INTERVALS[scaleType];\n  // Fallback for non-7-note scales\n  if (!ints || ints.length !== 7) return [...ROMAN_BASE];\n  return ints.map((semi, i) => {\n    const base = ROMAN_BASE[i];\n    const diff = semi - IONIAN_INTERVALS[i];\n    if (diff === 0) return base;\n    if (diff > 0) return '#'.repeat(diff) + base;\n    return 'b'.repeat(-diff) + base;\n  });\n}\n\n// === Catalog-driven semitone mapping and API (SSOT; supports 5/7/8 notes) ===\nexport const DEGREE_TO_SEMITONE: Record<DegreeToken, number> = {\n  '1': 0,\n  'b2': 1,\n  '2': 2,\n  'b3': 3,\n  '3': 4,\n  '4': 5,\n  '#4': 6,\n  'b5': 6,\n  '5': 7,\n  '#5': 8,\n  'b6': 8,\n  '6': 9,\n  'bb7': 9,\n  'b7': 10,\n  '7': 11,\n};\n\nexport function getScalePitchesById(rootPc: number, id: CatalogScaleId): number[] {\n  const s = SCALE_CATALOG.find(x => x.id === id);\n  if (!s) throw new Error(`Scale not found in catalog: ${String(id)}`);\n  return s.degrees.map(d => (rootPc + DEGREE_TO_SEMITONE[d] + 120) % 12);\n}\n\n// Dev helper: expose minimal API for console checks\nif (typeof window !== 'undefined') {\n  (window as any).__SCALES_API__ = {\n    getScalePitchesById,\n  };\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1024, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/Fretboard.tsx"],"sourcesContent":["\"use client\";\nimport React, { useEffect, useRef, useState } from \"react\";\nimport { SCALE_CATALOG } from \"@/lib/scaleCatalog\";\nimport { degreeLabelFor, degreeRomanFor, getScalePitches, type ScaleType } from \"@/lib/scales\";\nimport { player } from \"@/lib/audio/player\";\nimport type { FormShape, Quality } from \"@/lib/chordForms\";\nconst PITCHES12 = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'] as const;\n\ntype FretboardProps = {\n  strings?: string[]; // high -> low\n  frets?: number;\n  dotPositions?: number[];\n  overlay?: { display: 'degrees'|'names'; viewMode?: 'sounding'; capo: number; notes?: string[]; chordNotes?: string[]; showScaleGhost?: boolean; scaleRootPc?: number; scaleType?: ScaleType; context?: { chordRootPc?: number; quality?: Quality } } | null;\n  onRequestForms?: (at:{x:number;y:number}, ctx:{rootPc:number; quality: Quality})=>void;\n  formShape?: FormShape | null;\n};\n\n// --- Dot visuals (shared for Degrees/Names) ---\nconst DOT_PX_DESKTOP = 26;\nconst DOT_PX_MOBILE = 24;\nconst FONT_PX_DESKTOP = 14;\nconst FONT_PX_MOBILE = 13;\n// Original palette（page base: show degree colours）\nconst COLOR_ROOT   = \"hsl(355 80% 60% / .95)\"; // root\nconst COLOR_DEG3   = \"hsl(205 90% 56% / .90)\"; // 3rd\nconst COLOR_DEG5   = \"hsl(150 65% 45% / .90)\"; // 5th\nconst COLOR_DEG7   = \"hsl(48 95% 55% / .92)\";  // 7th\n// Preview palette（suggested-scale overlay: chord vs others）\nconst COLOR_CHORD  = \"hsl(0 85% 55% / .95)\";   // chord tones (red)\nconst COLOR_SCALE  = \"hsl(210 10% 72% / .70)\"; // non-chord scale tones (gray)\nconst COLOR_OUT    = \"hsl(210 6% 38% / .30)\";\nconst COLOR_GHOST  = \"hsl(210 12% 58% / .60)\"; // unified ghost color (darker)\nconst LABEL_COLOR = \"#0b0b0b\";\n\nconst dotStyle = (bg: string, isMobile: boolean): React.CSSProperties => {\n  const size = isMobile ? DOT_PX_MOBILE : DOT_PX_DESKTOP;\n  return {\n    width: size,\n    height: size,\n    borderRadius: size,\n    background: bg,\n    color: LABEL_COLOR,\n    fontWeight: 700,\n    fontSize: isMobile ? FONT_PX_MOBILE : FONT_PX_DESKTOP,\n    display: 'flex',\n    alignItems: 'center',\n    justifyContent: 'center',\n    transform: 'translate(-50%, -50%)',\n    textShadow: '0 0 1px rgba(0,0,0,.55)',\n    WebkitTextStroke: '0.3px rgba(255,255,255,.35)',\n    userSelect: 'none',\n  };\n};\n\nfunction colorForDegreeLabel(preview: boolean, lbl: string | null, isChordTone: boolean, isInScale: boolean, isRoot: boolean) {\n  if (!isInScale) return COLOR_OUT;\n  if (preview) {\n    return isChordTone ? COLOR_CHORD : COLOR_SCALE;\n  }\n  if (isRoot) return COLOR_ROOT;\n  if (!lbl) return COLOR_SCALE;\n  const l = lbl.replace(/\\s/g, \"\");\n  if (l.includes(\"3\")) return COLOR_DEG3;\n  if (l.includes(\"5\")) return COLOR_DEG5;\n  if (l.includes(\"7\")) return COLOR_DEG7;\n  return COLOR_SCALE;\n}\n\nfunction ghostFromBaseColor(base: string, alpha = 0.85): string {\n  try {\n    if (base.includes('/')) {\n      return base.replace(/\\/(.*?)\\)/, `/ ${alpha})`);\n    }\n    if (base.endsWith(')')) return base.replace(/\\)$/, ` / ${alpha})`);\n  } catch {}\n  return base;\n}\n\nexport default function Fretboard({\n  strings = ['E','B','G','D','A','E'],\n  frets = 15,\n  dotPositions: _dotPositions = [3,5,7,9,12,15],\n  overlay = null,\n  onRequestForms,\n  formShape = null,\n}: FretboardProps) {\n  const wrapRef = useRef<HTMLDivElement | null>(null);\n  // SSRと初回クライアント描画の一致を保つため、初期値はfalse（デスクトップ想定）\n  const [isMobile, setIsMobile] = useState(false);\n  const [pressedCell, setPressedCell] = useState<{ r: number; c: number; ver: number } | null>(null);\n  useEffect(() => {\n    const update = () => {\n      try { setIsMobile(window.innerWidth < 380); } catch { /* noop */ }\n    };\n    update();\n    window.addEventListener('resize', update);\n    return () => window.removeEventListener('resize', update);\n  }, []);\n  // ScaleとChordを統合したoverlayオブジェクトを作成\n  // 親から `overlay` が渡されている場合はそれを最優先（Find Key などの初期表示用）\n  const overlayEff = overlay ?? null;\n  // Layout constants\n  const LEFT_GUTTER = 44;   // px  // compact gutter (reduced)\n  const SPACE_W = 28;       // px  // standard fret min width\n  const ROW_H = 28;         // px\n  const TOP_BAR_H = 32;     // px\n  const OPEN_GAP = 20;      // px additional gap for open column (increased by +8px)\n  const ZERO_COL_W = SPACE_W + OPEN_GAP; // widened open column\n  const COLS = (f: number) => `${ZERO_COL_W}px repeat(${f}, minmax(${SPACE_W}px, 1fr))`;\n  const NUT_WIDTH = 3;      // px\n\n  // --- Chord label long-press (for mouse/touch on the label only) ---\n  const PRESS_MS = 400;\n  const pressTimer = useRef<number | null>(null);\n  const endPress = () => { if (pressTimer.current!==null){ clearTimeout(pressTimer.current); pressTimer.current=null; } };\n  const startPress = (e: React.PointerEvent, ctx:{rootPc:number; quality:Quality}) => {\n    if (!onRequestForms) return;\n    // マウスの長押しは不要だが、統一して実装\n    endPress();\n    pressTimer.current = window.setTimeout(()=>{\n      onRequestForms({ x:e.clientX, y:e.clientY }, ctx);\n    }, PRESS_MS);\n  };\n\n  useEffect(() => {}, [frets, strings.length]);\n  return (\n    <div className=\"rounded-lg border p-3 overflow-x-auto ot-fretboard ot-fb-compact\">\n      <div className=\"min-w-[640px]\">\n        <div ref={wrapRef} className=\"relative\" style={{ height: TOP_BAR_H + strings.length * ROW_H + 16 }}>\n          {/* nut line is rendered inside grid below */}\n          {/* Fret numbers top bar */}\n          <div\n            className=\"pointer-events-none absolute top-1 grid text-[12px] md:text-sm text-foreground/80\"\n            style={{\n              gridTemplateColumns: COLS(frets),\n              height: TOP_BAR_H,\n              left: LEFT_GUTTER,\n              right: 0,\n            }}\n          >\n            {Array.from({ length: frets+1 }).map((_, col) => {\n              const show = [0,1,3,5,7,9,12,15].includes(col);\n              if (!show) return <div key={col} />;\n              return (\n                <div key={col} className=\"flex items-start justify-center\">\n                  <span className=\"inline-block px-1 rounded bg-background/80\">{col}</span>\n                </div>\n              );\n            })}\n          </div>\n          {/* chord forms UI removed per spec */}\n          {/* Left tuning labels (E B G D A E) */}\n          <div\n            className=\"absolute select-none\"\n            style={{\n              left: 0,\n              top: TOP_BAR_H,\n              width: LEFT_GUTTER,\n              height: strings.length * ROW_H,\n              display: 'grid',\n              gridTemplateRows: `repeat(${strings.length}, ${ROW_H}px)`,\n            }}\n            aria-hidden=\"true\"\n          >\n            {strings.map((s, i) => (\n              <div key={`lbl-${i}`} className=\"flex items-center justify-center text-xs md:text-sm leading-none text-muted-foreground\">\n                {s}\n              </div>\n            ))}\n          </div>\n            <div className=\"absolute right-0 bottom-0 grid\" style={{ top: TOP_BAR_H, left: LEFT_GUTTER, width: `calc(100% - ${LEFT_GUTTER}px)`, gridTemplateColumns: COLS(frets), gridTemplateRows: `repeat(${strings.length}, ${ROW_H}px)` }}>\n            {strings.map((s, rowIdx) => (\n              <React.Fragment key={`row-${rowIdx}`}>\n                {/* Open space cell */}\n                <div className=\"relative\" key={`open-${rowIdx}`}>{renderOpenMarker({ overlay: overlayEff, strings, rowIdx, isMobile })}</div>\n                {Array.from({ length: frets }).map((_, colIdx) => (\n                  <div\n                    key={`c-${rowIdx}-${colIdx}`}\n                    className={`relative ${colIdx===0 ? 'border-l border-transparent' : 'border-l border-black/10 dark:border-white/10'} ${pressedCell && pressedCell.r===rowIdx && pressedCell.c===colIdx ? 'fb-pressed' : ''} cursor-pointer select-none`}\n                    onClick={async()=>{\n                      // 空白やゴースト領域でもタップで単音を軽く試聴\n                      const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40];\n                      const baseMidi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n                      const midi = baseMidi + (colIdx + 1);\n                      // 短い押下エフェクト\n                      setPressedCell(prev => ({ r: rowIdx, c: colIdx, ver: (prev?.ver ?? 0) + 1 }));\n                      const localVer = (pressedCell?.ver ?? 0) + 1;\n                      window.setTimeout(() => {\n                        setPressedCell(cur => (cur && cur.r===rowIdx && cur.c===colIdx && cur.ver===localVer) ? null : cur);\n                      }, 180);\n                      try { await player.resume(); player.playNote(midi, 240); } catch {}\n                    }}\n                  >\n                    {renderMarker({ overlay: overlayEff, strings, rowIdx, colIdx, isMobile })}\n                  </div>\n                ))}\n              </React.Fragment>\n            ))}\n            {/* Nut line (between 0 and 1) */}\n            <div\n              aria-hidden\n              className=\"absolute pointer-events-none z-[20] bg-black/60 dark:bg-white/70\"\n              style={{\n                left: ZERO_COL_W - NUT_WIDTH / 2,\n                top: 0,\n                bottom: 0,\n                width: NUT_WIDTH,\n                borderRadius: 2,\n              }}\n            />\n          </div>\n        </div>\n      </div>\n      {formShape && renderFormOverlay({ formShape, LEFT_GUTTER, TOP_BAR_H, SPACE_W, ROW_H })}\n    </div>\n  );\n}\n\nconst pitchIndexMap: Record<string, number> = {\n  C: 0, \"C#\": 1, Db: 1, D: 2, \"D#\": 3, Eb: 3, E: 4, F: 5, \"F#\": 6, Gb: 6,\n  G: 7, \"G#\": 8, Ab: 8, A: 9, \"A#\": 10, Bb: 10, B: 11,\n};\nconst pitchIndex = (note: string): number => pitchIndexMap[note] ?? 0;\n// Fallback degree label map (chromatic → degree text)\nfunction fallbackDegreeLabel(notePc: number, rootPc: number): string {\n  const d = (notePc - rootPc + 12) % 12;\n  const arr = [\"1\",\"b2\",\"2\",\"b3\",\"3\",\"4\",\"#4\",\"5\",\"b6\",\"6\",\"b7\",\"7\"] as const;\n  return arr[d];\n}\n\nfunction renderMarker({ overlay, strings, rowIdx, colIdx, isMobile }:{ overlay: FretboardProps['overlay']; strings: string[]; rowIdx: number; colIdx: number; isMobile: boolean; }){\n  if (!overlay) return null;\n  const chordNotes = overlay.chordNotes ?? overlay.notes ?? [];\n  const hasChord = (chordNotes?.length ?? 0) > 0;\n  const chordRootIdx = hasChord ? pitchIndex(chordNotes[0] ?? \"C\") : 0;\n  const set = new Set((chordNotes || []).map((note) => pitchIndex(note ?? \"C\")));\n  const openPc = pitchIndex(strings[rowIdx] ?? \"E\");\n  // Shaped: treat capo as new nut → subtract capo semitones\n  // column index 0 represents fret 1 (fret 0 = open is not drawn as a column)\n  const fretN = colIdx + 1;\n  const spc = (openPc + fretN) % 12; // shapedは廃止・常にsounding\n  // 実音のMIDI（弦の実チューニング＋フレット数）\n  const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40]; // E4, B3, G3, D3, A2, E2 (high -> low)\n  const baseMidi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n  const midi = baseMidi + fretN;\n  // scale-aware style & label\n  const scaleRoot = overlay.scaleRootPc;\n  const scaleType = overlay.scaleType;\n  const inScale = ((): boolean => {\n    if (typeof scaleRoot !== 'number' || !scaleType) return true;\n    const iv = (spc - scaleRoot + 120) % 12;\n    const ivs = getScalePitches(scaleRoot, overlay.scaleType as any).map(v => (v - scaleRoot + 120) % 12);\n    return ivs.includes(iv);\n  })();\n  // Optionally draw scale ghost when in scale and not a chord tone\n  const hasChordOverlay = (chordNotes?.length ?? 0) > 0;\n  const drawGhost = (overlay.showScaleGhost ?? true) && hasChordOverlay && inScale && !set.has(spc);\n  // Draw chord tone if provided\n  const drawChord = set.has(spc);\n  const drawScaleMain = !hasChordOverlay && inScale;\n  if (!drawGhost && !drawChord && !drawScaleMain) return null;\n  const iv = typeof scaleRoot === 'number' ? (spc - scaleRoot + 120) % 12 : 0;\n  const isRoot = iv === 0;\n  const isChordTone = set.has(spc) || [0,4,7,10,11].includes(iv); // root/3/5/7 as baseline\n  const degreeLbl = !inScale || typeof scaleRoot !== 'number' || !scaleType ? null : (degreeLabelFor(spc, scaleRoot, overlay.scaleType as any) ?? null);\n  const baseColor = colorForDegreeLabel(false, degreeLbl, isChordTone, inScale, isRoot);\n  const showDegrees = overlay.display === 'degrees';\n  const fallbackRoot = (typeof scaleRoot === 'number' ? scaleRoot : chordRootIdx);\n  const label = (showDegrees)\n    ? ((degreeRomanFor(spc, fallbackRoot, overlay.scaleType as any) ?? degreeLbl ?? fallbackDegreeLabel(spc, fallbackRoot)))\n    : PITCHES12[spc];\n  const dense = (() => { const def = SCALE_CATALOG.find(s => s.id === (overlay.scaleType as any)); return (def?.degrees?.length ?? 0) > 7; })();\n  const fretLabel = colIdx + 1;\n  const stringNumber = rowIdx + 1;\n  const ariaLabel = `string ${stringNumber}, fret ${fretLabel}, ${label === '1' ? 'root' : label}`;\n  return (\n    <div className=\"absolute inset-0\" aria-live=\"polite\">\n      {drawGhost && (\n        <div className={`absolute left-1/2 top-1/2 fret-dot--ghost${dense ? ' ghost--dense' : ''}`} style={{ color: ghostFromBaseColor(baseColor) }} aria-hidden />\n      )}\n      {drawScaleMain && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(baseColor, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n      {drawChord && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(baseColor, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main fret-dot--chord\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n    </div>\n  );\n}\n\nfunction renderOpenMarker({ overlay, strings, rowIdx, isMobile }:{ overlay: FretboardProps['overlay']; strings: string[]; rowIdx: number; isMobile: boolean; }){\n  if (!overlay) return null;\n  const chordNotes = overlay.chordNotes ?? overlay.notes ?? [];\n  const hasChord = (chordNotes?.length ?? 0) > 0;\n  const tonicIdx = hasChord ? pitchIndex(chordNotes[0] ?? \"C\") : 0;\n  const set = new Set((chordNotes || []).map((note) => pitchIndex(note ?? \"C\")));\n  const openPc = pitchIndex(strings[rowIdx] ?? \"E\");\n  const spcSounding = openPc; // open = fret 0 sounding\n  const spc = spcSounding; // shapedは廃止・常にsounding\n  // 実音のMIDI（弦の実チューニングの開放音）\n  const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40];\n  const midi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n  const scaleRoot = overlay.scaleRootPc;\n  const scaleType = overlay.scaleType;\n  const inScale = ((): boolean => {\n    if (typeof scaleRoot !== 'number' || !scaleType) return true;\n    const iv = (spc - scaleRoot + 120) % 12;\n    const ivs = getScalePitches(scaleRoot, overlay.scaleType as any).map(v => (v - scaleRoot + 120) % 12);\n    return ivs.includes(iv);\n  })();\n  const hasChordOverlay = (chordNotes?.length ?? 0) > 0;\n  const drawGhost = (overlay.showScaleGhost ?? true) && hasChordOverlay && inScale && !set.has(spc);\n  const drawChord = set.has(spc);\n  const drawScaleMain = !hasChordOverlay && inScale;\n  if (!drawGhost && !drawChord && !drawScaleMain) return null;\n  const iv = typeof scaleRoot === 'number' ? (spc - scaleRoot + 120) % 12 : 0;\n  const isRoot = iv === 0;\n  const isChordTone = [0,4,7,10,11].includes(iv) && inScale;\n  const degreeLbl = !inScale || typeof scaleRoot !== 'number' || !scaleType ? null : (degreeLabelFor(spc, scaleRoot, overlay.scaleType as any) ?? null);\n  const bg = colorForDegreeLabel(false, degreeLbl, isChordTone, inScale, isRoot);\n  const showDegrees = overlay.display === 'degrees';\n  const label = (showDegrees)\n    ? ((degreeRomanFor(spc, tonicIdx, overlay.scaleType as any) ?? degreeLbl ?? fallbackDegreeLabel(spc, tonicIdx)))\n    : PITCHES12[spc];\n  const dense = (() => { const def = SCALE_CATALOG.find(s => s.id === (overlay.scaleType as any)); return (def?.degrees?.length ?? 0) > 7; })();\n  const stringNumber = rowIdx + 1;\n  const ariaLabel = `string ${stringNumber}, fret 0, ${label === '1' ? 'root' : label}`;\n  return (\n    <div className=\"absolute inset-0\">\n      {drawGhost && (\n        <div className={`absolute left-1/2 top-1/2 fret-dot--ghost${dense ? ' ghost--dense' : ''}`} style={{ color: COLOR_GHOST }} aria-hidden />\n      )}\n      {drawScaleMain && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(bg, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n      {drawChord && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(bg, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main fret-dot--chord\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n    </div>\n  );\n}\n\nfunction renderFormOverlay({ formShape, LEFT_GUTTER, TOP_BAR_H, SPACE_W, ROW_H }:{ formShape: FormShape; LEFT_GUTTER:number; TOP_BAR_H:number; SPACE_W:number; ROW_H:number; }) {\n  return formShape.dots.map((dot, idx) => {\n    const degree = dot.deg === '1'\n      ? 'root'\n      : dot.deg\n          .replace(/b/g, 'flat ')\n          .replace(/#/g, 'sharp ');\n    const ariaLabel = `string ${dot.string}, fret ${dot.fret}, ${degree}`;\n    const left = `calc(${LEFT_GUTTER}px + ${dot.fret * SPACE_W}px)`;\n    const top = `calc(${TOP_BAR_H}px + ${(dot.string - 0.5) * ROW_H}px)`;\n    return (\n      <div\n        key={`form-${idx}`}\n        className=\"absolute\"\n        role=\"img\"\n        aria-label={ariaLabel}\n        style={{ left, top, transform:'translate(-50%, -50%)' }}\n      >\n        <span className=\"fret-dot--form\" aria-hidden />\n      </div>\n    );\n  });\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1716, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music/constants.ts"],"sourcesContent":["/**\n * 音楽理論の共通定数\n */\n\n/** ピッチクラスの名前（0=C, 1=C#, ..., 11=B） */\nexport const PC_NAMES = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'] as const;\n\n/** ピッチクラスの総数 */\nexport const PITCH_CLASS_COUNT = 12;\n\n/** デフォルトのMIDIオクターブ（C4 = MIDI 60） */\nexport const DEFAULT_MIDI_OCTAVE = 60;\n\n/**\n * ピッチクラスを0-11の範囲に正規化\n */\nexport function mod12(pc: number): number {\n  return ((pc % 12) + 12) % 12;\n}\n\n/**\n * ピッチクラス番号を音名に変換\n */\nexport function pcToName(pc: number): string {\n  return PC_NAMES[mod12(pc)];\n}\n\n/**\n * 音名をピッチクラス番号に変換\n */\nexport function nameToPc(name: string): number {\n  const index = PC_NAMES.indexOf(name as any);\n  return index >= 0 ? index : -1;\n}\n\n"],"names":[],"mappings":"AAAA;;CAEC,GAED,oCAAoC;;;;;;;;;;;;;;AAC7B,MAAM,WAAW;IAAC;IAAK;IAAM;IAAK;IAAM;IAAK;IAAK;IAAM;IAAK;IAAM;IAAK;IAAM;CAAI;AAGlF,MAAM,oBAAoB;AAG1B,MAAM,sBAAsB;AAK5B,SAAS,MAAM,EAAU;IAC9B,OAAO,CAAC,AAAC,KAAK,KAAM,EAAE,IAAI;AAC5B;AAKO,SAAS,SAAS,EAAU;IACjC,OAAO,QAAQ,CAAC,MAAM,IAAI;AAC5B;AAKO,SAAS,SAAS,IAAY;IACnC,MAAM,QAAQ,SAAS,OAAO,CAAC;IAC/B,OAAO,SAAS,IAAI,QAAQ,CAAC;AAC/B","debugId":null}},
    {"offset": {"line": 1765, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory.ts"],"sourcesContent":["// PITCHESは lib/music/constants.ts に移行しました\nexport { PC_NAMES as PITCHES, PC_NAMES } from './music/constants';\n// 内部で使用するためにインポート\nimport { PC_NAMES as PITCHES_INTERNAL } from './music/constants';\nexport type Pc = number; // 0..11\nexport type Mode = \"Major\" | \"Minor\";\n\nexport const SCALESETS = {\n  ionian:     [0,2,4,5,7,9,11],\n  dorian:     [0,2,3,5,7,9,10],\n  phrygian:   [0,1,3,5,7,8,10],\n  lydian:     [0,2,4,6,7,9,11],\n  mixolydian: [0,2,4,5,7,9,10],\n  aeolian:    [0,2,3,5,7,8,10],\n  locrian:    [0,1,3,5,6,8,10],\n  locrianNat2: [0,2,3,5,6,8,10], // Locrian ♮2 (Melodic Minor 6th mode)\n  majPent:    [0,2,4,7,9],\n  minPent:    [0,3,5,7,10],\n  bluesMin:   [0,3,5,6,7,10],\n  dimWholeHalf: [0,2,3,5,6,8,9,11], // Whole-Half diminished scale\n  dimHalfWhole: [0,1,3,4,6,7,9,10], // Half-Whole diminished scale\n  altered:    [0,1,3,4,6,8,10], // Altered scale (Super Locrian)\n} as const;\n\n// Quality aliases: シンボルの表記ゆれを正規化キーへ統一\nexport const QUALITY_ALIASES: Record<string, string> = {\n  // Major family\n  'maj': 'M', 'major': 'M', '': 'M',\n  'maj7': 'M7', 'M7': 'M7', 'Δ': 'M7', 'Δ7': 'M7',\n  'maj9': 'M9', 'M9': 'M9', 'Δ9': 'M9',\n  'maj11': 'M11', 'M11': 'M11',\n  'maj13': 'M13', 'M13': 'M13',\n  // Minor family\n  'min': 'm', 'mi': 'm', '-': 'm',\n  'min7': 'm7', 'mi7': 'm7', '-7': 'm7',\n  'min9': 'm9', 'mi9': 'm9',\n  'min11': 'm11', 'mi11': 'm11',\n  'min13': 'm13', 'mi13': 'm13',\n  'mM7': 'mMaj7', 'mMaj7': 'mMaj7', 'minMaj7': 'mMaj7',\n  // Diminished family\n  'dim': 'dim', '°': 'dim', 'o': 'dim',\n  'dim7': 'dim7', '°7': 'dim7', 'o7': 'dim7',\n  'm7b5': 'm7b5', 'm7♭5': 'm7b5', 'ø': 'm7b5', 'ø7': 'm7b5',\n  // Augmented family\n  'aug': 'aug', '+': 'aug',\n  'aug7': '7#5', '7#5': '7#5', '7+5': '7#5', '7♯5': '7#5',\n  // Suspended\n  'sus2': 'sus2', 'sus4': 'sus4', 'sus': 'sus4',\n  '7sus4': '7sus4', '7sus': '7sus4',\n  // Sixth chords\n  '6': '6', 'm6': 'm6', 'min6': 'm6',\n  '6/9': '6/9', '69': '6/9',\n  // Altered/extensions\n  '7b5': '7b5', '7♭5': '7b5', '7-5': '7b5',\n  '7b9': '7b9', '7♭9': '7b9', '7-9': '7b9',\n  '7#9': '7#9', '7♯9': '7#9', '7+9': '7#9',\n  '7b13': '7b13', '7♭13': '7b13',\n  '7#11': '7#11', '7♯11': '7#11',\n  '7(9)': '9', '7(11)': '11', '7(13)': '13', // 統一: 7(9)→9\n  'm7(9)': 'm9', 'm7(11)': 'm11',\n  'M7(9)': 'M9', 'M7(13)': 'M13',\n  '7alt': '7alt', '7altered': '7alt',\n} as const;\n\n// Quality resolver: QUALITY_ALIASESを通して正規化\nexport function resolveQuality(qual: string): string {\n  return QUALITY_ALIASES[qual] ?? qual;\n}\n\n// QUALITY_TONES: Chord Libraryの全40+品質を網羅\nexport const QUALITY_TONES: Record<string, number[]> = {\n  // Basic triads (Core)\n  M:     [0,4,7],\n  m:     [0,3,7],\n  aug:   [0,4,8],\n  dim:   [0,3,6],\n  // Suspended (Core)\n  sus2:  [0,2,7],\n  sus4:  [0,5,7],\n  // Sixth chords (Core)\n  \"6\":   [0,4,7,9],\n  m6:    [0,3,7,9],\n  \"6/9\": [0,4,7,9,14], // 6/9 = R,3,5,6,9\n  // Seventh chords (Core)\n  \"7\":   [0,4,7,10],   // Dominant 7th\n  M7:    [0,4,7,11],   // Major 7th\n  m7:    [0,3,7,10],   // Minor 7th\n  dim7:  [0,3,6,9],    // Diminished 7th (修正: [0,3,6,10]→[0,3,6,9])\n  m7b5:  [0,3,6,10],   // Half-diminished 7th\n  mMaj7: [0,3,7,11],   // Minor-major 7th\n  // Ninth chords (Core)\n  \"9\":   [0,4,7,10,14],  // Dominant 9th\n  M9:    [0,4,7,11,14],  // Major 9th\n  m9:    [0,3,7,10,14],  // Minor 9th\n  add9:  [0,4,7,14],     // Add 9 (no 7th)\n  madd9: [0,3,7,14],     // Minor add 9\n  // Extended chords (Advanced)\n  \"11\":  [0,4,7,10,14,17], // 11th (理論上は3rdを省略すべきだが、音度表示は完全形)\n  M11:   [0,4,7,11,14,17], // Major 11th (実務上は#11が一般的だが、ここは理論形)\n  m11:   [0,3,7,10,14,17], // Minor 11th\n  \"13\":  [0,4,7,10,14,21], // 13th (理論上は11thを省略すべき)\n  M13:   [0,4,7,11,14,21], // Major 13th\n  m13:   [0,3,7,10,14,21], // Minor 13th\n  // Altered/Sus7 (Core & Advanced)\n  \"7sus4\": [0,5,7,10],     // Dominant 7 sus4\n  \"7b5\":   [0,4,6,10],     // Dominant 7 flat 5\n  \"7#5\":   [0,4,8,10],     // Dominant 7 sharp 5 (aug7)\n  \"7b9\":   [0,4,7,10,13],  // Dominant 7 flat 9\n  \"7#9\":   [0,4,7,10,15],  // Dominant 7 sharp 9\n  \"7#11\":  [0,4,7,10,18],  // Dominant 7 sharp 11 (Lydian dominant)\n  \"7b13\":  [0,4,7,10,20],  // Dominant 7 flat 13\n  \"7alt\":  [0,4,7,10,13,15,18], // Altered (代表構成: ♭9,#9,#11 - 実用的な組み合わせに固定)\n};\n\nexport const noteToPc = (n: string): Pc => {\n  const i = PITCHES_INTERNAL.indexOf(n as any);\n  if (i >= 0) return i;\n  const flatMap: Record<string,string> = {Db:\"C#\",Gb:\"F#\",Ab:\"G#\",Bb:\"A#\",Eb:\"D#\",Cb:\"B\",Fb:\"E\"};\n  const up = flatMap[n] ?? n;\n  return PITCHES_INTERNAL.indexOf(up as any) as number;\n};\n\n/**\n * pcToNoteName: Pitch class → 音名変換（キーの調号に応じて♯/♭を選択）\n * @param pc - Pitch class (0-11)\n * @param keyRoot - キーのルート音（Pc: 0-11）\n * @param mode - Major or Minor\n * @returns 音名（例: \"Eb\", \"F#\"）\n */\nexport function pcToNoteName(pc: Pc, keyRoot?: Pc, mode?: Mode): string {\n  if (keyRoot === undefined) {\n    // キー情報がない場合は♭優先（Chord Libraryと同じ）\n    const flatPreferred = [\"C\", \"C#\", \"D\", \"Eb\", \"E\", \"F\", \"F#\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\"];\n    return flatPreferred[pc];\n  }\n  \n  // ♯系キーと♭系キーを判定\n  const sharpKeys = [7, 2, 9, 4, 11, 6, 1]; // G, D, A, E, B, F#, C#\n  const flatKeys = [5, 10, 3, 8, 1, 6, 11]; // F, Bb, Eb, Ab, Db, Gb, Cb\n  \n  const isSharpKey = sharpKeys.includes(keyRoot);\n  \n  if (isSharpKey) {\n    // ♯系キー: C, C#, D, D#, E, F, F#, G, G#, A, A#, B\n    const sharpNames = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"];\n    return sharpNames[pc];\n  } else {\n    // ♭系キー（またはC): C, Db, D, Eb, E, F, Gb, G, Ab, A, Bb, B\n    const flatNames = [\"C\", \"Db\", \"D\", \"Eb\", \"E\", \"F\", \"Gb\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\"];\n    return flatNames[pc];\n  }\n}\n\nexport const transpose = (pc: Pc, by: number) => (pc + by + 12) % 12;\n\nexport type ChordSym = string; // e.g. \"C\", \"Am\", \"G7\", \"F#m7\", \"C/E\"\nexport type ParsedChord = { root: Pc; qual: string; bass?: Pc; tones: Pc[] };\n\nexport function parseChord(sym: ChordSym): ParsedChord {\n  const slash = sym.split(\"/\");\n  const main = slash[0];\n  const m = main.match(/^([A-G](#|b)?)(.*)$/);\n  if (!m) throw new Error(\"bad chord: \"+sym);\n  const root = noteToPc(m[1]!);\n  const rawQual = (m[3] || \"\").trim() || \"\";\n  const qual = resolveQuality(rawQual || \"M\"); // エイリアス正規化を通す\n  const tonesRel = QUALITY_TONES[qual] ?? QUALITY_TONES.M;\n  const tones = tonesRel.map(iv => transpose(root, iv % 12)); // mod12で正規化\n  const bass = slash[1] ? noteToPc(slash[1]!) : undefined;\n  return { root, qual, bass, tones };\n}\n\n// Diatonic quality tables: 各度数に対する典型的な品質（第1候補が既定）\nexport const DEG_QUAL_MAJOR: Record<number, string[]> = {\n  0:[\"M\",\"M7\"], 2:[\"m\",\"m7\"], 4:[\"m\",\"m7\"], 5:[\"M\",\"M7\"], 7:[\"M\",\"7\"], 9:[\"m\",\"m7\"], 11:[\"dim\",\"m7b5\"],\n};\nexport const DEG_QUAL_MINOR: Record<number, string[]> = {\n  0:[\"m\",\"m7\"], 2:[\"dim\",\"m7b5\"], 3:[\"M\",\"M7\"], 5:[\"m\",\"m7\"],\n  7:[\"m\",\"7\",\"M\",\"7\"], // v と V の両方を許容\n  8:[\"M\",\"M7\"], 10:[\"M\",\"7\"],\n};\n\ntype RankItem = { keyRoot: Pc; mode: Mode; label: string; score: number; pct: number };\n\nexport function rankKeys(chords: ChordSym[]): RankItem[] {\n  const parsed = chords.map(parseChord);\n  const candidates: {root:Pc; mode:Mode}[] = [];\n  for (let r=0;r<12;r++) candidates.push({root:r,mode:\"Major\"},{root:r,mode:\"Minor\"});\n\n  const maxPerChord = 3;\n  const bonuses = 3;\n  const denom = parsed.length * maxPerChord + bonuses;\n\n  const res = candidates.map(({root,mode})=>{\n    const table = mode===\"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n    let s = 0;\n    parsed.forEach((c,idx)=>{\n      const deg = (c.root - root + 12) % 12;\n      const expected = table[deg];\n      if (expected) {\n        if (expected.includes(c.qual)) s += 3; else s += 2;\n      } else {\n        const scale = mode===\"Major\" ? SCALESETS.ionian : SCALESETS.aeolian;\n        const inScale = c.tones.every(t => scale.includes((t - root + 12)%12));\n        if (inScale) s += 1;\n      }\n      if (idx>0) {\n        const prevDeg = (parsed[idx-1].root - root + 12) % 12;\n        // 五度下行（循環）を一般的に評価: a→b が完全5度下行（-7半音＝+5半音）\n        const fifthsDown = ((prevDeg - deg + 12) % 12) === 7;\n        if (fifthsDown) s += 1; // 五度下行ボーナス（ii→V, V→I, vi→ii, etc.）\n      }\n    });\n    const firstDeg = (parsed[0].root - root + 12) % 12;\n    if (mode===\"Major\" && (firstDeg===0 || firstDeg===9)) s += 2;\n    if (mode===\"Minor\" && (firstDeg===0 || firstDeg===3)) s += 2;\n    const pct = Math.round((s / Math.max(denom,1)) * 100);\n    const label = `${PITCHES_INTERNAL[root]} ${mode}`;\n    return { keyRoot:root, mode, label, score:s, pct };\n  });\n  return res.sort((a,b)=> b.score - a.score);\n}\n\nexport type ScaleRank = { keyRoot: Pc; name: string; label: string; pct: number; set: number[] };\n\n/**\n * getRecommendedScalesForQuality: 品質に応じた推奨スケールを返す\n * @param quality - コード品質（例: \"m7b5\", \"dim7\", \"7b9\"）\n * @returns 推奨スケール名の配列（優先順）\n */\nexport function getRecommendedScalesForQuality(quality: string): Array<{name: string; scaleKey: keyof typeof SCALESETS}> {\n  const q = resolveQuality(quality);\n  \n  switch (q) {\n    case 'm7b5': // Half-diminished: Locrian ♮2 優先\n      return [\n        {name: \"Locrian ♮2\", scaleKey: \"locrianNat2\"},\n        {name: \"Locrian\", scaleKey: \"locrian\"}\n      ];\n    case 'dim':\n    case 'dim7': // Diminished: Whole-Half 優先\n      return [\n        {name: \"Diminished (W-H)\", scaleKey: \"dimWholeHalf\"}\n      ];\n    case '7b9': // Dominant b9: Half-Whole 優先\n      return [\n        {name: \"Diminished (H-W)\", scaleKey: \"dimHalfWhole\"},\n        {name: \"Mixolydian ♭9♭13\", scaleKey: \"altered\"} // 近似\n      ];\n    case '7alt': // Altered dominant\n      return [\n        {name: \"Altered\", scaleKey: \"altered\"}\n      ];\n    case '7': // Dominant 7th\n      return [\n        {name: \"Mixolydian\", scaleKey: \"mixolydian\"},\n        {name: \"Lydian Dominant (Mixolydian ♯11)\", scaleKey: \"lydian\"}, // 近似\n        {name: \"Altered\", scaleKey: \"altered\"}\n      ];\n    default:\n      return [];\n  }\n}\n\nexport function rankScales(chords: ChordSym[], baseKey: {root:Pc; mode:Mode}): ScaleRank[] {\n  const tones = Array.from(new Set(chords.map(parseChord).flatMap(c=>c.tones)));\n  const root = baseKey.root;\n  const defs = baseKey.mode===\"Major\"\n    ? [[\"Major Scale\",\"ionian\"],[\"Major Pentatonic\",\"majPent\"],[\"Mixolydian Mode\",\"mixolydian\"],[\"Lydian Mode\",\"lydian\"]]\n    : [[\"Minor Scale\",\"aeolian\"],[\"Minor Pentatonic\",\"minPent\"],[\"Dorian Mode\",\"dorian\"],[\"Phrygian Mode\",\"phrygian\"],[\"Blues (min)\",\"bluesMin\"]];\n  return defs.map(([disp, key])=>{\n    const set = SCALESETS[key as keyof typeof SCALESETS].map(iv => transpose(root, iv));\n    const cover = tones.filter(t => set.includes(t)).length;\n    const pct = Math.round(100 * cover / Math.max(tones.length,1));\n    return { keyRoot:root, name: disp as string, label: `${PITCHES_INTERNAL[root]} ${disp}`, pct, set };\n  }).sort((a,b)=> b.pct - a.pct);\n}\n\n\n// --- P2-3: Analyzer utilities ---\nexport type KeyCandidate = { tonic: Pc; mode: Mode; confidence: number; reasons: string[] };\n\nconst DEGREE_MAP_MAJOR = {0:\"I\",2:\"II\",4:\"III\",5:\"IV\",7:\"V\",9:\"VI\",11:\"VII\"} as const;\nconst DEGREE_MAP_MINOR = {0:\"i\",2:\"ii\",3:\"III\",5:\"iv\",7:\"v\",8:\"VI\",10:\"VII\"} as const;\n\nexport function scoreKeyCandidates(prog: ChordSym[]): KeyCandidate[] {\n  const ranked = rankKeys(prog);\n  const top = ranked.slice(0,5);  // v3.1: 3→5候補に拡張（iOS UI改善）\n  return top.map((r)=>{\n    const key = { tonic: r.keyRoot, mode: r.mode } as const;\n    const cad = detectCadence(prog, key);\n    const reasons: string[] = [];\n    if (cad === \"perfect\") reasons.push(\"Cadence: V→I\");\n    if (cad === \"deceptive\") reasons.push(\"Cadence: V→vi\");\n    if (cad === \"half\") reasons.push(\"Cadence: …→V\");\n    reasons.unshift(`diatonic fit ${r.pct}%`);\n    return { tonic: r.keyRoot, mode: r.mode, confidence: r.pct, reasons };\n  });\n}\n\nexport function classifyChord(chord: ParsedChord, key: {tonic: Pc; mode: Mode}): \"diatonic\"|\"secondary\"|\"borrowed\"|\"outside\" {\n  const diatonic = ((): string[] => {\n    const tonicName = PITCHES_INTERNAL[key.tonic];\n    if (key.mode === \"Major\") {\n      const mk = (Key as any)?.majorKey ? (Key as any).majorKey(tonicName) : null;\n      return mk?.chords || [];\n    } else {\n      const nk = (Key as any)?.minorKey ? (Key as any).minorKey(tonicName) : null;\n      return nk?.natural?.chords || nk?.chords || [];\n    }\n  })();\n  const target = chord.root + (chord.triad === \"maj\" ? \"\" : chord.triad === \"min\" ? \"m\" : \"dim\");\n  if (diatonic.includes(target)) return \"diatonic\";\n  // secondary dominant: X7 targeting a diatonic\n  const isDomLike = chord.triad === \"maj\" || chord.isDominantLike;\n  if (isDomLike) {\n    for (let r=0;r<12;r++){\n      const deg = (r - key.tonic + 12) % 12;\n      const table = key.mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n      if (table[deg]){\n        const fifth = transpose(r, 7 as any);\n        if (chord.root === fifth) return \"secondary\";\n      }\n    }\n  }\n  // simple borrowed detection in major: iv, bVII, bVI roots\n  if (key.mode === \"Major\"){\n    const deg = (chord.root - key.tonic + 12) % 12;\n    if (deg === 5 && chord.triad === \"min\") return \"borrowed\"; // iv\n    if (deg === 10 || deg === 8) return \"borrowed\"; // bVII, bVI\n  }\n  return \"outside\";\n}\n\nexport function detectCadence(prog: ChordSym[], key: {tonic: Pc; mode: Mode}): \"perfect\"|\"deceptive\"|\"half\"|null {\n  if (prog.length < 2) return null;\n  const last = parseChord(prog[prog.length-1]);\n  const prev = parseChord(prog[prog.length-2]);\n  const degLast = (last.root - key.tonic + 12) % 12;\n  const degPrev = (prev.root - key.tonic + 12) % 12;\n  if (degPrev === 7 && degLast === 0) return \"perfect\"; // V→I\n  if (degPrev === 7 && (degLast === 9)) return \"deceptive\"; // V→vi\n  if (degLast === 7) return \"half\"; // …→V\n  return null;\n}\n\n// --- Roman Numeral to Chord Symbol Conversion ---\n\n// Roman numeral mapping: Roman表記から度数（0-11）と明示的品質を解析\nconst ROMAN_MAP: Record<string, {offset: number}> = {\n  'Ⅰ': {offset: 0}, 'ⅰ': {offset: 0},\n  'Ⅱ': {offset: 2}, 'ⅱ': {offset: 2},\n  '♭Ⅱ': {offset: 1}, '♭ⅱ': {offset: 1},\n  'Ⅲ': {offset: 4}, 'ⅲ': {offset: 4},\n  '♭Ⅲ': {offset: 3}, '♭ⅲ': {offset: 3},\n  'Ⅳ': {offset: 5}, 'ⅳ': {offset: 5},\n  '♯Ⅳ': {offset: 6}, '♯ⅳ': {offset: 6},\n  'Ⅴ': {offset: 7}, 'ⅴ': {offset: 7},\n  '♭Ⅵ': {offset: 8}, '♭ⅵ': {offset: 8},\n  'Ⅵ': {offset: 9}, 'ⅵ': {offset: 9},\n  '♭Ⅶ': {offset: 10}, '♭ⅶ': {offset: 10},\n  'Ⅶ': {offset: 11}, 'ⅶ': {offset: 11},\n};\n\n/**\n * parseRomanNumeral: Roman numeral表記から度数と明示的品質を分離\n * 例: \"Ⅱm7\" → {deg: 2, explicitQual: \"m7\"}\n *     \"Ⅴ\" → {deg: 7, explicitQual: null}\n *     \"♭Ⅶ\" → {deg: 10, explicitQual: null}\n */\nfunction parseRomanNumeral(roman: string): {deg: number; explicitQual: string | null} {\n  // Roman表記の本体と接尾辞を分離\n  // 例: \"Ⅱm7\" → base=\"Ⅱ\", suffix=\"m7\"\n  let base = roman;\n  let suffix = \"\";\n  \n  // Roman表記のパターンをチェック\n  for (const [romanKey, {offset}] of Object.entries(ROMAN_MAP)) {\n    if (roman.startsWith(romanKey)) {\n      base = romanKey;\n      suffix = roman.slice(romanKey.length).trim();\n      return {deg: offset, explicitQual: suffix || null};\n    }\n  }\n  \n  // マッチしない場合はエラー（または警告）\n  console.warn(`Unknown Roman numeral: ${roman}`);\n  return {deg: 0, explicitQual: null}; // デフォルトは I（tonic）\n}\n\n/**\n * defaultQualityForDegree: 度数とモードに基づいてダイアトニック品質を返す\n * 例: Major key の deg=2 → \"m\"（ii）\n *     Major key の deg=11 → \"dim\"（vii°）\n */\nfunction defaultQualityForDegree(deg: number, mode: Mode): string {\n  const table = mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n  const candidates = table[deg];\n  if (!candidates || candidates.length === 0) {\n    // ダイアトニックにない度数（借用和音など）は空（Major triad）をデフォルトに\n    return \"\";\n  }\n  // 第1候補（三和音）を返す\n  return candidates[0];\n}\n\n/**\n * romanToChordSymbol: Roman numeral → 実コードシンボル変換（文脈化版）\n * @param roman - Roman numeral表記（例: \"Ⅱm7\", \"♭Ⅶ\", \"Ⅴ7\"）\n * @param keyRoot - キーのルート（Pc: 0-11）\n * @param mode - Major or Minor\n * @returns コードシンボル（例: \"Dm7\", \"Bb\", \"G7\"）\n */\nexport function romanToChordSymbol(roman: string, keyRoot: Pc, mode: Mode): string {\n  const {deg, explicitQual} = parseRomanNumeral(roman);\n  \n  // 明示的品質がない場合、ダイアトニック品質を補完\n  const quality = explicitQual !== null ? explicitQual : defaultQualityForDegree(deg, mode);\n  \n  // ルート音を計算（キーの調号に応じて♯/♭を選択）\n  const rootPc = (keyRoot + deg) % 12;\n  const rootName = pcToNoteName(rootPc, keyRoot, mode);\n  \n  // コードシンボルを組み立て\n  return `${rootName}${quality}`;\n}\n\n/**\n * formatRomanForDisplay: 度数と品質から正しいRoman表記を生成（SSOT準拠: I, ii, iii, IV, V, vi, vii°）\n * @param degree - 度数（0-11）\n * @param quality - コード品質（例: \"\", \"m\", \"7\", \"m7\", \"dim\", \"m7b5\"）\n * @param mode - Major or Minor\n * @param keyRoot - キーのルート（表記方針の決定に使用）\n * @returns 表示用Roman numeral（例: \"ii\", \"V7\", \"vii°\"）\n */\nexport function formatRomanForDisplay(degree: number, quality: string, mode: Mode, keyRoot?: Pc): string {\n  // 度数をdiatonic度数にマッピング（0,2,4,5,7,9,11 のみ）\n  const diatonicDegrees: Record<number, number> = {\n    0: 1, 2: 2, 4: 3, 5: 4, 7: 5, 9: 6, 11: 7\n  };\n  \n  const romanNum = diatonicDegrees[degree];\n  if (!romanNum) {\n    // 非ダイアトニック度数（借用和音など）は変化記号付きで表示\n    if (degree === 1) return '♭Ⅱ' + quality; // ♭II\n    if (degree === 3) return '♭Ⅲ' + quality; // ♭III\n    if (degree === 6) return '♯Ⅳ' + quality; // #IV\n    if (degree === 8) return '♭Ⅵ' + quality; // ♭VI\n    if (degree === 10) return '♭Ⅶ' + quality; // ♭VII\n    return '?'; // 不明\n  }\n  \n  // 品質から大文字/小文字を決定\n  const isMinor = quality.startsWith('m') && !quality.startsWith('maj');\n  const isDim = quality.includes('dim') || quality.includes('°') || quality === 'm7b5' || quality === 'ø';\n  \n  // ダイアトニック品質を参照して大文字/小文字を決定\n  const table = mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n  const expectedQuals = table[degree];\n  const isDiatonicMinor = expectedQuals?.some(q => q === 'm' || q === 'm7');\n  const isDiatonicDim = expectedQuals?.some(q => q === 'dim' || q === 'm7b5');\n  \n  // Roman数字の基本形\n  const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];\n  let romanBase = romanNumerals[romanNum - 1];\n  \n  // SSOT準拠: I, ii, iii, IV, V, vi, vii°\n  // Major key: I, ii, iii, IV, V, vi, vii°\n  // Minor key: i, ii°, III, iv, v/V, VI, VII\n  \n  if (mode === \"Major\") {\n    // I, IV, V は大文字、ii, iii, vi は小文字、vii° は小文字+°\n    if ([1, 4, 5].includes(romanNum) && !isMinor && !isDim) {\n      romanBase = romanBase; // 大文字のまま\n    } else if (isDim || isDiatonicDim) {\n      romanBase = romanBase.toLowerCase() + '°'; // vii°\n    } else {\n      romanBase = romanBase.toLowerCase(); // ii, iii, vi\n    }\n  } else {\n    // Minor key: i, ii°, III, iv, v/V, VI, VII\n    if ([3, 6, 7].includes(romanNum) && !isMinor && !isDim) {\n      romanBase = romanBase; // III, VI, VII は大文字\n    } else if (romanNum === 5) {\n      // v と V の両方あり（harmonic minor の V）\n      romanBase = isMinor ? 'v' : 'V';\n    } else if (isDim || isDiatonicDim) {\n      romanBase = romanBase.toLowerCase() + '°'; // ii°\n    } else {\n      romanBase = romanBase.toLowerCase(); // i, iv\n    }\n  }\n  \n  // 7thなどの拡張を追加（dim以外）\n  let extension = '';\n  if (!isDim && quality && quality !== 'm' && quality !== '') {\n    // 7, M7, m7, sus4などをそのまま付加\n    extension = quality.replace('m', '').replace('M', 'maj'); // m7 → 7, M7 → maj7\n    if (isMinor && extension.startsWith('7')) {\n      // マイナーコードの場合、m7 → 7 と表示（既に小文字で示されているため）\n      extension = extension;\n    }\n  }\n  \n  return romanBase + extension;\n}\n\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 2905, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/diatonic.ts"],"sourcesContent":["import { type Pc } from \"@/lib/theory\";\n\nexport type TriadQuality = 'maj'|'min'|'dim'|'aug';\n\nexport type DiatonicTriad = {\n  degree: 1|2|3|4|5|6|7;\n  rootPc: Pc;\n  pcs: [Pc, Pc, Pc]; // root, third, fifth (0..11)\n  quality: TriadQuality;\n};\n\n// Build 7 diatonic triads from scale intervals (e.g. Ionian [0,2,4,5,7,9,11])\nexport function diatonicTriads({ tonicPc, scaleIntervals }:{ tonicPc: Pc; scaleIntervals: number[] }): DiatonicTriad[] {\n  const pcs = scaleIntervals.map(iv => (tonicPc + iv + 120) % 12);\n  const triads: DiatonicTriad[] = [];\n  for (let i = 0; i < 7; i++) {\n    const deg = (i % 7) as 0|1|2|3|4|5|6;\n    const r = pcs[deg];\n    const t = pcs[(deg + 2) % 7];\n    const f = pcs[(deg + 4) % 7];\n    const q = qualityOfTriad(r, t, f);\n    triads.push({ degree: (i+1) as 1|2|3|4|5|6|7, rootPc: r, pcs: [r,t,f], quality: q });\n  }\n  return triads;\n}\n\nfunction qualityOfTriad(r: number, t: number, f: number): TriadQuality {\n  // intervals from root in semitones (mod 12)\n  const third = (t - r + 12) % 12;\n  const fifth = (f - r + 12) % 12;\n  if (third === 4 && fifth === 7) return 'maj';\n  if (third === 3 && fifth === 7) return 'min';\n  if (third === 3 && fifth === 6) return 'dim';\n  if (third === 4 && fifth === 8) return 'aug';\n  // fallback: closest common qualities\n  if (fifth === 6) return 'dim';\n  if (fifth === 8) return 'aug';\n  return third < 4 ? 'min' : 'maj';\n}\n\nconst ROMAN_UP = [\"I\",\"II\",\"III\",\"IV\",\"V\",\"VI\",\"VII\"] as const;\n\nexport function romanOfTriad(degree: 1|2|3|4|5|6|7, quality: TriadQuality, opts?: { case?: 'upper'|'quality' }): string {\n  const base = ROMAN_UP[degree - 1];\n  const mode = opts?.case ?? 'upper';\n  if (mode === 'upper') {\n    // Always uppercase; add dimin./aug symbols\n    if (quality === 'dim') return base + '°';\n    if (quality === 'aug') return base + '+';\n    return base;\n  }\n  // case: 'quality' → major uppercase, minor lowercase, diminished lowercase+°\n  if (quality === 'min') return base.toLowerCase();\n  if (quality === 'dim') return base.toLowerCase() + '°';\n  if (quality === 'aug') return base + '+';\n  return base; // maj\n}\n\n// Convert a triad (rootPc + quality) to a simple chord symbol (e.g., C, Cm, Cdim, C+)\nconst PC_TO_NAME = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'] as const;\nexport function triadToChordSym(t: { rootPc: Pc; quality: TriadQuality }): string {\n  const root = PC_TO_NAME[t.rootPc % 12];\n  if (t.quality === 'maj') return root;\n  if (t.quality === 'min') return root + 'm';\n  if (t.quality === 'dim') return root + 'dim';\n  return root + '+'; // aug\n}\n\n\n"],"names":[],"mappings":";;;;;;;;AAYO,SAAS,eAAe,KAAqE;QAArE,EAAE,OAAO,EAAE,cAAc,EAA4C,GAArE;IAC7B,MAAM,MAAM,eAAe,GAAG,CAAC,CAAA,KAAM,CAAC,UAAU,KAAK,GAAG,IAAI;IAC5D,MAAM,SAA0B,EAAE;IAClC,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;QAC1B,MAAM,MAAO,IAAI;QACjB,MAAM,IAAI,GAAG,CAAC,IAAI;QAClB,MAAM,IAAI,GAAG,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE;QAC5B,MAAM,IAAI,GAAG,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE;QAC5B,MAAM,IAAI,eAAe,GAAG,GAAG;QAC/B,OAAO,IAAI,CAAC;YAAE,QAAS,IAAE;YAAqB,QAAQ;YAAG,KAAK;gBAAC;gBAAE;gBAAE;aAAE;YAAE,SAAS;QAAE;IACpF;IACA,OAAO;AACT;AAEA,SAAS,eAAe,CAAS,EAAE,CAAS,EAAE,CAAS;IACrD,4CAA4C;IAC5C,MAAM,QAAQ,CAAC,IAAI,IAAI,EAAE,IAAI;IAC7B,MAAM,QAAQ,CAAC,IAAI,IAAI,EAAE,IAAI;IAC7B,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,qCAAqC;IACrC,IAAI,UAAU,GAAG,OAAO;IACxB,IAAI,UAAU,GAAG,OAAO;IACxB,OAAO,QAAQ,IAAI,QAAQ;AAC7B;AAEA,MAAM,WAAW;IAAC;IAAI;IAAK;IAAM;IAAK;IAAI;IAAK;CAAM;AAE9C,SAAS,aAAa,MAAqB,EAAE,OAAqB,EAAE,IAAmC;IAC5G,MAAM,OAAO,QAAQ,CAAC,SAAS,EAAE;QACpB;IAAb,MAAM,OAAO,CAAA,aAAA,iBAAA,2BAAA,KAAM,IAAI,cAAV,wBAAA,aAAc;IAC3B,IAAI,SAAS,SAAS;QACpB,2CAA2C;QAC3C,IAAI,YAAY,OAAO,OAAO,OAAO;QACrC,IAAI,YAAY,OAAO,OAAO,OAAO;QACrC,OAAO;IACT;IACA,6EAA6E;IAC7E,IAAI,YAAY,OAAO,OAAO,KAAK,WAAW;IAC9C,IAAI,YAAY,OAAO,OAAO,KAAK,WAAW,KAAK;IACnD,IAAI,YAAY,OAAO,OAAO,OAAO;IACrC,OAAO,MAAM,MAAM;AACrB;AAEA,sFAAsF;AACtF,MAAM,aAAa;IAAC;IAAI;IAAK;IAAI;IAAK;IAAI;IAAI;IAAK;IAAI;IAAK;IAAI;IAAK;CAAI;AAClE,SAAS,gBAAgB,CAAwC;IACtE,MAAM,OAAO,UAAU,CAAC,EAAE,MAAM,GAAG,GAAG;IACtC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO;IAChC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO,OAAO;IACvC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO,OAAO;IACvC,OAAO,OAAO,KAAK,MAAM;AAC3B","debugId":null}},
    {"offset": {"line": 3003, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/roman.ts"],"sourcesContent":["// Roman numeral utilities for chord degree display\n// Mode and functions are intentionally minimal and self-contained.\n\nimport { PITCHES, noteToPc } from \"../theory\";\n\nexport type Mode = \"major\" | \"minor\";\n\n// Ionian/Aeolian degree maps → roman index\nconst DEGREE_TO_INDEX_MAJOR: Record<number, number> = {\n  0: 0, // I\n  2: 1, // ii\n  4: 2, // iii\n  5: 3, // IV\n  7: 4, // V\n  9: 5, // vi\n  11: 6, // vii°\n};\n\nconst DEGREE_TO_INDEX_MINOR: Record<number, number> = {\n  0: 0,  // i\n  2: 1,  // ii°\n  3: 2,  // III\n  5: 3,  // iv\n  7: 4,  // v\n  8: 5,  // VI\n  10: 6, // VII\n};\n\nexport const ROMAN_NUMERALS_MAJOR = [\"I\", \"ii\", \"iii\", \"IV\", \"V\", \"vi\", \"vii°\"] as const;\nexport const ROMAN_NUMERALS_MINOR = [\"i\", \"ii°\", \"III\", \"iv\", \"v\", \"VI\", \"VII\"] as const;\n\nfunction isMaj7(sym: string): boolean {\n  return /maj7|M7/.test(sym);\n}\n\nfunction hasGeneric7(sym: string): boolean {\n  // append \"7\" for dominant/mi7 etc. but avoid maj7 and m7b5/dim7\n  if (isMaj7(sym)) return false;\n  if (/m7b5|ø|dim7/.test(sym)) return false;\n  return /(\\b|[^a-zA-Z])7(?![b#0-9])/i.test(sym) || /\\bm7\\b/i.test(sym);\n}\n\nfunction normalizePcName(input: string): string {\n  const pc = noteToPc(input);\n  return PITCHES[pc] ?? input;\n}\n\ntype RomanOptions = {\n  showQuality?: boolean; // append M7/7 markers\n  accidentalsForNonDiatonic?: boolean; // prefer bII/#iv instead of (F#)\n  uppercase?: boolean; // force uppercase numerals\n};\n\nexport function toRoman(chordSym: string, keyRoot: string, mode: Mode, opts: RomanOptions = {}): string {\n  // Default: prefer diatonic mapping; only use accidentals when明示\n  const { showQuality = true, accidentalsForNonDiatonic = false } = opts;\n  if (!chordSym || !keyRoot) return \"\";\n  const keyPc = noteToPc(keyRoot);\n\n  // Parse root (head of symbol, before slash)\n  const head = chordSym.split(\"/\")[0];\n  const m = head.match(/^([A-G](?:#|b)?)(.*)$/i);\n  if (!m) return chordSym;\n  const chordRoot = normalizePcName(m[1].toUpperCase());\n  const rest = (m[2] || \"\");\n\n  const deg = (noteToPc(chordRoot) - keyPc + 12) % 12;\n\n  const degreeTable = mode === \"major\" ? DEGREE_TO_INDEX_MAJOR : DEGREE_TO_INDEX_MINOR;\n  const romanBase = mode === \"major\" ? ROMAN_NUMERALS_MAJOR : ROMAN_NUMERALS_MINOR;\n  const romanUpper = [\"I\",\"II\",\"III\",\"IV\",\"V\",\"VI\",\"VII\"] as const;\n  const idx = degreeTable[deg as keyof typeof degreeTable] as number | undefined;\n\n  if (idx !== undefined) {\n    let roman = (opts.uppercase ? romanUpper[idx] : romanBase[idx]) as string;\n    // preserve diminished mark when forcing uppercase\n    if (opts.uppercase) {\n      if ((mode === \"major\" && idx === 6) || (mode === \"minor\" && idx === 1)) {\n        roman += \"°\";\n      }\n    }\n    if (!showQuality) return roman;\n    if (isMaj7(rest)) return roman + \"M7\";\n    if (hasGeneric7(rest)) return roman + \"7\";\n    return roman;\n  }\n\n  // Try single-step accidentals (# or b) relative to scale degrees\n  if (accidentalsForNonDiatonic) {\n    const scale = mode === \"major\" ? [0,2,4,5,7,9,11] : [0,2,3,5,7,8,10];\n    for (let j = 0; j < scale.length; j++) {\n      const s = scale[j];\n      if ((s + 1) % 12 === deg) {\n        return \"#\" + romanBase[j];\n      }\n      if ((s + 11) % 12 === deg) { // s - 1\n        return \"b\" + romanBase[j];\n      }\n    }\n  }\n  // Fallback: actual root\n  return `(${chordRoot})`;\n}\n\nexport function progressionToRoman(\n  chords: string[],\n  keyRoot: string,\n  mode: Mode\n): string[] {\n  return chords.map((c) => toRoman(c, keyRoot, mode));\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3149, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/analysis/scoreScales.ts"],"sourcesContent":["import type { Pc, Mode, ChordSym } from \"../theory\";\nimport { parseChord } from \"../theory\";\nimport { getScalePitches, type ScaleType } from \"../scales\";\n\nexport type ScaleCandidate = {\n  root: Pc;\n  type: ScaleType;\n  score: number; // 0..100\n  reasons?: string[];\n};\n\nconst CANDIDATE_TYPES_MAJOR: ScaleType[] = [\n  \"Ionian\",\n  \"Lydian\",\n  \"Mixolydian\",\n  \"MajorPentatonic\",\n];\nconst CANDIDATE_TYPES_MINOR: ScaleType[] = [\n  \"Aeolian\",\n  \"Dorian\",\n  \"Phrygian\",\n  \"HarmonicMinor\",\n  \"MelodicMinor\",\n  \"MinorPentatonic\",\n];\n\nfunction uniq<T>(arr: T[]): T[] {\n  return Array.from(new Set(arr));\n}\n\nexport function scoreScales(\n  prog: ChordSym[],\n  key: { root: Pc; mode: Mode }\n): ScaleCandidate[] {\n  const types = key.mode === \"Major\" ? CANDIDATE_TYPES_MAJOR : CANDIDATE_TYPES_MINOR;\n  const chordPcs = uniq(\n    prog.flatMap((ch) => {\n      const p = parseChord(ch);\n      const thirds = p.qual.includes(\"m\") ? 3 : 4;\n      const sevenths = p.qual.includes(\"7\") ? (p.qual.includes(\"M7\") ? 11 : 10) : null;\n      const pcs = [p.root % 12, (p.root + thirds) % 12, (p.root + 7) % 12];\n      if (sevenths !== null) pcs.push((p.root + sevenths) % 12);\n      return pcs;\n    })\n  );\n\n  const hasV7 = prog.some((ch) => /7\\b/.test(ch));\n\n  return types\n    .map<ScaleCandidate>((type) => {\n      const scale = getScalePitches(key.root, type);\n      const hit = chordPcs.filter((pc) => scale.includes(pc)).length;\n      const cover = hit / Math.max(1, chordPcs.length);\n      // ---- bonuses (max total 0.05) ----\n      let bonus = 0;\n      if (key.mode === \"Major\" && type === \"Ionian\") bonus += 0.02;\n      if (key.mode === \"Minor\" && type === \"Aeolian\") bonus += 0.02;\n      if (hasV7 && (type === \"HarmonicMinor\" || type === \"MelodicMinor\")) bonus += 0.03;\n      const raw = Math.min(1, cover + bonus);\n      const score = Math.round(raw * 100);\n      return { root: key.root, type, score };\n    })\n    .sort((a, b) => b.score - a.score);\n}\n\n\n"],"names":[],"mappings":";;;;AACA;AACA;;;AASA,MAAM,wBAAqC;IACzC;IACA;IACA;IACA;CACD;AACD,MAAM,wBAAqC;IACzC;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS,KAAQ,GAAQ;IACvB,OAAO,MAAM,IAAI,CAAC,IAAI,IAAI;AAC5B;AAEO,SAAS,YACd,IAAgB,EAChB,GAA6B;IAE7B,MAAM,QAAQ,IAAI,IAAI,KAAK,UAAU,wBAAwB;IAC7D,MAAM,WAAW,KACf,KAAK,OAAO,CAAC,CAAC;QACZ,MAAM,IAAI,IAAA,qJAAU,EAAC;QACrB,MAAM,SAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAO,IAAI;QAC1C,MAAM,WAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,QAAQ,KAAK,KAAM;QAC5E,MAAM,MAAM;YAAC,EAAE,IAAI,GAAG;YAAI,CAAC,EAAE,IAAI,GAAG,MAAM,IAAI;YAAI,CAAC,EAAE,IAAI,GAAG,CAAC,IAAI;SAAG;QACpE,IAAI,aAAa,MAAM,IAAI,IAAI,CAAC,CAAC,EAAE,IAAI,GAAG,QAAQ,IAAI;QACtD,OAAO;IACT;IAGF,MAAM,QAAQ,KAAK,IAAI,CAAC,CAAC,KAAO,MAAM,IAAI,CAAC;IAE3C,OAAO,MACJ,GAAG,CAAiB,CAAC;QACpB,MAAM,QAAQ,IAAA,0IAAe,EAAC,IAAI,IAAI,EAAE;QACxC,MAAM,MAAM,SAAS,MAAM,CAAC,CAAC,KAAO,MAAM,QAAQ,CAAC,KAAK,MAAM;QAC9D,MAAM,QAAQ,MAAM,KAAK,GAAG,CAAC,GAAG,SAAS,MAAM;QAC/C,qCAAqC;QACrC,IAAI,QAAQ;QACZ,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS,UAAU,SAAS;QACxD,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS,WAAW,SAAS;QACzD,IAAI,SAAS,CAAC,SAAS,mBAAmB,SAAS,cAAc,GAAG,SAAS;QAC7E,MAAM,MAAM,KAAK,GAAG,CAAC,GAAG,QAAQ;QAChC,MAAM,QAAQ,KAAK,KAAK,CAAC,MAAM;QAC/B,OAAO;YAAE,MAAM,IAAI,IAAI;YAAE;YAAM;QAAM;IACvC,GACC,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;AACrC","debugId":null}},
    {"offset": {"line": 3214, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/roman.ts"],"sourcesContent":["import { degreeLabelFor, parentModeOf, getScalePitches, type ScaleType } from \"@/lib/scales\";\nimport { parseChord, type ChordSym } from \"@/lib/theory\";\n\nconst ROMAN_UPPER = [\"I\",\"II\",\"III\",\"IV\",\"V\",\"VI\",\"VII\"] as const;\n\nfunction baseRomanFromDegreeLabel(lbl: string | null): string {\n  if (!lbl) return \"I\";\n  const n = Number(lbl.replace(/[♭#]/g, \"\"));\n  const idx = isFinite(n) ? Math.max(1, Math.min(7, n)) - 1 : 0;\n  return ROMAN_UPPER[idx];\n}\n\nfunction qualitySuffix(qual: string): string { return /7/.test(qual) ? \"7\" : \"\"; }\nfunction diminishedSymbol(qual: string): string { return /dim|o/.test(qual) ? \"°\" : \"\"; }\n\nexport function romanizeChord(\n  chord: ChordSym,\n  tonicPc: number,\n  scaleType: ScaleType\n): string {\n  const { root, qual } = parseChord(chord);\n  const effectiveType = parentModeOf(scaleType) ?? scaleType;\n  // try exact degree label first\n  let lbl = degreeLabelFor(root, tonicPc, effectiveType);\n  let accidental = lbl?.startsWith(\"♭\") ? \"♭\" : lbl?.startsWith(\"#\") ? \"♯\" : \"\";\n  // if null, try ±1 semitone nearest mapping\n  if (!lbl) {\n    const pcs = getScalePitches(tonicPc, effectiveType); // absolute pcs\n    const minus = (root + 12 - 1) % 12;\n    const plus = (root + 1) % 12;\n    const idxMinus = pcs.indexOf(minus);\n    const idxPlus = pcs.indexOf(plus);\n    if (idxMinus !== -1) {\n      lbl = degreeLabelFor(minus, tonicPc, effectiveType); // e.g., \"3\"\n      accidental = \"♭\";\n    } else if (idxPlus !== -1) {\n      lbl = degreeLabelFor(plus, tonicPc, effectiveType);\n      accidental = \"♯\";\n    }\n  }\n  const base = baseRomanFromDegreeLabel(lbl);\n  const sym = diminishedSymbol(qual);\n  const suf = qualitySuffix(qual);\n  return `${accidental}${base}${sym}${suf}`;\n}\n\nexport function progressionToRoman(\n  chords: ChordSym[],\n  tonicPc: number,\n  scaleType: ScaleType\n): string[] {\n  return chords.map((c) => romanizeChord(c, tonicPc, scaleType));\n}\n\n\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,cAAc;IAAC;IAAI;IAAK;IAAM;IAAK;IAAI;IAAK;CAAM;AAExD,SAAS,yBAAyB,GAAkB;IAClD,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,IAAI,OAAO,IAAI,OAAO,CAAC,SAAS;IACtC,MAAM,MAAM,SAAS,KAAK,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,GAAG,MAAM,IAAI;IAC5D,OAAO,WAAW,CAAC,IAAI;AACzB;AAEA,SAAS,cAAc,IAAY;IAAY,OAAO,IAAI,IAAI,CAAC,QAAQ,MAAM;AAAI;AACjF,SAAS,iBAAiB,IAAY;IAAY,OAAO,QAAQ,IAAI,CAAC,QAAQ,MAAM;AAAI;AAEjF,SAAS,cACd,KAAe,EACf,OAAe,EACf,SAAoB;IAEpB,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,IAAA,qJAAU,EAAC;QACZ;IAAtB,MAAM,gBAAgB,CAAA,gBAAA,IAAA,uIAAY,EAAC,wBAAb,2BAAA,gBAA2B;IACjD,+BAA+B;IAC/B,IAAI,MAAM,IAAA,yIAAc,EAAC,MAAM,SAAS;IACxC,IAAI,aAAa,CAAA,gBAAA,0BAAA,IAAK,UAAU,CAAC,QAAO,MAAM,CAAA,gBAAA,0BAAA,IAAK,UAAU,CAAC,QAAO,MAAM;IAC3E,2CAA2C;IAC3C,IAAI,CAAC,KAAK;QACR,MAAM,MAAM,IAAA,0IAAe,EAAC,SAAS,gBAAgB,eAAe;QACpE,MAAM,QAAQ,CAAC,OAAO,KAAK,CAAC,IAAI;QAChC,MAAM,OAAO,CAAC,OAAO,CAAC,IAAI;QAC1B,MAAM,WAAW,IAAI,OAAO,CAAC;QAC7B,MAAM,UAAU,IAAI,OAAO,CAAC;QAC5B,IAAI,aAAa,CAAC,GAAG;YACnB,MAAM,IAAA,yIAAc,EAAC,OAAO,SAAS,gBAAgB,YAAY;YACjE,aAAa;QACf,OAAO,IAAI,YAAY,CAAC,GAAG;YACzB,MAAM,IAAA,yIAAc,EAAC,MAAM,SAAS;YACpC,aAAa;QACf;IACF;IACA,MAAM,OAAO,yBAAyB;IACtC,MAAM,MAAM,iBAAiB;IAC7B,MAAM,MAAM,cAAc;IAC1B,OAAO,AAAC,GAAe,OAAb,YAAoB,OAAP,MAAa,OAAN,KAAU,OAAJ;AACtC;AAEO,SAAS,mBACd,MAAkB,EAClB,OAAe,EACf,SAAoB;IAEpB,OAAO,OAAO,GAAG,CAAC,CAAC,IAAM,cAAc,GAAG,SAAS;AACrD","debugId":null}},
    {"offset": {"line": 3282, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/capo/recommend.ts"],"sourcesContent":["// Capo recommendation utilities\n// Heuristic scoring favoring open-string friendly shapes\n\nexport type KeySel = { tonic: number; mode: 'major'|'minor'|'Major'|'Minor' };\nexport type ScaleSel = { type: string; tonic?: number };\n\nexport function classifyScaleFlavor(scaleType: string): 'majorish'|'minorish' {\n  const maj = ['Major','Ionian','Lydian','Mixolydian','Major Pentatonic'];\n  const t = scaleType.toLowerCase();\n  for (const s of maj) if (t.includes(s.toLowerCase())) return 'majorish';\n  return 'minorish';\n}\n\n// Open-chord ease per family (I..VII)\nconst MAJOR_FAMILY_SCORES: Record<'C'|'G'|'D'|'A'|'E', number[]> = {\n  C: [3,3,3,1,3,3,0],\n  G: [3,3,1,3,3,3,0],\n  D: [3,3,1,3,3,1,0],\n  A: [3,1,1,3,2,1,0],\n  E: [3,1,0,3,1,1,0],\n};\n\nconst MINOR_FAMILY_SCORES: Record<'Am'|'Em'|'Dm', number[]> = {\n  Am: [3,0,3,3,3,1,3],\n  Em: [3,0,3,3,1,3,3],\n  Dm: [3,0,1,0,3,0,3],\n};\n\nfunction fretWeight(n: number) {\n  if (n <= 5) return 1.0;\n  if (n <= 7) return 0.92;\n  if (n <= 9) return 0.82;\n  return 0.7;\n}\n\nexport function transposeDown(pc: number, n: number) {\n  return ((pc - n) % 12 + 12) % 12;\n}\n\nexport type CapoPick = {\n  capo: number;\n  playAs: string;\n  score: number;\n  reasons: string[];\n};\n\nconst NATURAL_NAME: Record<number,string> = {\n  0:'C',1:'C#',2:'D',3:'Eb',4:'E',5:'F',6:'F#',7:'G',8:'Ab',9:'A',10:'Bb',11:'B'\n};\n\nexport function recommendCapos(key: KeySel, scale: ScaleSel, topN = 3, opts: { includeOpen?: boolean } = {}): CapoPick[] {\n  const includeOpen = opts.includeOpen ?? true;\n  const flavor = classifyScaleFlavor(scale.type);\n  const picks: CapoPick[] = [];\n\n  for (let n = 0; n <= 11; n++) {\n    if (!includeOpen && n === 0) continue;\n    const shapedPc = transposeDown(key.tonic, n);\n    const name = NATURAL_NAME[shapedPc];\n    if (flavor === 'majorish') {\n      const famMap: Record<string, keyof typeof MAJOR_FAMILY_SCORES> = { C:'C', G:'G', D:'D', A:'A', E:'E' };\n      const fam = famMap[name];\n      if (!fam) continue;\n      const base = MAJOR_FAMILY_SCORES[fam].reduce((a,b)=>a+b,0);\n      const bonus = (MAJOR_FAMILY_SCORES[fam][0] >= 2 && MAJOR_FAMILY_SCORES[fam][3] >= 2 && MAJOR_FAMILY_SCORES[fam][4] >= 2) ? 2 : 0;\n      const score = (base + bonus) * fretWeight(n);\n      picks.push({ capo: n, playAs: fam, score, reasons: [ `I–IV–V ${bonus? '◎':'○'}`, `open ${base}/16`, n===0? 'open' : `capo ${n}` ]});\n    } else {\n      const famMap: Record<string, keyof typeof MINOR_FAMILY_SCORES> = { A:'Am', E:'Em', D:'Dm' };\n      const fam = famMap[name];\n      if (!fam) continue;\n      const base = MINOR_FAMILY_SCORES[fam].reduce((a,b)=>a+b,0);\n      const bonus = (MINOR_FAMILY_SCORES[fam][0] >= 2 && MINOR_FAMILY_SCORES[fam][3] >= 2) ? 2 : 0;\n      const score = (base + bonus) * fretWeight(n);\n      picks.push({ capo: n, playAs: fam, score, reasons: [ `i–iv ${bonus? '◎':'○'}`, `open ${base}/16`, n===0? 'open' : `capo ${n}` ]});\n    }\n  }\n\n  return picks.sort((a,b)=> b.score-a.score).slice(0, topN);\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3469, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/store/analysisStore.ts"],"sourcesContent":["import { create } from \"zustand\";\nimport { type Pc, type Mode, type ChordSym, scoreKeyCandidates } from \"@/lib/theory\";\nimport { scoreScales, type ScaleCandidate } from \"@/lib/analysis/scoreScales\";\nimport { progressionToRoman } from \"@/lib/roman\";\nimport { SCALE_INTERVALS, type ScaleType, parentModeOf } from \"@/lib/scales\";\nimport { diatonicTriads, romanOfTriad } from \"@/lib/theory/diatonic\";\nimport type { CapoOption } from \"@/lib/theory/capo\";\nimport { recommendCapos, type CapoPick } from \"@/lib/capo/recommend\";\n// Type-only import for ScaleId; using relative alias path per tsconfig\n// Avoid type import resolution issue in some toolchains by using a relative path string literal type\ntype ScaleId = 'major'|'natural_minor'|'mixolydian'|'lydian'|'major_pentatonic'|'minor_pentatonic';\n\nexport type Candidate = { tonic: Pc; mode: Mode; confidence: number; reasons: string[] };\nexport type FitTag = \"diatonic\"|\"secondary\"|\"borrowed\"|\"outside\";\nexport type ViewMode = \"sounding\"|\"shaped\"|\"compare\";\n\ntype AnalysisState = {\n  keyCandidates: Candidate[];\n  selectedKey?: { tonic: Pc; mode: Mode };\n  analysis?: { cadence?: string; perChordFit?: FitTag[] };\n  capo: { capo: number; shapedKey: string } | null;\n  viewMode: ViewMode;\n  scaleCandidates: ScaleCandidate[];\n  selectedScale: ScaleCandidate | null;\n  lastProg?: ChordSym[];\n  analyze: (prog: ChordSym[]) => void;\n  selectKey: (key: {tonic: Pc; mode: Mode}) => void;\n  selectScale: (s: ScaleCandidate) => void;\n  chooseCapo: (option: CapoOption) => void;\n  setViewMode: (v: ViewMode) => void;\n  reset: () => void;\n  romanTokens: string[];\n  romanText: string;\n  diatonic: { triads: ReturnType<typeof diatonicTriads>; romans: string[] } | null;\n  recommendedCapos: CapoPick[];\n};\n\nexport const useAnalysisStore = create<AnalysisState>((set, get) => ({\n  keyCandidates: [],\n  capo: null,\n  viewMode: \"sounding\",\n  scaleCandidates: [],\n  selectedScale: null,\n  romanTokens: [],\n  romanText: \"\",\n  diatonic: null,\n  recommendedCapos: [],\n  analyze: (prog) => {\n    set((state)=>{\n      const cands = scoreKeyCandidates(prog);\n      // 既存選択がある場合でも、トップ候補と±4pt以上差があればトップへ切替（誤維持防止）\n      const top = cands[0];\n      const keep = state.selectedKey && cands.find(c=> c.tonic===state.selectedKey!.tonic && c.mode===state.selectedKey!.mode);\n      const shouldKeep = (()=>{\n        if (!keep || !top) return false;\n        const diff = Math.abs((keep.confidence||0) - (top.confidence||0));\n        return diff < 4; // 近差のみ維持\n      })();\n      const nextSel = (shouldKeep && state.selectedKey) ? state.selectedKey : (top ? { tonic: top.tonic, mode: top.mode } : undefined);\n      const sc = nextSel ? scoreScales(prog, { root: nextSel.tonic, mode: nextSel.mode }) : [];\n      const selScale = sc[0] ?? null;\n      const romanTokens = nextSel && selScale ? progressionToRoman(prog, nextSel.tonic, selScale.type) : [];\n      const diatonic = (()=>{\n        if (!nextSel || !selScale) return null;\n        const tonic = nextSel.tonic;\n        let st = selScale.type as ScaleType;\n        let intervals = SCALE_INTERVALS[st] ?? [];\n        if (intervals.length < 7) {\n          const parent = parentModeOf(st);\n          if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n        }\n        if (!intervals.length) return null;\n        const triads = diatonicTriads({ tonicPc: tonic, scaleIntervals: intervals });\n        const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n        return { triads, romans };\n      })();\n      const recommendedCapos = nextSel && selScale ? recommendCapos({ tonic: nextSel.tonic as any, mode: nextSel.mode as any }, { type: selScale.type as any }, 3, { includeOpen: false }) : [];\n      return { keyCandidates: cands, selectedKey: nextSel, scaleCandidates: sc, selectedScale: selScale, lastProg: prog, romanTokens, romanText: romanTokens.join(\" – \"), diatonic, recommendedCapos } as Partial<AnalysisState> as AnalysisState;\n    });\n  },\n  selectKey: (key) => set((state)=>{\n    const prog = state.lastProg ?? [];\n    const sc = scoreScales(prog, { root: key.tonic, mode: key.mode });\n    const selScale = sc[0] ?? null;\n    const romanTokens = selScale ? progressionToRoman(prog, key.tonic, selScale.type) : [];\n    const diatonic = (()=>{\n      if (!selScale) return null;\n      let st = selScale.type as ScaleType;\n      let intervals = SCALE_INTERVALS[st] ?? [];\n      if (intervals.length < 7) {\n        const parent = parentModeOf(st);\n        if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n      }\n      if (!intervals.length) return null;\n      const triads = diatonicTriads({ tonicPc: key.tonic, scaleIntervals: intervals });\n      const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n      return { triads, romans };\n    })();\n    const recommendedCapos = selScale ? recommendCapos({ tonic: key.tonic as any, mode: key.mode as any }, { type: selScale.type as any }, 3, { includeOpen: false }) : [];\n    return { selectedKey: key, scaleCandidates: sc, selectedScale: selScale, romanTokens, romanText: romanTokens.join(\" – \"), diatonic, recommendedCapos };\n  }),\n  selectScale: (s) => set((state)=>{\n    const prog = state.lastProg ?? [];\n    const key = state.selectedKey;\n    const tokens = prog.length && key ? progressionToRoman(prog, key.tonic, s.type) : [];\n    const diatonic = (()=>{\n      if (!key) return null;\n      let st = s.type as ScaleType;\n      let intervals = SCALE_INTERVALS[st] ?? [];\n      if (intervals.length < 7) {\n        const parent = parentModeOf(st);\n        if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n      }\n      if (!intervals.length) return null;\n      const triads = diatonicTriads({ tonicPc: key.tonic, scaleIntervals: intervals });\n      const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n      return { triads, romans };\n    })();\n    const recommendedCapos = key ? recommendCapos({ tonic: key.tonic as any, mode: key.mode as any }, { type: s.type as any }, 3, { includeOpen: false }) : [];\n    return { selectedScale: s, romanTokens: tokens, romanText: tokens.join(\" – \"), diatonic, recommendedCapos };\n  }),\n  chooseCapo: (option) => set({ capo: { capo: option.capo, shapedKey: option.shapedKey } }),\n  setViewMode: (v) => set({ viewMode: v }),\n  reset: () => set({ keyCandidates: [], selectedKey: undefined, analysis: undefined, capo: null, viewMode: \"sounding\", scaleCandidates: [], selectedScale: null, lastProg: [] }),\n}));\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3695, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/ui/cadence.ts"],"sourcesContent":["export type CadenceType = 'perfect' | 'deceptive' | 'half' | null;\n\nexport function formatCadenceLabel(\n  t: CadenceType,\n  tailRoman?: { from?: string; to?: string }\n): string {\n  if (!t) return 'Cadence: —';\n  if (t === 'perfect')   return `Cadence: Perfect (${tailRoman?.from ?? 'V'} → ${tailRoman?.to ?? 'I'})`;\n  if (t === 'deceptive') return `Cadence: Deceptive (${tailRoman?.from ?? 'V'} → ${tailRoman?.to ?? 'vi'})`;\n  // half cadence ends on V\n  return `Cadence: Half (${tailRoman?.from ? `${tailRoman.from} → ` : '… → '}V)`;\n}\n\nexport function cadenceTooltip(t: CadenceType): string {\n  if (!t) return 'No cadence detected.';\n  if (t === 'perfect')   return 'Resolves to the Tonic: V → I. Feels fully resolved.';\n  if (t === 'deceptive') return 'Surprises by avoiding I: V → vi (or similar).';\n  return 'Phrase ends on the Dominant: … → V. Feels unresolved.';\n}\n\n// Short inline label for Roman box\nexport function formatCadenceShort(\n  t: CadenceType,\n  tail?: { from?: string; to?: string }\n): string {\n  if (!t) return '';\n  if (t === 'perfect')   return `Perfect (${tail?.from ?? 'V'} → ${tail?.to ?? 'I'})`;\n  if (t === 'deceptive') return `Deceptive (${tail?.from ?? 'V'} → ${tail?.to ?? 'vi'})`;\n  return `Half (${tail?.from ? `${tail.from} → ` : '… → '}V)`;\n}\n\n\n"],"names":[],"mappings":";;;;;;;;AAEO,SAAS,mBACd,CAAc,EACd,SAA0C;IAE1C,IAAI,CAAC,GAAG,OAAO;QACoC,iBAA4B;IAA/E,IAAI,MAAM,WAAa,OAAO,AAAC,qBAAgD,OAA5B,CAAA,kBAAA,sBAAA,gCAAA,UAAW,IAAI,cAAf,6BAAA,kBAAmB,KAAI,OAA0B,OAArB,CAAA,gBAAA,sBAAA,gCAAA,UAAW,EAAE,cAAb,2BAAA,gBAAiB,KAAI;QAC/C,kBAA4B;IAAjF,IAAI,MAAM,aAAa,OAAO,AAAC,uBAAkD,OAA5B,CAAA,mBAAA,sBAAA,gCAAA,UAAW,IAAI,cAAf,8BAAA,mBAAmB,KAAI,OAA2B,OAAtB,CAAA,iBAAA,sBAAA,gCAAA,UAAW,EAAE,cAAb,4BAAA,iBAAiB,MAAK;IACvG,yBAAyB;IACzB,OAAO,AAAC,kBAAmE,OAAlD,CAAA,sBAAA,gCAAA,UAAW,IAAI,IAAG,AAAC,GAAiB,OAAf,UAAU,IAAI,EAAC,SAAO,QAAO;AAC7E;AAEO,SAAS,eAAe,CAAc;IAC3C,IAAI,CAAC,GAAG,OAAO;IACf,IAAI,MAAM,WAAa,OAAO;IAC9B,IAAI,MAAM,aAAa,OAAO;IAC9B,OAAO;AACT;AAGO,SAAS,mBACd,CAAc,EACd,IAAqC;IAErC,IAAI,CAAC,GAAG,OAAO;QAC2B,YAAuB;IAAjE,IAAI,MAAM,WAAa,OAAO,AAAC,YAAkC,OAAvB,CAAA,aAAA,iBAAA,2BAAA,KAAM,IAAI,cAAV,wBAAA,aAAc,KAAI,OAAqB,OAAhB,CAAA,WAAA,iBAAA,2BAAA,KAAM,EAAE,cAAR,sBAAA,WAAY,KAAI;QACrC,aAAuB;IAAnE,IAAI,MAAM,aAAa,OAAO,AAAC,cAAoC,OAAvB,CAAA,cAAA,iBAAA,2BAAA,KAAM,IAAI,cAAV,yBAAA,cAAc,KAAI,OAAsB,OAAjB,CAAA,YAAA,iBAAA,2BAAA,KAAM,EAAE,cAAR,uBAAA,YAAY,MAAK;IACpF,OAAO,AAAC,SAAgD,OAAxC,CAAA,iBAAA,2BAAA,KAAM,IAAI,IAAG,AAAC,GAAY,OAAV,KAAK,IAAI,EAAC,SAAO,QAAO;AAC1D","debugId":null}},
    {"offset": {"line": 3733, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ui/InfoDot.tsx"],"sourcesContent":["\"use client\";\nimport { useEffect, useRef, useState, useLayoutEffect, type ReactNode } from \"react\";\nimport { createPortal } from \"react-dom\";\n\ntype Props = {\n  text?: string;                    // plain text (optional when using children)\n  title?: string;                   // optional title in the card\n  children?: ReactNode;             // custom body content\n  className?: string;\n  linkHref?: string;\n  linkLabel?: string;\n  ariaLabel?: string;\n  icon?: 'info' | 'graduation';    // icon type\n};\n\nexport default function InfoDot({\n  text,\n  title,\n  children,\n  className = \"\",\n  linkHref,\n  linkLabel = \"Learn more\",\n  ariaLabel = \"More info\",\n  icon = 'info',\n}: Props) {\n  const [open, setOpen] = useState(false);\n  const ref = useRef<HTMLDivElement>(null);\n  const btnRef = useRef<HTMLButtonElement>(null);\n  const [coords, setCoords] = useState<{left:number; top:number; maxW:number}>({left:0, top:0, maxW:320});\n  useEffect(() => {\n    const onDoc = (e: MouseEvent) => {\n      if (ref.current && !ref.current.contains(e.target as Node)) setOpen(false);\n    };\n    const onEsc = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setOpen(false);\n    };\n    document.addEventListener(\"click\", onDoc);\n    document.addEventListener(\"keydown\", onEsc);\n    return () => {\n      document.removeEventListener(\"click\", onDoc);\n      document.removeEventListener(\"keydown\", onEsc);\n    };\n  }, []);\n  useLayoutEffect(() => {\n    if (!open) return;\n    const update = () => {\n      if (!btnRef.current) return;\n      const r = btnRef.current.getBoundingClientRect();\n      const maxW = Math.min(Math.floor(window.innerWidth * 0.9), 360);\n      const left = Math.min(window.innerWidth - 8 - maxW, Math.max(8, Math.round(r.right - maxW)));\n      const top = Math.min(window.innerHeight - 8 - 120, Math.round(r.bottom + 6));\n      setCoords({ left, top, maxW });\n    };\n    update();\n    window.addEventListener(\"resize\", update);\n    window.addEventListener(\"scroll\", update, true);\n    return () => {\n      window.removeEventListener(\"resize\", update);\n      window.removeEventListener(\"scroll\", update, true);\n    };\n  }, [open]);\n\n  return (\n    <div ref={ref} className={`relative inline-flex items-center ${className}`}>\n      <button ref={btnRef} type=\"button\" className=\"info-dot\" aria-label={ariaLabel} onClick={() => setOpen((o) => !o)}>\n        {icon === 'graduation' ? (\n          <svg className=\"w-3 h-3\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n            <path d=\"M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z\"/>\n          </svg>\n        ) : (\n          'i'\n        )}\n      </button>\n      {open && createPortal(\n        (\n          <div\n            role=\"dialog\"\n            className=\"info-card\"\n            style={{\n              position: \"fixed\",\n              zIndex: 60,\n              left: `${coords.left}px`,\n              top: `${coords.top}px`,\n              maxWidth: `${coords.maxW}px`,\n            }}\n          >\n            {title && <div className=\"font-medium mb-1\">{title}</div>}\n            {children ? (\n              children\n            ) : (\n              (text ?? \"\").split(\"\\n\").map((line, i) => <div key={i}>{line}</div>)\n            )}\n            {linkHref && (\n              <div className=\"mt-2 text-right\">\n                <a href={linkHref} className=\"underline text-[12px] opacity-80\">\n                  {linkLabel}\n                </a>\n              </div>\n            )}\n          </div>\n        ),\n        document.body\n      )}\n    </div>\n  );\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3905, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ui/Heading.tsx"],"sourcesContent":["'use client';\n\nexport function H2({\n  children,\n  className = '',\n  right,\n  as: Tag = 'h2',\n}: {\n  children: React.ReactNode;\n  className?: string;\n  right?: React.ReactNode;\n  as?: keyof JSX.IntrinsicElements;\n}) {\n  return (\n    <div className={`mb-2 flex items-center gap-2 ${className}`}>\n      <Tag className=\"text-xl md:text-2xl font-semibold tracking-tight text-foreground\">\n        {children}\n      </Tag>\n      {right ? <div className=\"ml-auto\">{right}</div> : null}\n    </div>\n  );\n}\n\nexport function H3({\n  children,\n  className = '',\n  right,\n  as: Tag = 'h3',\n}: {\n  children: React.ReactNode;\n  className?: string;\n  right?: React.ReactNode;\n  as?: keyof JSX.IntrinsicElements;\n}) {\n  return (\n    <div className={`mb-1.5 flex items-center gap-2 ${className}`}>\n      <Tag className=\"text-sm md:text-base font-semibold tracking-wide text-foreground\">\n        {children}\n      </Tag>\n      {right ? (\n        <div className=\"ml-auto text-xs md:text-sm text-muted-foreground\">{right}</div>\n      ) : null}\n    </div>\n  );\n}\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"],"names":[],"mappings":";;;;;;;AAAA;;AAEO,SAAS,GAAG,KAUlB;QAVkB,EACjB,QAAQ,EACR,YAAY,EAAE,EACd,KAAK,EACL,IAAI,MAAM,IAAI,EAMf,GAVkB;IAWjB,qBACE,6LAAC;QAAI,WAAW,AAAC,gCAAyC,OAAV;;0BAC9C,6LAAC;gBAAI,WAAU;0BACZ;;;;;;YAEF,sBAAQ,6LAAC;gBAAI,WAAU;0BAAW;;;;;uBAAe;;;;;;;AAGxD;KAnBgB;AAqBT,SAAS,GAAG,KAUlB;QAVkB,EACjB,QAAQ,EACR,YAAY,EAAE,EACd,KAAK,EACL,IAAI,MAAM,IAAI,EAMf,GAVkB;IAWjB,qBACE,6LAAC;QAAI,WAAW,AAAC,kCAA2C,OAAV;;0BAChD,6LAAC;gBAAI,WAAU;0BACZ;;;;;;YAEF,sBACC,6LAAC;gBAAI,WAAU;0BAAoD;;;;;uBACjE;;;;;;;AAGV;MArBgB","debugId":null}},
    {"offset": {"line": 3982, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music-theory.ts"],"sourcesContent":["import { Key, Note, Scale } from \"tonal\";\n\nexport type NoteLetter =\n  | \"A\" | \"Bb\" | \"B\" | \"C\" | \"C#\" | \"Db\" | \"D\" | \"Eb\" | \"E\" | \"F\" | \"F#\" | \"Gb\" | \"G\" | \"Ab\";\n\nexport type KeySignature = { tonic: NoteLetter; quality: \"major\" | \"minor\" };\nexport type KeyCandidate = { key: KeySignature; confidence: number; reasons: string[] };\n\nexport type ScaleId =\n  | \"major\" | \"naturalMinor\" | \"majorPent\" | \"minorPent\" | \"blues\"\n  | \"dorian\" | \"mixolydian\" | \"lydian\" | \"harmonicMinor\" | \"melodicMinor\";\n\nexport type ScaleMeta = { id: ScaleId; name: string; tier: \"free\" | \"pro\" };\nexport type ScaleCandidate = { scale: ScaleMeta; score: number };\n\nexport type AnalysisResult = {\n  keyCandidates: KeyCandidate[];\n  recommendedScales: ScaleCandidate[];\n  perSection?: SectionAnalysis[];\n};\n\n// Phase E-5: Section-weighted analysis\nexport type SectionName =\n  | \"Intro\" | \"Verse\" | \"PreChorus\" | \"Chorus\" | \"PostChorus\"\n  | \"Bridge\" | \"Solo\" | \"Interlude\" | \"Outro\" | \"Breakdown\" | \"Custom\";\n\nexport interface SectionDef {\n  name: SectionName;\n  start: number;     // inclusive (0-based index in chords[])\n  end: number;       // inclusive\n  repeat?: number;   // default 1\n  weightMul?: number; // optional override\n}\n\nexport interface SectionAnalysis {\n  section: SectionDef;\n  best: KeyCandidate;\n  ranking: KeyCandidate[];\n}\n\nexport interface AnalyzeOpts {\n  sections?: SectionDef[];\n  weights?: Partial<{\n    section: Partial<Record<SectionName, number>>;\n    songHead: number; // default 1.2\n    songTail: number; // default 1.3\n    sectionEdge: number; // default 1.1\n  }>;\n  cadence?: boolean; // enable cadence detection (future)\n}\n\nconst ALL_TONICS: NoteLetter[] = [\n  \"C\", \"C#\", \"D\", \"Eb\", \"E\", \"F\", \"F#\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\",\n];\n\n// Phase E-5: Default section weights (based on musical importance)\nconst DEFAULT_SECTION_WEIGHTS: Record<SectionName, number> = {\n  Intro: 0.8,\n  Verse: 1.0,\n  PreChorus: 1.2,\n  Chorus: 1.6,      // サビは最重要\n  PostChorus: 1.3,\n  Bridge: 0.9,\n  Solo: 1.0,\n  Interlude: 0.8,\n  Outro: 0.9,\n  Breakdown: 0.9,\n  Custom: 1.0,\n};\n\nconst DEFAULT_WEIGHTS = {\n  songHead: 1.2,  // 既存の先頭重み\n  songTail: 1.3,  // 既存の末尾重み\n  sectionEdge: 1.1, // セクション先頭/末尾の補正\n};\n\nconst SCALE_DEFS: Record<ScaleId, ScaleMeta> = {\n  major: { id: \"major\", name: \"Major Scale\", tier: \"free\" },\n  naturalMinor: { id: \"naturalMinor\", name: \"Natural Minor Scale\", tier: \"free\" },\n  majorPent: { id: \"majorPent\", name: \"Major Pentatonic\", tier: \"free\" },\n  minorPent: { id: \"minorPent\", name: \"Minor Pentatonic\", tier: \"free\" },\n  blues: { id: \"blues\", name: \"Blues Scale\", tier: \"free\" },\n  dorian: { id: \"dorian\", name: \"Dorian Mode\", tier: \"pro\" },\n  mixolydian: { id: \"mixolydian\", name: \"Mixolydian Mode\", tier: \"pro\" },\n  lydian: { id: \"lydian\", name: \"Lydian Mode\", tier: \"pro\" },\n  harmonicMinor: { id: \"harmonicMinor\", name: \"Harmonic Minor\", tier: \"pro\" },\n  melodicMinor: { id: \"melodicMinor\", name: \"Melodic Minor\", tier: \"pro\" },\n};\n\ntype ParsedChord = {\n  raw: string;\n  root: string; // canonical pitch class, e.g., C, C#, Bb\n  triad: \"maj\" | \"min\" | \"dim\";\n  isDominantLike: boolean; // contains \"7\" (for V/V detection)\n};\n\nfunction normalizeNote(input: string): string {\n  const n = Note.pitchClass(input);\n  return n || input;\n}\n\nfunction parseChordToken(token: string): ParsedChord | null {\n  if (!token) return null;\n  // Remove bass/slash\n  const [head] = token.split(\"/\");\n  const m = head.match(/^([A-Ga-g])([#b]?)(.*)$/);\n  if (!m) return null;\n  const root = normalizeNote((m[1] + m[2]).toUpperCase());\n  const rest = (m[3] || \"\").toLowerCase();\n  // Order matters: detect maj before generic m\n  let triad: ParsedChord[\"triad\"] = \"maj\";\n  if (/(m7b5|ø|dim)/.test(rest)) triad = \"dim\";\n  else if (/maj/.test(rest)) triad = \"maj\";\n  else if (/(^|[^a-z])m(?!aj)/.test(rest)) triad = \"min\";\n  else if (/sus|aug/.test(rest)) triad = \"maj\"; // treat as functional major\n  else triad = \"maj\";\n  const isDominantLike = /(^|[^a-z])7(?![a-z0-9])/.test(rest) || /7/.test(rest);\n  return { raw: token, root, triad, isDominantLike };\n}\n\nfunction getDiatonicChords(key: KeySignature): string[] {\n  if (key.quality === \"major\") {\n    const mk = Key.majorKey(key.tonic);\n    return mk.chords || [];\n  }\n  const nk = Key.minorKey(key.tonic);\n  return nk.natural?.chords || nk.chords || [];\n}\n\nfunction isDiatonicMatch(chord: ParsedChord, diatonic: string[]): boolean {\n  const target = chord.root + (chord.triad === \"maj\" ? \"\" : chord.triad === \"min\" ? \"m\" : \"dim\");\n  return diatonic.includes(target);\n}\n\nfunction fifth(note: string): string {\n  const p = Note.transpose(note, \"5P\");\n  return normalizeNote(p);\n}\n\nfunction flat(note: string): string {\n  const p = Note.transpose(note, \"-1m\");\n  return normalizeNote(p);\n}\n\nfunction isSecondaryDominant(chord: ParsedChord, key: KeySignature): boolean {\n  // very light-weight V/V detector: major triad (or 7) on degree 2's major? We'll approximate as fifth of fifth\n  const v = fifth(key.tonic);\n  const vOfV = fifth(v);\n  return chord.root === vOfV && (chord.triad === \"maj\" || chord.isDominantLike);\n}\n\nfunction isSubdominantMinorOrbVII(chord: ParsedChord, key: KeySignature): boolean {\n  if (key.quality !== \"major\") return false;\n  const mk = Key.majorKey(key.tonic);\n  const scale = mk.scale || [];\n  const degree4 = scale[3];\n  const degree7 = scale[6];\n  const ivMinor = degree4 ? normalizeNote(degree4) : \"\";\n  const bVII = degree7 ? normalizeNote(flat(degree7)) : \"\";\n  const isIvMinor = chord.root === ivMinor && chord.triad === \"min\";\n  const isB7 = chord.root === bVII && chord.triad === \"maj\";\n  return !!(isIvMinor || isB7);\n}\n\nfunction scoreForKey(\n  chords: ParsedChord[],\n  key: KeySignature,\n  weights?: number[]\n): { score: number; reasons: string[] } {\n  const diatonic = getDiatonicChords(key);\n  let reasons: string[] = [];\n  \n  // Phase E-5: Use provided weights or fall back to legacy position weights\n  const W = weights || chords.map((_, i) => (i === 0 ? 1.2 : i === chords.length - 1 ? 1.3 : 1));\n  const total = W.reduce((a, b) => a + b, 0);\n  \n  let acc = 0;\n  chords.forEach((ch, i) => {\n    const w = W[i];\n    if (isDiatonicMatch(ch, diatonic)) {\n      acc += w * 1.0; // 100%\n    } else if (isSecondaryDominant(ch, key)) {\n      acc += w * 0.9; // 85-95%\n      reasons.push(`Secondary dominant tolerated: ${ch.raw}`);\n    } else if (isSubdominantMinorOrbVII(ch, key)) {\n      acc += w * 0.8; // 70-85%\n      reasons.push(`Borrowed chord tolerated: ${ch.raw}`);\n    } else {\n      acc += w * 0.5; // potential modulation or out-of-key\n    }\n  });\n  const confidence = Math.round((acc / total) * 100);\n  reasons.unshift(`${diatonic.length} diatonic chords in ${key.tonic} ${key.quality}`);\n  return { score: confidence, reasons };\n}\n\nfunction recommendScales(topKey: KeySignature, chords: ParsedChord[]): ScaleCandidate[] {\n  const list: ScaleMeta[] = [\n    SCALE_DEFS.major,\n    SCALE_DEFS.naturalMinor,\n    SCALE_DEFS.majorPent,\n    SCALE_DEFS.minorPent,\n    SCALE_DEFS.blues,\n    SCALE_DEFS.dorian,\n    SCALE_DEFS.mixolydian,\n    SCALE_DEFS.lydian,\n    SCALE_DEFS.harmonicMinor,\n    SCALE_DEFS.melodicMinor,\n  ];\n  // Build a set of chord roots to approximate note coverage\n  const chordRoots = new Set(chords.map((c) => c.root));\n  const keyTonic = topKey.tonic;\n  const scaleScores = list.map((sm) => {\n    const scaleName =\n      sm.id === \"major\" ? \"Major\" :\n      sm.id === \"naturalMinor\" ? \"Natural Minor\" :\n      sm.id === \"majorPent\" ? \"Major Pentatonic\" :\n      sm.id === \"minorPent\" ? \"Minor Pentatonic\" :\n      sm.id === \"blues\" ? \"Blues\" :\n      sm.id === \"dorian\" ? \"Dorian\" :\n      sm.id === \"mixolydian\" ? \"Mixolydian\" :\n      sm.id === \"lydian\" ? \"Lydian\" :\n      sm.id === \"harmonicMinor\" ? \"Harmonic Minor\" :\n      \"Melodic Minor\";\n    const sc = Scale.get(`${keyTonic} ${scaleName}`);\n    const noteSet = new Set((sc.notes || []).map(normalizeNote));\n    const matches = Array.from(chordRoots).filter((r) => noteSet.has(r)).length;\n    const score = matches / Math.max(1, chordRoots.size);\n    return { scale: sm, score } as ScaleCandidate;\n  });\n  scaleScores.sort((a, b) => b.score - a.score);\n  return scaleScores.slice(0, 5);\n}\n\n// Phase E-5: Compute weights for each chord based on sections\nfunction computeWeights(chordCount: number, opts: AnalyzeOpts): number[] {\n  const W = new Array(chordCount).fill(1.0);\n  const sections = opts.sections || [];\n  \n  const sectionWeights = { ...DEFAULT_SECTION_WEIGHTS, ...(opts.weights?.section ?? {}) };\n  const songHead = opts.weights?.songHead ?? DEFAULT_WEIGHTS.songHead;\n  const songTail = opts.weights?.songTail ?? DEFAULT_WEIGHTS.songTail;\n  const sectionEdge = opts.weights?.sectionEdge ?? DEFAULT_WEIGHTS.sectionEdge;\n  \n  // Apply section weights\n  for (const s of sections) {\n    const repeat = s.repeat ?? 1;\n    const base = (s.weightMul ?? sectionWeights[s.name] ?? 1.0) * Math.sqrt(repeat);\n    \n    for (let i = s.start; i <= s.end && i < chordCount; i++) {\n      W[i] *= base;\n    }\n    \n    // Section edge bonus\n    if (s.start < chordCount) W[s.start] *= sectionEdge;\n    if (s.end < chordCount) W[s.end] *= sectionEdge;\n  }\n  \n  // Song-level head/tail bonus (legacy compatibility)\n  if (chordCount > 0) W[0] *= songHead;\n  if (chordCount > 1) W[chordCount - 1] *= songTail;\n  \n  // Normalize (Σ W = 1)\n  const sumW = W.reduce((a, b) => a + b, 0) || 1;\n  return W.map(w => w / sumW);\n}\n\nexport function analyzeChordProgression(\n  rawTokens: string[],\n  opts: AnalyzeOpts = {}\n): AnalysisResult {\n  const chords = rawTokens\n    .map((t) => t.trim())\n    .filter(Boolean)\n    .map(parseChordToken)\n    .filter((c): c is ParsedChord => !!c);\n\n  // Phase E-5: Compute weights with section awareness\n  const weights = computeWeights(chords.length, opts);\n  \n  const candidates: KeyCandidate[] = [];\n  for (const tonic of ALL_TONICS) {\n    for (const quality of [\"major\", \"minor\"] as const) {\n      const { score, reasons } = scoreForKey(\n        chords,\n        { tonic: tonic as NoteLetter, quality },\n        weights\n      );\n      candidates.push({ key: { tonic: tonic as NoteLetter, quality }, confidence: score, reasons });\n    }\n  }\n  candidates.sort((a, b) => b.confidence - a.confidence);\n  const keyCandidates = candidates.slice(0, 5); // v3.1: 3→5候補に拡張（iOS UI改善）\n  const recommendedScales = recommendScales(keyCandidates[0].key, chords);\n  \n  // Phase E-5: Per-section analysis (optional)\n  let perSection: SectionAnalysis[] | undefined;\n  if (opts.sections && opts.sections.length > 0) {\n    perSection = opts.sections.map(sec => {\n      const slice = rawTokens.slice(sec.start, Math.min(sec.end + 1, rawTokens.length));\n      // Analyze section without section weights (just the chords themselves)\n      const local = analyzeChordProgression(slice, {\n        weights: {\n          songHead: 1.0, // No global position bias for local analysis\n          songTail: 1.0,\n        }\n      });\n      return {\n        section: sec,\n        best: local.keyCandidates[0],\n        ranking: local.keyCandidates\n      };\n    });\n  }\n  \n  return { keyCandidates, recommendedScales, perSection };\n}\n\nexport type DiatonicRequest = {\n  tonic: NoteLetter;\n  quality: \"major\" | \"minor\";\n  scale: \"major\" | \"naturalMinor\";\n};\n\nexport type DiatonicResponse = {\n  chords: string[];\n};\n\nexport function getDiatonicChordsFor(\n  req: DiatonicRequest\n): DiatonicResponse {\n  const key: KeySignature = { tonic: req.tonic, quality: req.quality };\n  const chords = getDiatonicChords(key);\n  return { chords };\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4308, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chords.ts"],"sourcesContent":["export const QUICK_QUALITIES = [\"M\",\"m\",\"7\",\"M7\",\"m7\",\"sus4\",\"dim\"] as const;\n\n// Advanced categories\nexport const ADV_EXTENSIONS = [\n  \"6\",\"m6\",\"9\",\"m9\",\"11\",\"M11\",\"13\",\"M13\"\n] as const;\n\nexport const ADV_ALTERED_DOM = [\n  \"7b5\",\"7#5\",\"7b9\",\"7#9\",\"7#11\",\"7b13\",\"7alt\"\n] as const;\n\nexport const ADV_DIM_VARIANTS = [\n  \"dim7\",\"m7b5\"\n] as const;\n\nexport const ADV_SUS_ADDS = [\n  \"sus2\",\"add9\",\"add11\",\"add13\",\"6/9\"\n] as const;\n\nexport const ADV_AUG_MAJMIN = [\n  \"aug\",\"mM7\"\n] as const;\n\nexport const ADVANCED_QUALITIES = [\n  ...ADV_EXTENSIONS,\n  ...ADV_ALTERED_DOM,\n  ...ADV_DIM_VARIANTS,\n  ...ADV_SUS_ADDS,\n  ...ADV_AUG_MAJMIN,\n  \"/bass\",\n] as const;\n\nexport type Quality = typeof QUICK_QUALITIES[number] | typeof ADVANCED_QUALITIES[number];\n\nexport const isAdvanced = (q: string): boolean => (ADVANCED_QUALITIES as readonly string[]).includes(q);\nexport const isQuick = (q: string): boolean => (QUICK_QUALITIES as readonly string[]).includes(q);\n\nexport const BASS_NOTES = [\"C\",\"C#\",\"D\",\"Eb\",\"E\",\"F\",\"F#\",\"G\",\"Ab\",\"A\",\"Bb\",\"B\"] as const;\nexport type BassNote = typeof BASS_NOTES[number];\n\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;AAAO,MAAM,kBAAkB;IAAC;IAAI;IAAI;IAAI;IAAK;IAAK;IAAO;CAAM;AAG5D,MAAM,iBAAiB;IAC5B;IAAI;IAAK;IAAI;IAAK;IAAK;IAAM;IAAK;CACnC;AAEM,MAAM,kBAAkB;IAC7B;IAAM;IAAM;IAAM;IAAM;IAAO;IAAO;CACvC;AAEM,MAAM,mBAAmB;IAC9B;IAAO;CACR;AAEM,MAAM,eAAe;IAC1B;IAAO;IAAO;IAAQ;IAAQ;CAC/B;AAEM,MAAM,iBAAiB;IAC5B;IAAM;CACP;AAEM,MAAM,qBAAqB;OAC7B;OACA;OACA;OACA;OACA;IACH;CACD;AAIM,MAAM,aAAa,CAAC,IAAuB,AAAC,mBAAyC,QAAQ,CAAC;AAC9F,MAAM,UAAU,CAAC,IAAuB,AAAC,gBAAsC,QAAQ,CAAC;AAExF,MAAM,aAAa;IAAC;IAAI;IAAK;IAAI;IAAK;IAAI;IAAI;IAAK;IAAI;IAAK;IAAI;IAAK;CAAI","debugId":null}},
    {"offset": {"line": 4404, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/compat.ts"],"sourcesContent":["export type BaseKind = \"major\" | \"minor\" | \"dominant\" | \"diminished\" | \"augmented\" | \"unknown\";\n\nexport const getBaseKind = (q: string): BaseKind => {\n  if (q.startsWith(\"M\") || q === \"M\") return \"major\";\n  if (q.startsWith(\"m\")) return \"minor\";\n  if (q === \"7\" || /^7/.test(q) || [\"9\",\"11\",\"13\"].includes(q)) return \"dominant\";\n  if (q.startsWith(\"dim\") || q === \"m7b5\") return \"diminished\";\n  if (q === \"aug\") return \"augmented\";\n  return \"unknown\";\n};\n\nexport const preferredBase = (candidate: string): BaseKind | \"any\" => {\n  if ([\"M9\",\"M11\",\"M13\",\"6\"].includes(candidate)) return \"major\";\n  if ([\"m6\",\"m9\"].includes(candidate)) return \"minor\";\n  if ([\"7b5\",\"7#5\",\"7b9\",\"7#9\",\"7#11\",\"7b13\",\"7alt\",\"9\",\"11\",\"13\"].includes(candidate)) return \"dominant\";\n  if ([\"dim7\",\"m7b5\"].includes(candidate)) return \"diminished\";\n  if ([\"add9\",\"add11\",\"add13\",\"sus2\",\"6/9\"].includes(candidate)) return \"any\";\n  if (candidate === \"aug\" || candidate === \"mM7\") return \"any\";\n  return \"any\";\n};\n\nexport const isCompatible = (currentBase: BaseKind, candidate: string): boolean => {\n  const pref = preferredBase(candidate);\n  if (pref === \"any\") return true;\n  if (currentBase === \"unknown\") return true;\n  if (currentBase === \"major\" && pref === \"minor\") return false;\n  if (currentBase === \"minor\" && pref === \"major\") return false;\n  if (currentBase !== \"dominant\" && [\"7b5\",\"7#5\",\"7b9\",\"7#9\",\"7#11\",\"7b13\",\"7alt\",\"9\",\"11\",\"13\"].includes(candidate)) {\n    return false;\n  }\n  if (currentBase !== \"diminished\" && [\"dim7\",\"m7b5\"].includes(candidate)) return false;\n  return true;\n};\n\n\n\n"],"names":[],"mappings":";;;;;;;;AAEO,MAAM,cAAc,CAAC;IAC1B,IAAI,EAAE,UAAU,CAAC,QAAQ,MAAM,KAAK,OAAO;IAC3C,IAAI,EAAE,UAAU,CAAC,MAAM,OAAO;IAC9B,IAAI,MAAM,OAAO,KAAK,IAAI,CAAC,MAAM;QAAC;QAAI;QAAK;KAAK,CAAC,QAAQ,CAAC,IAAI,OAAO;IACrE,IAAI,EAAE,UAAU,CAAC,UAAU,MAAM,QAAQ,OAAO;IAChD,IAAI,MAAM,OAAO,OAAO;IACxB,OAAO;AACT;AAEO,MAAM,gBAAgB,CAAC;IAC5B,IAAI;QAAC;QAAK;QAAM;QAAM;KAAI,CAAC,QAAQ,CAAC,YAAY,OAAO;IACvD,IAAI;QAAC;QAAK;KAAK,CAAC,QAAQ,CAAC,YAAY,OAAO;IAC5C,IAAI;QAAC;QAAM;QAAM;QAAM;QAAM;QAAO;QAAO;QAAO;QAAI;QAAK;KAAK,CAAC,QAAQ,CAAC,YAAY,OAAO;IAC7F,IAAI;QAAC;QAAO;KAAO,CAAC,QAAQ,CAAC,YAAY,OAAO;IAChD,IAAI;QAAC;QAAO;QAAQ;QAAQ;QAAO;KAAM,CAAC,QAAQ,CAAC,YAAY,OAAO;IACtE,IAAI,cAAc,SAAS,cAAc,OAAO,OAAO;IACvD,OAAO;AACT;AAEO,MAAM,eAAe,CAAC,aAAuB;IAClD,MAAM,OAAO,cAAc;IAC3B,IAAI,SAAS,OAAO,OAAO;IAC3B,IAAI,gBAAgB,WAAW,OAAO;IACtC,IAAI,gBAAgB,WAAW,SAAS,SAAS,OAAO;IACxD,IAAI,gBAAgB,WAAW,SAAS,SAAS,OAAO;IACxD,IAAI,gBAAgB,cAAc;QAAC;QAAM;QAAM;QAAM;QAAM;QAAO;QAAO;QAAO;QAAI;QAAK;KAAK,CAAC,QAAQ,CAAC,YAAY;QAClH,OAAO;IACT;IACA,IAAI,gBAAgB,gBAAgB;QAAC;QAAO;KAAO,CAAC,QAAQ,CAAC,YAAY,OAAO;IAChF,OAAO;AACT","debugId":null}},
    {"offset": {"line": 4494, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/capo.ts"],"sourcesContent":["// Simple capo advisor based on friendly open-chord shapes\n// PITCHESは lib/music/constants.ts に統一\nimport { PC_NAMES } from '../music/constants';\ntype Pitch = typeof PC_NAMES[number];\nexport type Mode = 'major'|'minor';\n// 外部で使用するためにエクスポート\nexport const PITCHES = PC_NAMES;\n\nconst SHAPES_MAJOR: {key: Pitch, label: string, weight: number}[] = [\n  { key: 'C', label: 'C', weight: 1.0 },\n  { key: 'G', label: 'G', weight: 1.0 },\n  { key: 'D', label: 'D', weight: 0.95 },\n  { key: 'A', label: 'A', weight: 0.9 },\n  { key: 'E', label: 'E', weight: 0.9 },\n];\nconst SHAPES_MINOR: {key: Pitch, label: string, weight: number}[] = [\n  { key: 'A', label: 'Am', weight: 1.0 },\n  { key: 'E', label: 'Em', weight: 1.0 },\n  { key: 'D', label: 'Dm', weight: 0.8 },\n];\n\nfunction idx(p: string){ const n = p.replace('♭','b').replace('＃','#'); \n  const map: Record<string, Pitch> = { 'Db':'C#','D#':'Eb','Gb':'F#','G#':'Ab','A#':'Bb' } as any;\n  const canon = (map[n as Pitch] || n);\n  return PC_NAMES.indexOf(canon as Pitch);\n}\nconst dist = (from:number,to:number)=> (to-from+12)%12;\n\nexport type CapoOption = {\n  capo: number;\n  shapedKey: string;\n  sounding: { tonic: Pitch, mode: Mode };\n  score: number;\n  notes: string[];\n};\n\nexport function suggestCapoOptions(target: { tonic: string, mode: Mode }): CapoOption[] {\n  const targetIdx = idx(target.tonic);\n  const shapes = target.mode === 'minor' ? SHAPES_MINOR : SHAPES_MAJOR;\n  const options = shapes.map(s => {\n    const capo = dist(idx(s.key), targetIdx);\n    const capoPenalty = capo <= 2 ? 0 : capo <= 4 ? 0.1 : capo <= 6 ? 0.25 : 0.4;\n    const score = s.weight - capoPenalty;\n    const notes: string[] = [];\n    if (capo <= 2) notes.push('Low position');\n    if (capo >= 6) notes.push('Higher position (thinner tone)');\n    if (/^(E|A|C|G)/.test(s.label)) notes.push('Many open strings');\n    return {\n      capo,\n      shapedKey: target.mode === 'minor' ? s.label : s.label,\n      sounding: { tonic: PC_NAMES[targetIdx], mode: target.mode },\n      score,\n      notes\n    } as CapoOption;\n  }).sort((a,b)=> b.score-a.score);\n  const picked: CapoOption[] = [];\n  for (const o of options) if (!picked.some(p=>p.capo===o.capo)) picked.push(o);\n  return picked.slice(0,3);\n}\n\n\n\n\n\n\n\n\n\n\n\n"],"names":[],"mappings":"AAAA,0DAA0D;AAC1D,sCAAsC;;;;;;;AACtC;;AAIO,MAAM,UAAU,+IAAQ;AAE/B,MAAM,eAA8D;IAClE;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAK;IACrC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;CACrC;AACD,MAAM,eAA8D;IAClE;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;IACrC;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;IACrC;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;CACtC;AAED,SAAS,IAAI,CAAS;IAAG,MAAM,IAAI,EAAE,OAAO,CAAC,KAAI,KAAK,OAAO,CAAC,KAAI;IAChE,MAAM,MAA6B;QAAE,MAAK;QAAK,MAAK;QAAK,MAAK;QAAK,MAAK;QAAK,MAAK;IAAK;IACvF,MAAM,QAAS,GAAG,CAAC,EAAW,IAAI;IAClC,OAAO,+IAAQ,CAAC,OAAO,CAAC;AAC1B;AACA,MAAM,OAAO,CAAC,MAAY,KAAa,CAAC,KAAG,OAAK,EAAE,IAAE;AAU7C,SAAS,mBAAmB,MAAqC;IACtE,MAAM,YAAY,IAAI,OAAO,KAAK;IAClC,MAAM,SAAS,OAAO,IAAI,KAAK,UAAU,eAAe;IACxD,MAAM,UAAU,OAAO,GAAG,CAAC,CAAA;QACzB,MAAM,OAAO,KAAK,IAAI,EAAE,GAAG,GAAG;QAC9B,MAAM,cAAc,QAAQ,IAAI,IAAI,QAAQ,IAAI,MAAM,QAAQ,IAAI,OAAO;QACzE,MAAM,QAAQ,EAAE,MAAM,GAAG;QACzB,MAAM,QAAkB,EAAE;QAC1B,IAAI,QAAQ,GAAG,MAAM,IAAI,CAAC;QAC1B,IAAI,QAAQ,GAAG,MAAM,IAAI,CAAC;QAC1B,IAAI,aAAa,IAAI,CAAC,EAAE,KAAK,GAAG,MAAM,IAAI,CAAC;QAC3C,OAAO;YACL;YACA,WAAW,OAAO,IAAI,KAAK,UAAU,EAAE,KAAK,GAAG,EAAE,KAAK;YACtD,UAAU;gBAAE,OAAO,+IAAQ,CAAC,UAAU;gBAAE,MAAM,OAAO,IAAI;YAAC;YAC1D;YACA;QACF;IACF,GAAG,IAAI,CAAC,CAAC,GAAE,IAAK,EAAE,KAAK,GAAC,EAAE,KAAK;IAC/B,MAAM,SAAuB,EAAE;IAC/B,KAAK,MAAM,KAAK,QAAS,IAAI,CAAC,OAAO,IAAI,CAAC,CAAA,IAAG,EAAE,IAAI,KAAG,EAAE,IAAI,GAAG,OAAO,IAAI,CAAC;IAC3E,OAAO,OAAO,KAAK,CAAC,GAAE;AACxB","debugId":null}},
    {"offset": {"line": 4595, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/DiatonicCapoTable.tsx"],"sourcesContent":["\"use client\";\nimport React, { useRef, useCallback } from \"react\";\nimport { useAnalysisStore } from \"@/store/analysisStore\";\nimport { diatonicTriads, triadToChordSym } from \"@/lib/theory/diatonic\";\nimport { romanDegreeLabelsForScale, SCALE_INTERVALS, type ScaleType, parentModeOf } from \"@/lib/scales\";\nimport { recommendCapos } from \"@/lib/capo/recommend\";\nimport { PITCHES } from \"@/lib/theory/capo\";\n\nexport type OnPickArgs = { id: string; row: 'open' | `capo${number}`; degree: number; pcs: number[]; capo: number; isRightClick?: boolean };\nexport default function DiatonicCapoTable({ onPick, selectedId, onSelectId }: { onPick?: (p: OnPickArgs) => void; selectedId?: string | null; onSelectId?: (id: string) => void }) {\n  const selectedKey = useAnalysisStore(s => (s as any).selectedKey);\n  const selectedScale = useAnalysisStore(s => (s as any).selectedScale);\n  const degreeLabels = romanDegreeLabelsForScale(selectedScale?.type ?? 'Ionian');\n  const toFancy = (s: string) => s.replaceAll('b','♭').replaceAll('#','♯');\n  const cellBase = \"px-2 py-1 text-center border rounded-[var(--chip-br)]\";\n  const cellNeutral = \"border-neutral-300 dark:border-neutral-700\";\n  const cellOpen = \"bg-emerald-50 border-emerald-200 text-emerald-900 dark:bg-emerald-800/25 dark:border-emerald-700 dark:text-emerald-100\";\n\n  // Mobile long-press support\n  const longPressTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const longPressTriggeredRef = useRef(false);\n\n  const handleTouchStart = useCallback((i: number, sym: string, pcs: number[]) => {\n    longPressTriggeredRef.current = false;\n    longPressTimerRef.current = setTimeout(() => {\n      longPressTriggeredRef.current = true;\n      const confirmed = window.confirm(`Add \"${sym}\" to progression?`);\n      if (confirmed) {\n        const id = `open-${i}`;\n        onSelectId?.(id);\n        onPick?.({ id, row: 'open', degree: i, pcs, capo: 0, isRightClick: true });\n      }\n    }, 500); // 500ms long press\n  }, [onPick, onSelectId]);\n\n  const handleTouchEnd = useCallback(() => {\n    if (longPressTimerRef.current) {\n      clearTimeout(longPressTimerRef.current);\n      longPressTimerRef.current = null;\n    }\n  }, []);\n\n  const openCells = React.useMemo(() => {\n    if (!selectedKey || !selectedScale) return Array(7).fill({ sym:'—', pcs:[] as number[] });\n    let st = selectedScale.type as ScaleType;\n    let ivs = SCALE_INTERVALS[st] ?? [];\n    if (ivs.length !== 7) {\n      const parent = parentModeOf(st);\n      if (parent) ivs = SCALE_INTERVALS[parent] ?? [];\n    }\n    if (ivs.length !== 7) return Array(7).fill({ sym:'—', pcs:[] as number[] });\n    const tris = diatonicTriads({ tonicPc: selectedKey.tonic, scaleIntervals: ivs });\n    return tris.map(t => ({ sym: triadToChordSym({ rootPc: t.rootPc, quality: t.quality }), pcs: t.pcs }));\n  }, [selectedKey, selectedScale]);\n\n  const capoRows = React.useMemo(() => {\n    if (!selectedKey || !selectedScale) return [] as Array<{ capo:number; label:string; cells:string[]; cellsPcs:number[][]; tooltip?:string }>;\n    const modeLabel = (selectedKey.mode === 'Major' || selectedKey.mode === 'Minor') ? selectedKey.mode : ((selectedKey.mode as any) === 'major' ? 'Major' : 'Minor');\n    const picks = recommendCapos({ tonic: selectedKey.tonic, mode: modeLabel as any }, { type: selectedScale.type as any }, 3, { includeOpen: true });\n    const nonZero = picks.filter(p => p.capo !== 0).sort((a,b)=> a.capo - b.capo).slice(0,2);\n    return nonZero.map(p => {\n      const playAs = p.playAs; // e.g., G or Am\n      const isMinor = /m$/.test(playAs);\n      const name = isMinor ? playAs.replace(/m$/,'') : playAs;\n      const pc = PITCHES.indexOf(name as any);\n      let st = selectedScale.type as ScaleType;\n      let ivs = SCALE_INTERVALS[st] ?? [];\n      if (ivs.length !== 7) {\n        const parent = parentModeOf(st);\n        if (parent) ivs = SCALE_INTERVALS[parent] ?? [];\n      }\n      const tris = ivs.length===7 ? diatonicTriads({ tonicPc: pc, scaleIntervals: ivs }) : [];\n      const cells = (tris.length? tris : Array(7).fill(null)).map((t:any)=> t ? triadToChordSym({ rootPc: t.rootPc, quality: t.quality }) : '—');\n      const cellsPcs = (tris.length? tris : Array(7).fill(null)).map((t:any)=> t ? (t.pcs as number[]) : []);\n      return { capo: p.capo, label: `Capo ${p.capo}`, cells, cellsPcs, tooltip: `Play as ${playAs}${(p.reasons&&p.reasons.length? ' · ' + p.reasons.join(' · ') : '')}` };\n    });\n  }, [selectedKey, selectedScale]);\n\n  const header = degreeLabels.map(toFancy);\n\n  return (\n    <div className=\"overflow-x-auto capo-compact capo-compact--tight\" aria-live=\"polite\" aria-labelledby=\"diatonic-title\">\n      <table className=\"w-full border-separate rounded-xl border text-sm md:text-[0.95rem]\" style={{ borderSpacing: '6px' }}>\n        <colgroup>\n          <col className=\"w-12 sm:w-14 md:w-18\" />\n          <col span={7} />\n        </colgroup>\n        <thead>\n          <tr>\n            <th scope=\"col\" className=\"px-1 py-0 text-center text-sm font-medium border-none bg-transparent rounded-none\"></th>\n            {header.map((d,i)=> (\n              <th key={`hdr-${i}`} scope=\"col\" className=\"px-1 py-0 text-center text-sm font-medium border-none bg-transparent rounded-none\">{d}</th>\n            ))}\n          </tr>\n        </thead>\n        <tbody>\n          <tr data-row=\"open\">\n            <th scope=\"row\" className=\"px-1 py-0 text-center text-xs font-normal border-none bg-transparent rounded-none text-foreground/70\" title=\"Open (no capo)\">Open</th>\n            {openCells.map((c, i)=> (\n              // cell id unique: open-<degreeIndex>\n              <td\n                key={`open-${i}`}\n                className={[cellBase, cellOpen, onPick ? 'cursor-pointer select-none tapfx' : '', (selectedId === `open-${i}` ? 'ring-2 ring-emerald-400/60 dia-cell--active' : 'dia-cell--idle')].join(' ')}\n                onClick={(e) => {\n                  if ((e as unknown as MouseEvent).button === 2) return; // 右クリックは無視\n                  if (longPressTriggeredRef.current) { longPressTriggeredRef.current = false; return; } // 長押し後のクリックを無視\n                  const id = `open-${i}`; onSelectId?.(id); onPick?.({ id, row: 'open', degree: i, pcs: c.pcs, capo: 0 });\n                }}\n                onContextMenu={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                  const confirmed = window.confirm(`Add \"${c.sym}\" to progression?`);\n                  if (confirmed) {\n                    const id = `open-${i}`;\n                    onSelectId?.(id);\n                    onPick?.({ id, row: 'open', degree: i, pcs: c.pcs, capo: 0, isRightClick: true });\n                  }\n                }}\n                onTouchStart={() => handleTouchStart(i, c.sym, c.pcs)}\n                onTouchEnd={handleTouchEnd}\n                onTouchCancel={handleTouchEnd}\n                role={onPick ? 'button' : undefined}\n                aria-label={onPick ? `Open ${c.sym}` : undefined}\n                aria-pressed={selectedId === `open-${i}`}\n              >{c.sym}</td>\n            ))}\n          </tr>\n          {capoRows.map((r)=> (\n            <tr key={`capo-${r.capo}`}>\n              <th scope=\"row\" className=\"px-1 py-0 text-center text-xs font-normal border-none bg-transparent rounded-none text-foreground/70\" title={r.tooltip}>{r.label}</th>\n              {r.cells.map((c, i)=> (\n                <td\n                  key={`capo-${r.capo}-${i}`}\n                  className={[cellBase, cellNeutral, 'opacity-65 cursor-default pointer-events-none', (selectedId === `capo${r.capo}-${i}` ? 'dia-cell--active' : 'dia-cell--idle')].join(' ')}\n                  role=\"button\"\n                  tabIndex={-1}\n                  aria-disabled=\"true\"\n                  aria-label={`${r.label} ${c}`}\n                >{c}</td>\n              ))}\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4968, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/roman/patterns.ts"],"sourcesContent":["export type RomanToken = string; // e.g., 'I','vi','IV','V','bVII','vii°'\n\nexport type Pattern = {\n  id: string;\n  name: string;\n  mode: 'major' | 'minor' | 'any';\n  seq: RomanToken[];\n  variants?: RomanToken[][];\n  summary: string;\n  tags?: string[];\n};\n\nexport const PATTERNS: Pattern[] = [\n  {\n    id: 'doo-wop',\n    name: 'Doo‑Wop (I–vi–IV–V)',\n    mode: 'major',\n    seq: ['I','vi','IV','V'],\n    summary: \"50s/60s loop: I→vi→IV→V back to I.\",\n  },\n  {\n    id: 'axis',\n    name: 'Axis (I–V–vi–IV)',\n    mode: 'major',\n    seq: ['I','V','vi','IV'],\n    summary: 'Modern pop four‑chords loop.',\n  },\n  {\n    id: 'canon',\n    name: \"Pachelbel's Canon\",\n    mode: 'major',\n    seq: ['I','V','vi','iii','IV','I','IV','V'],\n    variants: [['I','V','vi','IV']],\n    summary: 'Pachelbel‑style ground; long loop back to I.',\n  },\n  {\n    id: 'ii-V-I',\n    name: 'ii–V–I',\n    mode: 'any',\n    seq: ['ii','V','I'],\n    summary: 'The classic resolution run‑up.',\n  },\n  {\n    id: 'turnaround',\n    name: 'Turnaround (I–vi–ii–V)',\n    mode: 'any',\n    seq: ['I','vi','ii','V'],\n    summary: 'Quick loop returning to the top.',\n  },\n  {\n    id: 'andalusian',\n    name: 'Andalusian (i–VII–VI–V)',\n    mode: 'minor',\n    seq: ['i','VII','VI','V'],\n    summary: 'Classic minor descent; flamenco/Latin flavor.',\n  },\n  {\n    id: 'authentic',\n    name: 'Authentic cadence (V–I)',\n    mode: 'any',\n    seq: ['V','I'],\n    summary: 'Perfect cadence V→I.',\n  },\n  {\n    id: 'plagal',\n    name: 'Plagal cadence (IV–I)',\n    mode: 'any',\n    seq: ['IV','I'],\n    summary: 'Gentle IV→I resolution.',\n  },\n  {\n    id: 'deceptive',\n    name: 'Deceptive cadence (V–vi)',\n    mode: 'major',\n    seq: ['V','vi'],\n    summary: 'Deceptive V→vi keeps motion going.',\n  },\n];\n\n// --- English microcopy for pattern tooltips ------------------------------\nexport type RomanPatternId =\n  | \"dooWop\"\n  | \"axis\"\n  | \"canon\"\n  | \"twoFiveOne\"\n  | \"turnaround\"\n  | \"andalusian\"\n  | \"authentic\"   // perfect V→I\n  | \"plagal\"      // IV→I\n  | \"deceptive\";  // V→vi\n\nexport const PATTERN_LABEL_EN: Record<RomanPatternId, string> = {\n  dooWop: \"Doo‑Wop (I–VI–IV–V)\",\n  axis: \"Axis (I–V–vi–IV)\",\n  canon: \"Canon (I–V–vi–iii–IV–I–IV–V)\",\n  twoFiveOne: \"ii–V–I\",\n  turnaround: \"Turnaround\",\n  andalusian: \"Andalusian cadence\",\n  authentic: \"Perfect cadence (V → I)\",\n  plagal: \"Plagal cadence (IV → I)\",\n  deceptive: \"Deceptive cadence (V → vi)\",\n};\n\nexport const PATTERN_SUMMARY_EN: Record<RomanPatternId, string> = {\n  dooWop:\n    \"’50s progression. Nostalgic loop: tonic → relative minor → subdominant → dominant. Try adding 7ths for color.\",\n  axis:\n    \"Modern pop staple. A catchy loop that feels forward yet stable. Swap to ii–V at the end for a stronger landing.\",\n  canon:\n    \"Pachelbel‑style ground. Persistent bass motion with rotating functions; great for variations and melodies.\",\n  twoFiveOne:\n    \"The classic run‑up then land. Link by guide tones (3rd↔7th). Works anywhere you want a clear resolution.\",\n  turnaround:\n    \"Short cycle that brings you back to the top (e.g., I–VI7–ii7–V7). Use at phrase ends or between sections.\",\n  andalusian:\n    \"Descending minor flavor (e.g., i–♭VII–♭VI–V). Adds drama; land clearly on the target chord.\",\n  authentic:\n    \"Strong homecoming: dominant pulls into tonic. Extend V with 7/9/13; keep the landing clean on I.\",\n  plagal:\n    \"Gentler IV → I resolution. Use to soften endings or after a bright Lydian moment.\",\n  deceptive:\n    \"Twist the expectation: V → vi instead of I. Keeps energy moving; return to I later for closure.\",\n};\n\nexport function patternInfoEN(id: RomanPatternId) {\n  return { label: PATTERN_LABEL_EN[id], summary: PATTERN_SUMMARY_EN[id] };\n}\n\n"],"names":[],"mappings":";;;;;;;;;;AAYO,MAAM,WAAsB;IACjC;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;YAAK;YAAK;SAAI;QACxB,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;YAAI;YAAK;SAAK;QACxB,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;YAAI;YAAK;YAAM;YAAK;YAAI;YAAK;SAAI;QAC3C,UAAU;YAAC;gBAAC;gBAAI;gBAAI;gBAAK;aAAK;SAAC;QAC/B,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAK;YAAI;SAAI;QACnB,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;YAAK;YAAK;SAAI;QACxB,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;YAAM;YAAK;SAAI;QACzB,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;SAAI;QACd,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAK;SAAI;QACf,SAAS;IACX;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,KAAK;YAAC;YAAI;SAAK;QACf,SAAS;IACX;CACD;AAcM,MAAM,mBAAmD;IAC9D,QAAQ;IACR,MAAM;IACN,OAAO;IACP,YAAY;IACZ,YAAY;IACZ,YAAY;IACZ,WAAW;IACX,QAAQ;IACR,WAAW;AACb;AAEO,MAAM,qBAAqD;IAChE,QACE;IACF,MACE;IACF,OACE;IACF,YACE;IACF,YACE;IACF,YACE;IACF,WACE;IACF,QACE;IACF,WACE;AACJ;AAEO,SAAS,cAAc,EAAkB;IAC9C,OAAO;QAAE,OAAO,gBAAgB,CAAC,GAAG;QAAE,SAAS,kBAAkB,CAAC,GAAG;IAAC;AACxE","debugId":null}},
    {"offset": {"line": 5128, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/roman/match.ts"],"sourcesContent":["import { PATTERNS } from \"./patterns\";\n\nexport function normalizeRomanToken(tok: string): string {\n  const t = (tok || \"\").toString().trim().toUpperCase();\n  // Remove qualities/extensions, keep degree with optionally B/#\n  return t\n    .replace(/MAJ7|M7|7|MAJ|MIN|MI|DIM|AUG|SUS\\d?|ADD\\d+|Ø|O/g, \"\")\n    .replace(/\\(|\\)/g, \"\")\n    .replace(/[^IVB#]+/g, \"\")\n    .replace(/B/g, \"B\");\n}\n\nexport type Match = {\n  id: string; name: string; summary: string;\n  start: number; end: number; // [start, end)\n};\n\nexport function matchPatterns(\n  romanLine: string[], mode: 'major'|'minor'\n): Match[] {\n  const rom = romanLine.map(normalizeRomanToken);\n  const hits: Match[] = [];\n\n  for (const p of PATTERNS) {\n    const seqs = [p.seq, ...(p.variants ?? [])].map(s => s.map(normalizeRomanToken));\n    for (const seq of seqs) {\n      const L = seq.length;\n      // slide over roman tokens\n      for (let i = 0; i + L <= rom.length; i++) {\n        let ok = true;\n        for (let k = 0; k < L; k++) {\n          if (rom[i + k] !== seq[k]) { ok = false; break; }\n        }\n        if (ok) {\n          hits.push({ id: p.id, name: p.name, summary: p.tooltip, start: i, end: i + L });\n          break; // prefer first longest match for this pattern\n        }\n      }\n    }\n  }\n  hits.sort((a,b)=> (b.end-b.start)-(a.end-a.start));\n  return dedupe(hits);\n}\n\nfunction dedupe(xs: Match[]): Match[] {\n  const res: Match[] = [];\n  for (const m of xs) {\n    if (res.some(r => !(m.end <= r.start || r.end <= m.start))) continue;\n    res.push(m);\n  }\n  return res;\n}\n\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,SAAS,oBAAoB,GAAW;IAC7C,MAAM,IAAI,CAAC,OAAO,EAAE,EAAE,QAAQ,GAAG,IAAI,GAAG,WAAW;IACnD,+DAA+D;IAC/D,OAAO,EACJ,OAAO,CAAC,mDAAmD,IAC3D,OAAO,CAAC,UAAU,IAClB,OAAO,CAAC,aAAa,IACrB,OAAO,CAAC,MAAM;AACnB;AAOO,SAAS,cACd,SAAmB,EAAE,IAAqB;IAE1C,MAAM,MAAM,UAAU,GAAG,CAAC;IAC1B,MAAM,OAAgB,EAAE;IAExB,KAAK,MAAM,KAAK,wJAAQ,CAAE;YACC;QAAzB,MAAM,OAAO;YAAC,EAAE,GAAG;eAAM,CAAA,cAAA,EAAE,QAAQ,cAAV,yBAAA,cAAc,EAAE;SAAE,CAAC,GAAG,CAAC,CAAA,IAAK,EAAE,GAAG,CAAC;QAC3D,KAAK,MAAM,OAAO,KAAM;YACtB,MAAM,IAAI,IAAI,MAAM;YACpB,0BAA0B;YAC1B,IAAK,IAAI,IAAI,GAAG,IAAI,KAAK,IAAI,MAAM,EAAE,IAAK;gBACxC,IAAI,KAAK;gBACT,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;oBAC1B,IAAI,GAAG,CAAC,IAAI,EAAE,KAAK,GAAG,CAAC,EAAE,EAAE;wBAAE,KAAK;wBAAO;oBAAO;gBAClD;gBACA,IAAI,IAAI;oBACN,KAAK,IAAI,CAAC;wBAAE,IAAI,EAAE,EAAE;wBAAE,MAAM,EAAE,IAAI;wBAAE,SAAS,EAAE,OAAO;wBAAE,OAAO;wBAAG,KAAK,IAAI;oBAAE;oBAC7E,OAAO,8CAA8C;gBACvD;YACF;QACF;IACF;IACA,KAAK,IAAI,CAAC,CAAC,GAAE,IAAK,AAAC,EAAE,GAAG,GAAC,EAAE,KAAK,GAAE,CAAC,EAAE,GAAG,GAAC,EAAE,KAAK;IAChD,OAAO,OAAO;AAChB;AAEA,SAAS,OAAO,EAAW;IACzB,MAAM,MAAe,EAAE;IACvB,KAAK,MAAM,KAAK,GAAI;QAClB,IAAI,IAAI,IAAI,CAAC,CAAA,IAAK,CAAC,CAAC,EAAE,GAAG,IAAI,EAAE,KAAK,IAAI,EAAE,GAAG,IAAI,EAAE,KAAK,IAAI;QAC5D,IAAI,IAAI,CAAC;IACX;IACA,OAAO;AACT","debugId":null}},
    {"offset": {"line": 5192, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/features/sketch/storage.ts"],"sourcesContent":["// src/features/sketch/storage.ts\nimport { Sketch } from '@/types/sketch';\n\nconst KEY = 'ot_sketches';\nconst FREE_LIMIT = 3;\n\nexport const loadAll = (): Sketch[] =>\n  JSON.parse(localStorage.getItem(KEY) || '[]');\n\nexport const saveLocalFree = (sk: Sketch): { ok: boolean; reason?: string } => {\n  const list = loadAll().filter(s => s.id !== sk.id);\n  list.unshift(sk); // 先頭が最新\n  if (list.length > FREE_LIMIT) {\n    // LRU超過 → Pro誘導\n    localStorage.setItem(KEY, JSON.stringify(list.slice(0, FREE_LIMIT)));\n    return { ok: false, reason: 'limit_exceeded' };\n  }\n  localStorage.setItem(KEY, JSON.stringify(list));\n  return { ok: true };\n};\n\n// Pro同期はスケルトン（実装済みAPIがあれば差し替え）\nexport const saveCloudPro = async (sk: Sketch) => {\n  // await fetch('/api/sketch', { method:'POST', body: JSON.stringify(sk) })\n  return { ok: true };\n};\n\n// Free/Proの境界はSSOTの通り。保存/呼び出し/自動保存の3点がM1の核。\n"],"names":[],"mappings":"AAAA,iCAAiC;;;;;;;;;AAGjC,MAAM,MAAM;AACZ,MAAM,aAAa;AAEZ,MAAM,UAAU,IACrB,KAAK,KAAK,CAAC,aAAa,OAAO,CAAC,QAAQ;AAEnC,MAAM,gBAAgB,CAAC;IAC5B,MAAM,OAAO,UAAU,MAAM,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK,GAAG,EAAE;IACjD,KAAK,OAAO,CAAC,KAAK,QAAQ;IAC1B,IAAI,KAAK,MAAM,GAAG,YAAY;QAC5B,gBAAgB;QAChB,aAAa,OAAO,CAAC,KAAK,KAAK,SAAS,CAAC,KAAK,KAAK,CAAC,GAAG;QACvD,OAAO;YAAE,IAAI;YAAO,QAAQ;QAAiB;IAC/C;IACA,aAAa,OAAO,CAAC,KAAK,KAAK,SAAS,CAAC;IACzC,OAAO;QAAE,IAAI;IAAK;AACpB;AAGO,MAAM,eAAe,OAAO;IACjC,0EAA0E;IAC1E,OAAO;QAAE,IAAI;IAAK;AACpB,GAEA,4CAA4C","debugId":null}},
    {"offset": {"line": 5233, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/features/sketch/useSketch.ts"],"sourcesContent":["// src/features/sketch/useSketch.ts\nimport { useEffect, useRef, useState } from 'react';\nimport { Sketch } from '@/types/sketch';\nimport * as store from './storage';\nimport * as t from '@/lib/telemetry';\n\nexport const useSketch = (isPro: boolean) => {\n  const [sketch, setSketch] = useState<Sketch | null>(null);\n  const timer = useRef<number | null>(null);\n\n  const scheduleAutosave = () => {\n    if (timer.current) window.clearTimeout(timer.current);\n    timer.current = window.setTimeout(() => {\n      if (!sketch) return;\n      (async () => {\n        const r = isPro ? await store.saveCloudPro(sketch) : store.saveLocalFree(sketch);\n        if (!r.ok && r.reason === 'limit_exceeded') {\n          t.track('project_limit_warn', { page: 'chord_progression' });\n          // UI側で「3件まで」トースト表示\n        } else {\n          t.track('save_project', { page: 'chord_progression' });\n        }\n      })();\n    }, 3000); // 3秒アイドル\n  };\n\n  // 状態が変わるたびに自動保存を予約\n  useEffect(() => { scheduleAutosave(); /* eslint-disable-next-line */ }, [sketch]);\n\n  return { sketch, setSketch };\n};\n"],"names":[],"mappings":"AAAA,mCAAmC;;;;;AACnC;AAEA;AACA;;;;;AAEO,MAAM,YAAY,CAAC;;IACxB,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,yKAAQ,EAAgB;IACpD,MAAM,QAAQ,IAAA,uKAAM,EAAgB;IAEpC,MAAM,mBAAmB;QACvB,IAAI,MAAM,OAAO,EAAE,OAAO,YAAY,CAAC,MAAM,OAAO;QACpD,MAAM,OAAO,GAAG,OAAO,UAAU,CAAC;YAChC,IAAI,CAAC,QAAQ;YACb,CAAC;gBACC,MAAM,IAAI,QAAQ,MAAM,uJAAkB,CAAC,UAAU,wJAAmB,CAAC;gBACzE,IAAI,CAAC,EAAE,EAAE,IAAI,EAAE,MAAM,KAAK,kBAAkB;oBAC1C,mIAAO,CAAC,sBAAsB;wBAAE,MAAM;oBAAoB;gBAC1D,mBAAmB;gBACrB,OAAO;oBACL,mIAAO,CAAC,gBAAgB;wBAAE,MAAM;oBAAoB;gBACtD;YACF,CAAC;QACH,GAAG,OAAO,SAAS;IACrB;IAEA,mBAAmB;IACnB,IAAA,0KAAS;+BAAC;YAAQ,oBAAoB,4BAA4B;QAAG;8BAAG;QAAC;KAAO;IAEhF,OAAO;QAAE;QAAQ;IAAU;AAC7B;GAxBa","debugId":null}},
    {"offset": {"line": 5289, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/store/sketchStore.ts"],"sourcesContent":["import { create } from 'zustand';\nimport { Sketch } from '@/types/sketch';\nimport { loadAll, saveLocalFree, saveCloudPro } from '@/features/sketch/storage';\n\ntype SketchState = {\n  sketches: Sketch[];\n  currentSketch: Sketch | null;\n  isLoading: boolean;\n  error: string | null;\n\n  // Actions\n  loadSketches: () => void;\n  saveSketch: (sketch: Omit<Sketch, 'id' | 'createdAt' | 'updatedAt'>) => Promise<{ ok: boolean; reason?: string }>;\n  loadSketch: (id: string) => void;\n  deleteSketch: (id: string) => void;\n  duplicateSketch: (id: string) => void;\n  renameSketch: (id: string, name: string) => void;\n\n  // Auto-save\n  startAutoSave: (sketch: Sketch) => void;\n  stopAutoSave: () => void;\n};\n\nconst generateId = () => Math.random().toString(36).substr(2, 9);\n\nexport const useSketchStore = create<SketchState>((set, get) => ({\n  sketches: [],\n  currentSketch: null,\n  isLoading: false,\n  error: null,\n\n  loadSketches: () => {\n    set({ isLoading: true, error: null });\n    try {\n      const sketches = loadAll();\n      set({ sketches, isLoading: false });\n    } catch (error) {\n      set({ error: 'Failed to load sketches', isLoading: false });\n    }\n  },\n\n  saveSketch: async (sketchData) => {\n    const sketch: Sketch = {\n      ...sketchData,\n      id: generateId(),\n      createdAt: new Date().toISOString(),\n      updatedAt: new Date().toISOString(),\n    };\n\n    // Freeユーザーの場合\n    const result = saveLocalFree(sketch);\n\n    if (result.ok) {\n      // ローカルストレージが更新されたので、ストアも更新\n      const sketches = loadAll();\n      set({ sketches, currentSketch: sketch });\n      return { ok: true };\n    } else {\n      // Proユーザーの場合（スケルトン実装）\n      try {\n        await saveCloudPro(sketch);\n        const sketches = loadAll();\n        set({ sketches, currentSketch: sketch });\n        return { ok: true };\n      } catch (error) {\n        return { ok: false, reason: 'cloud_save_failed' };\n      }\n    }\n  },\n\n  loadSketch: (id: string) => {\n    const sketches = get().sketches;\n    const sketch = sketches.find(s => s.id === id);\n    if (sketch) {\n      set({ currentSketch: sketch });\n    }\n  },\n\n  deleteSketch: (id: string) => {\n    const sketches = get().sketches.filter(s => s.id !== id);\n    localStorage.setItem('ot_sketches', JSON.stringify(sketches));\n    set({ sketches });\n\n    if (get().currentSketch?.id === id) {\n      set({ currentSketch: null });\n    }\n  },\n\n  duplicateSketch: (id: string) => {\n    const sketches = get().sketches;\n    const original = sketches.find(s => s.id === id);\n    if (original) {\n      const duplicate: Sketch = {\n        ...original,\n        id: generateId(),\n        name: `${original.name} Copy`,\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n      };\n\n      const result = saveLocalFree(duplicate);\n      if (result.ok) {\n        const updatedSketches = loadAll();\n        set({ sketches: updatedSketches, currentSketch: duplicate });\n      }\n    }\n  },\n\n  renameSketch: (id: string, name: string) => {\n    const sketches = get().sketches.map(s =>\n      s.id === id ? { ...s, name, updatedAt: new Date().toISOString() } : s\n    );\n\n    localStorage.setItem('ot_sketches', JSON.stringify(sketches));\n    set({ sketches });\n\n    if (get().currentSketch?.id === id) {\n      set({ currentSketch: { ...get().currentSketch, name, updatedAt: new Date().toISOString() } });\n    }\n  },\n\n  startAutoSave: (sketch: Sketch) => {\n    // 3秒アイドル後に自動保存\n    const timeoutId = setTimeout(() => {\n      const currentState = get();\n      if (currentState.currentSketch?.id === sketch.id) {\n        // 変更があった場合のみ保存\n        const updatedSketch = { ...sketch, updatedAt: new Date().toISOString() };\n        const result = saveLocalFree(updatedSketch);\n        if (result.ok) {\n          const sketches = loadAll();\n          set({ sketches, currentSketch: updatedSketch });\n        }\n      }\n    }, 3000);\n\n    // タイムアウトIDを保持（クリーンアップ用）\n    return timeoutId;\n  },\n\n  stopAutoSave: () => {\n    // 自動保存をキャンセル\n  },\n}));\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5459, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/export/png.ts"],"sourcesContent":["// src/lib/export/png.ts\nimport * as t from '@/lib/telemetry';\nimport { toPng } from 'html-to-image';\n\nlet exporting = false;\n\nexport async function exportPng(el: HTMLElement, theme:'auto'|'light'|'dark'='auto') {\n  if (exporting) return; // 重複防止\n  exporting = true;\n  try {\n    // 一時的に可視化してレンダリングを確実にする\n    const originalOpacity = el.style.opacity;\n    const originalVisibility = el.style.visibility;\n    el.style.opacity = '1';\n    el.style.visibility = 'visible';\n    \n    // Fretboard内の全てのテキスト要素を強制的に黒色にし、フレット番号ボックスの背景を調整\n    const allElements = el.querySelectorAll('*');\n    const originalStyles: Array<{ elem: HTMLElement; color: string; fill: string; bg: string }> = [];\n    allElements.forEach((elem) => {\n      const htmlElem = elem as HTMLElement;\n      const originalColor = htmlElem.style.color;\n      const originalFill = htmlElem.style.fill;\n      const originalBg = htmlElem.style.background;\n      originalStyles.push({ elem: htmlElem, color: originalColor, fill: originalFill, bg: originalBg });\n      \n      // 全てのテキストを黒色に\n      htmlElem.style.color = '#000000';\n      if (htmlElem.tagName === 'text' || htmlElem.tagName === 'tspan') {\n        htmlElem.style.fill = '#000000';\n      }\n      \n      // フレット番号を含むspan要素の背景を薄いグレーに変更\n      if (htmlElem.tagName === 'SPAN' && htmlElem.className.includes('inline-block')) {\n        const text = htmlElem.textContent?.trim();\n        if (text && /^\\d+$/.test(text)) {\n          htmlElem.style.background = '#f3f4f6'; // 薄いグレー (Tailwind gray-100相当)\n          htmlElem.style.color = '#000000';\n        }\n      }\n    });\n    \n    // レンダリング完了を待つ\n    await new Promise(resolve => setTimeout(resolve, 150));\n    \n    el.dataset.export = theme; // CSSでテーマ反転を制御\n    const dataUrl = await toPng(el, { pixelRatio: 2, backgroundColor: '#ffffff', cacheBust: true });\n    \n    // 元に戻す\n    el.style.opacity = originalOpacity;\n    el.style.visibility = originalVisibility;\n    originalStyles.forEach(({ elem, color, fill, bg }) => {\n      elem.style.color = color;\n      elem.style.fill = fill;\n      elem.style.background = bg;\n    });\n    \n    const a = document.createElement('a');\n    a.href = dataUrl; a.download = 'ot-progression.png'; a.click();\n    t.track('export_png', { page: 'chord_progression', ok: true });\n  } catch (e) {\n    t.track('export_png', { page: 'chord_progression', ok: false, err: String(e) });\n  } finally {\n    el.removeAttribute('data-export');\n    exporting = false;\n  }\n}\n"],"names":[],"mappings":"AAAA,wBAAwB;;;;;AACxB;AACA;;;AAEA,IAAI,YAAY;AAET,eAAe,UAAU,EAAe;QAAE,QAAA,iEAA4B;IAC3E,IAAI,WAAW,QAAQ,OAAO;IAC9B,YAAY;IACZ,IAAI;QACF,wBAAwB;QACxB,MAAM,kBAAkB,GAAG,KAAK,CAAC,OAAO;QACxC,MAAM,qBAAqB,GAAG,KAAK,CAAC,UAAU;QAC9C,GAAG,KAAK,CAAC,OAAO,GAAG;QACnB,GAAG,KAAK,CAAC,UAAU,GAAG;QAEtB,iDAAiD;QACjD,MAAM,cAAc,GAAG,gBAAgB,CAAC;QACxC,MAAM,iBAAwF,EAAE;QAChG,YAAY,OAAO,CAAC,CAAC;YACnB,MAAM,WAAW;YACjB,MAAM,gBAAgB,SAAS,KAAK,CAAC,KAAK;YAC1C,MAAM,eAAe,SAAS,KAAK,CAAC,IAAI;YACxC,MAAM,aAAa,SAAS,KAAK,CAAC,UAAU;YAC5C,eAAe,IAAI,CAAC;gBAAE,MAAM;gBAAU,OAAO;gBAAe,MAAM;gBAAc,IAAI;YAAW;YAE/F,cAAc;YACd,SAAS,KAAK,CAAC,KAAK,GAAG;YACvB,IAAI,SAAS,OAAO,KAAK,UAAU,SAAS,OAAO,KAAK,SAAS;gBAC/D,SAAS,KAAK,CAAC,IAAI,GAAG;YACxB;YAEA,8BAA8B;YAC9B,IAAI,SAAS,OAAO,KAAK,UAAU,SAAS,SAAS,CAAC,QAAQ,CAAC,iBAAiB;oBACjE;gBAAb,MAAM,QAAO,wBAAA,SAAS,WAAW,cAApB,4CAAA,sBAAsB,IAAI;gBACvC,IAAI,QAAQ,QAAQ,IAAI,CAAC,OAAO;oBAC9B,SAAS,KAAK,CAAC,UAAU,GAAG,WAAW,8BAA8B;oBACrE,SAAS,KAAK,CAAC,KAAK,GAAG;gBACzB;YACF;QACF;QAEA,cAAc;QACd,MAAM,IAAI,QAAQ,CAAA,UAAW,WAAW,SAAS;QAEjD,GAAG,OAAO,CAAC,MAAM,GAAG,OAAO,eAAe;QAC1C,MAAM,UAAU,MAAM,IAAA,8JAAK,EAAC,IAAI;YAAE,YAAY;YAAG,iBAAiB;YAAW,WAAW;QAAK;QAE7F,OAAO;QACP,GAAG,KAAK,CAAC,OAAO,GAAG;QACnB,GAAG,KAAK,CAAC,UAAU,GAAG;QACtB,eAAe,OAAO,CAAC;gBAAC,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE,EAAE,EAAE;YAC/C,KAAK,KAAK,CAAC,KAAK,GAAG;YACnB,KAAK,KAAK,CAAC,IAAI,GAAG;YAClB,KAAK,KAAK,CAAC,UAAU,GAAG;QAC1B;QAEA,MAAM,IAAI,SAAS,aAAa,CAAC;QACjC,EAAE,IAAI,GAAG;QAAS,EAAE,QAAQ,GAAG;QAAsB,EAAE,KAAK;QAC5D,mIAAO,CAAC,cAAc;YAAE,MAAM;YAAqB,IAAI;QAAK;IAC9D,EAAE,OAAO,GAAG;QACV,mIAAO,CAAC,cAAc;YAAE,MAAM;YAAqB,IAAI;YAAO,KAAK,OAAO;QAAG;IAC/E,SAAU;QACR,GAAG,eAAe,CAAC;QACnB,YAAY;IACd;AACF","debugId":null}},
    {"offset": {"line": 5551, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music/chordParser.ts"],"sourcesContent":["/**\n * コード記号のパースとMIDI音への変換\n */\n\nimport { nameToPc, DEFAULT_MIDI_OCTAVE } from './constants';\n\nexport type ChordIntervals = number[];\n\nexport type ParsedChord = {\n  rootPc: number;\n  quality: string;\n  intervals: ChordIntervals;\n};\n\n/**\n * コード記号をパースして構成音のインターバルを返す\n * \n * @param symbol コード記号（例: \"Cmaj7\", \"Am\", \"G7\"）\n * @returns パース結果（ルート音、クオリティ、インターバル）\n */\nexport function parseChordSymbol(symbol: string): ParsedChord | null {\n  // ルート音とクオリティを分離\n  const match = symbol.match(/^([A-G](?:#|b)?)(.*)$/);\n  if (!match) return null;\n\n  const root = match[1];\n  const quality = (match[2] || '').toLowerCase();\n  const rootPc = nameToPc(root);\n  \n  if (rootPc < 0) return null;\n\n  const intervals = getIntervalsForQuality(quality, symbol);\n  \n  return { rootPc, quality, intervals };\n}\n\n/**\n * クオリティ文字列からインターバルを取得\n */\nfunction getIntervalsForQuality(quality: string, originalSymbol: string): ChordIntervals {\n  // 基本トライアド\n  let base: ChordIntervals;\n  \n  // マイナーコードの判定（\"m\" があるが \"maj\" ではない）\n  if (/(^|[^a-z])m(?!aj)/.test(quality)) {\n    base = [0, 3, 7]; // Minor\n  } else if (/dim|°/.test(quality)) {\n    return [0, 3, 6]; // Diminished\n  } else if (/aug|\\+/.test(quality)) {\n    return [0, 4, 8]; // Augmented\n  } else {\n    base = [0, 4, 7]; // Major (default)\n  }\n\n  // 7thコードの処理\n  if (/maj7|M7/.test(originalSymbol)) {\n    return [...base, 11]; // Major 7th\n  } else if (/7/.test(quality)) {\n    return [...base, 10]; // Dominant 7th\n  }\n\n  // 6thコードの処理\n  if (/6/.test(quality)) {\n    return [...base.slice(0, 3), 9]; // 6th\n  }\n\n  // Suspendedコードの処理\n  if (/sus4/.test(quality)) {\n    return [0, 5, 7]; // sus4\n  } else if (/sus2/.test(quality)) {\n    return [0, 2, 7]; // sus2\n  }\n\n  // 9thコードの処理（簡易版）\n  if (/9/.test(quality)) {\n    return [...base, 10, 14]; // Add 9th (2 octaves up)\n  }\n\n  return base;\n}\n\n/**\n * コード記号からMIDI音番号の配列を生成\n * \n * @param symbol コード記号\n * @param octave ベースとなるオクターブ（デフォルト: C4 = 60）\n * @returns MIDI音番号の配列、パース失敗時はnull\n */\nexport function chordToMidi(symbol: string, octave: number = DEFAULT_MIDI_OCTAVE): number[] | null {\n  const parsed = parseChordSymbol(symbol);\n  if (!parsed) return null;\n\n  const base = octave + parsed.rootPc;\n  return parsed.intervals.map(interval => base + interval);\n}\n\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;AAED;;AAgBO,SAAS,iBAAiB,MAAc;IAC7C,gBAAgB;IAChB,MAAM,QAAQ,OAAO,KAAK,CAAC;IAC3B,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,OAAO,KAAK,CAAC,EAAE;IACrB,MAAM,UAAU,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,EAAE,WAAW;IAC5C,MAAM,SAAS,IAAA,+IAAQ,EAAC;IAExB,IAAI,SAAS,GAAG,OAAO;IAEvB,MAAM,YAAY,uBAAuB,SAAS;IAElD,OAAO;QAAE;QAAQ;QAAS;IAAU;AACtC;AAEA;;CAEC,GACD,SAAS,uBAAuB,OAAe,EAAE,cAAsB;IACrE,UAAU;IACV,IAAI;IAEJ,kCAAkC;IAClC,IAAI,oBAAoB,IAAI,CAAC,UAAU;QACrC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,QAAQ;IAC5B,OAAO,IAAI,QAAQ,IAAI,CAAC,UAAU;QAChC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,aAAa;IACjC,OAAO,IAAI,SAAS,IAAI,CAAC,UAAU;QACjC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,YAAY;IAChC,OAAO;QACL,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,kBAAkB;IACtC;IAEA,YAAY;IACZ,IAAI,UAAU,IAAI,CAAC,iBAAiB;QAClC,OAAO;eAAI;YAAM;SAAG,EAAE,YAAY;IACpC,OAAO,IAAI,IAAI,IAAI,CAAC,UAAU;QAC5B,OAAO;eAAI;YAAM;SAAG,EAAE,eAAe;IACvC;IAEA,YAAY;IACZ,IAAI,IAAI,IAAI,CAAC,UAAU;QACrB,OAAO;eAAI,KAAK,KAAK,CAAC,GAAG;YAAI;SAAE,EAAE,MAAM;IACzC;IAEA,kBAAkB;IAClB,IAAI,OAAO,IAAI,CAAC,UAAU;QACxB,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,OAAO;IAC3B,OAAO,IAAI,OAAO,IAAI,CAAC,UAAU;QAC/B,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,OAAO;IAC3B;IAEA,iBAAiB;IACjB,IAAI,IAAI,IAAI,CAAC,UAAU;QACrB,OAAO;eAAI;YAAM;YAAI;SAAG,EAAE,yBAAyB;IACrD;IAEA,OAAO;AACT;AASO,SAAS,YAAY,MAAc;QAAE,SAAA,iEAAiB,0JAAmB;IAC9E,MAAM,SAAS,iBAAiB;IAChC,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,OAAO,SAAS,OAAO,MAAM;IACnC,OAAO,OAAO,SAAS,CAAC,GAAG,CAAC,CAAA,WAAY,OAAO;AACjD","debugId":null}},
    {"offset": {"line": 5664, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/Toast.client.tsx"],"sourcesContent":["\"use client\";\nimport { useEffect, useCallback } from 'react';\nimport { useCtaTracking } from '@/hooks/useCtaTracking';\n\nexport type ToastType = 'info' | 'success' | 'warning';\nexport type ToastCtaPlace = 'limit_toast' | 'png_toast';\n\nexport interface ToastProps {\n  message: string;\n  type?: ToastType;\n  ctaText?: string;\n  ctaHref?: string;\n  ctaPlace?: ToastCtaPlace;\n  onClose: () => void;\n  duration?: number;\n}\n\nconst TOAST_COLORS: Record<ToastType, string> = {\n  info: 'bg-blue-600',\n  success: 'bg-green-600',\n  warning: 'bg-orange-600',\n};\n\nconst DEFAULT_DURATION = 5000;\n\n/**\n * M3.5: Toast notification component\n * Displays temporary notifications with optional CTA\n * Auto-dismisses after duration (default 5s)\n */\nexport default function Toast({ \n  message, \n  type = 'info', \n  ctaText, \n  ctaHref, \n  ctaPlace,\n  onClose, \n  duration = DEFAULT_DURATION \n}: ToastProps) {\n  const { trackClick } = useCtaTracking();\n\n  useEffect(() => {\n    if (duration > 0) {\n      const timer = setTimeout(onClose, duration);\n      return () => clearTimeout(timer);\n    }\n  }, [duration, onClose]);\n\n  const handleCtaClick = useCallback(() => {\n    if (ctaPlace) {\n      trackClick(ctaPlace);\n    }\n  }, [ctaPlace, trackClick]);\n\n  const bgColor = TOAST_COLORS[type];\n\n  return (\n    <div \n      className=\"fixed bottom-20 sm:bottom-6 left-1/2 -translate-x-1/2 z-50 animate-slide-up max-w-md w-full mx-4\"\n      role=\"alert\"\n      aria-live=\"polite\"\n    >\n      <div className={`${bgColor} text-white rounded-lg shadow-2xl p-4 flex items-center justify-between gap-3`}>\n        <div className=\"flex-1 min-w-0\">\n          <p className=\"text-sm font-medium\">{message}</p>\n        </div>\n        {ctaText && ctaHref && (\n          <a\n            href={ctaHref}\n            target=\"_blank\"\n            rel=\"noopener noreferrer\"\n            className=\"flex-shrink-0 px-3 py-1.5 text-sm font-medium bg-white/20 hover:bg-white/30 rounded transition-colors\"\n            onClick={handleCtaClick}\n          >\n            {ctaText}\n          </a>\n        )}\n        <button\n          onClick={onClose}\n          className=\"flex-shrink-0 w-6 h-6 flex items-center justify-center hover:bg-white/20 rounded transition-colors\"\n          aria-label=\"Close notification\"\n        >\n          ✕\n        </button>\n      </div>\n    </div>\n  );\n}\n\n"],"names":[],"mappings":";;;;;AACA;AACA;;;AAFA;;;AAiBA,MAAM,eAA0C;IAC9C,MAAM;IACN,SAAS;IACT,SAAS;AACX;AAEA,MAAM,mBAAmB;AAOV,SAAS,MAAM,KAQjB;QARiB,EAC5B,OAAO,EACP,OAAO,MAAM,EACb,OAAO,EACP,OAAO,EACP,QAAQ,EACR,OAAO,EACP,WAAW,gBAAgB,EAChB,GARiB;;IAS5B,MAAM,EAAE,UAAU,EAAE,GAAG,IAAA,mJAAc;IAErC,IAAA,0KAAS;2BAAC;YACR,IAAI,WAAW,GAAG;gBAChB,MAAM,QAAQ,WAAW,SAAS;gBAClC;uCAAO,IAAM,aAAa;;YAC5B;QACF;0BAAG;QAAC;QAAU;KAAQ;IAEtB,MAAM,iBAAiB,IAAA,4KAAW;6CAAC;YACjC,IAAI,UAAU;gBACZ,WAAW;YACb;QACF;4CAAG;QAAC;QAAU;KAAW;IAEzB,MAAM,UAAU,YAAY,CAAC,KAAK;IAElC,qBACE,6LAAC;QACC,WAAU;QACV,MAAK;QACL,aAAU;kBAEV,cAAA,6LAAC;YAAI,WAAW,AAAC,GAAU,OAAR,SAAQ;;8BACzB,6LAAC;oBAAI,WAAU;8BACb,cAAA,6LAAC;wBAAE,WAAU;kCAAuB;;;;;;;;;;;gBAErC,WAAW,yBACV,6LAAC;oBACC,MAAM;oBACN,QAAO;oBACP,KAAI;oBACJ,WAAU;oBACV,SAAS;8BAER;;;;;;8BAGL,6LAAC;oBACC,SAAS;oBACT,WAAU;oBACV,cAAW;8BACZ;;;;;;;;;;;;;;;;;AAMT;GAzDwB;;QASC,mJAAc;;;KATf","debugId":null}},
    {"offset": {"line": 5781, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chords/types.ts"],"sourcesContent":["export type Plan = 'free' | 'pro';\nexport type NotationStyle = 'english' | 'compact' | 'jazz';\n\nexport type Family = 'maj'|'min'|'dom'|'sus'|'dim'|'aug'|'power';\nexport type Seventh = 'none'|'6'|'maj7'|'7'|'m7'|'m7b5'|'dim7';\nexport type ExtMode = 'add'|'tension';\n\nexport type Extensions = {\n  add9?: boolean; add11?: boolean; add13?: boolean;\n  nine?: boolean; eleven?: boolean; thirteen?: boolean;\n};\n\nexport type Alterations = { b9?:boolean; s9?:boolean; s11?:boolean; b13?:boolean; alt?:boolean; };\n\nexport type ChordSpec = {\n  root: string;\n  family: Family;\n  seventh: Seventh;\n  extMode: ExtMode;\n  ext: Extensions;\n  alt: Alterations;\n  sus?: 'sus2'|'sus4'|null;\n  slash?: string|null; // /bass\n};\n\nexport type ChordContext = {\n  plan: Plan;\n  notationStyle: NotationStyle; // default: 'english'\n};\n\nexport const DEFAULT_CONTEXT: ChordContext = { plan: 'free', notationStyle: 'english' };\n\n\n\n"],"names":[],"mappings":";;;;AA8BO,MAAM,kBAAgC;IAAE,MAAM;IAAQ,eAAe;AAAU","debugId":null}},
    {"offset": {"line": 5796, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chords/normalize.ts"],"sourcesContent":["import { ChordSpec, ChordContext } from './types';\n\nexport function normalizeChordSpec(input: ChordSpec, ctx: ChordContext, options: {autoCorrect11th?: boolean} = {}){\n  const spec: ChordSpec = JSON.parse(JSON.stringify(input));\n  const warnings: string[] = [];\n\n  // dom は 7th 前提\n  if (spec.family === 'dom') spec.seventh = '7';\n\n  // Pro gating\n  if (ctx.plan === 'free') {\n    // Pro: Tension, Alter, 6/9, /bass をロック\n    if (spec.extMode === 'tension') spec.ext = { nine:false, eleven:false, thirteen:false };\n    spec.alt = {};\n    // 6/9 は Pro 専用（6 と add9 の同時→6/9 変換を禁止）\n    // slash も禁止\n    if (spec.slash) spec.slash = null;\n  }\n\n  // Add/Tension 排他\n  if (spec.extMode === 'add') {\n    spec.ext.nine = spec.ext.eleven = spec.ext.thirteen = false;\n  } else {\n    spec.ext.add9 = spec.ext.add11 = spec.ext.add13 = false;\n  }\n\n  // 13 は 9 を内包\n  if (spec.ext.thirteen) spec.ext.nine = true;\n\n  // sus2/sus4 相互排他（後勝ち）\n  if (spec.sus === 'sus2' && input.sus === 'sus4') spec.sus = 'sus4';\n  if (spec.sus === 'sus4' && input.sus === 'sus2') spec.sus = 'sus2';\n\n  // maj/dom の 11 は回避警告（オプションで自動是正）\n  if (spec.ext.eleven) {\n    if (spec.family === 'maj') {\n      if (options.autoCorrect11th) {\n        // 自動是正: 11 → #11 (Lydian)\n        spec.ext.eleven = false;\n        if (spec.alt) {\n          spec.alt.sharpEleven = true;\n        } else {\n          spec.alt = { sharpEleven: true };\n        }\n        warnings.push('11 → #11 に自動調整しました（メジャーではavoid音のため）。');\n      } else {\n        warnings.push('メジャーでの11は3度と濁ります。#11（Lydian）を検討してください。');\n      }\n    }\n    if (spec.family === 'dom') {\n      if (options.autoCorrect11th) {\n        // 自動是正: 11 → #11 または sus4 の提案（ここでは#11を選択）\n        spec.ext.eleven = false;\n        if (spec.alt) {\n          spec.alt.sharpEleven = true;\n        } else {\n          spec.alt = { sharpEleven: true };\n        }\n        warnings.push('11 → #11 に自動調整しました（ドミナントでは3度と衝突するため）。');\n      } else {\n        warnings.push('ドミナントでの11は3度と衝突します。#11 または sus4 を検討してください。');\n      }\n    }\n  }\n\n  // 非 dom で Alterations は無効\n  if (spec.family !== 'dom') spec.alt = {};\n\n  // maj7 + sus は既定で無効\n  if (spec.seventh === 'maj7' && spec.sus) {\n    warnings.push('maj7 with sus is uncommon; use sus4(maj7) in advanced mode.');\n    spec.sus = null;\n  }\n\n  // Tension は 7th を持つ時のみ活性\n  if (spec.extMode === 'tension' && !['7','maj7','m7'].includes(spec.seventh)) {\n    spec.ext = { nine:false, eleven:false, thirteen:false };\n  }\n\n  return { spec, warnings } as const;\n}\n\n\n\n"],"names":[],"mappings":";;;;AAEO,SAAS,mBAAmB,KAAgB,EAAE,GAAiB;QAAE,UAAA,iEAAuC,CAAC;IAC9G,MAAM,OAAkB,KAAK,KAAK,CAAC,KAAK,SAAS,CAAC;IAClD,MAAM,WAAqB,EAAE;IAE7B,eAAe;IACf,IAAI,KAAK,MAAM,KAAK,OAAO,KAAK,OAAO,GAAG;IAE1C,aAAa;IACb,IAAI,IAAI,IAAI,KAAK,QAAQ;QACvB,uCAAuC;QACvC,IAAI,KAAK,OAAO,KAAK,WAAW,KAAK,GAAG,GAAG;YAAE,MAAK;YAAO,QAAO;YAAO,UAAS;QAAM;QACtF,KAAK,GAAG,GAAG,CAAC;QACZ,uCAAuC;QACvC,YAAY;QACZ,IAAI,KAAK,KAAK,EAAE,KAAK,KAAK,GAAG;IAC/B;IAEA,iBAAiB;IACjB,IAAI,KAAK,OAAO,KAAK,OAAO;QAC1B,KAAK,GAAG,CAAC,IAAI,GAAG,KAAK,GAAG,CAAC,MAAM,GAAG,KAAK,GAAG,CAAC,QAAQ,GAAG;IACxD,OAAO;QACL,KAAK,GAAG,CAAC,IAAI,GAAG,KAAK,GAAG,CAAC,KAAK,GAAG,KAAK,GAAG,CAAC,KAAK,GAAG;IACpD;IAEA,aAAa;IACb,IAAI,KAAK,GAAG,CAAC,QAAQ,EAAE,KAAK,GAAG,CAAC,IAAI,GAAG;IAEvC,sBAAsB;IACtB,IAAI,KAAK,GAAG,KAAK,UAAU,MAAM,GAAG,KAAK,QAAQ,KAAK,GAAG,GAAG;IAC5D,IAAI,KAAK,GAAG,KAAK,UAAU,MAAM,GAAG,KAAK,QAAQ,KAAK,GAAG,GAAG;IAE5D,iCAAiC;IACjC,IAAI,KAAK,GAAG,CAAC,MAAM,EAAE;QACnB,IAAI,KAAK,MAAM,KAAK,OAAO;YACzB,IAAI,QAAQ,eAAe,EAAE;gBAC3B,0BAA0B;gBAC1B,KAAK,GAAG,CAAC,MAAM,GAAG;gBAClB,IAAI,KAAK,GAAG,EAAE;oBACZ,KAAK,GAAG,CAAC,WAAW,GAAG;gBACzB,OAAO;oBACL,KAAK,GAAG,GAAG;wBAAE,aAAa;oBAAK;gBACjC;gBACA,SAAS,IAAI,CAAC;YAChB,OAAO;gBACL,SAAS,IAAI,CAAC;YAChB;QACF;QACA,IAAI,KAAK,MAAM,KAAK,OAAO;YACzB,IAAI,QAAQ,eAAe,EAAE;gBAC3B,0CAA0C;gBAC1C,KAAK,GAAG,CAAC,MAAM,GAAG;gBAClB,IAAI,KAAK,GAAG,EAAE;oBACZ,KAAK,GAAG,CAAC,WAAW,GAAG;gBACzB,OAAO;oBACL,KAAK,GAAG,GAAG;wBAAE,aAAa;oBAAK;gBACjC;gBACA,SAAS,IAAI,CAAC;YAChB,OAAO;gBACL,SAAS,IAAI,CAAC;YAChB;QACF;IACF;IAEA,0BAA0B;IAC1B,IAAI,KAAK,MAAM,KAAK,OAAO,KAAK,GAAG,GAAG,CAAC;IAEvC,oBAAoB;IACpB,IAAI,KAAK,OAAO,KAAK,UAAU,KAAK,GAAG,EAAE;QACvC,SAAS,IAAI,CAAC;QACd,KAAK,GAAG,GAAG;IACb;IAEA,yBAAyB;IACzB,IAAI,KAAK,OAAO,KAAK,aAAa,CAAC;QAAC;QAAI;QAAO;KAAK,CAAC,QAAQ,CAAC,KAAK,OAAO,GAAG;QAC3E,KAAK,GAAG,GAAG;YAAE,MAAK;YAAO,QAAO;YAAO,UAAS;QAAM;IACxD;IAEA,OAAO;QAAE;QAAM;IAAS;AAC1B","debugId":null}},
    {"offset": {"line": 5896, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chords/format.ts"],"sourcesContent":["import { ChordSpec, ChordContext } from './types';\n\nexport function formatChordSymbol(s: ChordSpec, ctx: ChordContext): string {\n  const parts: string[] = [s.root];\n\n  // family: output english by default\n  const fam =\n    s.family === 'maj' ? '' :\n    s.family === 'min' ? 'm' :\n    s.family === 'dom' ? '' :\n    s.family === 'sus' ? 'sus' :\n    s.family === 'dim' ? 'dim' :\n    s.family === 'aug' ? 'aug' : '5';\n  parts.push(fam);\n\n  // seventh\n  const sev =\n    s.seventh === 'maj7' ? (ctx.notationStyle==='compact' ? 'M7' : 'maj7') :\n    s.seventh === '7'    ? '7' :\n    s.seventh === 'm7'   ? 'm7' :\n    s.seventh === '6'    ? '6' :\n    s.seventh === 'm7b5' ? 'm7b5' :\n    s.seventh === 'dim7' ? 'dim7' : '';\n  parts.push(sev);\n\n  // extensions\n  if (s.extMode === 'tension') {\n    if (s.ext.thirteen) parts.push('13');\n    else if (s.ext.eleven) parts.push('11');\n    else if (s.ext.nine) parts.push('9');\n  } else {\n    const adds = [s.ext.add9 && 'add9', s.ext.add11 && 'add11', s.ext.add13 && 'add13'].filter(Boolean) as string[];\n    if (adds.length) parts.push(`(${adds.join(',')})`);\n  }\n\n  // alterations\n  const alt = [s.alt.b9 && 'b9', s.alt.s9 && '#9', s.alt.s11 && '#11', s.alt.b13 && 'b13']\n    .filter(Boolean).join('');\n  parts.push(alt);\n\n  // sus\n  if (s.sus) parts.push(s.sus);\n\n  // /bass\n  if (s.slash) parts.push(`/${s.slash}`);\n\n  return parts.join('');\n}\n\n\n\n"],"names":[],"mappings":";;;;AAEO,SAAS,kBAAkB,CAAY,EAAE,GAAiB;IAC/D,MAAM,QAAkB;QAAC,EAAE,IAAI;KAAC;IAEhC,oCAAoC;IACpC,MAAM,MACJ,EAAE,MAAM,KAAK,QAAQ,KACrB,EAAE,MAAM,KAAK,QAAQ,MACrB,EAAE,MAAM,KAAK,QAAQ,KACrB,EAAE,MAAM,KAAK,QAAQ,QACrB,EAAE,MAAM,KAAK,QAAQ,QACrB,EAAE,MAAM,KAAK,QAAQ,QAAQ;IAC/B,MAAM,IAAI,CAAC;IAEX,UAAU;IACV,MAAM,MACJ,EAAE,OAAO,KAAK,SAAU,IAAI,aAAa,KAAG,YAAY,OAAO,SAC/D,EAAE,OAAO,KAAK,MAAS,MACvB,EAAE,OAAO,KAAK,OAAS,OACvB,EAAE,OAAO,KAAK,MAAS,MACvB,EAAE,OAAO,KAAK,SAAS,SACvB,EAAE,OAAO,KAAK,SAAS,SAAS;IAClC,MAAM,IAAI,CAAC;IAEX,aAAa;IACb,IAAI,EAAE,OAAO,KAAK,WAAW;QAC3B,IAAI,EAAE,GAAG,CAAC,QAAQ,EAAE,MAAM,IAAI,CAAC;aAC1B,IAAI,EAAE,GAAG,CAAC,MAAM,EAAE,MAAM,IAAI,CAAC;aAC7B,IAAI,EAAE,GAAG,CAAC,IAAI,EAAE,MAAM,IAAI,CAAC;IAClC,OAAO;QACL,MAAM,OAAO;YAAC,EAAE,GAAG,CAAC,IAAI,IAAI;YAAQ,EAAE,GAAG,CAAC,KAAK,IAAI;YAAS,EAAE,GAAG,CAAC,KAAK,IAAI;SAAQ,CAAC,MAAM,CAAC;QAC3F,IAAI,KAAK,MAAM,EAAE,MAAM,IAAI,CAAC,AAAC,IAAkB,OAAf,KAAK,IAAI,CAAC,MAAK;IACjD;IAEA,cAAc;IACd,MAAM,MAAM;QAAC,EAAE,GAAG,CAAC,EAAE,IAAI;QAAM,EAAE,GAAG,CAAC,EAAE,IAAI;QAAM,EAAE,GAAG,CAAC,GAAG,IAAI;QAAO,EAAE,GAAG,CAAC,GAAG,IAAI;KAAM,CACrF,MAAM,CAAC,SAAS,IAAI,CAAC;IACxB,MAAM,IAAI,CAAC;IAEX,MAAM;IACN,IAAI,EAAE,GAAG,EAAE,MAAM,IAAI,CAAC,EAAE,GAAG;IAE3B,QAAQ;IACR,IAAI,EAAE,KAAK,EAAE,MAAM,IAAI,CAAC,AAAC,IAAW,OAAR,EAAE,KAAK;IAEnC,OAAO,MAAM,IAAI,CAAC;AACpB","debugId":null}},
    {"offset": {"line": 5944, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/pro/guard.ts"],"sourcesContent":["/**\n * Pro feature guard utilities\n * Defines which chord types require Pro subscription for adding to progression\n */\n\n/**\n * Chord quality types that require Pro subscription\n * - Altered Dominant: 7b9, 7#9, 7#11, 7b13, 7alt\n * - 13th extensions: 13, M13, m13\n * - Slash/On-Bass: detected via 'slash' flag\n */\nconst PRO_ONLY_QUALITIES = new Set([\n  // Altered Dominant\n  '7b9',\n  '7#9',\n  '7#11',\n  '7b13',\n  '7alt',\n  // 13th系\n  '13',\n  'M13',\n  'm13',\n]);\n\n/**\n * Check if a chord quality can be added to progression\n * @param quality - The chord quality string (e.g., '7b9', 'M13')\n * @param options - Options including isPro status and slash (on-bass) flag\n * @returns true if chord can be added, false if Pro subscription required\n */\nexport function canAddQuality(\n  quality: string,\n  options: { isPro: boolean; hasSlash?: boolean }\n): boolean {\n  const { isPro, hasSlash } = options;\n  \n  // Pro users can add everything\n  if (isPro) return true;\n  \n  // Slash/On-Bass requires Pro\n  if (hasSlash) return false;\n  \n  // Check if quality is in Pro-only set\n  return !PRO_ONLY_QUALITIES.has(quality);\n}\n\n/**\n * Check if a chord quality should show Pro badge\n * @param quality - The chord quality string\n * @param hasSlash - Whether slash/on-bass is active\n * @returns true if Pro badge should be shown\n */\nexport function shouldShowProBadge(quality: string, hasSlash?: boolean): boolean {\n  return PRO_ONLY_QUALITIES.has(quality) || !!hasSlash;\n}\n\n/**\n * Get the reason why a chord type is Pro-only (for telemetry/debugging)\n * @param quality - The chord quality string\n * @param hasSlash - Whether slash/on-bass is active\n * @returns Reason string or null if not Pro-only\n */\nexport function getProOnlyReason(quality: string, hasSlash?: boolean): string | null {\n  if (hasSlash) return 'slash';\n  if (quality.includes('alt')) return 'altered';\n  if (quality.includes('13')) return '13th';\n  if (PRO_ONLY_QUALITIES.has(quality)) return 'advanced';\n  return null;\n}\n\n\n"],"names":[],"mappings":"AAAA;;;CAGC,GAED;;;;;CAKC;;;;;;;;AACD,MAAM,qBAAqB,IAAI,IAAI;IACjC,mBAAmB;IACnB;IACA;IACA;IACA;IACA;IACA,QAAQ;IACR;IACA;IACA;CACD;AAQM,SAAS,cACd,OAAe,EACf,OAA+C;IAE/C,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG;IAE5B,+BAA+B;IAC/B,IAAI,OAAO,OAAO;IAElB,6BAA6B;IAC7B,IAAI,UAAU,OAAO;IAErB,sCAAsC;IACtC,OAAO,CAAC,mBAAmB,GAAG,CAAC;AACjC;AAQO,SAAS,mBAAmB,OAAe,EAAE,QAAkB;IACpE,OAAO,mBAAmB,GAAG,CAAC,YAAY,CAAC,CAAC;AAC9C;AAQO,SAAS,iBAAiB,OAAe,EAAE,QAAkB;IAClE,IAAI,UAAU,OAAO;IACrB,IAAI,QAAQ,QAAQ,CAAC,QAAQ,OAAO;IACpC,IAAI,QAAQ,QAAQ,CAAC,OAAO,OAAO;IACnC,IAAI,mBAAmB,GAAG,CAAC,UAAU,OAAO;IAC5C,OAAO;AACT","debugId":null}},
    {"offset": {"line": 5998, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/quality-master.ts"],"sourcesContent":["// Quality Master Data - Single Source of Truth for chord qualities\n// Generated from /Users/nh/App/OtoTheory/docs/content/Quality Master.csv\n\nexport type QualityInfo = {\n  tier: 'Free' | 'Pro';\n  categoryJa: string;\n  categoryEn: string;\n  quality: string;\n  commentJa: string;\n  commentEn: string;\n};\n\nexport const QUALITY_MASTER: QualityInfo[] = [\n  // Free - 基本 (Basics)\n  {\n    tier: 'Free',\n    categoryJa: '基本',\n    categoryEn: 'Basics',\n    quality: 'Major',\n    commentJa: '明るく、ハッピーな響きの基本となるコード。',\n    commentEn: 'The fundamental chord for a bright and happy sound.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本',\n    categoryEn: 'Basics',\n    quality: 'm (minor)',\n    commentJa: '少し切なく、落ち着いた響きの基本となるコード。',\n    commentEn: 'The fundamental chord for a slightly sad and calm sound.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本',\n    categoryEn: 'Basics',\n    quality: '7',\n    commentJa: '次のコードへ進みたくなるような、少し不安定でおしゃれな響き。',\n    commentEn: 'A slightly unstable and stylish sound that creates a sense of resolution to the next chord.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本',\n    categoryEn: 'Basics',\n    quality: 'maj7',\n    commentJa: '明るく、洗練された都会的な響き。',\n    commentEn: 'A bright, sophisticated, and urban sound.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本',\n    categoryEn: 'Basics',\n    quality: 'm7',\n    commentJa: '切なさの中に、おしゃれな雰囲気が加わった響き。',\n    commentEn: 'A sound that adds a stylish atmosphere to sadness.'\n  },\n\n  // Free - 基本の飾り付け (Essential Colors)\n  {\n    tier: 'Free',\n    categoryJa: '基本の飾り付け',\n    categoryEn: 'Essential Colors',\n    quality: 'sus4',\n    commentJa: 'メジャーでもマイナーでもない、解決を待つ浮遊感のある響き。',\n    commentEn: 'A sound with a floating feel, neither major nor minor, awaiting resolution.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本の飾り付け',\n    categoryEn: 'Essential Colors',\n    quality: 'sus2',\n    commentJa: 'sus4よりも、より明るく爽やかな浮遊感を持つ響き。',\n    commentEn: 'A sound with a brighter and fresher floating feel than sus4.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本の飾り付け',\n    categoryEn: 'Essential Colors',\n    quality: 'add9',\n    commentJa: '通常のコードにキラキラした透明感を加える、現代ポップスの定番。',\n    commentEn: 'The go-to chord in modern pop, adding a sparkling transparency to a basic chord.'\n  },\n  {\n    tier: 'Free',\n    categoryJa: '基本の飾り付け',\n    categoryEn: 'Essential Colors',\n    quality: 'dim',\n    commentJa: '不気味で緊張感のある響き。コードとコードを繋ぐ時に便利。',\n    commentEn: 'A spooky and tense sound, useful for connecting one chord to another.'\n  },\n\n  // Pro - ✨ キラキラ・浮遊感 (Sparkle & Float)\n  {\n    tier: 'Pro',\n    categoryJa: '✨ キラキラ・浮遊感',\n    categoryEn: 'Sparkle & Float',\n    quality: 'M9 (maj9)',\n    commentJa: 'ポップス、R&Bの王道おしゃれサウンド。',\n    commentEn: 'The quintessential stylish sound for Pop and R&B.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '✨ キラキラ・浮遊感',\n    categoryEn: 'Sparkle & Float',\n    quality: '6',\n    commentJa: 'maj7より少しレトロで温かい響き。',\n    commentEn: 'A slightly more retro and warmer sound than maj7.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '✨ キラキラ・浮遊感',\n    categoryEn: 'Sparkle & Float',\n    quality: '6/9',\n    commentJa: 'ジャズやフュージョンで多用される、明るく豊かな響き。',\n    commentEn: 'A bright and rich sound frequently used in Jazz and Fusion.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '✨ キラキラ・浮遊感',\n    categoryEn: 'Sparkle & Float',\n    quality: 'add#11',\n    commentJa: '現代的でドリーミーな、まさに「浮遊感」のあるサウンド。',\n    commentEn: 'A modern, dreamy sound that truly gives a \"floating\" feel.'\n  },\n\n  // Pro - 🌃 おしゃれ・都会的 (Stylish & Urban)\n  {\n    tier: 'Pro',\n    categoryJa: '🌃 おしゃれ・都会的',\n    categoryEn: 'Stylish & Urban',\n    quality: 'm9',\n    commentJa: 'm7をさらにスムーズで洗練させた響き。',\n    commentEn: 'An even smoother and more refined sound than m7.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '🌃 おしゃれ・都会的',\n    categoryEn: 'Stylish & Urban',\n    quality: 'm11',\n    commentJa: 'Lo-fi Hip HopやR&Bで定番の、少しアンニュイなサウンド。',\n    commentEn: 'A standard sound in Lo-fi Hip Hop and R&B, with a slightly melancholic vibe.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '🌃 おしゃれ・都会的',\n    categoryEn: 'Stylish & Urban',\n    quality: 'm7b5',\n    commentJa: 'マイナーキーのii-V-Iで必須。ジャズ、ボサノヴァへの入り口。',\n    commentEn: 'Essential for minor key ii-V-I progressions. Your gateway to Jazz and Bossa Nova.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '🌃 おしゃれ・都会的',\n    categoryEn: 'Stylish & Urban',\n    quality: 'mM7',\n    commentJa: '映画音楽のような、ミステリアスでドラマチックな響き。',\n    commentEn: 'A mysterious and dramatic sound, reminiscent of a movie soundtrack.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '🌃 おしゃれ・都会的',\n    categoryEn: 'Stylish & Urban',\n    quality: 'm6',\n    commentJa: 'ジャズや映画音楽で耳にする、少しレトロでミステリアスな響き。',\n    commentEn: 'A slightly retro and mysterious sound, often heard in jazz and film scores.'\n  },\n\n  // Pro - ⚡️ 緊張感・スパイス (Tension & Spice)\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: '7sus4',\n    commentJa: 'V7の前に置くことで、解決感を劇的に高めるプロの技。',\n    commentEn: 'A pro technique that dramatically enhances the feeling of resolution when placed before a V7 chord.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: 'aug',\n    commentJa: '不安定で、次のコードへ進む推進力が強い。',\n    commentEn: 'An unstable sound with a strong drive to move to the next chord.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: 'dim7',\n    commentJa: '経過コードとして非常に便利。緊張感を一気に高める。',\n    commentEn: 'Very useful as a passing chord to instantly increase tension.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: '7(#9)',\n    commentJa: 'ブルージーでロックな緊張感。',\n    commentEn: 'A bluesy and rock-oriented tension.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: '7(b9)',\n    commentJa: 'ジャズで多用される強い緊張感。',\n    commentEn: 'A strong tension frequently used in Jazz.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: '7(#5)',\n    commentJa: 'augと同じ。解決先を強く示す。',\n    commentEn: 'Same as augmented. Strongly indicates the point of resolution.'\n  },\n  {\n    tier: 'Pro',\n    categoryJa: '⚡️ 緊張感・スパイス',\n    categoryEn: 'Tension & Spice',\n    quality: '7(b13)',\n    commentJa: '複雑でムーディーな緊張感。',\n    commentEn: 'A complex and moody tension.'\n  }\n];\n\n// Helper functions\nexport const getQualityInfo = (quality: string): QualityInfo | undefined => {\n  return QUALITY_MASTER.find(q => q.quality === quality);\n};\n\nexport const getProQualities = (): string[] => {\n  return QUALITY_MASTER.filter(q => q.tier === 'Pro').map(q => q.quality);\n};\n\nexport const getFreeQualities = (): string[] => {\n  return QUALITY_MASTER.filter(q => q.tier === 'Free').map(q => q.quality);\n};\n\nexport const isProQuality = (quality: string): boolean => {\n  return QUALITY_MASTER.some(q => q.quality === quality && q.tier === 'Pro');\n};\n\nexport const getQualityComment = (quality: string, locale: 'ja' | 'en'): string => {\n  const info = getQualityInfo(quality);\n  if (!info) return '';\n  return locale === 'ja' ? info.commentJa : info.commentEn;\n};\n\nexport const getQualitiesByCategory = (tier: 'Free' | 'Pro'): Record<string, QualityInfo[]> => {\n  const filtered = QUALITY_MASTER.filter(q => q.tier === tier);\n  const grouped: Record<string, QualityInfo[]> = {};\n  \n  filtered.forEach(q => {\n    if (!grouped[q.categoryJa]) {\n      grouped[q.categoryJa] = [];\n    }\n    grouped[q.categoryJa].push(q);\n  });\n  \n  return grouped;\n};\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 6258, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ChordBuilder.tsx"],"sourcesContent":["\"use client\";\nimport { useMemo, useState, useRef, useEffect } from \"react\";\nimport { DEFAULT_CONTEXT, type ChordContext, type ChordSpec, type Family, type Plan } from \"@/lib/chords/types\";\nimport { normalizeChordSpec } from \"@/lib/chords/normalize\";\nimport { formatChordSymbol } from \"@/lib/chords/format\";\nimport { canAddQuality, shouldShowProBadge } from \"@/lib/pro/guard\";\nimport { QUALITY_MASTER, getQualityComment, getQualitiesByCategory, isProQuality } from \"@/lib/quality-master\";\n\ntype Props = {\n  plan?: Plan;\n  onConfirm?: (symbol: string, spec: ChordSpec) => void;\n  onBlock?: (reason: 'pro_quality' | 'pro_slash', quality?: string) => void;\n  onPreview?: (symbol: string) => void;\n};\n\nconst ROOTS = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'];\n\n// Pro Badge component (small 👑 at top-right of chip)\nconst ProBadge = () => (\n  <span className=\"absolute -top-1 -right-1 text-[10px]\" title=\"Pro専用\">👑</span>\n);\n\nexport default function ChordBuilder({ plan = 'free', onConfirm, onBlock, onPreview }: Props){\n  const baseSpec: ChordSpec = useMemo(() => ({\n    root: 'C',\n    family: 'maj',\n    seventh: 'none',\n    extMode: 'add',\n    ext: {},\n    alt: {},\n    sus: null,\n    slash: null,\n  }), []);\n  const [spec, setSpec] = useState<ChordSpec>(baseSpec);\n  const ctx: ChordContext = { ...DEFAULT_CONTEXT, plan };\n  \n  // Session state for 11th warning (show once per session)\n  const [has11thWarningShown, setHas11thWarningShown] = useState(false);\n\n  const { spec: norm, warnings } = useMemo(() => normalizeChordSpec(spec, ctx), [spec, ctx]);\n  const symbol = useMemo(() => formatChordSymbol(norm, ctx), [norm, ctx]);\n\n  const setRoot = (r: string) => setSpec(s => ({ ...s, root: r }));\n  \n  // Show 11th warning once per session\n  useEffect(() => {\n    if (!has11thWarningShown && norm.ext.eleven && (norm.family === 'maj' || norm.family === 'dom')) {\n      setHas11thWarningShown(true);\n    }\n  }, [norm.ext.eleven, norm.family, has11thWarningShown]);\n\n  // Helper function to convert Japanese category names to English\n  const getEnglishCategoryName = (japaneseCategory: string): string => {\n    switch (japaneseCategory) {\n      case '基本': return 'Basics';\n      case '基本の飾り付け': return 'Essential Colors';\n      case '✨ キラキラ・浮遊感': return '✨ Sparkle & Float';\n      case '🌃 おしゃれ・都会的': return '🌃 Stylish & Urban';\n      case '⚡️ 緊張感・スパイス': return '⚡️ Tension & Spice';\n      default: return japaneseCategory;\n    }\n  };\n\n  // Quality presets based on Quality Master.csv\n  const qualityPresets = useMemo(() => {\n    console.log('🔍 ChordBuilder: Creating quality presets...');\n    const freeQualities = getQualitiesByCategory('Free');\n    const proQualities = getQualitiesByCategory('Pro');\n    \n    // Debug: Log the qualities\n    console.log('🔍 Free qualities:', freeQualities);\n    console.log('🔍 Pro qualities:', proQualities);\n    console.log('🔍 Total qualities in QUALITY_MASTER:', QUALITY_MASTER.length);\n    \n    const presets: Array<{ \n      label: string; \n      apply: () => void; \n      pro?: boolean; \n      locked?: boolean;\n      comment?: string;\n      category?: string;\n    }> = [];\n\n    // Free qualities only - show Japanese category names for Japanese version\n    Object.entries(freeQualities).forEach(([category, qualities]) => {\n      qualities.forEach(quality => {\n        const qualityLabel = quality.quality === 'm (minor)' ? 'm' : \n                           quality.quality === 'Major' ? 'M' : \n                           quality.quality === 'maj7' ? 'M7' : quality.quality;\n        \n        presets.push({\n          label: qualityLabel,\n          apply: () => {\n            const spec = getSpecFromQuality(quality.quality);\n            if (spec) setSpec(spec);\n          },\n          pro: false, // Free quality\n          comment: quality.commentJa,\n          category: category // Use Japanese category names\n        });\n      });\n    });\n\n    // Pro qualities - show Japanese category names, only if user has Pro\n    if (plan === 'pro') {\n      Object.entries(proQualities).forEach(([category, qualities]) => {\n        qualities.forEach(quality => {\n          const qualityLabel = quality.quality === 'M9 (maj9)' ? 'M9' : \n                             quality.quality === 'm7b5' ? 'm7b5' :\n                             quality.quality === 'mM7' ? 'mM7' :\n                             quality.quality === 'm6' ? 'm6' :\n                             quality.quality === '7(#9)' ? '7(#9)' :\n                             quality.quality === '7(b9)' ? '7(b9)' :\n                             quality.quality === '7(#5)' ? '7(#5)' :\n                             quality.quality === '7(b13)' ? '7(b13)' :\n                             quality.quality;\n          \n          presets.push({\n            label: qualityLabel,\n            apply: () => {\n              const spec = getSpecFromQuality(quality.quality);\n              if (spec) setSpec(spec);\n            },\n            pro: true,\n            comment: quality.commentJa,\n            category: category // Use Japanese category names\n          });\n        });\n      });\n    }\n\n    return presets;\n  }, [plan]);\n\n  // Helper function to convert quality string to ChordSpec\n  const getSpecFromQuality = (quality: string): ChordSpec | null => {\n    const baseSpec = { ext: {}, alt: {}, sus: null, slash: null };\n    \n    switch (quality) {\n      case 'Major': return { ...baseSpec, root: 'C', family: 'maj', seventh: 'none', extMode: 'add' };\n      case 'm (minor)': return { ...baseSpec, root: 'C', family: 'min', seventh: 'none', extMode: 'add' };\n      case '7': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', extMode: 'tension' };\n      case 'maj7': return { ...baseSpec, root: 'C', family: 'maj', seventh: 'maj7', extMode: 'add' };\n      case 'm7': return { ...baseSpec, root: 'C', family: 'min', seventh: 'm7', extMode: 'add' };\n      case 'sus4': return { ...baseSpec, root: 'C', family: 'sus', sus: 'sus4', seventh: 'none', extMode: 'add' };\n      case 'sus2': return { ...baseSpec, root: 'C', family: 'sus', sus: 'sus2', seventh: 'none', extMode: 'add' };\n      case 'add9': return { ...baseSpec, root: 'C', family: 'maj', seventh: 'none', extMode: 'add', ext: { add9: true } };\n      case 'dim': return { ...baseSpec, root: 'C', family: 'dim', seventh: 'none', extMode: 'add' };\n      case 'M9 (maj9)': return { ...baseSpec, root: 'C', family: 'maj', seventh: 'maj7', extMode: 'add', ext: { add9: true } };\n      case '6': return { ...baseSpec, root: 'C', family: 'maj', seventh: '6', extMode: 'add' };\n      case '6/9': return { ...baseSpec, root: 'C', family: 'maj', seventh: '6', extMode: 'add', ext: { add9: true } };\n      case 'add#11': return { ...baseSpec, root: 'C', family: 'maj', seventh: 'none', extMode: 'add', ext: { add11: true }, alt: { s11: true } };\n      case 'm9': return { ...baseSpec, root: 'C', family: 'min', seventh: 'm7', extMode: 'add', ext: { add9: true } };\n      case 'm11': return { ...baseSpec, root: 'C', family: 'min', seventh: 'm7', extMode: 'add', ext: { add9: true, add11: true } };\n      case 'm7b5': return { ...baseSpec, root: 'C', family: 'min', seventh: 'm7b5', extMode: 'add' };\n      case 'mM7': return { ...baseSpec, root: 'C', family: 'min', seventh: 'maj7', extMode: 'add' };\n      case 'm6': return { ...baseSpec, root: 'C', family: 'min', seventh: '6', extMode: 'add' };\n      case '7sus4': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', sus: 'sus4', extMode: 'tension' };\n      case 'aug': return { ...baseSpec, root: 'C', family: 'aug', seventh: 'none', extMode: 'add' };\n      case 'dim7': return { ...baseSpec, root: 'C', family: 'dim', seventh: 'dim7', extMode: 'add' };\n      case '7(#9)': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', extMode: 'tension', alt: { sharp9: true } };\n      case '7(b9)': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', extMode: 'tension', alt: { flat9: true } };\n      case '7(#5)': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', extMode: 'tension', alt: { sharp5: true } };\n      case '7(b13)': return { ...baseSpec, root: 'C', family: 'dom', seventh: '7', extMode: 'tension', alt: { flat13: true } };\n      default: return null;\n    }\n  };\n\n  const renderChip = (\n    label: string, \n    active: boolean, \n    onClick: () => void, \n    opts?: { disabled?: boolean; locked?: boolean; showProBadge?: boolean; comment?: string }\n  ) => (\n    <div key={label} className=\"relative inline-block\">\n      <button\n        className={`h-9 px-3 rounded border text-xs ${active ? 'bg-[var(--brand-primary)] text-white' : ''} ${opts?.locked ? 'opacity-50' : ''}`}\n        onClick={() => { \n          if (!opts?.disabled && !opts?.locked) {\n            onClick(); \n          } else if (opts?.locked) {\n            // Pro quality clicked in free plan\n            onBlock?.('pro_quality', label);\n          }\n        }}\n        title={opts?.locked ? 'Proで解放' : opts?.comment}\n        aria-disabled={opts?.disabled || opts?.locked}\n        onContextMenu={(e) => {\n          e.preventDefault();\n          if (opts?.comment) {\n            // Show comment tooltip on right-click/long-press\n            // For now, we'll use the title attribute, but this could be enhanced with a custom tooltip\n          }\n        }}\n      >{label}</button>\n      {opts?.showProBadge && plan === 'free' && <ProBadge />}\n    </div>\n  );\n\n  return (\n    <div className=\"space-y-4\">\n      <div>\n        <div className=\"text-xs opacity-70 mb-0.5\">ルート</div>\n        <div className=\"flex gap-1 overflow-x-auto whitespace-nowrap py-0 -mx-2 px-2\">\n          {ROOTS.map(r => renderChip(r, norm.root === r, () => setRoot(r)))}\n        </div>\n      </div>\n\n      <div>\n        <div className=\"text-xs opacity-70 mb-0.5\">クイック ({plan === 'free' ? qualityPresets.filter(p => !p.pro).length : qualityPresets.length}種類)</div>\n        <div className=\"flex gap-1 overflow-x-auto whitespace-nowrap py-0 -mx-2 px-2\">\n          {qualityPresets\n            .filter(p => plan === 'free' ? !p.pro : true)\n            .map(p => (\n            <div key={p.label} className=\"relative\">\n              {renderChip(p.label, false, p.apply, { \n                locked: !!p.locked, \n                showProBadge: !!p.pro,\n                comment: p.comment \n              })}\n            </div>\n          ))}\n        </div>\n      </div>\n\n      {/* Advanced (Pro) section - only show Pro qualities */}\n      {plan === 'free' ? (\n        <details>\n          <summary className=\"cursor-pointer text-sm\">高度な機能 (Pro) 👑</summary>\n          <div className=\"mt-3 space-y-3\">\n            <div className=\"text-sm opacity-70 p-4 bg-gray-50 rounded-lg\">\n              Pro版では、より高度なコード品質をご利用いただけます。\n            </div>\n          </div>\n        </details>\n      ) : (\n        <details>\n          <summary className=\"cursor-pointer text-sm\">高度な機能 (Pro)</summary>\n          <div className=\"mt-3 space-y-3\">\n            {/* Pro qualities grouped by category */}\n            {Object.entries(getQualitiesByCategory('Pro')).map(([category, qualities]) => (\n              <div key={category}>\n                <div className=\"text-xs opacity-70 mb-0.5\">{category}</div>\n                <div className=\"flex gap-1 overflow-x-auto whitespace-nowrap py-0 -mx-2 px-2\">\n                  {qualities.map(quality => {\n                    const qualityLabel = quality.quality === 'M9 (maj9)' ? 'M9' : \n                                       quality.quality === 'm7b5' ? 'm7b5' :\n                                       quality.quality === 'mM7' ? 'mM7' :\n                                       quality.quality === 'm6' ? 'm6' :\n                                       quality.quality === '7(#9)' ? '7(#9)' :\n                                       quality.quality === '7(b9)' ? '7(b9)' :\n                                       quality.quality === '7(#5)' ? '7(#5)' :\n                                       quality.quality === '7(b13)' ? '7(b13)' :\n                                       quality.quality;\n                    \n                    return (\n                      <div key={quality.quality} className=\"relative\">\n                        {renderChip(qualityLabel, false, () => {\n                          const spec = getSpecFromQuality(quality.quality);\n                          if (spec) setSpec(spec);\n                        }, { \n                          comment: quality.commentJa \n                        })}\n                      </div>\n                    );\n                  })}\n                </div>\n              </div>\n            ))}\n          </div>\n        </details>\n      )}\n\n      {warnings.length > 0 && (\n        <div className=\"text-xs text-yellow-600 dark:text-yellow-400\">\n          {warnings[0]}\n        </div>\n      )}\n\n      <div className=\"bg-gradient-to-r from-blue-50 to-purple-50 dark:from-blue-900/20 dark:to-purple-900/20 rounded-lg p-4 border border-blue-200 dark:border-blue-800\">\n        <div className=\"flex items-center justify-between mb-3\">\n          <div className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">プレビュー</div>\n          <div className=\"text-lg font-bold text-blue-600 dark:text-blue-400\">\n            {symbol || 'コードを選択してください'}\n          </div>\n        </div>\n        <div className=\"flex gap-2 justify-center\">\n          <button \n            className=\"flex items-center gap-1 rounded-lg bg-green-500 hover:bg-green-600 text-white px-4 py-2 text-sm font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed\"\n            onClick={() => onPreview?.(symbol)}\n            disabled={!symbol}\n          >\n            <svg className=\"w-4 h-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n              <path d=\"M8 5v10l8-5-8-5z\"/>\n            </svg>\n            再生\n          </button>\n          <button \n            className=\"rounded-lg border border-gray-300 dark:border-gray-600 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors\" \n            onClick={() => setSpec(baseSpec)}\n          >\n            クリア\n          </button>\n          <button\n            className=\"rounded-lg bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white px-6 py-2 text-sm font-medium transition-all transform hover:scale-105\"\n            onClick={() => {\n              // Check if chord can be added\n              const isPro = plan === 'pro';\n              const hasSlash = !!norm.slash;\n              \n              // Simple quality extraction for guard check\n              // (This is a simplified check - actual quality depends on full spec)\n              let qualityToCheck = '';\n              if (norm.ext.thirteen) qualityToCheck = '13';\n              else if (norm.alt.b9) qualityToCheck = '7b9';\n              else if (norm.alt.s9) qualityToCheck = '7#9';\n              else if (norm.alt.s11) qualityToCheck = '7#11';\n              else if (norm.alt.b13) qualityToCheck = '7b13';\n              else if (norm.alt.alt) qualityToCheck = '7alt';\n              \n              const canAdd = canAddQuality(qualityToCheck, { isPro, hasSlash });\n              \n              if (!canAdd) {\n                // Block and notify parent\n                if (hasSlash) {\n                  onBlock?.('pro_slash');\n                } else {\n                  onBlock?.('pro_quality', qualityToCheck);\n                }\n              } else {\n                // Allow add\n                onConfirm?.(symbol, norm);\n              }\n            }}\n          >\n            追加\n          </button>\n        </div>\n      </div>\n    </div>\n  );\n}\n\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 7028, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/app/chord-progression/page.tsx"],"sourcesContent":["\"use client\";\nimport React from \"react\";\nimport AdSlot from \"@/components/AdSlot.client\";\nimport { useCallback, useEffect, useMemo, useRef, useState, useTransition } from \"react\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport Fretboard from \"@/components/Fretboard\";\nimport CapoFold from \"@/components/CapoFold\";\nimport { rankKeys, rankScales, type ScaleRank, PITCHES, detectCadence, noteToPc, romanToChordSymbol, type Mode } from \"@/lib/theory\";\nimport { getScalePitchesById, getScalePitches, scaleTypeLabel, normalizeScaleId, SCALE_INTERVALS, parentModeOf } from \"@/lib/scales\";\nimport { diatonicTriads, triadToChordSym } from \"@/lib/theory/diatonic\";\nimport { SCALE_CATALOG } from \"@/lib/scaleCatalog\";\nimport { toRoman, type Mode as RomanMode } from \"@/lib/theory/roman\";\nimport { useAnalysisStore } from \"@/store/analysisStore\";\nimport { formatCadenceLabel, cadenceTooltip, formatCadenceShort } from \"@/lib/ui/cadence\";\nimport type { CadenceType } from \"@/lib/ui/cadence\";\nimport SectionTitle from \"@/components/SectionTitle\";\nimport InfoDot from \"@/components/ui/InfoDot\";\nimport { H2, H3 } from \"@/components/ui/Heading\";\n \nimport { inferScaleIdFromLabel, scaleNotes, SCALE_DEFS, type ScaleId } from \"@/lib/theory/scales\";\nimport ScaleChip from \"@/components/ScaleChip\";\nimport { analyzeChordProgression } from \"@/lib/music-theory\";\nimport {\n  QUICK_QUALITIES,\n  ADVANCED_QUALITIES,\n  ADV_EXTENSIONS, ADV_ALTERED_DOM, ADV_DIM_VARIANTS, ADV_SUS_ADDS, ADV_AUG_MAJMIN,\n  isAdvanced, BASS_NOTES\n} from \"@/lib/chords\";\nimport { usePro } from \"@/components/ProProvider\";\nimport { ProGate } from \"@/components/ProGate\";\nimport UpgradeModal from \"@/components/UpgradeModal\";\nimport { getBaseKind, isCompatible } from \"@/lib/compat\";\nimport { copy } from \"@/lib/copy\";\nimport DiatonicCapoTable from \"@/components/DiatonicCapoTable\";\nimport { matchPatterns } from \"@/lib/theory/roman/match\";\nimport { patternInfoEN } from \"@/lib/theory/roman/patterns\";\nimport { ChordFormsPopover } from \"@/components/ChordFormsPopover\";\nimport { player } from \"@/lib/audio/player\";\nimport { buildForm, type FormKind, type FormShape, type Quality } from \"@/lib/chordForms\";\nimport { useSketch } from \"@/features/sketch/useSketch\";\nimport { useSketchStore } from \"@/store/sketchStore\";\nimport { track, trackToast } from \"@/lib/telemetry\";\nimport { exportPng } from \"@/lib/export/png\";\nimport { chordToMidi } from \"@/lib/music/chordParser\";\nimport Toast from \"@/components/Toast.client\";\nimport { useCtaMessages } from \"@/hooks/useCtaMessages\";\nimport { usePathname } from \"next/navigation\";\nimport ChordBuilder from \"@/components/ChordBuilder\";\n\nexport default function FindKeyPage() {\n  const CTA_MESSAGES = useCtaMessages();\n  const pathname = usePathname();\n  const isJapanese = pathname.startsWith('/ja');\n  const rootRowRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(rootRowRef, { orientation: \"horizontal\" });\n  const fbToggleRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(fbToggleRef, { orientation: \"horizontal\" });\n  const presetRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(presetRef, { orientation: \"horizontal\" });\n  const exportRef = useRef<HTMLDivElement | null>(null);\n  const exportCardRef = useRef<HTMLDivElement | null>(null);\n  // スロット固定の進行（空は空文字）。初期値は C–Am–F–G を 1〜4 に配置\n  const [slots, setSlots] = useState<string[]>(() => {\n    const a = new Array(12).fill(\"\");\n    a[0] = \"C\"; a[1] = \"Am\"; a[2] = \"F\"; a[3] = \"G\";\n    return a;\n  });\n  // 表示用の詰めた配列と、元スロットのインデックス\n  const filledIndices = useMemo(() => slots.reduce((acc:number[], v, i)=>{ if (v) acc.push(i); return acc; }, [] as number[]), [slots]);\n  const progression = useMemo(() => filledIndices.map(i => slots[i]), [filledIndices, slots]);\n  // 追加入力のカーソル位置（次の空スロット）\n  const firstEmpty = useMemo(() => { const idx = slots.findIndex(s => !s); return idx === -1 ? 11 : idx; }, [slots]);\n  const [cursorIndex, setCursorIndex] = useState<number>(0);\n  useEffect(() => { setCursorIndex(firstEmpty); }, [firstEmpty]);\n  const ROOTS = useMemo(() => [\n    'C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'\n  ], []);\n  const QUALITIES = useMemo(() => [\n    { label: 'M', value: '' },\n    { label: 'M7', value: 'maj7' },\n    { label: '7', value: '7' },\n    { label: '6', value: '6' },\n    { label: 'add9', value: 'add9' },\n    { label: 'sus4', value: 'sus4' },\n    { label: 'sus2', value: 'sus2' },\n    { label: 'm', value: 'm' },\n    { label: 'm7', value: 'm7' },\n    { label: 'dim', value: 'dim' },\n    { label: 'm7b5', value: 'm7b5' },\n    { label: 'aug', value: 'aug' },\n  ], []);\n  const [rootSel, setRootSel] = useState<string>('C');\n  const [qualitySel, setQualitySel] = useState<string>('M');\n  const [modifiers, setModifiers] = useState<string[]>([]);\n  const TENSIONS = useMemo(() => [\n    { label: 'sus2', value: 'sus2' },\n    { label: 'sus4', value: 'sus4' },\n    { label: 'add9', value: 'add9' },\n    { label: 'add11', value: 'add11' },\n    { label: 'add13', value: 'add13' },\n  ], []);\n  const [tensionsSel, setTensionsSel] = useState<string[]>([]);\n  const [bassSel, setBassSel] = useState<string>('');\n\n  const composeChord = (root: string, quality: string, tensions: string[], bass: string) => {\n    if (!root) return '';\n    const qualityPart = quality || '';\n    const tensionPart = tensions.length ? tensions.join('') : '';\n    const chord = `${root}${qualityPart}${tensionPart}`;\n    return bass ? `${chord}/${bass}` : chord;\n  };\n\n  const toggleTension = (val: string) => {\n    setTensionsSel((prev) => prev.includes(val) ? prev.filter(v => v !== val) : [...prev, val]);\n  };\n  const [result, setResult] = useState<ReturnType<typeof analyzeChordProgression> | null>(null);\n  const [keys, setKeys] = useState<ReturnType<typeof rankKeys>>([]);\n  const [scales, setScales] = useState<ScaleRank[]>([]);\n  const [selectedScaleRank, setSelectedScaleRank] = useState<ScaleRank | null>(null);\n  const [romanLine, setRomanLine] = useState<string[]>([]);\n  const { keyCandidates, selectedKey: selFromStore, analyze: runAnalyze, selectKey, scaleCandidates, selectedScale, selectScale, reset: resetAnalysis } = useAnalysisStore();\n  const [fbDisplay, setFbDisplay] = useState<'degrees'|'names'>('degrees');\n  const [selectedCellId, setSelectedCellId] = useState<string | null>(null);\n  const [overlayChordNotes, setOverlayChordNotes] = useState<string[]|null>(null);\n  const [formsPop, setFormsPop] = useState<null | { at:{x:number;y:number}; rootPc:number; quality:Quality }>(null);\n  const [formShape, setFormShape] = useState<FormShape | null>(null);\n  const resetForms = useCallback(() => { setFormsPop(null); setFormShape(null); }, []);\n  const isHeptatonic = useMemo(() => {\n    const t = selectedScale?.type as any;\n    const ivs = t ? (SCALE_INTERVALS as any)[t] : null;\n    return !ivs || ivs.length === 7;\n  }, [selectedScale?.type]);\n  useEffect(() => {\n    if (!isHeptatonic && fbDisplay !== 'degrees') setFbDisplay('degrees');\n  }, [isHeptatonic]);\n  const [selectedKey, setSelectedKey] = useState<{ tonic: string; mode: RomanMode } | null>(null);\n  const gridRef = useRef<HTMLDivElement | null>(null);\n  const leftWrapRef = useRef<HTMLDivElement | null>(null);\n  const resultRef = useRef<HTMLElement | null>(null);\n  const rightRef = useRef<HTMLElement | null>(null);\n  const [dragIndex, setDragIndex] = useState<number | null>(null);\n  \n  // Mobile touch drag support\n  const touchStartRef = useRef<{ index: number; startX: number; startY: number } | null>(null);\n  const dragPreviewRef = useRef<HTMLDivElement | null>(null);\n  \n  // Playback state\n  const [isPlaying, setIsPlaying] = useState(false);\n  const [bpm, setBpm] = useState(120);\n  const playbackTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const [currentChordIndex, setCurrentChordIndex] = useState<number>(-1);\n  \n  const moveSlot = useCallback((from: number, to: number) => {\n    setSlots(prev => {\n      if (from === to) return prev;\n      const arr = prev.slice();\n      const tmp = arr[from];\n      arr[from] = arr[to];\n      arr[to] = tmp;\n      return arr;\n    });\n  }, []);\n\n  // Mobile drag handlers\n  const [touchDragTarget, setTouchDragTarget] = useState<number | null>(null);\n  \n  const handleTouchStartDrag = useCallback((e: React.TouchEvent, i: number) => {\n    if (!slots[i]) return; // Only drag filled slots\n    e.stopPropagation();\n    const touch = e.touches[0];\n    touchStartRef.current = { index: i, startX: touch.clientX, startY: touch.clientY };\n    setDragIndex(i);\n    setTouchDragTarget(null);\n  }, [slots]);\n\n  const handleTouchMoveDrag = useCallback((e: React.TouchEvent, currentIndex: number) => {\n    if (touchStartRef.current === null || dragIndex === null) return;\n    \n    const touch = e.touches[0];\n    const element = document.elementFromPoint(touch.clientX, touch.clientY);\n    \n    // Find the slot element\n    let slotElement = element;\n    while (slotElement && !slotElement.hasAttribute('data-slot-index')) {\n      slotElement = slotElement.parentElement;\n    }\n    \n    if (slotElement) {\n      const targetIndex = parseInt(slotElement.getAttribute('data-slot-index') || '-1');\n      if (targetIndex >= 0 && targetIndex !== dragIndex) {\n        setTouchDragTarget(targetIndex);\n      }\n    }\n  }, [dragIndex]);\n\n  const handleTouchEndDrag = useCallback((e: React.TouchEvent) => {\n    if (touchStartRef.current !== null && dragIndex !== null && touchDragTarget !== null && dragIndex !== touchDragTarget) {\n      moveSlot(dragIndex, touchDragTarget);\n    }\n    touchStartRef.current = null;\n    setDragIndex(null);\n    setTouchDragTarget(null);\n  }, [dragIndex, touchDragTarget, moveSlot]);\n  \n  // Playback state flag to ensure stopPlayback is effective\n  const isPlayingRef = useRef(false);\n  \n  // Playback functions\n  const stopPlayback = useCallback(() => {\n    isPlayingRef.current = false;\n    if (playbackTimerRef.current) {\n      clearInterval(playbackTimerRef.current);\n      playbackTimerRef.current = null;\n    }\n    setIsPlaying(false);\n    setCurrentChordIndex(-1);\n  }, []);\n  \n  const startPlayback = useCallback(async () => {\n    const filledSlots = slots.map((s, i) => ({ chord: s, index: i })).filter(x => x.chord);\n    if (filledSlots.length === 0) return;\n    \n    // 前回の再生が残っていたら確実に停止\n    stopPlayback();\n    \n    await player.resume();\n    isPlayingRef.current = true;\n    setIsPlaying(true);\n    setCurrentChordIndex(0);\n    \n    // Count-in: simple metronome click\n    const countInBeats = 4;\n    const beatDuration = (60 / bpm) * 1000;\n    \n    for (let i = 0; i < countInBeats; i++) {\n      if (!isPlayingRef.current) return; // 停止されたらカウントイン中でも中断\n      await new Promise(resolve => setTimeout(resolve, beatDuration));\n      if (!isPlayingRef.current) return;\n      // Play a simple click sound (high MIDI note, short duration)\n      player.playNote(84, 100); // C6, 100ms\n    }\n    \n    // Start progression playback (4 beats per chord)\n    let chordIdx = 0;\n    let beatCount = 0;\n    const playBeat = async () => {\n      if (!isPlayingRef.current) {\n        // 停止フラグが立っていたらタイマーをクリア\n        if (playbackTimerRef.current) {\n          clearInterval(playbackTimerRef.current);\n          playbackTimerRef.current = null;\n        }\n        return;\n      }\n      if (beatCount % 4 === 0) {\n        // New chord every 4 beats\n        if (chordIdx >= filledSlots.length) {\n          chordIdx = 0; // Loop\n        }\n        const { chord, index } = filledSlots[chordIdx];\n        setCurrentChordIndex(index);\n        await playChordSymbol(chord);\n        chordIdx++;\n      } else {\n        // Re-trigger the same chord\n        if (chordIdx > 0 && chordIdx <= filledSlots.length) {\n          const { chord } = filledSlots[chordIdx - 1];\n          await playChordSymbol(chord);\n        }\n      }\n      beatCount++;\n    };\n    \n    if (!isPlayingRef.current) return;\n    await playBeat(); // Play first beat immediately\n    if (!isPlayingRef.current) return;\n    playbackTimerRef.current = setInterval(playBeat, beatDuration);\n    \n    track('progression_play', { page: 'chord_progression', bpm, chordCount: filledSlots.length });\n  }, [slots, bpm, stopPlayback]);\n  \n  const togglePlayback = useCallback(() => {\n    if (isPlaying) {\n      stopPlayback();\n    } else {\n      startPlayback();\n    }\n  }, [isPlaying, startPlayback, stopPlayback]);\n  \n  // Stop playback when component unmounts or slots change\n  useEffect(() => {\n    return () => {\n      if (playbackTimerRef.current) {\n        clearInterval(playbackTimerRef.current);\n      }\n    };\n  }, []);\n  \n  useEffect(() => {\n    if (isPlaying) {\n      stopPlayback();\n    }\n  }, [slots]);\n  \n  const removeSlot = useCallback((idx: number) => {\n    setSlots(prev => { const arr = prev.slice(); arr[idx] = \"\"; return arr; });\n  }, []);\n  const { isPro } = usePro();\n  const { sketch, setSketch } = useSketch(isPro);\n  const sketchIdRef = useRef<string | null>(null);\n  const ensureSketchId = () => { if (!sketchIdRef.current) sketchIdRef.current = Math.random().toString(36).slice(2, 10); return sketchIdRef.current; };\n  const { sketches, loadSketches, deleteSketch, saveSketch } = useSketchStore();\n  const [showSketchList, setShowSketchList] = useState(false);\n  const [selectedSketchForAction, setSelectedSketchForAction] = useState<any>(null);\n  const sketchesDropRef = useRef<HTMLDivElement | null>(null);\n  const [sketchName, setSketchName] = useState<string>(\"\");\n  \n  // Preset popup state\n  const [showPresetPopup, setShowPresetPopup] = useState(false);\n  const [presetKey, setPresetKey] = useState<string>('C');\n  const presetPopupRef = useRef<HTMLDivElement>(null);\n  useEffect(() => { if (showSketchList) loadSketches(); }, [showSketchList, loadSketches]);\n  useEffect(() => {\n    const onDown = (e: MouseEvent) => {\n      if (!showSketchList) return;\n      const el = sketchesDropRef.current;\n      if (el && !el.contains(e.target as Node)) setShowSketchList(false);\n    };\n    const onKey = (e: KeyboardEvent) => { if (e.key === 'Escape') setShowSketchList(false); };\n    document.addEventListener('mousedown', onDown);\n    document.addEventListener('keydown', onKey);\n    return () => { document.removeEventListener('mousedown', onDown); document.removeEventListener('keydown', onKey); };\n  }, [showSketchList]);\n  \n  // Close preset popup on outside click or ESC\n  useEffect(() => {\n    if (!showPresetPopup) return;\n    const onDown = (e: MouseEvent) => {\n      const el = presetPopupRef.current;\n      if (el && !el.contains(e.target as Node)) setShowPresetPopup(false);\n    };\n    const onKey = (e: KeyboardEvent) => { if (e.key === 'Escape') setShowPresetPopup(false); };\n    document.addEventListener('mousedown', onDown);\n    document.addEventListener('keydown', onKey);\n    return () => { document.removeEventListener('mousedown', onDown); document.removeEventListener('keydown', onKey); };\n  }, [showPresetPopup]);\n\n  // Save（Result内のプロンプト）\n  const [showNamePrompt, setShowNamePrompt] = useState(false);\n  const [nameInput, setNameInput] = useState(\"\");\n  const defaultSketchName = useMemo(() => (progression.length ? progression.join(\" \") : `Untitled ${new Date().toLocaleString()}`), [progression]);\n\n  // M3.5: Toast notifications\n  const [toastConfig, setToastConfig] = useState<{\n    message: string;\n    type: 'info' | 'success' | 'warning';\n    ctaText?: string;\n    ctaHref?: string;\n    ctaPlace?: 'limit_toast' | 'png_toast';\n  } | null>(null);\n\n  const toastShownRef = useRef<Set<string>>(new Set());\n\n  // M3.5: Show toast when reaching 9-12 chords\n  useEffect(() => {\n    const filledCount = slots.filter(s => s !== \"\").length;\n    if (filledCount === 9 && !toastShownRef.current.has('limit_warn')) {\n      setToastConfig({\n        message: CTA_MESSAGES.toast.limitWarn,\n        type: 'info',\n        ctaText: CTA_MESSAGES.toast.ctaButton,\n        ctaHref: '/ios-coming-soon',\n        ctaPlace: 'limit_toast'\n      });\n      trackToast('limit_warn', { page: 'chord_progression', chordCount: filledCount });\n      toastShownRef.current.add('limit_warn');\n    } else if (filledCount === 12 && !toastShownRef.current.has('limit_block')) {\n      setToastConfig({\n        message: CTA_MESSAGES.toast.limitBlock,\n        type: 'warning',\n        ctaText: CTA_MESSAGES.toast.ctaButton,\n        ctaHref: '/ios-coming-soon',\n        ctaPlace: 'limit_toast'\n      });\n      trackToast('limit_block', { page: 'chord_progression', chordCount: filledCount });\n      toastShownRef.current.add('limit_block');\n    }\n  }, [slots]);\n  \n  // M3.5: Current sketch name for PNG export\n  const [currentExportName, setCurrentExportName] = useState<string>(\"\");\n\n  const handleExportSketch = async (sk: any) => {\n    try {\n      // Sketchのデータからエクスポートカードを一時的に生成してPNG出力\n      if (!exportCardRef.current) return;\n      \n      // Set the sketch name for export\n      setCurrentExportName(sk.name || \"Untitled Sketch\");\n      \n      // Wait for state update\n      await new Promise(resolve => setTimeout(resolve, 50));\n      \n      // 一時的にopacityを1にしてレンダリング\n      const exportCard = exportCardRef.current;\n      exportCard.style.opacity = '1';\n      exportCard.style.visibility = 'visible';\n      \n      // レンダリング完了を待つ\n      await new Promise(resolve => setTimeout(resolve, 200));\n      \n      // PNG出力\n      await exportPng(exportCard, 'auto');\n      \n      // 元に戻す\n      exportCard.style.opacity = '0.0001';\n      exportCard.style.visibility = 'hidden';\n      setCurrentExportName(\"\");\n      \n      track('export_png', { page: 'chord_progression', source: 'sketch', id: sk.id });\n\n      // M3.5: Show toast after PNG export\n      if (!toastShownRef.current.has('png_export')) {\n        setToastConfig({\n          message: CTA_MESSAGES.toast.pngExport,\n          type: 'success',\n          ctaText: CTA_MESSAGES.toast.ctaButton,\n          ctaHref: '/ios-coming-soon',\n          ctaPlace: 'png_toast'\n        });\n        toastShownRef.current.add('png_export');\n      }\n    } catch (e) {\n      console.error('Export failed:', e);\n      setCurrentExportName(\"\");\n    }\n  };\n  \n  const doSaveSketch = async () => {\n    try {\n      // M3.5: Check Free limit BEFORE saving (directly from localStorage)\n      if (!isPro) {\n        const existingSketches = JSON.parse(localStorage.getItem('ot_sketches') || '[]');\n        console.log('[DEBUG] doSaveSketch - isPro:', isPro, 'existing sketches:', existingSketches.length);\n        \n        if (existingSketches.length >= 3) {\n          console.log('[DEBUG] Blocking save - limit reached');\n          setShowNamePrompt(false);\n          setNameInput(\"\");\n          setToastConfig({\n            message: CTA_MESSAGES.toast.sketchLimit,\n            type: 'warning',\n            ctaText: CTA_MESSAGES.toast.ctaButton,\n            ctaHref: '/ios-coming-soon',\n            ctaPlace: 'limit_toast'\n          });\n          trackToast('limit_block', { page: 'chord_progression', context: 'sketch_limit' });\n          return;\n        }\n      }\n      \n      console.log('[DEBUG] Proceeding with save');\n\n      const tonicGuess = (selFromStore ? PITCHES[selFromStore.tonic] : (selectedKey ? selectedKey.tonic : 'C')) as string;\n      const scaleGuess = (selectedScale?.type as any) || (selFromStore ? (selFromStore.mode as any) : 'Ionian');\n      const name = (nameInput.trim() || defaultSketchName).slice(0, 48);\n      const data: any = {\n        name,\n        schema: 'sketch_v1',\n        appVersion: '3.0.0',\n        key: { tonic: tonicGuess, scaleId: String(scaleGuess) },\n        capo: { fret: 0, note: 'Shaped' },\n        progression: { items: progression.map((c, i) => ({ id: c, degree: '', quality: '' })) },\n        fretboardView: { mode: fbDisplay === 'names' ? 'Names' : 'Degrees', guide: !!overlayChordNotes },\n      };\n      const r = await saveSketch(data);\n      track('save_project', { page: 'chord_progression', ok: r?.ok });\n      setShowNamePrompt(false); setNameInput(\"\");\n    } catch {}\n  };\n  const [showAdv, setShowAdv] = useState<boolean>(false);\n  const [showUpgrade, setShowUpgrade] = useState<boolean>(false);\n  const [addedFlash, setAddedFlash] = useState<boolean>(false);\n  const [isAnalyzing, startAnalyze] = useTransition();\n  const [patternHits, setPatternHits] = useState<{id:string;name:string;summary:string;start:number;end:number}[]>([]);\n  type CadenceView = { type: CadenceType; tail?: { from?: string; to?: string } };\n  const [cadences, setCadences] = useState<CadenceView[]>([]);\n  // Romanハイライト: 範囲(start<=i<end)を保持\n  const [romanHL, setRomanHL] = useState<{ start: number; end: number } | null>(null);\n  // Romanボックスをスクロール対象に\n  const romanBoxRef = useRef<HTMLDivElement | null>(null);\n  // Romanの小文字(i,v,x)だけを大文字化。括弧の中だけに適用するユーティリティ。\n  function upperRomansInParens(name: string): string {\n    return name.replace(/\\(([^)]+)\\)/g, (_: any, inner: string) => {\n      const up = inner.replace(/[ivx]+/g, (m: string) => m.toUpperCase());\n      return `(${up})`;\n    });\n  }\n  type ProgItem = { root: string; quality: string };\n  const parseProg = (arr: string[]): ProgItem[] => arr.map((t) => {\n    const m = t.match(/^([A-G](?:#|b)?)(.*)$/);\n    return { root: m?.[1] || t, quality: (m?.[2] || '') };\n  });\n\n  // Quick: ベース品質の“選択のみ”\n  const onPickBase = (q: string) => {\n    setQualitySel(q);\n    // ベース変更で矛盾する modifier は自動クリア\n    setModifiers((prev) => prev.filter((m) => isCompatible(getBaseKind(q), m)));\n    if (bassSel === rootSel) setBassSel('');\n  };\n\n  // Advanced: 要素のトグル（Pro以外はアップグレード誘導）\n  const toggleModifier = (m: string) => {\n    if (!isPro) { setShowUpgrade(true); return; }\n    if (!isCompatible(getBaseKind(qualitySel), m)) return;\n    setModifiers((prev) => (prev.includes(m) ? prev.filter((x) => x !== m) : [...prev, m]));\n  };\n\n  // Slash: ノートのみ（同音/同じノートで解除）\n  const onPickBass = (n: string) => {\n    if (!isPro) { setShowUpgrade(true); return; }\n    if (n === rootSel || n === bassSel) setBassSel(''); else setBassSel(n);\n  };\n  \n  // Preset helper: Roman numerals to actual chords based on key\n  const applyPreset = (presetName: string, romans: string[], key: string) => {\n    const keyPc = noteToPc(key);\n    if (keyPc === undefined || keyPc < 0 || keyPc > 11) return;\n    \n    // プリセットは基本的にMajor keyで定義されている\n    // （将来的にMinorプリセットを追加する場合は、ここで判定ロジックを追加）\n    const mode: Mode = \"Major\";\n    \n    // theory.tsのromanToChordSymbol関数を使用（文脈化された変換）\n    const chords = romans.map(roman => romanToChordSymbol(roman, keyPc, mode));\n    \n    // Append to existing progression (find first empty slot)\n    setSlots(prev => {\n      const arr = [...prev];\n      let insertIdx = arr.findIndex(s => !s); // Find first empty slot\n      if (insertIdx === -1) insertIdx = 0; // If all full, start from beginning\n      \n      chords.forEach((c, i) => {\n        const targetIdx = (insertIdx + i) % 12;\n        arr[targetIdx] = c;\n      });\n      return arr;\n    });\n    \n    // Move cursor to next empty slot or wrap around\n    setCursorIndex(prev => {\n      const arr = [...slots];\n      chords.forEach((c, i) => {\n        const insertIdx = arr.findIndex(s => !s);\n        if (insertIdx === -1) return 0;\n        const targetIdx = (insertIdx + i) % 12;\n        arr[targetIdx] = c;\n      });\n      const nextEmpty = arr.findIndex(s => !s);\n      return nextEmpty === -1 ? 0 : nextEmpty;\n    });\n    \n    // Don't auto-analyze - user must click Analyze button\n    track('preset_inserted', { page: 'chord_progression', preset: presetName });\n    setShowPresetPopup(false);\n  };\n\n  const analyze = () => {\n    const res = analyzeChordProgression(progression);\n    setResult(res);\n    const ranked = rankKeys(progression);\n    setKeys(ranked.slice(0,4));\n    if (ranked.length > 0) {\n      const mode: RomanMode = ranked[0].mode === \"Major\" ? \"major\" : \"minor\";\n      const keyName = ranked[0].label.split(\" \")[0];\n      const sel = { tonic: keyName, mode } as const;\n      setSelectedKey(sel);\n      setRomanLine(progression.map(c => toRoman(c, sel.tonic, sel.mode, { showQuality: true, uppercase: true })));\n    } else {\n      setScales([]);\n      setSelectedKey(null);\n      setRomanLine([]);\n    }\n    // store-based analysis for Top3 candidates\n    runAnalyze(progression);\n    \n    // Auto-scroll to result section\n    setTimeout(() => {\n      const resultElement = document.getElementById('result');\n      if (resultElement) {\n        resultElement.scrollIntoView({ \n          behavior: 'smooth', \n          block: 'start' \n        });\n      }\n    }, 100);\n  };\n\n  useEffect(() => {\n    const current = selFromStore || selectedKey;\n    if (!current) return;\n    const tonic = typeof (current as any).tonic === 'number' ? PITCHES[(current as any).tonic] : (current as any).tonic;\n    const mode = ((current as any).mode === 'Major' || (current as any).mode === 'Minor') ? ((current as any).mode === 'Major' ? 'major' : 'minor') : (current as any).mode;\n    setRomanLine(progression.map(c => toRoman(c, tonic, mode as RomanMode, { showQuality: true, uppercase: true })));\n  }, [selFromStore, selectedKey, progression]);\n\n  // Roman pattern detection\n  useEffect(() => {\n    if (!selectedKey || romanLine.length === 0) { setPatternHits([]); return; }\n    const mode = (selectedKey.mode as any) as 'major'|'minor';\n    setPatternHits(matchPatterns(romanLine, mode));\n  }, [romanLine, selectedKey]);\n\n  // Cadence detection (rule-based; normalize tokens + loop-boundary)\n  useEffect(() => {\n    if (!romanLine || romanLine.length === 0) { setCadences([]); return; }\n    const norm = romanLine.map((t) => {\n      const m = t.replace(/\\s+/g, \"\").match(/^(b|#)?([ivIV]+)(?:[°ø].*)?/);\n      if (!m) return t.toUpperCase();\n      const acc = m[1] ?? \"\";\n      const core = (m[2] ?? \"\").toUpperCase();\n      return `${acc}${core}`;\n    });\n    let raw: any = null;\n    try { raw = (detectCadence as any)(norm); } catch {}\n    const arr: any[] = Array.isArray(raw) ? raw : (raw ? [raw] : []);\n    const views: CadenceView[] = arr.map((r) => {\n      if (typeof r === 'string') return { type: r as CadenceType };\n      const type = (r?.type ?? r) as CadenceType;\n      const tail = r?.tailRoman ?? (r?.pair ? { from: r.pair[0], to: r.pair[1] } : undefined);\n      return { type, tail };\n    });\n    if (norm.length >= 2) {\n      const last = norm[norm.length - 1];\n      const first = norm[0];\n      if (!views.some(v => v.type === 'perfect') && last === 'V' && first === 'I')\n        views.push({ type: 'perfect', tail: { from: 'V', to: 'I' } });\n      if (!views.some(v => v.type === 'deceptive') && last === 'V' && first === 'VI')\n        views.push({ type: 'deceptive', tail: { from: 'V', to: 'vi' } });\n    }\n    setCadences(views);\n  }, [romanLine]);\n\n  // Fallback cadence (render-time) in case state-based detection fails\n  const fallbackCadence = useMemo(() => {\n    if (!romanLine || romanLine.length === 0) return null as { type: CadenceType; tail?: {from?:string; to?:string} } | null;\n    const norm = romanLine.map((t) => {\n      const m = t.replace(/\\s+/g, \"\").match(/^(b|#)?([ivIV]+)(?:[°ø].*)?/);\n      if (!m) return t.toUpperCase();\n      const acc = m[1] ?? \"\";\n      const core = (m[2] ?? \"\").toUpperCase();\n      return `${acc}${core}`;\n    });\n    if (norm.length < 2) return null;\n    const first = norm[0];\n    const last = norm[norm.length - 1];\n    if (last === 'V' && first === 'I') return { type: 'perfect' as CadenceType, tail: { from: 'V', to: 'I' } };\n    if (last === 'V' && first === 'VI') return { type: 'deceptive' as CadenceType, tail: { from: 'V', to: 'vi' } };\n    if (last === 'V') return { type: 'half' as CadenceType, tail: { from: undefined, to: 'V' } };\n    return null;\n  }, [romanLine]);\n\n  useEffect(() => {\n    const compute = () => {\n      if (!gridRef.current || !leftWrapRef.current || !resultRef.current) return;\n      // Desktopのみmin-heightを計算。モバイルはstickyを使わないため0に戻す。\n      const isDesktop = typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(min-width: 1024px)').matches;\n      if (!isDesktop) {\n        leftWrapRef.current.style.minHeight = '0px';\n        return;\n      }\n      // ループで伸び続けないよう、測定前に一旦0へ戻してから距離を測る\n      const prevMin = leftWrapRef.current.style.minHeight;\n      leftWrapRef.current.style.minHeight = '0px';\n      // 強制リフローでレイアウト確定\n      void leftWrapRef.current.offsetHeight;\n      const gridTop = gridRef.current.getBoundingClientRect().top + window.scrollY;\n      const rightBottom = rightRef.current ? (rightRef.current.getBoundingClientRect().bottom + window.scrollY) : 0;\n      const resultTop = resultRef.current.getBoundingClientRect().top + window.scrollY;\n      // two-col の下端を #result の直前に一致させる。誤差はceilで吸収\n      const stopY = Math.max(rightBottom, resultTop);\n      const minH = Math.max(0, Math.ceil(stopY - gridTop));\n      const prevNum = parseFloat(prevMin || '0');\n      if (Math.abs(minH - prevNum) > 1) {\n        leftWrapRef.current.style.minHeight = `${minH}px`;\n      }\n    };\n    // 初期・安定後\n    requestAnimationFrame(compute);\n    const t = setTimeout(compute, 120);\n    // リサイズはデバウンス\n    let rto: any = null;\n    const onResize = () => {\n      if (rto) clearTimeout(rto);\n      rto = setTimeout(compute, 120);\n    };\n    window.addEventListener('resize', onResize);\n    window.addEventListener('orientationchange', onResize);\n    window.addEventListener('load', compute);\n    // 右パネルサイズ変化を監視（デバウンス付き）\n    let ro: ResizeObserver | null = null;\n    let roResult: ResizeObserver | null = null;\n    if (typeof ResizeObserver !== 'undefined' && rightRef.current) {\n      let rt: any = null;\n      ro = new ResizeObserver(() => {\n        if (rt) clearTimeout(rt);\n        rt = setTimeout(compute, 100);\n      });\n      ro.observe(rightRef.current);\n    }\n    if (typeof ResizeObserver !== 'undefined' && resultRef.current) {\n      let rt2: any = null;\n      roResult = new ResizeObserver(() => {\n        if (rt2) clearTimeout(rt2);\n        rt2 = setTimeout(compute, 100);\n      });\n      roResult.observe(resultRef.current);\n    }\n    return () => {\n      clearTimeout(t);\n      if (rto) clearTimeout(rto);\n      window.removeEventListener('resize', onResize);\n      window.removeEventListener('orientationchange', onResize);\n      window.removeEventListener('load', compute);\n      if (ro) ro.disconnect();\n      if (roResult) roResult.disconnect();\n    };\n  }, []);\n\n  // コンテンツが変わったときにも軽く再同期\n  useEffect(() => {\n    if (!leftWrapRef.current) return;\n    const isDesktop = typeof window !== 'undefined' && window.matchMedia && window.matchMedia('(min-width: 1024px)').matches;\n    if (!isDesktop) return;\n    // 次フレームで再計算\n    requestAnimationFrame(() => {\n      const evt = new Event('resize');\n      window.dispatchEvent(evt);\n    });\n  }, [result, showAdv, progression.length]);\n  const previewLabel = (qualitySel === 'M' ? `${rootSel}` : `${rootSel}${qualitySel}`)\n    + (modifiers.length ? ` ${modifiers.join(' ')}` : '')\n    + (bassSel ? `/${bassSel}` : '');\n  const previewPlay = async () => {\n    if (!rootSel) return;\n    const pc = PITCHES.indexOf(rootSel as any);\n    if (pc < 0) return;\n    const base = 60 + pc; // C4基準\n    const q = qualitySel.toLowerCase();\n    const has = (m: string) => modifiers.includes(m);\n    let intervals: number[] = [0,4,7];\n    if (q.includes('m') && !q.includes('maj')) intervals = [0,3,7];\n    if (q.includes('dim')) intervals = [0,3,6];\n    if (q.includes('maj7') || q.includes('mmaj7')) intervals = [...(q.includes('m')?[0,3,7]:[0,4,7]), 11];\n    else if (q.includes('7')) intervals = [0,4,7,10];\n    if (has('sus2')) intervals = [0,2,7];\n    if (has('sus4')) intervals = [0,5,7];\n    const midis = intervals.map(iv => base + (iv%12));\n    try { await player.resume(); player.playChord(midis, 'lightStrum', 300); } catch {}\n  };\n  // 現在の編集内容をSketchへ反映（3秒アイドルで自動保存）\n  useEffect(() => {\n    try {\n      const id = ensureSketchId();\n      const name = progression.length ? progression.join(\" \").slice(0, 48) : `Untitled ${new Date().toLocaleString()}`;\n      const tonicGuess = (selFromStore ? PITCHES[selFromStore.tonic] : (selectedKey ? selectedKey.tonic : 'C')) as string;\n      const scaleGuess = (selectedScale?.type as any) || (selFromStore ? selFromStore.mode : 'Ionian');\n      setSketch({\n        id,\n        name,\n        createdAt: sketch?.createdAt || new Date().toISOString(),\n        updatedAt: new Date().toISOString(),\n        schema: 'sketch_v1',\n        appVersion: '3.0.0',\n        key: { tonic: tonicGuess, scaleId: String(scaleGuess) },\n        capo: { fret: 0, note: 'Shaped' as any },\n        progression: { items: progression.map((c, i) => ({ id: `${i+1}-${c}`, degree: '', quality: '' })) },\n        fretboardView: { mode: fbDisplay === 'names' ? 'Names' : 'Degrees', guide: !!overlayChordNotes },\n      } as any);\n    } catch {}\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [slots, fbDisplay, overlayChordNotes, selFromStore, selectedKey, selectedScale]);\n  // モバイル判定（SSRと一致させるため初期false、マウント後に判定）\n  const [isTouchDevice, setIsTouchDevice] = useState(false);\n  useEffect(() => {\n    try {\n      const touch = ('ontouchstart' in window) || ((navigator as any)?.maxTouchPoints ?? 0) > 0;\n      setIsTouchDevice(!!touch);\n    } catch { setIsTouchDevice(false); }\n  }, []);\n\n  // 進行チップ（\"C\", \"Am\", \"F\"...）を簡易解析して発音\n  const playChordSymbol = async (symbol: string) => {\n    try {\n      await player.resume();\n      const midis = chordToMidi(symbol);\n      if (midis && midis.length > 0) {\n        player.playChord(midis, 'lightStrum', 300);\n      }\n    } catch (error) {\n      console.error('Failed to play chord:', symbol, error);\n    }\n  };\n  return (\n    <main ref={exportRef as any} className=\"ot-page ot-stack\" data-page=\"find-key\">\n      {/* Progression card: full-width at top */}\n      <section id=\"progression\" className={\"ot-card prog-compact\"}>\n          <div className=\"flex items-center justify-between gap-4 sm:gap-3 mb-1 sm:mb-2\">\n            <div className=\"flex items-center gap-2\">\n              <H2 className=\"mb-0 text-left\">Build progression</H2>\n              <InfoDot\n                title=\"Build Progression\"\n                text={isJapanese \n                  ? \"Choose Chordsからコードを選んでスロットに追加ボタンから追加してください。上部のプリセットからコード進行を選択して追加することもできます。\"\n                  : \"Select chords from Choose Chords and add them using the slot add button. You can also select chord progressions from the presets at the top to add them.\"\n                }\n              />\n            </div>\n          <div className=\"flex flex-wrap items-center gap-2 relative\">\n              {/* Reset, Sketches */}\n            <button\n                type=\"button\"\n                className=\"btn-ghost btn-reset chip-pressable text-sm px-3 py-1 inline-flex items-center gap-1\"\n                title=\"Reset progression\"\n                onClick={() => {\n                  setSlots(Array(12).fill(\"\"));\n                  setCursorIndex(0);\n                  resetAnalysis();\n                  setKeys([]);\n                  setResult(null);\n                  setOverlayChordNotes(null);\n                  setSelectedCellId(null);\n                  setFbDisplay('degrees');\n                }}\n              >\n                <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\" aria-hidden=\"true\">\n                  <path d=\"M12 5V2L7 7l5 5V9c2.76 0 5 2.24 5 5a5 5 0 1 1-5-5z\"/>\n                </svg>\n                <span>Reset</span>\n              </button>\n              <button\n                type=\"button\"\n                className=\"chip-pressable inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs border\"\n                title=\"Show sketches\"\n                onClick={() => setShowSketchList(v=>!v)}\n                aria-expanded={showSketchList}\n              >\n                <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\" aria-hidden=\"true\"><path d=\"M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h12v2H3v-2z\"/></svg>\n                Sketches\n              </button>\n              {showSketchList && (\n                <div ref={sketchesDropRef} className=\"fixed right-4 top-20 z-[10000] w-[320px] max-h-[70vh] overflow-auto rounded-md border bg-white dark:bg-neutral-900 shadow-2xl p-2 space-y-2\">\n                  {sketches.length === 0 ? (\n                    <div className=\"text-xs opacity-70 p-2\">No sketches yet</div>\n                  ) : (\n                    sketches.map((sk) => (\n                      <div key={sk.id} className=\"flex items-center justify-between gap-2 px-2 py-1 rounded hover:bg-black/5 dark:hover:bg-white/10\">\n                        <button\n                          className=\"text-left text-sm flex-1 truncate\"\n                          title={`${sk.name}`}\n                          onClick={() => setSelectedSketchForAction(sk)}\n                        >\n                          {sk.name}\n                        </button>\n                        <button\n                          className=\"ot-btn-ghost text-xs\"\n                          title=\"Delete\"\n                          onClick={(e) => { e.stopPropagation(); deleteSketch(sk.id); loadSketches(); track('project_delete', { page: 'chord_progression', id: sk.id }); }}\n                        >\n                          🗑️\n            </button>\n          </div>\n                    ))\n                  )}\n                </div>\n              )}\n              \n              {/* スペース */}\n              <div className=\"w-4\" aria-hidden=\"true\"></div>\n              \n              {/* 右グループ: Playback controls */}\n              <div className=\"inline-flex items-center gap-2\">\n                <button\n                  type=\"button\"\n                  className=\"chip-pressable text-sm px-3 py-1.5 inline-flex items-center gap-1.5 rounded-lg border\"\n                  title={isPlaying ? \"Stop playback\" : \"Play progression\"}\n                  onClick={togglePlayback}\n                  disabled={progression.length === 0}\n                  style={{ opacity: progression.length === 0 ? 0.5 : 1 }}\n                >\n                  {isPlaying ? (\n                    <>\n                      <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <rect x=\"5\" y=\"5\" width=\"14\" height=\"14\" rx=\"1\"/>\n                      </svg>\n                      <span>Stop</span>\n                    </>\n                  ) : (\n                    <>\n                      <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n                        <path d=\"M8 5v14l11-7z\"/>\n                      </svg>\n                      <span>Play</span>\n                    </>\n                  )}\n                </button>\n                <div className=\"inline-flex items-center gap-1.5\">\n                  <label htmlFor=\"bpm-input\" className=\"text-xs opacity-70\">BPM:</label>\n                  <input\n                    id=\"bpm-input\"\n                    type=\"number\"\n                    min=\"40\"\n                    max=\"240\"\n                    value={bpm}\n                    onChange={(e) => setBpm(Math.max(40, Math.min(240, parseInt(e.target.value) || 120)))}\n                    className=\"w-16 px-2 py-1 text-sm rounded border bg-transparent\"\n                    disabled={isPlaying}\n                  />\n                </div>\n              </div>\n              \n              <select\n                className=\"chip\"\n                aria-label=\"Instrument\"\n                defaultValue={(typeof window!==\"undefined\" ? (localStorage.getItem('ot-instrument') || 'acoustic_guitar_steel') : 'acoustic_guitar_steel') as string}\n                onChange={async (e)=>{ const v = e.currentTarget.value as any; await player.setInstrument(v); }}\n              >\n                <option value=\"acoustic_guitar_steel\">Acoustic Steel</option>\n                <option value=\"acoustic_guitar_nylon\">Acoustic Nylon</option>\n                <option value=\"electric_guitar_clean\">Electric Clean</option>\n                <option value=\"distortion_guitar\">Distortion</option>\n                <option value=\"overdriven_guitar\">Over Drive</option>\n                <option value=\"electric_guitar_muted\">Muted</option>\n                <option value=\"acoustic_grand_piano\">Piano</option>\n              </select>\n            </div>\n          </div>\n          {/* 上段の旧進行チップ行は廃止 */}\n\n          {/* 12-slot grid（番号 or コード）。クリックでカーソル、filledはクリックで再生・×で削除。D&Dで入れ替え */}\n          <div className=\"prog-slots mt-2 flex flex-wrap gap-1\" aria-label=\"Progression slots\">\n            {Array.from({ length: 12 }).map((_, i) => {\n              const filled = Boolean(slots[i]);\n              const tone = 16; // emerald hue base\n              const alpha = i < 8 ? 0 : (i - 7) * 0.08; // 0,0.08,0.16,0.24 for 8..11\n              const bg = `rgba(16,185,129,${alpha.toFixed(2)})`;\n              const active = cursorIndex === i;\n              const isCurrentlyPlaying = currentChordIndex === i && isPlaying;\n              return (\n                <div\n                  key={`slot-${i}`}\n                  data-slot-index={i}\n                  className={[\n                    \"inline-flex items-center justify-center rounded border text-xs select-none relative chip-pressable\",\n                    filled ? \"bg-black/5 dark:bg-white/10\" : \"bg-transparent\",\n                    active ? \"ring-2 ring-emerald-400/60\" : \"\",\n                    isCurrentlyPlaying ? \"ring-4 ring-blue-500/80 shadow-lg\" : \"\",\n                    dragIndex === i ? \"opacity-50 scale-105\" : \"\",\n                    touchDragTarget === i ? \"ring-2 ring-blue-400\" : \"\"\n                  ].join(\" \")}\n                  style={{ \n                    padding: '6px 10px', \n                    minWidth: 72, \n                    minHeight: 36, \n                    background: filled ? undefined : bg, \n                    borderColor: 'var(--line)',\n                    transition: 'opacity 0.15s, transform 0.15s, box-shadow 0.15s',\n                    touchAction: filled ? 'none' : 'auto'\n                  }}\n                  onClick={() => { if (filled) { playChordSymbol(slots[i]); } else { setCursorIndex(i); } }}\n                  draggable={filled}\n                  onDragStart={() => setDragIndex(i)}\n                  onDragOver={(e) => e.preventDefault()}\n                  onDrop={() => { if (dragIndex !== null) { moveSlot(dragIndex, i); setDragIndex(null); } }}\n                  onTouchStart={(e) => handleTouchStartDrag(e, i)}\n                  onTouchMove={(e) => handleTouchMoveDrag(e, i)}\n                  onTouchEnd={handleTouchEndDrag}\n                >\n                  {/* corner numbering (always visible) */}\n                  <span className=\"absolute left-1 top-1 text-[10px] opacity-70 select-none pointer-events-none\">{String(i+1)}</span>\n                  {filled ? (\n                    <>\n                      <span>{slots[i]}</span>\n                <button\n                  aria-label=\"Remove chord\"\n                        className=\"absolute -top-1 -right-1 w-4 h-4 rounded-full bg-black/50 text-white text-[10px] leading-4 hover:bg-black/70\"\n                        onClick={(e)=>{ e.stopPropagation(); removeSlot(i); }}\n                >×</button>\n                    </>\n                  ) : null}\n          </div>\n              );\n            })}\n        </div>\n          </section>\n      \n      {/* Sketch Library セクションはドロップダウンに移行 */}\n      {/* Choose chords card: full-width below */}\n      <section id=\"choose\" ref={rightRef} className=\"ot-card right-panel\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <div className=\"flex items-center gap-2\">\n              <H2 className=\"mb-0 text-left\">Choose chords</H2>\n              <InfoDot\n                title=\"Choose Chords\"\n                text={isJapanese \n                  ? \"ルートとコードタイプを選んでください。追加ボタンでコード進行のスロットに追加できます。\\nProプランの場合、より複雑なコードタイプを選ぶことができます。\"\n                  : \"Select a root note and chord type. Use the Add button to add to chord progression slots.\\nPro plan allows you to select more complex chord types.\"\n                }\n              />\n            </div>\n            {/* Preset button moved from Build progression */}\n            <button\n              type=\"button\"\n              className=\"chip-pressable text-sm px-3 py-1 inline-flex items-center gap-1 rounded-lg border\"\n              title=\"Load preset progression\"\n              onClick={() => setShowPresetPopup(true)}\n            >\n              <span>📋</span>\n              <span>Presets</span>\n            </button>\n        </div>\n          {/* ChordBuilder component with Quality Master.csv integration */}\n          <ChordBuilder\n            plan={isPro ? 'pro' : 'free'}\n            onPreview={async (symbol) => {\n              // 既存の簡易プレビューと同等：symbol → MIDI 変換して再生\n              try {\n                await player.resume();\n                const midis = chordToMidi(symbol); // 既存ユーティリティ\n                player.playChord(midis, 'lightStrum', 300);\n              } catch {}\n            }}\n            onBlock={(reason) => {\n              // Pro限定（/bass など）に当たったときは課金モーダルを開く\n              setShowUpgrade(true);\n            }}\n            onConfirm={(symbol) => {\n              // 12スロットに追加（最初の空きに入れてカーソルを進める）\n              setSlots(prev => {\n                const arr = [...prev];\n                let idx = arr.findIndex(s => !s);\n                if (idx === -1) idx = 0;\n                arr[idx] = symbol;\n                return arr;\n              });\n              setCursorIndex(prev => {\n                // 直感的に \"次の空スロット\" へ\n                const arr = [...slots];\n                let i = arr.findIndex(s => !s);\n                return i === -1 ? 0 : i;\n              });\n              setAddedFlash(true); // 既存の \"Added\" 演出があるなら\n            }}\n          />\n          \n          {/* Analyze button */}\n          <div className=\"mt-4\">\n            <button\n              className={`w-full px-6 py-2 text-base rounded-lg font-semibold text-white transition-transform active:scale-[.98] active:translate-y-px focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-300 ${isAnalyzing ? 'bg-rose-400/70 cursor-wait' : 'bg-rose-400 hover:bg-rose-500'}`}\n              onClick={() => {\n                const items = parseProg(progression);\n                const hasAdv = items.some((i) => ADVANCED_QUALITIES.some((a) => i.quality.includes(a)));\n                if (hasAdv && !isPro) {\n                  if (typeof window !== 'undefined') window.alert('Advanced chords detected. Remove them or upgrade to Pro.');\n                  return;\n                }\n                startAnalyze(() => {\n                  // Run analysis without auto-scroll (analyze function has its own scroll)\n                  const res = analyzeChordProgression(progression);\n                  setResult(res);\n                  const ranked = rankKeys(progression);\n                  setKeys(ranked.slice(0,4));\n                  if (ranked.length > 0) {\n                    const mode: RomanMode = ranked[0].mode === \"Major\" ? \"major\" : \"minor\";\n                    const keyName = ranked[0].label.split(\" \")[0];\n                    const sel = { tonic: keyName, mode } as const;\n                    setSelectedKey(sel);\n                    setRomanLine(progression.map(c => toRoman(c, sel.tonic, sel.mode, { showQuality: true, uppercase: true })));\n                  } else {\n                    setScales([]);\n                    setSelectedKey(null);\n                    setRomanLine([]);\n                  }\n                  // store-based analysis for Top3 candidates\n                  runAnalyze(progression);\n                  \n                  // Auto-scroll to result section\n                  setTimeout(() => {\n                    const resultElement = document.getElementById('result');\n                    if (resultElement) {\n                      resultElement.scrollIntoView({ \n                        behavior: 'smooth', \n                        block: 'start' \n                      });\n                    }\n                  }, 100);\n                });\n              }}\n              disabled={isAnalyzing}\n              aria-busy={isAnalyzing}\n            >\n              {isAnalyzing ? (\n                <span className=\"inline-flex items-center gap-2\">\n                  <svg className=\"h-4 w-4 animate-spin\" viewBox=\"0 0 24 24\" aria-hidden=\"true\">\n                    <circle className=\"opacity-25\" cx=\"12\" cy=\"12\" r=\"10\" stroke=\"currentColor\" strokeWidth=\"3\"/>\n                    <path className=\"opacity-75\" fill=\"currentColor\" d=\"M4 12a8 8 0 0 1 8-8v4a4 4 0 0 0-4 4H4z\"/>\n                  </svg>\n                  Analyzing…\n                </span>\n              ) : 'Analyze'}\n            </button>\n          </div>\n      </section>\n      <section id=\"result\" ref={resultRef} className=\"ot-card\">\n        <div className=\"flex items-center justify-between\">\n          <H2 className=\"text-left mb-0\">Result</H2>\n          <div className=\"flex items-center gap-2\">\n            <button\n              type=\"button\"\n              className=\"chip-pressable inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm border\"\n              onClick={() => setShowNamePrompt(true)}\n              title=\"Save sketch\"\n            >\n              <svg className=\"w-4 h-4\" viewBox=\"0 0 24 24\" fill=\"currentColor\" aria-hidden=\"true\"><path d=\"M17 3H5a2 2 0 0 0-2 2v14l4-4h10a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2z\"/></svg>\n              Save\n            </button>\n          </div>\n        </div>\n        {showNamePrompt && (\n          <div className=\"fixed inset-0 z-[10000]\" role=\"dialog\" aria-modal=\"true\">\n            <div className=\"absolute inset-0 bg-black/40\" onClick={() => { setShowNamePrompt(false); setNameInput(\"\"); }} />\n            <div className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-neutral-900 border rounded-lg shadow-xl p-4 w-[92vw] max-w-[420px]\">\n              <div className=\"text-base font-semibold mb-2\">Save sketch</div>\n              <input\n                type=\"text\"\n                className=\"chip px-2 py-2 text-sm w-full\"\n                placeholder={defaultSketchName}\n                value={nameInput}\n                onChange={(e)=>setNameInput(e.target.value)}\n                aria-label=\"Sketch name\"\n                autoFocus\n              />\n              <div className=\"mt-3 flex items-center justify-end gap-2\">\n                <button\n                  type=\"button\"\n                  className=\"chip-pressable inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm border\"\n                  onClick={() => { setShowNamePrompt(false); setNameInput(\"\"); }}\n                >Cancel</button>\n                <button\n                  type=\"button\"\n                  className=\"chip-pressable inline-flex items-center gap-1 px-3 py-1 rounded-full text-sm border\"\n                  onClick={doSaveSketch}\n                >OK</button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Sketch Action Popup (Edit/Export/Cancel) */}\n        {selectedSketchForAction && (\n          <div className=\"fixed inset-0 z-[10001]\" role=\"dialog\" aria-modal=\"true\">\n            <div className=\"absolute inset-0 bg-black/40\" onClick={() => setSelectedSketchForAction(null)} />\n            <div className=\"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 bg-white dark:bg-neutral-900 border rounded-lg shadow-xl p-4 w-[92vw] max-w-[320px]\">\n              <div className=\"text-base font-semibold mb-3\">{selectedSketchForAction.name}</div>\n              <div className=\"space-y-2\">\n                <button\n                  type=\"button\"\n                  className=\"w-full chip-pressable inline-flex items-center justify-center gap-1 px-4 py-2 rounded-lg text-sm border\"\n                  onClick={() => {\n                    try {\n                      const sk = selectedSketchForAction;\n                      const arr = new Array(12).fill(\"\");\n                      (sk?.progression?.items || []).forEach((it: any, idx: number) => { if (idx < 12) arr[idx] = String(it?.id || \"\"); });\n                      setSlots(arr);\n                      setCursorIndex(arr.findIndex(s=>!s) === -1 ? 11 : arr.findIndex(s=>!s));\n                      // 解析を実行して候補を生成\n                      try { runAnalyze(arr.filter(Boolean) as any); } catch {}\n                      // Apply key to analysis store if possible\n                      const tonicPc = PITCHES.indexOf(sk.key.tonic as any);\n                      if (tonicPc >= 0) {\n                        try { selectKey?.({ tonic: tonicPc as any, mode: (String(sk.key.scaleId || '')?.toLowerCase().includes('aeolian') || String(sk.key.scaleId||'').toLowerCase().includes('minor') ? 'Minor' : 'Major') as any }); } catch {}\n                      }\n                      track('open_project', { page: 'chord_progression', id: sk.id });\n                      setShowSketchList(false);\n                      setSelectedSketchForAction(null);\n                    } catch {}\n                  }}\n                >\n                  Edit\n                </button>\n                <button\n                  type=\"button\"\n                  className=\"w-full chip-pressable inline-flex items-center justify-center gap-1 px-4 py-2 rounded-lg text-sm border\"\n                  onClick={async () => {\n                    try {\n                      const sk = selectedSketchForAction;\n                      // Export機能を実装（後で追加）\n                      await handleExportSketch(sk);\n                      setSelectedSketchForAction(null);\n                    } catch {}\n                  }}\n                >\n                  Export\n                </button>\n                <button\n                  type=\"button\"\n                  className=\"w-full chip-pressable inline-flex items-center justify-center gap-1 px-4 py-2 rounded-lg text-sm border\"\n                  onClick={() => setSelectedSketchForAction(null)}\n                >\n                  Cancel\n                </button>\n              </div>\n            </div>\n          </div>\n        )}\n\n        {/* Export-only compact card (offscreen) */}\n        <div\n          ref={exportCardRef}\n          aria-hidden\n          style={{\n            position: 'fixed',\n            left: 0,\n            top: 0,\n            zIndex: 9999,\n            opacity: 0.0001,\n            pointerEvents: 'none',\n            width: 800,\n            height: 600,\n            background: '#ffffff',\n            color: '#000000',\n            padding: 24,\n            borderRadius: 12,\n            border: '2px solid #cbd5e1',\n            boxShadow: '0 4px 6px rgba(0,0,0,0.1)'\n          }}\n        >\n          {(() => {\n            const exportName = currentExportName || (nameInput?.trim() ? nameInput : defaultSketchName);\n            const keyLabel = (() => {\n              const k = selFromStore;\n              if (!k) return '-';\n              return `${PITCHES[k.tonic]} ${k.mode}`;\n            })();\n            const progText = progression.join(' ');\n            const scaleLabel = (() => {\n              const s = selectedScale;\n              if (!s) return '-';\n              return scaleTypeLabel(s.type);\n            })();\n            const fb = (() => {\n              const capoN = 0;\n              const rootPc = selectedScale ? selectedScale.root : undefined;\n              const notesSounding = (selectedScale && typeof rootPc === 'number')\n                ? getScalePitchesById(rootPc, selectedScale.type as any).map(pc => PITCHES[pc])\n                : [];\n              const displayMode = isHeptatonic ? (fbDisplay as any) : ('degrees' as any);\n              const quality: Quality = (() => {\n                const q = selectedScale?.type;\n                if (!q) return 'maj';\n                return q.toLowerCase().includes('aeolian') || q.toLowerCase().startsWith('min') ? 'min' : 'maj';\n              })();\n              const rootForContext = typeof rootPc === 'number' ? rootPc : 0;\n              return (\n                <div style={{ marginTop: 8, background: '#ffffff', border: '2px solid #cbd5e1', borderRadius: '8px', padding: '12px', width: '100%' }}>\n                  <Fretboard\n                    overlay={{ viewMode: 'sounding', capo: capoN, notes: notesSounding, chordNotes: overlayChordNotes ?? undefined, showScaleGhost: Boolean(overlayChordNotes), display: displayMode, scaleRootPc: (typeof rootPc === 'number' ? rootPc : 0), scaleType: (selectedScale?.type ?? 'Ionian'), context: { chordRootPc: (typeof rootPc === 'number' ? rootPc : 0), quality } }}\n                    onRequestForms={() => {}}\n                  />\n                </div>\n              );\n            })();\n            return (\n              <div style={{\n                background: '#ffffff',\n                color: '#000000',\n                fontFamily: 'ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif',\n                width: '100%',\n                height: '100%',\n                display: 'flex',\n                flexDirection: 'column',\n                gap: '12px',\n                padding: '8px'\n              } as any}>\n                <div style={{ fontWeight: 700, fontSize: 24, color: '#000000', lineHeight: 1.3 }}>{exportName}</div>\n                <div style={{ fontSize: 18, color: '#000000', fontWeight: 600 }}>Key: <span style={{ color: '#1e40af' }}>{keyLabel}</span></div>\n                <div style={{ fontSize: 16, color: '#000000', fontWeight: 500 }}>Progression: <span style={{ color: '#1e40af' }}>{progText || '-'}</span></div>\n                <div style={{ fontSize: 16, color: '#000000', fontWeight: 500 }}>Scale: <span style={{ color: '#1e40af' }}>{scaleLabel}</span></div>\n                <div style={{ flex: 1, background: '#ffffff', border: '2px solid #cbd5e1', borderRadius: '8px', padding: '12px', overflow: 'hidden' }}>\n                  {fb}\n                </div>\n              </div>\n            );\n          })()}\n        </div>\n          {keyCandidates.length > 0 ? (\n            <div className=\"space-y-4\">\n              {/* Low accuracy warning - only show after analyze */}\n              {keyCandidates.length > 0 && progression.length < 8 && (\n                <div className=\"text-xs px-3 py-2 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 text-yellow-800 dark:text-yellow-200\">\n                  ⚠️ 精度向上のため、8コード以上の入力を推奨します（現在: {progression.length}コード）\n                </div>\n              )}\n              {/* === Key === */}\n              <H3>Key</H3>\n              <div className=\"flex items-center justify-between gap-2\">\n                <div className=\"chip-row mb-2\" role=\"tablist\" aria-label=\"Key candidates\">\n                  {keyCandidates.map((k, idx) => {\n                    const active = selFromStore && selFromStore.tonic === k.tonic && selFromStore.mode === k.mode;\n                    const label = `${PITCHES[k.tonic]} ${k.mode}`;\n                    const reasons = k.reasons.join(\"\\n\");\n                    return (\n                      <button\n                        key={`${label}-${idx}`}\n                        role=\"tab\"\n                        aria-selected={active}\n                        className={[\"chip\",\"chip--key\", active?\"chip--active\":\"\"].join(\" \")}\n                        title={`Why this key\\n${reasons}`}\n                        onClick={() => selectKey({ tonic: k.tonic, mode: k.mode })}\n                        data-roving=\"item\"\n                      >\n                        {label} {Math.round(k.confidence)}%\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n              {/* === Scale === */}\n              <div className=\"result-block\">\n                <H3>\n                  <span className=\"flex items-center gap-2\">\n                    <span>Scale</span>\n                    {(() => {\n                      const curId = (selectedScale?.type as any) ?? (scaleCandidates?.[0]?.type as any) ?? 'Ionian';\n                      const cur = SCALE_CATALOG.find(s => s.id === (curId as any));\n                      if (!cur) return null;\n                      const notesInC = getScalePitchesById(0, cur.id).map(pc => PITCHES[pc]).join(' ');\n                      return (\n                        <InfoDot title={cur.display.en} className=\"ml-1\" linkHref=\"/resources/glossary\" linkLabel=\"Glossary\">\n                          <div className=\"text-sm\">\n                            <div className=\"mb-1\"><b>Degrees:</b> {cur.degrees.join(' ')}</div>\n                            <div className=\"mb-1\"><b>Notes in C:</b> {notesInC}</div>\n                            {cur.info?.oneLiner && (<div className=\"mb-1\"><b>About:</b> {cur.info.oneLiner}</div>)}\n                          </div>\n                        </InfoDot>\n                      );\n                    })()}\n                  </span>\n                </H3>\n                <div className=\"chip-row mb-2\" role=\"tablist\" aria-label=\"Scale candidates\">\n                  {scaleCandidates.map((s, idx) => {\n                    const type = normalizeScaleId(s.type as any);\n                    const active = selectedScale?.type === type && selectedScale?.root === s.root;\n                    const label = `${PITCHES[s.root]} ${scaleTypeLabel(type as any)}`;\n                    return (\n                      <button\n                        key={`${label}-${idx}`}\n                        role=\"tab\"\n                        aria-selected={active}\n                        className={[\"chip\", \"chip--key\", active ? \"chip--active\" : \"\"].join(\" \")}\n                        onClick={() => { selectScale(s); track('scale_pick', { page:'find-key', scale: s.type, key: PITCHES[s.root] }); }}\n                        data-roving=\"item\"\n                      >\n                        {label} {Math.round(s.score)}%\n                      </button>\n                    );\n                  })}\n                </div>\n              </div>\n            </div>\n        ) : (\n          <div className=\"text-sm opacity-70\">Click Analyze to see results.</div>\n        )}\n      </section>\n\n      {/* Tools セクション（Fretboard以下） */}\n      <section className=\"ot-card mt-2\">\n        <H2>Tools</H2>\n        <div className=\"space-y-4\">\n              {/* === Fretboard === */}\n              <div className=\"result-block\">\n                <H3\n                  right={\n                    <div ref={fbToggleRef} className=\"flex items-center gap-2 bg-transparent shadow-none fretboard-toggle\" aria-label=\"Fretboard notation\" role=\"tablist\">\n                      <button\n                        role=\"tab\"\n                        aria-selected={fbDisplay === 'degrees'}\n                        tabIndex={fbDisplay === 'degrees' ? 0 : -1}\n                        className={[\"chip\",\"chip--key\", fbDisplay === 'degrees' ? \"chip--active\" : \"\"].join(\" \")}\n                        onClick={()=>setFbDisplay('degrees')}\n                        data-roving=\"item\"\n                      >Degrees</button>\n                      <button\n                        role=\"tab\"\n                        aria-selected={fbDisplay === 'names'}\n                        tabIndex={isHeptatonic && fbDisplay === 'names' ? 0 : -1}\n                        aria-disabled={!isHeptatonic}\n                        className={[\"chip\",\"chip--key\", fbDisplay === 'names' ? \"chip--active\" : \"\", !isHeptatonic ? \"chip--disabled\" : \"\"].join(\" \")}\n                        onClick={()=>{ if (isHeptatonic) setFbDisplay('names'); }}\n                        data-roving=\"item\"\n                      >Names</button>\n                      {/* Names右の音色選択は削除 */}\n                    </div>\n                  }\n                >Fretboard</H3>\n                <div className=\"fret-wrap\">\n                  <div className=\"fret-inner\">\n                    {selectedScale ? (() => {\n                      const capoN = 0;\n                      const rootPc = selectedScale.root;\n                      const notesSounding = getScalePitchesById(rootPc, selectedScale.type as any).map(pc => PITCHES[pc]);\n                      const displayMode = isHeptatonic ? (fbDisplay as any) : ('degrees' as any);\n                      const quality: Quality = (() => {\n                        const q = selectedScale?.type;\n                        if (!q) return 'maj';\n                        return q.toLowerCase().includes('aeolian') || q.toLowerCase().startsWith('min') ? 'min' : 'maj';\n                      })();\n                      const rootForContext = rootPc;\n                      return (\n                        <Fretboard\n                          overlay={{ viewMode: 'sounding', capo: capoN, notes: notesSounding, chordNotes: overlayChordNotes ?? undefined, showScaleGhost: Boolean(overlayChordNotes), display: displayMode, scaleRootPc: rootPc as any, scaleType: selectedScale.type as any, context: { chordRootPc: rootPc, quality } }}\n                          onRequestForms={(at, ctx) => {\n                            setFormsPop({ at, rootPc: ctx.rootPc ?? rootForContext, quality: ctx.quality });\n                          }}\n                          formShape={formShape}\n                        />\n                      );\n                    })() : (\n                      <div className=\"text-center text-sm opacity-50 py-8\">\n                        Click Analyze to see fretboard\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </div>\n\n              {/* === Diatonic (Capo-based table) === */}\n              <section className=\"result-block space-y-2\">\n                <H3>\n                  <span className=\"flex items-center gap-2\">\n                    <span>Diatonic</span>\n                    <InfoDot\n                      className=\"ml-1\"\n                      title=\"Diatonic chords\"\n                      linkHref=\"/resources/glossary\"\n                      linkLabel=\"Glossary\"\n                    >\n                      <p className=\"text-sm\">Chords built only from the key’s scale tones (I–ii–iii–IV–V–vi–vii°).</p>\n                      <ul className=\"mt-2 list-disc pl-5 space-y-1 text-sm\">\n                        <li>Stable sound: everything stays inside the key.</li>\n                        <li>Use: begin inside → add color with a borrowed chord (iv, bVII, bVI).</li>\n                        <li>Try: ii–V–I or IV–V–I for clear motion.</li>\n                      </ul>\n                      <h4 className=\"mt-3 font-medium\">Shaped vs. Sounding (Capo)</h4>\n                      <ul className=\"mt-1 list-disc pl-5 space-y-1 text-sm\">\n                        <li>Shaped: labels show the shapes you fret after capo.</li>\n                        <li>Sounding: labels show the actual pitch you hear.</li>\n                      </ul>\n                    </InfoDot>\n                  </span>\n                </H3>\n                <DiatonicCapoTable\n                  selectedId={selectedCellId}\n                  onSelectId={(id)=> setSelectedCellId(id)}\n                  onPick={async ({ id, pcs, isRightClick })=>{\n                    // 右クリックの場合はコード進行に追加\n                    if (isRightClick) {\n                      // ダイアトニックテーブルからコード名を取得\n                      const selectedKey = useAnalysisStore.getState().selectedKey;\n                      const selectedScale = useAnalysisStore.getState().selectedScale;\n                      if (!selectedKey || !selectedScale) return;\n                      \n                      let st = selectedScale.type as any;\n                      let ivs = (SCALE_INTERVALS as any)[st] ?? [];\n                      if (ivs.length !== 7) {\n                        const parent = parentModeOf(st);\n                        if (parent) ivs = (SCALE_INTERVALS as any)[parent] ?? [];\n                      }\n                      if (ivs.length !== 7) return;\n                      \n                      const tris = diatonicTriads({ tonicPc: selectedKey.tonic, scaleIntervals: ivs });\n                      const degreeIndex = parseInt(id.replace('open-', ''));\n                      const triad = tris[degreeIndex];\n                      if (!triad) return;\n                      \n                      const chordSym = triadToChordSym({ rootPc: triad.rootPc, quality: triad.quality });\n                      const newSlots = [...slots];\n                      newSlots[cursorIndex] = chordSym;\n                      setSlots(newSlots);\n                      if (cursorIndex < 11) setCursorIndex(cursorIndex + 1);\n                      track('diatonic_pick', { page:'find-key', action: 'right_click_add' });\n                      return;\n                    }\n                    \n                    // 同じセルを再選択 → リセット（スケールトーンのみ表示に戻す）\n                    if (selectedCellId === id) {\n                      setOverlayChordNotes(null);\n                      setSelectedCellId(null);\n                      resetForms();\n                      return;\n                    }\n                    const mainNotes = pcs.map(pc => PITCHES[pc] as string);\n                    setOverlayChordNotes(mainNotes);\n                    setSelectedCellId(id);\n                    resetForms();\n                    track('diatonic_pick', { page:'find-key' });\n                    // 和音再生（ピッチクラス→C4基準の実音に変換して3音同時）\n                    try {\n                      await player.resume();\n                      const midis = pcs.map(pc => 60 + (pc % 12));\n                      player.playChord(midis, 'lightStrum', 260);\n                    } catch {}\n                  }}\n                />\n              </section>\n              \n              {/* === Roman (hide for non-heptatonic scales) === */}\n              {isHeptatonic && (\n                <>\n                  <H3>Roman</H3>\n                  <div ref={romanBoxRef} className=\"rounded-md border px-3 py-2\" aria-live=\"polite\" data-testid=\"roman-row\">\n                    <div className=\"flex-1 overflow-x-auto whitespace-nowrap text-lg md:text-xl tracking-wide\">\n                      {romanLine.length === 0 ? (\n                        <span>-</span>\n                      ) : (\n                        romanLine.map((tok, i) => (\n                          <React.Fragment key={`rom-${i}`}>\n                            <span\n                              data-idx={i}\n                              className={romanHL && i >= romanHL.start && i <= romanHL.end ? 'roman-mark' : undefined}\n                            >\n                              {String(tok || '').toUpperCase()}\n                            </span>\n                            {i < romanLine.length - 1 ? <span aria-hidden className=\"mx-1\">–</span> : null}\n                          </React.Fragment>\n                        ))\n                      )}\n                    </div>\n                  </div>\n                </>\n              )}\n\n              {/* Patterns */}\n              {patternHits.length > 0 && (\n                <div className=\"mt-2 flex flex-wrap items-center gap-2\">\n                  <span className=\"text-xs opacity-70\">Patterns</span>\n                  {(() => {\n                    const h = patternHits[0];\n                    const idToEn: Record<string, any> = {\n                      'doo-wop': 'dooWop',\n                      'axis': 'axis',\n                      'canon': 'canon',\n                      'ii-V-I': 'twoFiveOne',\n                      'turnaround': 'turnaround',\n                      'andalusian': 'andalusian',\n                      'authentic': 'authentic',\n                      'plagal': 'plagal',\n                      'deceptive': 'deceptive',\n                    };\n                    const en = idToEn[h.id] ? patternInfoEN(idToEn[h.id]) : null;\n                    const label = en?.label || upperRomansInParens(h.name).replace(/\\(I–vi–IV–V\\)/, \"(I–VI–IV–V)\");\n                    const summary = en?.summary || (h.summary || h.name);\n                    const isActive = !!(romanHL && romanHL.start === h.start && romanHL.end === h.end);\n                    return (\n                      <>\n                        <button\n                          key={`${h.id}-0`}\n                          type=\"button\"\n                          className={[\"text-sm leading-tight font-medium hover:opacity-80 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400/50 rounded\"].join(' ')}\n                          title={summary}\n                          onClick={() => {\n                            setRomanHL(prev => (prev && prev.start === h.start && prev.end === h.end)\n                              ? null\n                              : { start: Math.max(0, h.start), end: Math.max(h.start, Math.min(romanLine.length - 1, h.end)) }\n                            );\n                            requestAnimationFrame(() => {\n                              const box = romanBoxRef.current;\n                              if (!box) return;\n                              const mark = box.querySelector(`[data-idx=\"${h.start}\"]`) as HTMLElement | null;\n                              if (mark) box.scrollLeft = Math.max(0, mark.offsetLeft - 12);\n                            });\n                          }}\n                        >\n                          {label}\n                        </button>\n                        <InfoDot ariaLabel={`${label} – info`} text={`${label}\\n\\n${summary}`} />\n                      </>\n                    );\n                  })()}\n                </div>\n              )}\n\n              {/* Cadence row (keep label in sync with Patterns) */}\n              {(cadences.length > 0 || fallbackCadence) && (\n                <div className=\"mt-2 flex flex-wrap items-center gap-2\">\n                  <span className=\"text-xs opacity-70\">Cadence</span>\n                  {(() => {\n                    const c: any = cadences[0] ?? fallbackCadence;\n                    const t = c?.type ?? c; // 'perfect' | 'deceptive' | 'half'\n                    const tail = c?.tail ?? c?.tailRoman;\n                    const label = formatCadenceShort(t, tail);\n                    return (\n                      <span className=\"inline-flex items-center gap-1.5 text-sm leading-tight\">\n                        <span className=\"font-medium\">{label}</span>\n                        <InfoDot text={cadenceTooltip(t)} />\n                      </span>\n                    );\n                  })()}\n                </div>\n              )}\n              \n              \n              {/* Capo block removed (feature gated off) */}\n              \n              \n              {/* link to open in chords removed per spec */}\n                </div>\n        </section>\n      <section className=\"ot-card\" aria-label=\"Ad\">\n        <AdSlot page=\"chord_progression\" format=\"horizontal\" />\n      </section>\n      \n      {/* Preset Popup */}\n      {showPresetPopup && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40\" style={{ backdropFilter: 'blur(4px)' }}>\n          <div ref={presetPopupRef} className=\"bg-white dark:bg-gray-800 rounded-lg shadow-2xl p-6 max-w-md w-full mx-4\">\n            <h3 className=\"text-lg font-semibold mb-4\">Load Preset</h3>\n            \n            {/* Key selector */}\n            <div className=\"mb-4\">\n              <label className=\"text-xs opacity-70 mb-1 block\">Key</label>\n              <div className=\"flex flex-wrap gap-1\">\n                {['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'].map(k => (\n                  <button\n                    key={k}\n                    className={`chip ${presetKey === k ? 'chip--active' : ''}`}\n                    onClick={() => setPresetKey(k)}\n                  >\n                    {k}\n                  </button>\n                ))}\n              </div>\n            </div>\n            \n            {/* Preset buttons */}\n            <div className=\"space-y-2 max-h-[60vh] overflow-y-auto\">\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-V-vi-IV', ['Ⅰ', 'Ⅴ', 'Ⅵm', 'Ⅳ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅴ–Ⅵm–Ⅳ</div>\n                <div className=\"text-xs opacity-70\">Pop progression</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('ii-V-I', ['Ⅱm', 'Ⅴ', 'Ⅰ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅱm–Ⅴ–Ⅰ</div>\n                <div className=\"text-xs opacity-70\">Jazz turnaround</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('12-bar-blues', ['Ⅰ', 'Ⅰ', 'Ⅰ', 'Ⅰ', 'Ⅳ', 'Ⅳ', 'Ⅰ', 'Ⅰ', 'Ⅴ', 'Ⅳ', 'Ⅰ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">12-bar Blues</div>\n                <div className=\"text-xs opacity-70\">Classic blues form (all 12 slots)</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-II', ['Ⅰ', 'Ⅱ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅱ</div>\n                <div className=\"text-xs opacity-70\">Simple two-chord progression</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-bVII-IV', ['Ⅰ', '♭Ⅶ', 'Ⅳ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–♭Ⅶ–Ⅳ</div>\n                <div className=\"text-xs opacity-70\">Rock progression</div>\n              </button>\n              \n              {/* 新規追加: 5つの有用なプリセット */}\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('vi-IV-I-V', ['Ⅵm', 'Ⅳ', 'Ⅰ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅵm–Ⅳ–Ⅰ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">Emotional / Ballad (I-V-vi-IVの逆回転)</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-vi-IV-V', ['Ⅰ', 'Ⅵm', 'Ⅳ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅵm–Ⅳ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">50's progression / Doo-wop</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-IV-V', ['Ⅰ', 'Ⅳ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅳ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">Three-chord song / Rock classic</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('vi-ii-V-I', ['Ⅵm', 'Ⅱm', 'Ⅴ', 'Ⅰ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅵm–Ⅱm–Ⅴ–Ⅰ</div>\n                <div className=\"text-xs opacity-70\">Circle progression / Jazz standard</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-bVII-bVI-bVII', ['Ⅰ', '♭Ⅶ', '♭Ⅵ', '♭Ⅶ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–♭Ⅶ–♭Ⅵ–♭Ⅶ</div>\n                <div className=\"text-xs opacity-70\">Mixolydian vamp / Rock anthem</div>\n              </button>\n              \n              {/* 新規追加: さらに10種類のプリセット */}\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-IVm-I-V', ['Ⅰ', 'Ⅳm', 'Ⅰ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅳm–Ⅰ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">Borrowed chord / Minor IV</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('vi-IV-I-III', ['Ⅵm', 'Ⅳ', 'Ⅰ', 'Ⅲ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅵm–Ⅳ–Ⅰ–Ⅲ</div>\n                <div className=\"text-xs opacity-70\">Andalusian cadence / Spanish feel</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-bIII-bVII-IV', ['Ⅰ', '♭Ⅲ', '♭Ⅶ', 'Ⅳ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–♭Ⅲ–♭Ⅶ–Ⅳ</div>\n                <div className=\"text-xs opacity-70\">Modal interchange / Epic progression</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-iii-IV-V', ['Ⅰ', 'Ⅲm', 'Ⅳ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅲm–Ⅳ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">Classic progression / Beatles style</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-V-vi-iii-IV-I-IV-V', ['Ⅰ', 'Ⅴ', 'Ⅵm', 'Ⅲm', 'Ⅳ', 'Ⅰ', 'Ⅳ', 'Ⅴ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅴ–Ⅵm–Ⅲm–Ⅳ–Ⅰ–Ⅳ–Ⅴ</div>\n                <div className=\"text-xs opacity-70\">Pachelbel's Canon / Wedding classic</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-bVI-bVII-I', ['Ⅰ', '♭Ⅵ', '♭Ⅶ', 'Ⅰ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–♭Ⅵ–♭Ⅶ–Ⅰ</div>\n                <div className=\"text-xs opacity-70\">Power ballad / 80s rock</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('vi-V-IV-III', ['Ⅵm', 'Ⅴ', 'Ⅳ', 'Ⅲ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅵm–Ⅴ–Ⅳ–Ⅲ</div>\n                <div className=\"text-xs opacity-70\">Descending progression / Melancholic</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-IV-bVII-IV', ['Ⅰ', 'Ⅳ', '♭Ⅶ', 'Ⅳ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅳ–♭Ⅶ–Ⅳ</div>\n                <div className=\"text-xs opacity-70\">Folk/Country vamp</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-bVII-IV-I', ['Ⅰ', '♭Ⅶ', 'Ⅳ', 'Ⅰ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–♭Ⅶ–Ⅳ–Ⅰ</div>\n                <div className=\"text-xs opacity-70\">Stadium anthem / Closing progression</div>\n              </button>\n              <button\n                className=\"w-full text-left px-4 py-2.5 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors\"\n                onClick={() => applyPreset('I-iii-vi-IV', ['Ⅰ', 'Ⅲm', 'Ⅵm', 'Ⅳ'], presetKey)}\n              >\n                <div className=\"font-medium\">Ⅰ–Ⅲm–Ⅵm–Ⅳ</div>\n                <div className=\"text-xs opacity-70\">Smooth descent / R&B style</div>\n              </button>\n            </div>\n            \n            <button\n              className=\"mt-4 w-full px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600\"\n              onClick={() => setShowPresetPopup(false)}\n            >\n              Cancel\n            </button>\n          </div>\n        </div>\n      )}\n\n      {/* M3.5: Toast notifications */}\n      {toastConfig && (\n        <Toast\n          message={toastConfig.message}\n          type={toastConfig.type}\n          ctaText={toastConfig.ctaText}\n          ctaHref={toastConfig.ctaHref}\n          ctaPlace={toastConfig.ctaPlace}\n          onClose={() => setToastConfig(null)}\n        />\n      )}\n    </main>\n  );\n}\n\nconst AdvSection: React.FC<{title:string; children:React.ReactNode}> = ({ title, children }) => (\n  <div>\n    <div className=\"text-xs text-black/60 dark:text-white/60 mb-1\">{title}</div>\n    <div className=\"adv-grid\">\n      {children}\n    </div>\n  </div>\n);\n\nconst Chip: React.FC<{label:string; onClick?:()=>void; disabled?:boolean; active?:boolean; small?:boolean}> = ({ label, onClick, disabled, active, small }) => (\n  <button\n    className={[\"chip\", small ? \"chip--sm\" : \"\", active ? \"chip--active\" : \"\", disabled ? \"chip--disabled\" : \"\"].join(\" \")}\n    onClick={onClick}\n    aria-disabled={disabled}\n  >\n    {label}\n  </button>\n);\n\n// moved to components/ui/InfoDot\n\n\n\n"],"names":[],"mappings":"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","debugId":null}}]
}