{"version":3,"sources":["turbopack:///[project]/src/app/find-chords/page.tsx","turbopack:///[project]/src/state/overlay.ts","turbopack:///[project]/src/lib/scaleSuggestions.ts","turbopack:///[project]/src/components/ScaleTable.tsx","turbopack:///[project]/src/components/ChordFormsPopover.tsx","turbopack:///[project]/src/lib/chordForms.ts","turbopack:///[project]/src/lib/chords/substitute.refactored.ts","turbopack:///[project]/src/components/SubstituteCard.tsx"],"sourcesContent":["\"use client\";\nimport { Suspense, useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport AdSlot from \"@/components/AdSlot.client\";\nimport { getDiatonicChordsFor, type NoteLetter } from \"@/lib/music-theory\";\nimport { toRoman, type Mode } from \"@/lib/theory/roman\";\nimport { useSearchParams } from \"next/navigation\";\nimport Fretboard from \"@/components/Fretboard\";\nimport { OverlayProvider } from \"@/state/overlay\";\nimport DiatonicCapoTable from \"@/components/DiatonicCapoTable\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport InfoDot from \"@/components/ui/InfoDot\";\nimport { useAnalysisStore } from \"@/store/analysisStore\";\nimport { getScalePitchesById } from \"@/lib/scales\";\nimport { SCALE_CATALOG, type ScaleId } from \"@/lib/scaleCatalog\";\nimport { PC_NAMES } from \"@/lib/music/constants\";\nimport { track } from \"@/lib/telemetry\";\nimport ScaleTable from \"@/components/ScaleTable\";\nimport { ChordFormsPopover } from \"@/components/ChordFormsPopover\";\nimport { buildForm, type FormKind, type FormShape, type Quality } from \"@/lib/chordForms\";\nimport SubstituteCard from \"@/components/SubstituteCard\";\n\nexport default function FindChordsPage() {\n  return (\n    <Suspense fallback={<div className=\"ot-page\">Loading...</div>}>\n      <FindChordsContent />\n    </Suspense>\n  );\n}\n\nfunction FindChordsContent() {\n  const params = useSearchParams();\n  const KEY_OPTIONS: NoteLetter[] = useMemo(() => PC_NAMES as unknown as NoteLetter[], []);\n  const UI_SCALES = SCALE_CATALOG; // SSOT カタログ\n\n  const [keyTonic, setKeyTonic] = useState<NoteLetter>((params.get('key') as NoteLetter) || 'C');\n  const initialMode: ScaleId = (params.get('mode') === 'minor') ? 'Aeolian' : 'Ionian';\n  const [selScaleId, setSelScaleId] = useState<ScaleId>(initialMode);\n  const isHept = useMemo(() => {\n    const def = UI_SCALES.find(s => s.id === selScaleId);\n    return (def?.degrees.length ?? 7) === 7;\n  }, [selScaleId]);\n\n  const diatonic = useMemo(() => {\n    const sel = UI_SCALES.find(s => s.id === selScaleId)!;\n    const sevenNote = sel.degrees.length === 7;\n    if (!sevenNote) return [] as any[];\n    const quality = (sel.id==='Aeolian' ? 'minor' : 'major') as any;\n    return getDiatonicChordsFor({ tonic: keyTonic, quality, scale: sel.id as any } as any).chords;\n  }, [keyTonic, selScaleId]);\n\n  const mode: Mode = useMemo(() => (selScaleId === 'Aeolian' ? 'minor' : 'major'), [selScaleId]);\n\n  type Display = 'degrees'|'names';\n  const keyRowRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(keyRowRef, { orientation: \"horizontal\" });\n  const fbToggleRef = useRef<HTMLSpanElement | null>(null);\n  useRovingTabs(fbToggleRef, { orientation: \"horizontal\" });\n  const [display, setDisplay] = useState<Display>('degrees');\n  const [fbCapo, setFbCapo] = useState<number>(0);\n  const [overlayNotes, setOverlayNotes] = useState<string[]|null>(null);\n  const [previewScaleId, setPreviewScaleId] = useState<ScaleId | null>(null);\n  const [selectedCellId, setSelectedCellId] = useState<string | null>(null);\n  const [lastPickedPcs, setLastPickedPcs] = useState<number[]|null>(null);\n  const [formsPop, setFormsPop] = useState<null | { at:{x:number;y:number}; rootPc:number; quality:Quality }>(null);\n  const [formShape, setFormShape] = useState<FormShape | null>(null);\n  const resetForms = useCallback(() => { setFormsPop(null); setFormShape(null); }, []);\n\n  // Debug quick-check: ensure overlay wiring is correct\n  useEffect(() => {}, [display, overlayNotes]);\n  const { selectKey } = useAnalysisStore();\n  // auto-refresh; no manual \"Show Chords\" button\n\n  const onPickKey = (k: NoteLetter) => {\n    setKeyTonic(k);\n    const q = (selScaleId === 'Aeolian') ? 'minor' : 'major';\n    const modeLabel = q === 'major' ? 'Major' : 'Minor';\n    const tonicPc = KEY_OPTIONS.indexOf(k);\n    selectKey({ tonic: tonicPc as any, mode: modeLabel as any });\n    track('key_pick', { page: 'find-chords', key: k, mode: modeLabel });\n    // local-only; store scale is not required here\n    void refreshDiatonicAndOverlay();\n  };\n\n  const onPickScale = (id: ScaleId) => {\n    setSelScaleId(id);\n    const tonicPc = KEY_OPTIONS.indexOf(keyTonic);\n    track('scale_pick', { page: 'find-chords', scale: id, key: keyTonic });\n    void refreshDiatonicAndOverlay();\n  };\n\n  async function refreshDiatonicAndOverlay() {\n    // Recompute store to refresh diatonic/capo table and set a base overlay\n    const tonicPc = KEY_OPTIONS.indexOf(keyTonic);\n    const uiScale = (selScaleId === 'Aeolian') ? 'minor' : 'major';\n    const modeLabel = uiScale === 'major' ? 'Major' : 'Minor';\n    selectKey({ tonic: tonicPc as any, mode: modeLabel as any });\n    // local-only; store scale is not required here\n    // base view: show only page scale; no chord overlay yet\n    setOverlayNotes(null);\n  }\n\n  useEffect(() => {\n    // 初期表示でも現在のKey/Scaleに合わせてベースを反映\n    void refreshDiatonicAndOverlay();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const scaleRootPc = useMemo(()=> KEY_OPTIONS.indexOf(keyTonic), [keyTonic]);\n  const scaleTypeForUI = useMemo(()=> selScaleId, [selScaleId]);\n\n  const scaleNotesForCurrentKey = () => {\n    const pcs = getScalePitchesById(scaleRootPc as any, scaleTypeForUI as any);\n    return pcs.map(pc => PC_NAMES[pc] as string);\n  };\n\n  // Reset overlay to current scale and clear selection\n  const resetToScale = useCallback(() => {\n    setDisplay('degrees');\n    setFbCapo(0);\n    setOverlayNotes(null);\n    setPreviewScaleId(null);\n    setSelectedCellId(null);\n    setLastPickedPcs(null);\n    resetForms();\n    track('overlay_reset', { page: 'find-chords', scale: selScaleId, key: keyTonic });\n  }, [scaleRootPc, scaleTypeForUI, resetForms]);\n\n  // Esc key to reset back to scale view\n  useEffect(() => {\n    const h = (e: KeyboardEvent) => { if (e.key === 'Escape') resetToScale(); };\n    window.addEventListener('keydown', h);\n    return () => window.removeEventListener('keydown', h);\n  }, [resetToScale]);\n\n  // ---- chord tone helper (minimal triad/7th) ----\n  const P = PC_NAMES as unknown as readonly string[];\n  const idxNote = (n: string) => P.indexOf(n as any);\n  const shift = (n: string, semi: number) => P[(idxNote(n) + semi + 120) % 12];\n  function tonesFor(sym: string): string[] {\n    const m = (sym || '').trim().match(/^([A-G](?:#|b)?)(.*)$/);\n    if (!m) return [];\n    const root = m[1]!; const q = (m[2] || '').trim();\n    let iv = [0,4,7];\n    if (/^m(?!aj)/.test(q)) iv = [0,3,7];\n    if (/dim|o/.test(q)) iv = [0,3,6];\n    if (/aug|\\+/.test(q)) iv = [0,4,8];\n    if (/m7b5/.test(q)) iv = [0,3,6,10];\n    else if (/maj7|M7/.test(q)) iv = Array.from(new Set([...iv,11]));\n    else if (/m7/.test(q)) iv = Array.from(new Set([...iv,10]));\n    else if (/7/.test(q)) iv = Array.from(new Set([...iv,10]));\n    return iv.map(semi => shift(root, semi));\n  }\n\n  return (\n    <OverlayProvider>\n    <main className=\"ot-page ot-stack\" data-page=\"find-chords\">\n      <h1 className=\"sr-only\">Find Chords</h1>\n      {/* Select Key & Scale */}\n      <section className=\"ot-card\">\n        <h2 className=\"ot-h2\">Select Key &amp; Scale</h2>\n        <div className=\"mt-3 grid sm:grid-cols-2 gap-3\">\n        <div>\n          <label className=\"block text-sm mb-1\">Key</label>\n          <div className=\"flex flex-col gap-2\" role=\"tablist\" aria-label=\"Select key\" ref={keyRowRef}>\n            {[[\"C\",\"C#\",\"D\",\"Eb\",\"E\",\"F\"],[\"F#\",\"G\",\"Ab\",\"A\",\"Bb\",\"B\"]].map((row, ri)=> (\n              <div key={`krow-${ri}`} ref={ri===0?keyRowRef as any:undefined} className=\"flex flex-wrap gap-2\">\n                {row.map(k => (\n                  <button\n                    key={k}\n                    role=\"tab\"\n                    aria-selected={keyTonic === (k as NoteLetter)}\n                    tabIndex={keyTonic === (k as NoteLetter) ? 0 : -1}\n                    className={[\"chip\",\"chip--key\", keyTonic===k?\"chip--active\":\"\"].join(\" \")}\n                    data-roving=\"item\"\n                    onClick={()=>{ onPickKey(k as NoteLetter); }}\n                    title={`Key ${k}`}\n                  >{k}</button>\n                ))}\n              </div>\n            ))}\n          </div>\n        </div>\n        <div>\n          <label htmlFor=\"scale\" className=\"block text-sm mb-1\">\n            <span>Scale</span>\n            {(() => {\n              const cur = UI_SCALES.find(s => s.id === selScaleId)!;\n              const notesInC = getScalePitchesById(0, cur.id).map(pc => PC_NAMES[pc]).join(' ');\n              const defaultAbout = `${cur.group} scale — ${cur.degrees.length}-note pattern.`;\n              return (\n                <InfoDot title={cur.display.en} className=\"ml-2\" linkHref=\"/resources/glossary\" linkLabel=\"Glossary\">\n                  <div className=\"text-sm\">\n                    <div className=\"mb-1\"><b>Degrees:</b> {cur.degrees.join(' ')}</div>\n                    <div className=\"mb-1\"><b>Notes in C:</b> {notesInC}</div>\n                    <div className=\"mb-1\"><b>About:</b> {cur.info?.oneLiner ?? defaultAbout}</div>\n                    {!!cur.info?.examples?.length && (\n                      <div className=\"mt-2\">\n                        <b className=\"text-xs\">Song examples</b>\n                        <ul className=\"text-xs mt-1 space-y-1\">\n                          {cur.info.examples.map((e,i)=> (\n                            <li key={i}>\n                              {e.url ? <a href={e.url} target=\"_blank\" rel=\"noreferrer\">{e.title}</a> : e.title}\n                              {e.artist ? ` — ${e.artist}` : ''}{e.cue ? ` (${e.cue})` : ''}\n                            </li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                </InfoDot>\n              );\n            })()}\n          </label>\n          <select\n            id=\"scale\"\n            name=\"scale\"\n            className=\"w-full rounded border px-3 py-2 text-sm bg-transparent\"\n            value={selScaleId}\n            onChange={(e) => onPickScale(e.target.value as ScaleId)}\n          >\n            {UI_SCALES.map((s) => (\n              <option key={s.id} value={s.id}>{s.display.en}</option>\n            ))}\n          </select>\n        </div>\n        </div>\n      </section>\n      {/* Result: Diatonic → Fretboard */}\n      <section className=\"ot-card\">\n        <h2 className=\"ot-h2\">Result</h2>\n        <div className=\"ot-stack\">\n          <div>\n            <h3 className=\"ot-h3 flex items-center gap-2\"><span>Diatonic</span>\n              <InfoDot title=\"Diatonic chords\" linkHref=\"/resources/glossary\" linkLabel=\"Glossary\">\n                <p className=\"text-sm\">Chords built only from the key’s scale tones (I–ii–iii–IV–V–vi–vii°).</p>\n                <p className=\"text-sm mt-2\">Capo rows show the shapes you fret. The sounding chord tones on the fretboard are the same as the Open row.</p>\n                <p className=\"text-xs mt-1\">See details in Reference → Capo &amp; Shapes</p>\n              </InfoDot>\n            </h3>\n            {!isHept && (\n              <p className=\"text-xs text-foreground/70 mt-1\">\n                This scale is not heptatonic; Roman numerals are hidden. Diatonic suggestions are limited to the Open row.\n              </p>\n            )}\n            <div data-testid={isHept ? undefined : \"diatonic-open-only\"}>\n            <DiatonicCapoTable selectedId={selectedCellId} onSelectId={(id)=>{\n              // 再クリック（同じセル）は状態を変えない（プレビューはResetを使用）\n              if (selectedCellId === id) { return; }\n              setSelectedCellId(id);\n            }} onPick={({ pcs })=>{\n              const mainNotes = pcs.map(pc => PC_NAMES[pc] as string);\n              setOverlayNotes(mainNotes);\n              setLastPickedPcs(pcs);\n              resetForms();\n              track('diatonic_pick', { page:'find-chords', id:selectedCellId, scale: selScaleId, key: keyTonic });\n            }} />\n            </div>\n          </div>\n          {/* Scale table (MVP): show 2-scale suggestions for the selected chord */}\n          {selectedCellId && lastPickedPcs && (\n            <div className=\"mt-2\">\n              <ScaleTable\n                chordQuality={detectQualityFromPcs(lastPickedPcs)}\n                rootPc={scaleRootPc as any}\n                onPreviewScale={(id)=>{ setPreviewScaleId(id as any); }}\n                onResetPreview={()=>{ setPreviewScaleId(null); resetToScale(); }}\n                openGlossary={(id)=>{ try{ window.open('/resources/glossary','_blank'); }catch{} }}\n                activeScaleId={previewScaleId as any}\n              />\n            </div>\n          )}\n          {/* Substitute Chords: show alternative chords */}\n          {selectedCellId && lastPickedPcs && (\n            <SubstituteCard\n              rootPc={scaleRootPc as any}\n              quality={detectQualityFromPcs(lastPickedPcs) as any}\n              degree={(() => {\n                // セルIDから度数を取得 (例: \"open-0\" → 1, \"open-1\" → 2)\n                const parts = selectedCellId.split('-');\n                return parseInt(parts[1] || '0', 10) + 1;\n              })()}\n              keyContext={{\n                tonic: KEY_OPTIONS.indexOf(keyTonic),\n                mode: (selScaleId === 'Aeolian' ? 'Minor' : 'Major') as any\n              }}\n              page=\"find-chords\"\n            />\n          )}\n          <div>\n            <h3 className=\"ot-h3 flex items-center justify-between\">\n              <span>Fretboard</span>\n              <span ref={fbToggleRef} className=\"flex items-center gap-2\" role=\"tablist\" aria-orientation=\"horizontal\" aria-label=\"Fretboard notation\">\n              <button role=\"tab\" aria-selected={display==='degrees'} tabIndex={display==='degrees'?0:-1} className={[\"chip\", display==='degrees'?\"chip--on\":\"\"].join(\" \")} data-roving=\"item\" onClick={()=>{ resetForms(); setDisplay('degrees'); }}>Degrees</button>\n              <button role=\"tab\" aria-selected={display==='names'} tabIndex={display==='names'?0:-1} className={[\"chip\", display==='names'?\"chip--on\":\"\"].join(\" \")} data-roving=\"item\" onClick={()=>{ resetForms(); setDisplay('names'); }}>Names</button>\n              {selectedCellId && (\n                <button role=\"tab\" aria-selected={false} tabIndex={-1} className=\"chip\" onClick={resetToScale} aria-label=\"Reset\">Reset</button>\n              )}\n              </span>\n            </h3>\n            <Fretboard\n              overlay={{\n                viewMode: 'sounding' as any,\n                capo: fbCapo,\n                display: display as any,\n                scaleRootPc: scaleRootPc as any,\n                scaleType: (previewScaleId ?? scaleTypeForUI) as any,\n                showScaleGhost: Boolean(selectedCellId),\n                chordNotes: overlayNotes ?? undefined,\n                context: {\n                  chordRootPc: lastPickedPcs && lastPickedPcs.length ? lastPickedPcs[0] : undefined,\n                  quality: (() => {\n                    const pcs = lastPickedPcs ?? [];\n                    const q = detectQualityFromPcs(pcs.length ? pcs : [scaleRootPc]);\n                    return q === 'min' ? 'min' : 'maj';\n                  })(),\n                },\n              }}\n              onRequestForms={(at, ctx)=>{\n                setFormsPop({ at, rootPc: ctx.rootPc, quality: ctx.quality });\n              }}\n              formShape={formShape}\n            />\n          </div>\n        </div>\n      </section>\n\n      {/* Ad Placeholder (card participates in page rhythm) */}\n      <section className=\"ot-card ad-placeholder\" aria-label=\"Ad\">\n        <AdSlot page=\"find_chords\" format=\"horizontal\" />\n      </section>\n      {formsPop && (\n        <ChordFormsPopover\n          at={formsPop.at}\n          quality={formsPop.quality}\n          rootPc={formsPop.rootPc}\n          page=\"find-chords\"\n          onPick={(kind: FormKind)=>{\n            const shape = buildForm(kind, formsPop.quality, formsPop.rootPc);\n            setFormShape(shape);\n          }}\n          onClose={()=> setFormsPop(null)}\n        />\n      )}\n    </main>\n    </OverlayProvider>\n  );\n}\n\n// --- helpers ---\nfunction detectQualityFromPcs(pcs:number[]): 'maj'|'min'|'dom7'|'m7b5'|'dim' {\n  const set = new Set(pcs.map(x => ((x - pcs[0] + 12) % 12)));\n  // simple triad/7th checks (relative to first pc as root)\n  if (set.has(0) && set.has(4) && set.has(7)) return 'maj';\n  if (set.has(0) && set.has(3) && set.has(7)) return 'min';\n  if (set.has(0) && set.has(3) && set.has(6)) return 'dim';\n  if (set.has(0) && set.has(4) && set.has(7) && set.has(10)) return 'dom7';\n  if (set.has(0) && set.has(3) && set.has(6) && set.has(10)) return 'm7b5';\n  return 'maj';\n}\n\n\n","import React, {createContext, useContext, useRef, useState, useCallback} from 'react';\nimport * as t from '@/lib/telemetry';\n\ntype ViewMode = 'Degrees' | 'Names';\ntype ScaleOverlay = { scaleId: string; notes: number[] } | null;\ntype ChordOverlay = { chordId: string; notes: number[] } | null;\n\ninterface OverlayContextType {\n  viewMode: ViewMode;\n  scale: ScaleOverlay;\n  chord: ChordOverlay;\n  setViewMode: (m: ViewMode) => void;\n  setScale: (s: ScaleOverlay) => void;\n  setChordFromUser: (c: ChordOverlay) => void;\n  resetChord: () => void;\n  // backward-compat aliases (zustand-like naming)\n  setScaleLayer: (s: ScaleOverlay) => void;\n  resetChordLayer: () => void;\n}\n\nconst OverlayContext = createContext<OverlayContextType | null>(null);\n\nexport const OverlayProvider: React.FC<React.PropsWithChildren> = ({children}) => {\n  const [viewMode, setViewMode] = useState<ViewMode>('Degrees');\n  const [scale, setScale] = useState<ScaleOverlay>(null);\n  const [chord, setChord] = useState<ChordOverlay>(null);\n  const shownOnceRef = useRef(false);\n\n  const setChordFromUser = useCallback((c: ChordOverlay) => {\n    setChord(prev => {\n      if (!shownOnceRef.current && !prev && c) {\n        t.track('overlay_shown', { page: 'chord_progression', control: 'chord' });\n        shownOnceRef.current = true;\n      }\n      return c;\n    });\n  }, []);\n\n  const resetChord = useCallback(() => {\n    setChord(null);\n    t.track('overlay_reset', { page: 'chord_progression' });\n  }, []);\n\n  const contextValue: OverlayContextType = {\n    viewMode,\n    scale,\n    chord,\n    setViewMode: (m) => {\n      if (m !== viewMode) {\n        setViewMode(m);\n        t.track('fb_toggle', { page: 'chord_progression', value: m });\n      }\n    },\n    setScale,\n    setChordFromUser,\n    resetChord,\n    // aliases\n    setScaleLayer: (s) => setScale(s),\n    resetChordLayer: () => resetChord(),\n  };\n\n  return React.createElement(\n    OverlayContext.Provider,\n    { value: contextValue },\n    children\n  );\n};\n\n// Accept optional selector for backward compatibility with zustand-like calls\nexport const useOverlay = <T = OverlayContextType>(selector?: (c: OverlayContextType) => T): T => {\n  const ctx = useContext(OverlayContext);\n  if (!ctx) {\n    // Provider未設置時でもクラッシュさせないフェイルセーフ\n    const fallback: OverlayContextType = {\n      viewMode: 'Degrees',\n      scale: null,\n      chord: null,\n      setViewMode: () => {},\n      setScale: () => {},\n      setChordFromUser: () => {},\n      resetChord: () => {},\n      setScaleLayer: () => {},\n      resetChordLayer: () => {},\n    };\n    return (selector ? selector(fallback) : (fallback as unknown as T));\n  }\n  return (selector ? selector(ctx) : (ctx as unknown as T));\n};","export type ScaleId =\n  | 'Ionian' | 'Lydian' | 'Aeolian' | 'Dorian' | 'Phrygian'\n  | 'Mixolydian' | 'Locrian' | 'DiminishedWholeHalf'\n  | 'HarmonicMinor' | 'MelodicMinor' | 'WholeTone' | 'Altered';\n\nexport type WhyKey =\n  | 'maj_ionian' | 'maj_lydian' | 'maj_mixolydian'\n  | 'min_aeolian' | 'min_dorian' | 'min_phrygian' | 'min_harmonic' | 'min_melodic'\n  | 'dom_mixolydian' | 'dom_altered' | 'dom_wholetone'\n  | 'm7b5_locrian' | 'dim_wh';\n\nexport type Suggest = { scales: ScaleId[]; why: WhyKey[] };\n\nexport function suggestScalesForChord(quality: 'maj'|'min'|'dom7'|'m7b5'|'dim'|'maj7'|'m7'|'7'): Suggest {\n  switch (quality) {\n    case 'maj':\n    case 'maj7':\n      return { scales: ['Ionian','Lydian'], why: ['maj_ionian','maj_lydian'] };\n    case 'min':\n    case 'm7':\n      return { scales: ['Aeolian','Dorian','Phrygian'], why: ['min_aeolian','min_dorian','min_phrygian'] };\n    case 'dom7':\n    case '7':\n      return { scales: ['Mixolydian','Altered'], why: ['dom_mixolydian','dom_altered'] };\n    case 'm7b5':\n      return { scales: ['Locrian','DiminishedWholeHalf'], why: ['m7b5_locrian','dim_wh'] };\n    case 'dim':\n      return { scales: ['DiminishedWholeHalf','Locrian'], why: ['dim_wh','m7b5_locrian'] };\n  }\n}\n\n\n","\"use client\";\nimport React, { useRef } from \"react\";\nimport { suggestScalesForChord } from \"@/lib/scaleSuggestions\";\nimport { SCALE_CATALOG } from \"@/lib/scaleCatalog\";\nimport { track as tel } from \"@/lib/telemetry\";\nimport { player } from \"@/lib/audio/player\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\n\nexport function ScaleTable({\n  chordQuality, rootPc, onPreviewScale, onResetPreview, openGlossary, activeScaleId\n}: {\n  chordQuality: 'maj'|'min'|'dom7'|'m7b5'|'dim';\n  rootPc: number; // 0=C,...11=B\n  onPreviewScale: (scaleId: string)=>void; // 下地だけ切替（プレビュー）\n  onResetPreview: ()=>void;                // Reset（プレビュー解除）\n  openGlossary: (scaleId: string)=>void; // /resources/glossary\n  activeScaleId?: string | null;          // 現在プレビュー中のスケール\n}) {\n  const { scales } = suggestScalesForChord(chordQuality);\n  const listRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(listRef, { orientation: \"horizontal\" });\n  return (\n    <div className=\"ot-scale-table\" data-testid=\"scale-chips\" aria-label=\"Suggested scales\">\n      {/* Active scale chip is visually highlighted; no extra label needed */}\n      <details className=\"rounded border p-2 bg-background/40\">\n        <summary className=\"text-sm cursor-pointer select-none\">Suggested scales for this chord</summary>\n        <div className=\"mt-2 flex items-center justify-between gap-2\">\n          <div role=\"tablist\" aria-label=\"Preview scale\" className=\"flex flex-wrap gap-2\" ref={listRef}>\n          {scales.map((id, idx) => (\n            <div key={id} className=\"inline-flex items-center gap-1\">\n              <button\n                role=\"tab\" className={[\"chip\", (activeScaleId===id? \"chip--active\" : \"\")].join(\" \")}\n                onClick={() => { onPreviewScale(id); tel('overlay_shown', { control:'scale', scaleId:id }); void playArpShort(rootPc, id); }}\n                aria-describedby={`why-${id}`}\n                data-roving=\"item\"\n              >\n                {labelFor(id, chordQuality, idx)}\n              </button>\n              <button\n                type=\"button\"\n                className=\"inline-flex items-center justify-center w-5 h-5 rounded-full text-xs opacity-60 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/10 transition-opacity\"\n                onClick={()=> openGlossary(id)}\n                aria-label={`Learn more about ${id}`}\n                title=\"Learn more in Glossary\"\n              >\n                ⓘ\n              </button>\n            </div>\n          ))}\n          </div>\n          <button className=\"btn-ghost text-xs ml-auto\" onClick={onResetPreview}>Reset</button>\n        </div>\n        <div className=\"mt-2 flex flex-wrap gap-x-4 gap-y-1 items-center text-xs opacity-80\">\n          {scales.map((id)=> (\n            <span key={`why-${id}`} id={`why-${id}`}>{getWhyText(id)}</span>\n          ))}\n        </div>\n      </details>\n    </div>\n  );\n}\n\n// 短いアルペジオ（上昇→下降パターン）\nasync function playArpShort(rootPc:number, scaleId:string){\n  try {\n    // @ts-ignore SSOT API exposed in window\n    const api = (window as any).__SCALES_API__;\n    if (!api?.getScalePitchesById) return;\n    const pcs: number[] = api.getScalePitchesById(rootPc, scaleId);\n    const steps = pcs.slice(0, Math.min(5, pcs.length)); // 最大5音\n    const ascending = steps.slice();\n    const descending = steps.slice().reverse().slice(1); // ルート音は重複させない\n    const pattern = [...ascending, ...descending];\n    const dur = 100; // 各音100ms\n    await player.resume();\n    for (const pc of pattern) {\n      player.playNote(60 + pc, dur);\n      await wait(dur);\n    }\n    tel('scale_arpeggio_play', { page: 'find-chords', scaleId, rootPc });\n  } catch {}\n}\nfunction wait(ms:number){ return new Promise(r=>setTimeout(r, ms)); }\n\nfunction getWhyText(scaleId:string){\n  const map:Record<string,string> = {\n    Ionian:'maj_ionian',\n    Lydian:'maj_lydian',\n    Aeolian:'min_aeolian',\n    Dorian:'min_dorian',\n    Phrygian:'min_phrygian',\n    Mixolydian:'dom_mixolydian',\n    Locrian:'m7b5_locrian',\n    DiminishedWholeHalf:'dim_wh',\n    Altered:'dom_altered',\n    HarmonicMinor:'min_harmonic',\n    MelodicMinor:'min_melodic',\n    WholeTone:'dom_wholetone'\n  };\n  const t:Record<string,string> = {\n    maj_ionian:\"Foundation for major chords – fits all diatonic tones\",\n    maj_lydian:\"Bright color with raised 4th (#11) – jazz/modern sound\",\n    maj_mixolydian:\"Dominant-like major – contains the b7 for blues flavor\",\n    min_aeolian:\"Natural minor foundation – matches all minor scale tones\",\n    min_dorian:\"Brighter minor with natural 6th – popular in jazz and funk\",\n    min_phrygian:\"Dark minor with flat 2nd – Spanish/flamenco character\",\n    min_harmonic:\"Dramatic minor with raised 7th – classical and exotic sound\",\n    min_melodic:\"Jazz minor – ascending melodic scale with natural 6th and 7th\",\n    dom_mixolydian:\"Perfect for dominant 7th – contains the b7 tension\",\n    dom_altered:\"Maximum tension – all alterations (b9, #9, #11, b13)\",\n    dom_wholetone:\"Symmetrical whole-tone pattern – dreamy, unresolved quality\",\n    m7b5_locrian:\"Outlines half-diminished chord – starts on the 7th degree\",\n    dim_wh:\"Symmetrical whole-half pattern – creates tension over diminished chords\"\n  };\n  return t[map[scaleId]] || '';\n}\n\nfunction labelFor(id:string, q:'maj'|'min'|'dom7'|'m7b5'|'dim'|'maj7'|'m7'|'7', idx:number){\n  if (q==='maj' || q==='maj7') {\n    if (idx===0) return 'Ionian (Major Scale)';\n    if (idx===1) return 'Lydian (#4 Color)';\n  }\n  if (q==='min' || q==='m7') {\n    if (idx===0) return 'Aeolian (Natural Minor)';\n    if (idx===1) return 'Dorian (Bright Minor)';\n    if (idx===2) return 'Phrygian (Dark Minor)';\n  }\n  if (q==='dom7' || q==='7') {\n    if (idx===0) return 'Mixolydian (Dominant)';\n    if (idx===1) return 'Altered (Tension)';\n  }\n  if (q==='m7b5') {\n    if (idx===0) return 'Locrian (Half-Dim)';\n    if (idx===1) return 'Whole–Half Dim';\n  }\n  if (q==='dim') {\n    if (idx===0) return 'Whole–Half Dim';\n    if (idx===1) return 'Locrian';\n  }\n  return id;\n}\n\nexport default ScaleTable;\n\n\n","\"use client\";\n\nimport React, { useEffect, useRef } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport type { FormKind, Quality } from \"@/lib/chordForms\";\nimport { trackOverlayShown, track } from \"@/lib/telemetry\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport { player } from \"@/lib/audio/player\";\n\ntype Props = {\n  at: { x: number; y: number };\n  quality: Quality;\n  rootPc: number; // 追加: ルート音のピッチクラス\n  onPick: (kind: FormKind) => void;\n  onClose: () => void;\n  page?: string;\n};\n\nexport function ChordFormsPopover({ at, quality, rootPc, onPick, onClose, page = \"analyze\" }: Props) {\n  const ref = useRef<HTMLDivElement>(null);\n  const closeRef = useRef(onClose);\n  closeRef.current = onClose;\n  const sentOpenRef = useRef(false);\n  const pickedRef = useRef(false);\n  const buttonsRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(buttonsRef, { orientation: \"horizontal\" });\n\n  useEffect(() => {\n    if (!sentOpenRef.current) {\n      sentOpenRef.current = true;\n      trackOverlayShown({ control: \"forms\", open: true, page });\n    }\n\n    const firstButton = ref.current?.querySelector<HTMLButtonElement>(\"button\");\n    firstButton?.focus({ preventScroll: true });\n\n    function onKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") closeRef.current();\n    }\n    function onClickOutside(e: MouseEvent) {\n      if (!ref.current) return;\n      if (!ref.current.contains(e.target as Node)) closeRef.current();\n    }\n\n    document.addEventListener(\"keydown\", onKey);\n    document.addEventListener(\"mousedown\", onClickOutside);\n    return () => {\n      document.removeEventListener(\"keydown\", onKey);\n      document.removeEventListener(\"mousedown\", onClickOutside);\n    };\n  }, [page]);\n\n  const style: React.CSSProperties = {\n    position: \"fixed\",\n    left: at.x,\n    top: at.y,\n    zIndex: 2147483647,\n    pointerEvents: \"auto\",\n  };\n\n  const choose = (kind: FormKind) => {\n    if (pickedRef.current) return;\n    pickedRef.current = true;\n    trackOverlayShown({ control: \"forms\", value: kind, page });\n    onPick(kind);\n    onClose();\n  };\n\n  const playFormPreview = async (kind: FormKind) => {\n    try {\n      await player.resume();\n      // 基本的な3和音を再生（ルート、3度、5度）\n      const intervals = quality === 'maj' ? [0, 4, 7] : [0, 3, 7];\n      const midis = intervals.map(iv => 60 + rootPc + iv);\n      player.playChord(midis, 'lightStrum', 300);\n      track('play_chord', { page, source: 'form_preview', kind });\n    } catch {}\n  };\n\n  const node = (\n    <div\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-label=\"Chord forms\"\n      ref={ref}\n      style={style}\n      className=\"ot-pop\"\n    >\n      <div className=\"flex items-center justify-between mb-2\">\n        <p className=\"ot-h3\" style={{ margin: 0 }}>\n          Chord Forms\n        </p>\n        <button\n          type=\"button\"\n          onClick={onClose}\n          className=\"text-xs opacity-60 hover:opacity-100 px-2 py-1 rounded hover:bg-black/5 dark:hover:bg-white/10\"\n          aria-label=\"Close\"\n        >\n          ✕\n        </button>\n      </div>\n      <p className=\"text-xs opacity-70 mb-3\">\n        Select a fingering pattern for {quality === 'maj' ? 'major' : 'minor'} chord\n      </p>\n      <div className=\"flex flex-col gap-2\" ref={buttonsRef}>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"open\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Open Position</div>\n            <div className=\"text-xs opacity-70\">Uses open strings</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"open\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview open position\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"barreE\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Barre (E-shape)</div>\n            <div className=\"text-xs opacity-70\">6th string root</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"barreE\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview E-shape barre\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"barreA\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Barre (A-shape)</div>\n            <div className=\"text-xs opacity-70\">5th string root</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"barreA\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview A-shape barre\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n      </div>\n      <p className=\"ot-hint mt-3\">Right-click or long-press a chord to open.</p>\n    </div>\n  );\n\n  if (typeof document !== \"undefined\") {\n    return createPortal(node, document.body);\n  }\n  return node;\n}\n\nexport default ChordFormsPopover;\n ","export type Degree = '1'|'b2'|'2'|'b3'|'3'|'4'|'b5'|'5'|'#5'|'6'|'b7'|'7';\nexport type FormKind = 'open'|'barreE'|'barreA';\nexport type Quality = 'maj'|'min';\n\nexport type ShapeDot = {\n  string: 1|2|3|4|5|6;   // 1 = highest (thin) string\n  fret: number;           // 0 = open string\n  deg: Degree;\n  muted?: boolean;\n};\n\nexport type FormShape = {\n  kind: FormKind;\n  quality: Quality;\n  rootPc: number;         // 0=C, 1=C#, ... 11=B\n  rootString: 6|5;        // 6 = E-shape, 5 = A-shape\n  dots: ShapeDot[];\n  barre?: { stringFrom: 6|5; fret: number };\n};\n\nconst OPEN_E_PC = 4; // E\nconst OPEN_A_PC = 9; // A\n\nfunction mod12(n: number): number {\n  return ((n % 12) + 12) % 12;\n}\n\nfunction nearestBarreFretForRoot(openPc: number, targetPc: number): number {\n  const tgt = mod12(targetPc);\n  for (let f = 1; f <= 12; f++) {\n    if (mod12(openPc + f) === tgt) return f;\n  }\n  return 1;\n}\n\nexport function getOpenShapeE(quality: Quality, rootPc: number): FormShape {\n  const dots: ShapeDot[] =\n    quality === 'maj'\n      ? [\n          { string: 6, fret: 0, deg: '1' },\n          { string: 5, fret: 2, deg: '5' },\n          { string: 4, fret: 2, deg: '1' },\n          { string: 3, fret: 1, deg: '3' },\n          { string: 2, fret: 0, deg: '5' },\n          { string: 1, fret: 0, deg: '1' },\n        ]\n      : [\n          { string: 6, fret: 0, deg: '1' },\n          { string: 5, fret: 2, deg: '5' },\n          { string: 4, fret: 2, deg: '1' },\n          { string: 3, fret: 0, deg: 'b3' },\n          { string: 2, fret: 0, deg: '5' },\n          { string: 1, fret: 0, deg: '1' },\n        ];\n\n  return { kind: 'open', quality, rootPc, rootString: 6, dots };\n}\n\nexport function makeBarreEShape(quality: Quality, rootPc: number): FormShape {\n  const f = nearestBarreFretForRoot(OPEN_E_PC, rootPc);\n  const dots: ShapeDot[] = [\n    { string: 6, fret: f, deg: '1' },\n    { string: 5, fret: f + 2, deg: '5' },\n    { string: 4, fret: f + 2, deg: '1' },\n    { string: 3, fret: quality === 'maj' ? f + 1 : f, deg: quality === 'maj' ? '3' : 'b3' },\n    { string: 2, fret: f, deg: '5' },\n    { string: 1, fret: f, deg: '1' },\n  ];\n\n  return {\n    kind: 'barreE',\n    quality,\n    rootPc,\n    rootString: 6,\n    dots,\n    barre: { stringFrom: 6, fret: f },\n  };\n}\n\nexport function makeBarreAShape(quality: Quality, rootPc: number): FormShape {\n  const f = nearestBarreFretForRoot(OPEN_A_PC, rootPc);\n  const dots: ShapeDot[] = [\n    { string: 5, fret: f, deg: '1' },\n    { string: 4, fret: f + 2, deg: '5' },\n    { string: 3, fret: quality === 'maj' ? f + 2 : f, deg: quality === 'maj' ? '3' : 'b3' },\n    { string: 2, fret: f + 2, deg: '1' },\n    { string: 1, fret: f, deg: '5' },\n  ];\n\n  return {\n    kind: 'barreA',\n    quality,\n    rootPc,\n    rootString: 5,\n    dots,\n    barre: { stringFrom: 5, fret: f },\n  };\n}\n\nexport function buildForm(kind: FormKind, quality: Quality, rootPc: number): FormShape {\n  if (kind === 'open') return getOpenShapeE(quality, rootPc);\n  if (kind === 'barreE') return makeBarreEShape(quality, rootPc);\n  return makeBarreAShape(quality, rootPc);\n}\n\n\n","/**\n * 代理コード（Substitute Chords）推奨ロジック（リファクタリング版）\n * \n * 各ダイアトニックコードに対して、機能的に類似した代理コード候補を提示\n */\n\nimport { pcToName, mod12 } from '@/lib/music/constants';\n\nexport type SubstituteChord = {\n  chord: string; // \"Cmaj7\", \"Am\" など\n  reason: string; // 代理の理由（一文）\n  examples?: string[]; // 代表曲の例（2〜3件）\n};\n\nexport type ChordContext = {\n  rootPc: number; // 0=C, 1=C#, ..., 11=B\n  quality: 'maj' | 'min' | 'dom7' | 'dim';\n  degree: number; // 1=I, 2=II, ..., 7=VII (1-indexed)\n  key: { tonic: number; mode: 'Major' | 'Minor' };\n};\n\ntype SubstituteRule = (context: ChordContext) => SubstituteChord[];\n\n/**\n * Major keyにおける各度数の代理コード定義\n */\nconst MAJOR_KEY_SUBSTITUTES: Record<number, SubstituteRule> = {\n  // I (Tonic)\n  1: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Richer tonic sound with major 7th\",\n      examples: [\"The Girl from Ipanema\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}6`,\n      reason: \"Jazz tonic with added 6th\",\n      examples: [\"All the Things You Are\", \"Autumn Leaves\"]\n    },\n    {\n      chord: `${pcToName(mod12(rootPc + 9))}m`,\n      reason: \"Relative minor shares the same notes\",\n      examples: [\"Let It Be\", \"No Woman No Cry\"]\n    }\n  ],\n\n  // ii (Subdominant)\n  2: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Jazz ii with minor 7th\",\n      examples: [\"Autumn Leaves\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: pcToName(mod12(key.tonic + 5)),\n      reason: \"IV chord shares subdominant function\",\n      examples: [\"Let It Be\", \"Hey Jude\"]\n    }\n  ],\n\n  // IV (Subdominant)\n  4: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Lydian color with major 7th\",\n      examples: [\"The Girl from Ipanema\", \"Dreams (Fleetwood Mac)\"]\n    },\n    {\n      chord: `${pcToName(mod12(key.tonic + 2))}m`,\n      reason: \"ii chord shares subdominant function\",\n      examples: [\"Autumn Leaves\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}m`,\n      reason: \"Borrowed minor IV for color\",\n      examples: [\"Yesterday\", \"Creep\"]\n    }\n  ],\n\n  // V (Dominant)\n  5: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}7`,\n      reason: \"Dominant 7th creates strong tension\",\n      examples: [\"Sweet Home Alabama\", \"Twist and Shout\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}sus4`,\n      reason: \"Suspended 4th delays resolution\",\n      examples: [\"Pinball Wizard\", \"The Edge of Glory\"]\n    },\n    {\n      chord: `${pcToName(mod12(key.tonic + 11))}dim`,\n      reason: \"vii° shares dominant function\",\n      examples: [\"Girl from Ipanema\", \"Michelle\"]\n    }\n  ],\n\n  // vi (Tonic)\n  6: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Jazz minor with added 7th\",\n      examples: [\"Stairway to Heaven\", \"Hotel California\"]\n    },\n    {\n      chord: pcToName(key.tonic),\n      reason: \"Relative major shares the same notes\",\n      examples: [\"Let It Be\", \"Hey Jude\"]\n    }\n  ]\n};\n\n/**\n * Minor keyにおける各度数の代理コード定義\n */\nconst MINOR_KEY_SUBSTITUTES: Record<number, SubstituteRule> = {\n  // i (Tonic)\n  1: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Natural minor 7th\",\n      examples: [\"Stairway to Heaven\", \"Smooth\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}m6`,\n      reason: \"Minor 6th for Dorian color\",\n      examples: [\"Scarborough Fair\", \"So What\"]\n    },\n    {\n      chord: pcToName(mod12(rootPc + 3)),\n      reason: \"Relative major (bIII) shares notes\",\n      examples: [\"Stairway to Heaven\", \"All Along the Watchtower\"]\n    }\n  ],\n\n  // iv (Subdominant)\n  4: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Minor 7th for subdominant color\",\n      examples: [\"Light My Fire\", \"Losing My Religion\"]\n    }\n  ],\n\n  // v or V (Dominant)\n  5: ({ rootPc, quality }) => {\n    if (quality === 'min') {\n      return [\n        {\n          chord: `${pcToName(rootPc)}7`,\n          reason: \"Raised 3rd (V7) for stronger resolution\",\n          examples: [\"Stairway to Heaven\", \"House of the Rising Sun\"]\n        }\n      ];\n    } else {\n      return [\n        {\n          chord: `${pcToName(rootPc)}7`,\n          reason: \"Dominant 7th for tension\",\n          examples: [\"Smooth\", \"Black Magic Woman\"]\n        }\n      ];\n    }\n  }\n};\n\n/**\n * 汎用的な代理コード（度数が定義されていない場合）\n */\nfunction getGenericSubstitutes(context: ChordContext): SubstituteChord[] {\n  const { rootPc, quality } = context;\n  const subs: SubstituteChord[] = [];\n\n  if (quality === 'maj') {\n    subs.push({\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Added major 7th for richer sound\"\n    });\n  } else if (quality === 'min') {\n    subs.push({\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Added minor 7th for jazz flavor\"\n    });\n  }\n\n  return subs;\n}\n\n/**\n * 代理コード候補を取得\n * @param context コードのコンテキスト（ルート音、クオリティ、度数、キー）\n * @returns 代理コード候補の配列（最大3つ）\n */\nexport function getSubstitutes(context: ChordContext): SubstituteChord[] {\n  const { degree, key } = context;\n  const isMajorKey = key.mode === 'Major';\n\n  // 辞書から適切なルールを取得\n  const substitutesMap = isMajorKey ? MAJOR_KEY_SUBSTITUTES : MINOR_KEY_SUBSTITUTES;\n  const rule = substitutesMap[degree];\n\n  let substitutes: SubstituteChord[];\n  \n  if (rule) {\n    substitutes = rule(context);\n  } else {\n    // 定義されていない度数には汎用ルールを適用\n    substitutes = getGenericSubstitutes(context);\n  }\n\n  // 最大3つまで\n  return substitutes.slice(0, 3);\n}\n\n","\"use client\";\n\nimport React, { useRef, useEffect, useMemo, useCallback } from \"react\";\nimport { getSubstitutes, type SubstituteChord, type ChordContext } from \"@/lib/chords/substitute.refactored\";\nimport { player } from \"@/lib/audio/player\";\nimport { track } from \"@/lib/telemetry\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport { chordToMidi } from \"@/lib/music/chordParser\";\n\ntype Props = {\n  rootPc: number; // 0=C, 1=C#, ..., 11=B\n  quality: 'maj' | 'min' | 'dom7' | 'dim';\n  degree: number; // 1=I, 2=II, ..., 7=VII\n  keyContext: { tonic: number; mode: 'Major' | 'Minor' };\n  onAdd?: (chord: string) => void; // Chord Progression への追加\n  page?: string;\n};\n\nexport function SubstituteCard({ \n  rootPc, \n  quality, \n  degree, \n  keyContext, \n  onAdd, \n  page = 'find-chords' \n}: Props) {\n  const listRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(listRef, { orientation: \"horizontal\" });\n\n  // コンテキストをメモ化\n  const context = useMemo<ChordContext>(() => ({\n    rootPc,\n    quality,\n    degree,\n    key: keyContext\n  }), [rootPc, quality, degree, keyContext]);\n\n  // 代理コード候補を計算\n  const substitutes = useMemo(() => {\n    return getSubstitutes(context);\n  }, [context]);\n\n  // Telemetry: 表示時に1回だけ送信\n  useEffect(() => {\n    if (substitutes.length > 0) {\n      track('substitute_shown', { \n        page, \n        rootPc, \n        quality, \n        degree, \n        count: substitutes.length \n      });\n    }\n  }, [substitutes, page, rootPc, quality, degree]);\n\n  // 試聴機能\n  const playSubstitute = useCallback(async (sub: SubstituteChord) => {\n    try {\n      await player.resume();\n      \n      const midis = chordToMidi(sub.chord);\n      if (!midis || midis.length === 0) {\n        console.warn(`Failed to parse chord: ${sub.chord}`);\n        return;\n      }\n\n      player.playChord(midis, 'lightStrum', 300);\n      track('play_chord', { \n        page, \n        source: 'substitute_preview', \n        chord: sub.chord \n      });\n    } catch (error) {\n      console.error('Failed to play substitute chord:', error);\n    }\n  }, [page]);\n\n  // 追加機能\n  const handleAdd = useCallback((sub: SubstituteChord) => {\n    if (onAdd) {\n      onAdd(sub.chord);\n      track('substitute_add', { \n        page, \n        rootPc, \n        originalQuality: quality, \n        substituteChord: sub.chord \n      });\n    }\n  }, [onAdd, page, rootPc, quality]);\n\n  // 代理コードがない場合は非表示\n  if (substitutes.length === 0) {\n    return null;\n  }\n\n  return (\n    <details className=\"rounded border p-2 bg-background/40 mt-2\">\n      <summary className=\"text-sm cursor-pointer select-none font-medium\">\n        Substitute Chords ({substitutes.length})\n      </summary>\n      <div className=\"mt-2\">\n        <p className=\"text-xs opacity-70 mb-3 px-1\">\n          Alternative chords with similar harmonic function\n        </p>\n        <div className=\"space-y-2\" ref={listRef}>\n          {substitutes.map((sub, idx) => (\n            <SubstituteChordItem\n              key={`${sub.chord}-${idx}`}\n              substitute={sub}\n              onPlay={playSubstitute}\n              onAdd={onAdd ? handleAdd : undefined}\n            />\n          ))}\n        </div>\n      </div>\n    </details>\n  );\n}\n\n/**\n * 個別の代理コードアイテムコンポーネント\n */\ntype SubstituteChordItemProps = {\n  substitute: SubstituteChord;\n  onPlay: (sub: SubstituteChord) => void;\n  onAdd?: (sub: SubstituteChord) => void;\n};\n\nfunction SubstituteChordItem({ substitute, onPlay, onAdd }: SubstituteChordItemProps) {\n  return (\n    <div className=\"rounded border p-2 bg-white dark:bg-neutral-900/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\">\n      <div className=\"flex items-start justify-between gap-2 mb-1\">\n        <div className=\"flex-1\">\n          <div className=\"font-medium text-base\">{substitute.chord}</div>\n          <div className=\"text-sm opacity-80 mt-0.5\">{substitute.reason}</div>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <button\n            type=\"button\"\n            onClick={() => onPlay(substitute)}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label={`Preview ${substitute.chord}`}\n            title=\"Preview sound\"\n            data-roving=\"item\"\n          >\n            ▶\n          </button>\n          {onAdd && (\n            <button\n              type=\"button\"\n              onClick={() => onAdd(substitute)}\n              className=\"px-2 py-1 text-xs rounded border bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-colors\"\n              aria-label={`Add ${substitute.chord} to progression`}\n              title=\"Add to progression\"\n            >\n              + Add\n            </button>\n          )}\n        </div>\n      </div>\n      {substitute.examples && substitute.examples.length > 0 && (\n        <div className=\"text-xs opacity-60 mt-1 flex items-center gap-1\">\n          <span className=\"opacity-70\">Examples:</span>\n          <span>{substitute.examples.join(' · ')}</span>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default SubstituteCard;\n\n"],"names":[],"mappings":"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"}