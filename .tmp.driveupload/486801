"use strict";(()=>{var e={};e.id=9652,e.ids=[9652],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},8105:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>S,patchFetch:()=>x,requestAsyncStorage:()=>b,routeModule:()=>_,serverHooks:()=>P,staticGenerationAsyncStorage:()=>v});var n={};r.r(n),r.d(n,{POST:()=>g,runtime:()=>u});var o=r(9303),a=r(8716),i=r(670),s=r(7070);let u="nodejs",c=Number(process.env.CONF_THRESHOLD_LOW??.58),l=Number(process.env.CONF_THRESHOLD_HIGH??.85),p=Number(process.env.CONF_LEN_GAIN??.03),d=Number(process.env.CONF_SNR_GAIN??.03),m=Number(process.env.CONF_SNR_PENALTY??.08),y=[0,2,4,5,7,9,11],h=[0,2,3,5,7,8,10];function f(e,t){return e.map(e=>(e+t)%12)}function N(e,t={}){try{fetch("/api/telemetry",{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({event:e,...t})}).catch(()=>{})}catch{}}async function g(e){try{let t=await e.json(),r=function(e){if(!Array.isArray(e)||12!==e.length)return null;let t=e.map(e=>Number.isFinite(e)?Math.max(0,Number(e)):NaN);if(t.some(e=>!Number.isFinite(e)))return null;let r=t.reduce((e,t)=>e+t,0);if(r<=0)return null;let n=t.map(e=>e/r);return n.some(e=>!Number.isFinite(e))?null:n}(t?.pcp12);if(!r)return N("audio_analyze_err",{code:"pcp12_invalid",status:400}),s.NextResponse.json({error:"pcp12_invalid"},{status:400});let n=function(e){let t=t=>t.reduce((t,r)=>t+e[r],0);return[...Array.from({length:12},(e,r)=>({keyPc:r,mode:"major",score:t(f(y,r))})),...Array.from({length:12},(e,r)=>({keyPc:r,mode:"minor",score:t(f(h,r))}))].sort((e,t)=>t.score-e.score).slice(0,3)}(r),{conf:o,level:a,candidates:i}=function(e,t){let r=e[0]?.score??0,n=e[1]?.score??0,o=r+n+(e[2]?.score??0);if(!Number.isFinite(o)||o<=0)return{conf:0,level:"low",candidates:e.map(e=>({keyPc:e.keyPc,mode:e.mode,confidence:0}))};let a=r/o;"number"==typeof t?.lengthSec&&t.lengthSec>=6&&t.lengthSec<=14&&(a+=p),"number"==typeof t?.snrHint&&(t.snrHint>18?a+=d:t.snrHint<8&&(a-=m));let i=(a=Math.max(0,Math.min(1,Number.isFinite(a)?a:0)))<c?"low":a>=l?"high":"mid";return{conf:a,level:i,candidates:e.map(e=>({keyPc:e.keyPc,mode:e.mode,confidence:o>0?e.score/o:0}))}}(n,{lengthSec:t?.lengthSec,snrHint:t?.snrHint});N("audio_analyze_ok",{n:r.length}),N("audio_analyze_conf",{level:a,conf:o});let u={keyCandidates:i,conf:o,pcp12:r,...o<c?{advice:function(e,t){let r=[];return r.push("Low signal quality. Try recording again in a quieter room for 4â€“12s. Record at least ~4 seconds."),"number"==typeof e&&e<8&&r.push("Avoid background noise and bring the instrument closer to the mic."),r.join(" ")}(t?.snrHint,t?.lengthSec)}:{}};return s.NextResponse.json(u,{status:200})}catch(e){return N("audio_analyze_err",{code:"analyze_failed",status:500}),s.NextResponse.json({error:"analyze_failed"},{status:500})}}let _=new o.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/analyze/route",pathname:"/api/analyze",filename:"route",bundlePath:"app/api/analyze/route"},resolvedPagePath:"/Users/nh/App/OtoTheory/ototheory-web/src/app/api/analyze/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:b,staticGenerationAsyncStorage:v,serverHooks:P}=_,S="/api/analyze/route";function x(){return(0,i.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:v})}}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[8948,5972],()=>r(8105));module.exports=n})();