{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/AdSlot.client.tsx"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { track } from \"@/lib/telemetry\";\nimport { usePro } from \"@/components/ProProvider\";\n\ninterface AdSlotProps {\n  page: string;\n  slot?: string; // AdSense広告スロットID（オプション）\n  format?: \"auto\" | \"rectangle\" | \"horizontal\" | \"vertical\";\n  style?: React.CSSProperties;\n}\n\nexport default function AdSlot({ \n  page, \n  slot = \"XXXXXXXXXX\", // デフォルトの広告スロットID\n  format = \"auto\",\n  style = {}\n}: AdSlotProps) {\n  const { isPro } = usePro();\n  const [mounted, setMounted] = useState(false);\n  const [adLoaded, setAdLoaded] = useState(false);\n\n  useEffect(() => {\n    setMounted(true);\n  }, []);\n\n  useEffect(() => {\n    if (!mounted || isPro) return;\n\n    // AdSenseの広告をロード\n    try {\n      // @ts-ignore\n      if (window.adsbygoogle && !adLoaded) {\n        // @ts-ignore\n        (window.adsbygoogle = window.adsbygoogle || []).push({});\n        setAdLoaded(true);\n        track(\"ad_shown\", { page });\n      }\n    } catch (error) {\n      console.error(\"AdSense load error:\", error);\n    }\n  }, [mounted, isPro, page, adLoaded]);\n\n  if (isPro) {\n    return null;\n  }\n\n  return (\n    <div \n      style={{ minHeight: 110, ...style }} \n      aria-label=\"Advertisement\"\n      className=\"ad-container\"\n    >\n      {mounted ? (\n        <ins\n          className=\"adsbygoogle\"\n          style={{ display: \"block\", ...style }}\n          data-ad-client=\"ca-pub-9662479821167655\"\n          data-ad-slot={slot}\n          data-ad-format={format}\n          data-full-width-responsive=\"true\"\n        />\n      ) : null}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AACA;AACA;AAJA;;;;;AAae,SAAS,OAAO,EAC7B,IAAI,EACJ,OAAO,YAAY,EACnB,SAAS,MAAM,EACf,QAAQ,CAAC,CAAC,EACE;IACZ,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,2IAAM;IACxB,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAC;IAEzC,IAAA,kNAAS,EAAC;QACR,WAAW;IACb,GAAG,EAAE;IAEL,IAAA,kNAAS,EAAC;QACR,IAAI,CAAC,WAAW,OAAO;QAEvB,iBAAiB;QACjB,IAAI;YACF,aAAa;YACb,IAAI,OAAO,WAAW,IAAI,CAAC,UAAU;gBACnC,aAAa;gBACb,CAAC,OAAO,WAAW,GAAG,OAAO,WAAW,IAAI,EAAE,EAAE,IAAI,CAAC,CAAC;gBACtD,YAAY;gBACZ,IAAA,gIAAK,EAAC,YAAY;oBAAE;gBAAK;YAC3B;QACF,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,uBAAuB;QACvC;IACF,GAAG;QAAC;QAAS;QAAO;QAAM;KAAS;IAEnC,IAAI,OAAO;QACT,OAAO;IACT;IAEA,qBACE,8OAAC;QACC,OAAO;YAAE,WAAW;YAAK,GAAG,KAAK;QAAC;QAClC,cAAW;QACX,WAAU;kBAET,wBACC,8OAAC;YACC,WAAU;YACV,OAAO;gBAAE,SAAS;gBAAS,GAAG,KAAK;YAAC;YACpC,kBAAe;YACf,gBAAc;YACd,kBAAgB;YAChB,8BAA2B;;;;;mBAE3B;;;;;;AAGV","debugId":null}},
    {"offset": {"line": 81, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music-theory.ts"],"sourcesContent":["import { Key, Note, Scale } from \"tonal\";\n\nexport type NoteLetter =\n  | \"A\" | \"Bb\" | \"B\" | \"C\" | \"C#\" | \"Db\" | \"D\" | \"Eb\" | \"E\" | \"F\" | \"F#\" | \"Gb\" | \"G\" | \"Ab\";\n\nexport type KeySignature = { tonic: NoteLetter; quality: \"major\" | \"minor\" };\nexport type KeyCandidate = { key: KeySignature; confidence: number; reasons: string[] };\n\nexport type ScaleId =\n  | \"major\" | \"naturalMinor\" | \"majorPent\" | \"minorPent\" | \"blues\"\n  | \"dorian\" | \"mixolydian\" | \"lydian\" | \"harmonicMinor\" | \"melodicMinor\";\n\nexport type ScaleMeta = { id: ScaleId; name: string; tier: \"free\" | \"pro\" };\nexport type ScaleCandidate = { scale: ScaleMeta; score: number };\n\nexport type AnalysisResult = {\n  keyCandidates: KeyCandidate[];\n  recommendedScales: ScaleCandidate[];\n  perSection?: SectionAnalysis[];\n};\n\n// Phase E-5: Section-weighted analysis\nexport type SectionName =\n  | \"Intro\" | \"Verse\" | \"PreChorus\" | \"Chorus\" | \"PostChorus\"\n  | \"Bridge\" | \"Solo\" | \"Interlude\" | \"Outro\" | \"Breakdown\" | \"Custom\";\n\nexport interface SectionDef {\n  name: SectionName;\n  start: number;     // inclusive (0-based index in chords[])\n  end: number;       // inclusive\n  repeat?: number;   // default 1\n  weightMul?: number; // optional override\n}\n\nexport interface SectionAnalysis {\n  section: SectionDef;\n  best: KeyCandidate;\n  ranking: KeyCandidate[];\n}\n\nexport interface AnalyzeOpts {\n  sections?: SectionDef[];\n  weights?: Partial<{\n    section: Partial<Record<SectionName, number>>;\n    songHead: number; // default 1.2\n    songTail: number; // default 1.3\n    sectionEdge: number; // default 1.1\n  }>;\n  cadence?: boolean; // enable cadence detection (future)\n}\n\nconst ALL_TONICS: NoteLetter[] = [\n  \"C\", \"C#\", \"D\", \"Eb\", \"E\", \"F\", \"F#\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\",\n];\n\n// Phase E-5: Default section weights (based on musical importance)\nconst DEFAULT_SECTION_WEIGHTS: Record<SectionName, number> = {\n  Intro: 0.8,\n  Verse: 1.0,\n  PreChorus: 1.2,\n  Chorus: 1.6,      // サビは最重要\n  PostChorus: 1.3,\n  Bridge: 0.9,\n  Solo: 1.0,\n  Interlude: 0.8,\n  Outro: 0.9,\n  Breakdown: 0.9,\n  Custom: 1.0,\n};\n\nconst DEFAULT_WEIGHTS = {\n  songHead: 1.2,  // 既存の先頭重み\n  songTail: 1.3,  // 既存の末尾重み\n  sectionEdge: 1.1, // セクション先頭/末尾の補正\n};\n\nconst SCALE_DEFS: Record<ScaleId, ScaleMeta> = {\n  major: { id: \"major\", name: \"Major Scale\", tier: \"free\" },\n  naturalMinor: { id: \"naturalMinor\", name: \"Natural Minor Scale\", tier: \"free\" },\n  majorPent: { id: \"majorPent\", name: \"Major Pentatonic\", tier: \"free\" },\n  minorPent: { id: \"minorPent\", name: \"Minor Pentatonic\", tier: \"free\" },\n  blues: { id: \"blues\", name: \"Blues Scale\", tier: \"free\" },\n  dorian: { id: \"dorian\", name: \"Dorian Mode\", tier: \"pro\" },\n  mixolydian: { id: \"mixolydian\", name: \"Mixolydian Mode\", tier: \"pro\" },\n  lydian: { id: \"lydian\", name: \"Lydian Mode\", tier: \"pro\" },\n  harmonicMinor: { id: \"harmonicMinor\", name: \"Harmonic Minor\", tier: \"pro\" },\n  melodicMinor: { id: \"melodicMinor\", name: \"Melodic Minor\", tier: \"pro\" },\n};\n\ntype ParsedChord = {\n  raw: string;\n  root: string; // canonical pitch class, e.g., C, C#, Bb\n  triad: \"maj\" | \"min\" | \"dim\";\n  isDominantLike: boolean; // contains \"7\" (for V/V detection)\n};\n\nfunction normalizeNote(input: string): string {\n  const n = Note.pitchClass(input);\n  return n || input;\n}\n\nfunction parseChordToken(token: string): ParsedChord | null {\n  if (!token) return null;\n  // Remove bass/slash\n  const [head] = token.split(\"/\");\n  const m = head.match(/^([A-Ga-g])([#b]?)(.*)$/);\n  if (!m) return null;\n  const root = normalizeNote((m[1] + m[2]).toUpperCase());\n  const rest = (m[3] || \"\").toLowerCase();\n  // Order matters: detect maj before generic m\n  let triad: ParsedChord[\"triad\"] = \"maj\";\n  if (/(m7b5|ø|dim)/.test(rest)) triad = \"dim\";\n  else if (/maj/.test(rest)) triad = \"maj\";\n  else if (/(^|[^a-z])m(?!aj)/.test(rest)) triad = \"min\";\n  else if (/sus|aug/.test(rest)) triad = \"maj\"; // treat as functional major\n  else triad = \"maj\";\n  const isDominantLike = /(^|[^a-z])7(?![a-z0-9])/.test(rest) || /7/.test(rest);\n  return { raw: token, root, triad, isDominantLike };\n}\n\nfunction getDiatonicChords(key: KeySignature): string[] {\n  if (key.quality === \"major\") {\n    const mk = Key.majorKey(key.tonic);\n    return mk.chords || [];\n  }\n  const nk = Key.minorKey(key.tonic);\n  return nk.natural?.chords || nk.chords || [];\n}\n\nfunction isDiatonicMatch(chord: ParsedChord, diatonic: string[]): boolean {\n  const target = chord.root + (chord.triad === \"maj\" ? \"\" : chord.triad === \"min\" ? \"m\" : \"dim\");\n  return diatonic.includes(target);\n}\n\nfunction fifth(note: string): string {\n  const p = Note.transpose(note, \"5P\");\n  return normalizeNote(p);\n}\n\nfunction flat(note: string): string {\n  const p = Note.transpose(note, \"-1m\");\n  return normalizeNote(p);\n}\n\nfunction isSecondaryDominant(chord: ParsedChord, key: KeySignature): boolean {\n  // very light-weight V/V detector: major triad (or 7) on degree 2's major? We'll approximate as fifth of fifth\n  const v = fifth(key.tonic);\n  const vOfV = fifth(v);\n  return chord.root === vOfV && (chord.triad === \"maj\" || chord.isDominantLike);\n}\n\nfunction isSubdominantMinorOrbVII(chord: ParsedChord, key: KeySignature): boolean {\n  if (key.quality !== \"major\") return false;\n  const mk = Key.majorKey(key.tonic);\n  const scale = mk.scale || [];\n  const degree4 = scale[3];\n  const degree7 = scale[6];\n  const ivMinor = degree4 ? normalizeNote(degree4) : \"\";\n  const bVII = degree7 ? normalizeNote(flat(degree7)) : \"\";\n  const isIvMinor = chord.root === ivMinor && chord.triad === \"min\";\n  const isB7 = chord.root === bVII && chord.triad === \"maj\";\n  return !!(isIvMinor || isB7);\n}\n\nfunction scoreForKey(\n  chords: ParsedChord[],\n  key: KeySignature,\n  weights?: number[]\n): { score: number; reasons: string[] } {\n  const diatonic = getDiatonicChords(key);\n  let reasons: string[] = [];\n  \n  // Phase E-5: Use provided weights or fall back to legacy position weights\n  const W = weights || chords.map((_, i) => (i === 0 ? 1.2 : i === chords.length - 1 ? 1.3 : 1));\n  const total = W.reduce((a, b) => a + b, 0);\n  \n  let acc = 0;\n  chords.forEach((ch, i) => {\n    const w = W[i];\n    if (isDiatonicMatch(ch, diatonic)) {\n      acc += w * 1.0; // 100%\n    } else if (isSecondaryDominant(ch, key)) {\n      acc += w * 0.9; // 85-95%\n      reasons.push(`Secondary dominant tolerated: ${ch.raw}`);\n    } else if (isSubdominantMinorOrbVII(ch, key)) {\n      acc += w * 0.8; // 70-85%\n      reasons.push(`Borrowed chord tolerated: ${ch.raw}`);\n    } else {\n      acc += w * 0.5; // potential modulation or out-of-key\n    }\n  });\n  const confidence = Math.round((acc / total) * 100);\n  reasons.unshift(`${diatonic.length} diatonic chords in ${key.tonic} ${key.quality}`);\n  return { score: confidence, reasons };\n}\n\nfunction recommendScales(topKey: KeySignature, chords: ParsedChord[]): ScaleCandidate[] {\n  const list: ScaleMeta[] = [\n    SCALE_DEFS.major,\n    SCALE_DEFS.naturalMinor,\n    SCALE_DEFS.majorPent,\n    SCALE_DEFS.minorPent,\n    SCALE_DEFS.blues,\n    SCALE_DEFS.dorian,\n    SCALE_DEFS.mixolydian,\n    SCALE_DEFS.lydian,\n    SCALE_DEFS.harmonicMinor,\n    SCALE_DEFS.melodicMinor,\n  ];\n  // Build a set of chord roots to approximate note coverage\n  const chordRoots = new Set(chords.map((c) => c.root));\n  const keyTonic = topKey.tonic;\n  const scaleScores = list.map((sm) => {\n    const scaleName =\n      sm.id === \"major\" ? \"Major\" :\n      sm.id === \"naturalMinor\" ? \"Natural Minor\" :\n      sm.id === \"majorPent\" ? \"Major Pentatonic\" :\n      sm.id === \"minorPent\" ? \"Minor Pentatonic\" :\n      sm.id === \"blues\" ? \"Blues\" :\n      sm.id === \"dorian\" ? \"Dorian\" :\n      sm.id === \"mixolydian\" ? \"Mixolydian\" :\n      sm.id === \"lydian\" ? \"Lydian\" :\n      sm.id === \"harmonicMinor\" ? \"Harmonic Minor\" :\n      \"Melodic Minor\";\n    const sc = Scale.get(`${keyTonic} ${scaleName}`);\n    const noteSet = new Set((sc.notes || []).map(normalizeNote));\n    const matches = Array.from(chordRoots).filter((r) => noteSet.has(r)).length;\n    const score = matches / Math.max(1, chordRoots.size);\n    return { scale: sm, score } as ScaleCandidate;\n  });\n  scaleScores.sort((a, b) => b.score - a.score);\n  return scaleScores.slice(0, 5);\n}\n\n// Phase E-5: Compute weights for each chord based on sections\nfunction computeWeights(chordCount: number, opts: AnalyzeOpts): number[] {\n  const W = new Array(chordCount).fill(1.0);\n  const sections = opts.sections || [];\n  \n  const sectionWeights = { ...DEFAULT_SECTION_WEIGHTS, ...(opts.weights?.section ?? {}) };\n  const songHead = opts.weights?.songHead ?? DEFAULT_WEIGHTS.songHead;\n  const songTail = opts.weights?.songTail ?? DEFAULT_WEIGHTS.songTail;\n  const sectionEdge = opts.weights?.sectionEdge ?? DEFAULT_WEIGHTS.sectionEdge;\n  \n  // Apply section weights\n  for (const s of sections) {\n    const repeat = s.repeat ?? 1;\n    const base = (s.weightMul ?? sectionWeights[s.name] ?? 1.0) * Math.sqrt(repeat);\n    \n    for (let i = s.start; i <= s.end && i < chordCount; i++) {\n      W[i] *= base;\n    }\n    \n    // Section edge bonus\n    if (s.start < chordCount) W[s.start] *= sectionEdge;\n    if (s.end < chordCount) W[s.end] *= sectionEdge;\n  }\n  \n  // Song-level head/tail bonus (legacy compatibility)\n  if (chordCount > 0) W[0] *= songHead;\n  if (chordCount > 1) W[chordCount - 1] *= songTail;\n  \n  // Normalize (Σ W = 1)\n  const sumW = W.reduce((a, b) => a + b, 0) || 1;\n  return W.map(w => w / sumW);\n}\n\nexport function analyzeChordProgression(\n  rawTokens: string[],\n  opts: AnalyzeOpts = {}\n): AnalysisResult {\n  const chords = rawTokens\n    .map((t) => t.trim())\n    .filter(Boolean)\n    .map(parseChordToken)\n    .filter((c): c is ParsedChord => !!c);\n\n  // Phase E-5: Compute weights with section awareness\n  const weights = computeWeights(chords.length, opts);\n  \n  const candidates: KeyCandidate[] = [];\n  for (const tonic of ALL_TONICS) {\n    for (const quality of [\"major\", \"minor\"] as const) {\n      const { score, reasons } = scoreForKey(\n        chords,\n        { tonic: tonic as NoteLetter, quality },\n        weights\n      );\n      candidates.push({ key: { tonic: tonic as NoteLetter, quality }, confidence: score, reasons });\n    }\n  }\n  candidates.sort((a, b) => b.confidence - a.confidence);\n  const keyCandidates = candidates.slice(0, 5); // v3.1: 3→5候補に拡張（iOS UI改善）\n  const recommendedScales = recommendScales(keyCandidates[0].key, chords);\n  \n  // Phase E-5: Per-section analysis (optional)\n  let perSection: SectionAnalysis[] | undefined;\n  if (opts.sections && opts.sections.length > 0) {\n    perSection = opts.sections.map(sec => {\n      const slice = rawTokens.slice(sec.start, Math.min(sec.end + 1, rawTokens.length));\n      // Analyze section without section weights (just the chords themselves)\n      const local = analyzeChordProgression(slice, {\n        weights: {\n          songHead: 1.0, // No global position bias for local analysis\n          songTail: 1.0,\n        }\n      });\n      return {\n        section: sec,\n        best: local.keyCandidates[0],\n        ranking: local.keyCandidates\n      };\n    });\n  }\n  \n  return { keyCandidates, recommendedScales, perSection };\n}\n\nexport type DiatonicRequest = {\n  tonic: NoteLetter;\n  quality: \"major\" | \"minor\";\n  scale: \"major\" | \"naturalMinor\";\n};\n\nexport type DiatonicResponse = {\n  chords: string[];\n};\n\nexport function getDiatonicChordsFor(\n  req: DiatonicRequest\n): DiatonicResponse {\n  const key: KeySignature = { tonic: req.tonic, quality: req.quality };\n  const chords = getDiatonicChords(key);\n  return { chords };\n}\n\n\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAAA;AAAA;;AAmDA,MAAM,aAA2B;IAC/B;IAAK;IAAM;IAAK;IAAM;IAAK;IAAK;IAAM;IAAK;IAAM;IAAK;IAAM;CAC7D;AAED,mEAAmE;AACnE,MAAM,0BAAuD;IAC3D,OAAO;IACP,OAAO;IACP,WAAW;IACX,QAAQ;IACR,YAAY;IACZ,QAAQ;IACR,MAAM;IACN,WAAW;IACX,OAAO;IACP,WAAW;IACX,QAAQ;AACV;AAEA,MAAM,kBAAkB;IACtB,UAAU;IACV,UAAU;IACV,aAAa;AACf;AAEA,MAAM,aAAyC;IAC7C,OAAO;QAAE,IAAI;QAAS,MAAM;QAAe,MAAM;IAAO;IACxD,cAAc;QAAE,IAAI;QAAgB,MAAM;QAAuB,MAAM;IAAO;IAC9E,WAAW;QAAE,IAAI;QAAa,MAAM;QAAoB,MAAM;IAAO;IACrE,WAAW;QAAE,IAAI;QAAa,MAAM;QAAoB,MAAM;IAAO;IACrE,OAAO;QAAE,IAAI;QAAS,MAAM;QAAe,MAAM;IAAO;IACxD,QAAQ;QAAE,IAAI;QAAU,MAAM;QAAe,MAAM;IAAM;IACzD,YAAY;QAAE,IAAI;QAAc,MAAM;QAAmB,MAAM;IAAM;IACrE,QAAQ;QAAE,IAAI;QAAU,MAAM;QAAe,MAAM;IAAM;IACzD,eAAe;QAAE,IAAI;QAAiB,MAAM;QAAkB,MAAM;IAAM;IAC1E,cAAc;QAAE,IAAI;QAAgB,MAAM;QAAiB,MAAM;IAAM;AACzE;AASA,SAAS,cAAc,KAAa;IAClC,MAAM,IAAI,2LAAI,CAAC,UAAU,CAAC;IAC1B,OAAO,KAAK;AACd;AAEA,SAAS,gBAAgB,KAAa;IACpC,IAAI,CAAC,OAAO,OAAO;IACnB,oBAAoB;IACpB,MAAM,CAAC,KAAK,GAAG,MAAM,KAAK,CAAC;IAC3B,MAAM,IAAI,KAAK,KAAK,CAAC;IACrB,IAAI,CAAC,GAAG,OAAO;IACf,MAAM,OAAO,cAAc,CAAC,CAAC,CAAC,EAAE,GAAG,CAAC,CAAC,EAAE,EAAE,WAAW;IACpD,MAAM,OAAO,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,WAAW;IACrC,6CAA6C;IAC7C,IAAI,QAA8B;IAClC,IAAI,eAAe,IAAI,CAAC,OAAO,QAAQ;SAClC,IAAI,MAAM,IAAI,CAAC,OAAO,QAAQ;SAC9B,IAAI,oBAAoB,IAAI,CAAC,OAAO,QAAQ;SAC5C,IAAI,UAAU,IAAI,CAAC,OAAO,QAAQ,OAAO,4BAA4B;SACrE,QAAQ;IACb,MAAM,iBAAiB,0BAA0B,IAAI,CAAC,SAAS,IAAI,IAAI,CAAC;IACxE,OAAO;QAAE,KAAK;QAAO;QAAM;QAAO;IAAe;AACnD;AAEA,SAAS,kBAAkB,GAAiB;IAC1C,IAAI,IAAI,OAAO,KAAK,SAAS;QAC3B,MAAM,KAAK,wLAAG,CAAC,QAAQ,CAAC,IAAI,KAAK;QACjC,OAAO,GAAG,MAAM,IAAI,EAAE;IACxB;IACA,MAAM,KAAK,wLAAG,CAAC,QAAQ,CAAC,IAAI,KAAK;IACjC,OAAO,GAAG,OAAO,EAAE,UAAU,GAAG,MAAM,IAAI,EAAE;AAC9C;AAEA,SAAS,gBAAgB,KAAkB,EAAE,QAAkB;IAC7D,MAAM,SAAS,MAAM,IAAI,GAAG,CAAC,MAAM,KAAK,KAAK,QAAQ,KAAK,MAAM,KAAK,KAAK,QAAQ,MAAM,KAAK;IAC7F,OAAO,SAAS,QAAQ,CAAC;AAC3B;AAEA,SAAS,MAAM,IAAY;IACzB,MAAM,IAAI,2LAAI,CAAC,SAAS,CAAC,MAAM;IAC/B,OAAO,cAAc;AACvB;AAEA,SAAS,KAAK,IAAY;IACxB,MAAM,IAAI,2LAAI,CAAC,SAAS,CAAC,MAAM;IAC/B,OAAO,cAAc;AACvB;AAEA,SAAS,oBAAoB,KAAkB,EAAE,GAAiB;IAChE,8GAA8G;IAC9G,MAAM,IAAI,MAAM,IAAI,KAAK;IACzB,MAAM,OAAO,MAAM;IACnB,OAAO,MAAM,IAAI,KAAK,QAAQ,CAAC,MAAM,KAAK,KAAK,SAAS,MAAM,cAAc;AAC9E;AAEA,SAAS,yBAAyB,KAAkB,EAAE,GAAiB;IACrE,IAAI,IAAI,OAAO,KAAK,SAAS,OAAO;IACpC,MAAM,KAAK,wLAAG,CAAC,QAAQ,CAAC,IAAI,KAAK;IACjC,MAAM,QAAQ,GAAG,KAAK,IAAI,EAAE;IAC5B,MAAM,UAAU,KAAK,CAAC,EAAE;IACxB,MAAM,UAAU,KAAK,CAAC,EAAE;IACxB,MAAM,UAAU,UAAU,cAAc,WAAW;IACnD,MAAM,OAAO,UAAU,cAAc,KAAK,YAAY;IACtD,MAAM,YAAY,MAAM,IAAI,KAAK,WAAW,MAAM,KAAK,KAAK;IAC5D,MAAM,OAAO,MAAM,IAAI,KAAK,QAAQ,MAAM,KAAK,KAAK;IACpD,OAAO,CAAC,CAAC,CAAC,aAAa,IAAI;AAC7B;AAEA,SAAS,YACP,MAAqB,EACrB,GAAiB,EACjB,OAAkB;IAElB,MAAM,WAAW,kBAAkB;IACnC,IAAI,UAAoB,EAAE;IAE1B,0EAA0E;IAC1E,MAAM,IAAI,WAAW,OAAO,GAAG,CAAC,CAAC,GAAG,IAAO,MAAM,IAAI,MAAM,MAAM,OAAO,MAAM,GAAG,IAAI,MAAM;IAC3F,MAAM,QAAQ,EAAE,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,GAAG;IAExC,IAAI,MAAM;IACV,OAAO,OAAO,CAAC,CAAC,IAAI;QAClB,MAAM,IAAI,CAAC,CAAC,EAAE;QACd,IAAI,gBAAgB,IAAI,WAAW;YACjC,OAAO,IAAI,KAAK,OAAO;QACzB,OAAO,IAAI,oBAAoB,IAAI,MAAM;YACvC,OAAO,IAAI,KAAK,SAAS;YACzB,QAAQ,IAAI,CAAC,CAAC,8BAA8B,EAAE,GAAG,GAAG,EAAE;QACxD,OAAO,IAAI,yBAAyB,IAAI,MAAM;YAC5C,OAAO,IAAI,KAAK,SAAS;YACzB,QAAQ,IAAI,CAAC,CAAC,0BAA0B,EAAE,GAAG,GAAG,EAAE;QACpD,OAAO;YACL,OAAO,IAAI,KAAK,qCAAqC;QACvD;IACF;IACA,MAAM,aAAa,KAAK,KAAK,CAAC,AAAC,MAAM,QAAS;IAC9C,QAAQ,OAAO,CAAC,GAAG,SAAS,MAAM,CAAC,oBAAoB,EAAE,IAAI,KAAK,CAAC,CAAC,EAAE,IAAI,OAAO,EAAE;IACnF,OAAO;QAAE,OAAO;QAAY;IAAQ;AACtC;AAEA,SAAS,gBAAgB,MAAoB,EAAE,MAAqB;IAClE,MAAM,OAAoB;QACxB,WAAW,KAAK;QAChB,WAAW,YAAY;QACvB,WAAW,SAAS;QACpB,WAAW,SAAS;QACpB,WAAW,KAAK;QAChB,WAAW,MAAM;QACjB,WAAW,UAAU;QACrB,WAAW,MAAM;QACjB,WAAW,aAAa;QACxB,WAAW,YAAY;KACxB;IACD,0DAA0D;IAC1D,MAAM,aAAa,IAAI,IAAI,OAAO,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI;IACnD,MAAM,WAAW,OAAO,KAAK;IAC7B,MAAM,cAAc,KAAK,GAAG,CAAC,CAAC;QAC5B,MAAM,YACJ,GAAG,EAAE,KAAK,UAAU,UACpB,GAAG,EAAE,KAAK,iBAAiB,kBAC3B,GAAG,EAAE,KAAK,cAAc,qBACxB,GAAG,EAAE,KAAK,cAAc,qBACxB,GAAG,EAAE,KAAK,UAAU,UACpB,GAAG,EAAE,KAAK,WAAW,WACrB,GAAG,EAAE,KAAK,eAAe,eACzB,GAAG,EAAE,KAAK,WAAW,WACrB,GAAG,EAAE,KAAK,kBAAkB,mBAC5B;QACF,MAAM,KAAK,8LAAK,CAAC,GAAG,CAAC,GAAG,SAAS,CAAC,EAAE,WAAW;QAC/C,MAAM,UAAU,IAAI,IAAI,CAAC,GAAG,KAAK,IAAI,EAAE,EAAE,GAAG,CAAC;QAC7C,MAAM,UAAU,MAAM,IAAI,CAAC,YAAY,MAAM,CAAC,CAAC,IAAM,QAAQ,GAAG,CAAC,IAAI,MAAM;QAC3E,MAAM,QAAQ,UAAU,KAAK,GAAG,CAAC,GAAG,WAAW,IAAI;QACnD,OAAO;YAAE,OAAO;YAAI;QAAM;IAC5B;IACA,YAAY,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;IAC5C,OAAO,YAAY,KAAK,CAAC,GAAG;AAC9B;AAEA,8DAA8D;AAC9D,SAAS,eAAe,UAAkB,EAAE,IAAiB;IAC3D,MAAM,IAAI,IAAI,MAAM,YAAY,IAAI,CAAC;IACrC,MAAM,WAAW,KAAK,QAAQ,IAAI,EAAE;IAEpC,MAAM,iBAAiB;QAAE,GAAG,uBAAuB;QAAE,GAAI,KAAK,OAAO,EAAE,WAAW,CAAC,CAAC;IAAE;IACtF,MAAM,WAAW,KAAK,OAAO,EAAE,YAAY,gBAAgB,QAAQ;IACnE,MAAM,WAAW,KAAK,OAAO,EAAE,YAAY,gBAAgB,QAAQ;IACnE,MAAM,cAAc,KAAK,OAAO,EAAE,eAAe,gBAAgB,WAAW;IAE5E,wBAAwB;IACxB,KAAK,MAAM,KAAK,SAAU;QACxB,MAAM,SAAS,EAAE,MAAM,IAAI;QAC3B,MAAM,OAAO,CAAC,EAAE,SAAS,IAAI,cAAc,CAAC,EAAE,IAAI,CAAC,IAAI,GAAG,IAAI,KAAK,IAAI,CAAC;QAExE,IAAK,IAAI,IAAI,EAAE,KAAK,EAAE,KAAK,EAAE,GAAG,IAAI,IAAI,YAAY,IAAK;YACvD,CAAC,CAAC,EAAE,IAAI;QACV;QAEA,qBAAqB;QACrB,IAAI,EAAE,KAAK,GAAG,YAAY,CAAC,CAAC,EAAE,KAAK,CAAC,IAAI;QACxC,IAAI,EAAE,GAAG,GAAG,YAAY,CAAC,CAAC,EAAE,GAAG,CAAC,IAAI;IACtC;IAEA,oDAAoD;IACpD,IAAI,aAAa,GAAG,CAAC,CAAC,EAAE,IAAI;IAC5B,IAAI,aAAa,GAAG,CAAC,CAAC,aAAa,EAAE,IAAI;IAEzC,sBAAsB;IACtB,MAAM,OAAO,EAAE,MAAM,CAAC,CAAC,GAAG,IAAM,IAAI,GAAG,MAAM;IAC7C,OAAO,EAAE,GAAG,CAAC,CAAA,IAAK,IAAI;AACxB;AAEO,SAAS,wBACd,SAAmB,EACnB,OAAoB,CAAC,CAAC;IAEtB,MAAM,SAAS,UACZ,GAAG,CAAC,CAAC,IAAM,EAAE,IAAI,IACjB,MAAM,CAAC,SACP,GAAG,CAAC,iBACJ,MAAM,CAAC,CAAC,IAAwB,CAAC,CAAC;IAErC,oDAAoD;IACpD,MAAM,UAAU,eAAe,OAAO,MAAM,EAAE;IAE9C,MAAM,aAA6B,EAAE;IACrC,KAAK,MAAM,SAAS,WAAY;QAC9B,KAAK,MAAM,WAAW;YAAC;YAAS;SAAQ,CAAW;YACjD,MAAM,EAAE,KAAK,EAAE,OAAO,EAAE,GAAG,YACzB,QACA;gBAAE,OAAO;gBAAqB;YAAQ,GACtC;YAEF,WAAW,IAAI,CAAC;gBAAE,KAAK;oBAAE,OAAO;oBAAqB;gBAAQ;gBAAG,YAAY;gBAAO;YAAQ;QAC7F;IACF;IACA,WAAW,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,UAAU,GAAG,EAAE,UAAU;IACrD,MAAM,gBAAgB,WAAW,KAAK,CAAC,GAAG,IAAI,2BAA2B;IACzE,MAAM,oBAAoB,gBAAgB,aAAa,CAAC,EAAE,CAAC,GAAG,EAAE;IAEhE,6CAA6C;IAC7C,IAAI;IACJ,IAAI,KAAK,QAAQ,IAAI,KAAK,QAAQ,CAAC,MAAM,GAAG,GAAG;QAC7C,aAAa,KAAK,QAAQ,CAAC,GAAG,CAAC,CAAA;YAC7B,MAAM,QAAQ,UAAU,KAAK,CAAC,IAAI,KAAK,EAAE,KAAK,GAAG,CAAC,IAAI,GAAG,GAAG,GAAG,UAAU,MAAM;YAC/E,uEAAuE;YACvE,MAAM,QAAQ,wBAAwB,OAAO;gBAC3C,SAAS;oBACP,UAAU;oBACV,UAAU;gBACZ;YACF;YACA,OAAO;gBACL,SAAS;gBACT,MAAM,MAAM,aAAa,CAAC,EAAE;gBAC5B,SAAS,MAAM,aAAa;YAC9B;QACF;IACF;IAEA,OAAO;QAAE;QAAe;QAAmB;IAAW;AACxD;AAYO,SAAS,qBACd,GAAoB;IAEpB,MAAM,MAAoB;QAAE,OAAO,IAAI,KAAK;QAAE,SAAS,IAAI,OAAO;IAAC;IACnE,MAAM,SAAS,kBAAkB;IACjC,OAAO;QAAE;IAAO;AAClB","debugId":null}},
    {"offset": {"line": 395, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/scaleCatalog.ts"],"sourcesContent":["// Single Source of Truth for scale catalog (English-first)\n\nexport type DegreeToken =\n  | '1' | 'b2' | '2' | 'b3' | '3' | '4' | '#4' | 'b5' | '5' | '#5' | 'b6' | '6' | 'bb7' | 'b7' | '7';\n\nexport type ScaleId =\n  | 'Ionian' | 'Dorian' | 'Phrygian' | 'Lydian' | 'Mixolydian' | 'Aeolian' | 'Locrian'\n  | 'MajorPentatonic' | 'MinorPentatonic' | 'Blues'\n  | 'HarmonicMinor' | 'MelodicMinor' | 'Dorianb2'\n  | 'DiminishedWholeHalf' | 'DiminishedHalfWhole';\n\nexport type ScaleCatalogItem = {\n  id: ScaleId;\n  display: { en: string; ja?: string };\n  degrees: DegreeToken[];\n  group: 'Diatonic' | 'Pentatonic' | 'Minor' | 'Other';\n  info?: {\n    oneLiner?: string;\n    examples?: Array<{ title: string; artist: string; url?: string; cue?: string }>;\n  };\n  enabled?: boolean; // future feature flag (defaults true)\n};\n\n// NOTE: These entries follow common definitions. Please align with Excel (EN) if it differs.\nexport const SCALE_CATALOG: ScaleCatalogItem[] = [\n  // Use English names per Excel (avoid modal names for major/minor)\n  { id: 'Ionian', display: { en: 'Major Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','4','5','6','7'],\n    info: { oneLiner: 'Major scale; bright and stable.',\n      examples: [\n        { title: 'Let It Be', artist: 'The Beatles' },\n        { title: 'Do-Re-Mi', artist: 'Richard Rodgers' }\n      ] } },\n  { id: 'Dorian', display: { en: 'Dorian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','b3','4','5','6','b7'],\n    info: { oneLiner: 'Minor with a natural 6th; cool, modal colour.',\n      examples: [\n        { title: 'So What', artist: 'Miles Davis' }\n      ] } },\n  { id: 'Phrygian', display: { en: 'Phrygian Scale' }, group: 'Diatonic',\n    degrees: ['1','b2','b3','4','5','b6','b7'],\n    info: { oneLiner: 'Dark, Spanish/Arabic flavour with flat 2.' } },\n  { id: 'Lydian', display: { en: 'Lydian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','#4','5','6','7'],\n    info: { oneLiner: 'Dreamy major with raised 4th (♯4).',\n      examples: [ { title: 'The Simpsons Theme', artist: 'Danny Elfman' } ] } },\n  { id: 'Mixolydian', display: { en: 'Mixolydian Scale' }, group: 'Diatonic',\n    degrees: ['1','2','3','4','5','6','b7'],\n    info: { oneLiner: 'Major with flat 7; dominant, bluesy feel.',\n      examples: [\n        { title: 'Sweet Home Alabama', artist: 'Lynyrd Skynyrd' }\n      ] } },\n  { id: 'Aeolian', display: { en: 'Natural Minor Scale' }, group: 'Diatonic',\n    degrees: ['1','2','b3','4','5','b6','b7'],\n    info: { oneLiner: 'Natural minor; sad or moody colour.',\n      examples: [ { title: 'House of the Rising Sun', artist: 'Traditional' } ] } },\n  { id: 'Locrian', display: { en: 'Locrian Scale' }, group: 'Diatonic',\n    degrees: ['1','b2','b3','4','b5','b6','b7'],\n    info: { oneLiner: 'Diminished 5th; unstable, rarely used as a key.' } },\n\n  { id: 'MajorPentatonic', display: { en: 'Major Pentatonic' }, group: 'Pentatonic',\n    degrees: ['1','2','3','5','6'],\n    info: { oneLiner: 'Five-note, open and melodic; fits many chords.',\n      examples: [ { title: 'My Girl', artist: 'The Temptations' } ] } },\n  { id: 'MinorPentatonic', display: { en: 'Minor Pentatonic' }, group: 'Pentatonic',\n    degrees: ['1','b3','4','5','b7'],\n    info: { oneLiner: 'Five-note minor staple for rock/blues solos.',\n      examples: [ { title: 'Purple Haze', artist: 'Jimi Hendrix' } ] } },\n  { id: 'Blues', display: { en: 'Blues Scale (minor)' }, group: 'Pentatonic',\n    degrees: ['1','b3','4','b5','5','b7'],\n    info: { oneLiner: 'Minor pentatonic plus blue note (♭5).',\n      examples: [ { title: 'Smoke on the Water', artist: 'Deep Purple' } ] } },\n\n  { id: 'HarmonicMinor', display: { en: 'Harmonic Minor' }, group: 'Minor',\n    degrees: ['1','2','b3','4','5','b6','7'],\n    info: { oneLiner: 'Minor with raised 7th; exotic dominant pull.',\n      examples: [ { title: 'Misirlou', artist: 'Traditional' } ] } },\n  { id: 'MelodicMinor', display: { en: 'Melodic Minor Scale' }, group: 'Minor',\n    degrees: ['1','2','b3','4','5','6','7'],\n    info: { oneLiner: 'Jazz minor (ascending); smooth minor/major blend.' } },\n\n  // Diminished scales (symmetric) — added per Excel list\n  { id: 'DiminishedWholeHalf', display: { en: 'Diminished Scale (Whole–Half)' }, group: 'Other',\n    degrees: ['1','2','b3','4','b5','b6','6','7'],\n    info: { oneLiner: 'Symmetric 8-note (whole–half) scale; over dim7.' } },\n  { id: 'DiminishedHalfWhole', display: { en: 'Diminished Scale (Half–Whole)' }, group: 'Other',\n    degrees: ['1','b2','b3','3','#4','5','6','b7'],\n    info: { oneLiner: 'Symmetric 8-note (half–whole); over 7♭9 chords.' } },\n];\n\n// Dev helper: expose catalog for quick inspection in console (no filtering)\nif (typeof window !== 'undefined') {\n  (window as any).__SCALES_EN__ = SCALE_CATALOG;\n}\n\n\n// Build 12-bit mask from degree tokens (C-root relative)\nexport function getScaleMask12(id: ScaleId): number[] {\n  const item = SCALE_CATALOG.find(s => s.id === id);\n  if (!item) return Array(12).fill(0);\n  const DEGREE_TO_SEMITONE: Record<DegreeToken, number> = {\n    '1': 0, 'b2': 1, '2': 2, 'b3': 3, '3': 4, '4': 5, '#4': 6, 'b5': 6, '5': 7, '#5': 8, 'b6': 8, '6': 9, 'bb7': 9, 'b7': 10, '7': 11\n  };\n  const mask = Array(12).fill(0);\n  for (const d of item.degrees) {\n    const s = DEGREE_TO_SEMITONE[d];\n    if (typeof s === 'number') mask[(s + 120) % 12] = 1;\n  }\n  return mask;\n}\n\nexport function listScales(): { id: ScaleId; label: string }[] {\n  return SCALE_CATALOG.map(s => ({ id: s.id, label: s.display.en }));\n}\n\n// 非ヘプタ判定とPent/Blues例外のヘルパー関数\nexport const isHeptatonic = (scaleId: string): boolean => {\n  const item = SCALE_CATALOG.find(s => s.id === scaleId as ScaleId);\n  return item ? item.degrees.length === 7 : false;\n};\n\nexport const isPentOrBlues = (scaleId: string): boolean => {\n  return scaleId === 'MajorPentatonic' || scaleId === 'MinorPentatonic' || scaleId === 'Blues';\n};\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 780, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/scales.ts"],"sourcesContent":["export type Pc = number; // 0..11\nimport { SCALE_CATALOG, type DegreeToken, type ScaleId as CatalogScaleId } from './scaleCatalog';\n\nexport type ScaleType =\n  | 'Ionian'\n  | 'Dorian'\n  | 'Phrygian'\n  | 'Lydian'\n  | 'Mixolydian'\n  | 'Aeolian'\n  | 'Locrian'\n  | 'HarmonicMinor'\n  | 'MelodicMinor'\n  | 'MajorPentatonic'\n  | 'MinorPentatonic'\n  | 'Blues'\n  | 'DiminishedWholeHalf'\n  | 'DiminishedHalfWhole';\n\nexport const SCALE_INTERVALS: Record<ScaleType, number[]> = {\n  Ionian:          [0,2,4,5,7,9,11],\n  Dorian:          [0,2,3,5,7,9,10],\n  Phrygian:        [0,1,3,5,7,8,10],\n  Lydian:          [0,2,4,6,7,9,11],\n  Mixolydian:      [0,2,4,5,7,9,10],\n  Aeolian:         [0,2,3,5,7,8,10],\n  Locrian:         [0,1,3,5,6,8,10],\n  HarmonicMinor:   [0,2,3,5,7,8,11],\n  MelodicMinor:    [0,2,3,5,7,9,11],\n  MajorPentatonic: [0,2,4,7,9],\n  MinorPentatonic: [0,3,5,7,10],\n  Blues:           [0,3,5,6,7,10],\n  DiminishedWholeHalf: [0,2,3,5,6,8,9,11],\n  DiminishedHalfWhole: [0,1,3,4,6,7,9,10],\n};\n\nexport type ScaleId = CatalogScaleId;\n\nexport function getScalePitches(root: Pc, type: ScaleId): Pc[] {\n  // Prefer catalog-driven calculation when possible\n  try {\n    return getScalePitchesById(root, type as unknown as CatalogScaleId);\n  } catch {}\n  const ints = SCALE_INTERVALS[type as unknown as ScaleType];\n  if (!ints || ints.length === 0) {\n    throw new Error(`Unknown scale id: ${String(type)}`);\n  }\n  return ints.map((iv) => (root + iv + 120) % 12);\n}\n\n// エイリアス→正規IDの正規化関数\nexport function normalizeScaleId(id: string): string {\n  const aliases: Record<string, string> = { Major: 'Ionian', Minor: 'Aeolian' };\n  const key = String(id);\n  return aliases[key] ?? aliases[key[0].toUpperCase()+key.slice(1)] ?? id;\n}\n\nexport function scaleTypeLabel(t: ScaleId | ScaleType): string {\n  // エイリアス吸収（防御的）\n  const aliasToId: Record<string, ScaleType> = { Major: 'Ionian', Minor: 'Aeolian' };\n  const id = (aliasToId[t as string] ?? t) as ScaleType;\n  \n  const map: Record<ScaleType,string> = {\n    Ionian: 'Major Scale',\n    Dorian: 'Dorian',\n    Phrygian: 'Phrygian',\n    Lydian: 'Lydian',\n    Mixolydian: 'Mixolydian',\n    Aeolian: 'Natural Minor',\n    Locrian: 'Locrian',\n    HarmonicMinor: 'Harmonic Minor',\n    MelodicMinor: 'Melodic Minor',\n    MajorPentatonic: 'Major Pentatonic',\n    MinorPentatonic: 'Minor Pentatonic',\n  };\n  // Mapを既定とし、未定義はカタログのdisplay.enを利用\n  const short = map[id];\n  if (short) return short;\n  const cat = SCALE_CATALOG.find(s => s.id === (id as any));\n  return (cat?.display.en || String(id)).replace(/\\s*\\(.*\\)$/,'');\n}\n\n// === Degree labels (with accidentals) per scale type ===\nexport const DEGREE_LABELS: Record<ScaleType, string[]> = {\n  Ionian:          [\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\"],\n  Dorian:          [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"6\",\"♭7\"],\n  Phrygian:        [\"1\",\"♭2\",\"♭3\",\"4\",\"5\",\"♭6\",\"♭7\"],\n  Lydian:          [\"1\",\"2\",\"3\",\"♯4\",\"5\",\"6\",\"7\"],\n  Mixolydian:      [\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"♭7\"],\n  Aeolian:         [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"♭6\",\"♭7\"],\n  Locrian:         [\"1\",\"♭2\",\"♭3\",\"4\",\"♭5\",\"♭6\",\"♭7\"],\n  HarmonicMinor:   [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"♭6\",\"7\"],\n  MelodicMinor:    [\"1\",\"2\",\"♭3\",\"4\",\"5\",\"6\",\"7\"],\n  MajorPentatonic: [\"1\",\"2\",\"3\",\"5\",\"6\"],\n  MinorPentatonic: [\"1\",\"♭3\",\"4\",\"5\",\"♭7\"],\n  Blues:           [\"1\",\"♭3\",\"4\",\"♭5\",\"5\",\"♭7\"],\n};\n\n// pc to degree label for given scale; returns null if pc not in scale\nexport function degreeLabelFor(pc: Pc, root: Pc, type: ScaleId | ScaleType): string | null {\n  const iv = (pc - root + 120) % 12;\n  // Prefer catalog degrees → semitone offsets\n  const cat = SCALE_CATALOG.find(s => s.id === (type as any));\n  const ivs = (cat ? cat.degrees.map(d => DEGREE_TO_SEMITONE[d]) : undefined)\n    ?? (SCALE_INTERVALS[type as ScaleType] ?? []);\n  const idx = ivs.indexOf(iv);\n  if (idx === -1) return null;\n  const labels = (cat?.degrees as string[] | undefined)\n    ?? (DEGREE_LABELS[type as ScaleType] ?? undefined);\n  if (!labels) return null;\n  return labels[idx] ?? null;\n}\n\n// Convert a degree token like \"1\", \"b2\", \"#4\", \"♭3\" to Roman form (R, II, ♯IV, ♭III, etc.)\nfunction degreeTokenToRoman(token: string): string {\n  const t = token.replace(/\\s+/g, '')\n    .replace(/bb/g, '♭♭')\n    .replace(/b/g, '♭')\n    .replace(/##/g, '♯♯')\n    .replace(/#/g, '♯');\n  // Extract accidentals and number\n  const m = t.match(/^(♭|♯|♭♭|♯♯)?(\\d)$/);\n  if (!m) {\n    // fallback: if already has Roman-like content, return as is\n    return t;\n  }\n  const acc = m[1] ?? '';\n  const n = m[2];\n  const romanBase: Record<string,string> = {\n    '1': 'R',\n    '2': 'II',\n    '3': 'III',\n    '4': 'IV',\n    '5': 'V',\n    '6': 'VI',\n    '7': 'VII',\n  };\n  const base = romanBase[n] ?? n;\n  return `${acc}${base}`;\n}\n\n// Roman degree label for a pitch class in a given scale (uses catalog degrees when available)\nexport function degreeRomanFor(pc: Pc, root: Pc, type: ScaleId | ScaleType): string | null {\n  const iv = (pc - root + 120) % 12;\n  const cat = SCALE_CATALOG.find(s => s.id === (type as any));\n  const ivs = (cat ? cat.degrees.map(d => DEGREE_TO_SEMITONE[d]) : undefined)\n    ?? (SCALE_INTERVALS[type as ScaleType] ?? []);\n  const idx = ivs.indexOf(iv);\n  if (idx === -1) return null;\n  const labels = (cat?.degrees as string[] | undefined)\n    ?? (DEGREE_LABELS[type as ScaleType] ?? undefined);\n  if (!labels) return null;\n  const token = labels[idx] ?? '';\n  return degreeTokenToRoman(token);\n}\n\n// Parent mode mapping (e.g., pentatonic → its diatonic parent)\nexport function parentModeOf(t: ScaleId | ScaleType): ScaleType | null {\n  switch (t) {\n    case 'MajorPentatonic':\n      return 'Ionian';\n    case 'MinorPentatonic':\n      return 'Aeolian';\n    default:\n      return null;\n  }\n}\n\n\n// === Roman degree labels per scale type (vs Ionian baseline) ===\nconst IONIAN_INTERVALS = [0,2,4,5,7,9,11];\nconst ROMAN_BASE = ['I','II','III','IV','V','VI','VII'] as const;\n\nexport function romanDegreeLabelsForScale(scaleType: ScaleType): string[] {\n  const ints = SCALE_INTERVALS[scaleType];\n  // Fallback for non-7-note scales\n  if (!ints || ints.length !== 7) return [...ROMAN_BASE];\n  return ints.map((semi, i) => {\n    const base = ROMAN_BASE[i];\n    const diff = semi - IONIAN_INTERVALS[i];\n    if (diff === 0) return base;\n    if (diff > 0) return '#'.repeat(diff) + base;\n    return 'b'.repeat(-diff) + base;\n  });\n}\n\n// === Catalog-driven semitone mapping and API (SSOT; supports 5/7/8 notes) ===\nexport const DEGREE_TO_SEMITONE: Record<DegreeToken, number> = {\n  '1': 0,\n  'b2': 1,\n  '2': 2,\n  'b3': 3,\n  '3': 4,\n  '4': 5,\n  '#4': 6,\n  'b5': 6,\n  '5': 7,\n  '#5': 8,\n  'b6': 8,\n  '6': 9,\n  'bb7': 9,\n  'b7': 10,\n  '7': 11,\n};\n\nexport function getScalePitchesById(rootPc: number, id: CatalogScaleId): number[] {\n  const s = SCALE_CATALOG.find(x => x.id === id);\n  if (!s) throw new Error(`Scale not found in catalog: ${String(id)}`);\n  return s.degrees.map(d => (rootPc + DEGREE_TO_SEMITONE[d] + 120) % 12);\n}\n\n// Dev helper: expose minimal API for console checks\nif (typeof window !== 'undefined') {\n  (window as any).__SCALES_API__ = {\n    getScalePitchesById,\n  };\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1198, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/Fretboard.tsx"],"sourcesContent":["\"use client\";\nimport React, { useEffect, useRef, useState } from \"react\";\nimport { SCALE_CATALOG } from \"@/lib/scaleCatalog\";\nimport { degreeLabelFor, degreeRomanFor, getScalePitches, type ScaleType } from \"@/lib/scales\";\nimport { player } from \"@/lib/audio/player\";\nimport type { FormShape, Quality } from \"@/lib/chordForms\";\nconst PITCHES12 = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'] as const;\n\ntype FretboardProps = {\n  strings?: string[]; // high -> low\n  frets?: number;\n  dotPositions?: number[];\n  overlay?: { display: 'degrees'|'names'; viewMode?: 'sounding'; capo: number; notes?: string[]; chordNotes?: string[]; showScaleGhost?: boolean; scaleRootPc?: number; scaleType?: ScaleType; context?: { chordRootPc?: number; quality?: Quality } } | null;\n  onRequestForms?: (at:{x:number;y:number}, ctx:{rootPc:number; quality: Quality})=>void;\n  formShape?: FormShape | null;\n};\n\n// --- Dot visuals (shared for Degrees/Names) ---\nconst DOT_PX_DESKTOP = 26;\nconst DOT_PX_MOBILE = 24;\nconst FONT_PX_DESKTOP = 14;\nconst FONT_PX_MOBILE = 13;\n// Original palette（page base: show degree colours）\nconst COLOR_ROOT   = \"hsl(355 80% 60% / .95)\"; // root\nconst COLOR_DEG3   = \"hsl(205 90% 56% / .90)\"; // 3rd\nconst COLOR_DEG5   = \"hsl(150 65% 45% / .90)\"; // 5th\nconst COLOR_DEG7   = \"hsl(48 95% 55% / .92)\";  // 7th\n// Preview palette（suggested-scale overlay: chord vs others）\nconst COLOR_CHORD  = \"hsl(0 85% 55% / .95)\";   // chord tones (red)\nconst COLOR_SCALE  = \"hsl(210 10% 72% / .70)\"; // non-chord scale tones (gray)\nconst COLOR_OUT    = \"hsl(210 6% 38% / .30)\";\nconst COLOR_GHOST  = \"hsl(210 12% 58% / .60)\"; // unified ghost color (darker)\nconst LABEL_COLOR = \"#0b0b0b\";\n\nconst dotStyle = (bg: string, isMobile: boolean): React.CSSProperties => {\n  const size = isMobile ? DOT_PX_MOBILE : DOT_PX_DESKTOP;\n  return {\n    width: size,\n    height: size,\n    borderRadius: size,\n    background: bg,\n    color: LABEL_COLOR,\n    fontWeight: 700,\n    fontSize: isMobile ? FONT_PX_MOBILE : FONT_PX_DESKTOP,\n    display: 'flex',\n    alignItems: 'center',\n    justifyContent: 'center',\n    transform: 'translate(-50%, -50%)',\n    textShadow: '0 0 1px rgba(0,0,0,.55)',\n    WebkitTextStroke: '0.3px rgba(255,255,255,.35)',\n    userSelect: 'none',\n  };\n};\n\nfunction colorForDegreeLabel(preview: boolean, lbl: string | null, isChordTone: boolean, isInScale: boolean, isRoot: boolean) {\n  if (!isInScale) return COLOR_OUT;\n  if (preview) {\n    return isChordTone ? COLOR_CHORD : COLOR_SCALE;\n  }\n  if (isRoot) return COLOR_ROOT;\n  if (!lbl) return COLOR_SCALE;\n  const l = lbl.replace(/\\s/g, \"\");\n  if (l.includes(\"3\")) return COLOR_DEG3;\n  if (l.includes(\"5\")) return COLOR_DEG5;\n  if (l.includes(\"7\")) return COLOR_DEG7;\n  return COLOR_SCALE;\n}\n\nfunction ghostFromBaseColor(base: string, alpha = 0.85): string {\n  try {\n    if (base.includes('/')) {\n      return base.replace(/\\/(.*?)\\)/, `/ ${alpha})`);\n    }\n    if (base.endsWith(')')) return base.replace(/\\)$/, ` / ${alpha})`);\n  } catch {}\n  return base;\n}\n\nexport default function Fretboard({\n  strings = ['E','B','G','D','A','E'],\n  frets = 15,\n  dotPositions: _dotPositions = [3,5,7,9,12,15],\n  overlay = null,\n  onRequestForms,\n  formShape = null,\n}: FretboardProps) {\n  const wrapRef = useRef<HTMLDivElement | null>(null);\n  // SSRと初回クライアント描画の一致を保つため、初期値はfalse（デスクトップ想定）\n  const [isMobile, setIsMobile] = useState(false);\n  const [pressedCell, setPressedCell] = useState<{ r: number; c: number; ver: number } | null>(null);\n  useEffect(() => {\n    const update = () => {\n      try { setIsMobile(window.innerWidth < 380); } catch { /* noop */ }\n    };\n    update();\n    window.addEventListener('resize', update);\n    return () => window.removeEventListener('resize', update);\n  }, []);\n  // ScaleとChordを統合したoverlayオブジェクトを作成\n  // 親から `overlay` が渡されている場合はそれを最優先（Find Key などの初期表示用）\n  const overlayEff = overlay ?? null;\n  // Layout constants\n  const LEFT_GUTTER = 44;   // px  // compact gutter (reduced)\n  const SPACE_W = 28;       // px  // standard fret min width\n  const ROW_H = 28;         // px\n  const TOP_BAR_H = 32;     // px\n  const OPEN_GAP = 20;      // px additional gap for open column (increased by +8px)\n  const ZERO_COL_W = SPACE_W + OPEN_GAP; // widened open column\n  const COLS = (f: number) => `${ZERO_COL_W}px repeat(${f}, minmax(${SPACE_W}px, 1fr))`;\n  const NUT_WIDTH = 3;      // px\n\n  // --- Chord label long-press (for mouse/touch on the label only) ---\n  const PRESS_MS = 400;\n  const pressTimer = useRef<number | null>(null);\n  const endPress = () => { if (pressTimer.current!==null){ clearTimeout(pressTimer.current); pressTimer.current=null; } };\n  const startPress = (e: React.PointerEvent, ctx:{rootPc:number; quality:Quality}) => {\n    if (!onRequestForms) return;\n    // マウスの長押しは不要だが、統一して実装\n    endPress();\n    pressTimer.current = window.setTimeout(()=>{\n      onRequestForms({ x:e.clientX, y:e.clientY }, ctx);\n    }, PRESS_MS);\n  };\n\n  useEffect(() => {}, [frets, strings.length]);\n  return (\n    <div className=\"rounded-lg border p-3 overflow-x-auto ot-fretboard ot-fb-compact\">\n      <div className=\"min-w-[640px]\">\n        <div ref={wrapRef} className=\"relative\" style={{ height: TOP_BAR_H + strings.length * ROW_H + 16 }}>\n          {/* nut line is rendered inside grid below */}\n          {/* Fret numbers top bar */}\n          <div\n            className=\"pointer-events-none absolute top-1 grid text-[12px] md:text-sm text-foreground/80\"\n            style={{\n              gridTemplateColumns: COLS(frets),\n              height: TOP_BAR_H,\n              left: LEFT_GUTTER,\n              right: 0,\n            }}\n          >\n            {Array.from({ length: frets+1 }).map((_, col) => {\n              const show = [0,1,3,5,7,9,12,15].includes(col);\n              if (!show) return <div key={col} />;\n              return (\n                <div key={col} className=\"flex items-start justify-center\">\n                  <span className=\"inline-block px-1 rounded bg-background/80\">{col}</span>\n                </div>\n              );\n            })}\n          </div>\n          {/* chord forms UI removed per spec */}\n          {/* Left tuning labels (E B G D A E) */}\n          <div\n            className=\"absolute select-none\"\n            style={{\n              left: 0,\n              top: TOP_BAR_H,\n              width: LEFT_GUTTER,\n              height: strings.length * ROW_H,\n              display: 'grid',\n              gridTemplateRows: `repeat(${strings.length}, ${ROW_H}px)`,\n            }}\n            aria-hidden=\"true\"\n          >\n            {strings.map((s, i) => (\n              <div key={`lbl-${i}`} className=\"flex items-center justify-center text-xs md:text-sm leading-none text-muted-foreground\">\n                {s}\n              </div>\n            ))}\n          </div>\n            <div className=\"absolute right-0 bottom-0 grid\" style={{ top: TOP_BAR_H, left: LEFT_GUTTER, width: `calc(100% - ${LEFT_GUTTER}px)`, gridTemplateColumns: COLS(frets), gridTemplateRows: `repeat(${strings.length}, ${ROW_H}px)` }}>\n            {strings.map((s, rowIdx) => (\n              <React.Fragment key={`row-${rowIdx}`}>\n                {/* Open space cell */}\n                <div className=\"relative\" key={`open-${rowIdx}`}>{renderOpenMarker({ overlay: overlayEff, strings, rowIdx, isMobile })}</div>\n                {Array.from({ length: frets }).map((_, colIdx) => (\n                  <div\n                    key={`c-${rowIdx}-${colIdx}`}\n                    className={`relative ${colIdx===0 ? 'border-l border-transparent' : 'border-l border-black/10 dark:border-white/10'} ${pressedCell && pressedCell.r===rowIdx && pressedCell.c===colIdx ? 'fb-pressed' : ''} cursor-pointer select-none`}\n                    onClick={async()=>{\n                      // 空白やゴースト領域でもタップで単音を軽く試聴\n                      const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40];\n                      const baseMidi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n                      const midi = baseMidi + (colIdx + 1);\n                      // 短い押下エフェクト\n                      setPressedCell(prev => ({ r: rowIdx, c: colIdx, ver: (prev?.ver ?? 0) + 1 }));\n                      const localVer = (pressedCell?.ver ?? 0) + 1;\n                      window.setTimeout(() => {\n                        setPressedCell(cur => (cur && cur.r===rowIdx && cur.c===colIdx && cur.ver===localVer) ? null : cur);\n                      }, 180);\n                      try { await player.resume(); player.playNote(midi, 240); } catch {}\n                    }}\n                  >\n                    {renderMarker({ overlay: overlayEff, strings, rowIdx, colIdx, isMobile })}\n                  </div>\n                ))}\n              </React.Fragment>\n            ))}\n            {/* Nut line (between 0 and 1) */}\n            <div\n              aria-hidden\n              className=\"absolute pointer-events-none z-[20] bg-black/60 dark:bg-white/70\"\n              style={{\n                left: ZERO_COL_W - NUT_WIDTH / 2,\n                top: 0,\n                bottom: 0,\n                width: NUT_WIDTH,\n                borderRadius: 2,\n              }}\n            />\n          </div>\n        </div>\n      </div>\n      {formShape && renderFormOverlay({ formShape, LEFT_GUTTER, TOP_BAR_H, SPACE_W, ROW_H })}\n    </div>\n  );\n}\n\nconst pitchIndexMap: Record<string, number> = {\n  C: 0, \"C#\": 1, Db: 1, D: 2, \"D#\": 3, Eb: 3, E: 4, F: 5, \"F#\": 6, Gb: 6,\n  G: 7, \"G#\": 8, Ab: 8, A: 9, \"A#\": 10, Bb: 10, B: 11,\n};\nconst pitchIndex = (note: string): number => pitchIndexMap[note] ?? 0;\n// Fallback degree label map (chromatic → degree text)\nfunction fallbackDegreeLabel(notePc: number, rootPc: number): string {\n  const d = (notePc - rootPc + 12) % 12;\n  const arr = [\"1\",\"b2\",\"2\",\"b3\",\"3\",\"4\",\"#4\",\"5\",\"b6\",\"6\",\"b7\",\"7\"] as const;\n  return arr[d];\n}\n\nfunction renderMarker({ overlay, strings, rowIdx, colIdx, isMobile }:{ overlay: FretboardProps['overlay']; strings: string[]; rowIdx: number; colIdx: number; isMobile: boolean; }){\n  if (!overlay) return null;\n  const chordNotes = overlay.chordNotes ?? overlay.notes ?? [];\n  const hasChord = (chordNotes?.length ?? 0) > 0;\n  const chordRootIdx = hasChord ? pitchIndex(chordNotes[0] ?? \"C\") : 0;\n  const set = new Set((chordNotes || []).map((note) => pitchIndex(note ?? \"C\")));\n  const openPc = pitchIndex(strings[rowIdx] ?? \"E\");\n  // Shaped: treat capo as new nut → subtract capo semitones\n  // column index 0 represents fret 1 (fret 0 = open is not drawn as a column)\n  const fretN = colIdx + 1;\n  const spc = (openPc + fretN) % 12; // shapedは廃止・常にsounding\n  // 実音のMIDI（弦の実チューニング＋フレット数）\n  const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40]; // E4, B3, G3, D3, A2, E2 (high -> low)\n  const baseMidi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n  const midi = baseMidi + fretN;\n  // scale-aware style & label\n  const scaleRoot = overlay.scaleRootPc;\n  const scaleType = overlay.scaleType;\n  const inScale = ((): boolean => {\n    if (typeof scaleRoot !== 'number' || !scaleType) return true;\n    const iv = (spc - scaleRoot + 120) % 12;\n    const ivs = getScalePitches(scaleRoot, overlay.scaleType as any).map(v => (v - scaleRoot + 120) % 12);\n    return ivs.includes(iv);\n  })();\n  // Optionally draw scale ghost when in scale and not a chord tone\n  const hasChordOverlay = (chordNotes?.length ?? 0) > 0;\n  const drawGhost = (overlay.showScaleGhost ?? true) && hasChordOverlay && inScale && !set.has(spc);\n  // Draw chord tone if provided\n  const drawChord = set.has(spc);\n  const drawScaleMain = !hasChordOverlay && inScale;\n  if (!drawGhost && !drawChord && !drawScaleMain) return null;\n  const iv = typeof scaleRoot === 'number' ? (spc - scaleRoot + 120) % 12 : 0;\n  const isRoot = iv === 0;\n  const isChordTone = set.has(spc) || [0,4,7,10,11].includes(iv); // root/3/5/7 as baseline\n  const degreeLbl = !inScale || typeof scaleRoot !== 'number' || !scaleType ? null : (degreeLabelFor(spc, scaleRoot, overlay.scaleType as any) ?? null);\n  const baseColor = colorForDegreeLabel(false, degreeLbl, isChordTone, inScale, isRoot);\n  const showDegrees = overlay.display === 'degrees';\n  const fallbackRoot = (typeof scaleRoot === 'number' ? scaleRoot : chordRootIdx);\n  const label = (showDegrees)\n    ? ((degreeRomanFor(spc, fallbackRoot, overlay.scaleType as any) ?? degreeLbl ?? fallbackDegreeLabel(spc, fallbackRoot)))\n    : PITCHES12[spc];\n  const dense = (() => { const def = SCALE_CATALOG.find(s => s.id === (overlay.scaleType as any)); return (def?.degrees?.length ?? 0) > 7; })();\n  const fretLabel = colIdx + 1;\n  const stringNumber = rowIdx + 1;\n  const ariaLabel = `string ${stringNumber}, fret ${fretLabel}, ${label === '1' ? 'root' : label}`;\n  return (\n    <div className=\"absolute inset-0\" aria-live=\"polite\">\n      {drawGhost && (\n        <div className={`absolute left-1/2 top-1/2 fret-dot--ghost${dense ? ' ghost--dense' : ''}`} style={{ color: ghostFromBaseColor(baseColor) }} aria-hidden />\n      )}\n      {drawScaleMain && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(baseColor, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n      {drawChord && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(baseColor, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main fret-dot--chord\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n    </div>\n  );\n}\n\nfunction renderOpenMarker({ overlay, strings, rowIdx, isMobile }:{ overlay: FretboardProps['overlay']; strings: string[]; rowIdx: number; isMobile: boolean; }){\n  if (!overlay) return null;\n  const chordNotes = overlay.chordNotes ?? overlay.notes ?? [];\n  const hasChord = (chordNotes?.length ?? 0) > 0;\n  const tonicIdx = hasChord ? pitchIndex(chordNotes[0] ?? \"C\") : 0;\n  const set = new Set((chordNotes || []).map((note) => pitchIndex(note ?? \"C\")));\n  const openPc = pitchIndex(strings[rowIdx] ?? \"E\");\n  const spcSounding = openPc; // open = fret 0 sounding\n  const spc = spcSounding; // shapedは廃止・常にsounding\n  // 実音のMIDI（弦の実チューニングの開放音）\n  const STRING_OPEN_MIDI = [64, 59, 55, 50, 45, 40];\n  const midi = STRING_OPEN_MIDI[Math.min(rowIdx, STRING_OPEN_MIDI.length - 1)] ?? 64;\n  const scaleRoot = overlay.scaleRootPc;\n  const scaleType = overlay.scaleType;\n  const inScale = ((): boolean => {\n    if (typeof scaleRoot !== 'number' || !scaleType) return true;\n    const iv = (spc - scaleRoot + 120) % 12;\n    const ivs = getScalePitches(scaleRoot, overlay.scaleType as any).map(v => (v - scaleRoot + 120) % 12);\n    return ivs.includes(iv);\n  })();\n  const hasChordOverlay = (chordNotes?.length ?? 0) > 0;\n  const drawGhost = (overlay.showScaleGhost ?? true) && hasChordOverlay && inScale && !set.has(spc);\n  const drawChord = set.has(spc);\n  const drawScaleMain = !hasChordOverlay && inScale;\n  if (!drawGhost && !drawChord && !drawScaleMain) return null;\n  const iv = typeof scaleRoot === 'number' ? (spc - scaleRoot + 120) % 12 : 0;\n  const isRoot = iv === 0;\n  const isChordTone = [0,4,7,10,11].includes(iv) && inScale;\n  const degreeLbl = !inScale || typeof scaleRoot !== 'number' || !scaleType ? null : (degreeLabelFor(spc, scaleRoot, overlay.scaleType as any) ?? null);\n  const bg = colorForDegreeLabel(false, degreeLbl, isChordTone, inScale, isRoot);\n  const showDegrees = overlay.display === 'degrees';\n  const label = (showDegrees)\n    ? ((degreeRomanFor(spc, tonicIdx, overlay.scaleType as any) ?? degreeLbl ?? fallbackDegreeLabel(spc, tonicIdx)))\n    : PITCHES12[spc];\n  const dense = (() => { const def = SCALE_CATALOG.find(s => s.id === (overlay.scaleType as any)); return (def?.degrees?.length ?? 0) > 7; })();\n  const stringNumber = rowIdx + 1;\n  const ariaLabel = `string ${stringNumber}, fret 0, ${label === '1' ? 'root' : label}`;\n  return (\n    <div className=\"absolute inset-0\">\n      {drawGhost && (\n        <div className={`absolute left-1/2 top-1/2 fret-dot--ghost${dense ? ' ghost--dense' : ''}`} style={{ color: COLOR_GHOST }} aria-hidden />\n      )}\n      {drawScaleMain && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(bg, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n      {drawChord && (\n        <button\n          type=\"button\"\n          onClick={async()=>{ await player.resume(); player.playNote(midi); }}\n          style={dotStyle(bg, isMobile)}\n          className=\"absolute left-1/2 top-1/2 fret-dot fret-dot--main fret-dot--chord\"\n          aria-label={ariaLabel}\n        >\n          {label}\n        </button>\n      )}\n    </div>\n  );\n}\n\nfunction renderFormOverlay({ formShape, LEFT_GUTTER, TOP_BAR_H, SPACE_W, ROW_H }:{ formShape: FormShape; LEFT_GUTTER:number; TOP_BAR_H:number; SPACE_W:number; ROW_H:number; }) {\n  return formShape.dots.map((dot, idx) => {\n    const degree = dot.deg === '1'\n      ? 'root'\n      : dot.deg\n          .replace(/b/g, 'flat ')\n          .replace(/#/g, 'sharp ');\n    const ariaLabel = `string ${dot.string}, fret ${dot.fret}, ${degree}`;\n    const left = `calc(${LEFT_GUTTER}px + ${dot.fret * SPACE_W}px)`;\n    const top = `calc(${TOP_BAR_H}px + ${(dot.string - 0.5) * ROW_H}px)`;\n    return (\n      <div\n        key={`form-${idx}`}\n        className=\"absolute\"\n        role=\"img\"\n        aria-label={ariaLabel}\n        style={{ left, top, transform:'translate(-50%, -50%)' }}\n      >\n        <span className=\"fret-dot--form\" aria-hidden />\n      </div>\n    );\n  });\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1838, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/state/overlay.ts"],"sourcesContent":["import React, {createContext, useContext, useRef, useState, useCallback} from 'react';\nimport * as t from '@/lib/telemetry';\n\ntype ViewMode = 'Degrees' | 'Names';\ntype ScaleOverlay = { scaleId: string; notes: number[] } | null;\ntype ChordOverlay = { chordId: string; notes: number[] } | null;\n\ninterface OverlayContextType {\n  viewMode: ViewMode;\n  scale: ScaleOverlay;\n  chord: ChordOverlay;\n  setViewMode: (m: ViewMode) => void;\n  setScale: (s: ScaleOverlay) => void;\n  setChordFromUser: (c: ChordOverlay) => void;\n  resetChord: () => void;\n  // backward-compat aliases (zustand-like naming)\n  setScaleLayer: (s: ScaleOverlay) => void;\n  resetChordLayer: () => void;\n}\n\nconst OverlayContext = createContext<OverlayContextType | null>(null);\n\nexport const OverlayProvider: React.FC<React.PropsWithChildren> = ({children}) => {\n  const [viewMode, setViewMode] = useState<ViewMode>('Degrees');\n  const [scale, setScale] = useState<ScaleOverlay>(null);\n  const [chord, setChord] = useState<ChordOverlay>(null);\n  const shownOnceRef = useRef(false);\n\n  const setChordFromUser = useCallback((c: ChordOverlay) => {\n    setChord(prev => {\n      if (!shownOnceRef.current && !prev && c) {\n        t.track('overlay_shown', { page: 'chord_progression', control: 'chord' });\n        shownOnceRef.current = true;\n      }\n      return c;\n    });\n  }, []);\n\n  const resetChord = useCallback(() => {\n    setChord(null);\n    t.track('overlay_reset', { page: 'chord_progression' });\n  }, []);\n\n  const contextValue: OverlayContextType = {\n    viewMode,\n    scale,\n    chord,\n    setViewMode: (m) => {\n      if (m !== viewMode) {\n        setViewMode(m);\n        t.track('fb_toggle', { page: 'chord_progression', value: m });\n      }\n    },\n    setScale,\n    setChordFromUser,\n    resetChord,\n    // aliases\n    setScaleLayer: (s) => setScale(s),\n    resetChordLayer: () => resetChord(),\n  };\n\n  return React.createElement(\n    OverlayContext.Provider,\n    { value: contextValue },\n    children\n  );\n};\n\n// Accept optional selector for backward compatibility with zustand-like calls\nexport const useOverlay = <T = OverlayContextType>(selector?: (c: OverlayContextType) => T): T => {\n  const ctx = useContext(OverlayContext);\n  if (!ctx) {\n    // Provider未設置時でもクラッシュさせないフェイルセーフ\n    const fallback: OverlayContextType = {\n      viewMode: 'Degrees',\n      scale: null,\n      chord: null,\n      setViewMode: () => {},\n      setScale: () => {},\n      setChordFromUser: () => {},\n      resetChord: () => {},\n      setScaleLayer: () => {},\n      resetChordLayer: () => {},\n    };\n    return (selector ? selector(fallback) : (fallback as unknown as T));\n  }\n  return (selector ? selector(ctx) : (ctx as unknown as T));\n};"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAmBA,MAAM,+BAAiB,IAAA,sNAAa,EAA4B;AAEzD,MAAM,kBAAqD,CAAC,EAAC,QAAQ,EAAC;IAC3E,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAW;IACnD,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAe;IACjD,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAe;IACjD,MAAM,eAAe,IAAA,+MAAM,EAAC;IAE5B,MAAM,mBAAmB,IAAA,oNAAW,EAAC,CAAC;QACpC,SAAS,CAAA;YACP,IAAI,CAAC,aAAa,OAAO,IAAI,CAAC,QAAQ,GAAG;gBACvC,gIAAO,CAAC,iBAAiB;oBAAE,MAAM;oBAAqB,SAAS;gBAAQ;gBACvE,aAAa,OAAO,GAAG;YACzB;YACA,OAAO;QACT;IACF,GAAG,EAAE;IAEL,MAAM,aAAa,IAAA,oNAAW,EAAC;QAC7B,SAAS;QACT,gIAAO,CAAC,iBAAiB;YAAE,MAAM;QAAoB;IACvD,GAAG,EAAE;IAEL,MAAM,eAAmC;QACvC;QACA;QACA;QACA,aAAa,CAAC;YACZ,IAAI,MAAM,UAAU;gBAClB,YAAY;gBACZ,gIAAO,CAAC,aAAa;oBAAE,MAAM;oBAAqB,OAAO;gBAAE;YAC7D;QACF;QACA;QACA;QACA;QACA,UAAU;QACV,eAAe,CAAC,IAAM,SAAS;QAC/B,iBAAiB,IAAM;IACzB;IAEA,qBAAO,gNAAK,CAAC,aAAa,CACxB,eAAe,QAAQ,EACvB;QAAE,OAAO;IAAa,GACtB;AAEJ;AAGO,MAAM,aAAa,CAAyB;IACjD,MAAM,MAAM,IAAA,mNAAU,EAAC;IACvB,IAAI,CAAC,KAAK;QACR,iCAAiC;QACjC,MAAM,WAA+B;YACnC,UAAU;YACV,OAAO;YACP,OAAO;YACP,aAAa,KAAO;YACpB,UAAU,KAAO;YACjB,kBAAkB,KAAO;YACzB,YAAY,KAAO;YACnB,eAAe,KAAO;YACtB,iBAAiB,KAAO;QAC1B;QACA,OAAQ,WAAW,SAAS,YAAa;IAC3C;IACA,OAAQ,WAAW,SAAS,OAAQ;AACtC","debugId":null}},
    {"offset": {"line": 1919, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music/constants.ts"],"sourcesContent":["/**\n * 音楽理論の共通定数\n */\n\n/** ピッチクラスの名前（0=C, 1=C#, ..., 11=B） */\nexport const PC_NAMES = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'Ab', 'A', 'Bb', 'B'] as const;\n\n/** ピッチクラスの総数 */\nexport const PITCH_CLASS_COUNT = 12;\n\n/** デフォルトのMIDIオクターブ（C4 = MIDI 60） */\nexport const DEFAULT_MIDI_OCTAVE = 60;\n\n/**\n * ピッチクラスを0-11の範囲に正規化\n */\nexport function mod12(pc: number): number {\n  return ((pc % 12) + 12) % 12;\n}\n\n/**\n * ピッチクラス番号を音名に変換\n */\nexport function pcToName(pc: number): string {\n  return PC_NAMES[mod12(pc)];\n}\n\n/**\n * 音名をピッチクラス番号に変換\n */\nexport function nameToPc(name: string): number {\n  const index = PC_NAMES.indexOf(name as any);\n  return index >= 0 ? index : -1;\n}\n\n"],"names":[],"mappings":"AAAA;;CAEC,GAED,oCAAoC;;;;;;;;;;;;;;AAC7B,MAAM,WAAW;IAAC;IAAK;IAAM;IAAK;IAAM;IAAK;IAAK;IAAM;IAAK;IAAM;IAAK;IAAM;CAAI;AAGlF,MAAM,oBAAoB;AAG1B,MAAM,sBAAsB;AAK5B,SAAS,MAAM,EAAU;IAC9B,OAAO,CAAC,AAAC,KAAK,KAAM,EAAE,IAAI;AAC5B;AAKO,SAAS,SAAS,EAAU;IACjC,OAAO,QAAQ,CAAC,MAAM,IAAI;AAC5B;AAKO,SAAS,SAAS,IAAY;IACnC,MAAM,QAAQ,SAAS,OAAO,CAAC;IAC/B,OAAO,SAAS,IAAI,QAAQ,CAAC;AAC/B","debugId":null}},
    {"offset": {"line": 1965, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory.ts"],"sourcesContent":["// PITCHESは lib/music/constants.ts に移行しました\nexport { PC_NAMES as PITCHES, PC_NAMES } from './music/constants';\n// 内部で使用するためにインポート\nimport { PC_NAMES as PITCHES_INTERNAL } from './music/constants';\nexport type Pc = number; // 0..11\nexport type Mode = \"Major\" | \"Minor\";\n\nexport const SCALESETS = {\n  ionian:     [0,2,4,5,7,9,11],\n  dorian:     [0,2,3,5,7,9,10],\n  phrygian:   [0,1,3,5,7,8,10],\n  lydian:     [0,2,4,6,7,9,11],\n  mixolydian: [0,2,4,5,7,9,10],\n  aeolian:    [0,2,3,5,7,8,10],\n  locrian:    [0,1,3,5,6,8,10],\n  locrianNat2: [0,2,3,5,6,8,10], // Locrian ♮2 (Melodic Minor 6th mode)\n  majPent:    [0,2,4,7,9],\n  minPent:    [0,3,5,7,10],\n  bluesMin:   [0,3,5,6,7,10],\n  dimWholeHalf: [0,2,3,5,6,8,9,11], // Whole-Half diminished scale\n  dimHalfWhole: [0,1,3,4,6,7,9,10], // Half-Whole diminished scale\n  altered:    [0,1,3,4,6,8,10], // Altered scale (Super Locrian)\n} as const;\n\n// Quality aliases: シンボルの表記ゆれを正規化キーへ統一\nexport const QUALITY_ALIASES: Record<string, string> = {\n  // Major family\n  'maj': 'M', 'major': 'M', '': 'M',\n  'maj7': 'M7', 'M7': 'M7', 'Δ': 'M7', 'Δ7': 'M7',\n  'maj9': 'M9', 'M9': 'M9', 'Δ9': 'M9',\n  'maj11': 'M11', 'M11': 'M11',\n  'maj13': 'M13', 'M13': 'M13',\n  // Minor family\n  'min': 'm', 'mi': 'm', '-': 'm',\n  'min7': 'm7', 'mi7': 'm7', '-7': 'm7',\n  'min9': 'm9', 'mi9': 'm9',\n  'min11': 'm11', 'mi11': 'm11',\n  'min13': 'm13', 'mi13': 'm13',\n  'mM7': 'mMaj7', 'mMaj7': 'mMaj7', 'minMaj7': 'mMaj7',\n  // Diminished family\n  'dim': 'dim', '°': 'dim', 'o': 'dim',\n  'dim7': 'dim7', '°7': 'dim7', 'o7': 'dim7',\n  'm7b5': 'm7b5', 'm7♭5': 'm7b5', 'ø': 'm7b5', 'ø7': 'm7b5',\n  // Augmented family\n  'aug': 'aug', '+': 'aug',\n  'aug7': '7#5', '7#5': '7#5', '7+5': '7#5', '7♯5': '7#5',\n  // Suspended\n  'sus2': 'sus2', 'sus4': 'sus4', 'sus': 'sus4',\n  '7sus4': '7sus4', '7sus': '7sus4',\n  // Sixth chords\n  '6': '6', 'm6': 'm6', 'min6': 'm6',\n  '6/9': '6/9', '69': '6/9',\n  // Altered/extensions\n  '7b5': '7b5', '7♭5': '7b5', '7-5': '7b5',\n  '7b9': '7b9', '7♭9': '7b9', '7-9': '7b9',\n  '7#9': '7#9', '7♯9': '7#9', '7+9': '7#9',\n  '7b13': '7b13', '7♭13': '7b13',\n  '7#11': '7#11', '7♯11': '7#11',\n  '7(9)': '9', '7(11)': '11', '7(13)': '13', // 統一: 7(9)→9\n  'm7(9)': 'm9', 'm7(11)': 'm11',\n  'M7(9)': 'M9', 'M7(13)': 'M13',\n  '7alt': '7alt', '7altered': '7alt',\n} as const;\n\n// Quality resolver: QUALITY_ALIASESを通して正規化\nexport function resolveQuality(qual: string): string {\n  return QUALITY_ALIASES[qual] ?? qual;\n}\n\n// QUALITY_TONES: Chord Libraryの全40+品質を網羅\nexport const QUALITY_TONES: Record<string, number[]> = {\n  // Basic triads (Core)\n  M:     [0,4,7],\n  m:     [0,3,7],\n  aug:   [0,4,8],\n  dim:   [0,3,6],\n  // Suspended (Core)\n  sus2:  [0,2,7],\n  sus4:  [0,5,7],\n  // Sixth chords (Core)\n  \"6\":   [0,4,7,9],\n  m6:    [0,3,7,9],\n  \"6/9\": [0,4,7,9,14], // 6/9 = R,3,5,6,9\n  // Seventh chords (Core)\n  \"7\":   [0,4,7,10],   // Dominant 7th\n  M7:    [0,4,7,11],   // Major 7th\n  m7:    [0,3,7,10],   // Minor 7th\n  dim7:  [0,3,6,9],    // Diminished 7th (修正: [0,3,6,10]→[0,3,6,9])\n  m7b5:  [0,3,6,10],   // Half-diminished 7th\n  mMaj7: [0,3,7,11],   // Minor-major 7th\n  // Ninth chords (Core)\n  \"9\":   [0,4,7,10,14],  // Dominant 9th\n  M9:    [0,4,7,11,14],  // Major 9th\n  m9:    [0,3,7,10,14],  // Minor 9th\n  add9:  [0,4,7,14],     // Add 9 (no 7th)\n  madd9: [0,3,7,14],     // Minor add 9\n  // Extended chords (Advanced)\n  \"11\":  [0,4,7,10,14,17], // 11th (理論上は3rdを省略すべきだが、音度表示は完全形)\n  M11:   [0,4,7,11,14,17], // Major 11th (実務上は#11が一般的だが、ここは理論形)\n  m11:   [0,3,7,10,14,17], // Minor 11th\n  \"13\":  [0,4,7,10,14,21], // 13th (理論上は11thを省略すべき)\n  M13:   [0,4,7,11,14,21], // Major 13th\n  m13:   [0,3,7,10,14,21], // Minor 13th\n  // Altered/Sus7 (Core & Advanced)\n  \"7sus4\": [0,5,7,10],     // Dominant 7 sus4\n  \"7b5\":   [0,4,6,10],     // Dominant 7 flat 5\n  \"7#5\":   [0,4,8,10],     // Dominant 7 sharp 5 (aug7)\n  \"7b9\":   [0,4,7,10,13],  // Dominant 7 flat 9\n  \"7#9\":   [0,4,7,10,15],  // Dominant 7 sharp 9\n  \"7#11\":  [0,4,7,10,18],  // Dominant 7 sharp 11 (Lydian dominant)\n  \"7b13\":  [0,4,7,10,20],  // Dominant 7 flat 13\n  \"7alt\":  [0,4,7,10,13,15,18], // Altered (代表構成: ♭9,#9,#11 - 実用的な組み合わせに固定)\n};\n\nexport const noteToPc = (n: string): Pc => {\n  const i = PITCHES_INTERNAL.indexOf(n as any);\n  if (i >= 0) return i;\n  const flatMap: Record<string,string> = {Db:\"C#\",Gb:\"F#\",Ab:\"G#\",Bb:\"A#\",Eb:\"D#\",Cb:\"B\",Fb:\"E\"};\n  const up = flatMap[n] ?? n;\n  return PITCHES_INTERNAL.indexOf(up as any) as number;\n};\n\n/**\n * pcToNoteName: Pitch class → 音名変換（キーの調号に応じて♯/♭を選択）\n * @param pc - Pitch class (0-11)\n * @param keyRoot - キーのルート音（Pc: 0-11）\n * @param mode - Major or Minor\n * @returns 音名（例: \"Eb\", \"F#\"）\n */\nexport function pcToNoteName(pc: Pc, keyRoot?: Pc, mode?: Mode): string {\n  if (keyRoot === undefined) {\n    // キー情報がない場合は♭優先（Chord Libraryと同じ）\n    const flatPreferred = [\"C\", \"C#\", \"D\", \"Eb\", \"E\", \"F\", \"F#\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\"];\n    return flatPreferred[pc];\n  }\n  \n  // ♯系キーと♭系キーを判定\n  const sharpKeys = [7, 2, 9, 4, 11, 6, 1]; // G, D, A, E, B, F#, C#\n  const flatKeys = [5, 10, 3, 8, 1, 6, 11]; // F, Bb, Eb, Ab, Db, Gb, Cb\n  \n  const isSharpKey = sharpKeys.includes(keyRoot);\n  \n  if (isSharpKey) {\n    // ♯系キー: C, C#, D, D#, E, F, F#, G, G#, A, A#, B\n    const sharpNames = [\"C\", \"C#\", \"D\", \"D#\", \"E\", \"F\", \"F#\", \"G\", \"G#\", \"A\", \"A#\", \"B\"];\n    return sharpNames[pc];\n  } else {\n    // ♭系キー（またはC): C, Db, D, Eb, E, F, Gb, G, Ab, A, Bb, B\n    const flatNames = [\"C\", \"Db\", \"D\", \"Eb\", \"E\", \"F\", \"Gb\", \"G\", \"Ab\", \"A\", \"Bb\", \"B\"];\n    return flatNames[pc];\n  }\n}\n\nexport const transpose = (pc: Pc, by: number) => (pc + by + 12) % 12;\n\nexport type ChordSym = string; // e.g. \"C\", \"Am\", \"G7\", \"F#m7\", \"C/E\"\nexport type ParsedChord = { root: Pc; qual: string; bass?: Pc; tones: Pc[] };\n\nexport function parseChord(sym: ChordSym): ParsedChord {\n  const slash = sym.split(\"/\");\n  const main = slash[0];\n  const m = main.match(/^([A-G](#|b)?)(.*)$/);\n  if (!m) throw new Error(\"bad chord: \"+sym);\n  const root = noteToPc(m[1]!);\n  const rawQual = (m[3] || \"\").trim() || \"\";\n  const qual = resolveQuality(rawQual || \"M\"); // エイリアス正規化を通す\n  const tonesRel = QUALITY_TONES[qual] ?? QUALITY_TONES.M;\n  const tones = tonesRel.map(iv => transpose(root, iv % 12)); // mod12で正規化\n  const bass = slash[1] ? noteToPc(slash[1]!) : undefined;\n  return { root, qual, bass, tones };\n}\n\n// Diatonic quality tables: 各度数に対する典型的な品質（第1候補が既定）\nexport const DEG_QUAL_MAJOR: Record<number, string[]> = {\n  0:[\"M\",\"M7\"], 2:[\"m\",\"m7\"], 4:[\"m\",\"m7\"], 5:[\"M\",\"M7\"], 7:[\"M\",\"7\"], 9:[\"m\",\"m7\"], 11:[\"dim\",\"m7b5\"],\n};\nexport const DEG_QUAL_MINOR: Record<number, string[]> = {\n  0:[\"m\",\"m7\"], 2:[\"dim\",\"m7b5\"], 3:[\"M\",\"M7\"], 5:[\"m\",\"m7\"],\n  7:[\"m\",\"7\",\"M\",\"7\"], // v と V の両方を許容\n  8:[\"M\",\"M7\"], 10:[\"M\",\"7\"],\n};\n\ntype RankItem = { keyRoot: Pc; mode: Mode; label: string; score: number; pct: number };\n\nexport function rankKeys(chords: ChordSym[]): RankItem[] {\n  const parsed = chords.map(parseChord);\n  const candidates: {root:Pc; mode:Mode}[] = [];\n  for (let r=0;r<12;r++) candidates.push({root:r,mode:\"Major\"},{root:r,mode:\"Minor\"});\n\n  const maxPerChord = 3;\n  const bonuses = 3;\n  const denom = parsed.length * maxPerChord + bonuses;\n\n  const res = candidates.map(({root,mode})=>{\n    const table = mode===\"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n    let s = 0;\n    parsed.forEach((c,idx)=>{\n      const deg = (c.root - root + 12) % 12;\n      const expected = table[deg];\n      if (expected) {\n        if (expected.includes(c.qual)) s += 3; else s += 2;\n      } else {\n        const scale = mode===\"Major\" ? SCALESETS.ionian : SCALESETS.aeolian;\n        const inScale = c.tones.every(t => scale.includes((t - root + 12)%12));\n        if (inScale) s += 1;\n      }\n      if (idx>0) {\n        const prevDeg = (parsed[idx-1].root - root + 12) % 12;\n        // 五度下行（循環）を一般的に評価: a→b が完全5度下行（-7半音＝+5半音）\n        const fifthsDown = ((prevDeg - deg + 12) % 12) === 7;\n        if (fifthsDown) s += 1; // 五度下行ボーナス（ii→V, V→I, vi→ii, etc.）\n      }\n    });\n    const firstDeg = (parsed[0].root - root + 12) % 12;\n    if (mode===\"Major\" && (firstDeg===0 || firstDeg===9)) s += 2;\n    if (mode===\"Minor\" && (firstDeg===0 || firstDeg===3)) s += 2;\n    const pct = Math.round((s / Math.max(denom,1)) * 100);\n    const label = `${PITCHES_INTERNAL[root]} ${mode}`;\n    return { keyRoot:root, mode, label, score:s, pct };\n  });\n  return res.sort((a,b)=> b.score - a.score);\n}\n\nexport type ScaleRank = { keyRoot: Pc; name: string; label: string; pct: number; set: number[] };\n\n/**\n * getRecommendedScalesForQuality: 品質に応じた推奨スケールを返す\n * @param quality - コード品質（例: \"m7b5\", \"dim7\", \"7b9\"）\n * @returns 推奨スケール名の配列（優先順）\n */\nexport function getRecommendedScalesForQuality(quality: string): Array<{name: string; scaleKey: keyof typeof SCALESETS}> {\n  const q = resolveQuality(quality);\n  \n  switch (q) {\n    case 'm7b5': // Half-diminished: Locrian ♮2 優先\n      return [\n        {name: \"Locrian ♮2\", scaleKey: \"locrianNat2\"},\n        {name: \"Locrian\", scaleKey: \"locrian\"}\n      ];\n    case 'dim':\n    case 'dim7': // Diminished: Whole-Half 優先\n      return [\n        {name: \"Diminished (W-H)\", scaleKey: \"dimWholeHalf\"}\n      ];\n    case '7b9': // Dominant b9: Half-Whole 優先\n      return [\n        {name: \"Diminished (H-W)\", scaleKey: \"dimHalfWhole\"},\n        {name: \"Mixolydian ♭9♭13\", scaleKey: \"altered\"} // 近似\n      ];\n    case '7alt': // Altered dominant\n      return [\n        {name: \"Altered\", scaleKey: \"altered\"}\n      ];\n    case '7': // Dominant 7th\n      return [\n        {name: \"Mixolydian\", scaleKey: \"mixolydian\"},\n        {name: \"Lydian Dominant (Mixolydian ♯11)\", scaleKey: \"lydian\"}, // 近似\n        {name: \"Altered\", scaleKey: \"altered\"}\n      ];\n    default:\n      return [];\n  }\n}\n\nexport function rankScales(chords: ChordSym[], baseKey: {root:Pc; mode:Mode}): ScaleRank[] {\n  const tones = Array.from(new Set(chords.map(parseChord).flatMap(c=>c.tones)));\n  const root = baseKey.root;\n  const defs = baseKey.mode===\"Major\"\n    ? [[\"Major Scale\",\"ionian\"],[\"Major Pentatonic\",\"majPent\"],[\"Mixolydian Mode\",\"mixolydian\"],[\"Lydian Mode\",\"lydian\"]]\n    : [[\"Minor Scale\",\"aeolian\"],[\"Minor Pentatonic\",\"minPent\"],[\"Dorian Mode\",\"dorian\"],[\"Phrygian Mode\",\"phrygian\"],[\"Blues (min)\",\"bluesMin\"]];\n  return defs.map(([disp, key])=>{\n    const set = SCALESETS[key as keyof typeof SCALESETS].map(iv => transpose(root, iv));\n    const cover = tones.filter(t => set.includes(t)).length;\n    const pct = Math.round(100 * cover / Math.max(tones.length,1));\n    return { keyRoot:root, name: disp as string, label: `${PITCHES_INTERNAL[root]} ${disp}`, pct, set };\n  }).sort((a,b)=> b.pct - a.pct);\n}\n\n\n// --- P2-3: Analyzer utilities ---\nexport type KeyCandidate = { tonic: Pc; mode: Mode; confidence: number; reasons: string[] };\n\nconst DEGREE_MAP_MAJOR = {0:\"I\",2:\"II\",4:\"III\",5:\"IV\",7:\"V\",9:\"VI\",11:\"VII\"} as const;\nconst DEGREE_MAP_MINOR = {0:\"i\",2:\"ii\",3:\"III\",5:\"iv\",7:\"v\",8:\"VI\",10:\"VII\"} as const;\n\nexport function scoreKeyCandidates(prog: ChordSym[]): KeyCandidate[] {\n  const ranked = rankKeys(prog);\n  const top = ranked.slice(0,5);  // v3.1: 3→5候補に拡張（iOS UI改善）\n  return top.map((r)=>{\n    const key = { tonic: r.keyRoot, mode: r.mode } as const;\n    const cad = detectCadence(prog, key);\n    const reasons: string[] = [];\n    if (cad === \"perfect\") reasons.push(\"Cadence: V→I\");\n    if (cad === \"deceptive\") reasons.push(\"Cadence: V→vi\");\n    if (cad === \"half\") reasons.push(\"Cadence: …→V\");\n    reasons.unshift(`diatonic fit ${r.pct}%`);\n    return { tonic: r.keyRoot, mode: r.mode, confidence: r.pct, reasons };\n  });\n}\n\nexport function classifyChord(chord: ParsedChord, key: {tonic: Pc; mode: Mode}): \"diatonic\"|\"secondary\"|\"borrowed\"|\"outside\" {\n  const diatonic = ((): string[] => {\n    const tonicName = PITCHES_INTERNAL[key.tonic];\n    if (key.mode === \"Major\") {\n      const mk = (Key as any)?.majorKey ? (Key as any).majorKey(tonicName) : null;\n      return mk?.chords || [];\n    } else {\n      const nk = (Key as any)?.minorKey ? (Key as any).minorKey(tonicName) : null;\n      return nk?.natural?.chords || nk?.chords || [];\n    }\n  })();\n  const target = chord.root + (chord.triad === \"maj\" ? \"\" : chord.triad === \"min\" ? \"m\" : \"dim\");\n  if (diatonic.includes(target)) return \"diatonic\";\n  // secondary dominant: X7 targeting a diatonic\n  const isDomLike = chord.triad === \"maj\" || chord.isDominantLike;\n  if (isDomLike) {\n    for (let r=0;r<12;r++){\n      const deg = (r - key.tonic + 12) % 12;\n      const table = key.mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n      if (table[deg]){\n        const fifth = transpose(r, 7 as any);\n        if (chord.root === fifth) return \"secondary\";\n      }\n    }\n  }\n  // simple borrowed detection in major: iv, bVII, bVI roots\n  if (key.mode === \"Major\"){\n    const deg = (chord.root - key.tonic + 12) % 12;\n    if (deg === 5 && chord.triad === \"min\") return \"borrowed\"; // iv\n    if (deg === 10 || deg === 8) return \"borrowed\"; // bVII, bVI\n  }\n  return \"outside\";\n}\n\nexport function detectCadence(prog: ChordSym[], key: {tonic: Pc; mode: Mode}): \"perfect\"|\"deceptive\"|\"half\"|null {\n  if (prog.length < 2) return null;\n  const last = parseChord(prog[prog.length-1]);\n  const prev = parseChord(prog[prog.length-2]);\n  const degLast = (last.root - key.tonic + 12) % 12;\n  const degPrev = (prev.root - key.tonic + 12) % 12;\n  if (degPrev === 7 && degLast === 0) return \"perfect\"; // V→I\n  if (degPrev === 7 && (degLast === 9)) return \"deceptive\"; // V→vi\n  if (degLast === 7) return \"half\"; // …→V\n  return null;\n}\n\n// --- Roman Numeral to Chord Symbol Conversion ---\n\n// Roman numeral mapping: Roman表記から度数（0-11）と明示的品質を解析\nconst ROMAN_MAP: Record<string, {offset: number}> = {\n  'Ⅰ': {offset: 0}, 'ⅰ': {offset: 0},\n  'Ⅱ': {offset: 2}, 'ⅱ': {offset: 2},\n  '♭Ⅱ': {offset: 1}, '♭ⅱ': {offset: 1},\n  'Ⅲ': {offset: 4}, 'ⅲ': {offset: 4},\n  '♭Ⅲ': {offset: 3}, '♭ⅲ': {offset: 3},\n  'Ⅳ': {offset: 5}, 'ⅳ': {offset: 5},\n  '♯Ⅳ': {offset: 6}, '♯ⅳ': {offset: 6},\n  'Ⅴ': {offset: 7}, 'ⅴ': {offset: 7},\n  '♭Ⅵ': {offset: 8}, '♭ⅵ': {offset: 8},\n  'Ⅵ': {offset: 9}, 'ⅵ': {offset: 9},\n  '♭Ⅶ': {offset: 10}, '♭ⅶ': {offset: 10},\n  'Ⅶ': {offset: 11}, 'ⅶ': {offset: 11},\n};\n\n/**\n * parseRomanNumeral: Roman numeral表記から度数と明示的品質を分離\n * 例: \"Ⅱm7\" → {deg: 2, explicitQual: \"m7\"}\n *     \"Ⅴ\" → {deg: 7, explicitQual: null}\n *     \"♭Ⅶ\" → {deg: 10, explicitQual: null}\n */\nfunction parseRomanNumeral(roman: string): {deg: number; explicitQual: string | null} {\n  // Roman表記の本体と接尾辞を分離\n  // 例: \"Ⅱm7\" → base=\"Ⅱ\", suffix=\"m7\"\n  let base = roman;\n  let suffix = \"\";\n  \n  // Roman表記のパターンをチェック\n  for (const [romanKey, {offset}] of Object.entries(ROMAN_MAP)) {\n    if (roman.startsWith(romanKey)) {\n      base = romanKey;\n      suffix = roman.slice(romanKey.length).trim();\n      return {deg: offset, explicitQual: suffix || null};\n    }\n  }\n  \n  // マッチしない場合はエラー（または警告）\n  console.warn(`Unknown Roman numeral: ${roman}`);\n  return {deg: 0, explicitQual: null}; // デフォルトは I（tonic）\n}\n\n/**\n * defaultQualityForDegree: 度数とモードに基づいてダイアトニック品質を返す\n * 例: Major key の deg=2 → \"m\"（ii）\n *     Major key の deg=11 → \"dim\"（vii°）\n */\nfunction defaultQualityForDegree(deg: number, mode: Mode): string {\n  const table = mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n  const candidates = table[deg];\n  if (!candidates || candidates.length === 0) {\n    // ダイアトニックにない度数（借用和音など）は空（Major triad）をデフォルトに\n    return \"\";\n  }\n  // 第1候補（三和音）を返す\n  return candidates[0];\n}\n\n/**\n * romanToChordSymbol: Roman numeral → 実コードシンボル変換（文脈化版）\n * @param roman - Roman numeral表記（例: \"Ⅱm7\", \"♭Ⅶ\", \"Ⅴ7\"）\n * @param keyRoot - キーのルート（Pc: 0-11）\n * @param mode - Major or Minor\n * @returns コードシンボル（例: \"Dm7\", \"Bb\", \"G7\"）\n */\nexport function romanToChordSymbol(roman: string, keyRoot: Pc, mode: Mode): string {\n  const {deg, explicitQual} = parseRomanNumeral(roman);\n  \n  // 明示的品質がない場合、ダイアトニック品質を補完\n  const quality = explicitQual !== null ? explicitQual : defaultQualityForDegree(deg, mode);\n  \n  // ルート音を計算（キーの調号に応じて♯/♭を選択）\n  const rootPc = (keyRoot + deg) % 12;\n  const rootName = pcToNoteName(rootPc, keyRoot, mode);\n  \n  // コードシンボルを組み立て\n  return `${rootName}${quality}`;\n}\n\n/**\n * formatRomanForDisplay: 度数と品質から正しいRoman表記を生成（SSOT準拠: I, ii, iii, IV, V, vi, vii°）\n * @param degree - 度数（0-11）\n * @param quality - コード品質（例: \"\", \"m\", \"7\", \"m7\", \"dim\", \"m7b5\"）\n * @param mode - Major or Minor\n * @param keyRoot - キーのルート（表記方針の決定に使用）\n * @returns 表示用Roman numeral（例: \"ii\", \"V7\", \"vii°\"）\n */\nexport function formatRomanForDisplay(degree: number, quality: string, mode: Mode, keyRoot?: Pc): string {\n  // 度数をdiatonic度数にマッピング（0,2,4,5,7,9,11 のみ）\n  const diatonicDegrees: Record<number, number> = {\n    0: 1, 2: 2, 4: 3, 5: 4, 7: 5, 9: 6, 11: 7\n  };\n  \n  const romanNum = diatonicDegrees[degree];\n  if (!romanNum) {\n    // 非ダイアトニック度数（借用和音など）は変化記号付きで表示\n    if (degree === 1) return '♭Ⅱ' + quality; // ♭II\n    if (degree === 3) return '♭Ⅲ' + quality; // ♭III\n    if (degree === 6) return '♯Ⅳ' + quality; // #IV\n    if (degree === 8) return '♭Ⅵ' + quality; // ♭VI\n    if (degree === 10) return '♭Ⅶ' + quality; // ♭VII\n    return '?'; // 不明\n  }\n  \n  // 品質から大文字/小文字を決定\n  const isMinor = quality.startsWith('m') && !quality.startsWith('maj');\n  const isDim = quality.includes('dim') || quality.includes('°') || quality === 'm7b5' || quality === 'ø';\n  \n  // ダイアトニック品質を参照して大文字/小文字を決定\n  const table = mode === \"Major\" ? DEG_QUAL_MAJOR : DEG_QUAL_MINOR;\n  const expectedQuals = table[degree];\n  const isDiatonicMinor = expectedQuals?.some(q => q === 'm' || q === 'm7');\n  const isDiatonicDim = expectedQuals?.some(q => q === 'dim' || q === 'm7b5');\n  \n  // Roman数字の基本形\n  const romanNumerals = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII'];\n  let romanBase = romanNumerals[romanNum - 1];\n  \n  // SSOT準拠: I, ii, iii, IV, V, vi, vii°\n  // Major key: I, ii, iii, IV, V, vi, vii°\n  // Minor key: i, ii°, III, iv, v/V, VI, VII\n  \n  if (mode === \"Major\") {\n    // I, IV, V は大文字、ii, iii, vi は小文字、vii° は小文字+°\n    if ([1, 4, 5].includes(romanNum) && !isMinor && !isDim) {\n      romanBase = romanBase; // 大文字のまま\n    } else if (isDim || isDiatonicDim) {\n      romanBase = romanBase.toLowerCase() + '°'; // vii°\n    } else {\n      romanBase = romanBase.toLowerCase(); // ii, iii, vi\n    }\n  } else {\n    // Minor key: i, ii°, III, iv, v/V, VI, VII\n    if ([3, 6, 7].includes(romanNum) && !isMinor && !isDim) {\n      romanBase = romanBase; // III, VI, VII は大文字\n    } else if (romanNum === 5) {\n      // v と V の両方あり（harmonic minor の V）\n      romanBase = isMinor ? 'v' : 'V';\n    } else if (isDim || isDiatonicDim) {\n      romanBase = romanBase.toLowerCase() + '°'; // ii°\n    } else {\n      romanBase = romanBase.toLowerCase(); // i, iv\n    }\n  }\n  \n  // 7thなどの拡張を追加（dim以外）\n  let extension = '';\n  if (!isDim && quality && quality !== 'm' && quality !== '') {\n    // 7, M7, m7, sus4などをそのまま付加\n    extension = quality.replace('m', '').replace('M', 'maj'); // m7 → 7, M7 → maj7\n    if (isMinor && extension.startsWith('7')) {\n      // マイナーコードの場合、m7 → 7 と表示（既に小文字で示されているため）\n      extension = extension;\n    }\n  }\n  \n  return romanBase + extension;\n}\n\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3086, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/analysis/scoreScales.ts"],"sourcesContent":["import type { Pc, Mode, ChordSym } from \"../theory\";\nimport { parseChord } from \"../theory\";\nimport { getScalePitches, type ScaleType } from \"../scales\";\n\nexport type ScaleCandidate = {\n  root: Pc;\n  type: ScaleType;\n  score: number; // 0..100\n  reasons?: string[];\n};\n\nconst CANDIDATE_TYPES_MAJOR: ScaleType[] = [\n  \"Ionian\",\n  \"Lydian\",\n  \"Mixolydian\",\n  \"MajorPentatonic\",\n];\nconst CANDIDATE_TYPES_MINOR: ScaleType[] = [\n  \"Aeolian\",\n  \"Dorian\",\n  \"Phrygian\",\n  \"HarmonicMinor\",\n  \"MelodicMinor\",\n  \"MinorPentatonic\",\n];\n\nfunction uniq<T>(arr: T[]): T[] {\n  return Array.from(new Set(arr));\n}\n\nexport function scoreScales(\n  prog: ChordSym[],\n  key: { root: Pc; mode: Mode }\n): ScaleCandidate[] {\n  const types = key.mode === \"Major\" ? CANDIDATE_TYPES_MAJOR : CANDIDATE_TYPES_MINOR;\n  const chordPcs = uniq(\n    prog.flatMap((ch) => {\n      const p = parseChord(ch);\n      const thirds = p.qual.includes(\"m\") ? 3 : 4;\n      const sevenths = p.qual.includes(\"7\") ? (p.qual.includes(\"M7\") ? 11 : 10) : null;\n      const pcs = [p.root % 12, (p.root + thirds) % 12, (p.root + 7) % 12];\n      if (sevenths !== null) pcs.push((p.root + sevenths) % 12);\n      return pcs;\n    })\n  );\n\n  const hasV7 = prog.some((ch) => /7\\b/.test(ch));\n\n  return types\n    .map<ScaleCandidate>((type) => {\n      const scale = getScalePitches(key.root, type);\n      const hit = chordPcs.filter((pc) => scale.includes(pc)).length;\n      const cover = hit / Math.max(1, chordPcs.length);\n      // ---- bonuses (max total 0.05) ----\n      let bonus = 0;\n      if (key.mode === \"Major\" && type === \"Ionian\") bonus += 0.02;\n      if (key.mode === \"Minor\" && type === \"Aeolian\") bonus += 0.02;\n      if (hasV7 && (type === \"HarmonicMinor\" || type === \"MelodicMinor\")) bonus += 0.03;\n      const raw = Math.min(1, cover + bonus);\n      const score = Math.round(raw * 100);\n      return { root: key.root, type, score };\n    })\n    .sort((a, b) => b.score - a.score);\n}\n\n\n"],"names":[],"mappings":";;;;AACA;AACA;;;AASA,MAAM,wBAAqC;IACzC;IACA;IACA;IACA;CACD;AACD,MAAM,wBAAqC;IACzC;IACA;IACA;IACA;IACA;IACA;CACD;AAED,SAAS,KAAQ,GAAQ;IACvB,OAAO,MAAM,IAAI,CAAC,IAAI,IAAI;AAC5B;AAEO,SAAS,YACd,IAAgB,EAChB,GAA6B;IAE7B,MAAM,QAAQ,IAAI,IAAI,KAAK,UAAU,wBAAwB;IAC7D,MAAM,WAAW,KACf,KAAK,OAAO,CAAC,CAAC;QACZ,MAAM,IAAI,IAAA,kJAAU,EAAC;QACrB,MAAM,SAAS,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAO,IAAI;QAC1C,MAAM,WAAW,EAAE,IAAI,CAAC,QAAQ,CAAC,OAAQ,EAAE,IAAI,CAAC,QAAQ,CAAC,QAAQ,KAAK,KAAM;QAC5E,MAAM,MAAM;YAAC,EAAE,IAAI,GAAG;YAAI,CAAC,EAAE,IAAI,GAAG,MAAM,IAAI;YAAI,CAAC,EAAE,IAAI,GAAG,CAAC,IAAI;SAAG;QACpE,IAAI,aAAa,MAAM,IAAI,IAAI,CAAC,CAAC,EAAE,IAAI,GAAG,QAAQ,IAAI;QACtD,OAAO;IACT;IAGF,MAAM,QAAQ,KAAK,IAAI,CAAC,CAAC,KAAO,MAAM,IAAI,CAAC;IAE3C,OAAO,MACJ,GAAG,CAAiB,CAAC;QACpB,MAAM,QAAQ,IAAA,uIAAe,EAAC,IAAI,IAAI,EAAE;QACxC,MAAM,MAAM,SAAS,MAAM,CAAC,CAAC,KAAO,MAAM,QAAQ,CAAC,KAAK,MAAM;QAC9D,MAAM,QAAQ,MAAM,KAAK,GAAG,CAAC,GAAG,SAAS,MAAM;QAC/C,qCAAqC;QACrC,IAAI,QAAQ;QACZ,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS,UAAU,SAAS;QACxD,IAAI,IAAI,IAAI,KAAK,WAAW,SAAS,WAAW,SAAS;QACzD,IAAI,SAAS,CAAC,SAAS,mBAAmB,SAAS,cAAc,GAAG,SAAS;QAC7E,MAAM,MAAM,KAAK,GAAG,CAAC,GAAG,QAAQ;QAChC,MAAM,QAAQ,KAAK,KAAK,CAAC,MAAM;QAC/B,OAAO;YAAE,MAAM,IAAI,IAAI;YAAE;YAAM;QAAM;IACvC,GACC,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;AACrC","debugId":null}},
    {"offset": {"line": 3148, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/roman.ts"],"sourcesContent":["import { degreeLabelFor, parentModeOf, getScalePitches, type ScaleType } from \"@/lib/scales\";\nimport { parseChord, type ChordSym } from \"@/lib/theory\";\n\nconst ROMAN_UPPER = [\"I\",\"II\",\"III\",\"IV\",\"V\",\"VI\",\"VII\"] as const;\n\nfunction baseRomanFromDegreeLabel(lbl: string | null): string {\n  if (!lbl) return \"I\";\n  const n = Number(lbl.replace(/[♭#]/g, \"\"));\n  const idx = isFinite(n) ? Math.max(1, Math.min(7, n)) - 1 : 0;\n  return ROMAN_UPPER[idx];\n}\n\nfunction qualitySuffix(qual: string): string { return /7/.test(qual) ? \"7\" : \"\"; }\nfunction diminishedSymbol(qual: string): string { return /dim|o/.test(qual) ? \"°\" : \"\"; }\n\nexport function romanizeChord(\n  chord: ChordSym,\n  tonicPc: number,\n  scaleType: ScaleType\n): string {\n  const { root, qual } = parseChord(chord);\n  const effectiveType = parentModeOf(scaleType) ?? scaleType;\n  // try exact degree label first\n  let lbl = degreeLabelFor(root, tonicPc, effectiveType);\n  let accidental = lbl?.startsWith(\"♭\") ? \"♭\" : lbl?.startsWith(\"#\") ? \"♯\" : \"\";\n  // if null, try ±1 semitone nearest mapping\n  if (!lbl) {\n    const pcs = getScalePitches(tonicPc, effectiveType); // absolute pcs\n    const minus = (root + 12 - 1) % 12;\n    const plus = (root + 1) % 12;\n    const idxMinus = pcs.indexOf(minus);\n    const idxPlus = pcs.indexOf(plus);\n    if (idxMinus !== -1) {\n      lbl = degreeLabelFor(minus, tonicPc, effectiveType); // e.g., \"3\"\n      accidental = \"♭\";\n    } else if (idxPlus !== -1) {\n      lbl = degreeLabelFor(plus, tonicPc, effectiveType);\n      accidental = \"♯\";\n    }\n  }\n  const base = baseRomanFromDegreeLabel(lbl);\n  const sym = diminishedSymbol(qual);\n  const suf = qualitySuffix(qual);\n  return `${accidental}${base}${sym}${suf}`;\n}\n\nexport function progressionToRoman(\n  chords: ChordSym[],\n  tonicPc: number,\n  scaleType: ScaleType\n): string[] {\n  return chords.map((c) => romanizeChord(c, tonicPc, scaleType));\n}\n\n\n"],"names":[],"mappings":";;;;;;AAAA;AACA;;;AAEA,MAAM,cAAc;IAAC;IAAI;IAAK;IAAM;IAAK;IAAI;IAAK;CAAM;AAExD,SAAS,yBAAyB,GAAkB;IAClD,IAAI,CAAC,KAAK,OAAO;IACjB,MAAM,IAAI,OAAO,IAAI,OAAO,CAAC,SAAS;IACtC,MAAM,MAAM,SAAS,KAAK,KAAK,GAAG,CAAC,GAAG,KAAK,GAAG,CAAC,GAAG,MAAM,IAAI;IAC5D,OAAO,WAAW,CAAC,IAAI;AACzB;AAEA,SAAS,cAAc,IAAY;IAAY,OAAO,IAAI,IAAI,CAAC,QAAQ,MAAM;AAAI;AACjF,SAAS,iBAAiB,IAAY;IAAY,OAAO,QAAQ,IAAI,CAAC,QAAQ,MAAM;AAAI;AAEjF,SAAS,cACd,KAAe,EACf,OAAe,EACf,SAAoB;IAEpB,MAAM,EAAE,IAAI,EAAE,IAAI,EAAE,GAAG,IAAA,kJAAU,EAAC;IAClC,MAAM,gBAAgB,IAAA,oIAAY,EAAC,cAAc;IACjD,+BAA+B;IAC/B,IAAI,MAAM,IAAA,sIAAc,EAAC,MAAM,SAAS;IACxC,IAAI,aAAa,KAAK,WAAW,OAAO,MAAM,KAAK,WAAW,OAAO,MAAM;IAC3E,2CAA2C;IAC3C,IAAI,CAAC,KAAK;QACR,MAAM,MAAM,IAAA,uIAAe,EAAC,SAAS,gBAAgB,eAAe;QACpE,MAAM,QAAQ,CAAC,OAAO,KAAK,CAAC,IAAI;QAChC,MAAM,OAAO,CAAC,OAAO,CAAC,IAAI;QAC1B,MAAM,WAAW,IAAI,OAAO,CAAC;QAC7B,MAAM,UAAU,IAAI,OAAO,CAAC;QAC5B,IAAI,aAAa,CAAC,GAAG;YACnB,MAAM,IAAA,sIAAc,EAAC,OAAO,SAAS,gBAAgB,YAAY;YACjE,aAAa;QACf,OAAO,IAAI,YAAY,CAAC,GAAG;YACzB,MAAM,IAAA,sIAAc,EAAC,MAAM,SAAS;YACpC,aAAa;QACf;IACF;IACA,MAAM,OAAO,yBAAyB;IACtC,MAAM,MAAM,iBAAiB;IAC7B,MAAM,MAAM,cAAc;IAC1B,OAAO,GAAG,aAAa,OAAO,MAAM,KAAK;AAC3C;AAEO,SAAS,mBACd,MAAkB,EAClB,OAAe,EACf,SAAoB;IAEpB,OAAO,OAAO,GAAG,CAAC,CAAC,IAAM,cAAc,GAAG,SAAS;AACrD","debugId":null}},
    {"offset": {"line": 3212, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/diatonic.ts"],"sourcesContent":["import { type Pc } from \"@/lib/theory\";\n\nexport type TriadQuality = 'maj'|'min'|'dim'|'aug';\n\nexport type DiatonicTriad = {\n  degree: 1|2|3|4|5|6|7;\n  rootPc: Pc;\n  pcs: [Pc, Pc, Pc]; // root, third, fifth (0..11)\n  quality: TriadQuality;\n};\n\n// Build 7 diatonic triads from scale intervals (e.g. Ionian [0,2,4,5,7,9,11])\nexport function diatonicTriads({ tonicPc, scaleIntervals }:{ tonicPc: Pc; scaleIntervals: number[] }): DiatonicTriad[] {\n  const pcs = scaleIntervals.map(iv => (tonicPc + iv + 120) % 12);\n  const triads: DiatonicTriad[] = [];\n  for (let i = 0; i < 7; i++) {\n    const deg = (i % 7) as 0|1|2|3|4|5|6;\n    const r = pcs[deg];\n    const t = pcs[(deg + 2) % 7];\n    const f = pcs[(deg + 4) % 7];\n    const q = qualityOfTriad(r, t, f);\n    triads.push({ degree: (i+1) as 1|2|3|4|5|6|7, rootPc: r, pcs: [r,t,f], quality: q });\n  }\n  return triads;\n}\n\nfunction qualityOfTriad(r: number, t: number, f: number): TriadQuality {\n  // intervals from root in semitones (mod 12)\n  const third = (t - r + 12) % 12;\n  const fifth = (f - r + 12) % 12;\n  if (third === 4 && fifth === 7) return 'maj';\n  if (third === 3 && fifth === 7) return 'min';\n  if (third === 3 && fifth === 6) return 'dim';\n  if (third === 4 && fifth === 8) return 'aug';\n  // fallback: closest common qualities\n  if (fifth === 6) return 'dim';\n  if (fifth === 8) return 'aug';\n  return third < 4 ? 'min' : 'maj';\n}\n\nconst ROMAN_UP = [\"I\",\"II\",\"III\",\"IV\",\"V\",\"VI\",\"VII\"] as const;\n\nexport function romanOfTriad(degree: 1|2|3|4|5|6|7, quality: TriadQuality, opts?: { case?: 'upper'|'quality' }): string {\n  const base = ROMAN_UP[degree - 1];\n  const mode = opts?.case ?? 'upper';\n  if (mode === 'upper') {\n    // Always uppercase; add dimin./aug symbols\n    if (quality === 'dim') return base + '°';\n    if (quality === 'aug') return base + '+';\n    return base;\n  }\n  // case: 'quality' → major uppercase, minor lowercase, diminished lowercase+°\n  if (quality === 'min') return base.toLowerCase();\n  if (quality === 'dim') return base.toLowerCase() + '°';\n  if (quality === 'aug') return base + '+';\n  return base; // maj\n}\n\n// Convert a triad (rootPc + quality) to a simple chord symbol (e.g., C, Cm, Cdim, C+)\nconst PC_TO_NAME = ['C','C#','D','Eb','E','F','F#','G','Ab','A','Bb','B'] as const;\nexport function triadToChordSym(t: { rootPc: Pc; quality: TriadQuality }): string {\n  const root = PC_TO_NAME[t.rootPc % 12];\n  if (t.quality === 'maj') return root;\n  if (t.quality === 'min') return root + 'm';\n  if (t.quality === 'dim') return root + 'dim';\n  return root + '+'; // aug\n}\n\n\n"],"names":[],"mappings":";;;;;;;;AAYO,SAAS,eAAe,EAAE,OAAO,EAAE,cAAc,EAA4C;IAClG,MAAM,MAAM,eAAe,GAAG,CAAC,CAAA,KAAM,CAAC,UAAU,KAAK,GAAG,IAAI;IAC5D,MAAM,SAA0B,EAAE;IAClC,IAAK,IAAI,IAAI,GAAG,IAAI,GAAG,IAAK;QAC1B,MAAM,MAAO,IAAI;QACjB,MAAM,IAAI,GAAG,CAAC,IAAI;QAClB,MAAM,IAAI,GAAG,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE;QAC5B,MAAM,IAAI,GAAG,CAAC,CAAC,MAAM,CAAC,IAAI,EAAE;QAC5B,MAAM,IAAI,eAAe,GAAG,GAAG;QAC/B,OAAO,IAAI,CAAC;YAAE,QAAS,IAAE;YAAqB,QAAQ;YAAG,KAAK;gBAAC;gBAAE;gBAAE;aAAE;YAAE,SAAS;QAAE;IACpF;IACA,OAAO;AACT;AAEA,SAAS,eAAe,CAAS,EAAE,CAAS,EAAE,CAAS;IACrD,4CAA4C;IAC5C,MAAM,QAAQ,CAAC,IAAI,IAAI,EAAE,IAAI;IAC7B,MAAM,QAAQ,CAAC,IAAI,IAAI,EAAE,IAAI;IAC7B,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,IAAI,UAAU,KAAK,UAAU,GAAG,OAAO;IACvC,qCAAqC;IACrC,IAAI,UAAU,GAAG,OAAO;IACxB,IAAI,UAAU,GAAG,OAAO;IACxB,OAAO,QAAQ,IAAI,QAAQ;AAC7B;AAEA,MAAM,WAAW;IAAC;IAAI;IAAK;IAAM;IAAK;IAAI;IAAK;CAAM;AAE9C,SAAS,aAAa,MAAqB,EAAE,OAAqB,EAAE,IAAmC;IAC5G,MAAM,OAAO,QAAQ,CAAC,SAAS,EAAE;IACjC,MAAM,OAAO,MAAM,QAAQ;IAC3B,IAAI,SAAS,SAAS;QACpB,2CAA2C;QAC3C,IAAI,YAAY,OAAO,OAAO,OAAO;QACrC,IAAI,YAAY,OAAO,OAAO,OAAO;QACrC,OAAO;IACT;IACA,6EAA6E;IAC7E,IAAI,YAAY,OAAO,OAAO,KAAK,WAAW;IAC9C,IAAI,YAAY,OAAO,OAAO,KAAK,WAAW,KAAK;IACnD,IAAI,YAAY,OAAO,OAAO,OAAO;IACrC,OAAO,MAAM,MAAM;AACrB;AAEA,sFAAsF;AACtF,MAAM,aAAa;IAAC;IAAI;IAAK;IAAI;IAAK;IAAI;IAAI;IAAK;IAAI;IAAK;IAAI;IAAK;CAAI;AAClE,SAAS,gBAAgB,CAAwC;IACtE,MAAM,OAAO,UAAU,CAAC,EAAE,MAAM,GAAG,GAAG;IACtC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO;IAChC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO,OAAO;IACvC,IAAI,EAAE,OAAO,KAAK,OAAO,OAAO,OAAO;IACvC,OAAO,OAAO,KAAK,MAAM;AAC3B","debugId":null}},
    {"offset": {"line": 3305, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/capo/recommend.ts"],"sourcesContent":["// Capo recommendation utilities\n// Heuristic scoring favoring open-string friendly shapes\n\nexport type KeySel = { tonic: number; mode: 'major'|'minor'|'Major'|'Minor' };\nexport type ScaleSel = { type: string; tonic?: number };\n\nexport function classifyScaleFlavor(scaleType: string): 'majorish'|'minorish' {\n  const maj = ['Major','Ionian','Lydian','Mixolydian','Major Pentatonic'];\n  const t = scaleType.toLowerCase();\n  for (const s of maj) if (t.includes(s.toLowerCase())) return 'majorish';\n  return 'minorish';\n}\n\n// Open-chord ease per family (I..VII)\nconst MAJOR_FAMILY_SCORES: Record<'C'|'G'|'D'|'A'|'E', number[]> = {\n  C: [3,3,3,1,3,3,0],\n  G: [3,3,1,3,3,3,0],\n  D: [3,3,1,3,3,1,0],\n  A: [3,1,1,3,2,1,0],\n  E: [3,1,0,3,1,1,0],\n};\n\nconst MINOR_FAMILY_SCORES: Record<'Am'|'Em'|'Dm', number[]> = {\n  Am: [3,0,3,3,3,1,3],\n  Em: [3,0,3,3,1,3,3],\n  Dm: [3,0,1,0,3,0,3],\n};\n\nfunction fretWeight(n: number) {\n  if (n <= 5) return 1.0;\n  if (n <= 7) return 0.92;\n  if (n <= 9) return 0.82;\n  return 0.7;\n}\n\nexport function transposeDown(pc: number, n: number) {\n  return ((pc - n) % 12 + 12) % 12;\n}\n\nexport type CapoPick = {\n  capo: number;\n  playAs: string;\n  score: number;\n  reasons: string[];\n};\n\nconst NATURAL_NAME: Record<number,string> = {\n  0:'C',1:'C#',2:'D',3:'Eb',4:'E',5:'F',6:'F#',7:'G',8:'Ab',9:'A',10:'Bb',11:'B'\n};\n\nexport function recommendCapos(key: KeySel, scale: ScaleSel, topN = 3, opts: { includeOpen?: boolean } = {}): CapoPick[] {\n  const includeOpen = opts.includeOpen ?? true;\n  const flavor = classifyScaleFlavor(scale.type);\n  const picks: CapoPick[] = [];\n\n  for (let n = 0; n <= 11; n++) {\n    if (!includeOpen && n === 0) continue;\n    const shapedPc = transposeDown(key.tonic, n);\n    const name = NATURAL_NAME[shapedPc];\n    if (flavor === 'majorish') {\n      const famMap: Record<string, keyof typeof MAJOR_FAMILY_SCORES> = { C:'C', G:'G', D:'D', A:'A', E:'E' };\n      const fam = famMap[name];\n      if (!fam) continue;\n      const base = MAJOR_FAMILY_SCORES[fam].reduce((a,b)=>a+b,0);\n      const bonus = (MAJOR_FAMILY_SCORES[fam][0] >= 2 && MAJOR_FAMILY_SCORES[fam][3] >= 2 && MAJOR_FAMILY_SCORES[fam][4] >= 2) ? 2 : 0;\n      const score = (base + bonus) * fretWeight(n);\n      picks.push({ capo: n, playAs: fam, score, reasons: [ `I–IV–V ${bonus? '◎':'○'}`, `open ${base}/16`, n===0? 'open' : `capo ${n}` ]});\n    } else {\n      const famMap: Record<string, keyof typeof MINOR_FAMILY_SCORES> = { A:'Am', E:'Em', D:'Dm' };\n      const fam = famMap[name];\n      if (!fam) continue;\n      const base = MINOR_FAMILY_SCORES[fam].reduce((a,b)=>a+b,0);\n      const bonus = (MINOR_FAMILY_SCORES[fam][0] >= 2 && MINOR_FAMILY_SCORES[fam][3] >= 2) ? 2 : 0;\n      const score = (base + bonus) * fretWeight(n);\n      picks.push({ capo: n, playAs: fam, score, reasons: [ `i–iv ${bonus? '◎':'○'}`, `open ${base}/16`, n===0? 'open' : `capo ${n}` ]});\n    }\n  }\n\n  return picks.sort((a,b)=> b.score-a.score).slice(0, topN);\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3487, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/store/analysisStore.ts"],"sourcesContent":["import { create } from \"zustand\";\nimport { type Pc, type Mode, type ChordSym, scoreKeyCandidates } from \"@/lib/theory\";\nimport { scoreScales, type ScaleCandidate } from \"@/lib/analysis/scoreScales\";\nimport { progressionToRoman } from \"@/lib/roman\";\nimport { SCALE_INTERVALS, type ScaleType, parentModeOf } from \"@/lib/scales\";\nimport { diatonicTriads, romanOfTriad } from \"@/lib/theory/diatonic\";\nimport type { CapoOption } from \"@/lib/theory/capo\";\nimport { recommendCapos, type CapoPick } from \"@/lib/capo/recommend\";\n// Type-only import for ScaleId; using relative alias path per tsconfig\n// Avoid type import resolution issue in some toolchains by using a relative path string literal type\ntype ScaleId = 'major'|'natural_minor'|'mixolydian'|'lydian'|'major_pentatonic'|'minor_pentatonic';\n\nexport type Candidate = { tonic: Pc; mode: Mode; confidence: number; reasons: string[] };\nexport type FitTag = \"diatonic\"|\"secondary\"|\"borrowed\"|\"outside\";\nexport type ViewMode = \"sounding\"|\"shaped\"|\"compare\";\n\ntype AnalysisState = {\n  keyCandidates: Candidate[];\n  selectedKey?: { tonic: Pc; mode: Mode };\n  analysis?: { cadence?: string; perChordFit?: FitTag[] };\n  capo: { capo: number; shapedKey: string } | null;\n  viewMode: ViewMode;\n  scaleCandidates: ScaleCandidate[];\n  selectedScale: ScaleCandidate | null;\n  lastProg?: ChordSym[];\n  analyze: (prog: ChordSym[]) => void;\n  selectKey: (key: {tonic: Pc; mode: Mode}) => void;\n  selectScale: (s: ScaleCandidate) => void;\n  chooseCapo: (option: CapoOption) => void;\n  setViewMode: (v: ViewMode) => void;\n  reset: () => void;\n  romanTokens: string[];\n  romanText: string;\n  diatonic: { triads: ReturnType<typeof diatonicTriads>; romans: string[] } | null;\n  recommendedCapos: CapoPick[];\n};\n\nexport const useAnalysisStore = create<AnalysisState>((set, get) => ({\n  keyCandidates: [],\n  capo: null,\n  viewMode: \"sounding\",\n  scaleCandidates: [],\n  selectedScale: null,\n  romanTokens: [],\n  romanText: \"\",\n  diatonic: null,\n  recommendedCapos: [],\n  analyze: (prog) => {\n    set((state)=>{\n      const cands = scoreKeyCandidates(prog);\n      // 既存選択がある場合でも、トップ候補と±4pt以上差があればトップへ切替（誤維持防止）\n      const top = cands[0];\n      const keep = state.selectedKey && cands.find(c=> c.tonic===state.selectedKey!.tonic && c.mode===state.selectedKey!.mode);\n      const shouldKeep = (()=>{\n        if (!keep || !top) return false;\n        const diff = Math.abs((keep.confidence||0) - (top.confidence||0));\n        return diff < 4; // 近差のみ維持\n      })();\n      const nextSel = (shouldKeep && state.selectedKey) ? state.selectedKey : (top ? { tonic: top.tonic, mode: top.mode } : undefined);\n      const sc = nextSel ? scoreScales(prog, { root: nextSel.tonic, mode: nextSel.mode }) : [];\n      const selScale = sc[0] ?? null;\n      const romanTokens = nextSel && selScale ? progressionToRoman(prog, nextSel.tonic, selScale.type) : [];\n      const diatonic = (()=>{\n        if (!nextSel || !selScale) return null;\n        const tonic = nextSel.tonic;\n        let st = selScale.type as ScaleType;\n        let intervals = SCALE_INTERVALS[st] ?? [];\n        if (intervals.length < 7) {\n          const parent = parentModeOf(st);\n          if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n        }\n        if (!intervals.length) return null;\n        const triads = diatonicTriads({ tonicPc: tonic, scaleIntervals: intervals });\n        const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n        return { triads, romans };\n      })();\n      const recommendedCapos = nextSel && selScale ? recommendCapos({ tonic: nextSel.tonic as any, mode: nextSel.mode as any }, { type: selScale.type as any }, 3, { includeOpen: false }) : [];\n      return { keyCandidates: cands, selectedKey: nextSel, scaleCandidates: sc, selectedScale: selScale, lastProg: prog, romanTokens, romanText: romanTokens.join(\" – \"), diatonic, recommendedCapos } as Partial<AnalysisState> as AnalysisState;\n    });\n  },\n  selectKey: (key) => set((state)=>{\n    const prog = state.lastProg ?? [];\n    const sc = scoreScales(prog, { root: key.tonic, mode: key.mode });\n    const selScale = sc[0] ?? null;\n    const romanTokens = selScale ? progressionToRoman(prog, key.tonic, selScale.type) : [];\n    const diatonic = (()=>{\n      if (!selScale) return null;\n      let st = selScale.type as ScaleType;\n      let intervals = SCALE_INTERVALS[st] ?? [];\n      if (intervals.length < 7) {\n        const parent = parentModeOf(st);\n        if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n      }\n      if (!intervals.length) return null;\n      const triads = diatonicTriads({ tonicPc: key.tonic, scaleIntervals: intervals });\n      const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n      return { triads, romans };\n    })();\n    const recommendedCapos = selScale ? recommendCapos({ tonic: key.tonic as any, mode: key.mode as any }, { type: selScale.type as any }, 3, { includeOpen: false }) : [];\n    return { selectedKey: key, scaleCandidates: sc, selectedScale: selScale, romanTokens, romanText: romanTokens.join(\" – \"), diatonic, recommendedCapos };\n  }),\n  selectScale: (s) => set((state)=>{\n    const prog = state.lastProg ?? [];\n    const key = state.selectedKey;\n    const tokens = prog.length && key ? progressionToRoman(prog, key.tonic, s.type) : [];\n    const diatonic = (()=>{\n      if (!key) return null;\n      let st = s.type as ScaleType;\n      let intervals = SCALE_INTERVALS[st] ?? [];\n      if (intervals.length < 7) {\n        const parent = parentModeOf(st);\n        if (parent) { st = parent; intervals = SCALE_INTERVALS[parent] ?? []; }\n      }\n      if (!intervals.length) return null;\n      const triads = diatonicTriads({ tonicPc: key.tonic, scaleIntervals: intervals });\n      const romans = triads.map(t => romanOfTriad(t.degree, t.quality, { case: 'upper' }));\n      return { triads, romans };\n    })();\n    const recommendedCapos = key ? recommendCapos({ tonic: key.tonic as any, mode: key.mode as any }, { type: s.type as any }, 3, { includeOpen: false }) : [];\n    return { selectedScale: s, romanTokens: tokens, romanText: tokens.join(\" – \"), diatonic, recommendedCapos };\n  }),\n  chooseCapo: (option) => set({ capo: { capo: option.capo, shapedKey: option.shapedKey } }),\n  setViewMode: (v) => set({ viewMode: v }),\n  reset: () => set({ keyCandidates: [], selectedKey: undefined, analysis: undefined, capo: null, viewMode: \"sounding\", scaleCandidates: [], selectedScale: null, lastProg: [] }),\n}));\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 3700, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/theory/capo.ts"],"sourcesContent":["// Simple capo advisor based on friendly open-chord shapes\n// PITCHESは lib/music/constants.ts に統一\nimport { PC_NAMES } from '../music/constants';\ntype Pitch = typeof PC_NAMES[number];\nexport type Mode = 'major'|'minor';\n// 外部で使用するためにエクスポート\nexport const PITCHES = PC_NAMES;\n\nconst SHAPES_MAJOR: {key: Pitch, label: string, weight: number}[] = [\n  { key: 'C', label: 'C', weight: 1.0 },\n  { key: 'G', label: 'G', weight: 1.0 },\n  { key: 'D', label: 'D', weight: 0.95 },\n  { key: 'A', label: 'A', weight: 0.9 },\n  { key: 'E', label: 'E', weight: 0.9 },\n];\nconst SHAPES_MINOR: {key: Pitch, label: string, weight: number}[] = [\n  { key: 'A', label: 'Am', weight: 1.0 },\n  { key: 'E', label: 'Em', weight: 1.0 },\n  { key: 'D', label: 'Dm', weight: 0.8 },\n];\n\nfunction idx(p: string){ const n = p.replace('♭','b').replace('＃','#'); \n  const map: Record<string, Pitch> = { 'Db':'C#','D#':'Eb','Gb':'F#','G#':'Ab','A#':'Bb' } as any;\n  const canon = (map[n as Pitch] || n);\n  return PC_NAMES.indexOf(canon as Pitch);\n}\nconst dist = (from:number,to:number)=> (to-from+12)%12;\n\nexport type CapoOption = {\n  capo: number;\n  shapedKey: string;\n  sounding: { tonic: Pitch, mode: Mode };\n  score: number;\n  notes: string[];\n};\n\nexport function suggestCapoOptions(target: { tonic: string, mode: Mode }): CapoOption[] {\n  const targetIdx = idx(target.tonic);\n  const shapes = target.mode === 'minor' ? SHAPES_MINOR : SHAPES_MAJOR;\n  const options = shapes.map(s => {\n    const capo = dist(idx(s.key), targetIdx);\n    const capoPenalty = capo <= 2 ? 0 : capo <= 4 ? 0.1 : capo <= 6 ? 0.25 : 0.4;\n    const score = s.weight - capoPenalty;\n    const notes: string[] = [];\n    if (capo <= 2) notes.push('Low position');\n    if (capo >= 6) notes.push('Higher position (thinner tone)');\n    if (/^(E|A|C|G)/.test(s.label)) notes.push('Many open strings');\n    return {\n      capo,\n      shapedKey: target.mode === 'minor' ? s.label : s.label,\n      sounding: { tonic: PC_NAMES[targetIdx], mode: target.mode },\n      score,\n      notes\n    } as CapoOption;\n  }).sort((a,b)=> b.score-a.score);\n  const picked: CapoOption[] = [];\n  for (const o of options) if (!picked.some(p=>p.capo===o.capo)) picked.push(o);\n  return picked.slice(0,3);\n}\n\n\n\n\n\n\n\n\n\n\n\n"],"names":[],"mappings":"AAAA,0DAA0D;AAC1D,sCAAsC;;;;;;;AACtC;;AAIO,MAAM,UAAU,4IAAQ;AAE/B,MAAM,eAA8D;IAClE;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAK;IACrC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;IACpC;QAAE,KAAK;QAAK,OAAO;QAAK,QAAQ;IAAI;CACrC;AACD,MAAM,eAA8D;IAClE;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;IACrC;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;IACrC;QAAE,KAAK;QAAK,OAAO;QAAM,QAAQ;IAAI;CACtC;AAED,SAAS,IAAI,CAAS;IAAG,MAAM,IAAI,EAAE,OAAO,CAAC,KAAI,KAAK,OAAO,CAAC,KAAI;IAChE,MAAM,MAA6B;QAAE,MAAK;QAAK,MAAK;QAAK,MAAK;QAAK,MAAK;QAAK,MAAK;IAAK;IACvF,MAAM,QAAS,GAAG,CAAC,EAAW,IAAI;IAClC,OAAO,4IAAQ,CAAC,OAAO,CAAC;AAC1B;AACA,MAAM,OAAO,CAAC,MAAY,KAAa,CAAC,KAAG,OAAK,EAAE,IAAE;AAU7C,SAAS,mBAAmB,MAAqC;IACtE,MAAM,YAAY,IAAI,OAAO,KAAK;IAClC,MAAM,SAAS,OAAO,IAAI,KAAK,UAAU,eAAe;IACxD,MAAM,UAAU,OAAO,GAAG,CAAC,CAAA;QACzB,MAAM,OAAO,KAAK,IAAI,EAAE,GAAG,GAAG;QAC9B,MAAM,cAAc,QAAQ,IAAI,IAAI,QAAQ,IAAI,MAAM,QAAQ,IAAI,OAAO;QACzE,MAAM,QAAQ,EAAE,MAAM,GAAG;QACzB,MAAM,QAAkB,EAAE;QAC1B,IAAI,QAAQ,GAAG,MAAM,IAAI,CAAC;QAC1B,IAAI,QAAQ,GAAG,MAAM,IAAI,CAAC;QAC1B,IAAI,aAAa,IAAI,CAAC,EAAE,KAAK,GAAG,MAAM,IAAI,CAAC;QAC3C,OAAO;YACL;YACA,WAAW,OAAO,IAAI,KAAK,UAAU,EAAE,KAAK,GAAG,EAAE,KAAK;YACtD,UAAU;gBAAE,OAAO,4IAAQ,CAAC,UAAU;gBAAE,MAAM,OAAO,IAAI;YAAC;YAC1D;YACA;QACF;IACF,GAAG,IAAI,CAAC,CAAC,GAAE,IAAK,EAAE,KAAK,GAAC,EAAE,KAAK;IAC/B,MAAM,SAAuB,EAAE;IAC/B,KAAK,MAAM,KAAK,QAAS,IAAI,CAAC,OAAO,IAAI,CAAC,CAAA,IAAG,EAAE,IAAI,KAAG,EAAE,IAAI,GAAG,OAAO,IAAI,CAAC;IAC3E,OAAO,OAAO,KAAK,CAAC,GAAE;AACxB","debugId":null}},
    {"offset": {"line": 3798, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/DiatonicCapoTable.tsx"],"sourcesContent":["\"use client\";\nimport React, { useRef, useCallback } from \"react\";\nimport { useAnalysisStore } from \"@/store/analysisStore\";\nimport { diatonicTriads, triadToChordSym } from \"@/lib/theory/diatonic\";\nimport { romanDegreeLabelsForScale, SCALE_INTERVALS, type ScaleType, parentModeOf } from \"@/lib/scales\";\nimport { recommendCapos } from \"@/lib/capo/recommend\";\nimport { PITCHES } from \"@/lib/theory/capo\";\n\nexport type OnPickArgs = { id: string; row: 'open' | `capo${number}`; degree: number; pcs: number[]; capo: number; isRightClick?: boolean };\nexport default function DiatonicCapoTable({ onPick, selectedId, onSelectId }: { onPick?: (p: OnPickArgs) => void; selectedId?: string | null; onSelectId?: (id: string) => void }) {\n  const selectedKey = useAnalysisStore(s => (s as any).selectedKey);\n  const selectedScale = useAnalysisStore(s => (s as any).selectedScale);\n  const degreeLabels = romanDegreeLabelsForScale(selectedScale?.type ?? 'Ionian');\n  const toFancy = (s: string) => s.replaceAll('b','♭').replaceAll('#','♯');\n  const cellBase = \"px-2 py-1 text-center border rounded-[var(--chip-br)]\";\n  const cellNeutral = \"border-neutral-300 dark:border-neutral-700\";\n  const cellOpen = \"bg-emerald-50 border-emerald-200 text-emerald-900 dark:bg-emerald-800/25 dark:border-emerald-700 dark:text-emerald-100\";\n\n  // Mobile long-press support\n  const longPressTimerRef = useRef<NodeJS.Timeout | null>(null);\n  const longPressTriggeredRef = useRef(false);\n\n  const handleTouchStart = useCallback((i: number, sym: string, pcs: number[]) => {\n    longPressTriggeredRef.current = false;\n    longPressTimerRef.current = setTimeout(() => {\n      longPressTriggeredRef.current = true;\n      const confirmed = window.confirm(`Add \"${sym}\" to progression?`);\n      if (confirmed) {\n        const id = `open-${i}`;\n        onSelectId?.(id);\n        onPick?.({ id, row: 'open', degree: i, pcs, capo: 0, isRightClick: true });\n      }\n    }, 500); // 500ms long press\n  }, [onPick, onSelectId]);\n\n  const handleTouchEnd = useCallback(() => {\n    if (longPressTimerRef.current) {\n      clearTimeout(longPressTimerRef.current);\n      longPressTimerRef.current = null;\n    }\n  }, []);\n\n  const openCells = React.useMemo(() => {\n    if (!selectedKey || !selectedScale) return Array(7).fill({ sym:'—', pcs:[] as number[] });\n    let st = selectedScale.type as ScaleType;\n    let ivs = SCALE_INTERVALS[st] ?? [];\n    if (ivs.length !== 7) {\n      const parent = parentModeOf(st);\n      if (parent) ivs = SCALE_INTERVALS[parent] ?? [];\n    }\n    if (ivs.length !== 7) return Array(7).fill({ sym:'—', pcs:[] as number[] });\n    const tris = diatonicTriads({ tonicPc: selectedKey.tonic, scaleIntervals: ivs });\n    return tris.map(t => ({ sym: triadToChordSym({ rootPc: t.rootPc, quality: t.quality }), pcs: t.pcs }));\n  }, [selectedKey, selectedScale]);\n\n  const capoRows = React.useMemo(() => {\n    if (!selectedKey || !selectedScale) return [] as Array<{ capo:number; label:string; cells:string[]; cellsPcs:number[][]; tooltip?:string }>;\n    const modeLabel = (selectedKey.mode === 'Major' || selectedKey.mode === 'Minor') ? selectedKey.mode : ((selectedKey.mode as any) === 'major' ? 'Major' : 'Minor');\n    const picks = recommendCapos({ tonic: selectedKey.tonic, mode: modeLabel as any }, { type: selectedScale.type as any }, 3, { includeOpen: true });\n    const nonZero = picks.filter(p => p.capo !== 0).sort((a,b)=> a.capo - b.capo).slice(0,2);\n    return nonZero.map(p => {\n      const playAs = p.playAs; // e.g., G or Am\n      const isMinor = /m$/.test(playAs);\n      const name = isMinor ? playAs.replace(/m$/,'') : playAs;\n      const pc = PITCHES.indexOf(name as any);\n      let st = selectedScale.type as ScaleType;\n      let ivs = SCALE_INTERVALS[st] ?? [];\n      if (ivs.length !== 7) {\n        const parent = parentModeOf(st);\n        if (parent) ivs = SCALE_INTERVALS[parent] ?? [];\n      }\n      const tris = ivs.length===7 ? diatonicTriads({ tonicPc: pc, scaleIntervals: ivs }) : [];\n      const cells = (tris.length? tris : Array(7).fill(null)).map((t:any)=> t ? triadToChordSym({ rootPc: t.rootPc, quality: t.quality }) : '—');\n      const cellsPcs = (tris.length? tris : Array(7).fill(null)).map((t:any)=> t ? (t.pcs as number[]) : []);\n      return { capo: p.capo, label: `Capo ${p.capo}`, cells, cellsPcs, tooltip: `Play as ${playAs}${(p.reasons&&p.reasons.length? ' · ' + p.reasons.join(' · ') : '')}` };\n    });\n  }, [selectedKey, selectedScale]);\n\n  const header = degreeLabels.map(toFancy);\n\n  return (\n    <div className=\"overflow-x-auto capo-compact capo-compact--tight\" aria-live=\"polite\" aria-labelledby=\"diatonic-title\">\n      <table className=\"w-full border-separate rounded-xl border text-sm md:text-[0.95rem]\" style={{ borderSpacing: '6px' }}>\n        <colgroup>\n          <col className=\"w-12 sm:w-14 md:w-18\" />\n          <col span={7} />\n        </colgroup>\n        <thead>\n          <tr>\n            <th scope=\"col\" className=\"px-1 py-0 text-center text-sm font-medium border-none bg-transparent rounded-none\"></th>\n            {header.map((d,i)=> (\n              <th key={`hdr-${i}`} scope=\"col\" className=\"px-1 py-0 text-center text-sm font-medium border-none bg-transparent rounded-none\">{d}</th>\n            ))}\n          </tr>\n        </thead>\n        <tbody>\n          <tr data-row=\"open\">\n            <th scope=\"row\" className=\"px-1 py-0 text-center text-xs font-normal border-none bg-transparent rounded-none text-foreground/70\" title=\"Open (no capo)\">Open</th>\n            {openCells.map((c, i)=> (\n              // cell id unique: open-<degreeIndex>\n              <td\n                key={`open-${i}`}\n                className={[cellBase, cellOpen, onPick ? 'cursor-pointer select-none tapfx' : '', (selectedId === `open-${i}` ? 'ring-2 ring-emerald-400/60 dia-cell--active' : 'dia-cell--idle')].join(' ')}\n                onClick={(e) => {\n                  if ((e as unknown as MouseEvent).button === 2) return; // 右クリックは無視\n                  if (longPressTriggeredRef.current) { longPressTriggeredRef.current = false; return; } // 長押し後のクリックを無視\n                  const id = `open-${i}`; onSelectId?.(id); onPick?.({ id, row: 'open', degree: i, pcs: c.pcs, capo: 0 });\n                }}\n                onContextMenu={(e) => {\n                  e.preventDefault();\n                  e.stopPropagation();\n                  const confirmed = window.confirm(`Add \"${c.sym}\" to progression?`);\n                  if (confirmed) {\n                    const id = `open-${i}`;\n                    onSelectId?.(id);\n                    onPick?.({ id, row: 'open', degree: i, pcs: c.pcs, capo: 0, isRightClick: true });\n                  }\n                }}\n                onTouchStart={() => handleTouchStart(i, c.sym, c.pcs)}\n                onTouchEnd={handleTouchEnd}\n                onTouchCancel={handleTouchEnd}\n                role={onPick ? 'button' : undefined}\n                aria-label={onPick ? `Open ${c.sym}` : undefined}\n                aria-pressed={selectedId === `open-${i}`}\n              >{c.sym}</td>\n            ))}\n          </tr>\n          {capoRows.map((r)=> (\n            <tr key={`capo-${r.capo}`}>\n              <th scope=\"row\" className=\"px-1 py-0 text-center text-xs font-normal border-none bg-transparent rounded-none text-foreground/70\" title={r.tooltip}>{r.label}</th>\n              {r.cells.map((c, i)=> (\n                <td\n                  key={`capo-${r.capo}-${i}`}\n                  className={[cellBase, cellNeutral, 'opacity-65 cursor-default pointer-events-none', (selectedId === `capo${r.capo}-${i}` ? 'dia-cell--active' : 'dia-cell--idle')].join(' ')}\n                  role=\"button\"\n                  tabIndex={-1}\n                  aria-disabled=\"true\"\n                  aria-label={`${r.label} ${c}`}\n                >{c}</td>\n              ))}\n            </tr>\n          ))}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4125, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/hooks/useRovingTabs.ts"],"sourcesContent":["\"use client\";\n\nimport { useEffect } from \"react\";\n\ntype Options = {\n  itemSelector?: string;\n  orientation?: \"horizontal\" | \"vertical\" | \"both\";\n  includeHomeEnd?: boolean;\n};\n\nexport function useRovingTabs(root: React.RefObject<HTMLElement | null>, options: Options = {}) {\n  const {\n    itemSelector = '[role=\"tab\"],[data-roving=\"item\"]',\n    orientation = \"horizontal\",\n    includeHomeEnd = true,\n  } = options;\n\n  useEffect(() => {\n    const el = root.current;\n    if (!el) return;\n\n    const getItems = () => Array.from(el.querySelectorAll<HTMLElement>(itemSelector)).filter((node) => !node.hasAttribute(\"disabled\"));\n    const setTabIndex = (items: HTMLElement[], idx: number) => {\n      items.forEach((node, i) => (node.tabIndex = i === idx ? 0 : -1));\n    };\n\n    const applyInitial = () => {\n      const items = getItems();\n      if (!items.length) return;\n      let index = items.findIndex((node) => node.getAttribute(\"aria-selected\") === \"true\" || node.tabIndex === 0 || node === document.activeElement);\n      if (index < 0) index = 0;\n      setTabIndex(items, index);\n    };\n\n    applyInitial();\n\n    const onKey = (event: KeyboardEvent) => {\n      const items = getItems();\n      if (!items.length) return;\n      const currentIndex = items.indexOf(document.activeElement as HTMLElement);\n      if (currentIndex < 0) return;\n\n      const { key } = event;\n      const horizontal = orientation === \"horizontal\" || orientation === \"both\";\n      const vertical = orientation === \"vertical\" || orientation === \"both\";\n      let nextIndex = -1;\n\n      if (horizontal && key === \"ArrowRight\") nextIndex = (currentIndex + 1) % items.length;\n      if (horizontal && key === \"ArrowLeft\") nextIndex = (currentIndex - 1 + items.length) % items.length;\n      if (vertical && key === \"ArrowDown\") nextIndex = (currentIndex + 1) % items.length;\n      if (vertical && key === \"ArrowUp\") nextIndex = (currentIndex - 1 + items.length) % items.length;\n\n      if (nextIndex >= 0) {\n        event.preventDefault();\n        setTabIndex(items, nextIndex);\n        items[nextIndex].focus({ preventScroll: true });\n        return;\n      }\n\n      if (includeHomeEnd && key === \"Home\") {\n        event.preventDefault();\n        setTabIndex(items, 0);\n        items[0].focus({ preventScroll: true });\n        return;\n      }\n\n      if (includeHomeEnd && key === \"End\") {\n        event.preventDefault();\n        const last = items.length - 1;\n        setTabIndex(items, last);\n        items[last].focus({ preventScroll: true });\n      }\n    };\n\n    el.addEventListener(\"keydown\", onKey);\n    return () => {\n      el.removeEventListener(\"keydown\", onKey);\n    };\n  }, [root, itemSelector, orientation, includeHomeEnd]);\n}\n\n\n\n\n\n"],"names":[],"mappings":";;;;AAEA;AAFA;;AAUO,SAAS,cAAc,IAAyC,EAAE,UAAmB,CAAC,CAAC;IAC5F,MAAM,EACJ,eAAe,mCAAmC,EAClD,cAAc,YAAY,EAC1B,iBAAiB,IAAI,EACtB,GAAG;IAEJ,IAAA,kNAAS,EAAC;QACR,MAAM,KAAK,KAAK,OAAO;QACvB,IAAI,CAAC,IAAI;QAET,MAAM,WAAW,IAAM,MAAM,IAAI,CAAC,GAAG,gBAAgB,CAAc,eAAe,MAAM,CAAC,CAAC,OAAS,CAAC,KAAK,YAAY,CAAC;QACtH,MAAM,cAAc,CAAC,OAAsB;YACzC,MAAM,OAAO,CAAC,CAAC,MAAM,IAAO,KAAK,QAAQ,GAAG,MAAM,MAAM,IAAI,CAAC;QAC/D;QAEA,MAAM,eAAe;YACnB,MAAM,QAAQ;YACd,IAAI,CAAC,MAAM,MAAM,EAAE;YACnB,IAAI,QAAQ,MAAM,SAAS,CAAC,CAAC,OAAS,KAAK,YAAY,CAAC,qBAAqB,UAAU,KAAK,QAAQ,KAAK,KAAK,SAAS,SAAS,aAAa;YAC7I,IAAI,QAAQ,GAAG,QAAQ;YACvB,YAAY,OAAO;QACrB;QAEA;QAEA,MAAM,QAAQ,CAAC;YACb,MAAM,QAAQ;YACd,IAAI,CAAC,MAAM,MAAM,EAAE;YACnB,MAAM,eAAe,MAAM,OAAO,CAAC,SAAS,aAAa;YACzD,IAAI,eAAe,GAAG;YAEtB,MAAM,EAAE,GAAG,EAAE,GAAG;YAChB,MAAM,aAAa,gBAAgB,gBAAgB,gBAAgB;YACnE,MAAM,WAAW,gBAAgB,cAAc,gBAAgB;YAC/D,IAAI,YAAY,CAAC;YAEjB,IAAI,cAAc,QAAQ,cAAc,YAAY,CAAC,eAAe,CAAC,IAAI,MAAM,MAAM;YACrF,IAAI,cAAc,QAAQ,aAAa,YAAY,CAAC,eAAe,IAAI,MAAM,MAAM,IAAI,MAAM,MAAM;YACnG,IAAI,YAAY,QAAQ,aAAa,YAAY,CAAC,eAAe,CAAC,IAAI,MAAM,MAAM;YAClF,IAAI,YAAY,QAAQ,WAAW,YAAY,CAAC,eAAe,IAAI,MAAM,MAAM,IAAI,MAAM,MAAM;YAE/F,IAAI,aAAa,GAAG;gBAClB,MAAM,cAAc;gBACpB,YAAY,OAAO;gBACnB,KAAK,CAAC,UAAU,CAAC,KAAK,CAAC;oBAAE,eAAe;gBAAK;gBAC7C;YACF;YAEA,IAAI,kBAAkB,QAAQ,QAAQ;gBACpC,MAAM,cAAc;gBACpB,YAAY,OAAO;gBACnB,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC;oBAAE,eAAe;gBAAK;gBACrC;YACF;YAEA,IAAI,kBAAkB,QAAQ,OAAO;gBACnC,MAAM,cAAc;gBACpB,MAAM,OAAO,MAAM,MAAM,GAAG;gBAC5B,YAAY,OAAO;gBACnB,KAAK,CAAC,KAAK,CAAC,KAAK,CAAC;oBAAE,eAAe;gBAAK;YAC1C;QACF;QAEA,GAAG,gBAAgB,CAAC,WAAW;QAC/B,OAAO;YACL,GAAG,mBAAmB,CAAC,WAAW;QACpC;IACF,GAAG;QAAC;QAAM;QAAc;QAAa;KAAe;AACtD","debugId":null}},
    {"offset": {"line": 4202, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ui/InfoDot.tsx"],"sourcesContent":["\"use client\";\nimport { useEffect, useRef, useState, useLayoutEffect, type ReactNode } from \"react\";\nimport { createPortal } from \"react-dom\";\n\ntype Props = {\n  text?: string;                    // plain text (optional when using children)\n  title?: string;                   // optional title in the card\n  children?: ReactNode;             // custom body content\n  className?: string;\n  linkHref?: string;\n  linkLabel?: string;\n  ariaLabel?: string;\n  icon?: 'info' | 'graduation';    // icon type\n};\n\nexport default function InfoDot({\n  text,\n  title,\n  children,\n  className = \"\",\n  linkHref,\n  linkLabel = \"Learn more\",\n  ariaLabel = \"More info\",\n  icon = 'info',\n}: Props) {\n  const [open, setOpen] = useState(false);\n  const ref = useRef<HTMLDivElement>(null);\n  const btnRef = useRef<HTMLButtonElement>(null);\n  const [coords, setCoords] = useState<{left:number; top:number; maxW:number}>({left:0, top:0, maxW:320});\n  useEffect(() => {\n    const onDoc = (e: MouseEvent) => {\n      if (ref.current && !ref.current.contains(e.target as Node)) setOpen(false);\n    };\n    const onEsc = (e: KeyboardEvent) => {\n      if (e.key === \"Escape\") setOpen(false);\n    };\n    document.addEventListener(\"click\", onDoc);\n    document.addEventListener(\"keydown\", onEsc);\n    return () => {\n      document.removeEventListener(\"click\", onDoc);\n      document.removeEventListener(\"keydown\", onEsc);\n    };\n  }, []);\n  useLayoutEffect(() => {\n    if (!open) return;\n    const update = () => {\n      if (!btnRef.current) return;\n      const r = btnRef.current.getBoundingClientRect();\n      const maxW = Math.min(Math.floor(window.innerWidth * 0.9), 360);\n      const left = Math.min(window.innerWidth - 8 - maxW, Math.max(8, Math.round(r.right - maxW)));\n      const top = Math.min(window.innerHeight - 8 - 120, Math.round(r.bottom + 6));\n      setCoords({ left, top, maxW });\n    };\n    update();\n    window.addEventListener(\"resize\", update);\n    window.addEventListener(\"scroll\", update, true);\n    return () => {\n      window.removeEventListener(\"resize\", update);\n      window.removeEventListener(\"scroll\", update, true);\n    };\n  }, [open]);\n\n  return (\n    <div ref={ref} className={`relative inline-flex items-center ${className}`}>\n      <button ref={btnRef} type=\"button\" className=\"info-dot\" aria-label={ariaLabel} onClick={() => setOpen((o) => !o)}>\n        {icon === 'graduation' ? (\n          <svg className=\"w-3 h-3\" viewBox=\"0 0 24 24\" fill=\"currentColor\">\n            <path d=\"M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z\"/>\n          </svg>\n        ) : (\n          'i'\n        )}\n      </button>\n      {open && createPortal(\n        (\n          <div\n            role=\"dialog\"\n            className=\"info-card\"\n            style={{\n              position: \"fixed\",\n              zIndex: 60,\n              left: `${coords.left}px`,\n              top: `${coords.top}px`,\n              maxWidth: `${coords.maxW}px`,\n            }}\n          >\n            {title && <div className=\"font-medium mb-1\">{title}</div>}\n            {children ? (\n              children\n            ) : (\n              (text ?? \"\").split(\"\\n\").map((line, i) => <div key={i}>{line}</div>)\n            )}\n            {linkHref && (\n              <div className=\"mt-2 text-right\">\n                <a href={linkHref} className=\"underline text-[12px] opacity-80\">\n                  {linkLabel}\n                </a>\n              </div>\n            )}\n          </div>\n        ),\n        document.body\n      )}\n    </div>\n  );\n}\n\n\n"],"names":[],"mappings":";;;;;AACA;AACA;AAFA;;;;AAee,SAAS,QAAQ,EAC9B,IAAI,EACJ,KAAK,EACL,QAAQ,EACR,YAAY,EAAE,EACd,QAAQ,EACR,YAAY,YAAY,EACxB,YAAY,WAAW,EACvB,OAAO,MAAM,EACP;IACN,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAC;IACjC,MAAM,MAAM,IAAA,+MAAM,EAAiB;IACnC,MAAM,SAAS,IAAA,+MAAM,EAAoB;IACzC,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAyC;QAAC,MAAK;QAAG,KAAI;QAAG,MAAK;IAAG;IACrG,IAAA,kNAAS,EAAC;QACR,MAAM,QAAQ,CAAC;YACb,IAAI,IAAI,OAAO,IAAI,CAAC,IAAI,OAAO,CAAC,QAAQ,CAAC,EAAE,MAAM,GAAW,QAAQ;QACtE;QACA,MAAM,QAAQ,CAAC;YACb,IAAI,EAAE,GAAG,KAAK,UAAU,QAAQ;QAClC;QACA,SAAS,gBAAgB,CAAC,SAAS;QACnC,SAAS,gBAAgB,CAAC,WAAW;QACrC,OAAO;YACL,SAAS,mBAAmB,CAAC,SAAS;YACtC,SAAS,mBAAmB,CAAC,WAAW;QAC1C;IACF,GAAG,EAAE;IACL,IAAA,wNAAe,EAAC;QACd,IAAI,CAAC,MAAM;QACX,MAAM,SAAS;YACb,IAAI,CAAC,OAAO,OAAO,EAAE;YACrB,MAAM,IAAI,OAAO,OAAO,CAAC,qBAAqB;YAC9C,MAAM,OAAO,KAAK,GAAG,CAAC,KAAK,KAAK,CAAC,OAAO,UAAU,GAAG,MAAM;YAC3D,MAAM,OAAO,KAAK,GAAG,CAAC,OAAO,UAAU,GAAG,IAAI,MAAM,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,EAAE,KAAK,GAAG;YACrF,MAAM,MAAM,KAAK,GAAG,CAAC,OAAO,WAAW,GAAG,IAAI,KAAK,KAAK,KAAK,CAAC,EAAE,MAAM,GAAG;YACzE,UAAU;gBAAE;gBAAM;gBAAK;YAAK;QAC9B;QACA;QACA,OAAO,gBAAgB,CAAC,UAAU;QAClC,OAAO,gBAAgB,CAAC,UAAU,QAAQ;QAC1C,OAAO;YACL,OAAO,mBAAmB,CAAC,UAAU;YACrC,OAAO,mBAAmB,CAAC,UAAU,QAAQ;QAC/C;IACF,GAAG;QAAC;KAAK;IAET,qBACE,8OAAC;QAAI,KAAK;QAAK,WAAW,CAAC,kCAAkC,EAAE,WAAW;;0BACxE,8OAAC;gBAAO,KAAK;gBAAQ,MAAK;gBAAS,WAAU;gBAAW,cAAY;gBAAW,SAAS,IAAM,QAAQ,CAAC,IAAM,CAAC;0BAC3G,SAAS,6BACR,8OAAC;oBAAI,WAAU;oBAAU,SAAQ;oBAAY,MAAK;8BAChD,cAAA,8OAAC;wBAAK,GAAE;;;;;;;;;;2BAGV;;;;;;YAGH,sBAAQ,IAAA,4NAAY,gBAEjB,8OAAC;gBACC,MAAK;gBACL,WAAU;gBACV,OAAO;oBACL,UAAU;oBACV,QAAQ;oBACR,MAAM,GAAG,OAAO,IAAI,CAAC,EAAE,CAAC;oBACxB,KAAK,GAAG,OAAO,GAAG,CAAC,EAAE,CAAC;oBACtB,UAAU,GAAG,OAAO,IAAI,CAAC,EAAE,CAAC;gBAC9B;;oBAEC,uBAAS,8OAAC;wBAAI,WAAU;kCAAoB;;;;;;oBAC5C,WACC,WAEA,CAAC,QAAQ,EAAE,EAAE,KAAK,CAAC,MAAM,GAAG,CAAC,CAAC,MAAM,kBAAM,8OAAC;sCAAa;2BAAJ;;;;;oBAErD,0BACC,8OAAC;wBAAI,WAAU;kCACb,cAAA,8OAAC;4BAAE,MAAM;4BAAU,WAAU;sCAC1B;;;;;;;;;;;;;;;;sBAMX,SAAS,IAAI;;;;;;;AAIrB","debugId":null}},
    {"offset": {"line": 4350, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/scaleSuggestions.ts"],"sourcesContent":["export type ScaleId =\n  | 'Ionian' | 'Lydian' | 'Aeolian' | 'Dorian' | 'Phrygian'\n  | 'Mixolydian' | 'Locrian' | 'DiminishedWholeHalf'\n  | 'HarmonicMinor' | 'MelodicMinor' | 'WholeTone' | 'Altered';\n\nexport type WhyKey =\n  | 'maj_ionian' | 'maj_lydian' | 'maj_mixolydian'\n  | 'min_aeolian' | 'min_dorian' | 'min_phrygian' | 'min_harmonic' | 'min_melodic'\n  | 'dom_mixolydian' | 'dom_altered' | 'dom_wholetone'\n  | 'm7b5_locrian' | 'dim_wh';\n\nexport type Suggest = { scales: ScaleId[]; why: WhyKey[] };\n\nexport function suggestScalesForChord(quality: 'maj'|'min'|'dom7'|'m7b5'|'dim'|'maj7'|'m7'|'7'): Suggest {\n  switch (quality) {\n    case 'maj':\n    case 'maj7':\n      return { scales: ['Ionian','Lydian'], why: ['maj_ionian','maj_lydian'] };\n    case 'min':\n    case 'm7':\n      return { scales: ['Aeolian','Dorian','Phrygian'], why: ['min_aeolian','min_dorian','min_phrygian'] };\n    case 'dom7':\n    case '7':\n      return { scales: ['Mixolydian','Altered'], why: ['dom_mixolydian','dom_altered'] };\n    case 'm7b5':\n      return { scales: ['Locrian','DiminishedWholeHalf'], why: ['m7b5_locrian','dim_wh'] };\n    case 'dim':\n      return { scales: ['DiminishedWholeHalf','Locrian'], why: ['dim_wh','m7b5_locrian'] };\n  }\n}\n\n\n"],"names":[],"mappings":";;;;AAaO,SAAS,sBAAsB,OAAwD;IAC5F,OAAQ;QACN,KAAK;QACL,KAAK;YACH,OAAO;gBAAE,QAAQ;oBAAC;oBAAS;iBAAS;gBAAE,KAAK;oBAAC;oBAAa;iBAAa;YAAC;QACzE,KAAK;QACL,KAAK;YACH,OAAO;gBAAE,QAAQ;oBAAC;oBAAU;oBAAS;iBAAW;gBAAE,KAAK;oBAAC;oBAAc;oBAAa;iBAAe;YAAC;QACrG,KAAK;QACL,KAAK;YACH,OAAO;gBAAE,QAAQ;oBAAC;oBAAa;iBAAU;gBAAE,KAAK;oBAAC;oBAAiB;iBAAc;YAAC;QACnF,KAAK;YACH,OAAO;gBAAE,QAAQ;oBAAC;oBAAU;iBAAsB;gBAAE,KAAK;oBAAC;oBAAe;iBAAS;YAAC;QACrF,KAAK;YACH,OAAO;gBAAE,QAAQ;oBAAC;oBAAsB;iBAAU;gBAAE,KAAK;oBAAC;oBAAS;iBAAe;YAAC;IACvF;AACF","debugId":null}},
    {"offset": {"line": 4422, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ScaleTable.tsx"],"sourcesContent":["\"use client\";\nimport React, { useRef } from \"react\";\nimport { suggestScalesForChord } from \"@/lib/scaleSuggestions\";\nimport { SCALE_CATALOG } from \"@/lib/scaleCatalog\";\nimport { track as tel } from \"@/lib/telemetry\";\nimport { player } from \"@/lib/audio/player\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\n\nexport function ScaleTable({\n  chordQuality, rootPc, onPreviewScale, onResetPreview, openGlossary, activeScaleId\n}: {\n  chordQuality: 'maj'|'min'|'dom7'|'m7b5'|'dim';\n  rootPc: number; // 0=C,...11=B\n  onPreviewScale: (scaleId: string)=>void; // 下地だけ切替（プレビュー）\n  onResetPreview: ()=>void;                // Reset（プレビュー解除）\n  openGlossary: (scaleId: string)=>void; // /resources/glossary\n  activeScaleId?: string | null;          // 現在プレビュー中のスケール\n}) {\n  const { scales } = suggestScalesForChord(chordQuality);\n  const listRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(listRef, { orientation: \"horizontal\" });\n  return (\n    <div className=\"ot-scale-table\" data-testid=\"scale-chips\" aria-label=\"Suggested scales\">\n      {/* Active scale chip is visually highlighted; no extra label needed */}\n      <details className=\"rounded border p-2 bg-background/40\">\n        <summary className=\"text-sm cursor-pointer select-none\">Suggested scales for this chord</summary>\n        <div className=\"mt-2 flex items-center justify-between gap-2\">\n          <div role=\"tablist\" aria-label=\"Preview scale\" className=\"flex flex-wrap gap-2\" ref={listRef}>\n          {scales.map((id, idx) => (\n            <div key={id} className=\"inline-flex items-center gap-1\">\n              <button\n                role=\"tab\" className={[\"chip\", (activeScaleId===id? \"chip--active\" : \"\")].join(\" \")}\n                onClick={() => { onPreviewScale(id); tel('overlay_shown', { control:'scale', scaleId:id }); void playArpShort(rootPc, id); }}\n                aria-describedby={`why-${id}`}\n                data-roving=\"item\"\n              >\n                {labelFor(id, chordQuality, idx)}\n              </button>\n              <button\n                type=\"button\"\n                className=\"inline-flex items-center justify-center w-5 h-5 rounded-full text-xs opacity-60 hover:opacity-100 hover:bg-black/5 dark:hover:bg-white/10 transition-opacity\"\n                onClick={()=> openGlossary(id)}\n                aria-label={`Learn more about ${id}`}\n                title=\"Learn more in Glossary\"\n              >\n                ⓘ\n              </button>\n            </div>\n          ))}\n          </div>\n          <button className=\"btn-ghost text-xs ml-auto\" onClick={onResetPreview}>Reset</button>\n        </div>\n        <div className=\"mt-2 flex flex-wrap gap-x-4 gap-y-1 items-center text-xs opacity-80\">\n          {scales.map((id)=> (\n            <span key={`why-${id}`} id={`why-${id}`}>{getWhyText(id)}</span>\n          ))}\n        </div>\n      </details>\n    </div>\n  );\n}\n\n// 短いアルペジオ（上昇→下降パターン）\nasync function playArpShort(rootPc:number, scaleId:string){\n  try {\n    // @ts-ignore SSOT API exposed in window\n    const api = (window as any).__SCALES_API__;\n    if (!api?.getScalePitchesById) return;\n    const pcs: number[] = api.getScalePitchesById(rootPc, scaleId);\n    const steps = pcs.slice(0, Math.min(5, pcs.length)); // 最大5音\n    const ascending = steps.slice();\n    const descending = steps.slice().reverse().slice(1); // ルート音は重複させない\n    const pattern = [...ascending, ...descending];\n    const dur = 100; // 各音100ms\n    await player.resume();\n    for (const pc of pattern) {\n      player.playNote(60 + pc, dur);\n      await wait(dur);\n    }\n    tel('scale_arpeggio_play', { page: 'find-chords', scaleId, rootPc });\n  } catch {}\n}\nfunction wait(ms:number){ return new Promise(r=>setTimeout(r, ms)); }\n\nfunction getWhyText(scaleId:string){\n  const map:Record<string,string> = {\n    Ionian:'maj_ionian',\n    Lydian:'maj_lydian',\n    Aeolian:'min_aeolian',\n    Dorian:'min_dorian',\n    Phrygian:'min_phrygian',\n    Mixolydian:'dom_mixolydian',\n    Locrian:'m7b5_locrian',\n    DiminishedWholeHalf:'dim_wh',\n    Altered:'dom_altered',\n    HarmonicMinor:'min_harmonic',\n    MelodicMinor:'min_melodic',\n    WholeTone:'dom_wholetone'\n  };\n  const t:Record<string,string> = {\n    maj_ionian:\"Foundation for major chords – fits all diatonic tones\",\n    maj_lydian:\"Bright color with raised 4th (#11) – jazz/modern sound\",\n    maj_mixolydian:\"Dominant-like major – contains the b7 for blues flavor\",\n    min_aeolian:\"Natural minor foundation – matches all minor scale tones\",\n    min_dorian:\"Brighter minor with natural 6th – popular in jazz and funk\",\n    min_phrygian:\"Dark minor with flat 2nd – Spanish/flamenco character\",\n    min_harmonic:\"Dramatic minor with raised 7th – classical and exotic sound\",\n    min_melodic:\"Jazz minor – ascending melodic scale with natural 6th and 7th\",\n    dom_mixolydian:\"Perfect for dominant 7th – contains the b7 tension\",\n    dom_altered:\"Maximum tension – all alterations (b9, #9, #11, b13)\",\n    dom_wholetone:\"Symmetrical whole-tone pattern – dreamy, unresolved quality\",\n    m7b5_locrian:\"Outlines half-diminished chord – starts on the 7th degree\",\n    dim_wh:\"Symmetrical whole-half pattern – creates tension over diminished chords\"\n  };\n  return t[map[scaleId]] || '';\n}\n\nfunction labelFor(id:string, q:'maj'|'min'|'dom7'|'m7b5'|'dim'|'maj7'|'m7'|'7', idx:number){\n  if (q==='maj' || q==='maj7') {\n    if (idx===0) return 'Ionian (Major Scale)';\n    if (idx===1) return 'Lydian (#4 Color)';\n  }\n  if (q==='min' || q==='m7') {\n    if (idx===0) return 'Aeolian (Natural Minor)';\n    if (idx===1) return 'Dorian (Bright Minor)';\n    if (idx===2) return 'Phrygian (Dark Minor)';\n  }\n  if (q==='dom7' || q==='7') {\n    if (idx===0) return 'Mixolydian (Dominant)';\n    if (idx===1) return 'Altered (Tension)';\n  }\n  if (q==='m7b5') {\n    if (idx===0) return 'Locrian (Half-Dim)';\n    if (idx===1) return 'Whole–Half Dim';\n  }\n  if (q==='dim') {\n    if (idx===0) return 'Whole–Half Dim';\n    if (idx===1) return 'Locrian';\n  }\n  return id;\n}\n\nexport default ScaleTable;\n\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4651, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/ChordFormsPopover.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { useEffect, useRef } from \"react\";\nimport { createPortal } from \"react-dom\";\nimport type { FormKind, Quality } from \"@/lib/chordForms\";\nimport { trackOverlayShown, track } from \"@/lib/telemetry\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport { player } from \"@/lib/audio/player\";\n\ntype Props = {\n  at: { x: number; y: number };\n  quality: Quality;\n  rootPc: number; // 追加: ルート音のピッチクラス\n  onPick: (kind: FormKind) => void;\n  onClose: () => void;\n  page?: string;\n};\n\nexport function ChordFormsPopover({ at, quality, rootPc, onPick, onClose, page = \"analyze\" }: Props) {\n  const ref = useRef<HTMLDivElement>(null);\n  const closeRef = useRef(onClose);\n  closeRef.current = onClose;\n  const sentOpenRef = useRef(false);\n  const pickedRef = useRef(false);\n  const buttonsRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(buttonsRef, { orientation: \"horizontal\" });\n\n  useEffect(() => {\n    if (!sentOpenRef.current) {\n      sentOpenRef.current = true;\n      trackOverlayShown({ control: \"forms\", open: true, page });\n    }\n\n    const firstButton = ref.current?.querySelector<HTMLButtonElement>(\"button\");\n    firstButton?.focus({ preventScroll: true });\n\n    function onKey(e: KeyboardEvent) {\n      if (e.key === \"Escape\") closeRef.current();\n    }\n    function onClickOutside(e: MouseEvent) {\n      if (!ref.current) return;\n      if (!ref.current.contains(e.target as Node)) closeRef.current();\n    }\n\n    document.addEventListener(\"keydown\", onKey);\n    document.addEventListener(\"mousedown\", onClickOutside);\n    return () => {\n      document.removeEventListener(\"keydown\", onKey);\n      document.removeEventListener(\"mousedown\", onClickOutside);\n    };\n  }, [page]);\n\n  const style: React.CSSProperties = {\n    position: \"fixed\",\n    left: at.x,\n    top: at.y,\n    zIndex: 2147483647,\n    pointerEvents: \"auto\",\n  };\n\n  const choose = (kind: FormKind) => {\n    if (pickedRef.current) return;\n    pickedRef.current = true;\n    trackOverlayShown({ control: \"forms\", value: kind, page });\n    onPick(kind);\n    onClose();\n  };\n\n  const playFormPreview = async (kind: FormKind) => {\n    try {\n      await player.resume();\n      // 基本的な3和音を再生（ルート、3度、5度）\n      const intervals = quality === 'maj' ? [0, 4, 7] : [0, 3, 7];\n      const midis = intervals.map(iv => 60 + rootPc + iv);\n      player.playChord(midis, 'lightStrum', 300);\n      track('play_chord', { page, source: 'form_preview', kind });\n    } catch {}\n  };\n\n  const node = (\n    <div\n      role=\"dialog\"\n      aria-modal=\"true\"\n      aria-label=\"Chord forms\"\n      ref={ref}\n      style={style}\n      className=\"ot-pop\"\n    >\n      <div className=\"flex items-center justify-between mb-2\">\n        <p className=\"ot-h3\" style={{ margin: 0 }}>\n          Chord Forms\n        </p>\n        <button\n          type=\"button\"\n          onClick={onClose}\n          className=\"text-xs opacity-60 hover:opacity-100 px-2 py-1 rounded hover:bg-black/5 dark:hover:bg-white/10\"\n          aria-label=\"Close\"\n        >\n          ✕\n        </button>\n      </div>\n      <p className=\"text-xs opacity-70 mb-3\">\n        Select a fingering pattern for {quality === 'maj' ? 'major' : 'minor'} chord\n      </p>\n      <div className=\"flex flex-col gap-2\" ref={buttonsRef}>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"open\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Open Position</div>\n            <div className=\"text-xs opacity-70\">Uses open strings</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"open\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview open position\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"barreE\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Barre (E-shape)</div>\n            <div className=\"text-xs opacity-70\">6th string root</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"barreE\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview E-shape barre\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n        <div className=\"flex items-center gap-2\">\n          <button\n            type=\"button\"\n            data-roving=\"item\"\n            onClick={() => choose(\"barreA\")}\n            className=\"flex-1 px-3 py-2 rounded border text-left hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\"\n          >\n            <div className=\"font-medium\">Barre (A-shape)</div>\n            <div className=\"text-xs opacity-70\">5th string root</div>\n          </button>\n          <button\n            type=\"button\"\n            onClick={() => playFormPreview(\"barreA\")}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label=\"Preview A-shape barre\"\n            title=\"Preview sound\"\n          >\n            ▶\n          </button>\n        </div>\n      </div>\n      <p className=\"ot-hint mt-3\">Right-click or long-press a chord to open.</p>\n    </div>\n  );\n\n  if (typeof document !== \"undefined\") {\n    return createPortal(node, document.body);\n  }\n  return node;\n}\n\nexport default ChordFormsPopover;\n "],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 4981, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chordForms.ts"],"sourcesContent":["export type Degree = '1'|'b2'|'2'|'b3'|'3'|'4'|'b5'|'5'|'#5'|'6'|'b7'|'7';\nexport type FormKind = 'open'|'barreE'|'barreA';\nexport type Quality = 'maj'|'min';\n\nexport type ShapeDot = {\n  string: 1|2|3|4|5|6;   // 1 = highest (thin) string\n  fret: number;           // 0 = open string\n  deg: Degree;\n  muted?: boolean;\n};\n\nexport type FormShape = {\n  kind: FormKind;\n  quality: Quality;\n  rootPc: number;         // 0=C, 1=C#, ... 11=B\n  rootString: 6|5;        // 6 = E-shape, 5 = A-shape\n  dots: ShapeDot[];\n  barre?: { stringFrom: 6|5; fret: number };\n};\n\nconst OPEN_E_PC = 4; // E\nconst OPEN_A_PC = 9; // A\n\nfunction mod12(n: number): number {\n  return ((n % 12) + 12) % 12;\n}\n\nfunction nearestBarreFretForRoot(openPc: number, targetPc: number): number {\n  const tgt = mod12(targetPc);\n  for (let f = 1; f <= 12; f++) {\n    if (mod12(openPc + f) === tgt) return f;\n  }\n  return 1;\n}\n\nexport function getOpenShapeE(quality: Quality, rootPc: number): FormShape {\n  const dots: ShapeDot[] =\n    quality === 'maj'\n      ? [\n          { string: 6, fret: 0, deg: '1' },\n          { string: 5, fret: 2, deg: '5' },\n          { string: 4, fret: 2, deg: '1' },\n          { string: 3, fret: 1, deg: '3' },\n          { string: 2, fret: 0, deg: '5' },\n          { string: 1, fret: 0, deg: '1' },\n        ]\n      : [\n          { string: 6, fret: 0, deg: '1' },\n          { string: 5, fret: 2, deg: '5' },\n          { string: 4, fret: 2, deg: '1' },\n          { string: 3, fret: 0, deg: 'b3' },\n          { string: 2, fret: 0, deg: '5' },\n          { string: 1, fret: 0, deg: '1' },\n        ];\n\n  return { kind: 'open', quality, rootPc, rootString: 6, dots };\n}\n\nexport function makeBarreEShape(quality: Quality, rootPc: number): FormShape {\n  const f = nearestBarreFretForRoot(OPEN_E_PC, rootPc);\n  const dots: ShapeDot[] = [\n    { string: 6, fret: f, deg: '1' },\n    { string: 5, fret: f + 2, deg: '5' },\n    { string: 4, fret: f + 2, deg: '1' },\n    { string: 3, fret: quality === 'maj' ? f + 1 : f, deg: quality === 'maj' ? '3' : 'b3' },\n    { string: 2, fret: f, deg: '5' },\n    { string: 1, fret: f, deg: '1' },\n  ];\n\n  return {\n    kind: 'barreE',\n    quality,\n    rootPc,\n    rootString: 6,\n    dots,\n    barre: { stringFrom: 6, fret: f },\n  };\n}\n\nexport function makeBarreAShape(quality: Quality, rootPc: number): FormShape {\n  const f = nearestBarreFretForRoot(OPEN_A_PC, rootPc);\n  const dots: ShapeDot[] = [\n    { string: 5, fret: f, deg: '1' },\n    { string: 4, fret: f + 2, deg: '5' },\n    { string: 3, fret: quality === 'maj' ? f + 2 : f, deg: quality === 'maj' ? '3' : 'b3' },\n    { string: 2, fret: f + 2, deg: '1' },\n    { string: 1, fret: f, deg: '5' },\n  ];\n\n  return {\n    kind: 'barreA',\n    quality,\n    rootPc,\n    rootString: 5,\n    dots,\n    barre: { stringFrom: 5, fret: f },\n  };\n}\n\nexport function buildForm(kind: FormKind, quality: Quality, rootPc: number): FormShape {\n  if (kind === 'open') return getOpenShapeE(quality, rootPc);\n  if (kind === 'barreE') return makeBarreEShape(quality, rootPc);\n  return makeBarreAShape(quality, rootPc);\n}\n\n\n"],"names":[],"mappings":";;;;;;;;;;AAoBA,MAAM,YAAY,GAAG,IAAI;AACzB,MAAM,YAAY,GAAG,IAAI;AAEzB,SAAS,MAAM,CAAS;IACtB,OAAO,CAAC,AAAC,IAAI,KAAM,EAAE,IAAI;AAC3B;AAEA,SAAS,wBAAwB,MAAc,EAAE,QAAgB;IAC/D,MAAM,MAAM,MAAM;IAClB,IAAK,IAAI,IAAI,GAAG,KAAK,IAAI,IAAK;QAC5B,IAAI,MAAM,SAAS,OAAO,KAAK,OAAO;IACxC;IACA,OAAO;AACT;AAEO,SAAS,cAAc,OAAgB,EAAE,MAAc;IAC5D,MAAM,OACJ,YAAY,QACR;QACE;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;KAChC,GACD;QACE;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAK;QAChC;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;KAChC;IAEP,OAAO;QAAE,MAAM;QAAQ;QAAS;QAAQ,YAAY;QAAG;IAAK;AAC9D;AAEO,SAAS,gBAAgB,OAAgB,EAAE,MAAc;IAC9D,MAAM,IAAI,wBAAwB,WAAW;IAC7C,MAAM,OAAmB;QACvB;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM,IAAI;YAAG,KAAK;QAAI;QACnC;YAAE,QAAQ;YAAG,MAAM,IAAI;YAAG,KAAK;QAAI;QACnC;YAAE,QAAQ;YAAG,MAAM,YAAY,QAAQ,IAAI,IAAI;YAAG,KAAK,YAAY,QAAQ,MAAM;QAAK;QACtF;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;KAChC;IAED,OAAO;QACL,MAAM;QACN;QACA;QACA,YAAY;QACZ;QACA,OAAO;YAAE,YAAY;YAAG,MAAM;QAAE;IAClC;AACF;AAEO,SAAS,gBAAgB,OAAgB,EAAE,MAAc;IAC9D,MAAM,IAAI,wBAAwB,WAAW;IAC7C,MAAM,OAAmB;QACvB;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;QAC/B;YAAE,QAAQ;YAAG,MAAM,IAAI;YAAG,KAAK;QAAI;QACnC;YAAE,QAAQ;YAAG,MAAM,YAAY,QAAQ,IAAI,IAAI;YAAG,KAAK,YAAY,QAAQ,MAAM;QAAK;QACtF;YAAE,QAAQ;YAAG,MAAM,IAAI;YAAG,KAAK;QAAI;QACnC;YAAE,QAAQ;YAAG,MAAM;YAAG,KAAK;QAAI;KAChC;IAED,OAAO;QACL,MAAM;QACN;QACA;QACA,YAAY;QACZ;QACA,OAAO;YAAE,YAAY;YAAG,MAAM;QAAE;IAClC;AACF;AAEO,SAAS,UAAU,IAAc,EAAE,OAAgB,EAAE,MAAc;IACxE,IAAI,SAAS,QAAQ,OAAO,cAAc,SAAS;IACnD,IAAI,SAAS,UAAU,OAAO,gBAAgB,SAAS;IACvD,OAAO,gBAAgB,SAAS;AAClC","debugId":null}},
    {"offset": {"line": 5171, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/chords/substitute.refactored.ts"],"sourcesContent":["/**\n * 代理コード（Substitute Chords）推奨ロジック（リファクタリング版）\n * \n * 各ダイアトニックコードに対して、機能的に類似した代理コード候補を提示\n */\n\nimport { pcToName, mod12 } from '@/lib/music/constants';\n\nexport type SubstituteChord = {\n  chord: string; // \"Cmaj7\", \"Am\" など\n  reason: string; // 代理の理由（一文）\n  examples?: string[]; // 代表曲の例（2〜3件）\n};\n\nexport type ChordContext = {\n  rootPc: number; // 0=C, 1=C#, ..., 11=B\n  quality: 'maj' | 'min' | 'dom7' | 'dim';\n  degree: number; // 1=I, 2=II, ..., 7=VII (1-indexed)\n  key: { tonic: number; mode: 'Major' | 'Minor' };\n};\n\ntype SubstituteRule = (context: ChordContext) => SubstituteChord[];\n\n/**\n * Major keyにおける各度数の代理コード定義\n */\nconst MAJOR_KEY_SUBSTITUTES: Record<number, SubstituteRule> = {\n  // I (Tonic)\n  1: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Richer tonic sound with major 7th\",\n      examples: [\"The Girl from Ipanema\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}6`,\n      reason: \"Jazz tonic with added 6th\",\n      examples: [\"All the Things You Are\", \"Autumn Leaves\"]\n    },\n    {\n      chord: `${pcToName(mod12(rootPc + 9))}m`,\n      reason: \"Relative minor shares the same notes\",\n      examples: [\"Let It Be\", \"No Woman No Cry\"]\n    }\n  ],\n\n  // ii (Subdominant)\n  2: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Jazz ii with minor 7th\",\n      examples: [\"Autumn Leaves\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: pcToName(mod12(key.tonic + 5)),\n      reason: \"IV chord shares subdominant function\",\n      examples: [\"Let It Be\", \"Hey Jude\"]\n    }\n  ],\n\n  // IV (Subdominant)\n  4: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Lydian color with major 7th\",\n      examples: [\"The Girl from Ipanema\", \"Dreams (Fleetwood Mac)\"]\n    },\n    {\n      chord: `${pcToName(mod12(key.tonic + 2))}m`,\n      reason: \"ii chord shares subdominant function\",\n      examples: [\"Autumn Leaves\", \"Fly Me to the Moon\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}m`,\n      reason: \"Borrowed minor IV for color\",\n      examples: [\"Yesterday\", \"Creep\"]\n    }\n  ],\n\n  // V (Dominant)\n  5: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}7`,\n      reason: \"Dominant 7th creates strong tension\",\n      examples: [\"Sweet Home Alabama\", \"Twist and Shout\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}sus4`,\n      reason: \"Suspended 4th delays resolution\",\n      examples: [\"Pinball Wizard\", \"The Edge of Glory\"]\n    },\n    {\n      chord: `${pcToName(mod12(key.tonic + 11))}dim`,\n      reason: \"vii° shares dominant function\",\n      examples: [\"Girl from Ipanema\", \"Michelle\"]\n    }\n  ],\n\n  // vi (Tonic)\n  6: ({ rootPc, key }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Jazz minor with added 7th\",\n      examples: [\"Stairway to Heaven\", \"Hotel California\"]\n    },\n    {\n      chord: pcToName(key.tonic),\n      reason: \"Relative major shares the same notes\",\n      examples: [\"Let It Be\", \"Hey Jude\"]\n    }\n  ]\n};\n\n/**\n * Minor keyにおける各度数の代理コード定義\n */\nconst MINOR_KEY_SUBSTITUTES: Record<number, SubstituteRule> = {\n  // i (Tonic)\n  1: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Natural minor 7th\",\n      examples: [\"Stairway to Heaven\", \"Smooth\"]\n    },\n    {\n      chord: `${pcToName(rootPc)}m6`,\n      reason: \"Minor 6th for Dorian color\",\n      examples: [\"Scarborough Fair\", \"So What\"]\n    },\n    {\n      chord: pcToName(mod12(rootPc + 3)),\n      reason: \"Relative major (bIII) shares notes\",\n      examples: [\"Stairway to Heaven\", \"All Along the Watchtower\"]\n    }\n  ],\n\n  // iv (Subdominant)\n  4: ({ rootPc }) => [\n    {\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Minor 7th for subdominant color\",\n      examples: [\"Light My Fire\", \"Losing My Religion\"]\n    }\n  ],\n\n  // v or V (Dominant)\n  5: ({ rootPc, quality }) => {\n    if (quality === 'min') {\n      return [\n        {\n          chord: `${pcToName(rootPc)}7`,\n          reason: \"Raised 3rd (V7) for stronger resolution\",\n          examples: [\"Stairway to Heaven\", \"House of the Rising Sun\"]\n        }\n      ];\n    } else {\n      return [\n        {\n          chord: `${pcToName(rootPc)}7`,\n          reason: \"Dominant 7th for tension\",\n          examples: [\"Smooth\", \"Black Magic Woman\"]\n        }\n      ];\n    }\n  }\n};\n\n/**\n * 汎用的な代理コード（度数が定義されていない場合）\n */\nfunction getGenericSubstitutes(context: ChordContext): SubstituteChord[] {\n  const { rootPc, quality } = context;\n  const subs: SubstituteChord[] = [];\n\n  if (quality === 'maj') {\n    subs.push({\n      chord: `${pcToName(rootPc)}maj7`,\n      reason: \"Added major 7th for richer sound\"\n    });\n  } else if (quality === 'min') {\n    subs.push({\n      chord: `${pcToName(rootPc)}m7`,\n      reason: \"Added minor 7th for jazz flavor\"\n    });\n  }\n\n  return subs;\n}\n\n/**\n * 代理コード候補を取得\n * @param context コードのコンテキスト（ルート音、クオリティ、度数、キー）\n * @returns 代理コード候補の配列（最大3つ）\n */\nexport function getSubstitutes(context: ChordContext): SubstituteChord[] {\n  const { degree, key } = context;\n  const isMajorKey = key.mode === 'Major';\n\n  // 辞書から適切なルールを取得\n  const substitutesMap = isMajorKey ? MAJOR_KEY_SUBSTITUTES : MINOR_KEY_SUBSTITUTES;\n  const rule = substitutesMap[degree];\n\n  let substitutes: SubstituteChord[];\n  \n  if (rule) {\n    substitutes = rule(context);\n  } else {\n    // 定義されていない度数には汎用ルールを適用\n    substitutes = getGenericSubstitutes(context);\n  }\n\n  // 最大3つまで\n  return substitutes.slice(0, 3);\n}\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5410, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/lib/music/chordParser.ts"],"sourcesContent":["/**\n * コード記号のパースとMIDI音への変換\n */\n\nimport { nameToPc, DEFAULT_MIDI_OCTAVE } from './constants';\n\nexport type ChordIntervals = number[];\n\nexport type ParsedChord = {\n  rootPc: number;\n  quality: string;\n  intervals: ChordIntervals;\n};\n\n/**\n * コード記号をパースして構成音のインターバルを返す\n * \n * @param symbol コード記号（例: \"Cmaj7\", \"Am\", \"G7\"）\n * @returns パース結果（ルート音、クオリティ、インターバル）\n */\nexport function parseChordSymbol(symbol: string): ParsedChord | null {\n  // ルート音とクオリティを分離\n  const match = symbol.match(/^([A-G](?:#|b)?)(.*)$/);\n  if (!match) return null;\n\n  const root = match[1];\n  const quality = (match[2] || '').toLowerCase();\n  const rootPc = nameToPc(root);\n  \n  if (rootPc < 0) return null;\n\n  const intervals = getIntervalsForQuality(quality, symbol);\n  \n  return { rootPc, quality, intervals };\n}\n\n/**\n * クオリティ文字列からインターバルを取得\n */\nfunction getIntervalsForQuality(quality: string, originalSymbol: string): ChordIntervals {\n  // 基本トライアド\n  let base: ChordIntervals;\n  \n  // マイナーコードの判定（\"m\" があるが \"maj\" ではない）\n  if (/(^|[^a-z])m(?!aj)/.test(quality)) {\n    base = [0, 3, 7]; // Minor\n  } else if (/dim|°/.test(quality)) {\n    return [0, 3, 6]; // Diminished\n  } else if (/aug|\\+/.test(quality)) {\n    return [0, 4, 8]; // Augmented\n  } else {\n    base = [0, 4, 7]; // Major (default)\n  }\n\n  // 7thコードの処理\n  if (/maj7|M7/.test(originalSymbol)) {\n    return [...base, 11]; // Major 7th\n  } else if (/7/.test(quality)) {\n    return [...base, 10]; // Dominant 7th\n  }\n\n  // 6thコードの処理\n  if (/6/.test(quality)) {\n    return [...base.slice(0, 3), 9]; // 6th\n  }\n\n  // Suspendedコードの処理\n  if (/sus4/.test(quality)) {\n    return [0, 5, 7]; // sus4\n  } else if (/sus2/.test(quality)) {\n    return [0, 2, 7]; // sus2\n  }\n\n  // 9thコードの処理（簡易版）\n  if (/9/.test(quality)) {\n    return [...base, 10, 14]; // Add 9th (2 octaves up)\n  }\n\n  return base;\n}\n\n/**\n * コード記号からMIDI音番号の配列を生成\n * \n * @param symbol コード記号\n * @param octave ベースとなるオクターブ（デフォルト: C4 = 60）\n * @returns MIDI音番号の配列、パース失敗時はnull\n */\nexport function chordToMidi(symbol: string, octave: number = DEFAULT_MIDI_OCTAVE): number[] | null {\n  const parsed = parseChordSymbol(symbol);\n  if (!parsed) return null;\n\n  const base = octave + parsed.rootPc;\n  return parsed.intervals.map(interval => base + interval);\n}\n\n"],"names":[],"mappings":"AAAA;;CAEC;;;;;;AAED;;AAgBO,SAAS,iBAAiB,MAAc;IAC7C,gBAAgB;IAChB,MAAM,QAAQ,OAAO,KAAK,CAAC;IAC3B,IAAI,CAAC,OAAO,OAAO;IAEnB,MAAM,OAAO,KAAK,CAAC,EAAE;IACrB,MAAM,UAAU,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,EAAE,WAAW;IAC5C,MAAM,SAAS,IAAA,4IAAQ,EAAC;IAExB,IAAI,SAAS,GAAG,OAAO;IAEvB,MAAM,YAAY,uBAAuB,SAAS;IAElD,OAAO;QAAE;QAAQ;QAAS;IAAU;AACtC;AAEA;;CAEC,GACD,SAAS,uBAAuB,OAAe,EAAE,cAAsB;IACrE,UAAU;IACV,IAAI;IAEJ,kCAAkC;IAClC,IAAI,oBAAoB,IAAI,CAAC,UAAU;QACrC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,QAAQ;IAC5B,OAAO,IAAI,QAAQ,IAAI,CAAC,UAAU;QAChC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,aAAa;IACjC,OAAO,IAAI,SAAS,IAAI,CAAC,UAAU;QACjC,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,YAAY;IAChC,OAAO;QACL,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,kBAAkB;IACtC;IAEA,YAAY;IACZ,IAAI,UAAU,IAAI,CAAC,iBAAiB;QAClC,OAAO;eAAI;YAAM;SAAG,EAAE,YAAY;IACpC,OAAO,IAAI,IAAI,IAAI,CAAC,UAAU;QAC5B,OAAO;eAAI;YAAM;SAAG,EAAE,eAAe;IACvC;IAEA,YAAY;IACZ,IAAI,IAAI,IAAI,CAAC,UAAU;QACrB,OAAO;eAAI,KAAK,KAAK,CAAC,GAAG;YAAI;SAAE,EAAE,MAAM;IACzC;IAEA,kBAAkB;IAClB,IAAI,OAAO,IAAI,CAAC,UAAU;QACxB,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,OAAO;IAC3B,OAAO,IAAI,OAAO,IAAI,CAAC,UAAU;QAC/B,OAAO;YAAC;YAAG;YAAG;SAAE,EAAE,OAAO;IAC3B;IAEA,iBAAiB;IACjB,IAAI,IAAI,IAAI,CAAC,UAAU;QACrB,OAAO;eAAI;YAAM;YAAI;SAAG,EAAE,yBAAyB;IACrD;IAEA,OAAO;AACT;AASO,SAAS,YAAY,MAAc,EAAE,SAAiB,uJAAmB;IAC9E,MAAM,SAAS,iBAAiB;IAChC,IAAI,CAAC,QAAQ,OAAO;IAEpB,MAAM,OAAO,SAAS,OAAO,MAAM;IACnC,OAAO,OAAO,SAAS,CAAC,GAAG,CAAC,CAAA,WAAY,OAAO;AACjD","debugId":null}},
    {"offset": {"line": 5519, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/components/SubstituteCard.tsx"],"sourcesContent":["\"use client\";\n\nimport React, { useRef, useEffect, useMemo, useCallback } from \"react\";\nimport { getSubstitutes, type SubstituteChord, type ChordContext } from \"@/lib/chords/substitute.refactored\";\nimport { player } from \"@/lib/audio/player\";\nimport { track } from \"@/lib/telemetry\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport { chordToMidi } from \"@/lib/music/chordParser\";\n\ntype Props = {\n  rootPc: number; // 0=C, 1=C#, ..., 11=B\n  quality: 'maj' | 'min' | 'dom7' | 'dim';\n  degree: number; // 1=I, 2=II, ..., 7=VII\n  keyContext: { tonic: number; mode: 'Major' | 'Minor' };\n  onAdd?: (chord: string) => void; // Chord Progression への追加\n  page?: string;\n};\n\nexport function SubstituteCard({ \n  rootPc, \n  quality, \n  degree, \n  keyContext, \n  onAdd, \n  page = 'find-chords' \n}: Props) {\n  const listRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(listRef, { orientation: \"horizontal\" });\n\n  // コンテキストをメモ化\n  const context = useMemo<ChordContext>(() => ({\n    rootPc,\n    quality,\n    degree,\n    key: keyContext\n  }), [rootPc, quality, degree, keyContext]);\n\n  // 代理コード候補を計算\n  const substitutes = useMemo(() => {\n    return getSubstitutes(context);\n  }, [context]);\n\n  // Telemetry: 表示時に1回だけ送信\n  useEffect(() => {\n    if (substitutes.length > 0) {\n      track('substitute_shown', { \n        page, \n        rootPc, \n        quality, \n        degree, \n        count: substitutes.length \n      });\n    }\n  }, [substitutes, page, rootPc, quality, degree]);\n\n  // 試聴機能\n  const playSubstitute = useCallback(async (sub: SubstituteChord) => {\n    try {\n      await player.resume();\n      \n      const midis = chordToMidi(sub.chord);\n      if (!midis || midis.length === 0) {\n        console.warn(`Failed to parse chord: ${sub.chord}`);\n        return;\n      }\n\n      player.playChord(midis, 'lightStrum', 300);\n      track('play_chord', { \n        page, \n        source: 'substitute_preview', \n        chord: sub.chord \n      });\n    } catch (error) {\n      console.error('Failed to play substitute chord:', error);\n    }\n  }, [page]);\n\n  // 追加機能\n  const handleAdd = useCallback((sub: SubstituteChord) => {\n    if (onAdd) {\n      onAdd(sub.chord);\n      track('substitute_add', { \n        page, \n        rootPc, \n        originalQuality: quality, \n        substituteChord: sub.chord \n      });\n    }\n  }, [onAdd, page, rootPc, quality]);\n\n  // 代理コードがない場合は非表示\n  if (substitutes.length === 0) {\n    return null;\n  }\n\n  return (\n    <details className=\"rounded border p-2 bg-background/40 mt-2\">\n      <summary className=\"text-sm cursor-pointer select-none font-medium\">\n        Substitute Chords ({substitutes.length})\n      </summary>\n      <div className=\"mt-2\">\n        <p className=\"text-xs opacity-70 mb-3 px-1\">\n          Alternative chords with similar harmonic function\n        </p>\n        <div className=\"space-y-2\" ref={listRef}>\n          {substitutes.map((sub, idx) => (\n            <SubstituteChordItem\n              key={`${sub.chord}-${idx}`}\n              substitute={sub}\n              onPlay={playSubstitute}\n              onAdd={onAdd ? handleAdd : undefined}\n            />\n          ))}\n        </div>\n      </div>\n    </details>\n  );\n}\n\n/**\n * 個別の代理コードアイテムコンポーネント\n */\ntype SubstituteChordItemProps = {\n  substitute: SubstituteChord;\n  onPlay: (sub: SubstituteChord) => void;\n  onAdd?: (sub: SubstituteChord) => void;\n};\n\nfunction SubstituteChordItem({ substitute, onPlay, onAdd }: SubstituteChordItemProps) {\n  return (\n    <div className=\"rounded border p-2 bg-white dark:bg-neutral-900/50 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-colors\">\n      <div className=\"flex items-start justify-between gap-2 mb-1\">\n        <div className=\"flex-1\">\n          <div className=\"font-medium text-base\">{substitute.chord}</div>\n          <div className=\"text-sm opacity-80 mt-0.5\">{substitute.reason}</div>\n        </div>\n        <div className=\"flex items-center gap-1\">\n          <button\n            type=\"button\"\n            onClick={() => onPlay(substitute)}\n            className=\"w-8 h-8 flex items-center justify-center rounded border hover:bg-black/5 dark:hover:bg-white/10 transition-colors\"\n            aria-label={`Preview ${substitute.chord}`}\n            title=\"Preview sound\"\n            data-roving=\"item\"\n          >\n            ▶\n          </button>\n          {onAdd && (\n            <button\n              type=\"button\"\n              onClick={() => onAdd(substitute)}\n              className=\"px-2 py-1 text-xs rounded border bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-colors\"\n              aria-label={`Add ${substitute.chord} to progression`}\n              title=\"Add to progression\"\n            >\n              + Add\n            </button>\n          )}\n        </div>\n      </div>\n      {substitute.examples && substitute.examples.length > 0 && (\n        <div className=\"text-xs opacity-60 mt-1 flex items-center gap-1\">\n          <span className=\"opacity-70\">Examples:</span>\n          <span>{substitute.examples.join(' · ')}</span>\n        </div>\n      )}\n    </div>\n  );\n}\n\nexport default SubstituteCard;\n\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 5787, "column": 0}, "map": {"version":3,"sources":["file:///Users/nh/App/OtoTheory/ototheory-web/src/app/find-chords/page.tsx"],"sourcesContent":["\"use client\";\nimport { Suspense, useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport AdSlot from \"@/components/AdSlot.client\";\nimport { getDiatonicChordsFor, type NoteLetter } from \"@/lib/music-theory\";\nimport { toRoman, type Mode } from \"@/lib/theory/roman\";\nimport { useSearchParams } from \"next/navigation\";\nimport Fretboard from \"@/components/Fretboard\";\nimport { OverlayProvider } from \"@/state/overlay\";\nimport DiatonicCapoTable from \"@/components/DiatonicCapoTable\";\nimport { useRovingTabs } from \"@/hooks/useRovingTabs\";\nimport InfoDot from \"@/components/ui/InfoDot\";\nimport { useAnalysisStore } from \"@/store/analysisStore\";\nimport { getScalePitchesById } from \"@/lib/scales\";\nimport { SCALE_CATALOG, type ScaleId } from \"@/lib/scaleCatalog\";\nimport { PC_NAMES } from \"@/lib/music/constants\";\nimport { track } from \"@/lib/telemetry\";\nimport ScaleTable from \"@/components/ScaleTable\";\nimport { ChordFormsPopover } from \"@/components/ChordFormsPopover\";\nimport { buildForm, type FormKind, type FormShape, type Quality } from \"@/lib/chordForms\";\nimport SubstituteCard from \"@/components/SubstituteCard\";\n\nexport default function FindChordsPage() {\n  return (\n    <Suspense fallback={<div className=\"ot-page\">Loading...</div>}>\n      <FindChordsContent />\n    </Suspense>\n  );\n}\n\nfunction FindChordsContent() {\n  const params = useSearchParams();\n  const KEY_OPTIONS: NoteLetter[] = useMemo(() => PC_NAMES as unknown as NoteLetter[], []);\n  const UI_SCALES = SCALE_CATALOG; // SSOT カタログ\n\n  const [keyTonic, setKeyTonic] = useState<NoteLetter>((params.get('key') as NoteLetter) || 'C');\n  const initialMode: ScaleId = (params.get('mode') === 'minor') ? 'Aeolian' : 'Ionian';\n  const [selScaleId, setSelScaleId] = useState<ScaleId>(initialMode);\n  const isHept = useMemo(() => {\n    const def = UI_SCALES.find(s => s.id === selScaleId);\n    return (def?.degrees.length ?? 7) === 7;\n  }, [selScaleId]);\n\n  const diatonic = useMemo(() => {\n    const sel = UI_SCALES.find(s => s.id === selScaleId)!;\n    const sevenNote = sel.degrees.length === 7;\n    if (!sevenNote) return [] as any[];\n    const quality = (sel.id==='Aeolian' ? 'minor' : 'major') as any;\n    return getDiatonicChordsFor({ tonic: keyTonic, quality, scale: sel.id as any } as any).chords;\n  }, [keyTonic, selScaleId]);\n\n  const mode: Mode = useMemo(() => (selScaleId === 'Aeolian' ? 'minor' : 'major'), [selScaleId]);\n\n  type Display = 'degrees'|'names';\n  const keyRowRef = useRef<HTMLDivElement | null>(null);\n  useRovingTabs(keyRowRef, { orientation: \"horizontal\" });\n  const fbToggleRef = useRef<HTMLSpanElement | null>(null);\n  useRovingTabs(fbToggleRef, { orientation: \"horizontal\" });\n  const [display, setDisplay] = useState<Display>('degrees');\n  const [fbCapo, setFbCapo] = useState<number>(0);\n  const [overlayNotes, setOverlayNotes] = useState<string[]|null>(null);\n  const [previewScaleId, setPreviewScaleId] = useState<ScaleId | null>(null);\n  const [selectedCellId, setSelectedCellId] = useState<string | null>(null);\n  const [lastPickedPcs, setLastPickedPcs] = useState<number[]|null>(null);\n  const [formsPop, setFormsPop] = useState<null | { at:{x:number;y:number}; rootPc:number; quality:Quality }>(null);\n  const [formShape, setFormShape] = useState<FormShape | null>(null);\n  const resetForms = useCallback(() => { setFormsPop(null); setFormShape(null); }, []);\n\n  // Debug quick-check: ensure overlay wiring is correct\n  useEffect(() => {}, [display, overlayNotes]);\n  const { selectKey } = useAnalysisStore();\n  // auto-refresh; no manual \"Show Chords\" button\n\n  const onPickKey = (k: NoteLetter) => {\n    setKeyTonic(k);\n    const q = (selScaleId === 'Aeolian') ? 'minor' : 'major';\n    const modeLabel = q === 'major' ? 'Major' : 'Minor';\n    const tonicPc = KEY_OPTIONS.indexOf(k);\n    selectKey({ tonic: tonicPc as any, mode: modeLabel as any });\n    track('key_pick', { page: 'find-chords', key: k, mode: modeLabel });\n    // local-only; store scale is not required here\n    void refreshDiatonicAndOverlay();\n  };\n\n  const onPickScale = (id: ScaleId) => {\n    setSelScaleId(id);\n    const tonicPc = KEY_OPTIONS.indexOf(keyTonic);\n    track('scale_pick', { page: 'find-chords', scale: id, key: keyTonic });\n    void refreshDiatonicAndOverlay();\n  };\n\n  async function refreshDiatonicAndOverlay() {\n    // Recompute store to refresh diatonic/capo table and set a base overlay\n    const tonicPc = KEY_OPTIONS.indexOf(keyTonic);\n    const uiScale = (selScaleId === 'Aeolian') ? 'minor' : 'major';\n    const modeLabel = uiScale === 'major' ? 'Major' : 'Minor';\n    selectKey({ tonic: tonicPc as any, mode: modeLabel as any });\n    // local-only; store scale is not required here\n    // base view: show only page scale; no chord overlay yet\n    setOverlayNotes(null);\n  }\n\n  useEffect(() => {\n    // 初期表示でも現在のKey/Scaleに合わせてベースを反映\n    void refreshDiatonicAndOverlay();\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, []);\n\n  const scaleRootPc = useMemo(()=> KEY_OPTIONS.indexOf(keyTonic), [keyTonic]);\n  const scaleTypeForUI = useMemo(()=> selScaleId, [selScaleId]);\n\n  const scaleNotesForCurrentKey = () => {\n    const pcs = getScalePitchesById(scaleRootPc as any, scaleTypeForUI as any);\n    return pcs.map(pc => PC_NAMES[pc] as string);\n  };\n\n  // Reset overlay to current scale and clear selection\n  const resetToScale = useCallback(() => {\n    setDisplay('degrees');\n    setFbCapo(0);\n    setOverlayNotes(null);\n    setPreviewScaleId(null);\n    setSelectedCellId(null);\n    setLastPickedPcs(null);\n    resetForms();\n    track('overlay_reset', { page: 'find-chords', scale: selScaleId, key: keyTonic });\n  }, [scaleRootPc, scaleTypeForUI, resetForms]);\n\n  // Esc key to reset back to scale view\n  useEffect(() => {\n    const h = (e: KeyboardEvent) => { if (e.key === 'Escape') resetToScale(); };\n    window.addEventListener('keydown', h);\n    return () => window.removeEventListener('keydown', h);\n  }, [resetToScale]);\n\n  // ---- chord tone helper (minimal triad/7th) ----\n  const P = PC_NAMES as unknown as readonly string[];\n  const idxNote = (n: string) => P.indexOf(n as any);\n  const shift = (n: string, semi: number) => P[(idxNote(n) + semi + 120) % 12];\n  function tonesFor(sym: string): string[] {\n    const m = (sym || '').trim().match(/^([A-G](?:#|b)?)(.*)$/);\n    if (!m) return [];\n    const root = m[1]!; const q = (m[2] || '').trim();\n    let iv = [0,4,7];\n    if (/^m(?!aj)/.test(q)) iv = [0,3,7];\n    if (/dim|o/.test(q)) iv = [0,3,6];\n    if (/aug|\\+/.test(q)) iv = [0,4,8];\n    if (/m7b5/.test(q)) iv = [0,3,6,10];\n    else if (/maj7|M7/.test(q)) iv = Array.from(new Set([...iv,11]));\n    else if (/m7/.test(q)) iv = Array.from(new Set([...iv,10]));\n    else if (/7/.test(q)) iv = Array.from(new Set([...iv,10]));\n    return iv.map(semi => shift(root, semi));\n  }\n\n  return (\n    <OverlayProvider>\n    <main className=\"ot-page ot-stack\" data-page=\"find-chords\">\n      <h1 className=\"sr-only\">Find Chords</h1>\n      {/* Select Key & Scale */}\n      <section className=\"ot-card\">\n        <h2 className=\"ot-h2\">Select Key &amp; Scale</h2>\n        <div className=\"mt-3 grid sm:grid-cols-2 gap-3\">\n        <div>\n          <label className=\"block text-sm mb-1\">Key</label>\n          <div className=\"flex flex-col gap-2\" role=\"tablist\" aria-label=\"Select key\" ref={keyRowRef}>\n            {[[\"C\",\"C#\",\"D\",\"Eb\",\"E\",\"F\"],[\"F#\",\"G\",\"Ab\",\"A\",\"Bb\",\"B\"]].map((row, ri)=> (\n              <div key={`krow-${ri}`} ref={ri===0?keyRowRef as any:undefined} className=\"flex flex-wrap gap-2\">\n                {row.map(k => (\n                  <button\n                    key={k}\n                    role=\"tab\"\n                    aria-selected={keyTonic === (k as NoteLetter)}\n                    tabIndex={keyTonic === (k as NoteLetter) ? 0 : -1}\n                    className={[\"chip\",\"chip--key\", keyTonic===k?\"chip--active\":\"\"].join(\" \")}\n                    data-roving=\"item\"\n                    onClick={()=>{ onPickKey(k as NoteLetter); }}\n                    title={`Key ${k}`}\n                  >{k}</button>\n                ))}\n              </div>\n            ))}\n          </div>\n        </div>\n        <div>\n          <label htmlFor=\"scale\" className=\"block text-sm mb-1\">\n            <span>Scale</span>\n            {(() => {\n              const cur = UI_SCALES.find(s => s.id === selScaleId)!;\n              const notesInC = getScalePitchesById(0, cur.id).map(pc => PC_NAMES[pc]).join(' ');\n              const defaultAbout = `${cur.group} scale — ${cur.degrees.length}-note pattern.`;\n              return (\n                <InfoDot title={cur.display.en} className=\"ml-2\" linkHref=\"/resources/glossary\" linkLabel=\"Glossary\">\n                  <div className=\"text-sm\">\n                    <div className=\"mb-1\"><b>Degrees:</b> {cur.degrees.join(' ')}</div>\n                    <div className=\"mb-1\"><b>Notes in C:</b> {notesInC}</div>\n                    <div className=\"mb-1\"><b>About:</b> {cur.info?.oneLiner ?? defaultAbout}</div>\n                    {!!cur.info?.examples?.length && (\n                      <div className=\"mt-2\">\n                        <b className=\"text-xs\">Song examples</b>\n                        <ul className=\"text-xs mt-1 space-y-1\">\n                          {cur.info.examples.map((e,i)=> (\n                            <li key={i}>\n                              {e.url ? <a href={e.url} target=\"_blank\" rel=\"noreferrer\">{e.title}</a> : e.title}\n                              {e.artist ? ` — ${e.artist}` : ''}{e.cue ? ` (${e.cue})` : ''}\n                            </li>\n                          ))}\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                </InfoDot>\n              );\n            })()}\n          </label>\n          <select\n            id=\"scale\"\n            name=\"scale\"\n            className=\"w-full rounded border px-3 py-2 text-sm bg-transparent\"\n            value={selScaleId}\n            onChange={(e) => onPickScale(e.target.value as ScaleId)}\n          >\n            {UI_SCALES.map((s) => (\n              <option key={s.id} value={s.id}>{s.display.en}</option>\n            ))}\n          </select>\n        </div>\n        </div>\n      </section>\n      {/* Result: Diatonic → Fretboard */}\n      <section className=\"ot-card\">\n        <h2 className=\"ot-h2\">Result</h2>\n        <div className=\"ot-stack\">\n          <div>\n            <h3 className=\"ot-h3 flex items-center gap-2\"><span>Diatonic</span>\n              <InfoDot title=\"Diatonic chords\" linkHref=\"/resources/glossary\" linkLabel=\"Glossary\">\n                <p className=\"text-sm\">Chords built only from the key’s scale tones (I–ii–iii–IV–V–vi–vii°).</p>\n                <p className=\"text-sm mt-2\">Capo rows show the shapes you fret. The sounding chord tones on the fretboard are the same as the Open row.</p>\n                <p className=\"text-xs mt-1\">See details in Reference → Capo &amp; Shapes</p>\n              </InfoDot>\n            </h3>\n            {!isHept && (\n              <p className=\"text-xs text-foreground/70 mt-1\">\n                This scale is not heptatonic; Roman numerals are hidden. Diatonic suggestions are limited to the Open row.\n              </p>\n            )}\n            <div data-testid={isHept ? undefined : \"diatonic-open-only\"}>\n            <DiatonicCapoTable selectedId={selectedCellId} onSelectId={(id)=>{\n              // 再クリック（同じセル）は状態を変えない（プレビューはResetを使用）\n              if (selectedCellId === id) { return; }\n              setSelectedCellId(id);\n            }} onPick={({ pcs })=>{\n              const mainNotes = pcs.map(pc => PC_NAMES[pc] as string);\n              setOverlayNotes(mainNotes);\n              setLastPickedPcs(pcs);\n              resetForms();\n              track('diatonic_pick', { page:'find-chords', id:selectedCellId, scale: selScaleId, key: keyTonic });\n            }} />\n            </div>\n          </div>\n          {/* Scale table (MVP): show 2-scale suggestions for the selected chord */}\n          {selectedCellId && lastPickedPcs && (\n            <div className=\"mt-2\">\n              <ScaleTable\n                chordQuality={detectQualityFromPcs(lastPickedPcs)}\n                rootPc={scaleRootPc as any}\n                onPreviewScale={(id)=>{ setPreviewScaleId(id as any); }}\n                onResetPreview={()=>{ setPreviewScaleId(null); resetToScale(); }}\n                openGlossary={(id)=>{ try{ window.open('/resources/glossary','_blank'); }catch{} }}\n                activeScaleId={previewScaleId as any}\n              />\n            </div>\n          )}\n          {/* Substitute Chords: show alternative chords */}\n          {selectedCellId && lastPickedPcs && (\n            <SubstituteCard\n              rootPc={scaleRootPc as any}\n              quality={detectQualityFromPcs(lastPickedPcs) as any}\n              degree={(() => {\n                // セルIDから度数を取得 (例: \"open-0\" → 1, \"open-1\" → 2)\n                const parts = selectedCellId.split('-');\n                return parseInt(parts[1] || '0', 10) + 1;\n              })()}\n              keyContext={{\n                tonic: KEY_OPTIONS.indexOf(keyTonic),\n                mode: (selScaleId === 'Aeolian' ? 'Minor' : 'Major') as any\n              }}\n              page=\"find-chords\"\n            />\n          )}\n          <div>\n            <h3 className=\"ot-h3 flex items-center justify-between\">\n              <span>Fretboard</span>\n              <span ref={fbToggleRef} className=\"flex items-center gap-2\" role=\"tablist\" aria-orientation=\"horizontal\" aria-label=\"Fretboard notation\">\n              <button role=\"tab\" aria-selected={display==='degrees'} tabIndex={display==='degrees'?0:-1} className={[\"chip\", display==='degrees'?\"chip--on\":\"\"].join(\" \")} data-roving=\"item\" onClick={()=>{ resetForms(); setDisplay('degrees'); }}>Degrees</button>\n              <button role=\"tab\" aria-selected={display==='names'} tabIndex={display==='names'?0:-1} className={[\"chip\", display==='names'?\"chip--on\":\"\"].join(\" \")} data-roving=\"item\" onClick={()=>{ resetForms(); setDisplay('names'); }}>Names</button>\n              {selectedCellId && (\n                <button role=\"tab\" aria-selected={false} tabIndex={-1} className=\"chip\" onClick={resetToScale} aria-label=\"Reset\">Reset</button>\n              )}\n              </span>\n            </h3>\n            <Fretboard\n              overlay={{\n                viewMode: 'sounding' as any,\n                capo: fbCapo,\n                display: display as any,\n                scaleRootPc: scaleRootPc as any,\n                scaleType: (previewScaleId ?? scaleTypeForUI) as any,\n                showScaleGhost: Boolean(selectedCellId),\n                chordNotes: overlayNotes ?? undefined,\n                context: {\n                  chordRootPc: lastPickedPcs && lastPickedPcs.length ? lastPickedPcs[0] : undefined,\n                  quality: (() => {\n                    const pcs = lastPickedPcs ?? [];\n                    const q = detectQualityFromPcs(pcs.length ? pcs : [scaleRootPc]);\n                    return q === 'min' ? 'min' : 'maj';\n                  })(),\n                },\n              }}\n              onRequestForms={(at, ctx)=>{\n                setFormsPop({ at, rootPc: ctx.rootPc, quality: ctx.quality });\n              }}\n              formShape={formShape}\n            />\n          </div>\n        </div>\n      </section>\n\n      {/* Ad Placeholder (card participates in page rhythm) */}\n      <section className=\"ot-card ad-placeholder\" aria-label=\"Ad\">\n        <AdSlot page=\"find_chords\" format=\"horizontal\" />\n      </section>\n      {formsPop && (\n        <ChordFormsPopover\n          at={formsPop.at}\n          quality={formsPop.quality}\n          rootPc={formsPop.rootPc}\n          page=\"find-chords\"\n          onPick={(kind: FormKind)=>{\n            const shape = buildForm(kind, formsPop.quality, formsPop.rootPc);\n            setFormShape(shape);\n          }}\n          onClose={()=> setFormsPop(null)}\n        />\n      )}\n    </main>\n    </OverlayProvider>\n  );\n}\n\n// --- helpers ---\nfunction detectQualityFromPcs(pcs:number[]): 'maj'|'min'|'dom7'|'m7b5'|'dim' {\n  const set = new Set(pcs.map(x => ((x - pcs[0] + 12) % 12)));\n  // simple triad/7th checks (relative to first pc as root)\n  if (set.has(0) && set.has(4) && set.has(7)) return 'maj';\n  if (set.has(0) && set.has(3) && set.has(7)) return 'min';\n  if (set.has(0) && set.has(3) && set.has(6)) return 'dim';\n  if (set.has(0) && set.has(4) && set.has(7) && set.has(10)) return 'dom7';\n  if (set.has(0) && set.has(3) && set.has(6) && set.has(10)) return 'm7b5';\n  return 'maj';\n}\n\n\n"],"names":[],"mappings":";;;;;AACA;AACA;AACA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAnBA;;;;;;;;;;;;;;;;;;;;AAqBe,SAAS;IACtB,qBACE,8OAAC,iNAAQ;QAAC,wBAAU,8OAAC;YAAI,WAAU;sBAAU;;;;;;kBAC3C,cAAA,8OAAC;;;;;;;;;;AAGP;AAEA,SAAS;IACP,MAAM,SAAS,IAAA,qJAAe;IAC9B,MAAM,cAA4B,IAAA,gNAAO,EAAC,IAAM,4IAAQ,EAA6B,EAAE;IACvF,MAAM,YAAY,2IAAa,EAAE,YAAY;IAE7C,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAa,AAAC,OAAO,GAAG,CAAC,UAAyB;IAC1F,MAAM,cAAuB,AAAC,OAAO,GAAG,CAAC,YAAY,UAAW,YAAY;IAC5E,MAAM,CAAC,YAAY,cAAc,GAAG,IAAA,iNAAQ,EAAU;IACtD,MAAM,SAAS,IAAA,gNAAO,EAAC;QACrB,MAAM,MAAM,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;QACzC,OAAO,CAAC,KAAK,QAAQ,UAAU,CAAC,MAAM;IACxC,GAAG;QAAC;KAAW;IAEf,MAAM,WAAW,IAAA,gNAAO,EAAC;QACvB,MAAM,MAAM,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;QACzC,MAAM,YAAY,IAAI,OAAO,CAAC,MAAM,KAAK;QACzC,IAAI,CAAC,WAAW,OAAO,EAAE;QACzB,MAAM,UAAW,IAAI,EAAE,KAAG,YAAY,UAAU;QAChD,OAAO,IAAA,qJAAoB,EAAC;YAAE,OAAO;YAAU;YAAS,OAAO,IAAI,EAAE;QAAQ,GAAU,MAAM;IAC/F,GAAG;QAAC;QAAU;KAAW;IAEzB,MAAM,OAAa,IAAA,gNAAO,EAAC,IAAO,eAAe,YAAY,UAAU,SAAU;QAAC;KAAW;IAG7F,MAAM,YAAY,IAAA,+MAAM,EAAwB;IAChD,IAAA,8IAAa,EAAC,WAAW;QAAE,aAAa;IAAa;IACrD,MAAM,cAAc,IAAA,+MAAM,EAAyB;IACnD,IAAA,8IAAa,EAAC,aAAa;QAAE,aAAa;IAAa;IACvD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAU;IAChD,MAAM,CAAC,QAAQ,UAAU,GAAG,IAAA,iNAAQ,EAAS;IAC7C,MAAM,CAAC,cAAc,gBAAgB,GAAG,IAAA,iNAAQ,EAAgB;IAChE,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAiB;IACrE,MAAM,CAAC,gBAAgB,kBAAkB,GAAG,IAAA,iNAAQ,EAAgB;IACpE,MAAM,CAAC,eAAe,iBAAiB,GAAG,IAAA,iNAAQ,EAAgB;IAClE,MAAM,CAAC,UAAU,YAAY,GAAG,IAAA,iNAAQ,EAAoE;IAC5G,MAAM,CAAC,WAAW,aAAa,GAAG,IAAA,iNAAQ,EAAmB;IAC7D,MAAM,aAAa,IAAA,oNAAW,EAAC;QAAQ,YAAY;QAAO,aAAa;IAAO,GAAG,EAAE;IAEnF,sDAAsD;IACtD,IAAA,kNAAS,EAAC,KAAO,GAAG;QAAC;QAAS;KAAa;IAC3C,MAAM,EAAE,SAAS,EAAE,GAAG,IAAA,iJAAgB;IACtC,+CAA+C;IAE/C,MAAM,YAAY,CAAC;QACjB,YAAY;QACZ,MAAM,IAAI,AAAC,eAAe,YAAa,UAAU;QACjD,MAAM,YAAY,MAAM,UAAU,UAAU;QAC5C,MAAM,UAAU,YAAY,OAAO,CAAC;QACpC,UAAU;YAAE,OAAO;YAAgB,MAAM;QAAiB;QAC1D,IAAA,gIAAK,EAAC,YAAY;YAAE,MAAM;YAAe,KAAK;YAAG,MAAM;QAAU;QACjE,+CAA+C;QAC/C,KAAK;IACP;IAEA,MAAM,cAAc,CAAC;QACnB,cAAc;QACd,MAAM,UAAU,YAAY,OAAO,CAAC;QACpC,IAAA,gIAAK,EAAC,cAAc;YAAE,MAAM;YAAe,OAAO;YAAI,KAAK;QAAS;QACpE,KAAK;IACP;IAEA,eAAe;QACb,wEAAwE;QACxE,MAAM,UAAU,YAAY,OAAO,CAAC;QACpC,MAAM,UAAU,AAAC,eAAe,YAAa,UAAU;QACvD,MAAM,YAAY,YAAY,UAAU,UAAU;QAClD,UAAU;YAAE,OAAO;YAAgB,MAAM;QAAiB;QAC1D,+CAA+C;QAC/C,wDAAwD;QACxD,gBAAgB;IAClB;IAEA,IAAA,kNAAS,EAAC;QACR,gCAAgC;QAChC,KAAK;IACL,uDAAuD;IACzD,GAAG,EAAE;IAEL,MAAM,cAAc,IAAA,gNAAO,EAAC,IAAK,YAAY,OAAO,CAAC,WAAW;QAAC;KAAS;IAC1E,MAAM,iBAAiB,IAAA,gNAAO,EAAC,IAAK,YAAY;QAAC;KAAW;IAE5D,MAAM,0BAA0B;QAC9B,MAAM,MAAM,IAAA,2IAAmB,EAAC,aAAoB;QACpD,OAAO,IAAI,GAAG,CAAC,CAAA,KAAM,4IAAQ,CAAC,GAAG;IACnC;IAEA,qDAAqD;IACrD,MAAM,eAAe,IAAA,oNAAW,EAAC;QAC/B,WAAW;QACX,UAAU;QACV,gBAAgB;QAChB,kBAAkB;QAClB,kBAAkB;QAClB,iBAAiB;QACjB;QACA,IAAA,gIAAK,EAAC,iBAAiB;YAAE,MAAM;YAAe,OAAO;YAAY,KAAK;QAAS;IACjF,GAAG;QAAC;QAAa;QAAgB;KAAW;IAE5C,sCAAsC;IACtC,IAAA,kNAAS,EAAC;QACR,MAAM,IAAI,CAAC;YAAuB,IAAI,EAAE,GAAG,KAAK,UAAU;QAAgB;QAC1E,OAAO,gBAAgB,CAAC,WAAW;QACnC,OAAO,IAAM,OAAO,mBAAmB,CAAC,WAAW;IACrD,GAAG;QAAC;KAAa;IAEjB,kDAAkD;IAClD,MAAM,IAAI,4IAAQ;IAClB,MAAM,UAAU,CAAC,IAAc,EAAE,OAAO,CAAC;IACzC,MAAM,QAAQ,CAAC,GAAW,OAAiB,CAAC,CAAC,CAAC,QAAQ,KAAK,OAAO,GAAG,IAAI,GAAG;IAC5E,SAAS,SAAS,GAAW;QAC3B,MAAM,IAAI,CAAC,OAAO,EAAE,EAAE,IAAI,GAAG,KAAK,CAAC;QACnC,IAAI,CAAC,GAAG,OAAO,EAAE;QACjB,MAAM,OAAO,CAAC,CAAC,EAAE;QAAG,MAAM,IAAI,CAAC,CAAC,CAAC,EAAE,IAAI,EAAE,EAAE,IAAI;QAC/C,IAAI,KAAK;YAAC;YAAE;YAAE;SAAE;QAChB,IAAI,WAAW,IAAI,CAAC,IAAI,KAAK;YAAC;YAAE;YAAE;SAAE;QACpC,IAAI,QAAQ,IAAI,CAAC,IAAI,KAAK;YAAC;YAAE;YAAE;SAAE;QACjC,IAAI,SAAS,IAAI,CAAC,IAAI,KAAK;YAAC;YAAE;YAAE;SAAE;QAClC,IAAI,OAAO,IAAI,CAAC,IAAI,KAAK;YAAC;YAAE;YAAE;YAAE;SAAG;aAC9B,IAAI,UAAU,IAAI,CAAC,IAAI,KAAK,MAAM,IAAI,CAAC,IAAI,IAAI;eAAI;YAAG;SAAG;aACzD,IAAI,KAAK,IAAI,CAAC,IAAI,KAAK,MAAM,IAAI,CAAC,IAAI,IAAI;eAAI;YAAG;SAAG;aACpD,IAAI,IAAI,IAAI,CAAC,IAAI,KAAK,MAAM,IAAI,CAAC,IAAI,IAAI;eAAI;YAAG;SAAG;QACxD,OAAO,GAAG,GAAG,CAAC,CAAA,OAAQ,MAAM,MAAM;IACpC;IAEA,qBACE,8OAAC,0IAAe;kBAChB,cAAA,8OAAC;YAAK,WAAU;YAAmB,aAAU;;8BAC3C,8OAAC;oBAAG,WAAU;8BAAU;;;;;;8BAExB,8OAAC;oBAAQ,WAAU;;sCACjB,8OAAC;4BAAG,WAAU;sCAAQ;;;;;;sCACtB,8OAAC;4BAAI,WAAU;;8CACf,8OAAC;;sDACC,8OAAC;4CAAM,WAAU;sDAAqB;;;;;;sDACtC,8OAAC;4CAAI,WAAU;4CAAsB,MAAK;4CAAU,cAAW;4CAAa,KAAK;sDAC9E;gDAAC;oDAAC;oDAAI;oDAAK;oDAAI;oDAAK;oDAAI;iDAAI;gDAAC;oDAAC;oDAAK;oDAAI;oDAAK;oDAAI;oDAAK;iDAAI;6CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,mBACpE,8OAAC;oDAAuB,KAAK,OAAK,IAAE,YAAiB;oDAAW,WAAU;8DACvE,IAAI,GAAG,CAAC,CAAA,kBACP,8OAAC;4DAEC,MAAK;4DACL,iBAAe,aAAc;4DAC7B,UAAU,aAAc,IAAmB,IAAI,CAAC;4DAChD,WAAW;gEAAC;gEAAO;gEAAa,aAAW,IAAE,iBAAe;6DAAG,CAAC,IAAI,CAAC;4DACrE,eAAY;4DACZ,SAAS;gEAAM,UAAU;4DAAkB;4DAC3C,OAAO,CAAC,IAAI,EAAE,GAAG;sEACjB;2DARK;;;;;mDAHD,CAAC,KAAK,EAAE,IAAI;;;;;;;;;;;;;;;;8CAiB5B,8OAAC;;sDACC,8OAAC;4CAAM,SAAQ;4CAAQ,WAAU;;8DAC/B,8OAAC;8DAAK;;;;;;gDACL,CAAC;oDACA,MAAM,MAAM,UAAU,IAAI,CAAC,CAAA,IAAK,EAAE,EAAE,KAAK;oDACzC,MAAM,WAAW,IAAA,2IAAmB,EAAC,GAAG,IAAI,EAAE,EAAE,GAAG,CAAC,CAAA,KAAM,4IAAQ,CAAC,GAAG,EAAE,IAAI,CAAC;oDAC7E,MAAM,eAAe,GAAG,IAAI,KAAK,CAAC,SAAS,EAAE,IAAI,OAAO,CAAC,MAAM,CAAC,cAAc,CAAC;oDAC/E,qBACE,8OAAC,8IAAO;wDAAC,OAAO,IAAI,OAAO,CAAC,EAAE;wDAAE,WAAU;wDAAO,UAAS;wDAAsB,WAAU;kEACxF,cAAA,8OAAC;4DAAI,WAAU;;8EACb,8OAAC;oEAAI,WAAU;;sFAAO,8OAAC;sFAAE;;;;;;wEAAY;wEAAE,IAAI,OAAO,CAAC,IAAI,CAAC;;;;;;;8EACxD,8OAAC;oEAAI,WAAU;;sFAAO,8OAAC;sFAAE;;;;;;wEAAe;wEAAE;;;;;;;8EAC1C,8OAAC;oEAAI,WAAU;;sFAAO,8OAAC;sFAAE;;;;;;wEAAU;wEAAE,IAAI,IAAI,EAAE,YAAY;;;;;;;gEAC1D,CAAC,CAAC,IAAI,IAAI,EAAE,UAAU,wBACrB,8OAAC;oEAAI,WAAU;;sFACb,8OAAC;4EAAE,WAAU;sFAAU;;;;;;sFACvB,8OAAC;4EAAG,WAAU;sFACX,IAAI,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,GAAE,kBACxB,8OAAC;;wFACE,EAAE,GAAG,iBAAG,8OAAC;4FAAE,MAAM,EAAE,GAAG;4FAAE,QAAO;4FAAS,KAAI;sGAAc,EAAE,KAAK;;;;;mGAAQ,EAAE,KAAK;wFAChF,EAAE,MAAM,GAAG,CAAC,GAAG,EAAE,EAAE,MAAM,EAAE,GAAG;wFAAI,EAAE,GAAG,GAAG,CAAC,EAAE,EAAE,EAAE,GAAG,CAAC,CAAC,CAAC,GAAG;;mFAFpD;;;;;;;;;;;;;;;;;;;;;;;;;;;gDAWzB,CAAC;;;;;;;sDAEH,8OAAC;4CACC,IAAG;4CACH,MAAK;4CACL,WAAU;4CACV,OAAO;4CACP,UAAU,CAAC,IAAM,YAAY,EAAE,MAAM,CAAC,KAAK;sDAE1C,UAAU,GAAG,CAAC,CAAC,kBACd,8OAAC;oDAAkB,OAAO,EAAE,EAAE;8DAAG,EAAE,OAAO,CAAC,EAAE;mDAAhC,EAAE,EAAE;;;;;;;;;;;;;;;;;;;;;;;;;;;;8BAOzB,8OAAC;oBAAQ,WAAU;;sCACjB,8OAAC;4BAAG,WAAU;sCAAQ;;;;;;sCACtB,8OAAC;4BAAI,WAAU;;8CACb,8OAAC;;sDACC,8OAAC;4CAAG,WAAU;;8DAAgC,8OAAC;8DAAK;;;;;;8DAClD,8OAAC,8IAAO;oDAAC,OAAM;oDAAkB,UAAS;oDAAsB,WAAU;;sEACxE,8OAAC;4DAAE,WAAU;sEAAU;;;;;;sEACvB,8OAAC;4DAAE,WAAU;sEAAe;;;;;;sEAC5B,8OAAC;4DAAE,WAAU;sEAAe;;;;;;;;;;;;;;;;;;wCAG/B,CAAC,wBACA,8OAAC;4CAAE,WAAU;sDAAkC;;;;;;sDAIjD,8OAAC;4CAAI,eAAa,SAAS,YAAY;sDACvC,cAAA,8OAAC,kJAAiB;gDAAC,YAAY;gDAAgB,YAAY,CAAC;oDAC1D,sCAAsC;oDACtC,IAAI,mBAAmB,IAAI;wDAAE;oDAAQ;oDACrC,kBAAkB;gDACpB;gDAAG,QAAQ,CAAC,EAAE,GAAG,EAAE;oDACjB,MAAM,YAAY,IAAI,GAAG,CAAC,CAAA,KAAM,4IAAQ,CAAC,GAAG;oDAC5C,gBAAgB;oDAChB,iBAAiB;oDACjB;oDACA,IAAA,gIAAK,EAAC,iBAAiB;wDAAE,MAAK;wDAAe,IAAG;wDAAgB,OAAO;wDAAY,KAAK;oDAAS;gDACnG;;;;;;;;;;;;;;;;;gCAID,kBAAkB,+BACjB,8OAAC;oCAAI,WAAU;8CACb,cAAA,8OAAC,2IAAU;wCACT,cAAc,qBAAqB;wCACnC,QAAQ;wCACR,gBAAgB,CAAC;4CAAO,kBAAkB;wCAAY;wCACtD,gBAAgB;4CAAM,kBAAkB;4CAAO;wCAAgB;wCAC/D,cAAc,CAAC;4CAAO,IAAG;gDAAE,OAAO,IAAI,CAAC,uBAAsB;4CAAW,EAAC,OAAK,CAAC;wCAAE;wCACjF,eAAe;;;;;;;;;;;gCAKpB,kBAAkB,+BACjB,8OAAC,+IAAc;oCACb,QAAQ;oCACR,SAAS,qBAAqB;oCAC9B,QAAQ,CAAC;wCACP,8CAA8C;wCAC9C,MAAM,QAAQ,eAAe,KAAK,CAAC;wCACnC,OAAO,SAAS,KAAK,CAAC,EAAE,IAAI,KAAK,MAAM;oCACzC,CAAC;oCACD,YAAY;wCACV,OAAO,YAAY,OAAO,CAAC;wCAC3B,MAAO,eAAe,YAAY,UAAU;oCAC9C;oCACA,MAAK;;;;;;8CAGT,8OAAC;;sDACC,8OAAC;4CAAG,WAAU;;8DACZ,8OAAC;8DAAK;;;;;;8DACN,8OAAC;oDAAK,KAAK;oDAAa,WAAU;oDAA0B,MAAK;oDAAU,oBAAiB;oDAAa,cAAW;;sEACpH,8OAAC;4DAAO,MAAK;4DAAM,iBAAe,YAAU;4DAAW,UAAU,YAAU,YAAU,IAAE,CAAC;4DAAG,WAAW;gEAAC;gEAAQ,YAAU,YAAU,aAAW;6DAAG,CAAC,IAAI,CAAC;4DAAM,eAAY;4DAAO,SAAS;gEAAM;gEAAc,WAAW;4DAAY;sEAAG;;;;;;sEACvO,8OAAC;4DAAO,MAAK;4DAAM,iBAAe,YAAU;4DAAS,UAAU,YAAU,UAAQ,IAAE,CAAC;4DAAG,WAAW;gEAAC;gEAAQ,YAAU,UAAQ,aAAW;6DAAG,CAAC,IAAI,CAAC;4DAAM,eAAY;4DAAO,SAAS;gEAAM;gEAAc,WAAW;4DAAU;sEAAG;;;;;;wDAC9N,gCACC,8OAAC;4DAAO,MAAK;4DAAM,iBAAe;4DAAO,UAAU,CAAC;4DAAG,WAAU;4DAAO,SAAS;4DAAc,cAAW;sEAAQ;;;;;;;;;;;;;;;;;;sDAItH,8OAAC,0IAAS;4CACR,SAAS;gDACP,UAAU;gDACV,MAAM;gDACN,SAAS;gDACT,aAAa;gDACb,WAAY,kBAAkB;gDAC9B,gBAAgB,QAAQ;gDACxB,YAAY,gBAAgB;gDAC5B,SAAS;oDACP,aAAa,iBAAiB,cAAc,MAAM,GAAG,aAAa,CAAC,EAAE,GAAG;oDACxE,SAAS,CAAC;wDACR,MAAM,MAAM,iBAAiB,EAAE;wDAC/B,MAAM,IAAI,qBAAqB,IAAI,MAAM,GAAG,MAAM;4DAAC;yDAAY;wDAC/D,OAAO,MAAM,QAAQ,QAAQ;oDAC/B,CAAC;gDACH;4CACF;4CACA,gBAAgB,CAAC,IAAI;gDACnB,YAAY;oDAAE;oDAAI,QAAQ,IAAI,MAAM;oDAAE,SAAS,IAAI,OAAO;gDAAC;4CAC7D;4CACA,WAAW;;;;;;;;;;;;;;;;;;;;;;;;8BAOnB,8OAAC;oBAAQ,WAAU;oBAAyB,cAAW;8BACrD,cAAA,8OAAC,iJAAM;wBAAC,MAAK;wBAAc,QAAO;;;;;;;;;;;gBAEnC,0BACC,8OAAC,4JAAiB;oBAChB,IAAI,SAAS,EAAE;oBACf,SAAS,SAAS,OAAO;oBACzB,QAAQ,SAAS,MAAM;oBACvB,MAAK;oBACL,QAAQ,CAAC;wBACP,MAAM,QAAQ,IAAA,qIAAS,EAAC,MAAM,SAAS,OAAO,EAAE,SAAS,MAAM;wBAC/D,aAAa;oBACf;oBACA,SAAS,IAAK,YAAY;;;;;;;;;;;;;;;;;AAMpC;AAEA,kBAAkB;AAClB,SAAS,qBAAqB,GAAY;IACxC,MAAM,MAAM,IAAI,IAAI,IAAI,GAAG,CAAC,CAAA,IAAM,CAAC,IAAI,GAAG,CAAC,EAAE,GAAG,EAAE,IAAI;IACtD,yDAAyD;IACzD,IAAI,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,OAAO;IACnD,IAAI,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,OAAO;IACnD,IAAI,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,OAAO;IACnD,IAAI,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,KAAK,OAAO;IAClE,IAAI,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,MAAM,IAAI,GAAG,CAAC,KAAK,OAAO;IAClE,OAAO;AACT","debugId":null}}]
}