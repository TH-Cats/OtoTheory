# GTM でGoogle Analytics 4 (GA4) を設定する詳細ガイド

このガイドでは、Google Tag Manager（GTM）を使ってGoogle Analytics 4（GA4）を設定する手順を詳しく説明します。

## 前提条件

- ✅ GTMが正しくインストールされている（`GTM-NXSC7TN2`）
- ⚠️ Google Analytics 4 の測定ID（`G-XXXXXXXXXX`）が必要です

---

## ステップ1: Google Analytics 4 の測定IDを取得

### 1-1. Google Analytics にアクセス

1. [Google Analytics](https://analytics.google.com/) を開く
2. Googleアカウントでログイン

### 1-2. プロパティを作成（または既存のものを使用）

**新規作成の場合:**

1. 左下の「管理」（歯車アイコン）をクリック
2. 「プロパティを作成」をクリック
3. プロパティ名を入力（例：OtoTheory Web）
4. タイムゾーンと通貨を選択（日本の場合：日本、日本円）
5. 「次へ」をクリック
6. ビジネス情報を入力（任意）
7. 「作成」をクリック

### 1-3. データストリームを作成

1. プロパティ作成後、「データストリーム」画面が表示される
2. 「ウェブ」を選択
3. 以下を入力：
   - **ウェブサイトのURL**: `https://ototheory.app`（本番URL）
   - **ストリーム名**: OtoTheory Web
4. 「ストリームを作成」をクリック

### 1-4. 測定IDをコピー

1. データストリームの詳細画面で、**測定ID**（`G-XXXXXXXXXX`）が表示される
2. この測定IDをコピーしておく 📋

---

## ステップ2: GTM管理画面でGA4タグを設定

### 2-1. GTM管理画面にアクセス

1. [Google Tag Manager](https://tagmanager.google.com/) を開く
2. コンテナ `GTM-NXSC7TN2` を選択

### 2-2. GA4設定タグを作成

#### ① 新しいタグを作成

1. 左メニューの「タグ」をクリック
2. 右上の「新規」ボタンをクリック
3. タグの名前を入力（例：`GA4 - Configuration`）

#### ② タグタイプを選択

1. 「タグの設定」エリアをクリック
2. 「Googleアナリティクス: GA4設定」を選択

#### ③ 測定IDを入力

1. **測定ID** フィールドに、先ほどコピーした `G-XXXXXXXXXX` を入力
2. （オプション）その他の設定：
   - **送信するページビューイベント**: チェック（デフォルト）
   - **Cookie設定**: デフォルトのまま

#### ④ トリガーを設定

1. 「トリガー」エリアをクリック
2. 「All Pages」（すべてのページ）を選択
   - これにより、すべてのページでGA4が動作します

#### ⑤ 保存

1. 右上の「保存」ボタンをクリック

---

## ステップ3: カスタムイベントを追加（オプション）

ボタンクリックやフォーム送信などのイベントを追跡したい場合：

### 3-1. イベントタグを作成

1. 左メニューの「タグ」をクリック
2. 「新規」をクリック
3. タグ名を入力（例：`GA4 - Button Click`）

### 3-2. タグタイプを選択

1. 「タグの設定」をクリック
2. 「Googleアナリティクス: GA4イベント」を選択

### 3-3. 設定を入力

1. **設定タグ**: 先ほど作成した `GA4 - Configuration` を選択
2. **イベント名**: 任意の名前を入力（例：`button_click`）
3. **イベントパラメータ**（オプション）:
   - パラメータ名: `button_name`
   - 値: `{{Click Text}}` など

### 3-4. トリガーを設定

1. 「トリガー」をクリック
2. 「+」アイコンで新しいトリガーを作成
3. トリガータイプを選択（例：「すべての要素」のクリック）
4. 条件を設定（例：Click Classes に `cta-button` を含む）
5. 保存

### 3-5. タグを保存

---

## ステップ4: プレビューモードでテスト

### 4-1. プレビューを開始

1. GTM管理画面の右上「プレビュー」をクリック
2. Tag Assistant が開く

### 4-2. ウェブサイトに接続

1. **Your website's URL** に `http://localhost:3000` を入力
2. 「Connect」をクリック
3. 新しいタブでウェブサイトが開く

### 4-3. タグの発火を確認

1. Tag Assistant の左側で「Container Loaded」などのイベントを確認
2. 右側の「Tags Fired」セクションで、`GA4 - Configuration` が表示されるか確認
3. ✅ 緑色のチェックマーク = タグが正常に発火
4. ❌ 赤色のバツマーク = タグの発火に失敗

### 4-4. イベントをテスト

1. ウェブサイトでボタンをクリックしたり、ページを移動
2. Tag Assistant で各アクションが記録されているか確認
3. カスタムイベントが発火しているか確認

### 4-5. リアルタイムレポートで確認

1. Google Analytics の管理画面を開く
2. 左メニューの「レポート」>「リアルタイム」
3. あなたのアクセスが表示されているか確認（通常1-2分以内）

---

## ステップ5: 変更を公開

### 5-1. プレビューを終了

1. Tag Assistant の「Disconnect」をクリック
2. GTM管理画面に戻る

### 5-2. 変更内容を確認

1. 右上の「変更内容の概要」で、追加したタグを確認
2. 変更内容が正しいことを確認

### 5-3. 公開

1. 右上の「公開」ボタンをクリック
2. **バージョン名**を入力（例：`GA4 Setup - 2025-10-09`）
3. **バージョンの説明**を入力（例：`Google Analytics 4 を追加`）
4. 「公開」をクリック

### 5-4. 公開完了

✅ タグが本番環境に反映されました！

---

## よく使うイベントの設定例

### 1. ページビュー（自動）

GA4設定タグで自動的に追跡されます。追加設定不要。

### 2. ボタンクリック

**トリガー:**
- タイプ: すべての要素のクリック
- 条件: `Click Classes` に `cta-button` を含む

**イベント名:** `cta_click`

**パラメータ:**
- `button_name`: `{{Click Text}}`
- `page_path`: `{{Page Path}}`

### 3. フォーム送信

**トリガー:**
- タイプ: フォームの送信
- すべてのフォーム、または特定のフォームIDで絞り込み

**イベント名:** `form_submit`

**パラメータ:**
- `form_id`: `{{Form ID}}`

### 4. スクロール深度

**トリガー:**
- タイプ: スクロール距離
- 垂直スクロール距離: 25%, 50%, 75%, 90%

**イベント名:** `scroll`

**パラメータ:**
- `percent_scrolled`: `{{Scroll Depth Threshold}}`

### 5. 動画再生（YouTube埋め込み）

**トリガー:**
- タイプ: YouTube動画
- キャプチャ: 開始、完了、進捗状況

**イベント名:** `video_play`, `video_complete`

---

## トラブルシューティング

### タグが発火しない

1. **プレビューモードで確認**
   - Tag Assistant で「Tags Not Fired」を確認
   - トリガー条件が満たされているか確認

2. **測定IDを確認**
   - GA4設定タグの測定IDが正しいか確認
   - `G-` で始まることを確認

3. **GTMスニペットが正しく読み込まれているか**
   - ブラウザの開発者ツールで `dataLayer` を確認
   - Networkタブで `gtm.js` のリクエストを確認

### データがGAに表示されない

1. **リアルタイムレポートで確認**
   - 通常1-2分で表示される
   - 24-48時間はデータが不完全な場合がある

2. **データストリームの設定を確認**
   - ウェブストリームが「アクティブ」になっているか

3. **広告ブロッカーを無効化**
   - 開発時は広告ブロッカーを無効にしてテスト

---

## 推奨設定

### デバッグモードを有効化（開発時）

GA4設定タグに以下のパラメータを追加：
- パラメータ名: `debug_mode`
- 値: `true`

これにより、GA4の DebugView でリアルタイムデバッグが可能になります。

### Cookieの同意管理

EU圏やプライバシーに配慮する場合、Cookieの同意を管理：

1. GTMで「同意の概要」機能を使用
2. Cookieバナーを実装
3. ユーザーの同意後にGA4タグを発火

---

## 次のステップ

1. ✅ GA4タグを設定して公開
2. 📊 1-2週間データを収集
3. 📈 レポートを確認して、必要に応じてイベントを追加
4. 🎯 コンバージョン（目標）を設定

---

**作成日:** 2025-10-09
**GTM ID:** GTM-NXSC7TN2

